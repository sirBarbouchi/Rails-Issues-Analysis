url,repository_url,labels_url,comments_url,events_url,html_url,id,node_id,number,title,user,labels,state,locked,assignee,assignees,milestone,comments,created_at,updated_at,closed_at,author_association,active_lock_reason,draft,pull_request,body,reactions,timeline_url,performed_via_github_app,state_reason
https://api.github.com/repos/rails/rails/issues/49511,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49511/labels{/name},https://api.github.com/repos/rails/rails/issues/49511/comments,https://api.github.com/repos/rails/rails/issues/49511/events,https://github.com/rails/rails/pull/49511,1929837534,PR_kwDNIULOXBerEA,49511,[ci-skip][Docs]Update changelog links to 7-1-stable,"{'login': 'hachi8833', 'id': 4289625, 'node_id': 'MDQ6VXNlcjQyODk2MjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4289625?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/hachi8833', 'html_url': 'https://github.com/hachi8833', 'followers_url': 'https://api.github.com/users/hachi8833/followers', 'following_url': 'https://api.github.com/users/hachi8833/following{/other_user}', 'gists_url': 'https://api.github.com/users/hachi8833/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/hachi8833/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/hachi8833/subscriptions', 'organizations_url': 'https://api.github.com/users/hachi8833/orgs', 'repos_url': 'https://api.github.com/users/hachi8833/repos', 'events_url': 'https://api.github.com/users/hachi8833/events{/privacy}', 'received_events_url': 'https://api.github.com/users/hachi8833/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-06T10:08:02Z,2023-10-06T10:15:31Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49511', 'html_url': 'https://github.com/rails/rails/pull/49511', 'diff_url': 'https://github.com/rails/rails/pull/49511.diff', 'patch_url': 'https://github.com/rails/rails/pull/49511.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because the links to the changelogs in 7_1_release_notes.md have not been updated.

### Detail

The PR updates the links to changelogs to be consistent with the [previous 7.0 release notes](https://github.com/rails/rails/blob/main/guides/source/7_0_release_notes.md?plain=1#L354-L366)

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
","{'url': 'https://api.github.com/repos/rails/rails/issues/49511/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49511/timeline,,
https://api.github.com/repos/rails/rails/issues/49510,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49510/labels{/name},https://api.github.com/repos/rails/rails/issues/49510/comments,https://api.github.com/repos/rails/rails/issues/49510/events,https://github.com/rails/rails/issues/49510,1929582527,I_kwDNIULOcwMXvw,49510,activesupport 7.1.0 is throwing NoMethodError: undefined method `deprecator' for ActiveSupport:Module,"{'login': 'bblaal', 'id': 142652504, 'node_id': 'U_kgDOCIC0WA', 'avatar_url': 'https://avatars.githubusercontent.com/u/142652504?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bblaal', 'html_url': 'https://github.com/bblaal', 'followers_url': 'https://api.github.com/users/bblaal/followers', 'following_url': 'https://api.github.com/users/bblaal/following{/other_user}', 'gists_url': 'https://api.github.com/users/bblaal/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bblaal/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bblaal/subscriptions', 'organizations_url': 'https://api.github.com/users/bblaal/orgs', 'repos_url': 'https://api.github.com/users/bblaal/repos', 'events_url': 'https://api.github.com/users/bblaal/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bblaal/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,3,2023-10-06T07:18:03Z,2023-10-06T07:58:48Z,,NONE,,,,"### Steps to reproduce
by running command `bundle exec rake assets:precompile` or simply by running any configured pipeline, i.e: `jenkins`

### Expected behavior
Build should pass without an error

### Actual behavior
Build is getting failed with error:
`NoMethodError: undefined method `deprecator' for ActiveSupport:Module`

### System configuration
**Rails version**: `7.1.0`

**Ruby version**: `2.7`
","{'url': 'https://api.github.com/repos/rails/rails/issues/49510/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49510/timeline,,
https://api.github.com/repos/rails/rails/issues/49509,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49509/labels{/name},https://api.github.com/repos/rails/rails/issues/49509/comments,https://api.github.com/repos/rails/rails/issues/49509/events,https://github.com/rails/rails/pull/49509,1929280592,PR_kwDNIULOXBA18w,49509,"When running in CI, do not fail if Rails frameworks with tables have not been fully installed","{'login': 'ghiculescu', 'id': 509837, 'node_id': 'MDQ6VXNlcjUwOTgzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/509837?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ghiculescu', 'html_url': 'https://github.com/ghiculescu', 'followers_url': 'https://api.github.com/users/ghiculescu/followers', 'following_url': 'https://api.github.com/users/ghiculescu/following{/other_user}', 'gists_url': 'https://api.github.com/users/ghiculescu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ghiculescu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ghiculescu/subscriptions', 'organizations_url': 'https://api.github.com/users/ghiculescu/orgs', 'repos_url': 'https://api.github.com/users/ghiculescu/repos', 'events_url': 'https://api.github.com/users/ghiculescu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ghiculescu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-06T01:05:06Z,2023-10-06T01:09:43Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49509', 'html_url': 'https://github.com/rails/rails/pull/49509', 'diff_url': 'https://github.com/rails/rails/pull/49509.diff', 'patch_url': 'https://github.com/rails/rails/pull/49509.patch', 'merged_at': None}","Fixes https://github.com/rails/rails/issues/49500

The Rails first run experience should not require installing Action Text/Active Storage/Action Mailbox so you can run tests in CI. You should only install these features if you actually use them. It also should not require changing the require of `rails/all`.

This config works in production when eager loaded, so we should support it in test too.

With this PR we keep the first run experience we had before `7.1.0` but you can still customise all these things if you want.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49509/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49509/timeline,,
https://api.github.com/repos/rails/rails/issues/49507,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49507/labels{/name},https://api.github.com/repos/rails/rails/issues/49507/comments,https://api.github.com/repos/rails/rails/issues/49507/events,https://github.com/rails/rails/pull/49507,1929078738,PR_kwDNIULOXA1sbA,49507,Ensure `#signed_id` outputs `url_safe` strings,"{'login': 'terracatta', 'id': 315873, 'node_id': 'MDQ6VXNlcjMxNTg3Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/315873?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/terracatta', 'html_url': 'https://github.com/terracatta', 'followers_url': 'https://api.github.com/users/terracatta/followers', 'following_url': 'https://api.github.com/users/terracatta/following{/other_user}', 'gists_url': 'https://api.github.com/users/terracatta/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/terracatta/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/terracatta/subscriptions', 'organizations_url': 'https://api.github.com/users/terracatta/orgs', 'repos_url': 'https://api.github.com/users/terracatta/repos', 'events_url': 'https://api.github.com/users/terracatta/events{/privacy}', 'received_events_url': 'https://api.github.com/users/terracatta/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-05T21:21:06Z,2023-10-05T21:21:51Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49507', 'html_url': 'https://github.com/rails/rails/pull/49507', 'diff_url': 'https://github.com/rails/rails/pull/49507.diff', 'patch_url': 'https://github.com/rails/rails/pull/49507.patch', 'merged_at': None}","Fixes #49505

When @dhh introduced [signed_ids ](https://github.com/rails/rails/pull/39313) he likely always intended them to be url safe. 

Since the intent of signed_ids is to be included in things like URL params, we should be passing `url_safe: true` option to `MessageVerifier`.

This PR does exactly that.","{'url': 'https://api.github.com/repos/rails/rails/issues/49507/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49507/timeline,,
https://api.github.com/repos/rails/rails/issues/49505,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49505/labels{/name},https://api.github.com/repos/rails/rails/issues/49505/comments,https://api.github.com/repos/rails/rails/issues/49505/events,https://github.com/rails/rails/issues/49505,1929048677,I_kwDNIULOcvryZQ,49505,`#signed_id` outputs URL unsafe strings,"{'login': 'terracatta', 'id': 315873, 'node_id': 'MDQ6VXNlcjMxNTg3Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/315873?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/terracatta', 'html_url': 'https://github.com/terracatta', 'followers_url': 'https://api.github.com/users/terracatta/followers', 'following_url': 'https://api.github.com/users/terracatta/following{/other_user}', 'gists_url': 'https://api.github.com/users/terracatta/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/terracatta/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/terracatta/subscriptions', 'organizations_url': 'https://api.github.com/users/terracatta/orgs', 'repos_url': 'https://api.github.com/users/terracatta/repos', 'events_url': 'https://api.github.com/users/terracatta/events{/privacy}', 'received_events_url': 'https://api.github.com/users/terracatta/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-05T21:02:13Z,2023-10-06T00:09:27Z,,CONTRIBUTOR,,,,"Today, calling `Model.signed_id` there is a chance of generating URL unsafe strings. 

From my research, this has always been true, but I believe it may be more likely to happen due to changes in how ruby objects might be serialized after https://github.com/rails/rails/pull/47916 was merged (which IMO is a great change).

In my view, when @dhh introduced signed_ids he always intended them to be url safe.

Since the intent of signed_ids is to be included in things like URL params, we should be passing `url_safe: true` option to `MessageVerifier`.

### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.1.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)
ActiveRecord::Base.signed_id_verifier_secret = ""foobar""

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
  end
end

class User < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def check_for_unsafe_base64_characters
    user = User.create!
    signed_id = user.signed_id(purpose: ""~~~~~~~~~"")
    # `+` is not a url-safe character
    assert !signed_id.include?(""+"")
  end
end
```

### Expected behavior
`user.signed_id` should generate base64 strings that are url safe

### Actual behavior
The `+` is included which is not safe for URLs.

### System configuration
**Rails version**: 7.1.0

**Ruby version**: 3.2.2

### Monkey Patch
Here is the patch I am using in my app that fixes the issue.

```ruby
module ActiveRecord
  module SignedId
    module ClassMethods
      # Overriding this method because we want Rails to support signed_ids that are url_safe
      def signed_id_verifier
        @signed_id_verifier ||= begin
          secret = signed_id_verifier_secret
          secret = secret.call if secret.respond_to?(:call)

          if secret.nil?
            raise ArgumentError, ""You must set ActiveRecord::Base.signed_id_verifier_secret to use signed ids""
          else
            ActiveSupport::MessageVerifier.new secret, digest: ""SHA256"", serializer: JSON, url_safe: true
          end
        end
      end
    end
  end
end

```","{'url': 'https://api.github.com/repos/rails/rails/issues/49505/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49505/timeline,,
https://api.github.com/repos/rails/rails/issues/49504,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49504/labels{/name},https://api.github.com/repos/rails/rails/issues/49504/comments,https://api.github.com/repos/rails/rails/issues/49504/events,https://github.com/rails/rails/pull/49504,1929024415,PR_kwDNIULOXAyt9A,49504,Fix auto populating `IDENTITY` columns for PostgreSQL,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-05T20:43:28Z,2023-10-06T07:37:29Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49504', 'html_url': 'https://github.com/rails/rails/pull/49504', 'diff_url': 'https://github.com/rails/rails/pull/49504.diff', 'patch_url': 'https://github.com/rails/rails/pull/49504.patch', 'merged_at': None}","Fixes #49502.

This bug was introduced in https://github.com/rails/rails/pull/48241. Since `IDENTITY` columns in PostgreSQL do not have defaults, they are not auto populated via the changes made in that PR. Thus we need to consider them separately.

cc @nvasilevski 
","{'url': 'https://api.github.com/repos/rails/rails/issues/49504/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49504/timeline,,
https://api.github.com/repos/rails/rails/issues/49503,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49503/labels{/name},https://api.github.com/repos/rails/rails/issues/49503/comments,https://api.github.com/repos/rails/rails/issues/49503/events,https://github.com/rails/rails/pull/49503,1928964142,PR_kwDNIULOXAvZRw,49503,Backport to 7-0-stable: MemoryStore: preserve entry ttl when incrementing,"{'login': 'pjambet', 'id': 717637, 'node_id': 'MDQ6VXNlcjcxNzYzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/717637?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pjambet', 'html_url': 'https://github.com/pjambet', 'followers_url': 'https://api.github.com/users/pjambet/followers', 'following_url': 'https://api.github.com/users/pjambet/following{/other_user}', 'gists_url': 'https://api.github.com/users/pjambet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pjambet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pjambet/subscriptions', 'organizations_url': 'https://api.github.com/users/pjambet/orgs', 'repos_url': 'https://api.github.com/users/pjambet/repos', 'events_url': 'https://api.github.com/users/pjambet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pjambet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,1,2023-10-05T19:56:25Z,2023-10-05T23:08:07Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49503', 'html_url': 'https://github.com/rails/rails/pull/49503', 'diff_url': 'https://github.com/rails/rails/pull/49503.diff', 'patch_url': 'https://github.com/rails/rails/pull/49503.patch', 'merged_at': None}","### Motivation / Background

Backports the fix from https://github.com/rails/rails/pull/46305

### Detail

Calling `Rails.cache.increment` drops the existing TTL, which is an issue on the current release of Rails, 7.0.

### Additional information

Some of the changes introduced in [the original
PR](https://github.com/rails/rails/pull/46305) were discarded, such as the `normalize_` methods, as well as the change that originated in [that PR](https://github.com/rails/rails/pull/45068) that sets a value if none exists.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49503/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49503/timeline,,
https://api.github.com/repos/rails/rails/issues/49502,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49502/labels{/name},https://api.github.com/repos/rails/rails/issues/49502/comments,https://api.github.com/repos/rails/rails/issues/49502/events,https://github.com/rails/rails/issues/49502,1928943686,I_kwDNIULOcvlYRg,49502,ActiveRecord 7.1.0 does not return and assign primary keys that are generated identity columns,"{'login': 'jackc', 'id': 94130, 'node_id': 'MDQ6VXNlcjk0MTMw', 'avatar_url': 'https://avatars.githubusercontent.com/u/94130?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jackc', 'html_url': 'https://github.com/jackc', 'followers_url': 'https://api.github.com/users/jackc/followers', 'following_url': 'https://api.github.com/users/jackc/following{/other_user}', 'gists_url': 'https://api.github.com/users/jackc/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jackc/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jackc/subscriptions', 'organizations_url': 'https://api.github.com/users/jackc/orgs', 'repos_url': 'https://api.github.com/users/jackc/repos', 'events_url': 'https://api.github.com/users/jackc/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jackc/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2023-10-05T19:40:39Z,2023-10-06T00:07:56Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

Use ActiveRecord to create a record in a PostgreSQL table with a primary key `generated by default as identity` or `generated always as identity`. The database generated id will not be returned and assigned to the new record.

This worked in Rails v7.0.8 and fails in v7.1.0.

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.1.0""
  gem ""pg"", ""~> 1.5.4""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(ENV.fetch(""DATABASE_URL"", ""postgres:///""))
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Base.connection.exec_query <<~SQL
  create temporary table people (
    id int primary key generated by default as identity,
    name text not null
  );
SQL

class Person < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_id_is_returned
    person = Person.create! name: ""Jack""
    assert person.id
  end
end
```

### Expected behavior

`person.id` should have the value from the database.

### Actual behavior
<!-- Tell us what happens instead -->

`person.id` is `nil`.

### System configuration
**Rails version**: 7.1.0

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49502/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49502/timeline,,
https://api.github.com/repos/rails/rails/issues/49500,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49500/labels{/name},https://api.github.com/repos/rails/rails/issues/49500/comments,https://api.github.com/repos/rails/rails/issues/49500/events,https://github.com/rails/rails/issues/49500,1928487281,I_kwDNIULOcvJhcQ,49500, `Could not find table` in CI even though `db:test:prepare` has been run,"{'login': 'deanpcmad', 'id': 425200, 'node_id': 'MDQ6VXNlcjQyNTIwMA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/425200?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/deanpcmad', 'html_url': 'https://github.com/deanpcmad', 'followers_url': 'https://api.github.com/users/deanpcmad/followers', 'following_url': 'https://api.github.com/users/deanpcmad/following{/other_user}', 'gists_url': 'https://api.github.com/users/deanpcmad/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/deanpcmad/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/deanpcmad/subscriptions', 'organizations_url': 'https://api.github.com/users/deanpcmad/orgs', 'repos_url': 'https://api.github.com/users/deanpcmad/repos', 'events_url': 'https://api.github.com/users/deanpcmad/events{/privacy}', 'received_events_url': 'https://api.github.com/users/deanpcmad/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,7,2023-10-05T14:50:18Z,2023-10-06T02:22:03Z,,NONE,,,,"When creating a new Rails app with 7.1.0, which is setup to test in GitHub actions, it fails with a `Could not find table` error.

With 7.1.0.rc2, it works fine, so something has changed in the last few days.

An example app is here: https://github.com/deanpcmad/blogtest

Of which you can see the actions logs for [7.1.0](https://github.com/deanpcmad/blogtest/actions/runs/6420609711/job/17433065722) or for [7.1.0.rc2](https://github.com/deanpcmad/blogtest/actions/runs/6420698975/job/17433371320)

### System configuration
**Rails version**: 7.1.0

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49500/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49500/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/49499,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49499/labels{/name},https://api.github.com/repos/rails/rails/issues/49499/comments,https://api.github.com/repos/rails/rails/issues/49499/events,https://github.com/rails/rails/issues/49499,1928198301,I_kwDNIULOcu34nQ,49499,Undocumented breaking change for @rails/ujs,"{'login': 'Earlopain', 'id': 14981592, 'node_id': 'MDQ6VXNlcjE0OTgxNTky', 'avatar_url': 'https://avatars.githubusercontent.com/u/14981592?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Earlopain', 'html_url': 'https://github.com/Earlopain', 'followers_url': 'https://api.github.com/users/Earlopain/followers', 'following_url': 'https://api.github.com/users/Earlopain/following{/other_user}', 'gists_url': 'https://api.github.com/users/Earlopain/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Earlopain/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Earlopain/subscriptions', 'organizations_url': 'https://api.github.com/users/Earlopain/orgs', 'repos_url': 'https://api.github.com/users/Earlopain/repos', 'events_url': 'https://api.github.com/users/Earlopain/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Earlopain/received_events', 'type': 'User', 'site_admin': False}","[{'id': 603319189, 'node_id': 'MDU6TGFiZWw2MDMzMTkxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/rails-ujs', 'name': 'rails-ujs', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,4,2023-10-05T12:41:04Z,2023-10-06T00:08:46Z,,CONTRIBUTOR,,,,"During the upgrade from 7.0 to 7.1 I had to change how @rails/ujs is getting initialized from

```js
import Rails from ""@rails/ujs""
Rails.start()
```

to

```js
import ""@rails/ujs"";
```

The explicit import seems to now have side-effects as it complains about ujs already being initialized.
![image](https://github.com/rails/rails/assets/14981592/0cefbc8b-4314-405d-9100-c002f0b5b746)

https://github.com/rails/rails/tree/main/actionview/app/javascript suggests that the previous usage is still correct.

I'm using esbuild to bundle my js, specifically with this command:
`esbuild app/typescript/*.* --target=es2022 --bundle --sourcemap --outdir=./public/build`

Is this a bug with my setup or in ujs itself?

### Expected behavior
<!-- Tell us what should happen -->

### Actual behavior
<!-- Tell us what happens instead -->

### System configuration
**Rails version**: 7.1

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49499/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49499/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/49494,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49494/labels{/name},https://api.github.com/repos/rails/rails/issues/49494/comments,https://api.github.com/repos/rails/rails/issues/49494/events,https://github.com/rails/rails/issues/49494,1927900439,I_kwDNIULOcultFw,49494,"Indicate in the changelog/release notes for 7.1, that `Rails.logger` is now a `BroadcastLogger`","{'login': 'mensfeld', 'id': 392754, 'node_id': 'MDQ6VXNlcjM5Mjc1NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/392754?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mensfeld', 'html_url': 'https://github.com/mensfeld', 'followers_url': 'https://api.github.com/users/mensfeld/followers', 'following_url': 'https://api.github.com/users/mensfeld/following{/other_user}', 'gists_url': 'https://api.github.com/users/mensfeld/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mensfeld/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mensfeld/subscriptions', 'organizations_url': 'https://api.github.com/users/mensfeld/orgs', 'repos_url': 'https://api.github.com/users/mensfeld/repos', 'events_url': 'https://api.github.com/users/mensfeld/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mensfeld/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,"{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}, {'login': 'Edouard-chin', 'id': 8122246, 'node_id': 'MDQ6VXNlcjgxMjIyNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8122246?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Edouard-chin', 'html_url': 'https://github.com/Edouard-chin', 'followers_url': 'https://api.github.com/users/Edouard-chin/followers', 'following_url': 'https://api.github.com/users/Edouard-chin/following{/other_user}', 'gists_url': 'https://api.github.com/users/Edouard-chin/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Edouard-chin/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Edouard-chin/subscriptions', 'organizations_url': 'https://api.github.com/users/Edouard-chin/orgs', 'repos_url': 'https://api.github.com/users/Edouard-chin/repos', 'events_url': 'https://api.github.com/users/Edouard-chin/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Edouard-chin/received_events', 'type': 'User', 'site_admin': False}]","{'url': 'https://api.github.com/repos/rails/rails/milestones/84', 'html_url': 'https://github.com/rails/rails/milestone/84', 'labels_url': 'https://api.github.com/repos/rails/rails/milestones/84/labels', 'id': 10007455, 'node_id': 'MI_kwDNIULOAJiznw', 'number': 84, 'title': '7.1.1', 'description': None, 'creator': {'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}, 'open_issues': 1, 'closed_issues': 0, 'state': 'open', 'created_at': '2023-10-05T15:14:29Z', 'updated_at': '2023-10-05T15:14:29Z', 'due_on': None, 'closed_at': None}",1,2023-10-05T10:09:12Z,2023-10-06T03:21:25Z,,CONTRIBUTOR,,,,"Following on my discussion with @rafaelfranca:

My gem [karafka](https://github.com/karafka/karafka) integrates with the Rails logger via a Railtie using the ""unofficial"" broadcast  API as follows:

https://github.com/karafka/karafka/blob/b32be801a9a81853d81bbe249a76388acfd5876b/lib/karafka/railtie.rb#L49

Rails 7.1 has replaced the `#broadcast` module with a `BroadcastLogger` and because of that I wanted to upgrade my integration. After reading the docs what I did was that (in railtie:

```ruby
rails_logger = Rails.logger

stdout_logger = ActiveSupport::Logger.new($stdout)
stdout_logger.level = Rails.logger.level

Rails.logger = ActiveSupport::BroadcastLogger.new(
  rails_logger,
  stdout_logger
)
```
basically wrapping the native Rails logger and my logger with a broadcast and using this as a Rails logger.

While it worked for my case, it caused following issue for any ActiveJobs:

```
/gems/3.1.0/gems/activejob-7.1.0/lib/active_job/logging.rb:32:in `logger_tagged_by_active_job?': undefined method `current_tags' for nil:NilClass (NoMethodError)

        logger.formatter.current_tags.include?(""ActiveJob"")
```

that is because BroadcastLogger is proxying only the logger API (which makes sense).

My approach was based on the docs as they did not clearly state that `Rails.logger` is now a broadcast logger itself with the extra APIs needed and that instead of wrapping it with a BroadcastLogger the upgrade path is to use a `broadcast_to` delegator on the Rails logger itself effectively replacing the above code with:

```ruby
stdout_logger = ActiveSupport::Logger.new($stdout)

Rails.logger.broadcast_to(stdout_logger)
```

it is not stated in the [release notes](https://edgeguides.rubyonrails.org/7_1_release_notes.html) or at least it was not exactly clear to me how to upgrade my integration to achieve the pre 7.1 behaviour without any errors.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49494/reactions', 'total_count': 2, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/49494/timeline,,
https://api.github.com/repos/rails/rails/issues/49490,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49490/labels{/name},https://api.github.com/repos/rails/rails/issues/49490/comments,https://api.github.com/repos/rails/rails/issues/49490/events,https://github.com/rails/rails/pull/49490,1927141945,PR_kwDNIULOW_M5AQ,49490,Improve `Rails::Generators::Actions` logging and debugging,"{'login': 'stevepolitodesign', 'id': 5122678, 'node_id': 'MDQ6VXNlcjUxMjI2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5122678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/stevepolitodesign', 'html_url': 'https://github.com/stevepolitodesign', 'followers_url': 'https://api.github.com/users/stevepolitodesign/followers', 'following_url': 'https://api.github.com/users/stevepolitodesign/following{/other_user}', 'gists_url': 'https://api.github.com/users/stevepolitodesign/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/stevepolitodesign/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/stevepolitodesign/subscriptions', 'organizations_url': 'https://api.github.com/users/stevepolitodesign/orgs', 'repos_url': 'https://api.github.com/users/stevepolitodesign/repos', 'events_url': 'https://api.github.com/users/stevepolitodesign/events{/privacy}', 'received_events_url': 'https://api.github.com/users/stevepolitodesign/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-04T23:57:03Z,2023-10-05T13:11:49Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49490', 'html_url': 'https://github.com/rails/rails/pull/49490', 'diff_url': 'https://github.com/rails/rails/pull/49490.diff', 'patch_url': 'https://github.com/rails/rails/pull/49490.patch', 'merged_at': None}","### Motivation / Background

This commit is a follow-up to #49448, with regards to [this comment][].

Prior to this commit, logging and debugging for
[Rails::Generators::Actions][] was limited even when enabling `RAILS_LOG_TO_STDOUT`. This was because the private `action` method in the corresponding test was capturing `$stdout`.

#### Before

https://github.com/rails/rails/assets/5122678/caa0dbb9-2664-41cf-83fd-e130effa87be

#### After

https://github.com/rails/rails/assets/5122678/c5753449-f678-4486-b297-9be48a4e7619

[this comment]: https://github.com/rails/rails/pull/49448#issuecomment-1743061538
[Rails::Generators::Actions]: https://api.rubyonrails.org/v7.0.8/classes/Rails/Generators/Actions.html

### Detail

We simply conditionally capture the `stdout` like we did in  #49448.

```diff
4220d82e93 Improve generator logging and debugging
diff --git a/railties/test/generators/actions_test.rb b/railties/test/generators/actions_test.rb
index 6b5cdcf781..51a006ca87 100644
--- a/railties/test/generators/actions_test.rb
+++ b/railties/test/generators/actions_test.rb
@@ -720,7 +720,11 @@ def test_log_with_status_with_quiet
 
   private
     def action(...)
-      capture(:stdout) { generator.send(...) }
+      if ENV[""RAILS_LOG_TO_STDOUT""] == ""true""
+        generator.send(...)
+      else
+        capture(:stdout) { generator.send(...) }
+      end
     end
 
     def revoke(...)

```

### Additional information

It's possible other call sites in the test suite need to be updated, but I wanted to keep this commit focused.  

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49490/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49490/timeline,,
https://api.github.com/repos/rails/rails/issues/49489,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49489/labels{/name},https://api.github.com/repos/rails/rails/issues/49489/comments,https://api.github.com/repos/rails/rails/issues/49489/events,https://github.com/rails/rails/issues/49489,1926911555,I_kwDNIULOctpWQw,49489,Cache-Control header should be lower-case for static files with Rack 3,"{'login': 'zarqman', 'id': 22556, 'node_id': 'MDQ6VXNlcjIyNTU2', 'avatar_url': 'https://avatars.githubusercontent.com/u/22556?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zarqman', 'html_url': 'https://github.com/zarqman', 'followers_url': 'https://api.github.com/users/zarqman/followers', 'following_url': 'https://api.github.com/users/zarqman/following{/other_user}', 'gists_url': 'https://api.github.com/users/zarqman/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zarqman/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zarqman/subscriptions', 'organizations_url': 'https://api.github.com/users/zarqman/orgs', 'repos_url': 'https://api.github.com/users/zarqman/repos', 'events_url': 'https://api.github.com/users/zarqman/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zarqman/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,4,2023-10-04T20:14:47Z,2023-10-05T17:26:33Z,,CONTRIBUTOR,,,,"Responses from `ActionDispatch::Static` can return a mixed-case Cache-Control header on Rails 7.1 with Rack 3.

a) If `Cache-Control` is specified as part of `environments/*.rb` (which is the default on `development` and `test`), its casing is passed through as-is. I don't know if generators for `rails new` and `app:update` should be aware of Rack 3 and update this to lower-case or if it should be modified to lower-case during rails initialization or for each static response. 

Alternatively, the default could just be switched to lower-case since Rack 3 is likely to be pulled in for Rails 7.1 apps--not sure if that's safe if an app ends up running Rack 2 (perhaps because some other gem constrains it).

b) Related, `Content-Length` appears to be mixed-case all the time (both static files and normal controller actions).

### Steps to reproduce

Make sure the app is configured to use Rack 3.

Run `rails dev:cache` if not already enabled (to expose `cache-control` when in `development` mode):
```bash
$ rails dev:cache
Development mode is now being cached.
```

### Expected behavior

```bash
$ curl -I http://localhost:3000/robots.txt
HTTP/1.1 200 OK
last-modified: Sun, 18 Dec 2022 07:14:50 GMT
content-type: text/plain
cache-control: public, max-age=172800
content-length: 150
```

And, if (a) should manage the case of `cache-control` directly in `config/environments/{development,production,test}.rb`, `rails app:update` should offer this:

```ruby
  # example for development.rb
  config.public_file_server.headers = {
    ""cache-control"" => ""public, max-age=#{2.days.to_i}""
  }
```

### Actual behavior

Note the case of the final 2 lines.
```bash
$ curl -I http://localhost:3000/robots.txt
HTTP/1.1 200 OK
last-modified: Sun, 18 Dec 2022 07:14:50 GMT
content-type: text/plain
Cache-Control: public, max-age=172800
Content-Length: 150
```

And again, depending on (a):

```ruby
  # example for development.rb
  config.public_file_server.headers = {
    ""Cache-Control"" => ""public, max-age=#{2.days.to_i}""
  }
```


### System configuration
**Rails version**: 7.1.0.rc2

**Ruby version**: 3.2.2

**Rack version**: 3.0.8
","{'url': 'https://api.github.com/repos/rails/rails/issues/49489/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49489/timeline,,
https://api.github.com/repos/rails/rails/issues/49488,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49488/labels{/name},https://api.github.com/repos/rails/rails/issues/49488/comments,https://api.github.com/repos/rails/rails/issues/49488/events,https://github.com/rails/rails/pull/49488,1926560441,PR_kwDNIULOW-tYWw,49488,Add materialized? to NullTransaction,"{'login': 'pjambet', 'id': 717637, 'node_id': 'MDQ6VXNlcjcxNzYzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/717637?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pjambet', 'html_url': 'https://github.com/pjambet', 'followers_url': 'https://api.github.com/users/pjambet/followers', 'following_url': 'https://api.github.com/users/pjambet/following{/other_user}', 'gists_url': 'https://api.github.com/users/pjambet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pjambet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pjambet/subscriptions', 'organizations_url': 'https://api.github.com/users/pjambet/orgs', 'repos_url': 'https://api.github.com/users/pjambet/repos', 'events_url': 'https://api.github.com/users/pjambet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pjambet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-10-04T16:11:07Z,2023-10-05T01:05:33Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49488', 'html_url': 'https://github.com/rails/rails/pull/49488', 'diff_url': 'https://github.com/rails/rails/pull/49488.diff', 'patch_url': 'https://github.com/rails/rails/pull/49488.patch', 'merged_at': None}","### Motivation / Background

Checking if the current transaction is materialized cannot be done directly from the `materialized?` method because `NullTransaction` doesn't implemented `materialized?`

A workaround is to first check if the transaction is open:

```ruby
current_transaction = ActiveRecord::Base.connection.current_transaction
current_transaction.open? && current_transaction.materialized?
```

With this change we can skip the extra check on `open?`

```ruby
current_transaction = ActiveRecord::Base.connection.current_transaction
current_transaction.materialized?
```

### Detail

This PR continues the null object pattern approach for the `NullTransaction` by implementing `materialized?` to always return `false`, the same way it always returns `false` for `open?`

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

I couldn't find existing tests for this, so wasn't sure whether or not to add some.

@matthewd I was told to ask you about this change.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49488/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49488/timeline,,
https://api.github.com/repos/rails/rails/issues/49486,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49486/labels{/name},https://api.github.com/repos/rails/rails/issues/49486/comments,https://api.github.com/repos/rails/rails/issues/49486/events,https://github.com/rails/rails/pull/49486,1926281738,PR_kwDNIULOW-eFuQ,49486,Extend `validates_associated` to accept a block,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-04T13:56:45Z,2023-10-04T14:02:06Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49486', 'html_url': 'https://github.com/rails/rails/pull/49486', 'diff_url': 'https://github.com/rails/rails/pull/49486.diff', 'patch_url': 'https://github.com/rails/rails/pull/49486.patch', 'merged_at': None}","### Motivation / Background

Sometimes there are context-specific reasons to validate a particular field on an associated model. While it's possible to opt-into and opt-out of validation with contexts (the `on:` option), this commit proposes an alternative that extends validations declared with `validates_associated` and `validates ..., associated: true`.

For example, consider a `User` model with an optional `name` attribute. In most cases, the `User#name` isn't required, but let's say that a name _is_ required when the `User` is related to a `Book` as its `Author`.

### Detail

With the changes in this commit, the `Book` can` pass a block to declare additional validations on the relationship:

```ruby
class Book < ActiveRecord::Base
  belongs_to :author, class: User

  validates_associated :author do |author|
    author.validates_presence_of :name
  end
end
```

The block's parameter is optional, and can be omitted:

```ruby
validates_associated :author do
  validates_presence_of :name
end
```

When configuring the validation with options, pass a lambda as the +with:+ option:

```ruby
validates_associated :author,
  with: -> { validates_presence_of :name },
  unless: :anonymous?
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49486/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49486/timeline,,
https://api.github.com/repos/rails/rails/issues/49485,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49485/labels{/name},https://api.github.com/repos/rails/rails/issues/49485/comments,https://api.github.com/repos/rails/rails/issues/49485/events,https://github.com/rails/rails/pull/49485,1926274480,PR_kwDNIULOW-dr_g,49485,Run `test_expression_index` if `supports_expression_index?` returns true,"{'login': 'yahonda', 'id': 73684, 'node_id': 'MDQ6VXNlcjczNjg0', 'avatar_url': 'https://avatars.githubusercontent.com/u/73684?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/yahonda', 'html_url': 'https://github.com/yahonda', 'followers_url': 'https://api.github.com/users/yahonda/followers', 'following_url': 'https://api.github.com/users/yahonda/following{/other_user}', 'gists_url': 'https://api.github.com/users/yahonda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/yahonda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/yahonda/subscriptions', 'organizations_url': 'https://api.github.com/users/yahonda/orgs', 'repos_url': 'https://api.github.com/users/yahonda/repos', 'events_url': 'https://api.github.com/users/yahonda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/yahonda/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-10-04T13:53:28Z,2023-10-04T16:22:08Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49485', 'html_url': 'https://github.com/rails/rails/pull/49485', 'diff_url': 'https://github.com/rails/rails/pull/49485.diff', 'patch_url': 'https://github.com/rails/rails/pull/49485.patch', 'merged_at': None}","### Motivation / Background

This test runs the `test_expression_index` test if `supports_expression_index?` returns true.

### Detail
SQL statement to create unique index for generated column.
- `sqlite3` adapter CREATE UNIQUE INDEX ""topics_index"" ON ""topics"" ((LOWER(title)))
- `mysql2` and `trilogy` adapter CREATE UNIQUE INDEX `topics_index` ON `topics` ((LOWER(title)))
- `postgresql` adapter CREATE UNIQUE INDEX ""topics_index"" ON ""topics"" ((LOWER(title)))

Follow up #49483

### Additional information
None

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49485/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49485/timeline,,
https://api.github.com/repos/rails/rails/issues/49473,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49473/labels{/name},https://api.github.com/repos/rails/rails/issues/49473/comments,https://api.github.com/repos/rails/rails/issues/49473/events,https://github.com/rails/rails/issues/49473,1924388730,I_kwDNIULOcrPXeg,49473,Strict loading in `:n_plus_one_only` mode should not eager load child associations,"{'login': 'reid-rigo', 'id': 2439912, 'node_id': 'MDQ6VXNlcjI0Mzk5MTI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2439912?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/reid-rigo', 'html_url': 'https://github.com/reid-rigo', 'followers_url': 'https://api.github.com/users/reid-rigo/followers', 'following_url': 'https://api.github.com/users/reid-rigo/following{/other_user}', 'gists_url': 'https://api.github.com/users/reid-rigo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/reid-rigo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/reid-rigo/subscriptions', 'organizations_url': 'https://api.github.com/users/reid-rigo/orgs', 'repos_url': 'https://api.github.com/users/reid-rigo/repos', 'events_url': 'https://api.github.com/users/reid-rigo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/reid-rigo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-10-03T15:23:23Z,2023-10-04T10:57:29Z,,CONTRIBUTOR,,,,"### Description
Strict loading in `:n_plus_one_only` mode is designed to prevent performance issues when deeply traversing associations. It allows `Person.find(1).posts`, but _not_ `Person.find(1).posts.map(&:category)`. This fix avoids the surprise that occurs when `person.posts.first` eagerly loads the whole association rather than allowing the user to manage the child association.

This fixes a serious ordering issue. Without strict loading, `person.posts.first` is guaranteed to return the first post in primary key order. On the other hand, `person.posts.load.first` is nondeterministic. The database is not guaranteed to return in a consistent order, in particular under load with other operations occurring. This is a rude surprise when trying to use `:n_plus_one_only` mode.

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
This can be reproduced via any `has_many` association. Here's an example using ActiveRecord test models:
```ruby
person = Person.find(1)
person.strict_loading!(mode: :n_plus_one_only)
person.posts.first
# SELECT * FROM posts WHERE person_id = 1; -- non-deterministic order
```

### Expected behavior
<!-- Tell us what should happen -->
```ruby
person = Person.find(1)
person.strict_loading!(mode: :n_plus_one_only)
person.posts.first # this is 1+1, not N+1
# SELECT * FROM posts WHERE person_id = 1 ORDER BY id LIMIT 1;
```

### Actual behavior
<!-- Tell us what happens instead -->
```ruby
person = Person.find(1)
person.strict_loading!(mode: :n_plus_one_only)
person.posts.first
# SELECT * FROM posts WHERE person_id = 1; -- non-deterministic order
```

### Proposed fix
Please see #48785 

### System configuration
**Rails version**: `rails (7.0.7.2)`
**Ruby version**: `ruby 3.2.2`
","{'url': 'https://api.github.com/repos/rails/rails/issues/49473/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49473/timeline,,
https://api.github.com/repos/rails/rails/issues/49472,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49472/labels{/name},https://api.github.com/repos/rails/rails/issues/49472/comments,https://api.github.com/repos/rails/rails/issues/49472/events,https://github.com/rails/rails/pull/49472,1924200457,PR_kwDNIULOW8tPiw,49472,[ci skip] Change `resourceful` to `resource` for clarity,"{'login': 'mateusdeap', 'id': 14188887, 'node_id': 'MDQ6VXNlcjE0MTg4ODg3', 'avatar_url': 'https://avatars.githubusercontent.com/u/14188887?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mateusdeap', 'html_url': 'https://github.com/mateusdeap', 'followers_url': 'https://api.github.com/users/mateusdeap/followers', 'following_url': 'https://api.github.com/users/mateusdeap/following{/other_user}', 'gists_url': 'https://api.github.com/users/mateusdeap/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mateusdeap/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mateusdeap/subscriptions', 'organizations_url': 'https://api.github.com/users/mateusdeap/orgs', 'repos_url': 'https://api.github.com/users/mateusdeap/repos', 'events_url': 'https://api.github.com/users/mateusdeap/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mateusdeap/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,7,2023-10-03T13:50:48Z,2023-10-04T10:46:14Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49472', 'html_url': 'https://github.com/rails/rails/pull/49472', 'diff_url': 'https://github.com/rails/rails/pull/49472.diff', 'patch_url': 'https://github.com/rails/rails/pull/49472.patch', 'merged_at': None}","### Motivation / Background
Fixes #49327

This Pull Request simply changes the wording around the definition of what are resource routes and, specifically, what's a ""resourceful controller"", by calling it a ""resource controller"" instead.

As discussed in the issue, although the previous term was fine given the context of the guide, it was probably an improper term, since the meaning seems to be ""the controller for a given resource"" rather than a special type of controller that is said to be resourceful. Furthermore, the term itself, as far as I know, I've only ever seen in the rails guides, whereas `resource controller` seems to be of more common use.

### Detail

As stated above, I change here `resourceful controller` to `resource controller`.

### Additional information

N/A

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49472/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49472/timeline,,
https://api.github.com/repos/rails/rails/issues/49468,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49468/labels{/name},https://api.github.com/repos/rails/rails/issues/49468/comments,https://api.github.com/repos/rails/rails/issues/49468/events,https://github.com/rails/rails/issues/49468,1923447962,I_kwDNIULOcqV8mg,49468,`validates_uniqueness_of` does not work with `mark_for_destruction`,"{'login': 'ghiculescu', 'id': 509837, 'node_id': 'MDQ6VXNlcjUwOTgzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/509837?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ghiculescu', 'html_url': 'https://github.com/ghiculescu', 'followers_url': 'https://api.github.com/users/ghiculescu/followers', 'following_url': 'https://api.github.com/users/ghiculescu/following{/other_user}', 'gists_url': 'https://api.github.com/users/ghiculescu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ghiculescu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ghiculescu/subscriptions', 'organizations_url': 'https://api.github.com/users/ghiculescu/orgs', 'repos_url': 'https://api.github.com/users/ghiculescu/repos', 'events_url': 'https://api.github.com/users/ghiculescu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ghiculescu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,5,2023-10-03T06:56:13Z,2023-10-04T23:59:47Z,,MEMBER,,,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.text :title
    t.integer :post_id

    t.index [:title, :post_id], unique: true
  end
end

class Post < ActiveRecord::Base
  has_many :comments, autosave: true
end

class Comment < ActiveRecord::Base
  belongs_to :post
  validates_uniqueness_of :title
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!
    post.comments.create!(title: ""hi"")

    # reload
    post = Post.find(post.id)

    post.comments[0].mark_for_destruction
    post.comments.build(title: ""hi"")

    # raises ActiveRecord::RecordInvalid: Validation failed: Comments title has already been take
    post.save!

    assert_equal 1, post.comments.count
  end
end
```

### Expected behavior
I expect the test to pass.

### Actual behavior
`post.save!` raises with a validation error.

If you remove the `validates_uniqueness_of` and just keep the unique database constraint, the test passes. I expect `validates_uniqueness_of` to do the same thing as an equivalent database index, so I expect it to not block the save here.

Before working on a PR I'd like to get confirmation on if this expectation is wrong.

### System configuration
**Rails version**: main

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49468/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49468/timeline,,
https://api.github.com/repos/rails/rails/issues/49464,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49464/labels{/name},https://api.github.com/repos/rails/rails/issues/49464/comments,https://api.github.com/repos/rails/rails/issues/49464/events,https://github.com/rails/rails/issues/49464,1923143559,I_kwDNIULOcqDXhw,49464,`RubyTrackerTest` fail using ruby 3.3.0dev since ruby/ruby#8573,"{'login': 'yahonda', 'id': 73684, 'node_id': 'MDQ6VXNlcjczNjg0', 'avatar_url': 'https://avatars.githubusercontent.com/u/73684?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/yahonda', 'html_url': 'https://github.com/yahonda', 'followers_url': 'https://api.github.com/users/yahonda/followers', 'following_url': 'https://api.github.com/users/yahonda/following{/other_user}', 'gists_url': 'https://api.github.com/users/yahonda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/yahonda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/yahonda/subscriptions', 'organizations_url': 'https://api.github.com/users/yahonda/orgs', 'repos_url': 'https://api.github.com/users/yahonda/repos', 'events_url': 'https://api.github.com/users/yahonda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/yahonda/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 776781281, 'node_id': 'MDU6TGFiZWw3NzY3ODEyODE=', 'url': 'https://api.github.com/repos/rails/rails/labels/ci%20issues', 'name': 'ci issues', 'color': 'aaafff', 'default': False, 'description': None}]",open,False,,[],,1,2023-10-03T02:02:33Z,2023-10-03T02:03:15Z,,MEMBER,,,,"Managed to reproduce CI failure at https://buildkite.com/rails/rails/builds/100319#018af314-f0bd-4ea0-ae84-f2f576479e56/1090-1099

### Steps to reproduce
1. Install `ruby 3.3.0dev` including https://github.com/ruby/ruby/pull/8573
```ruby
cd actionview
bin/test test/template/dependency_tracker_test.rb -n /test_finds_dependenc/
```

### Expected behavior
It should pass.

### Actual behavior

```ruby
$ bin/test test/template/dependency_tracker_test.rb -n /test_finds_dependenc/
Running 39 tests in a single process (parallelization threshold is 50)
Run options: -n /test_finds_dependenc/ --seed 56149

# Running:

E

Error:
RubyTrackerTest#test_finds_dependencies_on_method_chains:
NoMethodError: undefined method `pluralize' for an instance of Symbol
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:120:in `render_call_template'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:18:in `render_calls'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:32:in `render_dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:13:in `dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/test/template/dependency_tracker_test.rb:158:in `test_finds_dependencies_on_method_chains'


bin/test test/template/dependency_tracker_test.rb:154

..E

Error:
RubyTrackerTest#test_finds_dependencies_with_extra_spaces:
NoMethodError: undefined method `pluralize' for an instance of Symbol
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:120:in `render_call_template'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:18:in `render_calls'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:32:in `render_dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:13:in `dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/test/template/dependency_tracker_test.rb:197:in `test_finds_dependencies_with_extra_spaces'


bin/test test/template/dependency_tracker_test.rb:179

E

Error:
RubyTrackerTest#test_finds_dependency_in_correct_directory:
NoMethodError: undefined method `pluralize' for an instance of Symbol
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:120:in `render_call_template'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:18:in `render_calls'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:32:in `render_dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:13:in `dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/test/template/dependency_tracker_test.rb:85:in `test_finds_dependency_in_correct_directory'


bin/test test/template/dependency_tracker_test.rb:81

E

Error:
RubyTrackerTest#test_finds_dependencies_with_bare_assoc_hash_on_constant:
NoMethodError: undefined method `pluralize' for an instance of Symbol
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:120:in `render_call_template'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:18:in `render_calls'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:32:in `render_dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:13:in `dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/test/template/dependency_tracker_test.rb:209:in `test_finds_dependencies_with_bare_assoc_hash_on_constant'


bin/test test/template/dependency_tracker_test.rb:200

..E

Error:
RubyTrackerTest#test_finds_dependency_in_correct_directory_with_underscore:
NoMethodError: undefined method `pluralize' for an instance of Symbol
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:120:in `render_call_template'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/render_parser/prism_render_parser.rb:18:in `render_calls'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:32:in `render_dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/lib/action_view/dependency_tracker/ruby_tracker.rb:13:in `dependencies'
    /home/yahonda/src/github.com/rails/rails/actionview/test/template/dependency_tracker_test.rb:92:in `test_finds_dependency_in_correct_directory_with_underscore'


bin/test test/template/dependency_tracker_test.rb:88

.........

Finished in 0.010077s, 1786.3040 runs/s, 1290.1085 assertions/s.
18 runs, 13 assertions, 0 failures, 5 errors, 0 skips
$
```
### System configuration
**Rails version**: main branch

**Ruby version**: ruby 3.3.0dev (2023-10-02T13:18:56Z master 87dad067e0) [x86_64-linux]
","{'url': 'https://api.github.com/repos/rails/rails/issues/49464/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49464/timeline,,
https://api.github.com/repos/rails/rails/issues/49459,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49459/labels{/name},https://api.github.com/repos/rails/rails/issues/49459/comments,https://api.github.com/repos/rails/rails/issues/49459/events,https://github.com/rails/rails/issues/49459,1922437228,I_kwDNIULOcpYQbA,49459,Reading from read replica using connected_to method will not enforce limit query,"{'login': 'taman9333', 'id': 29257107, 'node_id': 'MDQ6VXNlcjI5MjU3MTA3', 'avatar_url': 'https://avatars.githubusercontent.com/u/29257107?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/taman9333', 'html_url': 'https://github.com/taman9333', 'followers_url': 'https://api.github.com/users/taman9333/followers', 'following_url': 'https://api.github.com/users/taman9333/following{/other_user}', 'gists_url': 'https://api.github.com/users/taman9333/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/taman9333/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/taman9333/subscriptions', 'organizations_url': 'https://api.github.com/users/taman9333/orgs', 'repos_url': 'https://api.github.com/users/taman9333/repos', 'events_url': 'https://api.github.com/users/taman9333/events{/privacy}', 'received_events_url': 'https://api.github.com/users/taman9333/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,16,2023-10-02T18:41:57Z,2023-10-03T15:02:08Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
ActiveRecord::Base.connected_to(role: :reading) { Customer.where(name: ""Roberto"") }
```

### Expected behavior
<!-- Tell us what should happen -->
SELECT ""customers"".* FROM ""customers"" WHERE ""customers"".""name"" = 'Roberto' LIMIT 11.

### Actual behavior
<!-- Tell us what happens instead -->
SELECT ""customers"".* FROM ""customers"" WHERE ""customers"".""name"" = 'Roberto' 

Query without limit can lead to a query that would take a lot of time to execute, so I am wondering why using `connected_to` will not add limit query implicitly exactly as if we are executing query without using `connected_to`

Doing the following query in rails console
```ruby
Customer.where(name: ""Roberto"")
```

will generate the following sql
SELECT ""customers"".* FROM ""customers"" WHERE ""customers"".""name"" = 'Roberto' LIMIT 11.

### System configuration
**Rails version**: 6.0.5.1

**Ruby version**: 2.7.6
","{'url': 'https://api.github.com/repos/rails/rails/issues/49459/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49459/timeline,,
https://api.github.com/repos/rails/rails/issues/49455,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49455/labels{/name},https://api.github.com/repos/rails/rails/issues/49455/comments,https://api.github.com/repos/rails/rails/issues/49455/events,https://github.com/rails/rails/pull/49455,1921732176,PR_kwDNIULOW6nHSQ,49455,Turn skips into errors on Rails CI,"{'login': 'casperisfine', 'id': 19192189, 'node_id': 'MDQ6VXNlcjE5MTkyMTg5', 'avatar_url': 'https://avatars.githubusercontent.com/u/19192189?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/casperisfine', 'html_url': 'https://github.com/casperisfine', 'followers_url': 'https://api.github.com/users/casperisfine/followers', 'following_url': 'https://api.github.com/users/casperisfine/following{/other_user}', 'gists_url': 'https://api.github.com/users/casperisfine/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/casperisfine/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/casperisfine/subscriptions', 'organizations_url': 'https://api.github.com/users/casperisfine/orgs', 'repos_url': 'https://api.github.com/users/casperisfine/repos', 'events_url': 'https://api.github.com/users/casperisfine/events{/privacy}', 'received_events_url': 'https://api.github.com/users/casperisfine/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,2,2023-10-02T11:26:57Z,2023-10-02T12:01:52Z,,CONTRIBUTOR,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49455', 'html_url': 'https://github.com/rails/rails/pull/49455', 'diff_url': 'https://github.com/rails/rails/pull/49455.diff', 'patch_url': 'https://github.com/rails/rails/pull/49455.patch', 'merged_at': None}","We had a few cases of tests being skipped accidentally on CI hence not being ran for a long time (e.g. https://github.com/rails/rails/pull/49414).

Skipping make sense when running the test suite locally, e.g. you may not have Redis or some other dependency running.

But on CI, a test not being ran should be considered an error.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49455/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/49455/timeline,,
https://api.github.com/repos/rails/rails/issues/49445,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49445/labels{/name},https://api.github.com/repos/rails/rails/issues/49445/comments,https://api.github.com/repos/rails/rails/issues/49445/events,https://github.com/rails/rails/pull/49445,1920820336,PR_kwDNIULOW53EzQ,49445,Support multiple analyzers during `ActiveStorage::Blob#analyze`,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,2,2023-10-01T15:18:51Z,2023-10-01T21:15:46Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49445', 'html_url': 'https://github.com/rails/rails/pull/49445', 'diff_url': 'https://github.com/rails/rails/pull/49445.diff', 'patch_url': 'https://github.com/rails/rails/pull/49445.patch', 'merged_at': None}","
### Motivation / Background

Prior to this commit, Blob analysis could only involve a single Analyzer. By default, the metadata typically includes information about dimensions (for image and video).

If applications need to include more involved analysis, they also have to re-implement the dimension analysis on their own (either through composition, inheritance, or copy-pasting).

### Detail

This commit extends analysis to support *multiple* anaylzer classes by replacing [Enumerable#detect][] with [Enumerable#select][], and a [Hash#merge][] with an [Enumerable#reduce][].

[Enumerable#detect]: https://ruby-doc.org/core-3.0.2/Enumerable.html#method-i-detect
[Enumerable#select]: https://ruby-doc.org/core-3.0.2/Enumerable.html#method-i-select
[Hash#merge]: https://ruby-doc.org/3.2.2/Hash.html#method-i-hash
[Enumerable#reduce]: https://ruby-doc.org/core-3.0.2/Enumerable.html#method-i-reduce

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49445/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49445/timeline,,
https://api.github.com/repos/rails/rails/issues/49434,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49434/labels{/name},https://api.github.com/repos/rails/rails/issues/49434/comments,https://api.github.com/repos/rails/rails/issues/49434/events,https://github.com/rails/rails/issues/49434,1919673545,I_kwDNIULOcmvkyQ,49434,"Using group and aggregated functions on dates with sqlite3, returns date as a string and not as a Time object.","{'login': 'mariochavez', 'id': 59967, 'node_id': 'MDQ6VXNlcjU5OTY3', 'avatar_url': 'https://avatars.githubusercontent.com/u/59967?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mariochavez', 'html_url': 'https://github.com/mariochavez', 'followers_url': 'https://api.github.com/users/mariochavez/followers', 'following_url': 'https://api.github.com/users/mariochavez/following{/other_user}', 'gists_url': 'https://api.github.com/users/mariochavez/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mariochavez/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mariochavez/subscriptions', 'organizations_url': 'https://api.github.com/users/mariochavez/orgs', 'repos_url': 'https://api.github.com/users/mariochavez/repos', 'events_url': 'https://api.github.com/users/mariochavez/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mariochavez/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2023-09-29T17:36:37Z,2023-10-06T07:24:57Z,,CONTRIBUTOR,,,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.timestamps
  end
end

class Post < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_association_stuff
    Post.create!

    assert_kind_of Time, Post.group(:created_at).pluck(""MAX(created_at) AS last_date"").first
  end
end
```

### Expected behavior
Returned date must be a Time object.
2023-09-29 00:00:00 -0400 - Time

### Actual behavior
Returned date is a String.
2023-09-29 17:32:20.148108 - String

```
Failure:
BugTest#test_association_stuff [sqlite.rb:39]:
Expected ""2023-09-29 17:35:06.041688"" to be a kind of Time, not String.
```

NOTE: Postgresql adapter returns a Time object.

### System configuration
**Rails version**:
main@d38dcdc

**Ruby version**:
3.2.2","{'url': 'https://api.github.com/repos/rails/rails/issues/49434/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49434/timeline,,
https://api.github.com/repos/rails/rails/issues/49425,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49425/labels{/name},https://api.github.com/repos/rails/rails/issues/49425/comments,https://api.github.com/repos/rails/rails/issues/49425/events,https://github.com/rails/rails/pull/49425,1918438083,PR_kwDNIULOW35KJg,49425,No more _klass,"{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,2,2023-09-29T00:36:08Z,2023-09-29T20:21:39Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49425', 'html_url': 'https://github.com/rails/rails/pull/49425', 'diff_url': 'https://github.com/rails/rails/pull/49425.diff', 'patch_url': 'https://github.com/rails/rails/pull/49425.patch', 'merged_at': None}","We use `klass` because `class` is a reserved word in Ruby.

But, any word ending with the suffix `_class` isn't reserved, so we don't need to use the suffix `_klass` anywhere.","{'url': 'https://api.github.com/repos/rails/rails/issues/49425/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49425/timeline,,
https://api.github.com/repos/rails/rails/issues/49414,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49414/labels{/name},https://api.github.com/repos/rails/rails/issues/49414/comments,https://api.github.com/repos/rails/rails/issues/49414/events,https://github.com/rails/rails/pull/49414,1916984752,PR_kwDNIULOW2pTXA,49414,Do not skip Action Cable PG tests on CI,"{'login': 'casperisfine', 'id': 19192189, 'node_id': 'MDQ6VXNlcjE5MTkyMTg5', 'avatar_url': 'https://avatars.githubusercontent.com/u/19192189?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/casperisfine', 'html_url': 'https://github.com/casperisfine', 'followers_url': 'https://api.github.com/users/casperisfine/followers', 'following_url': 'https://api.github.com/users/casperisfine/following{/other_user}', 'gists_url': 'https://api.github.com/users/casperisfine/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/casperisfine/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/casperisfine/subscriptions', 'organizations_url': 'https://api.github.com/users/casperisfine/orgs', 'repos_url': 'https://api.github.com/users/casperisfine/repos', 'events_url': 'https://api.github.com/users/casperisfine/events{/privacy}', 'received_events_url': 'https://api.github.com/users/casperisfine/received_events', 'type': 'User', 'site_admin': False}","[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-28T08:30:48Z,2023-09-28T08:30:52Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49414', 'html_url': 'https://github.com/rails/rails/pull/49414', 'diff_url': 'https://github.com/rails/rails/pull/49414.diff', 'patch_url': 'https://github.com/rails/rails/pull/49414.patch', 'merged_at': None}","The intent is to skip them if you don't have PG running locally but on CI it's supposed to be running.

If we fail to connect, we should fail CI, not skip these tests.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49414/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49414/timeline,,
https://api.github.com/repos/rails/rails/issues/49388,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49388/labels{/name},https://api.github.com/repos/rails/rails/issues/49388/comments,https://api.github.com/repos/rails/rails/issues/49388/events,https://github.com/rails/rails/pull/49388,1913877363,PR_kwDNIULOW0BByw,49388,Reduce pg_stat_statements churn using `= any()` instead of `IN ()`,"{'login': 'seanlinsley', 'id': 688886, 'node_id': 'MDQ6VXNlcjY4ODg4Ng==', 'avatar_url': 'https://avatars.githubusercontent.com/u/688886?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanlinsley', 'html_url': 'https://github.com/seanlinsley', 'followers_url': 'https://api.github.com/users/seanlinsley/followers', 'following_url': 'https://api.github.com/users/seanlinsley/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanlinsley/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanlinsley/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanlinsley/subscriptions', 'organizations_url': 'https://api.github.com/users/seanlinsley/orgs', 'repos_url': 'https://api.github.com/users/seanlinsley/repos', 'events_url': 'https://api.github.com/users/seanlinsley/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanlinsley/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,15,2023-09-26T16:23:19Z,2023-10-04T14:26:35Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49388', 'html_url': 'https://github.com/rails/rails/pull/49388', 'diff_url': 'https://github.com/rails/rails/pull/49388.diff', 'patch_url': 'https://github.com/rails/rails/pull/49388.patch', 'merged_at': None}","### Motivation / Background

This PR resolves pg_stat_statements churn for Postgres databases, as described on the forum: https://discuss.rubyonrails.org/t/83667

### Detail

Currently, array inclusion queries like `where(id: [1,2])` generate the SQL `id IN (1, 2)`. Each distinct array length gets normalized separately, resulting in a high number of duplicates in pg_stat_statements and causing churn as there is a limit on the number of queries tracked.

This PR adds a patch for Postgres that generates `id = any('{1,2}')`, which pg_stat_statements normalizes as a single query no matter the array length.

`NOT IN` is implemented using `!= all()` https://stackoverflow.com/a/11730845

### Additional information

This turns out to be a good deal faster (using Postgres 15.4). Here are the min and max iterations per second from several benchmark runs:

- 490 - 600 on the main branch
- 750 - 950 on this branch with `BENCHMARK_PREPARED=1`
- 780 - 1020 on this branch with `BENCHMARK_PREPARED=0`

<details><summary>Here's the benchmark:</summary>

```rb
# Adapted from activerecord/examples/performance.rb

require ""active_record""
require ""benchmark/ips""

TIME    = (ENV[""BENCHMARK_TIME""] || 20).to_i
RECORDS = (ENV[""BENCHMARK_RECORDS""] || TIME * 1000).to_i

conn = {
  adapter: ""postgresql"",
  database: ""postgres"",
  prepared_statements: ENV[""BENCHMARK_PREPARED""] == ""1""
}

ActiveRecord::Base.establish_connection(conn)

class User < ActiveRecord::Base
  connection.create_table :users, force: true do |t|
    t.string :name, :email
    t.timestamps
  end
end

def progress_bar(int); print ""."" if (int % 100).zero? ; end

puts ""Generating data...""

module ActiveRecord
  class Faker
    LOREM = ""Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse non aliquet diam. Curabitur vel urna metus, quis malesuada elit.
     Integer consequat tincidunt felis. Etiam non erat dolor. Vivamus imperdiet nibh sit amet diam eleifend id posuere diam malesuada. Mauris at accumsan sem.
     Donec id lorem neque. Fusce erat lorem, ornare eu congue vitae, malesuada quis neque. Maecenas vel urna a velit pretium fermentum. Donec tortor enim,
     tempor venenatis egestas a, tempor sed ipsum. Ut arcu justo, faucibus non imperdiet ac, interdum at diam. Pellentesque ipsum enim, venenatis ut iaculis vitae,
     varius vitae sem. Sed rutrum quam ac elit euismod bibendum. Donec ultricies ultricies magna, at lacinia libero mollis aliquam. Sed ac arcu in tortor elementum
     tincidunt vel interdum sem. Curabitur eget erat arcu. Praesent eget eros leo. Nam magna enim, sollicitudin vehicula scelerisque in, vulputate ut libero.
     Praesent varius tincidunt commodo"".split

    def self.name
      LOREM.grep(/^\w*$/).sort_by { rand }.first(2).join "" ""
    end

    def self.email
      LOREM.grep(/^\w*$/).sort_by { rand }.first(2).join(""@"") + "".com""
    end
  end
end

begin
  puts ""Inserting #{RECORDS} users...""
  RECORDS.times do |record|
    user = User.create(
      created_at: Date.today,
      name: ActiveRecord::Faker.name,
      email: ActiveRecord::Faker.email
    )
    progress_bar(record)
  end
  puts ""Done!\n""

  Benchmark.ips(TIME) do |x|
    x.report ""Model.where(id: [...])"" do
      User.where(id: (1..100).to_a).count
    end
  end
ensure
  User.connection.drop_table :users
end
```

</details>

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49388/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49388/timeline,,
https://api.github.com/repos/rails/rails/issues/49382,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49382/labels{/name},https://api.github.com/repos/rails/rails/issues/49382/comments,https://api.github.com/repos/rails/rails/issues/49382/events,https://github.com/rails/rails/pull/49382,1912469952,PR_kwDNIULOWy0j0A,49382,Add failing test for remove_connection,"{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,"{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,0,2023-09-26T00:16:29Z,2023-09-28T17:05:37Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49382', 'html_url': 'https://github.com/rails/rails/pull/49382', 'diff_url': 'https://github.com/rails/rails/pull/49382.diff', 'patch_url': 'https://github.com/rails/rails/pull/49382.patch', 'merged_at': None}","It is not removing all the shards connections when we call it.

It is because the first time we call it we are resetting the `connection_specification_name` so the next call doesn't find the right connection pool.","{'url': 'https://api.github.com/repos/rails/rails/issues/49382/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49382/timeline,,
https://api.github.com/repos/rails/rails/issues/49377,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49377/labels{/name},https://api.github.com/repos/rails/rails/issues/49377/comments,https://api.github.com/repos/rails/rails/issues/49377/events,https://github.com/rails/rails/pull/49377,1911482451,PR_kwDNIULOWx-Tyw,49377,Action View: Remove internal calls to `tag` with positional arguments,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,4,2023-09-25T13:10:59Z,2023-10-05T23:47:01Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49377', 'html_url': 'https://github.com/rails/rails/pull/49377', 'diff_url': 'https://github.com/rails/rails/pull/49377.diff', 'patch_url': 'https://github.com/rails/rails/pull/49377.patch', 'merged_at': None}","### Motivation / Background
    
    
Follow-up to [#49371][]
    
In the wake of the deprecation of `tag(:div)` in favor of `tag.div`, this commit replaces all calls made internally with the more modern syntax.

This change is separate from the deprecation cycle, since there are **slight** behavioral changes, since the HTML output changes from self-closing elements like `<input />` to open void elements like `<input>`.

[#49371]: https://github.com/rails/rails/pull/49371

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49377/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49377/timeline,,
https://api.github.com/repos/rails/rails/issues/49376,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49376/labels{/name},https://api.github.com/repos/rails/rails/issues/49376/comments,https://api.github.com/repos/rails/rails/issues/49376/events,https://github.com/rails/rails/pull/49376,1910980756,PR_kwDNIULOWxi4NQ,49376,The SQLite3 adapter now implements the `supports_deferrable_constraints?` contract,"{'login': 'fractaledmind', 'id': 5077225, 'node_id': 'MDQ6VXNlcjUwNzcyMjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5077225?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fractaledmind', 'html_url': 'https://github.com/fractaledmind', 'followers_url': 'https://api.github.com/users/fractaledmind/followers', 'following_url': 'https://api.github.com/users/fractaledmind/following{/other_user}', 'gists_url': 'https://api.github.com/users/fractaledmind/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fractaledmind/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fractaledmind/subscriptions', 'organizations_url': 'https://api.github.com/users/fractaledmind/orgs', 'repos_url': 'https://api.github.com/users/fractaledmind/repos', 'events_url': 'https://api.github.com/users/fractaledmind/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fractaledmind/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,4,2023-09-25T08:41:00Z,2023-10-03T11:51:08Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49376', 'html_url': 'https://github.com/rails/rails/pull/49376', 'diff_url': 'https://github.com/rails/rails/pull/49376.diff', 'patch_url': 'https://github.com/rails/rails/pull/49376.patch', 'merged_at': None}","### Motivation / Background

SQLite is a feature-rich database engine, and production usage is only growing. We need Rails' support to offer developers the range and scope of its features.

The PostgreSQL adapter supports deferred foreign keys, and SQLite itself has support [deferred foreign keys](https://www.sqlite.org/foreignkeys.html#fk_deferred) [since at least 2011](https://www.sqlite.org/releaselog/3_7_6.html).

### Detail

Implementing the full `supports_deferrable_constraints?` contract allows foreign keys to be deferred by adding the `:deferrable` key to the `foreign_key` options in the `add_reference` and `add_foreign_key` methods.

```ruby
add_reference :person, :alias, foreign_key: { deferrable: :deferred }
add_reference :alias, :person, foreign_key: { deferrable: :deferred }
```

In this PR, I am adding full support for the SQLite3Adapter by implementing:

`ActiveRecord::ConnectionAdapters::SQLite3::SchemaCreation#visit_AddForeignKey`
`ActiveRecord::ConnectionAdapters::SQLite3::SchemaCreation#visit_ForeignKeyDefinition`
`ActiveRecord::ConnectionAdapters::SQLite3Adapter#supports_deferrable_constraints?`
`ActiveRecord::ConnectionAdapters::SQLite3::SchemaStatements#assert_valid_deferrable`

and altering:

`ActiveRecord::ConnectionAdapters::SQLite3::SchemaStatements#add_foreign_key`
`ActiveRecord::ConnectionAdapters::SQLite3Adapter#foreign_keys`

### Additional Info

In order to get the `ActiveRecord::ConnectionAdapters::SQLite3Adapter#foreign_keys` method working properly, I had to add a query to get the `CREATE TABLE` sql and parse which foreign key constraints are deferrable and which of those are deferred. In order to support this use-case, I extracted a `table_structure_sql` method which now `table_structure_with_collation` relies on. 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49376/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49376/timeline,,
https://api.github.com/repos/rails/rails/issues/49371,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49371/labels{/name},https://api.github.com/repos/rails/rails/issues/49371/comments,https://api.github.com/repos/rails/rails/issues/49371/events,https://github.com/rails/rails/pull/49371,1910462944,PR_kwDNIULOWxG-CQ,49371,Deprecate `tag` with positional arguments,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],"{'url': 'https://api.github.com/repos/rails/rails/milestones/83', 'html_url': 'https://github.com/rails/rails/milestone/83', 'labels_url': 'https://api.github.com/repos/rails/rails/milestones/83/labels', 'id': 9964242, 'node_id': 'MI_kwDNIULOAJgK0g', 'number': 83, 'title': '7.2.0', 'description': None, 'creator': {'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}, 'open_issues': 6, 'closed_issues': 1, 'state': 'open', 'created_at': '2023-09-25T20:29:14Z', 'updated_at': '2023-10-05T13:36:16Z', 'due_on': None, 'closed_at': None}",7,2023-09-25T00:50:17Z,2023-10-05T23:46:14Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49371', 'html_url': 'https://github.com/rails/rails/pull/49371', 'diff_url': 'https://github.com/rails/rails/pull/49371.diff', 'patch_url': 'https://github.com/rails/rails/pull/49371.patch', 'merged_at': None}","The bulk of this diff is related to indentation changes, so it's best reviewed [ignoring spacing changes](https://github.com/rails/rails/pull/49371/files?w=1)
---

### Motivation / Background

Modern evolutions of the `ActionView::Helpers::TagHelper#tag` method are intended to be called _on_ the `TagBuilder` instance itself instead of with positional arguments.

For example, `tag(""div"")` would be called with `tag.div`.

According to the [Legacy Syntax](https://api.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-tag-label-Legacy+syntax) heading of the [ActionView::Helpers::TagHelper#tag](https://api.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-tag) guides:

> The following format is for legacy syntax support. It will be deprecated in future versions of Rails.

Since deprecations must occur during releases, this commit proposes that 7.2 be the release to start the deprecation process so that a subsequent release can remove ""Legacy syntax"" support entirely.

### Detail

This commit adds a deprecation warning to encourage callers to invoke the helper in the more modern style.

Internally, Rails utilizes the positional argument syntax in several places. Since deprecations must be part of minor version releases, this commit wraps the internal invocations in `ActionView.deprecator.silence` blocks so that they can remain while the deprecation is made public. This compromise buys the framework time to re-structure those invocations to be compatible with the more modern syntax before the next major release.

There are several calls to `tag` with positional arguments in the test suite. This commit wraps those as well. In the future, some of those tests will be able to remove those blocks, while other tests will be able to be removed entirely once that style of invocation is no longer supported.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49371/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49371/timeline,,
https://api.github.com/repos/rails/rails/issues/49369,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49369/labels{/name},https://api.github.com/repos/rails/rails/issues/49369/comments,https://api.github.com/repos/rails/rails/issues/49369/events,https://github.com/rails/rails/pull/49369,1910387599,PR_kwDNIULOWxDH3g,49369,Action View: Reduce public API of `tag` helper,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-24T21:36:45Z,2023-10-05T17:41:38Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49369', 'html_url': 'https://github.com/rails/rails/pull/49369', 'diff_url': 'https://github.com/rails/rails/pull/49369.diff', 'patch_url': 'https://github.com/rails/rails/pull/49369.patch', 'merged_at': None}","### Motivation / Background

The `TagBuilder` instance returned by the
[ActionView::Helpers::TagHelper#tag][] method has the ability to build various HTML elements through its reliance on `method_missing`. The magic of that instance hinges on the fact that it has a **minimal** public interface, and transforms missing methods names into HTML elements. For example, calling `tag.div` invokes a missing `#div` method, which renders a `<div>` element.

There are two exceptional cases:

* `tag.p` is defined, since the existing [Kernel#p][] definition would prevent the underlying `#method_missing` invocation
* `tag.attributes` is a defined method to transform `Hash` instances and keyword arguments in HTML attribute strings

In addition to those two _intentional_ exceptions, there are also several methods that are incidentally part of the public interface:

* `#tag_string`
* `#content_tag_string`
* `#tag_options`
* `#boolean_tag_option`
* `#tag_option`

Along with those methods, the class also includes [OutputSafetyHelper][] and [CaptureHelper][], which expand surface area of the class's public interface even further.

While it's unlikely that these methods would collide with method invocations intended to construct HTML elements, they still impact that design of the object.

The ""public"" nature of the `TagBuilder` interface has some subtle nuances. While it **is** marked with `:nodoc:`, instances are returned by a public `tag` method, despite it being considered a private class only meant for internal consumption.

That same is true for the incidentally public methods mentioned above: no consuming applications should be invoking `#tag_string` or `#tag_options`. While that's true, those methods _are_ being invoked **directly** by other Action View classes.

### Detail

This commit removes those invocations, and instead replaces them with public method calls.

In cases where the tag name is statically know ahead of time, they're replaced with calls to that method (for example, `tag(:option)` becomes `tag.option`). When they're dynamic, they're replaced by calls to [public_send][] (for example, `tag(name)` becomes
`tag.public_send(name)`).

The majority of these changes are painless, with one exception. Some calls to the `#tag` helper also pass an `open` positional argument that isn't part of the `TagBuilder` class's public interface. As a result, that becomes slightly more complicated, and requires some String mutation to continue to pass the test suite.

This commit also removes the `OutputSafetyHelper` and `CaptureHelper` modules from the class, and delegates to the methods it depended on to j`@view_context`.

Hopefully, calls to `#tag` with positional arguments are less and less common, since the documentation describes it as a [Legacy Syntax][] marked for deprecation in future versions of Rails.

[Kernel#p]: https://ruby-doc.org/3.2.2/Kernel.html#method-i-p
[ActionView::Helpers::TagHelper#tag]: https://api.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-tag
[public_send]: https://ruby-doc.org/3.2.2/Object.html#method-i-public_send
[Legacy Syntax]: https://api.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-tag-label-Legacy+syntax
[OutputSafetyHelper]: https://api.rubyonrails.org/classes/ActionView/Helpers/OutputSafetyHelper.html
[CaptureHelper]: https://api.rubyonrails.org/classes/ActionView/Helpers/CaptureHelper.html

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49369/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49369/timeline,,
https://api.github.com/repos/rails/rails/issues/49368,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49368/labels{/name},https://api.github.com/repos/rails/rails/issues/49368/comments,https://api.github.com/repos/rails/rails/issues/49368/events,https://github.com/rails/rails/pull/49368,1910382899,PR_kwDNIULOWxC5TA,49368,Action View: Document `TagBuilder` as part of the public interface,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2023-09-24T21:19:34Z,2023-10-05T19:44:17Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49368', 'html_url': 'https://github.com/rails/rails/pull/49368', 'diff_url': 'https://github.com/rails/rails/pull/49368.diff', 'patch_url': 'https://github.com/rails/rails/pull/49368.patch', 'merged_at': None}","### Motivation / Background

Since the `ActionView::Helpers::TagBuilder` class is marked with
`:nodoc:`, the `tag.attributes` method isn't directly discoverable by
the [API Documentation][], despite it being mentioned under the
[Building HTML Attributes][] subheading of the [tag][] helper method
documentation.

Similarly, methods like `tag.div` and `tag.h1` are also not
discoverable, since they're dependent on method missing.

### Detail

This commit promotes `ActionView::Helpers::TagHelper::TagBuilder` to be
part of Action View's public API. This commit marks all of its methods
as `:nodoc:` to omit them from the public interface, then adds RubyDoc
comments for `#attributes` and the generated tag building methods like
`#div` and `#a` to provide hooks for the [API Documentation][] to serve
search results.

To further reduce the publicly discoverable interface, this commit also
removes the `CaptureHelper` and `OutputSafetyHelper` modules from the
class. To preserve the existing behavior, delegate those methods to the
`@view_context` instance variable instead.

[API Documentation]: https://api.rubyonrails.org
[Building HTML Attributes]: https://api.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-tag-label-Building+HTML+attributes
[tag]: https://api.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-tag

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49368/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 1, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49368/timeline,,
https://api.github.com/repos/rails/rails/issues/49365,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49365/labels{/name},https://api.github.com/repos/rails/rails/issues/49365/comments,https://api.github.com/repos/rails/rails/issues/49365/events,https://github.com/rails/rails/pull/49365,1910084000,PR_kwDNIULOWw0S5Q,49365,Update Action Cable Overview guide,"{'login': 'julianfssen', 'id': 25947043, 'node_id': 'MDQ6VXNlcjI1OTQ3MDQz', 'avatar_url': 'https://avatars.githubusercontent.com/u/25947043?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/julianfssen', 'html_url': 'https://github.com/julianfssen', 'followers_url': 'https://api.github.com/users/julianfssen/followers', 'following_url': 'https://api.github.com/users/julianfssen/following{/other_user}', 'gists_url': 'https://api.github.com/users/julianfssen/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/julianfssen/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/julianfssen/subscriptions', 'organizations_url': 'https://api.github.com/users/julianfssen/orgs', 'repos_url': 'https://api.github.com/users/julianfssen/repos', 'events_url': 'https://api.github.com/users/julianfssen/events{/privacy}', 'received_events_url': 'https://api.github.com/users/julianfssen/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-24T04:07:09Z,2023-09-27T08:41:27Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49365', 'html_url': 'https://github.com/rails/rails/pull/49365', 'diff_url': 'https://github.com/rails/rails/pull/49365.diff', 'patch_url': 'https://github.com/rails/rails/pull/49365.patch', 'merged_at': None}","### Motivation / Background

The `actioncable-examples` repo referenced in the guide is no longer maintained: https://github.com/rails/actioncable-examples/pull/46#issuecomment-1647505744. We should remove it from the guide. 

I also took the opportunity to update the guide with new sections on importing JavaScript channel files, `bin/rails generate channel`, and stopping streams.

### Detail

This Pull Request changes the following:

* Remove unmaintained `actioncable-examples` reference. For more info: https://github.com/rails/actioncable-examples/pull/46#issuecomment-1647505744
* Add `disconnect` and `unsubscribed` methods to the example connection and channel files.
* Add reference for `bin/rails generate channel`
* Add guide on importing JavaScript channel files with import maps.
* Add section on stopping streams

### Additional information

The new sections are easily found in the API documentation. That said, I still think it's valuable to add them to the guide for new developers.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49365/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49365/timeline,,
https://api.github.com/repos/rails/rails/issues/49360,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49360/labels{/name},https://api.github.com/repos/rails/rails/issues/49360/comments,https://api.github.com/repos/rails/rails/issues/49360/events,https://github.com/rails/rails/pull/49360,1909985879,PR_kwDNIULOWwvkNw,49360,"Use `ruby file: "".ruby-version""` for new apps","{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,3,2023-09-23T20:06:37Z,2023-09-24T07:34:16Z,,MEMBER,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49360', 'html_url': 'https://github.com/rails/rails/pull/49360', 'diff_url': 'https://github.com/rails/rails/pull/49360.diff', 'patch_url': 'https://github.com/rails/rails/pull/49360.patch', 'merged_at': None}","### Motivation / Background

Previously, new apps would have a Ruby version set in both the Gemfile and the .ruby-version file. This duplication makes it more difficult to quickly change an application's ruby version as users must remember to update multiple files.

### Detail

This commit updates the app generator's Gemfile to read the Ruby version from the .ruby-version file. Since this feature was introduced in the latest version of Bundler, it will only be enabled if a supported version of Bundler is used.

### Additional information

Alternatively, another solution mentioned on the original PR adding .ruby-version was that the .ruby-version file could be removed once rvm/rbenv support reading the Ruby version from the Gemfile. This has a downside that many other tools like chruby do not have plans to support reading a Ruby version from the Gemfile, and so users of those tools would have a worse experience if the .ruby-version file is removed.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49360/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49360/timeline,,
https://api.github.com/repos/rails/rails/issues/49355,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49355/labels{/name},https://api.github.com/repos/rails/rails/issues/49355/comments,https://api.github.com/repos/rails/rails/issues/49355/events,https://github.com/rails/rails/issues/49355,1909605353,I_kwDNIULOcdJD6Q,49355,ActiveRecord: `preload` for `has_many through` with `source_type` provided fails if `has_many through` association without `source_type` was specified in `preload` earlier.,"{'login': 'EnotPoloskun', 'id': 1088050, 'node_id': 'MDQ6VXNlcjEwODgwNTA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1088050?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/EnotPoloskun', 'html_url': 'https://github.com/EnotPoloskun', 'followers_url': 'https://api.github.com/users/EnotPoloskun/followers', 'following_url': 'https://api.github.com/users/EnotPoloskun/following{/other_user}', 'gists_url': 'https://api.github.com/users/EnotPoloskun/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/EnotPoloskun/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/EnotPoloskun/subscriptions', 'organizations_url': 'https://api.github.com/users/EnotPoloskun/orgs', 'repos_url': 'https://api.github.com/users/EnotPoloskun/repos', 'events_url': 'https://api.github.com/users/EnotPoloskun/events{/privacy}', 'received_events_url': 'https://api.github.com/users/EnotPoloskun/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2023-09-22T23:02:51Z,2023-09-23T14:04:08Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  gem ""rails"", ""7.0.8""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new($stdout)

ActiveRecord::Schema.define do
  create_table ""invoices"", force: :cascade, &:timestamps

  create_table ""invoice_payments"", force: :cascade do |t|
    t.integer ""invoice_id""
    t.integer ""source_id""
    t.string ""source_type""
  end

  create_table ""checks"", force: :cascade, &:timestamps

  create_table ""charges"", force: :cascade do |t|
    t.integer ""card_id""
  end

  create_table ""cards"", force: :cascade, &:timestamps
end

class Invoice < ActiveRecord::Base
  has_many :invoice_payments
  has_many :charges, through: :invoice_payments, source: :source, source_type: ""Charge""
end

class InvoicePayment < ActiveRecord::Base
  belongs_to :invoice
  belongs_to :source, polymorphic: true
end

class Check < ActiveRecord::Base
end

class Charge < ActiveRecord::Base
  belongs_to :card
end

class Card < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_preload
    invoice = Invoice.create!
    check = Check.create!
    card = Card.create!
    charge = Charge.create!(card: card)
    InvoicePayment.create!(invoice: invoice, source: charge)
    InvoicePayment.create!(invoice: invoice, source: check)

    assert_equal invoice, Invoice.preload(:invoice_payments).first # works
    assert_equal invoice, Invoice.preload(:charges).first # works
    assert_equal invoice, Invoice.preload(:invoice_payments, :charges).first # works
    assert_equal invoice, Invoice.preload(:charges, :invoice_payments).first # works
    assert_equal invoice, Invoice.preload({ charges: :card }, :invoice_payments).first # works
    assert_equal invoice, Invoice.preload(:invoice_payments, { charges: :card }).first # fails
  end
end

```

### Expected behavior
```
Invoice.preload(:invoice_payments, { charges: :card }).first
```
Should return first invoice with preloaded associations provided in `preload` same way how 
```
Invoice.preload({ charges: :card }, :invoice_payments).first
```
does. Order inside `preload` must not matter.

### Actual behavior
Following error is raised:
```
ActiveRecord::AssociationNotFoundError: Association named 'card' was not found on Check; perhaps you misspelled it?
```

### System configuration
**Rails version**: 7.0.8
**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49355/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49355/timeline,,
https://api.github.com/repos/rails/rails/issues/49354,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49354/labels{/name},https://api.github.com/repos/rails/rails/issues/49354/comments,https://api.github.com/repos/rails/rails/issues/49354/events,https://github.com/rails/rails/issues/49354,1909462702,I_kwDNIULOcdAWrg,49354,Activestorage direct uploads exhibits weird behaviour with data:{turbo:true},"{'login': 'nkokkos', 'id': 38037, 'node_id': 'MDQ6VXNlcjM4MDM3', 'avatar_url': 'https://avatars.githubusercontent.com/u/38037?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nkokkos', 'html_url': 'https://github.com/nkokkos', 'followers_url': 'https://api.github.com/users/nkokkos/followers', 'following_url': 'https://api.github.com/users/nkokkos/following{/other_user}', 'gists_url': 'https://api.github.com/users/nkokkos/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nkokkos/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nkokkos/subscriptions', 'organizations_url': 'https://api.github.com/users/nkokkos/orgs', 'repos_url': 'https://api.github.com/users/nkokkos/repos', 'events_url': 'https://api.github.com/users/nkokkos/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nkokkos/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1071962662, 'node_id': 'MDU6TGFiZWwxMDcxOTYyNjYy', 'url': 'https://api.github.com/repos/rails/rails/labels/more-information-needed', 'name': 'more-information-needed', 'color': 'bfdadc', 'default': False, 'description': 'When reporter needs to provide more information'}]",open,False,,[],,1,2023-09-22T20:07:42Z,2023-09-27T21:00:04Z,,NONE,,,,"
### Steps to reproduce
<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

Create a simple rails application with esbuild and use the example as posted here https://edgeguides.rubyonrails.org/active_storage_overview.html#example. 

Enable turbo with data:{turbo:true} on the link leading to the upload page.

### Expected behavior
<!-- Tell us what should happen -->
This should really happen:
https://edgeguides.rubyonrails.org/active_storage_overview.html#example.

### Actual behavior
<!-- Tell us what happens instead -->
During the upload process, the progress bars are shown more than once. For example, if I upload one file, two upload bars are shown and only one is active (both bars have the name of the file being uploaded). Now, if I try to upload again another file, 3 progress bars are shown and only one is active. 

### System configuration
**Rails version**: 7.0.8

**Ruby version**:  3.2.2","{'url': 'https://api.github.com/repos/rails/rails/issues/49354/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49354/timeline,,
https://api.github.com/repos/rails/rails/issues/49353,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49353/labels{/name},https://api.github.com/repos/rails/rails/issues/49353/comments,https://api.github.com/repos/rails/rails/issues/49353/events,https://github.com/rails/rails/issues/49353,1908917713,I_kwDNIULOccfF0Q,49353,ArgumentError when using create_with().find_or_create_by() with an array of enum.,"{'login': 'jean-francois-labbe', 'id': 1558372, 'node_id': 'MDQ6VXNlcjE1NTgzNzI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1558372?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jean-francois-labbe', 'html_url': 'https://github.com/jean-francois-labbe', 'followers_url': 'https://api.github.com/users/jean-francois-labbe/followers', 'following_url': 'https://api.github.com/users/jean-francois-labbe/following{/other_user}', 'gists_url': 'https://api.github.com/users/jean-francois-labbe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jean-francois-labbe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jean-francois-labbe/subscriptions', 'organizations_url': 'https://api.github.com/users/jean-francois-labbe/orgs', 'repos_url': 'https://api.github.com/users/jean-francois-labbe/repos', 'events_url': 'https://api.github.com/users/jean-francois-labbe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jean-francois-labbe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-09-22T13:30:52Z,2023-09-27T23:09:33Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :devices, force: true do |t|
  end

  create_table :alerts, force: true do |t|
    t.integer :device_id
    t.string :status
  end
end

class Device < ActiveRecord::Base
  has_many :alerts
end

class Alert < ActiveRecord::Base
  belongs_to :device
  enum status: { active: 'active', closed: 'closed', pending: 'pending' }
end

class BugTest < Minitest::Test
  def test_find_or_create_by_with_array_of_enum
    device = Device.create!

    Alert.find_by(device: device, status: [:pending, :active]) # Working fine

    Alert.create_with(status: :pending).find_or_create_by(device: device, status: [:pending, :active])
  end

  def test_find_or_create_by_doesnt_take_create_with_into_account
    assert_equal Alert.create_with(status: :pending).find_or_create_by(device: Device.create!, status: :active), 'pending'
  end
end
```

Crashes with
```
Failure:
BugTest#test_find_or_create_by_doesnt_take_create_with_into_account [find_or_create_by_rails_issue.rb:51]:
--- expected
+++ actual
@@ -1 +1 @@
-#<Alert id: 1, device_id: 1, status: ""active"">
+""pending""

Error:
BugTest#test_find_or_create_by_with_array_of_enum:
ArgumentError: '[:pending, :active]' is not a valid status
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/enum.rb:215:in `assert_valid_value'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activemodel/lib/active_model/attribute.rb:79:in `with_value_from_user'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activemodel/lib/active_model/attribute_set.rb:60:in `write_from_user'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/attribute_methods/write.rb:42:in `_write_attribute'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activemodel/lib/active_model/attribute_methods.rb:286:in `status='
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activemodel/lib/active_model/attribute_assignment.rb:49:in `public_send'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activemodel/lib/active_model/attribute_assignment.rb:49:in `_assign_attribute'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/attribute_assignment.rb:19:in `block in _assign_attributes'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/attribute_assignment.rb:11:in `each'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/attribute_assignment.rb:11:in `_assign_attributes'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activemodel/lib/active_model/attribute_assignment.rb:34:in `assign_attributes'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/core.rb:431:in `initialize'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/inheritance.rb:76:in `new'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/inheritance.rb:76:in `new'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/persistence.rb:37:in `create'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:899:in `_create'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:103:in `block in create'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:914:in `_scoping'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:452:in `scoping'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:103:in `create'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:216:in `block in create_or_find_by'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:531:in `block in within_new_transaction'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activesupport/lib/active_support/concurrency/null_lock.rb:9:in `synchronize'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:528:in `within_new_transaction'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:342:in `transaction'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/transactions.rb:212:in `transaction'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation/delegation.rb:122:in `public_send'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation/delegation.rb:122:in `block in method_missing'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:914:in `_scoping'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:452:in `scoping'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation/delegation.rb:122:in `method_missing'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:216:in `create_or_find_by'
    .gem/ruby/3.0.6/bundler/gems/rails-e6f09150a88c/activerecord/lib/active_record/relation.rb:176:in `find_or_create_by'
    find_or_create_by_rails_issue.rb:45:in `test_association_stuff'
```

### Expected behavior
When using `create_with(status: :pending)` followed by `find_or_create_by(device: device, status: [:pending, :active])` with an array of enum values I would expect the find to use the array of enum values and in case it needs to create a record it would use the value provided in `create_with`.

### Actual behavior
it crashes with `ArgumentError: '[:pending, :active]' is not a valid status`

What's surprising is that    ` Alert.find_by(device: device, status: [:pending, :active]) ` is Working fine

### System configuration
**Rails version**:  main@e6f0915

**Ruby version**: 3.0.6

**EDIT:**
Added `test_find_or_create_by_doesnt_take_create_with_into_account`","{'url': 'https://api.github.com/repos/rails/rails/issues/49353/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49353/timeline,,
https://api.github.com/repos/rails/rails/issues/49351,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49351/labels{/name},https://api.github.com/repos/rails/rails/issues/49351/comments,https://api.github.com/repos/rails/rails/issues/49351/events,https://github.com/rails/rails/issues/49351,1908399812,I_kwDNIULOcb_exA,49351,`db:rollback:{database}` dumps all databases schemas,"{'login': 'kv109', 'id': 399968, 'node_id': 'MDQ6VXNlcjM5OTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/399968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kv109', 'html_url': 'https://github.com/kv109', 'followers_url': 'https://api.github.com/users/kv109/followers', 'following_url': 'https://api.github.com/users/kv109/following{/other_user}', 'gists_url': 'https://api.github.com/users/kv109/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kv109/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kv109/subscriptions', 'organizations_url': 'https://api.github.com/users/kv109/orgs', 'repos_url': 'https://api.github.com/users/kv109/repos', 'events_url': 'https://api.github.com/users/kv109/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kv109/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-22T08:07:21Z,2023-09-27T21:44:06Z,,CONTRIBUTOR,,,,"### Steps to reproduce

Create a new Rails app
```
rails new --minimal rails-rollback-bug
cd rails-rollback-bug
```

Replace the `development` section in the `database.yml` with:
```yaml
development:
  primary:
    <<: *default
    database: db/primary.sqlite3
  secondary:
    <<: *default
    database: db/secondary.sqlite3
```

Run the rollback task:
```
rails db:rollback:primary
```

Verify that schemas for both databases were dumped, even though the task was supposed to be performed only for the `primary` database:
```
ls db | grep schema
schema.rb
secondary_schema.rb # this should not be here!
```

### Expected behavior
Only schema for the primary database should be dumped, i.e. only the `schema.rb` file should be created.

### Actual behavior
Schemas for both databases are dumped, i.e. two files (`schema.rb` and `secondary_schema.rb`) are created.

### Fix
I have a [fix](https://github.com/rails/rails/compare/main...kv109:rails:dont-dump-all-schemas-after-rollback?expand=1), but I didn't open a pull request, because I'm not sure how/if to test it. It looks like this aspect of databases tasks is [not tested at all](https://github.com/rails/rails/blob/main/activerecord/test/cases/tasks/database_tasks_test.rb), at least I couldn't find such tests. I'd be happy to write them, but I need some guidance.

### Is this really a problem?
If
1. Your secondary database schema isn't maintained by your Rails app and
2. you don't want to set `database_tasks` option to `false`, because you still want to be able to use `db:create`, `db:drop`, etc. (for easier development),

then each `db:rollback` will result in `ActiveRecord::StatementInvalid: PG::UndefinedColumn: ERROR:  column schema_migrations.version does not exist`, which can be pretty annoying.

### System configuration
Rails version: 7.0.8
Ruby version: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49351/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49351/timeline,,
https://api.github.com/repos/rails/rails/issues/49348,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49348/labels{/name},https://api.github.com/repos/rails/rails/issues/49348/comments,https://api.github.com/repos/rails/rails/issues/49348/events,https://github.com/rails/rails/pull/49348,1907793971,PR_kwDNIULOWu7p6Q,49348,Get fixture label from a record,"{'login': 'jean-francois-labbe', 'id': 1558372, 'node_id': 'MDQ6VXNlcjE1NTgzNzI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1558372?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jean-francois-labbe', 'html_url': 'https://github.com/jean-francois-labbe', 'followers_url': 'https://api.github.com/users/jean-francois-labbe/followers', 'following_url': 'https://api.github.com/users/jean-francois-labbe/following{/other_user}', 'gists_url': 'https://api.github.com/users/jean-francois-labbe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jean-francois-labbe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jean-francois-labbe/subscriptions', 'organizations_url': 'https://api.github.com/users/jean-francois-labbe/orgs', 'repos_url': 'https://api.github.com/users/jean-francois-labbe/repos', 'events_url': 'https://api.github.com/users/jean-francois-labbe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jean-francois-labbe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-21T21:27:36Z,2023-09-21T23:43:41Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49348', 'html_url': 'https://github.com/rails/rails/pull/49348', 'diff_url': 'https://github.com/rails/rails/pull/49348.diff', 'patch_url': 'https://github.com/rails/rails/pull/49348.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because I'd like to get the label of the fixture that created a record. 

### Detail

When working with fixtures, it inserts records in the database at the beginning of the test suite. I like to validate those fixtures to avoid inserting invalid data for testing. In case of validation error, I need to find out which fixture created the failing record. For some models it's easy to go from one record  to the fixture that created it, for other models it can be more complicated, for example a join model with an id and foreign_keys.

This PR introduces `ActiveRecord::FixtureSet.label_of(record)` which will return the fixture label of the record if it was created by a fixture.

I'd like to get feedback regarding this PR and could it be useful in the project ?
This is working for records with primary_key. 
Composite primary keys are not supported, should it be supported in this PR ?

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49348/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 1, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49348/timeline,,
https://api.github.com/repos/rails/rails/issues/49346,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49346/labels{/name},https://api.github.com/repos/rails/rails/issues/49346/comments,https://api.github.com/repos/rails/rails/issues/49346/events,https://github.com/rails/rails/pull/49346,1907061730,PR_kwDNIULOWuTf9w,49346,Add support for generated columns in SQLite3 adapter,"{'login': 'fractaledmind', 'id': 5077225, 'node_id': 'MDQ6VXNlcjUwNzcyMjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5077225?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fractaledmind', 'html_url': 'https://github.com/fractaledmind', 'followers_url': 'https://api.github.com/users/fractaledmind/followers', 'following_url': 'https://api.github.com/users/fractaledmind/following{/other_user}', 'gists_url': 'https://api.github.com/users/fractaledmind/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fractaledmind/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fractaledmind/subscriptions', 'organizations_url': 'https://api.github.com/users/fractaledmind/orgs', 'repos_url': 'https://api.github.com/users/fractaledmind/repos', 'events_url': 'https://api.github.com/users/fractaledmind/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fractaledmind/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-21T14:01:38Z,2023-10-03T12:12:25Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49346', 'html_url': 'https://github.com/rails/rails/pull/49346', 'diff_url': 'https://github.com/rails/rails/pull/49346.diff', 'patch_url': 'https://github.com/rails/rails/pull/49346.patch', 'merged_at': None}","### Motivation / Background

SQLite is a feature-rich database engine, and production usage is only growing. We need Rails' support to offer developers the range and scope of its features.

Both the MySQL and PostgreSQL adapters support virtual columns, and SQLite itself has support generated columns [since 2020](https://www.sqlite.org/releaselog/3_31_0.html).

### Detail

PR https://github.com/rails/rails/pull/41856 introduced virtual columns to the PostgreSQLAdapter. This is effectively a clone of that feature, with some necessary tweaks.

```ruby
create_table :users do |t|
  t.string :name
  t.virtual :name_upper, type: :string, as: 'UPPER(name)'
  t.virtual :name_lower, type: :string, as: 'LOWER(name)', stored: true
end
```

Firstly, SQLite supported both `STORED` and `VIRTUAL` generated columns, while PostgreSQL only supports `VIRTUAL`. Secondly, SQLite doesn't support `ALTER TABLE` commands with generated columns. 

In this PR, I am adding full support for the SQLite3Adapter by implementing:

`ActiveRecord::ConnectionAdapters::SQLite3::Column#virtual?`
`ActiveRecord::ConnectionAdapters::SQLite3Adapter#supports_virtual_columns?`

and altering:

`ActiveRecord::ConnectionAdapters::SQLite3::SchemaCreation#add_column_options`
`ActiveRecord::ConnectionAdapters::SQLite3::SchemaDefinitions#new_column_definition`
`ActiveRecord::ConnectionAdapters::SQLite3::SchemaDumper#prepare_column_options`
`ActiveRecord::ConnectionAdapters::SQLite3::SchemaStatements#new_column_from_field`
`ActiveRecord::ConnectionAdapters::SQLite3Adapter#table_structure`
`ActiveRecord::ConnectionAdapters::SQLite3Adapter#invalid_alter_table_type?`
`ActiveRecord::ConnectionAdapters::SQLite3Adapter#table_structure_with_collation`

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49346/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49346/timeline,,
https://api.github.com/repos/rails/rails/issues/49339,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49339/labels{/name},https://api.github.com/repos/rails/rails/issues/49339/comments,https://api.github.com/repos/rails/rails/issues/49339/events,https://github.com/rails/rails/pull/49339,1905718431,PR_kwDNIULOWtKnFw,49339,Introduce :production_only flag for ActiveSupport::ErorrReporter#handle,"{'login': 'andrewn617', 'id': 39735028, 'node_id': 'MDQ6VXNlcjM5NzM1MDI4', 'avatar_url': 'https://avatars.githubusercontent.com/u/39735028?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/andrewn617', 'html_url': 'https://github.com/andrewn617', 'followers_url': 'https://api.github.com/users/andrewn617/followers', 'following_url': 'https://api.github.com/users/andrewn617/following{/other_user}', 'gists_url': 'https://api.github.com/users/andrewn617/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/andrewn617/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/andrewn617/subscriptions', 'organizations_url': 'https://api.github.com/users/andrewn617/orgs', 'repos_url': 'https://api.github.com/users/andrewn617/repos', 'events_url': 'https://api.github.com/users/andrewn617/events{/privacy}', 'received_events_url': 'https://api.github.com/users/andrewn617/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,6,2023-09-20T21:04:43Z,2023-09-21T19:19:42Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49339', 'html_url': 'https://github.com/rails/rails/pull/49339', 'diff_url': 'https://github.com/rails/rails/pull/49339.diff', 'patch_url': 'https://github.com/rails/rails/pull/49339.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because I want to have the ability to use `ActiveSupport::ErrorReport#handle` to handle errors in production, but still have these errors be raised when encountered in test or development mode. Sometimes for un-expected / rare issues is better to handle it gracefully in production but I would still prefer to raise it in dev / test.

### Detail

This Pull Request introduces a `production_only` flag to the `ActiveSupport::ErrorReporter#handle` and `#report` methods and `production` attribute to `ActiveSupport::ErrorReporter`. When this flag is `true` errors will be raised in non-production environments instead of reported. The flag is `false` by default to preserve existing behaviour.

I added a `production` attribute to `ActiveSupport::ErrorReporter` instances to capture what environment we are in. It is `true` by default. 

In `Rails#error` I `tap` the error handler and set the `production` flag based on the Rails environment.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49339/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49339/timeline,,
https://api.github.com/repos/rails/rails/issues/49337,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49337/labels{/name},https://api.github.com/repos/rails/rails/issues/49337/comments,https://api.github.com/repos/rails/rails/issues/49337/events,https://github.com/rails/rails/pull/49337,1905651414,PR_kwDNIULOWtG7hA,49337,Include connection specification name into `ActiveRecord::StatementInvalid` errors,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,5,2023-09-20T20:12:27Z,2023-10-01T20:00:26Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49337', 'html_url': 'https://github.com/rails/rails/pull/49337', 'diff_url': 'https://github.com/rails/rails/pull/49337.diff', 'patch_url': 'https://github.com/rails/rails/pull/49337.patch', 'merged_at': None}",Fixes #49331.,"{'url': 'https://api.github.com/repos/rails/rails/issues/49337/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49337/timeline,,
https://api.github.com/repos/rails/rails/issues/49332,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49332/labels{/name},https://api.github.com/repos/rails/rails/issues/49332/comments,https://api.github.com/repos/rails/rails/issues/49332/events,https://github.com/rails/rails/pull/49332,1905137555,PR_kwDNIULOWsrIvg,49332,Handle update and update! on scopes properly,"{'login': 'raszi', 'id': 76983, 'node_id': 'MDQ6VXNlcjc2OTgz', 'avatar_url': 'https://avatars.githubusercontent.com/u/76983?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/raszi', 'html_url': 'https://github.com/raszi', 'followers_url': 'https://api.github.com/users/raszi/followers', 'following_url': 'https://api.github.com/users/raszi/following{/other_user}', 'gists_url': 'https://api.github.com/users/raszi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/raszi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/raszi/subscriptions', 'organizations_url': 'https://api.github.com/users/raszi/orgs', 'repos_url': 'https://api.github.com/users/raszi/repos', 'events_url': 'https://api.github.com/users/raszi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/raszi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,7,2023-09-20T14:34:30Z,2023-10-06T09:37:25Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49332', 'html_url': 'https://github.com/rails/rails/pull/49332', 'diff_url': 'https://github.com/rails/rails/pull/49332.diff', 'patch_url': 'https://github.com/rails/rails/pull/49332.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because the current behavior is misleading and could cause potential data loss. If you define a scope and you try to call an `update` or `update!` on the scope then you would expect that the updates will be executed on the scope and not on every record by ignoring the scope completely.

If I wanted to update every record, then I would call the `update` or `update!` on the model directly.

### Detail

This change updates the behavior of the `update` and `update!` methods of the `ActiveRecord::Relation`. If you pass a set of ids then the update will be executed on those records that match the selected ids but also satisfy the scope.

With this change, we also make the `update` and `update!` methods symmetric regardless of whether the first parameter was `:all` or a set of ids.

### Additional information

This might be considered a breaking change, but I do believe this is an actual bugfix since the behavior was misleading and it was asymmetric depending on the first argument.

Consider the following scenario, if you want to update the `Model` record and set all of the `sent_at` attributes to the actual time if the items have been sent, then this would work.

```ruby
Model.unsent.update!(:all, sent_at: Time.zone.now)
```

But if you want to reduce it to just a subset of ids:

```ruby
Model.unsent.update!([1, 2], { sent_at: Time.zone.now }, { sent_at: Time.zone.now })
```

Then this method call would update all the `Model` records with the matching ids in the DB and we would lose the previous `sent_at` values if for example Model with id `1` was sent already.

#### Undocumented and untested behavior

I made my change symmetric to `ActiveRecord::Persistence` so it will also raise an `ActiveRecord::RecordNotFound` error if a record could not be found, it also raises similar `ArgumentError` exceptions when invalid arguments are passed.  This behavior was undocumented and untested, now I added tests to cover the cases.

I was using `respond_to?` to check if we received an `Enumerable` like argument. This code is almost the exact copy of the `ActiveRecord::Persistence#update` or `ActiveRecord::Persistence#update!`, we could merge these three methods into one concern, but I did not want to introduce any bigger changes with this PR.

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49332/reactions', 'total_count': 7, '+1': 7, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49332/timeline,,
https://api.github.com/repos/rails/rails/issues/49331,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49331/labels{/name},https://api.github.com/repos/rails/rails/issues/49331/comments,https://api.github.com/repos/rails/rails/issues/49331/events,https://github.com/rails/rails/issues/49331,1905093936,I_kwDNIULOcY1tMA,49331,Report what connection spec failed on `ActiveRecord::StatementInvalid`,"{'login': 'sobrinho', 'id': 26460, 'node_id': 'MDQ6VXNlcjI2NDYw', 'avatar_url': 'https://avatars.githubusercontent.com/u/26460?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sobrinho', 'html_url': 'https://github.com/sobrinho', 'followers_url': 'https://api.github.com/users/sobrinho/followers', 'following_url': 'https://api.github.com/users/sobrinho/following{/other_user}', 'gists_url': 'https://api.github.com/users/sobrinho/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sobrinho/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sobrinho/subscriptions', 'organizations_url': 'https://api.github.com/users/sobrinho/orgs', 'repos_url': 'https://api.github.com/users/sobrinho/repos', 'events_url': 'https://api.github.com/users/sobrinho/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sobrinho/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,11,2023-09-20T14:12:26Z,2023-09-29T20:26:55Z,,CONTRIBUTOR,,,,"### Steps to reproduce
Backtraces doesn't always point exactly to what connection have failed.

```ruby
ActiveRecord::Base.configurations.configs_for(env_name: ActiveRecord::Tasks::DatabaseTasks.env).each do |db_config|
  ActiveRecord::Base.establish_connection(db_config)
  puts ActiveRecord::Base.connection.select_values 'select now()'
end
```

### Expected behavior
```
ActiveRecord::StatementInvalid
primary --> [connection name or something about what connection failed]
PG::ConnectionBad: PQconsumeInput() FATAL:  terminating connection due to idle-in-transaction timeout
ERROR:  server conn crashed?
SSL connection has been closed unexpectedly
```

### Actual behavior
```
ActiveRecord::StatementInvalid
PG::ConnectionBad: PQconsumeInput() FATAL:  terminating connection due to idle-in-transaction timeout
ERROR:  server conn crashed?
SSL connection has been closed unexpectedly
PG::ConnectionBad
```

### System configuration
**Rails version**: 6.1.7.5

**Ruby version**: 2.7.6
","{'url': 'https://api.github.com/repos/rails/rails/issues/49331/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49331/timeline,,
https://api.github.com/repos/rails/rails/issues/49328,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49328/labels{/name},https://api.github.com/repos/rails/rails/issues/49328/comments,https://api.github.com/repos/rails/rails/issues/49328/events,https://github.com/rails/rails/issues/49328,1904699061,I_kwDNIULOcYdmtQ,49328,Custom master key path is not respected in credentials:show and credentials:edit,"{'login': 'Verseth', 'id': 31414818, 'node_id': 'MDQ6VXNlcjMxNDE0ODE4', 'avatar_url': 'https://avatars.githubusercontent.com/u/31414818?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Verseth', 'html_url': 'https://github.com/Verseth', 'followers_url': 'https://api.github.com/users/Verseth/followers', 'following_url': 'https://api.github.com/users/Verseth/following{/other_user}', 'gists_url': 'https://api.github.com/users/Verseth/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Verseth/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Verseth/subscriptions', 'organizations_url': 'https://api.github.com/users/Verseth/orgs', 'repos_url': 'https://api.github.com/users/Verseth/repos', 'events_url': 'https://api.github.com/users/Verseth/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Verseth/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-20T10:36:03Z,2023-10-05T05:55:13Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```sh
$ rails new example
$ cd example
$ mv config/master.key config/custom_master.key
$ echo ""Rails.application.config.credentials.key_path = Rails.root.join('config', 'custom_master.key')"" >> config/application.rb
$ echo ""Rails.application.config.require_master_key = true"" >> config/application.rb
```

The app is set up. It is configured with a custom master key path, and to shutdown when the master key could not be found.

### Expected behavior
<!-- Tell us what should happen -->

The server should work just fine

```sh
$ bin/rails s
=> Booting Puma
=> Rails 7.0.8 application starting in development 
=> Run `bin/rails server --help` for more startup options
Puma starting in single mode...
* Puma version: 5.6.7 (ruby 3.2.2-p53) (""Birdie's Version"")
*  Min threads: 5
*  Max threads: 5
*  Environment: development
*          PID: 43547
* Listening on http://127.0.0.1:3000
* Listening on http://[::1]:3000
Use Ctrl-C to stop
```

The `credentials:show` and `credentials:edit` commands should look for the key in the file path configured in `config/application.rb`. They should load the key from `config/custom_master.key`, just like the app does when the server is started with `bin/rails server`

```sh
$ bin/rails credentials:show
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: 6dd34e9349447df81fac521bb56e790e7851148c8d6b308d9467ee4750f0432f5d2b9c64d49caa67094783504ee578932b7de5ffbe2478ea10b673de1ac85027
```

The same thing should happen for the `credentials:edit` command.

```sh
$ EDITOR=""code --wait"" bin/rails credentials:edit
```


### Actual behaviour
The server works just fine

```sh
$ bin/rails s
=> Booting Puma
=> Rails 7.0.8 application starting in development 
=> Run `bin/rails server --help` for more startup options
Puma starting in single mode...
* Puma version: 5.6.7 (ruby 3.2.2-p53) (""Birdie's Version"")
*  Min threads: 5
*  Max threads: 5
*  Environment: development
*          PID: 43547
* Listening on http://127.0.0.1:3000
* Listening on http://[::1]:3000
Use Ctrl-C to stop
```

But the `credentials:show` and `credentials:edit` commands are broken.

`bin/rails credentials:show` still looks for the master key in the default path `config/master.key` even though I configured `Rails.application.config.credentials.key_path` to `config/custom_master.key`.

```sh
$ bin/rails credentials:show
/Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/activesupport-7.0.8/lib/active_support/encrypted_file.rb:121:in `handle_missing_key': Missing encryption key to decrypt file with. Ask your team for your master key and write it to /Users/mateuszdrewniak/tmp/example/config/master.key or put it in the ENV['RAILS_MASTER_KEY']. (ActiveSupport::EncryptedFile::MissingKeyError)
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/activesupport-7.0.8/lib/active_support/encrypted_file.rb:53:in `key'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/activesupport-7.0.8/lib/active_support/encrypted_file.rb:65:in `read'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/activesupport-7.0.8/lib/active_support/encrypted_configuration.rb:43:in `read'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/commands/credentials/credentials_command.rb:51:in `show'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/thor-1.2.2/lib/thor/command.rb:27:in `run'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:127:in `invoke_command'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/thor-1.2.2/lib/thor.rb:392:in `dispatch'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/command/base.rb:87:in `perform'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/command.rb:48:in `invoke'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/commands.rb:18:in `<main>'
        from <internal:/Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:38:in `require'
        from <internal:/Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:38:in `require'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/bootsnap-1.16.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'
        from bin/rails:4:in `<main>'
```

The same thing happens for the `credentials:edit` command.

```sh
$ EDITOR=""code --wait"" bin/rails credentials:edit
/Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/activesupport-7.0.8/lib/active_support/encrypted_file.rb:121:in `handle_missing_key': Missing encryption key to decrypt file with. Ask your team for your master key and write it to /Users/mateuszdrewniak/tmp/example/config/master.key or put it in the ENV['RAILS_MASTER_KEY']. (ActiveSupport::EncryptedFile::MissingKeyError)
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/activesupport-7.0.8/lib/active_support/encrypted_file.rb:53:in `key'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/commands/credentials/credentials_command.rb:34:in `edit'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/thor-1.2.2/lib/thor/command.rb:27:in `run'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:127:in `invoke_command'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/thor-1.2.2/lib/thor.rb:392:in `dispatch'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/command/base.rb:87:in `perform'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/command.rb:48:in `invoke'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/railties-7.0.8/lib/rails/commands.rb:18:in `<main>'
        from <internal:/Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:38:in `require'
        from <internal:/Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:38:in `require'
        from /Users/mateuszdrewniak/.rbenv/versions/3.2.2/lib/ruby/gems/3.2.0/gems/bootsnap-1.16.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'
        from bin/rails:4:in `<main>'
```

### System configuration
**Rails version**:
Rails 7.0.8

**Ruby version**:
ruby 3.2.2 (2023-03-30 revision e51014f9c0) [arm64-darwin22]","{'url': 'https://api.github.com/repos/rails/rails/issues/49328/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49328/timeline,,
https://api.github.com/repos/rails/rails/issues/49327,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49327/labels{/name},https://api.github.com/repos/rails/rails/issues/49327/comments,https://api.github.com/repos/rails/rails/issues/49327/events,https://github.com/rails/rails/issues/49327,1904264534,I_kwDNIULOcYDFVg,49327,"Documentation Bug, lack of definition of 'Resourceful' ","{'login': 'YusukeSuzuki', 'id': 657060, 'node_id': 'MDQ6VXNlcjY1NzA2MA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/657060?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/YusukeSuzuki', 'html_url': 'https://github.com/YusukeSuzuki', 'followers_url': 'https://api.github.com/users/YusukeSuzuki/followers', 'following_url': 'https://api.github.com/users/YusukeSuzuki/following{/other_user}', 'gists_url': 'https://api.github.com/users/YusukeSuzuki/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/YusukeSuzuki/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/YusukeSuzuki/subscriptions', 'organizations_url': 'https://api.github.com/users/YusukeSuzuki/orgs', 'repos_url': 'https://api.github.com/users/YusukeSuzuki/repos', 'events_url': 'https://api.github.com/users/YusukeSuzuki/events{/privacy}', 'received_events_url': 'https://api.github.com/users/YusukeSuzuki/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 384913768, 'node_id': 'MDU6TGFiZWwzODQ5MTM3Njg=', 'url': 'https://api.github.com/repos/rails/rails/labels/good%20first%20issue', 'name': 'good first issue', 'color': '0e8a16', 'default': True, 'description': ''}]",open,False,,[],,6,2023-09-20T06:37:21Z,2023-10-03T13:51:46Z,,NONE,,,,The documentation lacks a definition of what conditions are met for resourceful routing.,"{'url': 'https://api.github.com/repos/rails/rails/issues/49327/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49327/timeline,,
https://api.github.com/repos/rails/rails/issues/49324,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49324/labels{/name},https://api.github.com/repos/rails/rails/issues/49324/comments,https://api.github.com/repos/rails/rails/issues/49324/events,https://github.com/rails/rails/issues/49324,1903862903,I_kwDNIULOcXqkdw,49324,Cannot detect when touch is called with belongs_to touch: true,"{'login': 'humphreyja', 'id': 6947247, 'node_id': 'MDQ6VXNlcjY5NDcyNDc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6947247?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/humphreyja', 'html_url': 'https://github.com/humphreyja', 'followers_url': 'https://api.github.com/users/humphreyja/followers', 'following_url': 'https://api.github.com/users/humphreyja/following{/other_user}', 'gists_url': 'https://api.github.com/users/humphreyja/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/humphreyja/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/humphreyja/subscriptions', 'organizations_url': 'https://api.github.com/users/humphreyja/orgs', 'repos_url': 'https://api.github.com/users/humphreyja/repos', 'events_url': 'https://api.github.com/users/humphreyja/events{/privacy}', 'received_events_url': 'https://api.github.com/users/humphreyja/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2023-09-19T23:44:30Z,2023-09-25T06:40:03Z,,NONE,,,,"I can't seem to find a way to detect when a touch event is called in an `after_commit` hook when the touch event is triggered by a relational ""touch: true"" event. If I manually call `comment.touch` the behavior is different and I can detect that the change being made is only a touch event.

In our system we rely on `updated_at` for caching, but we also have plenty of actioncable subscriptions and various other calculations being called on `after_commit`, but we only want to actually run those events when the record was updated, not just touched from a related record. 

Is there any way to detect when a commit is caused by a `belongs_to ... touch: true`? I can't seem to find anything about it and this seems like it'd be a pretty useful thing...

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  gem ""rails"", ""7.0.8""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :events, force: true do |t|
    t.string :name
    t.timestamps
  end

  create_table :posts, force: true do |t|
    t.integer :author_id
    t.string :results
    t.timestamps
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.string :description
    t.timestamps
  end
end

class Event < ActiveRecord::Base
end

class Post < ActiveRecord::Base
  has_many :comments

  after_commit :create_change_event, unless: :touched_only?

  def create_change_event
    Event.create(name: 'POST')
  end

  def touched_only?
    saved_changes.keys == ['updated_at']
  end
end

class Comment < ActiveRecord::Base
  belongs_to :post, touch: true
end

class BugTest < Minitest::Test
  def test_relational_touch_should_skip_hook_but_still_touch_parents
    post = Post.create!
    comment = Comment.create!(post:)
    Event.destroy_all
    post.reload

    assert_equal 0, Event.count, 'should have no events in the database'

    comment.update(description: 'something...')
    # Post should not create a new updated event because it was touched only
    assert_equal 0, Event.count, 'should still have no events in the database as we do not want to track touch only events'
  end
end
```

### Expected behavior
<!-- Tell us what should happen -->
`saved_changes` should include `updated_at` to prevent unnecessary operations in the `after_commit` hook.

### Actual behavior
<!-- Tell us what happens instead -->
`saved_changes` is empty, leading the system to believe that nothing was changed but the `after_commit` hook was still called.

### System configuration
**Rails version**: 7.0.8

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49324/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49324/timeline,,
https://api.github.com/repos/rails/rails/issues/49315,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49315/labels{/name},https://api.github.com/repos/rails/rails/issues/49315/comments,https://api.github.com/repos/rails/rails/issues/49315/events,https://github.com/rails/rails/pull/49315,1902605602,PR_kwDNIULOWqh3sA,49315,Support returning option in insert_all for MariaDB,"{'login': 'nkondratyev', 'id': 1068531, 'node_id': 'MDQ6VXNlcjEwNjg1MzE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1068531?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nkondratyev', 'html_url': 'https://github.com/nkondratyev', 'followers_url': 'https://api.github.com/users/nkondratyev/followers', 'following_url': 'https://api.github.com/users/nkondratyev/following{/other_user}', 'gists_url': 'https://api.github.com/users/nkondratyev/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nkondratyev/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nkondratyev/subscriptions', 'organizations_url': 'https://api.github.com/users/nkondratyev/orgs', 'repos_url': 'https://api.github.com/users/nkondratyev/repos', 'events_url': 'https://api.github.com/users/nkondratyev/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nkondratyev/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-19T09:46:58Z,2023-09-20T14:53:51Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49315', 'html_url': 'https://github.com/rails/rails/pull/49315', 'diff_url': 'https://github.com/rails/rails/pull/49315.diff', 'patch_url': 'https://github.com/rails/rails/pull/49315.patch', 'merged_at': None}","MariaDB have supported [INSERT RETURNING](https://mariadb.com/kb/en/insertreturning/) starting with 10.5.0.

This is very convenient to use in methods such as `ActiveRecord::Persistence.insert_all` to return default or setted by trigger attributes.

Now you can use returning option with MariaDB the same way as with PostgreSQL in ActiveRecord::Persistence [insert](https://api.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert_all) methods.

There are tests https://github.com/rails/rails/blob/ebcd7233ea1307448f2d97eaf56a8d303200e5f7/activerecord/test/cases/insert_all_test.rb#L87-L120  that will automatically run in the required version of MariaDB.

We've been using this patch in production for several months.","{'url': 'https://api.github.com/repos/rails/rails/issues/49315/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49315/timeline,,
https://api.github.com/repos/rails/rails/issues/49314,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49314/labels{/name},https://api.github.com/repos/rails/rails/issues/49314/comments,https://api.github.com/repos/rails/rails/issues/49314/events,https://github.com/rails/rails/pull/49314,1901813639,PR_kwDNIULOWp3EyQ,49314,Add normalizes_type to apply common normalizations,"{'login': 'codergeek121', 'id': 4910785, 'node_id': 'MDQ6VXNlcjQ5MTA3ODU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4910785?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/codergeek121', 'html_url': 'https://github.com/codergeek121', 'followers_url': 'https://api.github.com/users/codergeek121/followers', 'following_url': 'https://api.github.com/users/codergeek121/following{/other_user}', 'gists_url': 'https://api.github.com/users/codergeek121/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/codergeek121/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/codergeek121/subscriptions', 'organizations_url': 'https://api.github.com/users/codergeek121/orgs', 'repos_url': 'https://api.github.com/users/codergeek121/repos', 'events_url': 'https://api.github.com/users/codergeek121/events{/privacy}', 'received_events_url': 'https://api.github.com/users/codergeek121/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 257468118, 'node_id': 'MDU6TGFiZWwyNTc0NjgxMTg=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20work', 'name': 'needs work', 'color': '000000', 'default': False, 'description': None}]",open,False,,[],,2,2023-09-18T22:00:16Z,2023-10-06T06:07:39Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49314', 'html_url': 'https://github.com/rails/rails/pull/49314', 'diff_url': 'https://github.com/rails/rails/pull/49314.diff', 'patch_url': 'https://github.com/rails/rails/pull/49314.patch', 'merged_at': None}","### Motivation / Background

Many apps use the https://github.com/rmm5t/strip_attributes gem to strip most string attributes.
The new `normalizes` API is a perfect fit for this. One ""downside"" in contrast to the strip_attributes gem, is that you have to explicitly list all attributes you want to normalize. It would be nice to have a simple way to e.g. ""strip all string attributes in most models"".

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49314/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49314/timeline,,
https://api.github.com/repos/rails/rails/issues/49303,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49303/labels{/name},https://api.github.com/repos/rails/rails/issues/49303/comments,https://api.github.com/repos/rails/rails/issues/49303/events,https://github.com/rails/rails/issues/49303,1899478935,I_kwDNIULOcTe_lw,49303,"`render` with no arguments or non-existent partial returns `200 OK "" ""` in API controller","{'login': 'nholden', 'id': 7942714, 'node_id': 'MDQ6VXNlcjc5NDI3MTQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7942714?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nholden', 'html_url': 'https://github.com/nholden', 'followers_url': 'https://api.github.com/users/nholden/followers', 'following_url': 'https://api.github.com/users/nholden/following{/other_user}', 'gists_url': 'https://api.github.com/users/nholden/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nholden/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nholden/subscriptions', 'organizations_url': 'https://api.github.com/users/nholden/orgs', 'repos_url': 'https://api.github.com/users/nholden/repos', 'events_url': 'https://api.github.com/users/nholden/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nholden/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-16T15:48:13Z,2023-09-18T16:56:48Z,,CONTRIBUTOR,,,,"### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""rack"", ""~> 2.0""
end

require ""action_controller/railtie""

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""example.org""
  config.secret_key_base = ""secret_key_base""

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    get ""/base_no_arguments"" => ""test_base#no_arguments""
    get ""/base_non_existent_partial"" => ""test_base#non_existent_partial""
    get ""/api_no_arguments"" => ""test_api#no_arguments""
    get ""/api_non_existent_partial"" => ""test_api#non_existent_partial""
  end
end

class TestBaseController < ActionController::Base
  include Rails.application.routes.url_helpers

  def no_arguments
    render
  end

  def non_existent_partial
    render partial: ""foo/bar""
  end
end

class TestApiController < ActionController::API
  include Rails.application.routes.url_helpers

  def no_arguments
    render
  end

  def non_existent_partial
    render partial: ""foo/bar""
  end
end

require ""minitest/autorun""
require ""rack/test""

class BugTest < Minitest::Test
  include Rack::Test::Methods

  def test_base_no_arguments_returns_500
    get ""/base_no_arguments""

    refute last_response.ok?
    # ActionView::MissingTemplate
    assert_equal 500, last_response.status
    assert_equal """", last_response.body
  end

  def test_base_non_existent_partial_returns_500
    get ""/base_non_existent_partial""

    refute last_response.ok?
    # ActionView::MissingTemplate
    assert_equal 500, last_response.status
    assert_equal """", last_response.body
  end

  def test_api_no_arguments_returns_success
    get ""/api_no_arguments""

    assert last_response.ok?
    assert_equal 200, last_response.status
    assert_equal "" "", last_response.body
  end

  def test_api_non_existent_partial_returns_success
    get ""/api_non_existent_partial""

    assert last_response.ok?
    assert_equal 200, last_response.status
    assert_equal "" "", last_response.body
  end

  private
    def app
      Rails.application
    end
end
```

### Expected behavior
When I call `render` with no arguments or with a non-existent partial (e.g. `render(partial: ""foo/bar"")`) in an API controller. I'd expect to get some feedback that I'm doing something wrong. In a controller that inherits from `ActionController::Base`, this raises a `ActionView::MissingTemplate` error. I would expect Rails to raise a similar error in a controller that inherits from `ActionController::API`.

### Actual behavior
When I call `render` with no arguments or with a non-existent partial (e.g. `render(partial: ""foo/bar"")`), the controller returns a `200 OK` response with a body of `"" ""`.

I proposed deprecating this behavior in https://github.com/rails/rails/pull/49212.

### System configuration
**Rails version**: `main`

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49303/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49303/timeline,,
https://api.github.com/repos/rails/rails/issues/49301,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49301/labels{/name},https://api.github.com/repos/rails/rails/issues/49301/comments,https://api.github.com/repos/rails/rails/issues/49301/events,https://github.com/rails/rails/pull/49301,1899389684,PR_kwDNIULOWn2rWA,49301,[ci skip] clarify the benefits of using ActiveJob's execution wrappers,"{'login': 'freesteph', 'id': 107635, 'node_id': 'MDQ6VXNlcjEwNzYzNQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/107635?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/freesteph', 'html_url': 'https://github.com/freesteph', 'followers_url': 'https://api.github.com/users/freesteph/followers', 'following_url': 'https://api.github.com/users/freesteph/following{/other_user}', 'gists_url': 'https://api.github.com/users/freesteph/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/freesteph/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/freesteph/subscriptions', 'organizations_url': 'https://api.github.com/users/freesteph/orgs', 'repos_url': 'https://api.github.com/users/freesteph/repos', 'events_url': 'https://api.github.com/users/freesteph/events{/privacy}', 'received_events_url': 'https://api.github.com/users/freesteph/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,6,2023-09-16T10:36:45Z,2023-09-23T12:55:07Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49301', 'html_url': 'https://github.com/rails/rails/pull/49301', 'diff_url': 'https://github.com/rails/rails/pull/49301.diff', 'patch_url': 'https://github.com/rails/rails/pull/49301.patch', 'merged_at': None}","### Motivation / Background

I've been stuck on a failing test about a job that was supposed to be rescued from exceptions, and after an embarrassing amount of time I came to realise that using `perform` shortcuts all of the ActiveJob niceties.

This Pull Request has been created because I don't want other people to confuse the `perform`, `perform_now` or `perform_later` altogether and waste valuable time trying to understand why the first one doesn't behave like the two others.

Feel free to challenge the wording as you please :v:

### Detail

This Pull Request changes the ActiveJob guide.

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49301/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49301/timeline,,
https://api.github.com/repos/rails/rails/issues/49297,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49297/labels{/name},https://api.github.com/repos/rails/rails/issues/49297/comments,https://api.github.com/repos/rails/rails/issues/49297/events,https://github.com/rails/rails/pull/49297,1899146541,PR_kwDNIULOWnqp8w,49297,Add instrumentation for ActionController::Live#send_stream,"{'login': 'hannahramadan', 'id': 76922290, 'node_id': 'MDQ6VXNlcjc2OTIyMjkw', 'avatar_url': 'https://avatars.githubusercontent.com/u/76922290?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/hannahramadan', 'html_url': 'https://github.com/hannahramadan', 'followers_url': 'https://api.github.com/users/hannahramadan/followers', 'following_url': 'https://api.github.com/users/hannahramadan/following{/other_user}', 'gists_url': 'https://api.github.com/users/hannahramadan/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/hannahramadan/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/hannahramadan/subscriptions', 'organizations_url': 'https://api.github.com/users/hannahramadan/orgs', 'repos_url': 'https://api.github.com/users/hannahramadan/repos', 'events_url': 'https://api.github.com/users/hannahramadan/events{/privacy}', 'received_events_url': 'https://api.github.com/users/hannahramadan/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,2,2023-09-15T22:29:31Z,2023-10-05T16:59:48Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49297', 'html_url': 'https://github.com/rails/rails/pull/49297', 'diff_url': 'https://github.com/rails/rails/pull/49297.diff', 'patch_url': 'https://github.com/rails/rails/pull/49297.patch', 'merged_at': None}","### Motivation / Background

It was great to see `ActionController::Live#send_stream` introduced in Rails 7.0. We'd like to collect information on `send_stream` events by adding instrumentation for it.

### Detail

Adds instrumentation for `ActionController::Live#send_stream`. The event payload contains the filename, disposition, and type.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49297/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49297/timeline,,
https://api.github.com/repos/rails/rails/issues/49273,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49273/labels{/name},https://api.github.com/repos/rails/rails/issues/49273/comments,https://api.github.com/repos/rails/rails/issues/49273/events,https://github.com/rails/rails/issues/49273,1896689507,I_kwDNIULOcQ0vYw,49273,Respect prereqs for each database on rake db:migrate,"{'login': 'sobrinho', 'id': 26460, 'node_id': 'MDQ6VXNlcjI2NDYw', 'avatar_url': 'https://avatars.githubusercontent.com/u/26460?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sobrinho', 'html_url': 'https://github.com/sobrinho', 'followers_url': 'https://api.github.com/users/sobrinho/followers', 'following_url': 'https://api.github.com/users/sobrinho/following{/other_user}', 'gists_url': 'https://api.github.com/users/sobrinho/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sobrinho/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sobrinho/subscriptions', 'organizations_url': 'https://api.github.com/users/sobrinho/orgs', 'repos_url': 'https://api.github.com/users/sobrinho/repos', 'events_url': 'https://api.github.com/users/sobrinho/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sobrinho/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1071962662, 'node_id': 'MDU6TGFiZWwxMDcxOTYyNjYy', 'url': 'https://api.github.com/repos/rails/rails/labels/more-information-needed', 'name': 'more-information-needed', 'color': 'bfdadc', 'default': False, 'description': 'When reporter needs to provide more information'}]",open,False,,[],,4,2023-09-14T14:24:02Z,2023-10-04T08:44:28Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

We have some hooks on secondary connections like:

```
Rake::Task[""db:migrate:auditing""].prereqs << ""something""
```

But when we call `rake db:migrate` the prereqs aren't respected because of that line:

https://github.com/rails/rails/blob/6d4abdca5de1f85e1188e030d6cd8399948b02c1/activerecord/lib/active_record/railties/databases.rake#L100

Since we already have the rake task for each database defined, we could be invoking then instead:

https://github.com/rails/rails/blob/6d4abdca5de1f85e1188e030d6cd8399948b02c1/activerecord/lib/active_record/railties/databases.rake#L137

That would remove some code duplication as well.

### Expected behavior
prereqs for each database are invoked.

### Actual behavior
They are not.

### System configuration
**Rails version**: 6.1

**Ruby version**: N/A
","{'url': 'https://api.github.com/repos/rails/rails/issues/49273/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49273/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/49267,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49267/labels{/name},https://api.github.com/repos/rails/rails/issues/49267/comments,https://api.github.com/repos/rails/rails/issues/49267/events,https://github.com/rails/rails/pull/49267,1895379107,PR_kwDNIULOWkfY8g,49267,Add `save_and_open_page` helper to IntegrationTest,"{'login': 'JoeDupuis', 'id': 1518299, 'node_id': 'MDQ6VXNlcjE1MTgyOTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1518299?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JoeDupuis', 'html_url': 'https://github.com/JoeDupuis', 'followers_url': 'https://api.github.com/users/JoeDupuis/followers', 'following_url': 'https://api.github.com/users/JoeDupuis/following{/other_user}', 'gists_url': 'https://api.github.com/users/JoeDupuis/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JoeDupuis/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JoeDupuis/subscriptions', 'organizations_url': 'https://api.github.com/users/JoeDupuis/orgs', 'repos_url': 'https://api.github.com/users/JoeDupuis/repos', 'events_url': 'https://api.github.com/users/JoeDupuis/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JoeDupuis/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,0,2023-09-13T23:07:56Z,2023-10-04T01:44:58Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49267', 'html_url': 'https://github.com/rails/rails/pull/49267', 'diff_url': 'https://github.com/rails/rails/pull/49267.diff', 'patch_url': 'https://github.com/rails/rails/pull/49267.patch', 'merged_at': None}","`save_and_open_page` is a capybara helper that lets developers inspect the status of the page at any given point in their tests. This is helpful when trying to keep a short feedback loop while working on a test.

This change adds a similar helper with a matching signature to integration tests.


https://github.com/rails/rails/assets/1518299/8137fa68-619b-4673-bd95-495f56eb0984

### Motivation / Background

I have seen similar helpers defined in a number of projects in their `test_helper.rb`. 
I figured this would be a good candidate to upstream as we already have the same helper for system tests.

### Detail

Launchy is required to automatically open the dump in a browser, but the helper still works without. Without launchy it prints a warning along with the path to the dump for manual review. 

### Additional information

- I wasn't sure where to put the changelog notice. I've put it above the Rails 7.1 release header as I assume this won't make the cut for the release
- I did not add launchy to the [Gemfile template](https://github.com/rails/rails/blob/bb2fedbf013d2a087087c6456f3c54bc74d3e609/railties/lib/rails/generators/rails/app/templates/Gemfile.tt). Maybe I should?
### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49267/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49267/timeline,,
https://api.github.com/repos/rails/rails/issues/49259,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49259/labels{/name},https://api.github.com/repos/rails/rails/issues/49259/comments,https://api.github.com/repos/rails/rails/issues/49259/events,https://github.com/rails/rails/issues/49259,1895141197,I_kwDNIULOcPWPTQ,49259,rails console backtrace cleaner is too aggressive and removes all lines,"{'login': 'wlipa', 'id': 15970, 'node_id': 'MDQ6VXNlcjE1OTcw', 'avatar_url': 'https://avatars.githubusercontent.com/u/15970?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/wlipa', 'html_url': 'https://github.com/wlipa', 'followers_url': 'https://api.github.com/users/wlipa/followers', 'following_url': 'https://api.github.com/users/wlipa/following{/other_user}', 'gists_url': 'https://api.github.com/users/wlipa/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/wlipa/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/wlipa/subscriptions', 'organizations_url': 'https://api.github.com/users/wlipa/orgs', 'repos_url': 'https://api.github.com/users/wlipa/repos', 'events_url': 'https://api.github.com/users/wlipa/events{/privacy}', 'received_events_url': 'https://api.github.com/users/wlipa/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-13T19:39:11Z,2023-09-14T00:38:38Z,,NONE,,,,"In Rails 7.0.8, ruby 3.2.2, the backtrace cleaner completely removes all backtrace lines from any exception thrown in the rails console. Only the exception message is shown, which contains the location of the raised exception, but not any call stack info.

### Steps to reproduce

```
rails new consoletest
# add to app/models/application_record.rb:
  def self.ex
    raise 'an exception'
  end
  def self.ex2
    ex
  end
# then run the console
rails c
Loading development environment (Rails 7.0.8)
irb(main):001> ApplicationRecord.ex2
/private/tmp/consoletest/app/models/application_record.rb:5:in `ex': an exception (RuntimeError)
irb(main):002>

# note that no caller frames of the backtrace were shown - in particular the ex2 stack frame should be there. 
```

### Expected behavior

The backtrace should at least contain any app code stack frames for the exception call stack.

### Actual behavior

The rails backtrace silencer inside the railties lib removes each line.  I was unable to figure out why this happens in the console but not in a puma process.  Workaround is to remove all the backtrace silencers when running via the rails console.

### System configuration
**Rails version**: 7.0.8

**Ruby version**: ruby 3.2.2 (2023-03-30 revision e51014f9c0) [arm64-darwin22]
","{'url': 'https://api.github.com/repos/rails/rails/issues/49259/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49259/timeline,,
https://api.github.com/repos/rails/rails/issues/49254,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49254/labels{/name},https://api.github.com/repos/rails/rails/issues/49254/comments,https://api.github.com/repos/rails/rails/issues/49254/events,https://github.com/rails/rails/issues/49254,1894887186,I_kwDNIULOcPGvEg,49254,ActionCable 7.0.8 guide,"{'login': 'Tikkoneus', 'id': 1342501, 'node_id': 'MDQ6VXNlcjEzNDI1MDE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1342501?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Tikkoneus', 'html_url': 'https://github.com/Tikkoneus', 'followers_url': 'https://api.github.com/users/Tikkoneus/followers', 'following_url': 'https://api.github.com/users/Tikkoneus/following{/other_user}', 'gists_url': 'https://api.github.com/users/Tikkoneus/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Tikkoneus/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Tikkoneus/subscriptions', 'organizations_url': 'https://api.github.com/users/Tikkoneus/orgs', 'repos_url': 'https://api.github.com/users/Tikkoneus/repos', 'events_url': 'https://api.github.com/users/Tikkoneus/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Tikkoneus/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-13T16:37:00Z,2023-09-13T18:05:31Z,,NONE,,,,"Not a bug, but the [guide](https://guides.rubyonrails.org/action_cable_overview.html) left me in the dark at the end. The consumer never connected. Running `rails generate channel foobar` worked. It seems the key step missing from the docs is the diff in `config/importmap.rb`, never mentioned in the guide:

```
+pin ""@rails/actioncable"", to: ""actioncable.esm.js""
+pin_all_from ""app/javascript/channels"", under: ""channels""
```

I appreciate the guide's walk-through of all files involved, but since all the functionality the generator creates is do-nothing it seems reasonable to me to start the guide with an invocation of `generate channel` and then do the walk-through to fill out all the files just created.

### System configuration
**Rails version**: 7.0.8

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49254/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49254/timeline,,
https://api.github.com/repos/rails/rails/issues/49245,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49245/labels{/name},https://api.github.com/repos/rails/rails/issues/49245/comments,https://api.github.com/repos/rails/rails/issues/49245/events,https://github.com/rails/rails/pull/49245,1893384332,PR_kwDNIULOWizlXA,49245,Move started_request_message into LogSubscriber,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,4,2023-09-12T22:18:50Z,2023-09-20T21:49:12Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49245', 'html_url': 'https://github.com/rails/rails/pull/49245', 'diff_url': 'https://github.com/rails/rails/pull/49245.diff', 'patch_url': 'https://github.com/rails/rails/pull/49245.patch', 'merged_at': None}","### Motivation / Background

This commit is intended to address a few separate but related problems.

The first issue is that this log message is currently impossible to customize without monkey patching `Rails::Rack::Logger`. Gems like lograge and rails_semantic_logger currently monkey patch the class in order to remove or modify the message logged. Whether or not one of these specific gems is used, apps that want to use structured logging in production will almost certainly want to change or remove this message since it does not have a uniform structure.

Another issue is that this log message makes `Rails::Rack::Logger` dependent on `ActionDispatch::RemoteIp` if an application wants to be protected from IP spoofing (`RemoteIp` must appear before it in the middleware stack). There is currently an issue open because `RemoteIp` will raise an uncaught error when IP spoofing is detected, when really it should return a 4xx response. That type of issue is normally solved by `ActionDispatch::ShowExceptions`, however, `Rails::Rack::Logger` additionally depends on `ShowExceptions` being below it in the middleware stack so that the proper response status is logged. By moving the `started_request_message` out of `Rails::Rack::Logger`, the second dependency is removed and both `Rails::Rack::Logger` and `ShowExceptions` could be moved up to the top of the middleware stack in the future.

In addition to fixing the 5xx response for Ip spoofing requests, there is another large benefit to moving request instrumentation higher in the middleware stack. Currently, `process_action.action_controller` is the default instrumentation enabled in Rails applications. However, it is limited to returning information about the response returned from the controller action. This has lead to another issue opened where a user reported seeing 2xx responses logged (from `process_action`) even though the `ConditionalGet` middleware was intercepting the response and actually returning a 3xx response. So by enabling `Rails::Rack::Logger` to be moved higher up in the middleware stack, we are also creating an opportunity to have more realistic instrumentation and logs.

### Additional information

Issues references:
- #46003
- #46869 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49245/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49245/timeline,,
https://api.github.com/repos/rails/rails/issues/49240,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49240/labels{/name},https://api.github.com/repos/rails/rails/issues/49240/comments,https://api.github.com/repos/rails/rails/issues/49240/events,https://github.com/rails/rails/pull/49240,1892613767,PR_kwDNIULOWiKQFQ,49240,Add an internal route for bin/rails notes,"{'login': 'deepakmahakale', 'id': 14993828, 'node_id': 'MDQ6VXNlcjE0OTkzODI4', 'avatar_url': 'https://avatars.githubusercontent.com/u/14993828?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/deepakmahakale', 'html_url': 'https://github.com/deepakmahakale', 'followers_url': 'https://api.github.com/users/deepakmahakale/followers', 'following_url': 'https://api.github.com/users/deepakmahakale/following{/other_user}', 'gists_url': 'https://api.github.com/users/deepakmahakale/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/deepakmahakale/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/deepakmahakale/subscriptions', 'organizations_url': 'https://api.github.com/users/deepakmahakale/orgs', 'repos_url': 'https://api.github.com/users/deepakmahakale/repos', 'events_url': 'https://api.github.com/users/deepakmahakale/events{/privacy}', 'received_events_url': 'https://api.github.com/users/deepakmahakale/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-12T14:11:15Z,2023-09-18T13:00:02Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49240', 'html_url': 'https://github.com/rails/rails/pull/49240', 'diff_url': 'https://github.com/rails/rails/pull/49240.diff', 'patch_url': 'https://github.com/rails/rails/pull/49240.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Looking for early feedback on notes

Inspired by the `rails/info/routes` route I am suggesting a `rails/info/notes` internal route.

This will be same as doing 

```sh
$ bin/rails notes

app/controllers/posts_controller.rb:
  * [ 9] [TODO] Move this logic to a concern
  * [18] [FIXME] Refactor this method

app/models/post.rb:
  * [ 2] [TODO] Refactor this validation
```

### Detail

Adding an internal route for the `bin/rails notes` so we can check the notes on UI.

### Additional information

**Option 1:**

<img width=""890"" alt=""Screenshot 2023-09-12 at 19 40 07"" src=""https://github.com/rails/rails/assets/14993828/7bde94f3-629b-42b0-b85f-54826af9b553"">

**Option 2:**

<img width=""890"" alt=""Screenshot 2023-09-12 at 19 36 03"" src=""https://github.com/rails/rails/assets/14993828/104e15cb-460b-403d-93d8-5dcfae02d991"">

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49240/reactions', 'total_count': 3, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 3, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49240/timeline,,
https://api.github.com/repos/rails/rails/issues/49227,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49227/labels{/name},https://api.github.com/repos/rails/rails/issues/49227/comments,https://api.github.com/repos/rails/rails/issues/49227/events,https://github.com/rails/rails/issues/49227,1891294194,I_kwDNIULOcLrb8g,49227,`CurrentAttribute`s are cleared when a job gets executed inline in tests,"{'login': 'Earlopain', 'id': 14981592, 'node_id': 'MDQ6VXNlcjE0OTgxNTky', 'avatar_url': 'https://avatars.githubusercontent.com/u/14981592?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Earlopain', 'html_url': 'https://github.com/Earlopain', 'followers_url': 'https://api.github.com/users/Earlopain/followers', 'following_url': 'https://api.github.com/users/Earlopain/following{/other_user}', 'gists_url': 'https://api.github.com/users/Earlopain/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Earlopain/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Earlopain/subscriptions', 'organizations_url': 'https://api.github.com/users/Earlopain/orgs', 'repos_url': 'https://api.github.com/users/Earlopain/repos', 'events_url': 'https://api.github.com/users/Earlopain/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Earlopain/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,4,2023-09-11T21:28:34Z,2023-09-13T08:37:20Z,,CONTRIBUTOR,,,,"### Steps to reproduce

I have a test case like this

```rb
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""active_support/railtie""
require ""active_job/railtie""
require ""minitest/autorun""

class TestApp < Rails::Application
  config.load_defaults 7.1

  config.active_job.queue_adapter = :inline
  config.eager_load = false
end

Rails.application.initialize!

class Current < ActiveSupport::CurrentAttributes
  attribute :user
end

class DummyJob < ActiveJob::Base
  def perform
  end
end

class CurrentAttributeTest < ActiveSupport::TestCase
  test ""CurrentAttributes"" do
    Current.user = ""test""
    DummyJob.perform_later

    assert_equal(""test"", Current.user, ""CurrentAttributes reset"")
  end
end
```

Using the inline queue adapter the second assertion failed. ~~I tried making a self-contained test script but couldn't manage, the attributes only seem to be reset when I run it in a full-blown rails app. I have created a sample app here https://github.com/Earlopain/rails-current-attributes, you can just run rake test there.~~

I found issue #37526 and pr #37568 which seem to be about the same thing and it looks like they were closed as fixed/completed. Don't know what to make of that, just wanted to document.

### Expected behavior
CurrentAttributes are preserved.

### Actual behavior
CurrentAttributes are cleared.

### System configuration
**Rails version**: main

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49227/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49227/timeline,,
https://api.github.com/repos/rails/rails/issues/49223,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49223/labels{/name},https://api.github.com/repos/rails/rails/issues/49223/comments,https://api.github.com/repos/rails/rails/issues/49223/events,https://github.com/rails/rails/pull/49223,1890983917,PR_kwDNIULOWgxfEA,49223,Rails::Paths::Root can contains multiple directories,"{'login': 'LA-Toth', 'id': 1297651, 'node_id': 'MDQ6VXNlcjEyOTc2NTE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1297651?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/LA-Toth', 'html_url': 'https://github.com/LA-Toth', 'followers_url': 'https://api.github.com/users/LA-Toth/followers', 'following_url': 'https://api.github.com/users/LA-Toth/following{/other_user}', 'gists_url': 'https://api.github.com/users/LA-Toth/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/LA-Toth/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/LA-Toth/subscriptions', 'organizations_url': 'https://api.github.com/users/LA-Toth/orgs', 'repos_url': 'https://api.github.com/users/LA-Toth/repos', 'events_url': 'https://api.github.com/users/LA-Toth/events{/privacy}', 'received_events_url': 'https://api.github.com/users/LA-Toth/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,4,2023-09-11T17:50:25Z,2023-09-27T13:59:06Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49223', 'html_url': 'https://github.com/rails/rails/pull/49223', 'diff_url': 'https://github.com/rails/rails/pull/49223.diff', 'patch_url': 'https://github.com/rails/rails/pull/49223.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->


Originally Rails::Paths::Root supported multiple directories simply by appenending them to it (path << 'lib/something'), or a specific directory like:
  `path.add 'app/helpers', with: 'app/helpers', eager_load: true`
which is the default for 'app/helpers'.

As a complex app may has a complex directory layout, sometimes it's better to let add an array of directories, as the underlying Path object already supports it, and also Rails code, like: abstract_controller/helper.rb, def all_helpers_from_path


  

### Detail

This Pull Request changes `Rails::Paths::Root.add`.

While the change is backward-compatible, it enables the full potential of the Path class:
 `path.add 'app/helpers', with: ['app/helpers', 'lib/helpers'], eager_load: true`

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [ ] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49223/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49223/timeline,,
https://api.github.com/repos/rails/rails/issues/49217,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49217/labels{/name},https://api.github.com/repos/rails/rails/issues/49217/comments,https://api.github.com/repos/rails/rails/issues/49217/events,https://github.com/rails/rails/pull/49217,1890367844,PR_kwDNIULOWgQGIg,49217,Add `ActiveStorage::Blob#pdf?`,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-11T12:08:55Z,2023-09-11T17:26:40Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49217', 'html_url': 'https://github.com/rails/rails/pull/49217', 'diff_url': 'https://github.com/rails/rails/pull/49217.diff', 'patch_url': 'https://github.com/rails/rails/pull/49217.patch', 'merged_at': None}","It returns true if the content type is ""application/pdf"".
Similar to the existing `audio?`, `image?`, `video?` and `text?`
methods.

We probably don't want to add methods for every content type,
but pdf is pretty common and it's also used internally by Rails for
the Previewers.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49217/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49217/timeline,,
https://api.github.com/repos/rails/rails/issues/49212,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49212/labels{/name},https://api.github.com/repos/rails/rails/issues/49212/comments,https://api.github.com/repos/rails/rails/issues/49212/events,https://github.com/rails/rails/pull/49212,1888922678,PR_kwDNIULOWfETTA,49212,Deprecate calling `render` with no arguments in API controllers,"{'login': 'nholden', 'id': 7942714, 'node_id': 'MDQ6VXNlcjc5NDI3MTQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7942714?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nholden', 'html_url': 'https://github.com/nholden', 'followers_url': 'https://api.github.com/users/nholden/followers', 'following_url': 'https://api.github.com/users/nholden/following{/other_user}', 'gists_url': 'https://api.github.com/users/nholden/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nholden/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nholden/subscriptions', 'organizations_url': 'https://api.github.com/users/nholden/orgs', 'repos_url': 'https://api.github.com/users/nholden/repos', 'events_url': 'https://api.github.com/users/nholden/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nholden/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-10T01:05:59Z,2023-09-10T15:42:40Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49212', 'html_url': 'https://github.com/rails/rails/pull/49212', 'diff_url': 'https://github.com/rails/rails/pull/49212.diff', 'patch_url': 'https://github.com/rails/rails/pull/49212.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because when I called `render_to_string(partial: 'foo')` in an API controller, I got back `"" ""` whether or not the partial existed.

It turns out that in API controllers, the `partial` option on `render` does nothing, so it's equivalent to calling `render` with no arguments. I learned that in API controllers, calling `render` with no arguments has the surprising response of 200 OK with a body of `"" ""`.

### Detail

This change deprecates that surprising behavior and proposes that in the future, calling `render` with no arguments in API controllers will raise an error.

### Additional information

I'm open to other approaches here! Just trying to help other developers avoid this head-scratching behavior.  

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49212/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49212/timeline,,
https://api.github.com/repos/rails/rails/issues/49198,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49198/labels{/name},https://api.github.com/repos/rails/rails/issues/49198/comments,https://api.github.com/repos/rails/rails/issues/49198/events,https://github.com/rails/rails/pull/49198,1887292161,PR_kwDNIULOWdtUQw,49198,Support custom content type matchers on ActiveStorage::Blob,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-08T09:23:59Z,2023-09-27T13:39:52Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49198', 'html_url': 'https://github.com/rails/rails/pull/49198', 'diff_url': 'https://github.com/rails/rails/pull/49198.diff', 'patch_url': 'https://github.com/rails/rails/pull/49198.patch', 'merged_at': None}","ActiveStorage::Blob has methods for checking if it's an image, video, etc. In some case we might want to override the matchers or define our own matchers, for example to check if it's a PDF.

Instead of adding new methods for every possible content type, we should make this configurable with
`Rails.application.config.active_storage.content_type_matchers`.

```ruby
Rails.application.config.active_storage.content_type_matchers[:pdf] = -> (c) { c == ""application/pdf"" }
blob = ActiveStorage::Blob.last
blob.pdf? # => true
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49198/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49198/timeline,,
https://api.github.com/repos/rails/rails/issues/49197,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49197/labels{/name},https://api.github.com/repos/rails/rails/issues/49197/comments,https://api.github.com/repos/rails/rails/issues/49197/events,https://github.com/rails/rails/issues/49197,1887289217,I_kwDNIULOcH2_gQ,49197,ActiveRecord: Incorrect preloading behavior on has_many through associations with strict_loading,"{'login': 'inkstak', 'id': 474554, 'node_id': 'MDQ6VXNlcjQ3NDU1NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/474554?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/inkstak', 'html_url': 'https://github.com/inkstak', 'followers_url': 'https://api.github.com/users/inkstak/followers', 'following_url': 'https://api.github.com/users/inkstak/following{/other_user}', 'gists_url': 'https://api.github.com/users/inkstak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/inkstak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/inkstak/subscriptions', 'organizations_url': 'https://api.github.com/users/inkstak/orgs', 'repos_url': 'https://api.github.com/users/inkstak/repos', 'events_url': 'https://api.github.com/users/inkstak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/inkstak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-08T09:22:02Z,2023-09-11T12:44:33Z,,NONE,,,,"This issue may be linked to #49084 but conditions to reproduce seems to differ a bit

### Steps to reproduce
```ruby
require 'bundler/inline'

gemfile(true) do
  source 'https://rubygems.org'

  gem 'rails', '7.0.7.2'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new($stdout)

ActiveRecord::Schema.define do
  create_table 'groups', force: :cascade
  create_table 'members', force: :cascade

  create_table 'memberships', force: :cascade do |t|
    t.integer 'group_id'
    t.integer 'member_id'
  end

  create_table 'contributions', force: :cascade do |t|
    t.integer 'member_id'
  end
end

class Group < ActiveRecord::Base
  has_many :memberships
  has_many :members, through: :memberships
end

class Member < ActiveRecord::Base
  has_many :memberships
  has_many :groups, through: :memberships
  has_many :contributions
end

class Membership < ActiveRecord::Base
  belongs_to :group
  belongs_to :member
end

class Contribution < ActiveRecord::Base
  belongs_to :member
end

class BugTest < Minitest::Test
  def test_preload
    group = Group.create!
    member = Member.create!
    member.contributions.create!
    group.members << member

    assert Group.preload(:members, members: :contributions).first.members.first.contributions.loaded?
    assert Group.strict_loading.preload(:members, members: :contributions).first.members.first.contributions.loaded?
  end
end
```
### Expected behavior

The following expressions should both preload and returns first member's contributions:

```ruby
Group.preload(:members, members: :contributions).first.members.first.contributions
=> [#<Contribution:0x0000000108dd6e00 id: 1, member_id: 1>]

Group.strict_loading.preload(:members, members: :contributions).first.members.first.contributions
=> [#<Contribution:0x0000000108dd6e00 id: 1, member_id: 1>]
```

### Actual behavior

Actually, the second one raises an exception :

```ruby
Group.strict_loading.preload(:members, members: :contributions).first.members.first.contributions
# An error occurred when inspecting the object: #<ActiveRecord::StrictLoadingViolationError: `Member` is marked for strict_loading. The Contribution association named `:contributions` cannot be lazily loaded.>
# An error occurred when running Kernel#inspect: #<ActiveRecord::StrictLoadingViolationError: `Member` is marked for strict_loading. The Contribution association named `:contributions` cannot be lazily loaded.>
# .../active_record/core.rb:242:in `strict_loading_violation!'
# .../active_record/associations/association.rb:220:in `find_target'
# .../active_record/associations/collection_association.rb:264:in `load_target'
# .../active_record/associations/collection_proxy.rb:43:in `load_target'
# .../active_record/associations/collection_proxy.rb:1101:in `inspect'
```

This seems to happen when 3 conditions are met:

* using `strict_loading`
* using a `has_many through` association
* calling twice the `through` association in `preload`

It works when preloaded associations are inverted:

```ruby
Group.strict_loading.preload({ members: :contributions }, :members).first.members.first.contributions
=> [#<Contribution:0x0000000108dd6e00 id: 1, member_id: 1>]
```


### System configuration
**Rails version**: 7.0.7.2

**Ruby version**: 3.2.1 & 3.2.2

Cannot reproduce on Rails 6.0 or 6.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/49197/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49197/timeline,,
https://api.github.com/repos/rails/rails/issues/49189,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49189/labels{/name},https://api.github.com/repos/rails/rails/issues/49189/comments,https://api.github.com/repos/rails/rails/issues/49189/events,https://github.com/rails/rails/pull/49189,1886225684,PR_kwDNIULOWczcDg,49189,Allow access to the full set of options when managing PostgreSQL extensions,"{'login': 'ccutrer', 'id': 191320, 'node_id': 'MDQ6VXNlcjE5MTMyMA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/191320?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ccutrer', 'html_url': 'https://github.com/ccutrer', 'followers_url': 'https://api.github.com/users/ccutrer/followers', 'following_url': 'https://api.github.com/users/ccutrer/following{/other_user}', 'gists_url': 'https://api.github.com/users/ccutrer/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ccutrer/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ccutrer/subscriptions', 'organizations_url': 'https://api.github.com/users/ccutrer/orgs', 'repos_url': 'https://api.github.com/users/ccutrer/repos', 'events_url': 'https://api.github.com/users/ccutrer/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ccutrer/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}]",open,False,,[],,5,2023-09-07T16:33:18Z,2023-10-01T21:31:13Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49189', 'html_url': 'https://github.com/rails/rails/pull/49189', 'diff_url': 'https://github.com/rails/rails/pull/49189.diff', 'patch_url': 'https://github.com/rails/rails/pull/49189.patch', 'merged_at': None}","### Motivation / Background

This allows a fuller feature set for managing and interacting with PostgreSQL extensions.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49189/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49189/timeline,,
https://api.github.com/repos/rails/rails/issues/49187,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49187/labels{/name},https://api.github.com/repos/rails/rails/issues/49187/comments,https://api.github.com/repos/rails/rails/issues/49187/events,https://github.com/rails/rails/pull/49187,1886052717,PR_kwDNIULOWcqMtg,49187,Add `set_constraints` and `defer_constraints` helpers for PostgreSQL,"{'login': 'ccutrer', 'id': 191320, 'node_id': 'MDQ6VXNlcjE5MTMyMA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/191320?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ccutrer', 'html_url': 'https://github.com/ccutrer', 'followers_url': 'https://api.github.com/users/ccutrer/followers', 'following_url': 'https://api.github.com/users/ccutrer/following{/other_user}', 'gists_url': 'https://api.github.com/users/ccutrer/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ccutrer/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ccutrer/subscriptions', 'organizations_url': 'https://api.github.com/users/ccutrer/orgs', 'repos_url': 'https://api.github.com/users/ccutrer/repos', 'events_url': 'https://api.github.com/users/ccutrer/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ccutrer/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-09-07T14:49:09Z,2023-09-20T08:16:22Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49187', 'html_url': 'https://github.com/rails/rails/pull/49187', 'diff_url': 'https://github.com/rails/rails/pull/49187.diff', 'patch_url': 'https://github.com/rails/rails/pull/49187.patch', 'merged_at': None}","The docs already talk about how to set up deferrable constraints, but then rely on tthe user crafting custom SQL to actually use the feature. The helpers makes it easier to handle juggling multiple specific constraints, quoting issues, and automatically resetting to immediate if desired.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49187/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49187/timeline,,
https://api.github.com/repos/rails/rails/issues/49185,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49185/labels{/name},https://api.github.com/repos/rails/rails/issues/49185/comments,https://api.github.com/repos/rails/rails/issues/49185/events,https://github.com/rails/rails/pull/49185,1885689507,PR_kwDNIULOWcWUcg,49185,Add support for index option with add_column,"{'login': 'deepakmahakale', 'id': 14993828, 'node_id': 'MDQ6VXNlcjE0OTkzODI4', 'avatar_url': 'https://avatars.githubusercontent.com/u/14993828?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/deepakmahakale', 'html_url': 'https://github.com/deepakmahakale', 'followers_url': 'https://api.github.com/users/deepakmahakale/followers', 'following_url': 'https://api.github.com/users/deepakmahakale/following{/other_user}', 'gists_url': 'https://api.github.com/users/deepakmahakale/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/deepakmahakale/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/deepakmahakale/subscriptions', 'organizations_url': 'https://api.github.com/users/deepakmahakale/orgs', 'repos_url': 'https://api.github.com/users/deepakmahakale/repos', 'events_url': 'https://api.github.com/users/deepakmahakale/events{/privacy}', 'received_events_url': 'https://api.github.com/users/deepakmahakale/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-09-07T11:18:30Z,2023-09-13T11:09:36Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49185', 'html_url': 'https://github.com/rails/rails/pull/49185', 'diff_url': 'https://github.com/rails/rails/pull/49185.diff', 'patch_url': 'https://github.com/rails/rails/pull/49185.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->
With `create_table` and `add_reference` supporting the `index` option, 
most developers assume the `index: true` should work with `add_column` as well.

```ruby
create_table :users do |t|
  t.string :email, index: { unique: true }
end
```
```ruby
add_reference(:orders, :user, index: true)
```

Which is not the case.

![Screenshot 2023-09-07 at 16 51 33](https://github.com/rails/rails/assets/14993828/3cb6e797-a987-47df-a3d3-edf03e7015e5)
_Screenshot of a discussion we had last month:_

### Detail

This pull request adds support for the `index` option on the `add_column`

**Before:**

```ruby
class AddEmailAndPhoneNumberToUsers < ActiveRecord::Migration[7.1]
  def change
    add_column :users, :email, :string
    add_column :users, :phone_number, :string

    add_index :users, :email, unique: true
    add_index :users, :phone_number
  end
end
```

**After:**

```ruby
class AddEmailAndPhoneNumberToUsers < ActiveRecord::Migration[7.1]
  def change
    add_column :users, :email, :string, index: { unique: true }
    add_column :users, :phone_number, :string, index: true
  end
end
```

```sql
                                           Table ""public.users""
    Column    |              Type              | Collation | Nullable |              Default
--------------+--------------------------------+-----------+----------+-----------------------------------
 id           | bigint                         |           | not null | nextval('users_id_seq'::regclass)
 phone        | character varying              |           |          |
 created_at   | timestamp(6) without time zone |           | not null |
 updated_at   | timestamp(6) without time zone |           | not null |
 email        | character varying              |           |          |
 phone_number | character varying              |           |          |
Indexes:
    ""users_pkey"" PRIMARY KEY, btree (id)
    ""index_users_on_email"" UNIQUE, btree (email)
    ""index_users_on_phone_number"" btree (phone_number)
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [ ] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49185/reactions', 'total_count': 7, '+1': 7, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49185/timeline,,
https://api.github.com/repos/rails/rails/issues/49181,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49181/labels{/name},https://api.github.com/repos/rails/rails/issues/49181/comments,https://api.github.com/repos/rails/rails/issues/49181/events,https://github.com/rails/rails/pull/49181,1884774291,PR_kwDNIULOWbk-iQ,49181,Expose Active Storage service names,"{'login': 'bdewater', 'id': 496367, 'node_id': 'MDQ6VXNlcjQ5NjM2Nw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/496367?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bdewater', 'html_url': 'https://github.com/bdewater', 'followers_url': 'https://api.github.com/users/bdewater/followers', 'following_url': 'https://api.github.com/users/bdewater/following{/other_user}', 'gists_url': 'https://api.github.com/users/bdewater/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bdewater/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bdewater/subscriptions', 'organizations_url': 'https://api.github.com/users/bdewater/orgs', 'repos_url': 'https://api.github.com/users/bdewater/repos', 'events_url': 'https://api.github.com/users/bdewater/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bdewater/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-06T21:24:20Z,2023-09-06T21:44:15Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49181', 'html_url': 'https://github.com/rails/rails/pull/49181', 'diff_url': 'https://github.com/rails/rails/pull/49181.diff', 'patch_url': 'https://github.com/rails/rails/pull/49181.patch', 'merged_at': None}","This is useful to configure multiple disk services for parallel testing without having to resort to something like `ActiveStorage::Blob.services.send(:configurations).keys` to get this information.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49181/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49181/timeline,,
https://api.github.com/repos/rails/rails/issues/49168,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49168/labels{/name},https://api.github.com/repos/rails/rails/issues/49168/comments,https://api.github.com/repos/rails/rails/issues/49168/events,https://github.com/rails/rails/pull/49168,1883995291,PR_kwDNIULOWa6d4w,49168,Record ping on every actioncable message,"{'login': 'yauhenininjia', 'id': 13851881, 'node_id': 'MDQ6VXNlcjEzODUxODgx', 'avatar_url': 'https://avatars.githubusercontent.com/u/13851881?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/yauhenininjia', 'html_url': 'https://github.com/yauhenininjia', 'followers_url': 'https://api.github.com/users/yauhenininjia/followers', 'following_url': 'https://api.github.com/users/yauhenininjia/following{/other_user}', 'gists_url': 'https://api.github.com/users/yauhenininjia/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/yauhenininjia/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/yauhenininjia/subscriptions', 'organizations_url': 'https://api.github.com/users/yauhenininjia/orgs', 'repos_url': 'https://api.github.com/users/yauhenininjia/repos', 'events_url': 'https://api.github.com/users/yauhenininjia/events{/privacy}', 'received_events_url': 'https://api.github.com/users/yauhenininjia/received_events', 'type': 'User', 'site_admin': False}","[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-06T13:14:51Z,2023-09-07T07:38:39Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49168', 'html_url': 'https://github.com/rails/rails/pull/49168', 'diff_url': 'https://github.com/rails/rails/pull/49168.diff', 'patch_url': 'https://github.com/rails/rails/pull/49168.patch', 'merged_at': None}","### Motivation / Background

This PR is a fix for this issue described and closed due to inactivity here https://github.com/rails/rails/issues/42336
It still happens in apps with rails 7.0.7.2, ruby 3.2.2 and @rails/actioncable 7.0.4: when large number of events is sent via actioncable (in our case they are turbo broadcast messages) it prevents ping messages from coming in time (currently ping threshold is 6 seconds), so actioncable assumes connection as stale and creates a new one. However, during a downtime between closing/opening connections events could (and are) miss(ed).

In this PR pings are also recorded on every normal message coming to the client.

### Expected behavior

Connection does not become stale and does not get reconnected when ping messages are delayed due to large number of normal messages.

### Actual behavior

The client is disconnected if it doesn't receive ping events within the staleThreshold even though it's receiving other events.","{'url': 'https://api.github.com/repos/rails/rails/issues/49168/reactions', 'total_count': 2, '+1': 1, '-1': 1, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49168/timeline,,
https://api.github.com/repos/rails/rails/issues/49160,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49160/labels{/name},https://api.github.com/repos/rails/rails/issues/49160/comments,https://api.github.com/repos/rails/rails/issues/49160/events,https://github.com/rails/rails/pull/49160,1882537506,PR_kwDNIULOWZq0Kw,49160,Add an error when saving a record that was previously destroyed,"{'login': 'arielj', 'id': 188464, 'node_id': 'MDQ6VXNlcjE4ODQ2NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/188464?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/arielj', 'html_url': 'https://github.com/arielj', 'followers_url': 'https://api.github.com/users/arielj/followers', 'following_url': 'https://api.github.com/users/arielj/following{/other_user}', 'gists_url': 'https://api.github.com/users/arielj/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/arielj/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/arielj/subscriptions', 'organizations_url': 'https://api.github.com/users/arielj/orgs', 'repos_url': 'https://api.github.com/users/arielj/repos', 'events_url': 'https://api.github.com/users/arielj/events{/privacy}', 'received_events_url': 'https://api.github.com/users/arielj/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,1,2023-09-05T18:40:38Z,2023-09-23T04:15:11Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49160', 'html_url': 'https://github.com/rails/rails/pull/49160', 'diff_url': 'https://github.com/rails/rails/pull/49160.diff', 'patch_url': 'https://github.com/rails/rails/pull/49160.patch', 'merged_at': None}","### Motivation / Background

Currently, if we call `save` or `save!` in an object that was already destroyed, `save` returns `false` and `save!` raises an exception, but there's no information about why the save failed.

I ran into this issue with a legacy app that, because of a complicated set of callbacks, was destroying an object at some point and then calling `save!` somewhere else. This produced an exception, but there was no information about the reason.

After a lot of research I realized that the issue was the record was destroyed (so `.destroyed?` was `true`), but I think it will help a lot to have an error added to avoid having to find this out.

### Detail

This PR updates the `create_or_update` method to add a `:base` error message for this specific scenario.

I added a configuration for this to keep the old behavior if needed and during upgrades, since I imagine some apps may rely on the errors hash being empty.

### Additional information

No additional information.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49160/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49160/timeline,,
https://api.github.com/repos/rails/rails/issues/49147,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49147/labels{/name},https://api.github.com/repos/rails/rails/issues/49147/comments,https://api.github.com/repos/rails/rails/issues/49147/events,https://github.com/rails/rails/issues/49147,1881633849,I_kwDNIULOcCd0OQ,49147,ActiveRecord#define_attribute_methods should be called on deserialization from cache,"{'login': 'such', 'id': 1303925, 'node_id': 'MDQ6VXNlcjEzMDM5MjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1303925?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/such', 'html_url': 'https://github.com/such', 'followers_url': 'https://api.github.com/users/such/followers', 'following_url': 'https://api.github.com/users/such/following{/other_user}', 'gists_url': 'https://api.github.com/users/such/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/such/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/such/subscriptions', 'organizations_url': 'https://api.github.com/users/such/orgs', 'repos_url': 'https://api.github.com/users/such/repos', 'events_url': 'https://api.github.com/users/such/events{/privacy}', 'received_events_url': 'https://api.github.com/users/such/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2023-09-05T09:59:49Z,2023-09-06T15:22:27Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""


gemfile(true) do
  source ""https://rubygems.org""

  gem 'rails', github: 'rails/rails'
  gem 'sqlite3'
  gem 'test-unit'
end

require 'rails'
require 'active_record'
require 'logger'
require 'test/unit/assertions'

include Test::Unit::Assertions

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new($stdout)

ActiveRecord::Schema.define do
  create_table 'posts' do |t|
    t.string 'title'
  end
end

class Post < ActiveRecord::Base
  def title
    super.upcase
  end
end

Rails.cache = ActiveSupport::Cache::MemoryStore.new

post = Post.create!(title: 'Bug')
assert_equal 'BUG', post.title

Rails.cache.write('post', post)
post = Rails.cache.read('post')
assert_equal 'BUG', post.title

Post.reset_column_information
post = Post.find_by(title: 'Bug')
assert_equal 'BUG', post.title

Post.reset_column_information
post = Rails.cache.read('post')
assert_equal 'BUG', post.title
```

### Expected behavior
`post.title` should return `BUG` on the last line of code

It's failing because the `title` method has not been defined on Post. This. is usually done through `define_attribute_methods` the first time an ActiveRecord model is initialized or loaded from the DB.

### Actual behavior
<!-- Tell us what happens instead -->
```
/ruby-3.2.2/bundler/gems/rails-a10e7a9dc52d/activemodel/lib/active_model/attribute_methods.rb:481:in `method_missing': 
super: no superclass method `title' for #<Post id: 1, title: ""Bug""> (NoMethodError)
```
### System configuration
**Rails version**: `main`

**Ruby version**: `3.2.2`
","{'url': 'https://api.github.com/repos/rails/rails/issues/49147/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49147/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/49124,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49124/labels{/name},https://api.github.com/repos/rails/rails/issues/49124/comments,https://api.github.com/repos/rails/rails/issues/49124/events,https://github.com/rails/rails/pull/49124,1878786545,PR_kwDNIULOWWi7tw,49124,Feat: control active storage service urls caching,"{'login': 'civilcoder55', 'id': 58332033, 'node_id': 'MDQ6VXNlcjU4MzMyMDMz', 'avatar_url': 'https://avatars.githubusercontent.com/u/58332033?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/civilcoder55', 'html_url': 'https://github.com/civilcoder55', 'followers_url': 'https://api.github.com/users/civilcoder55/followers', 'following_url': 'https://api.github.com/users/civilcoder55/following{/other_user}', 'gists_url': 'https://api.github.com/users/civilcoder55/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/civilcoder55/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/civilcoder55/subscriptions', 'organizations_url': 'https://api.github.com/users/civilcoder55/orgs', 'repos_url': 'https://api.github.com/users/civilcoder55/repos', 'events_url': 'https://api.github.com/users/civilcoder55/events{/privacy}', 'received_events_url': 'https://api.github.com/users/civilcoder55/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2023-09-02T17:54:03Z,2023-09-02T17:59:44Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49124', 'html_url': 'https://github.com/rails/rails/pull/49124', 'diff_url': 'https://github.com/rails/rails/pull/49124.diff', 'patch_url': 'https://github.com/rails/rails/pull/49124.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because some browsers have a bug and didn't respect the cache max-age and never invalidate the cached URLs even if service_urls_expire_in is set to zero. Hence, I had to override the redirect controller and disable the cache.

This PR makes it easy to toggle caching without override and 

### Detail

- Active storage by default allows caching service URLs in browsers by adding cache-control max-age = `service_urls_expire_in` value
- This PR adds the ability to control caching by decoupling it from service_urls_expire_in.
- Adds a new boolean active storage config `cache_service_urls` equal to true by default 
- If it is set to false It will set `cache-control` to `no-store` 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49124/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49124/timeline,,
https://api.github.com/repos/rails/rails/issues/49115,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49115/labels{/name},https://api.github.com/repos/rails/rails/issues/49115/comments,https://api.github.com/repos/rails/rails/issues/49115/events,https://github.com/rails/rails/pull/49115,1878054243,PR_kwDNIULOWV9yzg,49115,"Add option validation to HABTM, closes #48939","{'login': 'smathy', 'id': 50139, 'node_id': 'MDQ6VXNlcjUwMTM5', 'avatar_url': 'https://avatars.githubusercontent.com/u/50139?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/smathy', 'html_url': 'https://github.com/smathy', 'followers_url': 'https://api.github.com/users/smathy/followers', 'following_url': 'https://api.github.com/users/smathy/following{/other_user}', 'gists_url': 'https://api.github.com/users/smathy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/smathy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/smathy/subscriptions', 'organizations_url': 'https://api.github.com/users/smathy/orgs', 'repos_url': 'https://api.github.com/users/smathy/repos', 'events_url': 'https://api.github.com/users/smathy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/smathy/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-09-01T21:17:02Z,2023-09-18T18:22:50Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49115', 'html_url': 'https://github.com/rails/rails/pull/49115', 'diff_url': 'https://github.com/rails/rails/pull/49115.diff', 'patch_url': 'https://github.com/rails/rails/pull/49115.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because it's annoying that HABTM doesn't alert you when you supply the wrong options.

### Detail

This Pull Request changes HABTM so it works like the other associations and raises `ArgumentError` when you supply options that it doesn't handle.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

Fixes #48939
","{'url': 'https://api.github.com/repos/rails/rails/issues/49115/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49115/timeline,,
https://api.github.com/repos/rails/rails/issues/49104,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49104/labels{/name},https://api.github.com/repos/rails/rails/issues/49104/comments,https://api.github.com/repos/rails/rails/issues/49104/events,https://github.com/rails/rails/issues/49104,1877473292,I_kwDNIULOb-f4DA,49104,ActiveStorage Javascript: Error parameter passed to the DirectUpload create callback should provide response status code and body,"{'login': 'alexandergitter', 'id': 816758, 'node_id': 'MDQ6VXNlcjgxNjc1OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/816758?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/alexandergitter', 'html_url': 'https://github.com/alexandergitter', 'followers_url': 'https://api.github.com/users/alexandergitter/followers', 'following_url': 'https://api.github.com/users/alexandergitter/following{/other_user}', 'gists_url': 'https://api.github.com/users/alexandergitter/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/alexandergitter/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/alexandergitter/subscriptions', 'organizations_url': 'https://api.github.com/users/alexandergitter/orgs', 'repos_url': 'https://api.github.com/users/alexandergitter/repos', 'events_url': 'https://api.github.com/users/alexandergitter/events{/privacy}', 'received_events_url': 'https://api.github.com/users/alexandergitter/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,3,2023-09-01T13:54:40Z,2023-09-02T17:06:02Z,,NONE,,,,"My example below implements a custom direct uploads controller (for authentication) and uses the Javascript class `DirectUpload` in the frontend code. It mostly follows the example code given in https://edgeguides.rubyonrails.org/active_storage_overview.html#integrating-with-libraries-or-frameworks

This issue is about the Javascript code, specifically the callback passed to the `create` method in `DirectUpload`. In the unauthenticated case, where the server responds with status code 401 (and potentially a JSON document body containing some extra information), the `error` parameter currently is just a simple string.

### Steps to reproduce
The Rails controller (backend):
```ruby
class DirectUploadsController < ActiveStorage::DirectUploadsController
  skip_forgery_protection
  before_action :authenticate!

  def authenticate!
    @token = request.headers['Authorization']&.split&.last

    return head :unauthorized unless @token == ""secret""
  end
end
```

The Javascript frontend code:
```javascript
import { DirectUpload } from ""@rails/activestorage""

const file = new File([], ""test.txt"")

const upload = new DirectUpload(file, ""/custom_direct_uploads"")
upload.create((error, blob) => console.log(error))
```

### Expected behavior
The `error` parameter passed to the callback should hold some structured information about the failed direct upload request - the response's status code and probably the body (most likely a JSON document).

### Actual behavior
The `error` parameter is a plain string: `Error creating Blob for ""test.txt"". Status: 401`.

### System configuration
**Rails version**:
7.0.7.2

**Ruby version**:
3.2.2","{'url': 'https://api.github.com/repos/rails/rails/issues/49104/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49104/timeline,,
https://api.github.com/repos/rails/rails/issues/49098,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49098/labels{/name},https://api.github.com/repos/rails/rails/issues/49098/comments,https://api.github.com/repos/rails/rails/issues/49098/events,https://github.com/rails/rails/issues/49098,1876081262,I_kwDNIULOb9K6bg,49098,"ActiveStorage::Attachment Forcefully Sets touch: true, Causing after_update Callbacks to Trigger Twice","{'login': 'rapito', 'id': 1380104, 'node_id': 'MDQ6VXNlcjEzODAxMDQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1380104?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rapito', 'html_url': 'https://github.com/rapito', 'followers_url': 'https://api.github.com/users/rapito/followers', 'following_url': 'https://api.github.com/users/rapito/following{/other_user}', 'gists_url': 'https://api.github.com/users/rapito/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rapito/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rapito/subscriptions', 'organizations_url': 'https://api.github.com/users/rapito/orgs', 'repos_url': 'https://api.github.com/users/rapito/repos', 'events_url': 'https://api.github.com/users/rapito/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rapito/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,3,2023-08-31T18:34:24Z,2023-09-18T05:04:46Z,,NONE,,,,"When using `ActiveStorage::Attachment`, I noticed that it forcefully sets `touch: true` to the parent record whenever it's saved. This behavior leads to `after_update` callbacks on the parent record being invoked twice. In use cases where versioning (e.g., with the PaperTrail gem) is employed, this results in two versions being created instead of just one.

### Steps to reproduce:

1. Create a model with an ActiveStorage attachment and an `after_update` callback.
2. Integrate versioning with PaperTrail gem.
3. Upload an attachment to the model and save.
4. Observe that two versions are created in PaperTrail instead of one.

or

1. Create a model with an ActiveStorage attachment and an after_update callback.
2. Attach a file to the model instance and save.
3. Observe that the operation within the after_update callback is triggered twice.

### Expected behavior:

Only one version should be created in PaperTrail when an attachment is added or updated.

### Actual behavior:

Two versions are being created in PaperTrail due to the `after_update` callback being triggered twice.

### System configuration:

**Rails version:** 7.0.5
**Ruby version:** 3.0.5

### Possible solutions:

1. Make the `touch: true` behavior configurable for ActiveStorage::Attachment.
2. Do not set `touch: true` by default and allow developers to opt-in if needed.

### Additional notes:

This behavior can potentially lead to other unintended side effects when combined with other gems or custom logic that relies on after_update callbacks. It would be beneficial for developers to have more control over this behavior.

i.e.: Imagine I have an after_update that runs or schedules a long-running process, this will be triggered twice just because the attachment is touched the record.

Furthermore, I've seen workarounds such as wrapping the code with no_touching, but I find this to be somewhat unpractical and bloats the code. 
Some codebases are large enough that doing this would require a considerable amount of refactoring just to attach a file.
```rb
SomeClass.no_touching do
  some_object.attachment.attach(attachable)
end
```","{'url': 'https://api.github.com/repos/rails/rails/issues/49098/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49098/timeline,,
https://api.github.com/repos/rails/rails/issues/49084,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49084/labels{/name},https://api.github.com/repos/rails/rails/issues/49084/comments,https://api.github.com/repos/rails/rails/issues/49084/events,https://github.com/rails/rails/issues/49084,1873520233,I_kwDNIULOb6umaQ,49084,ActiveRecord: incorrect Preloader behavior on has_many through associations when through association is preloaded,"{'login': 'kshnurov', 'id': 498185, 'node_id': 'MDQ6VXNlcjQ5ODE4NQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/498185?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kshnurov', 'html_url': 'https://github.com/kshnurov', 'followers_url': 'https://api.github.com/users/kshnurov/followers', 'following_url': 'https://api.github.com/users/kshnurov/following{/other_user}', 'gists_url': 'https://api.github.com/users/kshnurov/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kshnurov/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kshnurov/subscriptions', 'organizations_url': 'https://api.github.com/users/kshnurov/orgs', 'repos_url': 'https://api.github.com/users/kshnurov/repos', 'events_url': 'https://api.github.com/users/kshnurov/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kshnurov/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-08-30T11:53:38Z,2023-09-08T09:22:55Z,,NONE,,,,"### Steps to reproduce
```ruby
# frozen_string_literal: true

require 'bundler/inline'

gemfile(true) do
  source 'https://rubygems.org'

  gem 'rails', '7.0.7.2'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new($stdout)

ActiveRecord::Schema.define do
  create_table 'companies', force: :cascade, &:timestamps

  create_table 'announcements', force: :cascade, &:timestamps

  create_table 'announcement_references', force: :cascade do |t|
    t.integer 'announcement_id'
    t.integer 'owner_id'
    t.string 'owner_type'
  end

  create_table 'taxonomy_references', force: :cascade do |t|
    t.integer 'company_id'
    t.integer 'taxonomy_id'
    t.string 'taxonomy_type'
  end

  create_table 'categories', force: :cascade do |t|
    t.string 'name'
  end

  create_table 'groups', force: :cascade do |t|
    t.string 'name'
  end
end

class Company < ActiveRecord::Base
  has_many :taxonomy_references, dependent: :destroy
  has_many :group_references, -> { where(taxonomy_type: 'Group') }, class_name: 'TaxonomyReference', foreign_key: :company_id
  has_many :groups, through: :group_references, source: :taxonomy, source_type: 'Group'
  has_many :category_references, -> { where(taxonomy_type: 'Category') }, class_name: 'TaxonomyReference', foreign_key: :company_id
  has_many :categories, through: :category_references, source: :taxonomy, source_type: 'Category'

  has_many :announcement_references, foreign_key: :owner_id, as: :owner, inverse_of: :owner, dependent: :restrict_with_error
  has_many :announcements, through: :announcement_references, source: :announcement, dependent: :restrict_with_error
  has_many :announcements_from_groups, class_name: 'Announcement', through: :groups, source: :announcements
end

class TaxonomyReference < ActiveRecord::Base
  belongs_to :taxonomy, optional: false, polymorphic: true
  belongs_to :company, optional: false
end

class Category < ActiveRecord::Base
  has_many :taxonomy_references, as: :taxonomy, foreign_key: :taxonomy_id, dependent: :destroy
  has_many :companies, through: :taxonomy_references, source: :company
end

class Group < ActiveRecord::Base
  has_many :taxonomy_references, as: :taxonomy, foreign_key: :taxonomy_id, dependent: :destroy
  has_many :companies, through: :taxonomy_references, source: :company

  has_many :announcement_references, foreign_key: :owner_id, as: :owner, inverse_of: :owner, dependent: :restrict_with_error
  has_many :announcements, through: :announcement_references, source: :announcement, dependent: :restrict_with_error
end

class Announcement < ActiveRecord::Base
  has_many :announcement_references, foreign_key: :announcement_id, inverse_of: :announcement, dependent: :destroy

  has_many :companies, through: :announcement_references, source_type: 'Company', source: :owner
  has_many :groups, through: :announcement_references, source_type: 'Group', source: :owner
  has_many :companies_in_groups, through: :groups, source: :companies
end

class AnnouncementReference < ActiveRecord::Base
  belongs_to :announcement, optional: false, foreign_key: :announcement_id
  belongs_to :owner, optional: false, polymorphic: true
end

class BugTest < Minitest::Test
  def test_preload
    company = Company.create!
    group = Group.create!
    category = Category.create!
    company.categories << category
    company.groups << group
    group_announcement = Announcement.create!
    group_announcement.announcement_references.create(owner_type: 'Group', owner_id: group.id)
    company_announcement = Announcement.create!
    company_announcement.announcement_references.create(owner_type: 'Company', owner_id: company.id)

    assert_equal 1, company.groups.size
    assert_equal 1, company.categories.size
    assert_equal 1, group.announcements.size
    assert_equal 1, company.announcements.size
    assert_equal 1, company.announcements_from_groups.size

    assert_equal group_announcement, Announcement.preload(:companies => :categories).first # works
    assert_equal company_announcement, Announcement.preload(:companies => :categories).last # works
    assert_equal company_announcement, Announcement.preload(:announcement_references, :companies => :categories).last # works
    assert_equal group_announcement, Announcement.preload(:announcement_references, :companies, :companies => :categories).first # works!
    assert_equal group_announcement, Announcement.preload(:announcement_references, :companies => :categories).first # fails
  end
end
```

### Expected behavior
Should preload `companies => categories` only if there are `companies` as owners

### Actual behavior
Tries to preload `categories` on `Group`
```
ActiveRecord::AssociationNotFoundError: Association named 'categories' was not found on Group; perhaps you misspelled it?
```

### System configuration
**Rails version**: 7.0.7.2
**Ruby version**: 3.1.4
","{'url': 'https://api.github.com/repos/rails/rails/issues/49084/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49084/timeline,,
https://api.github.com/repos/rails/rails/issues/49079,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49079/labels{/name},https://api.github.com/repos/rails/rails/issues/49079/comments,https://api.github.com/repos/rails/rails/issues/49079/events,https://github.com/rails/rails/pull/49079,1872047860,PR_kwDNIULOWQ42VA,49079,Makes sure values have the correct type in _update_record. Fixes #49009.,"{'login': 'paulreece', 'id': 96156234, 'node_id': 'U_kgDOBbs6Sg', 'avatar_url': 'https://avatars.githubusercontent.com/u/96156234?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/paulreece', 'html_url': 'https://github.com/paulreece', 'followers_url': 'https://api.github.com/users/paulreece/followers', 'following_url': 'https://api.github.com/users/paulreece/following{/other_user}', 'gists_url': 'https://api.github.com/users/paulreece/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/paulreece/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/paulreece/subscriptions', 'organizations_url': 'https://api.github.com/users/paulreece/orgs', 'repos_url': 'https://api.github.com/users/paulreece/repos', 'events_url': 'https://api.github.com/users/paulreece/events{/privacy}', 'received_events_url': 'https://api.github.com/users/paulreece/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-08-29T16:47:38Z,2023-09-24T23:51:35Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49079', 'html_url': 'https://github.com/rails/rails/pull/49079', 'diff_url': 'https://github.com/rails/rails/pull/49079.diff', 'patch_url': 'https://github.com/rails/rails/pull/49079.patch', 'merged_at': None}","By transforming the values hash and adding in the type from the table it's being added to it ensures that the correct Type is used for the table.  This enables a user to make sure the specified type is used if one is set in the model. 

Fixes #[49009](https://github.com/rails/rails/issues/49009).
### Checklist

Before submitting the PR make sure the following are checked:

* [ X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ X] Tests are added or updated if you fix a bug or add a feature.
* [ X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49079/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/49079/timeline,,
https://api.github.com/repos/rails/rails/issues/49070,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49070/labels{/name},https://api.github.com/repos/rails/rails/issues/49070/comments,https://api.github.com/repos/rails/rails/issues/49070/events,https://github.com/rails/rails/issues/49070,1870537426,I_kwDNIULOb34i0g,49070,Through associations aren't populated for non-persisted records in a `belongs_to` cascade,"{'login': 'Slotos', 'id': 314453, 'node_id': 'MDQ6VXNlcjMxNDQ1Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/314453?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Slotos', 'html_url': 'https://github.com/Slotos', 'followers_url': 'https://api.github.com/users/Slotos/followers', 'following_url': 'https://api.github.com/users/Slotos/following{/other_user}', 'gists_url': 'https://api.github.com/users/Slotos/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Slotos/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Slotos/subscriptions', 'organizations_url': 'https://api.github.com/users/Slotos/orgs', 'repos_url': 'https://api.github.com/users/Slotos/repos', 'events_url': 'https://api.github.com/users/Slotos/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Slotos/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-28T21:30:45Z,2023-09-11T12:47:21Z,,NONE,,,,"### Steps to reproduce

Through associations are not populated correctly for non-persisted records in a belongs_to cascade, breaking cases where one model behaves as an autosave root for an associated tree, especially when it needs to run validations on far leaves in a Law of Demeter abiding setup.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :mesopotamians, force: true do |t|
    t.boolean :active, null: false, default: false
  end

  create_table :parchments, force: true do |t|
    t.references :mesopotamian, null: false, foreign_key: true
  end

  create_table :cuneiforms, force: true do |t|
    t.references :parchment, null: false, foreign_key: true
  end
end

class Mesopotamian < ActiveRecord::Base
  has_many :parchments, inverse_of: ""mesopotamian""
  has_many :cuneiforms, through: :parchments, inverse_of: ""mesopotamian""
end

class Parchment < ActiveRecord::Base
  belongs_to :mesopotamian, optional: false, autosave: true, inverse_of: ""parchments""
  has_many :cuneiforms, inverse_of: ""parchment""
end

class Cuneiform < ActiveRecord::Base
  belongs_to :parchment, optional: false, autosave: true, inverse_of: ""cuneiforms""
  has_one :mesopotamian, through: :parchment, inverse_of: ""cuneiforms""

  validate :mesopotamian_is_active

  def mesopotamian_is_active
    errors.add(:mesopotamian, ""Inactive ancestors cannot contribute"") unless mesopotamian&.active?
  end
end

class BugTest < Minitest::Test
  def test_has_one_through_on_new_records
    mesopotamian = Mesopotamian.new(active: true)
    parchment =  Parchment.new(mesopotamian:)
    cuneiform = Cuneiform.new(parchment:)

    assert cuneiform.save
    assert mesopotamian.persisted?
  end

  def test_has_one_through_on_new_cuneiform_for_existing_mesopotamian
    mesopotamian = Mesopotamian.create!(active: true)
    parchment =  Parchment.new(mesopotamian:)
    cuneiform = Cuneiform.new(parchment:)

    assert cuneiform.save
    assert mesopotamian.persisted?
  end

  def test_works_fine_on_persisted_intermediate
    mesopotamian = Mesopotamian.new(active: true)
    parchment =  Parchment.create!(mesopotamian:)
    cuneiform = Cuneiform.new(parchment:)

    assert cuneiform.save
    assert mesopotamian.persisted?
  end
end
```

### Expected behavior

`Cuneiform.new(parchment: Parchment.new(mesopotamian: Mesopotamian.new(active: true))).save` is able to correctly validate `mesopotamian.active` flag and proceed to saving the record

### Actual behavior

`mesopotamian` association is always evaluated to `nil` if `parchment` association is not persisted.

### System configuration

**Rails version**: 7.0.7.2

**Ruby version**: 3.1.4p223

### Notes

I'd be the first one to admit that the example provided is dubious in design terms and there are multiple alternative implementations with the same DB schema that wouldn't exhibit this issue. However, I'm working with an existing code where I need a similarly shaped association tree with a set of existing behaviours to behave well while I'm refactoring it.

Most importantly, I believe the association chain is clear, honest, and descriptive, which adds to the surprise factor of the issue.","{'url': 'https://api.github.com/repos/rails/rails/issues/49070/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49070/timeline,,
https://api.github.com/repos/rails/rails/issues/49052,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49052/labels{/name},https://api.github.com/repos/rails/rails/issues/49052/comments,https://api.github.com/repos/rails/rails/issues/49052/events,https://github.com/rails/rails/issues/49052,1868661732,I_kwDNIULOb2GD5A,49052,Active Record shard resolver's return value is not respected in Action Cable channel functions (websocket communication),"{'login': 'pospieszynski', 'id': 15077823, 'node_id': 'MDQ6VXNlcjE1MDc3ODIz', 'avatar_url': 'https://avatars.githubusercontent.com/u/15077823?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pospieszynski', 'html_url': 'https://github.com/pospieszynski', 'followers_url': 'https://api.github.com/users/pospieszynski/followers', 'following_url': 'https://api.github.com/users/pospieszynski/following{/other_user}', 'gists_url': 'https://api.github.com/users/pospieszynski/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pospieszynski/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pospieszynski/subscriptions', 'organizations_url': 'https://api.github.com/users/pospieszynski/orgs', 'repos_url': 'https://api.github.com/users/pospieszynski/repos', 'events_url': 'https://api.github.com/users/pospieszynski/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pospieszynski/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,8,2023-08-27T22:55:12Z,2023-09-05T13:42:43Z,,NONE,,,,"### Steps to reproduce
1. Create a sample app with multiple db shards, let's say ""A"" & ""B"".
2. Implement abstract class X that connects to shards A & B.
3. In `application.rb` implement shard_resolver (`config.active_record.shard_resolver`) to always return ""B"".
4. Implement simple Action Cable channel.

### Expected behavior
The `X.current_shard` invoked in the Action Cable channel function i.e `subscribed` returns the value returned by the `shard_resolver` block  which is ""B"".

### Actual behavior
The `X.current_shard` returns ""default"" effectively ignoring the shard_resolver outcome.

### System configuration
**Rails version**:  7.0.7.2

**Ruby version**: 3.0.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/49052/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49052/timeline,,
https://api.github.com/repos/rails/rails/issues/49050,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49050/labels{/name},https://api.github.com/repos/rails/rails/issues/49050/comments,https://api.github.com/repos/rails/rails/issues/49050/events,https://github.com/rails/rails/pull/49050,1868525353,PR_kwDNIULOWN6wew,49050,[Fix #48535]: fix behavior of `proc_for_binds` in `Arel::Nodes::HomogenousIn`,"{'login': 'JohnAnon9771', 'id': 42195321, 'node_id': 'MDQ6VXNlcjQyMTk1MzIx', 'avatar_url': 'https://avatars.githubusercontent.com/u/42195321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JohnAnon9771', 'html_url': 'https://github.com/JohnAnon9771', 'followers_url': 'https://api.github.com/users/JohnAnon9771/followers', 'following_url': 'https://api.github.com/users/JohnAnon9771/following{/other_user}', 'gists_url': 'https://api.github.com/users/JohnAnon9771/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JohnAnon9771/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JohnAnon9771/subscriptions', 'organizations_url': 'https://api.github.com/users/JohnAnon9771/orgs', 'repos_url': 'https://api.github.com/users/JohnAnon9771/repos', 'events_url': 'https://api.github.com/users/JohnAnon9771/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JohnAnon9771/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-27T14:57:07Z,2023-09-27T00:24:33Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49050', 'html_url': 'https://github.com/rails/rails/pull/49050', 'diff_url': 'https://github.com/rails/rails/pull/49050.diff', 'patch_url': 'https://github.com/rails/rails/pull/49050.patch', 'merged_at': None}","### Motivation / Background
This PR addresses the issues #48535 and #48072.

With the introduction of PR #41068, an unintended behavior surfaced, causing the `proc_for_binds` to apply casting to attributes that were already casted. Consequently, this led to the malfunctioning of queries, as noted in the referenced issues.

My proposed solution revolves around the incorporation of a new attribute ""type"" named `BindAttribute`. This type facilitates the desired functionality within the `proc_for_binds` implementation, while abstaining from unnecessary casting, given that the values are already casted. This correction has obviated the need for changes such as ""Fix deterministic queries that were broken after #41068,"" as detailed in [this commit](https://github.com/wbotelhos/rails/commit/37361bfb4222c5d210f11e48ecee46b05ea7d50e). These changes had inadvertently caused the tests initially intended for `proc_for_binds` within `HomogeneousIn` to erroneously evaluate the `proc_for_binds` within `InWithAdditionalValues`. This resulted in false positives whenever adjustments were made to the `proc_for_binds` within `HomogeneousIn`.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49050/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 2, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49050/timeline,,
https://api.github.com/repos/rails/rails/issues/49049,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49049/labels{/name},https://api.github.com/repos/rails/rails/issues/49049/comments,https://api.github.com/repos/rails/rails/issues/49049/events,https://github.com/rails/rails/pull/49049,1868320178,PR_kwDNIULOWNw6aA,49049,fixes issue where rails console filters lines that match 'APP_DIRS_PATTERN' because they are prefixed with 'from',"{'login': 'josh-m-sharpe', 'id': 39473, 'node_id': 'MDQ6VXNlcjM5NDcz', 'avatar_url': 'https://avatars.githubusercontent.com/u/39473?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/josh-m-sharpe', 'html_url': 'https://github.com/josh-m-sharpe', 'followers_url': 'https://api.github.com/users/josh-m-sharpe/followers', 'following_url': 'https://api.github.com/users/josh-m-sharpe/following{/other_user}', 'gists_url': 'https://api.github.com/users/josh-m-sharpe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/josh-m-sharpe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/josh-m-sharpe/subscriptions', 'organizations_url': 'https://api.github.com/users/josh-m-sharpe/orgs', 'repos_url': 'https://api.github.com/users/josh-m-sharpe/repos', 'events_url': 'https://api.github.com/users/josh-m-sharpe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/josh-m-sharpe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,4,2023-08-27T01:29:32Z,2023-09-13T19:51:11Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49049', 'html_url': 'https://github.com/rails/rails/pull/49049', 'diff_url': 'https://github.com/rails/rails/pull/49049.diff', 'patch_url': 'https://github.com/rails/rails/pull/49049.patch', 'merged_at': None}","### Motivation / Background
I noticed and confirmed with others that rails console was omitting expected backtrace lines as seen here:
```
$ cat app/models/user.rb
class User < ApplicationRecord

  def foo
    bar
  end

  def bar
    baz
  end

  def baz
    raise
  end
end

$  rc
Loading development environment (Rails 7.0.7)
3.1.4 :001 > User.new.foo
/Users/jsharpe/railsapp/app/models/user.rb:12:in `baz': unhandled exception
(irb):1:in `<main>
```

I believe this is caused by irb itself prefixing backtrace lines with the string: `\tfrom ` as seen here:
```
 (9:21:40 PM) ~ irb
3.0.4 :001 > class Foo
3.0.4 :002 > def foo
3.0.4 :003 > bar
3.0.4 :004 > end
3.0.4 :005 > def bar
3.0.4 :006 > baz
3.0.4 :007 > end
3.0.4 :008 > def baz
3.0.4 :009 > raise
3.0.4 :010 > end
3.0.4 :011 > end
 => :baz
3.0.4 :012 >
3.0.4 :013 > Foo.new.foo
(irb):9:in `baz': unhandled exception
	from (irb):6:in `bar'
	from (irb):3:in `foo'
	from (irb):13:in `<main>'
	from /Users/jsharpe/.rvm/gems/ruby-3.0.4/gems/irb-1.7.4/exe/irb:9:in `<top (required)>'
	from /Users/jsharpe/.rvm/gems/ruby-3.0.4/bin/irb:25:in `load'
	from /Users/jsharpe/.rvm/gems/ruby-3.0.4/bin/irb:25:in `<main>'
	from /Users/jsharpe/.rvm/gems/ruby-3.0.4/bin/ruby_executable_hooks:22:in `eval'
	from /Users/jsharpe/.rvm/gems/ruby-3.0.4/bin/ruby_executable_hooks:22:in `<main>'
```


This causes rails console to mistakenly filter lines that would otherwise match `Rails::BacktraceCleaner::APP_DIRS_PATTERN` because that regex hasn't anticipated the prefix.  
This patch filters `\tfrom ` if it exists which then allows the filter using `APP_DIRS_PATTERN` below to work correctly:

```
$ rc
Loading development environment (Rails 7.0.7)
3.1.4 :001 > User.new.foo
/Users/jsharpe/railsapp/app/models/user.rb:12:in `baz': unhandled exception
app/models/user.rb:8:in `bar'
app/models/user.rb:4:in `foo'
(irb):1:in `<main>'
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49049/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49049/timeline,,
https://api.github.com/repos/rails/rails/issues/49047,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49047/labels{/name},https://api.github.com/repos/rails/rails/issues/49047/comments,https://api.github.com/repos/rails/rails/issues/49047/events,https://github.com/rails/rails/pull/49047,1868295106,PR_kwDNIULOWNvxBA,49047,This allows Users to merge the actual model to an already aliased/scoped model when using the missing or associated methods. Fixes #48945. ,"{'login': 'paulreece', 'id': 96156234, 'node_id': 'U_kgDOBbs6Sg', 'avatar_url': 'https://avatars.githubusercontent.com/u/96156234?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/paulreece', 'html_url': 'https://github.com/paulreece', 'followers_url': 'https://api.github.com/users/paulreece/followers', 'following_url': 'https://api.github.com/users/paulreece/following{/other_user}', 'gists_url': 'https://api.github.com/users/paulreece/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/paulreece/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/paulreece/subscriptions', 'organizations_url': 'https://api.github.com/users/paulreece/orgs', 'repos_url': 'https://api.github.com/users/paulreece/repos', 'events_url': 'https://api.github.com/users/paulreece/events{/privacy}', 'received_events_url': 'https://api.github.com/users/paulreece/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-08-26T23:23:50Z,2023-09-01T14:56:01Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49047', 'html_url': 'https://github.com/rails/rails/pull/49047', 'diff_url': 'https://github.com/rails/rails/pull/49047.diff', 'patch_url': 'https://github.com/rails/rails/pull/49047.patch', 'merged_at': None}","Since `aliased_table_for` is called later on in the stack as to make the `missing` and `associated` methods have no awareness of aliasing taking place, I decided to make a similar data structure available within both.  By adding `@scope.table_name`, and  any `joins` `table_names` to an array, I am offering up a similar object that the `alias_tracker.aliases` hash would contain.  I used an array instead of a hash because in this case we don't need to check the values of the keys like `aliased_table_for` does.  By building this array it gives these methods an awareness of what aliasing might take place further on in the stack so that it can take the correct course of action when building the where clause.  

This adds an `alias_prediction` method which implements the behavior noted above:
```Ruby
        def alias_prediction
          alias_table_names = []
          alias_table_names.push(@scope.table_name)
          if @scope.values[:joins]
            @scope.values[:joins].each do |join|
              current_join = scope_association_reflection(join)
              alias_table_names.push(current_join.table_name)
            end
          end
          alias_table_names
        end
```

Note: The initial `reflection.options[:class_name]` check is still necessary to avoid false positives.

### Motivation / Background

This Pull Request has been created because a bug report was raised. Fixes #[48945](https://github.com/rails/rails/issues/48945).

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49047/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49047/timeline,,
https://api.github.com/repos/rails/rails/issues/49043,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49043/labels{/name},https://api.github.com/repos/rails/rails/issues/49043/comments,https://api.github.com/repos/rails/rails/issues/49043/events,https://github.com/rails/rails/pull/49043,1868184190,PR_kwDNIULOWNqj0Q,49043,Fix column typecasting with duplicate column names for PostgreSQL,"{'login': 'Flixt', 'id': 1724355, 'node_id': 'MDQ6VXNlcjE3MjQzNTU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1724355?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Flixt', 'html_url': 'https://github.com/Flixt', 'followers_url': 'https://api.github.com/users/Flixt/followers', 'following_url': 'https://api.github.com/users/Flixt/following{/other_user}', 'gists_url': 'https://api.github.com/users/Flixt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Flixt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Flixt/subscriptions', 'organizations_url': 'https://api.github.com/users/Flixt/orgs', 'repos_url': 'https://api.github.com/users/Flixt/repos', 'events_url': 'https://api.github.com/users/Flixt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Flixt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-08-26T17:30:53Z,2023-08-27T07:01:18Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49043', 'html_url': 'https://github.com/rails/rails/pull/49043', 'diff_url': 'https://github.com/rails/rails/pull/49043.diff', 'patch_url': 'https://github.com/rails/rails/pull/49043.patch', 'merged_at': None}","Fixes incorrect typecasting that occurred when there were duplicate column names returned from PostgreSQL which is always the case when calculations/aggregates are use multiple times when no aliases are used. The `column_type` method was moved from private to public, and the typecasting logic was updated.

Fixes #48946.

### Additional information

There are several other places where the `ActiveRecord::Result#column_type` is used directly, but I'm not sure if accessing the column_type via index would be correct/possible there. To me it seems these places are even incorrect since https://github.com/rails/rails/pull/45783 because the the `types`/`column_types` potentially not only contains columns by name but also by index.
- https://github.com/rails/rails/blob/f6b987d521b9ad3f9938b40f039fbdda78058a06/activerecord/lib/active_record/querying.rb#L66-L66
- https://github.com/rails/rails/blob/f6b987d521b9ad3f9938b40f039fbdda78058a06/activerecord/lib/active_record/associations/join_dependency.rb#L127-L127
- https://github.com/rails/rails/blob/f6b987d521b9ad3f9938b40f039fbdda78058a06/activerecord/lib/active_record/relation/calculations.rb#L508-L508


<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49043/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49043/timeline,,
https://api.github.com/repos/rails/rails/issues/49036,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49036/labels{/name},https://api.github.com/repos/rails/rails/issues/49036/comments,https://api.github.com/repos/rails/rails/issues/49036/events,https://github.com/rails/rails/pull/49036,1867116355,PR_kwDNIULOWMyCXw,49036,ActionText now supports storage in text column instead of separate table,"{'login': 'brunoenten', 'id': 722037, 'node_id': 'MDQ6VXNlcjcyMjAzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/722037?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/brunoenten', 'html_url': 'https://github.com/brunoenten', 'followers_url': 'https://api.github.com/users/brunoenten/followers', 'following_url': 'https://api.github.com/users/brunoenten/following{/other_user}', 'gists_url': 'https://api.github.com/users/brunoenten/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/brunoenten/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/brunoenten/subscriptions', 'organizations_url': 'https://api.github.com/users/brunoenten/orgs', 'repos_url': 'https://api.github.com/users/brunoenten/repos', 'events_url': 'https://api.github.com/users/brunoenten/events{/privacy}', 'received_events_url': 'https://api.github.com/users/brunoenten/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,4,2023-08-25T14:02:19Z,2023-08-27T13:03:00Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49036', 'html_url': 'https://github.com/rails/rails/pull/49036', 'diff_url': 'https://github.com/rails/rails/pull/49036.diff', 'patch_url': 'https://github.com/rails/rails/pull/49036.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background
ActionText uses a separate table to store HTML data. WIth advanced RDBMS like Postgres, it's not necessary as the database optimization engine will manage storage of columns with large data on its own.

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This PR introduces the possibility of using ActionText with only a 'string' column in the model table itself as storage.

### Detail

This Pull Request adds a new feature to ActionText, without any change to the existing ones. Code not explicitly choosing to use the new feature won't be affected in any way.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/49036/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49036/timeline,,
https://api.github.com/repos/rails/rails/issues/49025,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49025/labels{/name},https://api.github.com/repos/rails/rails/issues/49025/comments,https://api.github.com/repos/rails/rails/issues/49025/events,https://github.com/rails/rails/pull/49025,1864839154,PR_kwDNIULOWK1hHQ,49025,[Feature Request] Fixture scenarios for complex associations,"{'login': 'AlexB52', 'id': 7149034, 'node_id': 'MDQ6VXNlcjcxNDkwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7149034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/AlexB52', 'html_url': 'https://github.com/AlexB52', 'followers_url': 'https://api.github.com/users/AlexB52/followers', 'following_url': 'https://api.github.com/users/AlexB52/following{/other_user}', 'gists_url': 'https://api.github.com/users/AlexB52/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/AlexB52/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/AlexB52/subscriptions', 'organizations_url': 'https://api.github.com/users/AlexB52/orgs', 'repos_url': 'https://api.github.com/users/AlexB52/repos', 'events_url': 'https://api.github.com/users/AlexB52/events{/privacy}', 'received_events_url': 'https://api.github.com/users/AlexB52/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-08-24T10:13:33Z,2023-08-24T20:40:28Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/49025', 'html_url': 'https://github.com/rails/rails/pull/49025', 'diff_url': 'https://github.com/rails/rails/pull/49025.diff', 'patch_url': 'https://github.com/rails/rails/pull/49025.patch', 'merged_at': None}","# Introducing fixture scenarios

This pull request proposes a new feature: Fixture Scenarios via a new TestCase method, `#load_scenario`. This concept aims to improve test data management by introducing situational fixtures known as ""scenarios."" The primary goal is to enable the creation of manageable sets of fixtures with complex associations within a single file.

Your feedback on this proposal would be highly appreciated! :) 

## Problem Statement

The current approach to managing throwaway scenarios with fixtures has limitations. Fixtures accumulate in various files, often leading to confusion about their original intent. On-the-fly records or using FactoryBot can result in unnecessary records creation and does not adequately manage associations between records.

## Solution Overview

By grouping fixtures per scenario or purpose instead of types, fixture scenarios offer an alternative to loading sets of records for each test. They provide the following benefits:

- Utilize familiar features like ERB, `_fixture` configuration, associations, and table access.
- Manage all records' relationships within a single file, which is particularly useful for testing scenarios with complex associations.
- Load scenarios only when explicitly specified, ensuring the flexibility to use permanent fixtures when needed.

This can be useful to snapshot a set of records when reproducing a bug or a complex state without bloating the test setup with method calls that are irrelevant to the thing tested. A dev could build records manually once and snapshot their state in a scenario instead of building that state every time the test runs on a pipeline.

## Scenario Example

Here's an example of how a scenario could look:

```yml
# test/scenarios/organisation_with_author_and_posts.yml
organizations:
  _fixture:
    model_class: Organization

  code_monkeys:
    name: The code monkeys

posts:
  <% 1.upto(5) do |i| %>
  alex_post<%= i %>:
    author: alex
    title: Alex post <%= i %>
    body: Such a lovely day
    type: Post
  <% end %>

authors:
  alex:
    name: Alex
    author_address_id: 100
    organization: code_monkeys

  nsa_author:
    name: NSA Author
    author_address_id: 100
    organization: nsa

author_addresses:
  alex_address:
    id: 100

```

### Usage

```ruby
require ""test_helper""

class TestLoadScenario < ActiveRecord::TestCase
  def test_create_scenario
    load_scenario(SCENARIOS_ROOT + ""/organisation_with_author_and_posts.yml"")

    author = authors(:alex)

    assert author.author_address
    assert_equal ""The Code Monkeys"", author.organization.name
    assert_equal 5, author.posts.count
  end
end
```

## Implemented Rules

This PR is a POC with the following rules governing scenario fixtures:

* They are not loaded by default.
* They do not delete existing fixtures.
* They can reference existing fixtures.
* They can reference other existing scenario fixtures.
* They cannot override existing fixtures.
* They cannot override existing scenario fixtures.
* They allow ERB for dynamic data generation.
* They allow \_fixture configuration.
* They are accessible through table access.

## Caveats

One of the caveats is that managing records of the same type across multiple files can become challenging with schema changes unless shared defaults are established. This caveat likely applies to normal fixtures as well.

","{'url': 'https://api.github.com/repos/rails/rails/issues/49025/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/49025/timeline,,
https://api.github.com/repos/rails/rails/issues/49009,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/49009/labels{/name},https://api.github.com/repos/rails/rails/issues/49009/comments,https://api.github.com/repos/rails/rails/issues/49009/events,https://github.com/rails/rails/issues/49009,1862399866,I_kwDNIULObwH3eg,49009,AR::Base#becomes no longer handles attribute type changes,"{'login': 'mlarraz', 'id': 2575714, 'node_id': 'MDQ6VXNlcjI1NzU3MTQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575714?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mlarraz', 'html_url': 'https://github.com/mlarraz', 'followers_url': 'https://api.github.com/users/mlarraz/followers', 'following_url': 'https://api.github.com/users/mlarraz/following{/other_user}', 'gists_url': 'https://api.github.com/users/mlarraz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mlarraz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mlarraz/subscriptions', 'organizations_url': 'https://api.github.com/users/mlarraz/orgs', 'repos_url': 'https://api.github.com/users/mlarraz/repos', 'events_url': 'https://api.github.com/users/mlarraz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mlarraz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-08-23T01:14:39Z,2023-08-23T18:46:32Z,,CONTRIBUTOR,,,,"On Rails 6.1, it was possible to use `AR::Base#becomes` to handle converting one model to another with the same attribute but a different type. In the below example, two models share the same table but one stores emails in Base64. This appears to have broken in Rails 7.

### Steps to reproduce
```ruby
require ""base64""
require ""bundler/inline""

gemfile do
  gem ""activerecord"", ""~> 7.0""
  gem ""sqlite3""
end

require ""active_record""

ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')

ActiveRecord::Schema.define do
    create_table :users do |t|
      t.string :email
    end
end

class Base64String < ActiveModel::Type::Value
  def serialize(value)
    ::Base64.strict_encode64(value) unless value.nil?
  end

  def deserialize(value)
     ::Base64.strict_decode64(value) unless value.nil?
  end
end

ActiveRecord::Type.register(:base64_string, Base64String)

class User < ActiveRecord::Base
  self.primary_key = ""id""
end

class EncryptedUser < ActiveRecord::Base
  self.primary_key = ""id""
  self.table_name = ""users""

  attribute :email, :base64_string
end

user = User.create!(email: ""foo@example.com"")

encrypted_user = EncryptedUser.create!(email: ""secret@example.com"")

# The EncryptedUser's email is stored as a Base64 encoded string
User.exists?(email: ""secret@example.com"") # => false
User.exists?(email: ::Base64.strict_encode64(""secret@example.com"")) # => true

converted_user = user.becomes(EncryptedUser)
converted_user.email = ""secret2@example.com""
converted_user.save!

# When a User is converted to an EncryptedUser, their email should be stored as a Base64 encoded string
User.exists?(email: ""secret2@example.com"") # => false on Rails 6.1, true on Rails 7.0
User.exists?(email: Base64.strict_encode64(""secret2@example.com"")) # => true on Rails 6.1, false on Rails 7.0
```

### Expected behavior
Converting a `User` to an `EncryptedUser` and saving it should automatically persist the `email` attribute using the Base64String type. This was the behavior in Rails 6.1.

### Actual behavior
The custom attribute type on `EncryptedUser` is ignored and `email` is saved as plain text. 

I believe this accidentally changed with https://github.com/rails/rails/commit/6ee96a8f42d6b13bffd46342248f447d9f289288#diff-11b42664eb9834972953ecd5725c75fd6020af6d4ee5da37ef6d8e0c146f7773R432-R435, since `PredicateBuilder#build_bind_attribute` would get the updated attribute type from the table definition: https://github.com/rails/rails/blob/90b0266e9bfaaadbd2d249ad2eeec042077a0063/activerecord/lib/active_record/relation/predicate_builder.rb#L71-L74

I have fixed this manually by overriding the setter:

```ruby
def email=(value)
   super
   @attributes[""email""] = @attributes[""email""].with_type(self.type_for_attribute(""email""))
end
```
but I propose that a more generic solution be added directly to `#becomes`.

### System configuration
**Rails version**: 7.0.7

**Ruby version**: 3.2.2","{'url': 'https://api.github.com/repos/rails/rails/issues/49009/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/49009/timeline,,
https://api.github.com/repos/rails/rails/issues/48993,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48993/labels{/name},https://api.github.com/repos/rails/rails/issues/48993/comments,https://api.github.com/repos/rails/rails/issues/48993/events,https://github.com/rails/rails/pull/48993,1860143970,PR_kwDNIULOWG2WtQ,48993,Make `has_secure_password` pluginable/extendable with different password hashing algorithms,"{'login': 'f3ndot', 'id': 740289, 'node_id': 'MDQ6VXNlcjc0MDI4OQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/740289?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/f3ndot', 'html_url': 'https://github.com/f3ndot', 'followers_url': 'https://api.github.com/users/f3ndot/followers', 'following_url': 'https://api.github.com/users/f3ndot/following{/other_user}', 'gists_url': 'https://api.github.com/users/f3ndot/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/f3ndot/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/f3ndot/subscriptions', 'organizations_url': 'https://api.github.com/users/f3ndot/orgs', 'repos_url': 'https://api.github.com/users/f3ndot/repos', 'events_url': 'https://api.github.com/users/f3ndot/events{/privacy}', 'received_events_url': 'https://api.github.com/users/f3ndot/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],"{'url': 'https://api.github.com/repos/rails/rails/milestones/83', 'html_url': 'https://github.com/rails/rails/milestone/83', 'labels_url': 'https://api.github.com/repos/rails/rails/milestones/83/labels', 'id': 9964242, 'node_id': 'MI_kwDNIULOAJgK0g', 'number': 83, 'title': '7.2.0', 'description': None, 'creator': {'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}, 'open_issues': 6, 'closed_issues': 1, 'state': 'open', 'created_at': '2023-09-25T20:29:14Z', 'updated_at': '2023-10-05T13:36:16Z', 'due_on': None, 'closed_at': None}",2,2023-08-21T21:01:57Z,2023-09-29T20:50:03Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48993', 'html_url': 'https://github.com/rails/rails/pull/48993', 'diff_url': 'https://github.com/rails/rails/pull/48993.diff', 'patch_url': 'https://github.com/rails/rails/pull/48993.patch', 'merged_at': None}","### Motivation / Background

Based on an idea by @rafaelfranca in https://github.com/rails/rails/issues/41420#issuecomment-1686745412.

While BCrypt may be the desirable default password hashing algorithm in Rails for the foreseeable future, making the mechanism for hashing and verifying passwords in `has_secure_password` extendable/modular is valuable.

Developers may opt for different hashing algorithms and can now extend or plug in their own alongside BCrypt in a clean and maintainable way. From the referenced thread, there is discourse amongst people on what should be the _de facto_ password algorithm and disagreement on whether Argon2 should be it. Rails should make it easier for the community to progress on best password hashing practices.

This also unlocks Rails shipping with more than BCrypt as an available hashing algorithm.

I _could_ see a world where Rails offers PBKDF2 (for those wanting FIPS 140 compliance), BCrypt (the safe default), and Argon2 (since OWASP recommends it).

### Detail

This PR takes BCrypt-specific code in `ActiveModel::SecurePassword` and extracts it out into an object `ActiveModel::SecurePassword::BCrypt`. The object adheres to a simple interface (`ActiveModel::SecurePassword::Base`) so developers can supplement with different algorithms (or different libraries of the same underlying algo). 

A user of the Rails framework uses the newly added `:algorithm` option in `has_secure_password` to declare what password hashing algo should be used on a given attribute.

Developers can write libraries or even initializers to add different password hashing algorithm support following a very clean interface.

Below is an example of someone opting to use Argon2 using `ruby-argon2`:

```ruby
# config/initializers/add_argon2_to_activemodel_securepassword.rb

require ""active_model/secure_password/base""

module ActiveModel
  module SecurePassword
    class Argon2id < Base
      def initialize
        require ""argon2""
      rescue LoadError
        warn ""You don't have argon2 installed in your application. Please add it to your Gemfile and run bundle install.""
        raise
      end

      def self.algorithm_name
        :argon2id
      end

      def hash_password(unencrypted_password, options = {})
        if options[:min_cost]
          hasher = Argon2::Password.new(t_cost: 1, m_cost: 3, p_cost: 1)
        else
          hasher = Argon2::Password.new(t_cost: 2, m_cost: 19, p_cost: 1)  # Latest OWASP recommended values
        end
        hasher.create(unencrypted_password)
      end

      def verify_password(password, digest)
        Argon2::Password.verify_password(password, digest)
      end

      def password_salt(digest)
        Argon2::HashFormat.new(digest).salt
      end
    end
  end
end
```

```ruby
# app/models/user.rb

class User < ActiveRecord::Base
  has_secure_password :password, algorithm: :argon2
end
```

### Additional information

I'm a bit of a novice when it comes to making Rails aware of different files and how to ""register"" a series of subclasses (some of which could be defined in libraries or the initializers folder) to a part of Rails. Open to whatever pattern is the most appropriate.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

","{'url': 'https://api.github.com/repos/rails/rails/issues/48993/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48993/timeline,,
https://api.github.com/repos/rails/rails/issues/48986,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48986/labels{/name},https://api.github.com/repos/rails/rails/issues/48986/comments,https://api.github.com/repos/rails/rails/issues/48986/events,https://github.com/rails/rails/pull/48986,1857928799,PR_kwDNIULOWE_a2g,48986,[Fix #46509] Run autosave validations regardless of changes,"{'login': 'joshuay03', 'id': 54629302, 'node_id': 'MDQ6VXNlcjU0NjI5MzAy', 'avatar_url': 'https://avatars.githubusercontent.com/u/54629302?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/joshuay03', 'html_url': 'https://github.com/joshuay03', 'followers_url': 'https://api.github.com/users/joshuay03/followers', 'following_url': 'https://api.github.com/users/joshuay03/following{/other_user}', 'gists_url': 'https://api.github.com/users/joshuay03/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/joshuay03/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/joshuay03/subscriptions', 'organizations_url': 'https://api.github.com/users/joshuay03/orgs', 'repos_url': 'https://api.github.com/users/joshuay03/repos', 'events_url': 'https://api.github.com/users/joshuay03/events{/privacy}', 'received_events_url': 'https://api.github.com/users/joshuay03/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-20T02:25:41Z,2023-08-30T20:17:56Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48986', 'html_url': 'https://github.com/rails/rails/pull/48986', 'diff_url': 'https://github.com/rails/rails/pull/48986.diff', 'patch_url': 'https://github.com/rails/rails/pull/48986.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created to fix https://github.com/rails/rails/issues/46509.

### Detail

This Pull Request changes association autosave logic to decouple validation and save conditions, so that validations are always run (still taking into consideration options like `:validate`) regardless of whether or not the record is changing. This makes autosave validations consistent with direct persistence methods like `save`, as shown in https://github.com/rails/rails/issues/46509#issuecomment-1322641993 and the test I've added in this PR.

This approach was inspired by the comments in https://github.com/rails/rails/pull/47088, which was an alternate approach to fixing the linked issue.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

Failing one edge case test, see https://github.com/rails/rails/pull/48986#issuecomment-1685203599.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48986/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48986/timeline,,
https://api.github.com/repos/rails/rails/issues/48975,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48975/labels{/name},https://api.github.com/repos/rails/rails/issues/48975/comments,https://api.github.com/repos/rails/rails/issues/48975/events,https://github.com/rails/rails/issues/48975,1857100531,I_kwDNIULObrEa8w,48975,rails-ujs ignores submission value of form-associated custom elements,"{'login': 'khuston', 'id': 4020899, 'node_id': 'MDQ6VXNlcjQwMjA4OTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4020899?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/khuston', 'html_url': 'https://github.com/khuston', 'followers_url': 'https://api.github.com/users/khuston/followers', 'following_url': 'https://api.github.com/users/khuston/following{/other_user}', 'gists_url': 'https://api.github.com/users/khuston/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/khuston/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/khuston/subscriptions', 'organizations_url': 'https://api.github.com/users/khuston/orgs', 'repos_url': 'https://api.github.com/users/khuston/repos', 'events_url': 'https://api.github.com/users/khuston/events{/privacy}', 'received_events_url': 'https://api.github.com/users/khuston/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,0,2023-08-18T18:08:52Z,2023-08-18T18:08:52Z,,NONE,,,,"### Preface

Best practice when designing a form-associated custom element would be to have interface parity with `HTMLInputElement`, especially the value attribute's behavior (e.g. only null when disabled, otherwise null is converted to empty string). I am submitting this issue in part to document a potential pitfall of form-associated custom elements that don't follow this best practice and suggest that rails-ujs could use `FormData` and `URLSearchParams` to avoid the pitfall altogether.

### Steps to reproduce
Include a [form-associated custom element](https://html.spec.whatwg.org/multipage/custom-elements.html#form-associated-custom-element) that deviates from `HTMLInputElement` behavior by not having a value attribute at all or having a `.value` property that returns null. (The form-associated custom element sets its [submission value](https://html.spec.whatwg.org/multipage/custom-elements.html#face-submission-value) through the [ElementInternals API](https://developer.mozilla.org/en-US/docs/Web/API/ElementInternals/setFormValue)).

Use `remote: true` and `multipart: false` (default multipart value) when creating the form.

Fire a submit event on the form to trigger rails-ujs ajax.

Observe that rails-ujs serializes the parameters into `x-www-form-urlencode` without regard to the submission value.

```html.erb
<script>
    class MyControl extends HTMLElement {

        static formAssociated = true;

        constructor() {
            super();
            this.internals_ = this.attachInternals();
            this.value_ = null;
        }

        // HTMLInputElement has a ""value"" property. We do too,
        // but sometimes ours is null despite being enabled.
        get value() { return this.value_; }
        set value(v) { this.value_ = v; }

        // More properties which aren't required by the standard but recommended.
        get form() { return this.internals_.form; }
        get name() { return this.getAttribute('name'); }
    }
    customElements.define('null-value', NullValueControl);
</script>

<%= form_with url: ""/things"", method: :get, remote: true do |form| %>
  <null-value name=""some_value""></null-value>
  <%= form.submit %>
<% end %>

```

### Expected behavior

The serialized parameters should match those given by `FormData`, which constructs the entry list following the [standard procedure](https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#constructing-form-data-set) that supports form-associated custom elements. The parameters can then be URL encoded, e.g.

```js
const formData = new FormData(form)
const params = new URLSearchParams(formData)
// params is populated with parameters based on the submission value of form-associated custom elements
// in the above code example, the submission value of the field is null, so it doesn't appear in params at all
```

Note: `multipart: true` on the form already results in `FormData` being correctly used to serialize as `multipart/form-data`

### Actual behavior
rails-ujs serializes parameters into `x-www-form-urlencode` by scanning for value attributes on form controls. A form-associated custom element may not have a value attribute or may return the property as null.

Example 1: If the form-associated custom element has no value attribute, it is missed altogether, even if a submission value is contributed to the form.

Example 2: If the form-associated custom element has a `.value` property that is null, it is serialized to the literal string 'null'.

https://github.com/rails/rails/blob/main/actionview/app/assets/javascripts/rails-ujs.esm.js#L283

### System configuration
**Rails version**: 7.0.7

**Ruby version**: 3.1.2","{'url': 'https://api.github.com/repos/rails/rails/issues/48975/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48975/timeline,,
https://api.github.com/repos/rails/rails/issues/48968,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48968/labels{/name},https://api.github.com/repos/rails/rails/issues/48968/comments,https://api.github.com/repos/rails/rails/issues/48968/events,https://github.com/rails/rails/issues/48968,1855533364,I_kwDNIULObpkxNA,48968,ActiveRecord - Dependent destroy relies on cached ActiveRecord::Relation,"{'login': 'sergioisidoro', 'id': 5014629, 'node_id': 'MDQ6VXNlcjUwMTQ2Mjk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5014629?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sergioisidoro', 'html_url': 'https://github.com/sergioisidoro', 'followers_url': 'https://api.github.com/users/sergioisidoro/followers', 'following_url': 'https://api.github.com/users/sergioisidoro/following{/other_user}', 'gists_url': 'https://api.github.com/users/sergioisidoro/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sergioisidoro/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sergioisidoro/subscriptions', 'organizations_url': 'https://api.github.com/users/sergioisidoro/orgs', 'repos_url': 'https://api.github.com/users/sergioisidoro/repos', 'events_url': 'https://api.github.com/users/sergioisidoro/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sergioisidoro/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-08-17T18:50:35Z,2023-09-06T13:40:16Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby

class ThingsTodo < ApplicationRecord
   belongs_to :task # without FK constraint

class Task < ApplicationRecord
   has_many :things_todo, dependent: :destroy

   after_create :init_things_todo
   
   def init_things_todo
       # call service that creates things to do
       InitializeTodo.call(self)

@todo = Todo.create()
@todo.id  # 123
@todo.things_todo.count  # Zero, Expected
ThingsTodo.count # Not Zero, Expected

@todo.destroy!
ThingsTodo.count # Not Zero, NOT expected?
ThingsTodo.first.id # 123

ThingsTodo.destroy_all

@todo = Todo.create()
@todo.reload
@todo.destroy!
ThingsTodo.count # Zero 

```
### Expected behavior
Although I do not expect the just created object to contain the initialised related objects - created by the `after_save` callback, I was expecting the the `dependent: :destroy` to make a query to delete the related records, instead of using the cached ActiveRecord::Relation. 

### Actual behavior
Dependent destroy calls destroy on the cached ActiveRecord::Relation (which is empty). This might be by design as a way to avoid one extra query, but it took me a while to realise because in this case there was no foreign key constraint. I was also getting a fk_constraint error on another case, and didn't realise why I was getting it until I found this.

Also note that this makes the behaviour of destroy and destroy async different, as destroy async will make a separate query with `find_by`.

### Going forward 
A) make dependent destroy make a query, with a performance penalty.
B) Expand on the warning in the documentations - https://guides.rubyonrails.org/association_basics.html#options-for-belongs-to-dependent - to include this caveat. 

### System configuration
**Rails version**: 7.0.4
**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48968/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48968/timeline,,
https://api.github.com/repos/rails/rails/issues/48957,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48957/labels{/name},https://api.github.com/repos/rails/rails/issues/48957/comments,https://api.github.com/repos/rails/rails/issues/48957/events,https://github.com/rails/rails/pull/48957,1853867624,PR_kwDNIULOWBkdoA,48957,Better handle SyntaxError in Action View,"{'login': 'cmaruz', 'id': 1709692, 'node_id': 'MDQ6VXNlcjE3MDk2OTI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1709692?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/cmaruz', 'html_url': 'https://github.com/cmaruz', 'followers_url': 'https://api.github.com/users/cmaruz/followers', 'following_url': 'https://api.github.com/users/cmaruz/following{/other_user}', 'gists_url': 'https://api.github.com/users/cmaruz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/cmaruz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/cmaruz/subscriptions', 'organizations_url': 'https://api.github.com/users/cmaruz/orgs', 'repos_url': 'https://api.github.com/users/cmaruz/repos', 'events_url': 'https://api.github.com/users/cmaruz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/cmaruz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,2,2023-08-16T20:32:55Z,2023-09-27T02:51:31Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48957', 'html_url': 'https://github.com/rails/rails/pull/48957', 'diff_url': 'https://github.com/rails/rails/pull/48957.diff', 'patch_url': 'https://github.com/rails/rails/pull/48957.patch', 'merged_at': None}","### Motivation / Background

Fixes #48326

This Pull Request has been created to fix an issue where syntax errors generated inside an eval method cause an Internal Server Error due to a TypeError.

### Detail

In order to display the extraced source of a syntax error, we try to locate the node id for the backtrace location. The call to RubyVM::AbstractSyntaxTree.node_id_for_backtrace_location is expecting a Thread::Backtrace::Location object, but we are passing a SourceMapLocation instead.

Once this is fixed, another issue then appears. The first location of the backtrace for an eval error does not include the filename of where eval is called, so we can't extract the source. This means that the development view fails to show the extracted source because it is hard-coded to show the source extracted for the first location.

This commit does two things:
1) it addresses the issue by making sure that we are always passing a Thread::Backtrace::Location instead
2) it allows the development view to show the extracted source fragment by ensuring the first location of the backtrace for a syntax error coming from eval includes the name of the file where eval is called


### Additional information

I have tried to keep the changes consistent with the approach introduced in https://github.com/rails/rails/pull/46171.","{'url': 'https://api.github.com/repos/rails/rails/issues/48957/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48957/timeline,,
https://api.github.com/repos/rails/rails/issues/48946,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48946/labels{/name},https://api.github.com/repos/rails/rails/issues/48946/comments,https://api.github.com/repos/rails/rails/issues/48946/events,https://github.com/rails/rails/issues/48946,1852020901,I_kwDNIULObmOYpQ,48946,Regression in Postgres aggregate function data type inference/casting in Rails >= 7.0.5,"{'login': 'midnightmonster', 'id': 57948, 'node_id': 'MDQ6VXNlcjU3OTQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/57948?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/midnightmonster', 'html_url': 'https://github.com/midnightmonster', 'followers_url': 'https://api.github.com/users/midnightmonster/followers', 'following_url': 'https://api.github.com/users/midnightmonster/following{/other_user}', 'gists_url': 'https://api.github.com/users/midnightmonster/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/midnightmonster/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/midnightmonster/subscriptions', 'organizations_url': 'https://api.github.com/users/midnightmonster/orgs', 'repos_url': 'https://api.github.com/users/midnightmonster/repos', 'events_url': 'https://api.github.com/users/midnightmonster/events{/privacy}', 'received_events_url': 'https://api.github.com/users/midnightmonster/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2023-08-15T19:41:45Z,2023-08-16T18:22:11Z,,NONE,,,,"### Steps to reproduce
```sql
-- Create Postgres database, required to reproduce
CREATE DATABASE type_inference_test;
```

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # gem ""rails"", github: ""rails/rails"", tag: ""v7.0.4.3"" # OK
  # gem ""rails"", github: ""rails/rails"", tag: ""v7.0.5""   # Fail
  # gem ""rails"", github: ""rails/rails"", tag: ""v7.0.7""   # Fail
  gem ""rails"", github: ""rails/rails"", branch: ""main""    # Fail
  gem ""pg""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# The issue appears appears with Postgres, not with SQLite. I have not tested other adapters.
# ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
# N.b., in sqlite3 .pluck(""sum(decimal_column)"").first returns a Float instead of a BigDecimal. Though that arguably is a bug, AFAICT it is _not_ a regression.
ActiveRecord::Base.establish_connection(adapter: ""postgresql"", database: ""type_inference_test"", encoding: ""unicode"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :line_items, force: true do |t|
    t.integer :unit_count
    t.decimal :subtotal
  end
end

class LineItem < ActiveRecord::Base
end

class TypeInferenceBug < Minitest::Test
  def setup
    LineItem.create! unit_count: 5, subtotal: 47.98
    LineItem.create! unit_count: 1, subtotal: 13.13
  end

  # This works correctly
  def test_single_column
    assert_kind_of Integer, LineItem.sum(:unit_count)
    assert_kind_of Integer, LineItem.pluck(""sum(unit_count)"").first
    assert_kind_of BigDecimal, LineItem.sum(:subtotal)
    assert_kind_of BigDecimal, LineItem.pluck(""sum(subtotal)"").first
  end

  # All these fail starting in 7.0.5. ActiveRecord seems to apply the type of the last item to all numeric(?) columns.
  def test_two_column_decimal_last
    # Fails in 7.0.5-7.0.7, ok in 7.0.4.3
    assert_kind_of Integer, LineItem.pluck(""sum(unit_count)"", ""sum(subtotal)"").first.first
  end

  def test_two_column_integer_last
    # Fails in 7.0.5-7.0.7, ok in 7.0.4.3
    assert_kind_of BigDecimal, LineItem.pluck(""sum(subtotal)"", ""sum(unit_count)"").first.first
  end

  def test_same_problem_with_another_aggregate_function
    # Fails in 7.0.5-7.0.7, ok in 7.0.4.3
    assert_kind_of BigDecimal, LineItem.pluck(""max(subtotal)"", ""max(unit_count)"").first.first
  end
end

```

### Expected behavior
Type of values returned from `pluck(""aggregate_function(column)"",...)` depends on database's data type and does not change if additional values are also plucked. Up through Rails 7.0.4.3, this worked as expected.

### Actual behavior
When plucking sums (or other aggregate functions) of more than one numeric column, `pluck` coerces all numeric(?) values to the type of the last column, at least when using the postgresql adapter. In our use, this results in integers inconveniently cast to BigDecimals and (more perniciously) decimal values representing dollars and cents being truncated to integersand the data type of existing columns of a `pluck` call changing based on order or from adding an additional column.

### System configuration
**Rails version**: 7.0.7

**Ruby version**: 3.1.1p18
","{'url': 'https://api.github.com/repos/rails/rails/issues/48946/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48946/timeline,,
https://api.github.com/repos/rails/rails/issues/48945,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48945/labels{/name},https://api.github.com/repos/rails/rails/issues/48945/comments,https://api.github.com/repos/rails/rails/issues/48945/events,https://github.com/rails/rails/issues/48945,1851736618,I_kwDNIULObl9CKg,48945,Broken table alias referencing in Rails 7.0.7,"{'login': 'kaoru', 'id': 89070, 'node_id': 'MDQ6VXNlcjg5MDcw', 'avatar_url': 'https://avatars.githubusercontent.com/u/89070?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kaoru', 'html_url': 'https://github.com/kaoru', 'followers_url': 'https://api.github.com/users/kaoru/followers', 'following_url': 'https://api.github.com/users/kaoru/following{/other_user}', 'gists_url': 'https://api.github.com/users/kaoru/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kaoru/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kaoru/subscriptions', 'organizations_url': 'https://api.github.com/users/kaoru/orgs', 'repos_url': 'https://api.github.com/users/kaoru/repos', 'events_url': 'https://api.github.com/users/kaoru/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kaoru/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,8,2023-08-15T16:11:26Z,2023-08-23T22:35:35Z,,NONE,,,,"### Steps to reproduce

We're using a combination of ""where missing"" and ""or + scope"" to find goals without a state, either because they have no state record or because they have a state record with a NULL state column on it.

The behaviour has changed in Rails 7.0.7 to throw an ActiveRecord::StatementInvalid error, because on 7.0.6 the left joined table was not given an alias but on 7.0.7 it is given an alias and that alias is then not consistently used in the where clauses produced.

Note this looks a lot like https://github.com/rails/rails/issues/48334 but that bug is fixed on 7.0.6 and 7.0.7.

```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # gem 'rails', '~> 7.0', '= 7.0.6'
  gem 'rails', '~> 7.0', '= 7.0.7'
  # gem 'rails', github: 'rails/rails'
  gem 'sqlite3'
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
#ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :goals, force: true do |t|
  end

  create_table :goal_states, force: true do |t|
    t.integer :goal_id
    t.string :state
  end
end

class Goal < ActiveRecord::Base
  has_one :state, class_name: 'GoalState', dependent: :destroy

  scope :no_state, -> { where.missing(:state).or(left_joins(:state).merge(GoalState.not_set)) }
end

class GoalState < ActiveRecord::Base
  belongs_to :goal

  scope :set, -> { where.not(state: nil) }
  scope :not_set, -> { where(state: nil) }
end

class BugTest < Minitest::Test
  def setup
    @g1 = Goal.create

    @g2 = Goal.create
    @g2.create_state(state: nil)

    @g3 = Goal.create
    @g3.create_state(state: 'cool')
  end

  # This works on Rails 7.0.6 and gives an ActiveRecord::StatementInvalid on
  # Rails 7.0.7 because the table alias behaviour has changed.
  def test_no_state
    puts
    puts Goal.no_state.to_sql
    puts

    assert_equal 2, Goal.no_state.count
    assert_equal Goal.no_state, [@g1, @g2]
  end
end
```

### Expected behavior

On Rails 7.0.6 the SQL produced is:

```sql
SELECT ""goals"".* FROM ""goals"" LEFT OUTER JOIN ""goal_states"" ON ""goal_states"".""goal_id"" = ""goals"".""id"" WHERE (""goal_states"".""id"" IS NULL OR ""goal_states"".""state"" IS NULL)
```

### Actual behavior

On Rails 7.0.7 (and on the main branch of `rails/rails`) the SQL produced is:

```sql
SELECT ""goals"".* FROM ""goals"" LEFT OUTER JOIN ""goal_states"" ""state"" ON ""state"".""goal_id"" = ""goals"".""id"" WHERE (""state"".""id"" IS NULL OR ""goal_states"".""state"" IS NULL)
```

Which throws an error:

```
ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: goal_states.state
```

Because the missing gives the left join an alias of ""state"" but the check produced by the ""OR"" uses the table name ""goal_states"".

I've fixed this in our codebase by changing the code to `scope :no_status, -> { left_joins(:status).merge(Goals::Status.not_set) }` because technically with a left join the missing check is redundant anyway! But I thought I'd report the bug in case it's affecting other people with harder-to-fix query cases.

### System configuration

**Rails version**: 7.0.7

**Ruby version**: 3.2.2","{'url': 'https://api.github.com/repos/rails/rails/issues/48945/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48945/timeline,,
https://api.github.com/repos/rails/rails/issues/48944,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48944/labels{/name},https://api.github.com/repos/rails/rails/issues/48944/comments,https://api.github.com/repos/rails/rails/issues/48944/events,https://github.com/rails/rails/issues/48944,1851693426,I_kwDNIULObl6Zcg,48944,Order of `id` column in `select` changes loaded record ID,"{'login': 'conzett', 'id': 142183, 'node_id': 'MDQ6VXNlcjE0MjE4Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/142183?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/conzett', 'html_url': 'https://github.com/conzett', 'followers_url': 'https://api.github.com/users/conzett/followers', 'following_url': 'https://api.github.com/users/conzett/following{/other_user}', 'gists_url': 'https://api.github.com/users/conzett/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/conzett/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/conzett/subscriptions', 'organizations_url': 'https://api.github.com/users/conzett/orgs', 'repos_url': 'https://api.github.com/users/conzett/repos', 'events_url': 'https://api.github.com/users/conzett/events{/privacy}', 'received_events_url': 'https://api.github.com/users/conzett/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-15T15:44:05Z,2023-09-04T14:10:19Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require ""bundler/inline""                                                         
                                                                                 
gemfile(true) do                                                                 
  source ""https://rubygems.org""                                                  
                                                                                 
  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }                
                                                                                 
  # Activate the gem you are reporting the issue against.                        
  gem ""activerecord"", ""~> 7.0.0""                                                 
  gem ""sqlite3""                                                                  
end                                                                              
                                                                                 
require ""active_record""                                                          
require ""minitest/autorun""                                                       
require ""logger""                                                                 
                                                                                 
# This connection will do for database-independent bug reports.                  
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)                                   
                                                                                 
ActiveRecord::Schema.define do                                                   
  create_table :posts, force: true do |t|                                        
  end                                                                            
                                                                                 
  create_table :comments, force: true do |t|                                     
    t.integer :post_id                                                           
  end                                                                            
end                                                                              
                                                                                 
class Post < ActiveRecord::Base                                                  
  has_many :comments                                                             
end                                                                              
                                                                                 
class Comment < ActiveRecord::Base                                               
  belongs_to :post                                                               
end                                                                              
                                                                                 
class BugTest < Minitest::Test                                                   
  def test_select_order_with_join                                                
    10.times { |i| Post.create! id: i + 1 }                                      
                                                                                 
    Post.first.comments << Comment.create!                                       
                                                                                 
    join_last = Post.left_joins(:comments).select ""posts.*, comments.id""         
    join_first = Post.left_joins(:comments).select ""comments.id, posts.*""        
                                                                                 
    assert_equal (1..10).to_a, join_last.map(&:id)                               
    assert_equal join_last.map(&:id), join_first.map(&:id)                       
  end                                                                            
end                                                                              
```

### Expected behavior
- Post records should have correct `id` and not the ID of the join record(s)
- Order of what is being selected should not matter?

### Actual behavior
The ID if the join record appears to be assigned to the main record

### System configuration
**Rails version**: 7.0.0

**Ruby version**: 3.2.2

Also tested with Rails 6 and Ruby 2.7
","{'url': 'https://api.github.com/repos/rails/rails/issues/48944/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48944/timeline,,
https://api.github.com/repos/rails/rails/issues/48939,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48939/labels{/name},https://api.github.com/repos/rails/rails/issues/48939/comments,https://api.github.com/repos/rails/rails/issues/48939/events,https://github.com/rails/rails/issues/48939,1850332701,I_kwDNIULObknWHQ,48939,HABTM Silently ignores :dependent option,"{'login': 'nhorton', 'id': 204146, 'node_id': 'MDQ6VXNlcjIwNDE0Ng==', 'avatar_url': 'https://avatars.githubusercontent.com/u/204146?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nhorton', 'html_url': 'https://github.com/nhorton', 'followers_url': 'https://api.github.com/users/nhorton/followers', 'following_url': 'https://api.github.com/users/nhorton/following{/other_user}', 'gists_url': 'https://api.github.com/users/nhorton/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nhorton/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nhorton/subscriptions', 'organizations_url': 'https://api.github.com/users/nhorton/orgs', 'repos_url': 'https://api.github.com/users/nhorton/repos', 'events_url': 'https://api.github.com/users/nhorton/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nhorton/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2023-08-14T18:35:22Z,2023-09-27T01:45:57Z,,CONTRIBUTOR,,,,"### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :categories, force: true do |t|
  end

  create_join_table :posts, :categories
end

class Post < ActiveRecord::Base
  has_and_belongs_to_many :categories
end

class Category < ActiveRecord::Base
  has_and_belongs_to_many :posts, dependent: :destroy
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!
    category = Category.create!
    post.categories << category
    assert post.persisted?
    assert category.posts.include?(post)

    # Now the bug
    category.destroy!
    refute Post.find_by_id(post.id) # Post should be gone
  end
end

```

### Expected behavior
HABTM should either destroy the associated resource when it is destroyed, or the declaration should error when you try to set the `:dependent` option should trigger an error

### Actual behavior
It silently accepts the `:dependent` option then ignores it

### System configuration
**Rails version**: 7.0.7

**Ruby version**: 3.1.4
","{'url': 'https://api.github.com/repos/rails/rails/issues/48939/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48939/timeline,,
https://api.github.com/repos/rails/rails/issues/48933,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48933/labels{/name},https://api.github.com/repos/rails/rails/issues/48933/comments,https://api.github.com/repos/rails/rails/issues/48933/events,https://github.com/rails/rails/pull/48933,1848400629,PR_kwDNIULOV899oQ,48933,Fix a regression preventing vendorizing gems outside of the vendor folder,"{'login': 'JoeDupuis', 'id': 1518299, 'node_id': 'MDQ6VXNlcjE1MTgyOTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1518299?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JoeDupuis', 'html_url': 'https://github.com/JoeDupuis', 'followers_url': 'https://api.github.com/users/JoeDupuis/followers', 'following_url': 'https://api.github.com/users/JoeDupuis/following{/other_user}', 'gists_url': 'https://api.github.com/users/JoeDupuis/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JoeDupuis/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JoeDupuis/subscriptions', 'organizations_url': 'https://api.github.com/users/JoeDupuis/orgs', 'repos_url': 'https://api.github.com/users/JoeDupuis/repos', 'events_url': 'https://api.github.com/users/JoeDupuis/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JoeDupuis/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-08-13T04:24:10Z,2023-09-13T23:26:13Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48933', 'html_url': 'https://github.com/rails/rails/pull/48933', 'diff_url': 'https://github.com/rails/rails/pull/48933.diff', 'patch_url': 'https://github.com/rails/rails/pull/48933.patch', 'merged_at': None}","#48287 introduced auto loading fixtures in engines. All engines present in the root folder of the rails app would have their fixtures auto loaded. This caused tests to fail when gems were vendorized, because fixtures from the internal rails test suite would be loaded.

#48323 Added a check to exclude the vendor folder.

This PR extends the check introduced in #48323 to prevent loading fixtures from gem paths instead of just the vendor folder.

Some tools like devenv install gems in the root of the app, but outside of the vendor folder (`.devenv/state`).

This change prevents automatically loading fixtures from gems instead of the vendor folder.

### Motivation / Background

I run rails using devenv and after updating rails, my test suite started to complain about fixtures from rails internal tests.
The current check doesn't fix the issue for all situations. This new check *should*.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48933/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48933/timeline,,
https://api.github.com/repos/rails/rails/issues/48932,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48932/labels{/name},https://api.github.com/repos/rails/rails/issues/48932/comments,https://api.github.com/repos/rails/rails/issues/48932/events,https://github.com/rails/rails/pull/48932,1848369470,PR_kwDNIULOV88TUA,48932,This branch allows a user to set self.table_alias in the model,"{'login': 'paulreece', 'id': 96156234, 'node_id': 'U_kgDOBbs6Sg', 'avatar_url': 'https://avatars.githubusercontent.com/u/96156234?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/paulreece', 'html_url': 'https://github.com/paulreece', 'followers_url': 'https://api.github.com/users/paulreece/followers', 'following_url': 'https://api.github.com/users/paulreece/following{/other_user}', 'gists_url': 'https://api.github.com/users/paulreece/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/paulreece/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/paulreece/subscriptions', 'organizations_url': 'https://api.github.com/users/paulreece/orgs', 'repos_url': 'https://api.github.com/users/paulreece/repos', 'events_url': 'https://api.github.com/users/paulreece/events{/privacy}', 'received_events_url': 'https://api.github.com/users/paulreece/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-13T02:50:09Z,2023-09-01T14:57:18Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48932', 'html_url': 'https://github.com/rails/rails/pull/48932', 'diff_url': 'https://github.com/rails/rails/pull/48932.diff', 'patch_url': 'https://github.com/rails/rails/pull/48932.patch', 'merged_at': None}","This branch allows a user to set `self.table_alias` in the model to custom set a table alias.  It then accounts for the SQL needed for this in the AST.  Fixes #48775.

### Motivation / Background

This was motivated by the behavior shown in #[48775](https://github.com/rails/rails/issues/48775) and by a suggestion to implement it by @rafaelfranca.  

### Detail

This Pull Request allows a user to set a SQL `table_alias` in the model by using `self.table_alias = ""alias""`.  Once this is done it gets added to the `Alias` node in the AST.  In order to account for this in the SQL created by the AST I have the `Insert` statement using the original table name instead of the `table_alias` when a `table_alias` is present so that the SQL INSERT will function.  

With the `Update` and `Delete` methods I changed the default behavior of `visit_Arel_Table` to use ` AS ` when a `table_alias` is present, `table AS t` vs `table t`.  One last adjustment was necessary in the `Delete` method.  In order for MySQL to use the alias in the delete method I needed to add the `table_alias` after `DELETE `.  So the code checks for MySQL and if the Node is using a `table_alias` it will then insert the alias  after `DELETE `, `DELETE t FROM table AS t` vs `DELETE FROM table AS t`.  

With these adjustments in place one can now successfully use a `table_alias` set from the model with the Public API.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48932/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48932/timeline,,
https://api.github.com/repos/rails/rails/issues/48923,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48923/labels{/name},https://api.github.com/repos/rails/rails/issues/48923/comments,https://api.github.com/repos/rails/rails/issues/48923/events,https://github.com/rails/rails/pull/48923,1845411391,PR_kwDNIULOV6bNkQ,48923,[Fix #48922] Honour encrypted attribute context in encrypted_attribute?,"{'login': 'maximerety', 'id': 58582, 'node_id': 'MDQ6VXNlcjU4NTgy', 'avatar_url': 'https://avatars.githubusercontent.com/u/58582?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maximerety', 'html_url': 'https://github.com/maximerety', 'followers_url': 'https://api.github.com/users/maximerety/followers', 'following_url': 'https://api.github.com/users/maximerety/following{/other_user}', 'gists_url': 'https://api.github.com/users/maximerety/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maximerety/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maximerety/subscriptions', 'organizations_url': 'https://api.github.com/users/maximerety/orgs', 'repos_url': 'https://api.github.com/users/maximerety/repos', 'events_url': 'https://api.github.com/users/maximerety/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maximerety/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-08-10T15:21:02Z,2023-08-10T15:23:12Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48923', 'html_url': 'https://github.com/rails/rails/pull/48923', 'diff_url': 'https://github.com/rails/rails/pull/48923.diff', 'patch_url': 'https://github.com/rails/rails/pull/48923.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

This Pull Request has been created to fix https://github.com/rails/rails/issues/48922.

### Detail

The helper `encrypted_attribute?` currently delegates the check to the global default encryptor configured, cf

https://github.com/rails/rails/blob/e6d59cdebbd0ddaf88029a7b9f03f5d642780e0a/activerecord/lib/active_record/encryption/encryptable_record.rb#L141-L144

This Pull Requests delegates the check to the EncryptedAttributeType instance defined for the attribute. This attribute type properly applies context properties defined initially with `encrypts`, such as a custom encryptor or message serializer.

This fixes an issue where the `encrypted_attribute?` helper would return erroneous results.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48923/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48923/timeline,,
https://api.github.com/repos/rails/rails/issues/48922,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48922/labels{/name},https://api.github.com/repos/rails/rails/issues/48922/comments,https://api.github.com/repos/rails/rails/issues/48922/events,https://github.com/rails/rails/issues/48922,1845388034,I_kwDNIULObf5jAg,48922,Helper `encrypted_attribute?` does not honour the context properties passed to `encrypts`,"{'login': 'maximerety', 'id': 58582, 'node_id': 'MDQ6VXNlcjU4NTgy', 'avatar_url': 'https://avatars.githubusercontent.com/u/58582?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maximerety', 'html_url': 'https://github.com/maximerety', 'followers_url': 'https://api.github.com/users/maximerety/followers', 'following_url': 'https://api.github.com/users/maximerety/following{/other_user}', 'gists_url': 'https://api.github.com/users/maximerety/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maximerety/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maximerety/subscriptions', 'organizations_url': 'https://api.github.com/users/maximerety/orgs', 'repos_url': 'https://api.github.com/users/maximerety/repos', 'events_url': 'https://api.github.com/users/maximerety/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maximerety/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,0,2023-08-10T15:09:33Z,2023-09-21T06:24:26Z,,CONTRIBUTOR,,,,"### Steps to reproduce

1. Pass a custom encryptor (or other context properties) to the `encrypts` helper, e.g.
https://github.com/rails/rails/blob/e6d59cdebbd0ddaf88029a7b9f03f5d642780e0a/activerecord/test/cases/encryption/encryption_schemes_test.rb#L198-L202
1. Create a record and test a supposedly encrypted attribute with `encrypted_attribute?`:

    ```ruby
    author = EncryptedAuthor1.create name: ""1""
    assert author.encrypted_attribute? :name
    ```

### Expected behavior

The attribute is expected to be encrypted, i.e. `encrypted_attribute?` should return `true`.

### Actual behavior

The attribute appears to be unencrypted, i.e. `encrypted_attribute?` returns `false`, despite the actual value being encrypted.

### System configuration

**Rails version**: 7.0.7 / main
**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48922/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48922/timeline,,
https://api.github.com/repos/rails/rails/issues/48921,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48921/labels{/name},https://api.github.com/repos/rails/rails/issues/48921/comments,https://api.github.com/repos/rails/rails/issues/48921/events,https://github.com/rails/rails/pull/48921,1845260824,PR_kwDNIULOV6S7bg,48921,feat: Add ActiveModel::Model.filter_attributes,"{'login': 'bf4', 'id': 142914, 'node_id': 'MDQ6VXNlcjE0MjkxNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/142914?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bf4', 'html_url': 'https://github.com/bf4', 'followers_url': 'https://api.github.com/users/bf4/followers', 'following_url': 'https://api.github.com/users/bf4/following{/other_user}', 'gists_url': 'https://api.github.com/users/bf4/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bf4/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bf4/subscriptions', 'organizations_url': 'https://api.github.com/users/bf4/orgs', 'repos_url': 'https://api.github.com/users/bf4/repos', 'events_url': 'https://api.github.com/users/bf4/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bf4/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,3,2023-08-10T14:03:53Z,2023-08-13T16:33:55Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48921', 'html_url': 'https://github.com/rails/rails/pull/48921', 'diff_url': 'https://github.com/rails/rails/pull/48921.diff', 'patch_url': 'https://github.com/rails/rails/pull/48921.patch', 'merged_at': None}","If this looks good, I'll fill in the gaps in documentation and respond
to feedback in a timely manner.

Is a simpler version of what's in
https://github.com/rails/rails/blob/7-0-stable/activerecord/lib/active_record/core.rb#L373-L396

I'm using this in our application and thought I'd share back.

### Motivation / Background

We using ActiveModel::Model to build plain-old-ruby
objects for things like API clients.  When I use
the Attributes API to define secrets like `attribute :api_key, :string`
I don't want the `api_key` to show up anywhere.

This Pull Request has been created because ActiveModel::Model
is missing the `filter_attributes` behavior present in
ActiveRecord::Core.

### Detail

This Pull Request changes adds `filter_attributes` to ActiveModel::API

I added it to ActiveModel::API so that it does not interfere with
ActiveRecord.


### Additional information

We're using this in our app.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/48921/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48921/timeline,,
https://api.github.com/repos/rails/rails/issues/48915,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48915/labels{/name},https://api.github.com/repos/rails/rails/issues/48915/comments,https://api.github.com/repos/rails/rails/issues/48915/events,https://github.com/rails/rails/issues/48915,1843653413,I_kwDNIULObePrJQ,48915,"Not obvious how to customize ActiveStorage routing, and undocumented in API docs and guide","{'login': 'technicalpickles', 'id': 159, 'node_id': 'MDQ6VXNlcjE1OQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/159?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/technicalpickles', 'html_url': 'https://github.com/technicalpickles', 'followers_url': 'https://api.github.com/users/technicalpickles/followers', 'following_url': 'https://api.github.com/users/technicalpickles/following{/other_user}', 'gists_url': 'https://api.github.com/users/technicalpickles/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/technicalpickles/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/technicalpickles/subscriptions', 'organizations_url': 'https://api.github.com/users/technicalpickles/orgs', 'repos_url': 'https://api.github.com/users/technicalpickles/repos', 'events_url': 'https://api.github.com/users/technicalpickles/events{/privacy}', 'received_events_url': 'https://api.github.com/users/technicalpickles/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-09T16:46:50Z,2023-08-23T19:13:47Z,,CONTRIBUTOR,,,,"While setting up ActiveStorage in an existing app, we found ourselves needing to make sure that it's only available on a specific subdomain. We use this snippet in `config/routes.rb` when we are applying this to our application code:

```ruby
defaults(subdomain: app_subdomain) do
  # routes here
end
```

The [ActiveStorage Overview guide](https://guides.rubyonrails.org/active_storage_overview.html) doesn't mention it at all.

I dug around active_storage, and found this:

https://github.com/rails/rails/blob/8ec27a4529e37cff77abe54573bb8923d9fe8e9a/activestorage/config/routes.rb#L4

https://github.com/rails/rails/blob/8ec27a4529e37cff77abe54573bb8923d9fe8e9a/activestorage/lib/active_storage.rb#L359

When I found that it was using `scope`, I realized we could pass in a Hash with options instead of a string to use as a prefix:

```ruby
# config/initializers/active_storage.rb
Rails.application.config.active_storage.routes_prefix = {path: 'rails/active_storage', subdomain: app_subdomain}
```

Seeing it written out this way, `routes_prefix` doesn't seem as an accurate a name for what it allows.

This might be a few tasks actually:

- document `routes_prefix` in rdoc
- document `routes_prefix` on the guide
- maybe rename `routes_prefix` w/ a deprecation?

### Steps to reproduce

n/a
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# Your reproduction script goes here
```

### Expected behavior
<!-- Tell us what should happen -->

Should be able to find out how to customize ActiveStorage routing on either API docs or ActiveStorage guide

### Actual behavior

Had to read the code to find out how to do this

### System configuration
**Rails version**: 7-0-stable (fabd0b5827a3af1f189d726fbc7669f9fbdeef5e)

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48915/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48915/timeline,,
https://api.github.com/repos/rails/rails/issues/48909,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48909/labels{/name},https://api.github.com/repos/rails/rails/issues/48909/comments,https://api.github.com/repos/rails/rails/issues/48909/events,https://github.com/rails/rails/issues/48909,1842028900,I_kwDNIULObcshZA,48909,Google Storage Service Error when uploading attachments,"{'login': 'matiassalles99', 'id': 57004457, 'node_id': 'MDQ6VXNlcjU3MDA0NDU3', 'avatar_url': 'https://avatars.githubusercontent.com/u/57004457?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matiassalles99', 'html_url': 'https://github.com/matiassalles99', 'followers_url': 'https://api.github.com/users/matiassalles99/followers', 'following_url': 'https://api.github.com/users/matiassalles99/following{/other_user}', 'gists_url': 'https://api.github.com/users/matiassalles99/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matiassalles99/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matiassalles99/subscriptions', 'organizations_url': 'https://api.github.com/users/matiassalles99/orgs', 'repos_url': 'https://api.github.com/users/matiassalles99/repos', 'events_url': 'https://api.github.com/users/matiassalles99/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matiassalles99/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-08T20:17:01Z,2023-09-05T05:26:30Z,,CONTRIBUTOR,,,,"- We have been running into these kinds of errors lately when attaching multiple images to a model:
`Google::Cloud::AlreadyExistsError conflict: The metadata for object ""...."" was edited during the operation. Please try again.`
- After digging into both the google cloud gem and active storage I noticed that google cloud is the only one that implements the `update_metadata` method within the `class Service::GCSService` which makes me wonder why is that the case.
- I saw that the `identify` method call in `ActiveStorage::Blob` within `upload(io, identify: true)` updates the metadata, and the analyze job also. Google Storage gem does some threads execution when calling the API which I don't fully understand, but I was wondering if there might be a race condition here, or get more info from people who have a deeper understanding of Active Storage with GCS

The code looks as simple as:
``` ruby
   class A
      has_many :media
   end

   class Media
      belongs_to :user
      has_one_attached :image
    end

    # In the controller
    attach_to = A.first

    # We get an array of directly uploaded images
    array_of_signed_ids = params[:images]
    media = array_of_signed_ids.map { |image| attach_to.media.build(image: image) }
    media.each { |m| m.save! }
    
    respond_to ... 
```

### Expected behavior
- Shouldn't raise Google::Cloud::AlreadyExistsError since we are just following the normal flow of attaching images to a model 

### Actual behavior
- Intermittently raises Google::Cloud::AlreadyExistsError 

### System configuration
**Rails version**:
7.0.4

**Ruby version**:
3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48909/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48909/timeline,,
https://api.github.com/repos/rails/rails/issues/48908,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48908/labels{/name},https://api.github.com/repos/rails/rails/issues/48908/comments,https://api.github.com/repos/rails/rails/issues/48908/events,https://github.com/rails/rails/issues/48908,1841342515,I_kwDNIULObcCoMw,48908,ActiveRecord::RecordInvalid silently ignored during create! with associations and after_create callbacks,"{'login': 'eric-christian', 'id': 298704, 'node_id': 'MDQ6VXNlcjI5ODcwNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/298704?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eric-christian', 'html_url': 'https://github.com/eric-christian', 'followers_url': 'https://api.github.com/users/eric-christian/followers', 'following_url': 'https://api.github.com/users/eric-christian/following{/other_user}', 'gists_url': 'https://api.github.com/users/eric-christian/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eric-christian/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eric-christian/subscriptions', 'organizations_url': 'https://api.github.com/users/eric-christian/orgs', 'repos_url': 'https://api.github.com/users/eric-christian/repos', 'events_url': 'https://api.github.com/users/eric-christian/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eric-christian/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,8,2023-08-08T13:38:43Z,2023-08-10T13:45:13Z,,NONE,,,,"Hello,

we noticed some inconsistent data in our database and came to the conclusion that data created within an `after_create` hook is not always present.
Our audit tool hooks itself into some of our models by using the `after_*` callbacks.
And on a rare occasion, it produced an invalid record. Causing an `ActiveRecord::RecordInvalid` to be raised within the callback.
If that happens while the audited model is used solely, everything works as intended. A rollback is issued and no incomplete data is persisted. The exception is also re-raised, which is correct in my opinion, but not what the documentation claims: https://guides.rubyonrails.org/active_record_callbacks.html#halting-execution

However, something different happens, if we try this with associated models. Both models are saved, no rollback happens, no exception bubbels up. Incomplete data is persisted because everything but the audit was commited. There is no indication that the callback failed at all.  

I was unable to find any documentation explaining this behavior.

### Steps to reproduce
```ruby
### Schema

class CreateTestAs < ActiveRecord::Migration[7.0]
  def change
    create_table :test_as do |t|
      t.timestamps
    end
  end
end

class CreateTestBs < ActiveRecord::Migration[7.0]
  def change
    create_table :test_bs do |t|
      t.references :test_a
      t.timestamps
    end
  end
end

### Models

class TestA < ApplicationRecord
  has_one :test_b
end

class TestB < ApplicationRecord
  after_create(-> { raise ActiveRecord::RecordInvalid }) # simulating the broken audit-tool behavior
end
```

### Expected behavior
The expectation is that `TestA.create!(test_b: TestB.new)` issues a rollback and raises the same exception as `TestB.create!` does. No data should be persisted.

### Actual behavior
While `TestB.create!`, as expected, raises an `ActiveRecord::RecordInvalid` exception and issues a rollback. `TestA.create!(test_b: TestB.new)` does not. Instead, both instances of TestA and TestB are persisted. The exception is silently ignored!

```bash
[1] pry(main)> TestB.create!
  TRANSACTION (0.5ms)  BEGIN
  TestB Create (1.8ms)  INSERT INTO ""test_bs"" (""test_a_id"", ""created_at"", ""updated_at"") VALUES ($1, $2, $3) RETURNING ""id""  [[""test_a_id"", nil], [""created_at"", ""2023-08-08 12:29:45.686484""], [""updated_at"", ""2023-08-08 12:29:45.686484""]]
  TRANSACTION (0.6ms)  ROLLBACK
ActiveRecord::RecordInvalid: Record invalid

[2] pry(main)> TestA.create!(test_b: TestB.new)
  TRANSACTION (1.4ms)  BEGIN
  TestA Create (7.6ms)  INSERT INTO ""test_as"" (""created_at"", ""updated_at"") VALUES ($1, $2) RETURNING ""id""  [[""created_at"", ""2023-08-08 12:30:30.200175""], [""updated_at"", ""2023-08-08 12:30:30.200175""]]
  TestB Create (1.3ms)  INSERT INTO ""test_bs"" (""test_a_id"", ""created_at"", ""updated_at"") VALUES ($1, $2, $3) RETURNING ""id""  [[""test_a_id"", 13], [""created_at"", ""2023-08-08 12:30:30.208412""], [""updated_at"", ""2023-08-08 12:30:30.208412""]]
  TRANSACTION (7.7ms)  COMMIT
```

### System configuration
**Rails version**: 7.0.6

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48908/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48908/timeline,,
https://api.github.com/repos/rails/rails/issues/48892,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48892/labels{/name},https://api.github.com/repos/rails/rails/issues/48892/comments,https://api.github.com/repos/rails/rails/issues/48892/events,https://github.com/rails/rails/pull/48892,1837692578,PR_kwDNIULOVz9CCg,48892,Draft | Investigate implicit recall usage in url helpers,"{'login': 'joshuay03', 'id': 54629302, 'node_id': 'MDQ6VXNlcjU0NjI5MzAy', 'avatar_url': 'https://avatars.githubusercontent.com/u/54629302?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/joshuay03', 'html_url': 'https://github.com/joshuay03', 'followers_url': 'https://api.github.com/users/joshuay03/followers', 'following_url': 'https://api.github.com/users/joshuay03/following{/other_user}', 'gists_url': 'https://api.github.com/users/joshuay03/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/joshuay03/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/joshuay03/subscriptions', 'organizations_url': 'https://api.github.com/users/joshuay03/orgs', 'repos_url': 'https://api.github.com/users/joshuay03/repos', 'events_url': 'https://api.github.com/users/joshuay03/events{/privacy}', 'received_events_url': 'https://api.github.com/users/joshuay03/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2023-08-05T10:42:54Z,2023-08-16T10:37:00Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48892', 'html_url': 'https://github.com/rails/rails/pull/48892', 'diff_url': 'https://github.com/rails/rails/pull/48892.diff', 'patch_url': 'https://github.com/rails/rails/pull/48892.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created to investigate https://github.com/rails/rails/issues/15097.

### Detail

This Pull Request changes [REPLACE ME]

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

I noticed that options are also extracted from the recall here:
https://github.com/rails/rails/blob/d73daaca479ac50ef2983d3f0af3ae16af738cf0/actionpack/lib/action_dispatch/routing/route_set.rb#L738-L747

But the `id` is never extracted (in the case of my test) since the `controller` doesn't get extracted in the first place as `segment_keys.include?(key)` returns `false` here:
https://github.com/rails/rails/blob/d73daaca479ac50ef2983d3f0af3ae16af738cf0/actionpack/lib/action_dispatch/routing/route_set.rb#L712

I'm unsure of the usecase for using the recall like this, just thought I'd point it out since it's relevant.

**Edit:** I'm guessing this is utilised in mailers going off of the documentation added here: https://github.com/rails/rails/pull/20631?

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48892/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48892/timeline,,
https://api.github.com/repos/rails/rails/issues/48885,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48885/labels{/name},https://api.github.com/repos/rails/rails/issues/48885/comments,https://api.github.com/repos/rails/rails/issues/48885/events,https://github.com/rails/rails/pull/48885,1836498633,PR_kwDNIULOVy8rpQ,48885,I18n record not destroyed,"{'login': 'enmy', 'id': 7958278, 'node_id': 'MDQ6VXNlcjc5NTgyNzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7958278?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/enmy', 'html_url': 'https://github.com/enmy', 'followers_url': 'https://api.github.com/users/enmy/followers', 'following_url': 'https://api.github.com/users/enmy/following{/other_user}', 'gists_url': 'https://api.github.com/users/enmy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/enmy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/enmy/subscriptions', 'organizations_url': 'https://api.github.com/users/enmy/orgs', 'repos_url': 'https://api.github.com/users/enmy/repos', 'events_url': 'https://api.github.com/users/enmy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/enmy/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-08-04T10:39:19Z,2023-08-10T20:41:06Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48885', 'html_url': 'https://github.com/rails/rails/pull/48885', 'diff_url': 'https://github.com/rails/rails/pull/48885.diff', 'patch_url': 'https://github.com/rails/rails/pull/48885.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because you couldn't change the `ActiveRecord::Persistence` exception message, meaning the message was `""Failed to destroy #{model} with #{key}""` even if it wasn't an english language app.

### Detail

This Pull Request changes the `ActiveRecord::Persistence` exception message to allow i18n on it.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [ ] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48885/reactions', 'total_count': 7, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 3, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48885/timeline,,
https://api.github.com/repos/rails/rails/issues/48878,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48878/labels{/name},https://api.github.com/repos/rails/rails/issues/48878/comments,https://api.github.com/repos/rails/rails/issues/48878/events,https://github.com/rails/rails/issues/48878,1835744145,I_kwDNIULObWs7kQ,48878,"ActionController::PermissionsPolicy does not define ""Permissions-Policy"" but ""Feature-Policy""","{'login': 'mikevoets', 'id': 4422159, 'node_id': 'MDQ6VXNlcjQ0MjIxNTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4422159?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mikevoets', 'html_url': 'https://github.com/mikevoets', 'followers_url': 'https://api.github.com/users/mikevoets/followers', 'following_url': 'https://api.github.com/users/mikevoets/following{/other_user}', 'gists_url': 'https://api.github.com/users/mikevoets/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mikevoets/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mikevoets/subscriptions', 'organizations_url': 'https://api.github.com/users/mikevoets/orgs', 'repos_url': 'https://api.github.com/users/mikevoets/repos', 'events_url': 'https://api.github.com/users/mikevoets/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mikevoets/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2023-08-03T21:14:55Z,2023-08-03T21:20:00Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# config/initializers/permissions_policy.rb

Rails.application.config.permissions_policy do |f|
  f.camera      :none
  f.gyroscope   :none
  f.microphone  :none
  f.usb         :none
  f.fullscreen  :self
  f.payment     :self
end
```

### Expected behavior
This adds the following to the response headers:

Permissions-Policy: camera=(), gyroscope=(), microphone=(), usb=(), fullscreen=(self), payment=(self)

### Actual behavior
This adds the following to the response headers:

Feature-Policy: camera 'none'; gyroscope 'none'; microphone 'none'; usb 'none'; fullscreen 'self'; payment 'self'

### System configuration
**Rails version**: 7.0.6

**Ruby version**: 3.0.6p216
","{'url': 'https://api.github.com/repos/rails/rails/issues/48878/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48878/timeline,,
https://api.github.com/repos/rails/rails/issues/48849,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48849/labels{/name},https://api.github.com/repos/rails/rails/issues/48849/comments,https://api.github.com/repos/rails/rails/issues/48849/events,https://github.com/rails/rails/pull/48849,1827476822,PR_kwDNIULOVrXWxQ,48849,[Fix #43638] Fix fixtures for namespaced models,"{'login': 'macuk', 'id': 56448, 'node_id': 'MDQ6VXNlcjU2NDQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/56448?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/macuk', 'html_url': 'https://github.com/macuk', 'followers_url': 'https://api.github.com/users/macuk/followers', 'following_url': 'https://api.github.com/users/macuk/following{/other_user}', 'gists_url': 'https://api.github.com/users/macuk/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/macuk/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/macuk/subscriptions', 'organizations_url': 'https://api.github.com/users/macuk/orgs', 'repos_url': 'https://api.github.com/users/macuk/repos', 'events_url': 'https://api.github.com/users/macuk/events{/privacy}', 'received_events_url': 'https://api.github.com/users/macuk/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-29T13:21:06Z,2023-07-29T13:26:16Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48849', 'html_url': 'https://github.com/rails/rails/pull/48849', 'diff_url': 'https://github.com/rails/rails/pull/48849.diff', 'patch_url': 'https://github.com/rails/rails/pull/48849.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created to fix https://github.com/rails/rails/issues/43638

### Detail

When a new namespaced model is generated and the namespace is equal to the existing model, the generated tests fail because, in such case, fixtures are generated and loaded incorrectly.

There is a possibility to place model fixtures in subdirectories, so for `Customer` model, we can place fixtures in `test/fixtures/customers.yml` and `test/fixtures/customers/*.yml`. This is a problem when there is a namespaced model, for example `Customers::Categories` because the default fixture is placed in `test/fixtures/customers/categories.yml` and is loaded incorrectly.

This change adds `model_class` to fixtures generated for namespaced models and skips loading namespaced fixtures while a model class mismatch is detected.

<!-- ### Additional information -->

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48849/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48849/timeline,,
https://api.github.com/repos/rails/rails/issues/48874,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48874/labels{/name},https://api.github.com/repos/rails/rails/issues/48874/comments,https://api.github.com/repos/rails/rails/issues/48874/events,https://github.com/rails/rails/issues/48874,1833726665,I_kwDNIULObUxyyQ,48874,Rack::Lint on Rails,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,8,2023-07-26T12:30:45Z,2023-09-18T23:15:02Z,,MEMBER,,,,"Meta issue for adding `Rack::Lint` to Rails middleware tests.

As Rack 3 can now be used with Rails main, it is necessary to ensure that all of the middleware defined in Rails adhere to the Rack SPEC. While existing test coverage was able to find many of the incompatibilities, I've seen multiple examples of mixed case header usage left that need to be fixed. Instead of trying to `grep` or otherwise manually find these middleware that aren't adhering to the SPEC, I'd like to add Rack::Lint to (every?) middleware's unit test in Rails so that we can be sure they follow the Rack 3 SPEC programmatically.","{'url': 'https://api.github.com/repos/rails/rails/issues/48874/reactions', 'total_count': 4, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 4, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48874/timeline,,
https://api.github.com/repos/rails/rails/issues/48804,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48804/labels{/name},https://api.github.com/repos/rails/rails/issues/48804/comments,https://api.github.com/repos/rails/rails/issues/48804/events,https://github.com/rails/rails/pull/48804,1821538167,PR_kwDNIULOVmWXbQ,48804,Change lanes to update callbacks when an autosaved record already exists,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-26T04:05:40Z,2023-07-26T04:24:53Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48804', 'html_url': 'https://github.com/rails/rails/pull/48804', 'diff_url': 'https://github.com/rails/rails/pull/48804.diff', 'patch_url': 'https://github.com/rails/rails/pull/48804.patch', 'merged_at': None}","### Motivation / Background

This address the bug identified in #47171, which is occurs when an autosave is triggered in a before_create, resulting in a the create callbacks occurring twice. The second time on a record that was already persisted, but since there are no attributes changed (it's a clean record), the new record receives the default values.

Now when an autosave occurs in a before_create, we run the update callbacks as well as any create callbacks to avoid confusing situation.

### Alternatives Considered

#### 1) Call an aliased method `_update_record_without_callbacks` and return

This would avoid creating the duplicate record, but may surprise the developer if any `after_*` callbacks they were expecting didn't occur.

We wanted to retain that same guarantee.

#### 2) Raise if the record is already persisted

The previous behavior of creating multiple records may have simply gone unnoticed to users, and raising would be a breaking change.

We could roll out that behavior behind a flag and deprecation warning, but we wanted to try and solve for this edge-case.

#### 3) Return if record is already persisted and no dirty changes

Similar to the second option, silently allowing this behavior to change could have unexpected consequences.

The interesting thing was also non of the Active Record tests failed if we just stopped the callback chain there.

### Additional information

Fixes #47171","{'url': 'https://api.github.com/repos/rails/rails/issues/48804/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48804/timeline,,
https://api.github.com/repos/rails/rails/issues/48799,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48799/labels{/name},https://api.github.com/repos/rails/rails/issues/48799/comments,https://api.github.com/repos/rails/rails/issues/48799/events,https://github.com/rails/rails/pull/48799,1819685364,PR_kwDNIULOVkyKkw,48799,Clarify on how to return records in order of ids in ActiveRecord,"{'login': 'chendo', 'id': 2661, 'node_id': 'MDQ6VXNlcjI2NjE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2661?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/chendo', 'html_url': 'https://github.com/chendo', 'followers_url': 'https://api.github.com/users/chendo/followers', 'following_url': 'https://api.github.com/users/chendo/following{/other_user}', 'gists_url': 'https://api.github.com/users/chendo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/chendo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/chendo/subscriptions', 'organizations_url': 'https://api.github.com/users/chendo/orgs', 'repos_url': 'https://api.github.com/users/chendo/repos', 'events_url': 'https://api.github.com/users/chendo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/chendo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-25T07:01:29Z,2023-08-02T15:59:42Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48799', 'html_url': 'https://github.com/rails/rails/pull/48799', 'diff_url': 'https://github.com/rails/rails/pull/48799.diff', 'patch_url': 'https://github.com/rails/rails/pull/48799.patch', 'merged_at': None}","#### Motivation

I was bitten by a subtle bug where code was depending on the order of records being returned by `.find`, however turns out `reorder("""")` does not actually clear the order scope, which meant that the order of results was not the order of the ids being passed in.

This change makes it clearer what is required to have records be returned in order.","{'url': 'https://api.github.com/repos/rails/rails/issues/48799/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48799/timeline,,
https://api.github.com/repos/rails/rails/issues/48797,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48797/labels{/name},https://api.github.com/repos/rails/rails/issues/48797/comments,https://api.github.com/repos/rails/rails/issues/48797/events,https://github.com/rails/rails/issues/48797,1819038102,I_kwDNIULObGxRlg,48797,Changing Encryption Field to Deterministic Causes Encryption Errors,"{'login': 'aveedibya', 'id': 5461802, 'node_id': 'MDQ6VXNlcjU0NjE4MDI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5461802?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/aveedibya', 'html_url': 'https://github.com/aveedibya', 'followers_url': 'https://api.github.com/users/aveedibya/followers', 'following_url': 'https://api.github.com/users/aveedibya/following{/other_user}', 'gists_url': 'https://api.github.com/users/aveedibya/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/aveedibya/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/aveedibya/subscriptions', 'organizations_url': 'https://api.github.com/users/aveedibya/orgs', 'repos_url': 'https://api.github.com/users/aveedibya/repos', 'events_url': 'https://api.github.com/users/aveedibya/events{/privacy}', 'received_events_url': 'https://api.github.com/users/aveedibya/received_events', 'type': 'User', 'site_admin': False}","[{'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,1,2023-07-24T19:52:06Z,2023-07-26T23:15:02Z,,NONE,,,,"Wondering if there is a way to read an encrypted field after changing its encryption to `deterministic`? Seems like currently there is no way in Rails to read the field's value if the field was set to `non-deterministic` (default way)  and then changed to `deterministic`.

<div class=""message mb-1"" style=""box-sizing: border-box; margin: 0px 12px; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; color: rgb(33, 37, 41); font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"">ActiveRecord::Encryption::Errors::Decryption: ActiveRecord::Encryption::Errors::Decryption</div>

56 | uncompress_if_needed(cipher.decrypt(message, key: keys.collect(&:secret), **cipher_options), message.headers.compressed)
-- | --
57 | rescue *(ENCODING_ERRORS + DECRYPT_ERRORS)
58 | raise Errors::Decryption
59 | end

Versions in use:
ruby ""3.1.2""
gem ""rails"", ""~> 7.0.3""
","{'url': 'https://api.github.com/repos/rails/rails/issues/48797/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48797/timeline,,
https://api.github.com/repos/rails/rails/issues/48790,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48790/labels{/name},https://api.github.com/repos/rails/rails/issues/48790/comments,https://api.github.com/repos/rails/rails/issues/48790/events,https://github.com/rails/rails/issues/48790,1817396793,I_kwDNIULObFNGOQ,48790,URL of attachments inside ActionText content are wrong when content is rendered within background jobs,"{'login': 'Benratelade', 'id': 8875705, 'node_id': 'MDQ6VXNlcjg4NzU3MDU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8875705?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Benratelade', 'html_url': 'https://github.com/Benratelade', 'followers_url': 'https://api.github.com/users/Benratelade/followers', 'following_url': 'https://api.github.com/users/Benratelade/following{/other_user}', 'gists_url': 'https://api.github.com/users/Benratelade/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Benratelade/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Benratelade/subscriptions', 'organizations_url': 'https://api.github.com/users/Benratelade/orgs', 'repos_url': 'https://api.github.com/users/Benratelade/repos', 'events_url': 'https://api.github.com/users/Benratelade/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Benratelade/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,1,2023-07-24T00:48:22Z,2023-08-09T06:53:58Z,,NONE,,,,"### Steps to reproduce
I couldn't figure out how to use the scripts to replicate the issue, since I had to include background jobs and ActionText with ActiveRecord. Instead, I put together a simple Rails app with a test case that shows the problem. Hopefully that's enough. 

You can find the app here: https://github.com/Benratelade/rails-workers-routing-bug 

### Expected behavior
The `src` of images inside the ActionText should match that of the rest of the Rails app when the content is rendered within a Sidekiq job. 

### Actual behavior
The `src` of images inside the ActionText uses `http://example.org` and ignores the Rails app config, but only when the content is rendered synchronously. 

### System configuration
**Rails version**: 7.0.3

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48790/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48790/timeline,,
https://api.github.com/repos/rails/rails/issues/48787,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48787/labels{/name},https://api.github.com/repos/rails/rails/issues/48787/comments,https://api.github.com/repos/rails/rails/issues/48787/events,https://github.com/rails/rails/issues/48787,1816764710,I_kwDNIULObEmhJg,48787,Combing tagged logger without block and with block leaks tags across threads,"{'login': 'erikbelusic', 'id': 4841877, 'node_id': 'MDQ6VXNlcjQ4NDE4Nzc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4841877?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/erikbelusic', 'html_url': 'https://github.com/erikbelusic', 'followers_url': 'https://api.github.com/users/erikbelusic/followers', 'following_url': 'https://api.github.com/users/erikbelusic/following{/other_user}', 'gists_url': 'https://api.github.com/users/erikbelusic/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/erikbelusic/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/erikbelusic/subscriptions', 'organizations_url': 'https://api.github.com/users/erikbelusic/orgs', 'repos_url': 'https://api.github.com/users/erikbelusic/repos', 'events_url': 'https://api.github.com/users/erikbelusic/events{/privacy}', 'received_events_url': 'https://api.github.com/users/erikbelusic/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,1,2023-07-22T13:24:34Z,2023-09-07T16:15:43Z,,NONE,,,,"Using the tagged logger without a block does not appear to have the same threaded isolation that tagging with a block has. The documentation doesn't make it clear if its intended or not, but from a user's perspective, it is unexpected. From the existing tests, it looks like some of this is expected, but the inconsistency is confusing. I left a comment on the original PR to try and get some insight.

This could be in some ways related to https://github.com/rails/rails/issues/46084 - however the focus of that is broadcast logging and not threading, however the issues seem similar - tag leak.

### Steps to reproduce
This example currently relies on identical setup to what is in `activesupport/test/tagged_logging_test.rb` which should make it easy to add these tests or some modified versions if its agreed this is a bug.
```
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""active_support""
require ""active_support/core_ext/object/blank""
require ""minitest/autorun""

class BugTest < Minitest::Test
  # Copied from activesupport/test/tagged_logging_test.rb
  class MyLogger < ::ActiveSupport::Logger
    def flush(*)
      info ""[FLUSHED]""
    end
  end

  # Copied from activesupport/test/tagged_logging_test.rb
  def setup
    @output = StringIO.new
    @logger = ActiveSupport::TaggedLogging.new(MyLogger.new(@output))
  end

  # Copied from activesupport/test/tagged_logging_test.rb:80
  def test_keeps_each_tag_in_their_own_thread
    @logger.tagged(""BCX"") do
      Thread.new do
        @logger.info ""Dull story""
        @logger.tagged(""OMG"") { @logger.info ""Cool story"" }
      end.join
      @logger.info ""Funky time""
    end
    assert_equal ""Dull story\n[OMG] Cool story\n[BCX] Funky time\n"", @output.string
  end
  # PASS output:
  # Dull story
  # [OMG] Cool story
  # [BCX] Funky time

  def test_keeps_each_tag_in_their_own_thread_using_tagged_without_block
    logger1 = @logger.tagged(""BCX"")
    Thread.new do
      logger1.info ""Dull story""
      logger2 = logger1.tagged(""OMG"")
      logger2.info ""Cool story""
    end.join
    logger1.info ""Funky time""

    assert_equal ""Dull story\n[OMG] Cool story\n[BCX] Funky time\n"", @output.string
  end
  # FAIL output:
  # [BCX] Dull story
  # [BCX] [OMG] Cool story
  # [BCX] Funky time

  def test_keeps_each_tag_in_their_own_thread_using_tagged_without_block_combined_with_tagged_block
    logger1 = @logger.tagged(""BCX"")
    Thread.new do
      logger1.info ""Dull story""
      logger1.tagged(""OMG"") { logger1.info ""Cool story"" }
    end.join
    logger1.info ""Funky time""

    assert_equal ""Dull story\n[OMG] Cool story\n[BCX] Funky time\n"", @output.string
  end
  # FAIL output:
  # [BCX] Dull story
  # [BCX] [OMG] Cool story
  # [BCX] Funky time

  def test_keeps_each_tag_in_their_own_thread_using_tagged_without_block_combined_with_tagged_block_nested
    logger = @logger.tagged(""BASE_TAG"")
    logger.tagged(""BCX"") do
      Thread.new do
        logger.info ""Dull story""
        logger.tagged(""OMG"") { logger.info ""Cool story"" }
      end.join
      logger.info ""Funky time""
    end
    assert_equal ""[BASE_TAG] Dull story\n[BASE_TAG] [OMG] Cool story\n[BASE_TAG] [BCX] Funky time\n"", @output.string
  end
  # FAIL output:
  # [BASE_TAG] [BCX] Dull story
  # [BASE_TAG] [BCX] [OMG] Cool story
  # [BASE_TAG] [BCX] Funky time
end
```

### Expected behavior
I would expect that if `#tagged` has a certain level of thread isolation, it should always have that isolation and behave consistently. At a minimum `test_keeps_each_tag_in_their_own_thread_using_tagged_without_block_combined_with_tagged_block_nested` should pass. It seems awkward that depending on how your current logger instance was created, the behavior of tagging with a block could change. I think it is worth a conversation on the correct behavior here, as maybe my first two failures should remain failures due to some context or intent I am unaware of.

### Actual behavior
1. When using a new logger created from `#tagged`, tags are shared across threads
2. When tagging with a block from a logger instance created from `#tagged`, all tags are shared

### System configuration
**Rails version**: main

**Ruby version**: 3.0.0
","{'url': 'https://api.github.com/repos/rails/rails/issues/48787/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48787/timeline,,
https://api.github.com/repos/rails/rails/issues/48785,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48785/labels{/name},https://api.github.com/repos/rails/rails/issues/48785/comments,https://api.github.com/repos/rails/rails/issues/48785/events,https://github.com/rails/rails/pull/48785,1816415292,PR_kwDNIULOViFuCg,48785,Fix child association loading in `:n_plus_one_only` mode,"{'login': 'reid-rigo', 'id': 2439912, 'node_id': 'MDQ6VXNlcjI0Mzk5MTI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2439912?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/reid-rigo', 'html_url': 'https://github.com/reid-rigo', 'followers_url': 'https://api.github.com/users/reid-rigo/followers', 'following_url': 'https://api.github.com/users/reid-rigo/following{/other_user}', 'gists_url': 'https://api.github.com/users/reid-rigo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/reid-rigo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/reid-rigo/subscriptions', 'organizations_url': 'https://api.github.com/users/reid-rigo/orgs', 'repos_url': 'https://api.github.com/users/reid-rigo/repos', 'events_url': 'https://api.github.com/users/reid-rigo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/reid-rigo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-07-21T21:44:39Z,2023-10-04T14:34:53Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48785', 'html_url': 'https://github.com/rails/rails/pull/48785', 'diff_url': 'https://github.com/rails/rails/pull/48785.diff', 'patch_url': 'https://github.com/rails/rails/pull/48785.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

Fixes #49473

Strict loading in `:n_plus_one_only` mode is designed to prevent performance issues when deeply traversing associations. It allows `Person.find(1).posts`, but _not_ `Person.find(1).posts.map(&:category)`. This fix avoids the surprise that occurs when `person.posts.first` eagerly loads the whole association rather than allowing the user to manage the child association.

This fixes a serious ordering issue. Without strict loading, `person.posts.first` is guaranteed to return the first post in primary key order. On the other hand, `person.posts.load.first` is nondeterministic. The database is not guaranteed to return in a consistent order, in particular under load with other operations occurring. This is a rude surprise when trying to use `:n_plus_one_only` mode.

### Detail

Before:

```ruby
person = Person.find(1)
person.strict_loading!(mode: :n_plus_one_only)
person.posts.first
# SELECT * FROM posts WHERE person_id = 1; -- non-deterministic order
```

After:

```ruby
person = Person.find(1)
person.strict_loading!(mode: :n_plus_one_only)
person.posts.first # this is 1+1, not N+1
# SELECT * FROM posts WHERE person_id = 1 ORDER BY id LIMIT 1;
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48785/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48785/timeline,,
https://api.github.com/repos/rails/rails/issues/48782,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48782/labels{/name},https://api.github.com/repos/rails/rails/issues/48782/comments,https://api.github.com/repos/rails/rails/issues/48782/events,https://github.com/rails/rails/pull/48782,1816121950,PR_kwDNIULOVh11hg,48782,Only show SMTP envelope recipient when relevant,"{'login': 'c960657', 'id': 111346, 'node_id': 'MDQ6VXNlcjExMTM0Ng==', 'avatar_url': 'https://avatars.githubusercontent.com/u/111346?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/c960657', 'html_url': 'https://github.com/c960657', 'followers_url': 'https://api.github.com/users/c960657/followers', 'following_url': 'https://api.github.com/users/c960657/following{/other_user}', 'gists_url': 'https://api.github.com/users/c960657/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/c960657/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/c960657/subscriptions', 'organizations_url': 'https://api.github.com/users/c960657/orgs', 'repos_url': 'https://api.github.com/users/c960657/repos', 'events_url': 'https://api.github.com/users/c960657/events{/privacy}', 'received_events_url': 'https://api.github.com/users/c960657/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-21T17:03:49Z,2023-07-25T11:18:47Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48782', 'html_url': 'https://github.com/rails/rails/pull/48782', 'diff_url': 'https://github.com/rails/rails/pull/48782.diff', 'patch_url': 'https://github.com/rails/rails/pull/48782.patch', 'merged_at': None}","### Motivation
The SMTP envelope recipient usually reflects the `To`, `Cc` and `Bcc` email headers. The mailer preview only shows SMTP the envelope recipient (SMTP-To) if it differs from `To`, but it does not take Cc and Bcc into account.

Screenshot:
![image](https://github.com/rails/rails/assets/111346/5ea59067-4c5c-480e-b550-e22ecfdc306c)

### Detail
This Pull Request extends the check for SMTP-To to cover also `Cc` and `Bcc`, so it is only displayed in the rare event that the envelope recipient has been manually overriden.

Also, show the list of email addresses without array brackets and quotes.

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

","{'url': 'https://api.github.com/repos/rails/rails/issues/48782/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48782/timeline,,
https://api.github.com/repos/rails/rails/issues/48781,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48781/labels{/name},https://api.github.com/repos/rails/rails/issues/48781/comments,https://api.github.com/repos/rails/rails/issues/48781/events,https://github.com/rails/rails/pull/48781,1816091927,PR_kwDNIULOVh0OaA,48781,Detect if the editor is missing a wait flag and print a warning,"{'login': 'LukasSkywalker', 'id': 282447, 'node_id': 'MDQ6VXNlcjI4MjQ0Nw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/282447?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/LukasSkywalker', 'html_url': 'https://github.com/LukasSkywalker', 'followers_url': 'https://api.github.com/users/LukasSkywalker/followers', 'following_url': 'https://api.github.com/users/LukasSkywalker/following{/other_user}', 'gists_url': 'https://api.github.com/users/LukasSkywalker/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/LukasSkywalker/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/LukasSkywalker/subscriptions', 'organizations_url': 'https://api.github.com/users/LukasSkywalker/orgs', 'repos_url': 'https://api.github.com/users/LukasSkywalker/repos', 'events_url': 'https://api.github.com/users/LukasSkywalker/events{/privacy}', 'received_events_url': 'https://api.github.com/users/LukasSkywalker/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-21T16:37:31Z,2023-07-21T16:40:49Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48781', 'html_url': 'https://github.com/rails/rails/pull/48781', 'diff_url': 'https://github.com/rails/rails/pull/48781.diff', 'patch_url': 'https://github.com/rails/rails/pull/48781.patch', 'merged_at': None}","### Motivation / Background

The current code for commands such as `credentials:edit` detects whether $EDITOR or $VISUAL are set, and tells the developer to set them to something like `EDITOR=mate --wait` if they are not. On systems where $EDITOR is set, but it launches a forking process, the message is not displayed and may never be seen by the developer.

### Description

This change detects whether the editor for commands like `credentials:edit` exits in less than one second, such as when `EDITOR` is set to `mate` without the wait flag. This is a sign that the editor process is forking and exited immediately, and that the developer didn't have a chance to edit the file.

If an immediate exit is detected, a message is printed that the editor command should be changed to wait instead of exiting.","{'url': 'https://api.github.com/repos/rails/rails/issues/48781/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48781/timeline,,
https://api.github.com/repos/rails/rails/issues/48775,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48775/labels{/name},https://api.github.com/repos/rails/rails/issues/48775/comments,https://api.github.com/repos/rails/rails/issues/48775/events,https://github.com/rails/rails/issues/48775,1814805867,I_kwDNIULObCu9aw,48775,"Arel table alias breaks insert, update, and delete statements","{'login': 'lavoiesl', 'id': 1216046, 'node_id': 'MDQ6VXNlcjEyMTYwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1216046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lavoiesl', 'html_url': 'https://github.com/lavoiesl', 'followers_url': 'https://api.github.com/users/lavoiesl/followers', 'following_url': 'https://api.github.com/users/lavoiesl/following{/other_user}', 'gists_url': 'https://api.github.com/users/lavoiesl/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lavoiesl/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lavoiesl/subscriptions', 'organizations_url': 'https://api.github.com/users/lavoiesl/orgs', 'repos_url': 'https://api.github.com/users/lavoiesl/repos', 'events_url': 'https://api.github.com/users/lavoiesl/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lavoiesl/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-07-20T21:10:55Z,2023-08-08T01:17:57Z,,NONE,,,,"### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.0.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string ""name""
  end
end

class Post < ActiveRecord::Base
end


class BugTest < Minitest::Test
  def setup
    Post.arel_table.table_alias = nil
  end

  def test_select
    assert_equal('SELECT ""posts"".* FROM ""posts""', Post.all.to_sql)
  end

  def test_select_alias
    Post.arel_table.table_alias = ""p""
    assert_equal('SELECT ""p"".* FROM ""posts"" ""p""', Post.all.to_sql)
  end

  def test_insert
    post = Post.create!
    refute_nil(post)
  end

  def test_insert_alias
    Post.arel_table.table_alias = ""p""
    e = assert_raises(ActiveRecord::StatementInvalid) do
      Post.create!
    end
    assert_equal('INSERT INTO ""posts"" ""p"" DEFAULT VALUES', e.sql)
    assert_equal('SQLite3::SQLException: near """"p"""": syntax error', e.message)
  end

  def test_update
    post = Post.create!
    refute_nil(post)
    post.name = ""foo""
    post.save!
  end

  def test_update_alias
    post = Post.create!
    refute_nil(post)

    Post.arel_table.table_alias = ""p""
    e = assert_raises(ActiveRecord::StatementInvalid) do
      post.name = ""foo""
      post.save!
    end
    assert_equal('UPDATE ""posts"" ""p"" SET ""name"" = ? WHERE ""p"".""id"" = ?', e.sql)
    assert_equal('SQLite3::SQLException: near """"p"""": syntax error', e.message)
  end

  def test_delete
    post = Post.create!
    refute_nil(post)
    post.delete
  end

  def test_delete_alias
    post = Post.create!
    refute_nil(post)

    Post.arel_table.table_alias = ""p""
    e = assert_raises(ActiveRecord::StatementInvalid) do
      post.delete
    end
    assert_equal('DELETE FROM ""posts"" ""p"" WHERE ""p"".""id"" = ?', e.sql)
    assert_equal('SQLite3::SQLException: near """"p"""": syntax error', e.message)
  end
end
```

### Expected behavior
The table alias is valid on SELECTs, but not on INSERT, UPDATE, or DELETE statements.
The example is with sqlite, but [MySQL has similar rules where it specifically asks for a table _name_](https://dev.mysql.com/doc/refman/8.0/en/insert.html).

I would expect Arel to _NOT_ use the alias on insert, update, and delete statements

### System configuration
**Rails version**:
6.1.7.4

**Ruby version**:
3.2.2

**MySQL**:
MySQL 5.7, using the mysql2 0.5.5 gem","{'url': 'https://api.github.com/repos/rails/rails/issues/48775/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48775/timeline,,
https://api.github.com/repos/rails/rails/issues/48767,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48767/labels{/name},https://api.github.com/repos/rails/rails/issues/48767/comments,https://api.github.com/repos/rails/rails/issues/48767/events,https://github.com/rails/rails/pull/48767,1812829600,PR_kwDNIULOVfCRww,48767,Prevent header wrapping in email preview,"{'login': 'c960657', 'id': 111346, 'node_id': 'MDQ6VXNlcjExMTM0Ng==', 'avatar_url': 'https://avatars.githubusercontent.com/u/111346?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/c960657', 'html_url': 'https://github.com/c960657', 'followers_url': 'https://api.github.com/users/c960657/followers', 'following_url': 'https://api.github.com/users/c960657/following{/other_user}', 'gists_url': 'https://api.github.com/users/c960657/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/c960657/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/c960657/subscriptions', 'organizations_url': 'https://api.github.com/users/c960657/orgs', 'repos_url': 'https://api.github.com/users/c960657/repos', 'events_url': 'https://api.github.com/users/c960657/events{/privacy}', 'received_events_url': 'https://api.github.com/users/c960657/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-19T22:33:35Z,2023-07-21T11:40:33Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48767', 'html_url': 'https://github.com/rails/rails/pull/48767', 'diff_url': 'https://github.com/rails/rails/pull/48767.diff', 'patch_url': 'https://github.com/rails/rails/pull/48767.patch', 'merged_at': None}","### Motivation / Background
In the all header view in email previews, header names may wrap if the header value is very long (see screenshot). Header names are usually short, so I suggest we don't wrap those.

### Screenshot
#### Before
<img width=""668"" alt=""image"" src=""https://github.com/rails/rails/assets/111346/d1949ad5-2a3d-4c3a-9f25-cd55b3b272a4"">

#### After
<img width=""731"" alt=""image"" src=""https://github.com/rails/rails/assets/111346/72cb2aea-55bd-4e38-8e78-307d500dc512"">


### Checklist
* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [n/a] Tests are added or updated if you fix a bug or add a feature.
* [n/a] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48767/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48767/timeline,,
https://api.github.com/repos/rails/rails/issues/48764,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48764/labels{/name},https://api.github.com/repos/rails/rails/issues/48764/comments,https://api.github.com/repos/rails/rails/issues/48764/events,https://github.com/rails/rails/issues/48764,1812566337,I_kwDNIULObAmRQQ,48764,Encrypted columns are not decrypted when used in group operations across joins,"{'login': 'TikiTDO', 'id': 326184, 'node_id': 'MDQ6VXNlcjMyNjE4NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/326184?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/TikiTDO', 'html_url': 'https://github.com/TikiTDO', 'followers_url': 'https://api.github.com/users/TikiTDO/followers', 'following_url': 'https://api.github.com/users/TikiTDO/following{/other_user}', 'gists_url': 'https://api.github.com/users/TikiTDO/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/TikiTDO/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/TikiTDO/subscriptions', 'organizations_url': 'https://api.github.com/users/TikiTDO/orgs', 'repos_url': 'https://api.github.com/users/TikiTDO/repos', 'events_url': 'https://api.github.com/users/TikiTDO/events{/privacy}', 'received_events_url': 'https://api.github.com/users/TikiTDO/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,0,2023-07-19T19:10:23Z,2023-07-19T19:42:54Z,,NONE,,,,"### Steps to reproduce

1. Create a DB entry with an encrypted deterministic column as per: https://guides.rubyonrails.org/active_record_encryption.html#deterministic-and-non-deterministic-encryption

Run the following code on a server with the encryption key:

```ruby
Article.joins(:author).group(:email).count
```

### Expected behavior

```ruby
=> {""email@example.com""=>111,
 ""email@example.com""=>222}
```

### Actual behavior

```ruby
=> {""{\""p\"":\""tHc=\"",\""h\"":{\""iv\"":\""AUAnaod3vn4ThiCq\"",\""at\"":\""tNCqVTXFXsTu/7b22+KJkQ==\""}}""=>111,
 ""{\""p\"":\""vXw=\"",\""h\"":{\""iv\"":\""GzjQbfA1erPDJGcG\"",\""at\"":\""cSCrtBxMJuJI/belpvaGtQ==\""}}""=>222}
```


### System configuration
**Rails version**: 7.0.6

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48764/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48764/timeline,,
https://api.github.com/repos/rails/rails/issues/48757,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48757/labels{/name},https://api.github.com/repos/rails/rails/issues/48757/comments,https://api.github.com/repos/rails/rails/issues/48757/events,https://github.com/rails/rails/pull/48757,1809802708,PR_kwDNIULOVcd36Q,48757,Draft | Investigate `has_many` `through` polymorphic with `where`,"{'login': 'joshuay03', 'id': 54629302, 'node_id': 'MDQ6VXNlcjU0NjI5MzAy', 'avatar_url': 'https://avatars.githubusercontent.com/u/54629302?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/joshuay03', 'html_url': 'https://github.com/joshuay03', 'followers_url': 'https://api.github.com/users/joshuay03/followers', 'following_url': 'https://api.github.com/users/joshuay03/following{/other_user}', 'gists_url': 'https://api.github.com/users/joshuay03/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/joshuay03/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/joshuay03/subscriptions', 'organizations_url': 'https://api.github.com/users/joshuay03/orgs', 'repos_url': 'https://api.github.com/users/joshuay03/repos', 'events_url': 'https://api.github.com/users/joshuay03/events{/privacy}', 'received_events_url': 'https://api.github.com/users/joshuay03/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-18T12:12:34Z,2023-07-18T12:25:46Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48757', 'html_url': 'https://github.com/rails/rails/pull/48757', 'diff_url': 'https://github.com/rails/rails/pull/48757.diff', 'patch_url': 'https://github.com/rails/rails/pull/48757.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created to investigate https://github.com/rails/rails/issues/40109 and https://github.com/rails/rails/issues/34613.

### Detail

This Pull Request changes [REPLACE ME]

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [ ] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48757/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48757/timeline,,
https://api.github.com/repos/rails/rails/issues/48756,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48756/labels{/name},https://api.github.com/repos/rails/rails/issues/48756/comments,https://api.github.com/repos/rails/rails/issues/48756/events,https://github.com/rails/rails/pull/48756,1809556037,PR_kwDNIULOVcQTng,48756,[Docs] Improve `set_load_path` documentation,"{'login': 'iMacTia', 'id': 2527520, 'node_id': 'MDQ6VXNlcjI1Mjc1MjA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2527520?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/iMacTia', 'html_url': 'https://github.com/iMacTia', 'followers_url': 'https://api.github.com/users/iMacTia/followers', 'following_url': 'https://api.github.com/users/iMacTia/following{/other_user}', 'gists_url': 'https://api.github.com/users/iMacTia/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/iMacTia/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/iMacTia/subscriptions', 'organizations_url': 'https://api.github.com/users/iMacTia/orgs', 'repos_url': 'https://api.github.com/users/iMacTia/repos', 'events_url': 'https://api.github.com/users/iMacTia/events{/privacy}', 'received_events_url': 'https://api.github.com/users/iMacTia/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-07-18T09:37:05Z,2023-07-18T09:55:30Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48756', 'html_url': 'https://github.com/rails/rails/pull/48756', 'diff_url': 'https://github.com/rails/rails/pull/48756.diff', 'patch_url': 'https://github.com/rails/rails/pull/48756.patch', 'merged_at': None}","### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because I needed to add a custom folder to `$LOAD_PATH` in my Rails project and I wanted to do it using the framework tools, however when I checked the documentation, I was given incorrect information that didn't work on the current release. More specifically, the existing documentation erroneously mentions `config.load_path` which was removed in Rails 3 and now replaced by `config.paths.load_paths`.

### Detail

In addition to updating the outdated reference from `config.load_path` to `config.paths.load_paths`, the new documentation explicitly lists all ""autoload paths"" for the reader which can otherwise only be known by checking the code, and mentions the `add_autoload_paths_to_load_path` config toggle.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] N/A ~Tests are added or updated if you fix a bug or add a feature.~
* [ ] N/A ~CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.~
","{'url': 'https://api.github.com/repos/rails/rails/issues/48756/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48756/timeline,,
https://api.github.com/repos/rails/rails/issues/48745,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48745/labels{/name},https://api.github.com/repos/rails/rails/issues/48745/comments,https://api.github.com/repos/rails/rails/issues/48745/events,https://github.com/rails/rails/pull/48745,1808009190,PR_kwDNIULOVa8Pzg,48745,Implemented ActiveRecord::Base.pretty_print to work with PP.,"{'login': 'osyo-manga', 'id': 214488, 'node_id': 'MDQ6VXNlcjIxNDQ4OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/214488?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/osyo-manga', 'html_url': 'https://github.com/osyo-manga', 'followers_url': 'https://api.github.com/users/osyo-manga/followers', 'following_url': 'https://api.github.com/users/osyo-manga/following{/other_user}', 'gists_url': 'https://api.github.com/users/osyo-manga/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/osyo-manga/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/osyo-manga/subscriptions', 'organizations_url': 'https://api.github.com/users/osyo-manga/orgs', 'repos_url': 'https://api.github.com/users/osyo-manga/repos', 'events_url': 'https://api.github.com/users/osyo-manga/events{/privacy}', 'received_events_url': 'https://api.github.com/users/osyo-manga/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-07-17T15:13:20Z,2023-07-19T18:35:21Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48745', 'html_url': 'https://github.com/rails/rails/pull/48745', 'diff_url': 'https://github.com/rails/rails/pull/48745.diff', 'patch_url': 'https://github.com/rails/rails/pull/48745.patch', 'merged_at': None}","### Motivation / Background

When checking what columns are defined in an arbitrary model, you may use `console` or other tools to output the model class.
However, when a model has many columns, it can be difficult to read when displayed on a single line.

```ruby
p User
# => User(id: integer, first_name: string, last_name: string, birth_at: datetime, email: string, address: string, active: boolean, parent_id: integer, type: string, created_at: datetime, updated_at: datetime)
```

NOTE: [implement ActiveRecord::Base#pretty_print by notEthan  Pull Request #15172  rails/rails](https://github.com/rails/rails/pull/15172)

### Detail

Define `ActiveRecord::Base.pretty_print` to support `pp` output.

```ruby
pp User
# => User(
#     id: integer,
#     first_name: string,
#     last_name: string,
#     birth_at: datetime,
#     email: string,
#     address: string,
#     active: boolean,
#     parent_id: integer,
#     type: string,
#     created_at: datetime,
#     updated_at: datetime)
```

The format and implementation are based on [`ActiveRecord::Base#pretty_print`](https://github.com/rails/rails/blob/e18791c0bf2e03d3e6380f69b44e946564c6f873/activerecord/lib/active_record/core.rb#L682-L705) and [`ActiveRecord::Base.inspect`](https://github.com/rails/rails/blob/e18791c0bf2e03d3e6380f69b44e946564c6f873/activerecord/lib/active_record/core.rb#L332-L346).

Note: Output of `ActiveRecord::Base#pretty_print` is as follows.

```ruby
pp User.new
# => #<User:0x00007f0431d6dc88
#     id: nil,
#     first_name: nil,
#     last_name: nil,
#     birth_at: nil,
#     email: nil,
#     address: nil,
#     active: nil,
#     parent_id: nil,
#     type: nil,
#     created_at: nil,
#     updated_at: nil>
```


### Additional information

I also found the following problem when implementing `ActiveRecord::Base#pretty_print` and have addressed it.
* [pretty_print will use #inspect if a subclass redefines it by notEthan  Pull Request #18474  rails/rails](https://github.com/rails/rails/pull/18474)


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48745/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48745/timeline,,
https://api.github.com/repos/rails/rails/issues/48741,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48741/labels{/name},https://api.github.com/repos/rails/rails/issues/48741/comments,https://api.github.com/repos/rails/rails/issues/48741/events,https://github.com/rails/rails/pull/48741,1806167793,PR_kwDNIULOVZagWA,48741,Adjust link text and add info to AV Helpers API docs,"{'login': 'mikepmunroe', 'id': 514063, 'node_id': 'MDQ6VXNlcjUxNDA2Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/514063?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mikepmunroe', 'html_url': 'https://github.com/mikepmunroe', 'followers_url': 'https://api.github.com/users/mikepmunroe/followers', 'following_url': 'https://api.github.com/users/mikepmunroe/following{/other_user}', 'gists_url': 'https://api.github.com/users/mikepmunroe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mikepmunroe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mikepmunroe/subscriptions', 'organizations_url': 'https://api.github.com/users/mikepmunroe/orgs', 'repos_url': 'https://api.github.com/users/mikepmunroe/repos', 'events_url': 'https://api.github.com/users/mikepmunroe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mikepmunroe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2023-07-15T15:21:20Z,2023-07-17T19:14:17Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48741', 'html_url': 'https://github.com/rails/rails/pull/48741', 'diff_url': 'https://github.com/rails/rails/pull/48741.diff', 'patch_url': 'https://github.com/rails/rails/pull/48741.patch', 'merged_at': None}","### Motivation / Background

This Pull Request is a follow up to #48273 
Feedback in that PR requested an adjustment to the link text in the Guide and to add some information to Action View Helpers API docs. 

### Detail

This Pull Request changes link text in a guide file and adds info to Action View Helpers API docs landing page. 

### Additional information

/cc @zzak since this PR started with me, bounced off him after a tweak, and continues with me for some extra based on feedback. 

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48741/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48741/timeline,,
https://api.github.com/repos/rails/rails/issues/48733,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48733/labels{/name},https://api.github.com/repos/rails/rails/issues/48733/comments,https://api.github.com/repos/rails/rails/issues/48733/events,https://github.com/rails/rails/pull/48733,1803173069,PR_kwDNIULOVW3KSw,48733,Allow `accepts_nested_attributes_for` to accept associated record attributes with custom primary keys,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-07-13T14:38:31Z,2023-07-20T13:39:36Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48733', 'html_url': 'https://github.com/rails/rails/pull/48733', 'diff_url': 'https://github.com/rails/rails/pull/48733.diff', 'patch_url': 'https://github.com/rails/rails/pull/48733.patch', 'merged_at': None}","Fixes #48714.

Currently, when we have an `accepts_nested_attributes_for` for a child relation with a custom primary key, when assigning child attributes we must use `""id""` key with a value to provide a primary key, which can be confusing (as in the linked issue).

Example:
```ruby
class Owner < ApplicationRecord
  has_many :pets
  accepts_nested_attributes_for :pets
end

class Pet < ApplicationRecord
  self.primary_key = :pet_id # custom primary key name
  belongs_to :owner
end
```

Before:

```ruby
owner.update(pets_attributes: { id: 2, name: ""parrot"" }) # works, because we used ""id"" as a key
owner.update(pets_attributes: { pet_id: 2, name: ""parrot"" }) # does not work
```

After - both variants are working","{'url': 'https://api.github.com/repos/rails/rails/issues/48733/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48733/timeline,,
https://api.github.com/repos/rails/rails/issues/48731,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48731/labels{/name},https://api.github.com/repos/rails/rails/issues/48731/comments,https://api.github.com/repos/rails/rails/issues/48731/events,https://github.com/rails/rails/pull/48731,1802713295,PR_kwDNIULOVWd2Xg,48731,Prevent extra newlines after table generation block in shema.rb,"{'login': 'knagode', 'id': 4473199, 'node_id': 'MDQ6VXNlcjQ0NzMxOTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4473199?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/knagode', 'html_url': 'https://github.com/knagode', 'followers_url': 'https://api.github.com/users/knagode/followers', 'following_url': 'https://api.github.com/users/knagode/following{/other_user}', 'gists_url': 'https://api.github.com/users/knagode/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/knagode/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/knagode/subscriptions', 'organizations_url': 'https://api.github.com/users/knagode/orgs', 'repos_url': 'https://api.github.com/users/knagode/repos', 'events_url': 'https://api.github.com/users/knagode/events{/privacy}', 'received_events_url': 'https://api.github.com/users/knagode/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-13T10:26:54Z,2023-07-13T15:56:45Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48731', 'html_url': 'https://github.com/rails/rails/pull/48731', 'diff_url': 'https://github.com/rails/rails/pull/48731.diff', 'patch_url': 'https://github.com/rails/rails/pull/48731.patch', 'merged_at': None}","when there are no foreign keys or indexes.  This will produce valid code without linting issues (issue: Trailing whitespace detected)


### Motivation / Background

Schema generator was generating files with linting issues (Trailing whitespace detected) **when there is no foreign_keys in the database**. Developer who care about linting has to manually fix those issues after every schema dump operation (e.g. `rails db:migrate`). 

Example of schema file **with linting issue** (extra newline on L6): 
```
ActiveRecord::Schema[7.0].define(version: 2023_03_14_145511) do
  create_table ""action_logs"", force: :cascade do |t|
    t.string ""action"", null: false
    t.index [""deleted_at""], name: ""index_action_logs_on_deleted_at""
  end

end
```

Example of schema file **without** linting issues: 

```
ActiveRecord::Schema[7.0].define(version: 2023_03_14_145511) do
  create_table ""action_logs"", force: :cascade do |t|
    t.string ""action"", null: false
    t.index [""deleted_at""], name: ""index_action_logs_on_deleted_at""
  end
end
```

### Details
We should NOT attach a newline after last table definition. Extra newline is needed only if foreign keys definitions exists in the database. 

### Checklist
 Before submitting the PR make sure the following are checked:
 
 * [x]  This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
 * [x]  Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
 * [ ]  Tests are added or updated if you fix a bug or add a feature.
 * [ ]  CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48731/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48731/timeline,,
https://api.github.com/repos/rails/rails/issues/48727,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48727/labels{/name},https://api.github.com/repos/rails/rails/issues/48727/comments,https://api.github.com/repos/rails/rails/issues/48727/events,https://github.com/rails/rails/pull/48727,1802075341,PR_kwDNIULOVV654w,48727,Fix index_errors and provide :nested_attributes_order mode,"{'login': 'lulalala', 'id': 366910, 'node_id': 'MDQ6VXNlcjM2NjkxMA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/366910?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lulalala', 'html_url': 'https://github.com/lulalala', 'followers_url': 'https://api.github.com/users/lulalala/followers', 'following_url': 'https://api.github.com/users/lulalala/following{/other_user}', 'gists_url': 'https://api.github.com/users/lulalala/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lulalala/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lulalala/subscriptions', 'organizations_url': 'https://api.github.com/users/lulalala/orgs', 'repos_url': 'https://api.github.com/users/lulalala/repos', 'events_url': 'https://api.github.com/users/lulalala/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lulalala/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-07-13T03:13:17Z,2023-08-15T03:18:04Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48727', 'html_url': 'https://github.com/rails/rails/pull/48727', 'diff_url': 'https://github.com/rails/rails/pull/48727.diff', 'patch_url': 'https://github.com/rails/rails/pull/48727.patch', 'merged_at': None}","1. Fix #24390, a bug on indexing association validation errors.
1. Add`index_errors: :nested_attributes_order` mode for an alternative ordering of errors.

### Motivation / Background

GitLab is using `index_errors` but has to [workaround its bug](https://gitlab.com/gitlab-org/gitlab/-/merge_requests/51623#note_490919557), which is #24390. That bug is about association validation error having the incorrect index because the indexing can be computed from an incomplete collection of association records. The fix would be to index from the full association collection.

@tijwelch first created https://github.com/rails/rails/pull/24728, however @markedmondson  pointed out that [`reject_if` would not work properly](https://github.com/rails/rails/pull/24728#issuecomment-321361869). Also, from the discussions I found that people have two different interpretations of what ""indexing"" means: 

1. to index by association order (based on database order), which is the current behavior
2. to index by nested attributes order (and `reject_if` is only applicable here)

Those two are conflicting goals. To cater to both of them, this PR also adds a new ordering mode called `nested_attributes_order`. This mode is more applicable to GitLab's use case, where the frontend could pass nested attributes in arbitrary order, and still want the error index to match such order.

### Detail

This Pull Request adds a new class called `ActiveRecord::Associations::NestedError`, which handles the calculation of index. The original index logic exists in `AutosaveAssociation` and is moved into this class. Base on `index_errors` setting, it would choose whether to index based on `association.target` order or nested attributes order.

For nested attributes order, when nested_attributes are assigned (via a setter like `roles_attributes=`), the array of the corresponding records will be stored in the association object as `nested_attributes_target`. The `NestedError` can then access this array to compute the index. The `reject_if` would also work since if something is rejected, the `nested_attributes_target` would have `nil` in its place as a placeholder, therefore maintaining the overall index.

### Additional information

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48727/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48727/timeline,,
https://api.github.com/repos/rails/rails/issues/48721,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48721/labels{/name},https://api.github.com/repos/rails/rails/issues/48721/comments,https://api.github.com/repos/rails/rails/issues/48721/events,https://github.com/rails/rails/issues/48721,1801229394,I_kwDNIULOa1yUUg,48721,"Calling model.decrypt saves the unencrypted entity, which breaks further access to it","{'login': 'dsusviela', 'id': 18326941, 'node_id': 'MDQ6VXNlcjE4MzI2OTQx', 'avatar_url': 'https://avatars.githubusercontent.com/u/18326941?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dsusviela', 'html_url': 'https://github.com/dsusviela', 'followers_url': 'https://api.github.com/users/dsusviela/followers', 'following_url': 'https://api.github.com/users/dsusviela/following{/other_user}', 'gists_url': 'https://api.github.com/users/dsusviela/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dsusviela/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dsusviela/subscriptions', 'organizations_url': 'https://api.github.com/users/dsusviela/orgs', 'repos_url': 'https://api.github.com/users/dsusviela/repos', 'events_url': 'https://api.github.com/users/dsusviela/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dsusviela/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,3,2023-07-12T15:25:26Z,2023-07-16T15:51:41Z,,CONTRIBUTOR,,,,"### Steps to reproduce

1. Create a model with AR encryption on one of the fields
2. Make sure the chosen field has deterministic encryption
3. Go into the rails console
4. Create an entity of this model, and save it
5. Call `#decrypt`
6. Do `Model.find(:id).inspect`
7. You should get an error

Any interaction with this record will result in errors

### Executable use case:

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem 'rails'
  gem ""sqlite3""
  gem ""pry""
  gem ""byebug""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Encryption.configure(
  primary_key: SecureRandom.alphanumeric(32),
  deterministic_key: SecureRandom.alphanumeric(32),
  key_derivation_salt: SecureRandom.alphanumeric(32),
  extend_queries: true,
  )

ActiveRecord::Schema.define do
  create_table :users, force: :true do |t|
    t.string :secret
  end
end

class User < ActiveRecord::Base
  encrypts :secret, deterministic: true
end

class BugTest < Minitest::Test
  def test_decrypt_breaks_access_to_model
    model = User.create(secret: ""my_test_string"")
    id = model.id
    model.decrypt

    assert_raises(ActiveRecord::Encryption::Errors::Decryption) do
      User.find(id).inspect
    end
  end
end
```

### Expected behavior
I can still interact with the entity, at the very least I should be able to recover it

### Actual behavior
Any method calls on this record yield in the after mentioned exception

### My 2 cents

I found this behavior when playing around with some records, and called `decrypt` on some of them because I was playing around. My issue is probably the intended behavior (that the record gets updated) and I understand that we get an exception since the record is not in the expected json string format anymore. However I think that we can improve the experience with any of: 

- Improving the documentation; adding a warning that this will result in an `update` of your record
- Changing the implementation so that the `ActiveRecord::Encryption::NullEncryptor.new` returns a string with a single string

I'm okay with providing any solution that it may be okay

### System configuration
**Rails version**: 7.0.6

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48721/reactions', 'total_count': 4, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48721/timeline,,
https://api.github.com/repos/rails/rails/issues/48714,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48714/labels{/name},https://api.github.com/repos/rails/rails/issues/48714/comments,https://api.github.com/repos/rails/rails/issues/48714/events,https://github.com/rails/rails/issues/48714,1799178211,I_kwDNIULOaz1H4w,48714,accepts_nested_attributes_for does not work with non `id` primary_key,"{'login': 'fanantoxa', 'id': 7717033, 'node_id': 'MDQ6VXNlcjc3MTcwMzM=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7717033?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fanantoxa', 'html_url': 'https://github.com/fanantoxa', 'followers_url': 'https://api.github.com/users/fanantoxa/followers', 'following_url': 'https://api.github.com/users/fanantoxa/following{/other_user}', 'gists_url': 'https://api.github.com/users/fanantoxa/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fanantoxa/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fanantoxa/subscriptions', 'organizations_url': 'https://api.github.com/users/fanantoxa/orgs', 'repos_url': 'https://api.github.com/users/fanantoxa/repos', 'events_url': 'https://api.github.com/users/fanantoxa/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fanantoxa/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,8,2023-07-11T15:18:06Z,2023-08-03T16:06:38Z,,NONE,,,,"### Steps to reproduce
Currently `accepts_nested_attributes_for` when it's trying to find existing records in relation it's hardcoded to take a look on `id` column. 
Problem is that `id` is not alway a primary key. In our case we have one of tables does not have `id` column at all but uses `uuid` is primary key. 
We've set `self.primary_key = 'uuid'` but `accepts_nested_attributes_for` does not uses this value to use in matching existing records.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true, id: false do |t|
    t.integer :uuid, primary_key: true
    t.integer :post_id
    t.string :name
  end
end

class Post < ActiveRecord::Base
  has_many :comments

  accepts_nested_attributes_for :comments, allow_destroy: true
end

class Comment < ActiveRecord::Base
  self.primary_key = 'uuid'

  belongs_to :post
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!
    post.comments << Comment.create!(name: 'wonderfull')

    post.reload

    assert_equal 1, post.comments.count
    assert_equal 1, Comment.count
    assert_equal post.id, Comment.first.post.id

    update_posts_data = {
      'id' => post.id,
      'comments_attributes' => [
        {
          'uuid' => Comment.first.uuid,
          'name' => 'Even Better'
        },
        {
          'name' => 'Another comment'
        }
      ]
    }

    post.assign_attributes(update_posts_data)

    post.save

    post.reload
    assert_equal 2, post.comments.count
    assert_equal 2, Comment.count

    assert_equal post.id, Comment.first.post.id
    assert_equal post.id, Comment.last.post.id

    assert_equal 'Even Better', Comment.first.name
    assert_equal 'Another comment', Comment.last.name
  end
end

```

### Expected behavior
Existing records are updated and new created.

### Actual behavior
It always trying to create new records and hit violation on primary key:
```
ActiveRecord::RecordNotUnique: SQLite3::ConstraintException: UNIQUE constraint failed: comments.uuid
```

### System configuration
**Rails version**: 7.1.0.alpha 
But present in any Rails version

**Ruby version**: 3.1.2 
But present in any Ruby version
","{'url': 'https://api.github.com/repos/rails/rails/issues/48714/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48714/timeline,,
https://api.github.com/repos/rails/rails/issues/48711,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48711/labels{/name},https://api.github.com/repos/rails/rails/issues/48711/comments,https://api.github.com/repos/rails/rails/issues/48711/events,https://github.com/rails/rails/pull/48711,1798631060,PR_kwDNIULOVS-l9Q,48711,Change form template to use button tag,"{'login': 'shouichi', 'id': 99586, 'node_id': 'MDQ6VXNlcjk5NTg2', 'avatar_url': 'https://avatars.githubusercontent.com/u/99586?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shouichi', 'html_url': 'https://github.com/shouichi', 'followers_url': 'https://api.github.com/users/shouichi/followers', 'following_url': 'https://api.github.com/users/shouichi/following{/other_user}', 'gists_url': 'https://api.github.com/users/shouichi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shouichi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shouichi/subscriptions', 'organizations_url': 'https://api.github.com/users/shouichi/orgs', 'repos_url': 'https://api.github.com/users/shouichi/repos', 'events_url': 'https://api.github.com/users/shouichi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shouichi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-11T10:32:27Z,2023-07-11T10:32:31Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48711', 'html_url': 'https://github.com/rails/rails/pull/48711', 'diff_url': 'https://github.com/rails/rails/pull/48711.diff', 'patch_url': 'https://github.com/rails/rails/pull/48711.patch', 'merged_at': None}","Rails 7 uses Turbo/Stimulus by default. Turbo adds disabled attributes when submitting form (see https://github.com/hotwired/turbo/pull/386). As the PR describes, we can change submission text when form is submitted.

```
button                  .show-when-disabled { display: none; }
button[disabled]        .show-when-disabled { display: initial; }

button                  .show-when-enabled { display: initial; }
button[disabled]        .show-when-enabled { display: none; }
```

```
<button>
  <span class=""show-when-enabled"">Submit</span>
  <span class=""show-when-disabled"">Submitting...</span>
</button>
```

This is only possible with the button tag. Because input tag does not allow child elements.

It also seems like that button tags are preferred way nowadays.

> https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/button
> Note: While <input> elements of type button are still perfectly valid
> HTML, the newer <button> element is now the favored way to create
> buttons. Given that a <button>'s label text is inserted between the
> opening and closing tags, you can include HTML in the label, even
> images.","{'url': 'https://api.github.com/repos/rails/rails/issues/48711/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48711/timeline,,
https://api.github.com/repos/rails/rails/issues/48700,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48700/labels{/name},https://api.github.com/repos/rails/rails/issues/48700/comments,https://api.github.com/repos/rails/rails/issues/48700/events,https://github.com/rails/rails/pull/48700,1795570078,PR_kwDNIULOVQXNrg,48700,"Update inconsistent documentation for `#structurally_compatible?`, `#and` and `#or`","{'login': 'joshuay03', 'id': 54629302, 'node_id': 'MDQ6VXNlcjU0NjI5MzAy', 'avatar_url': 'https://avatars.githubusercontent.com/u/54629302?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/joshuay03', 'html_url': 'https://github.com/joshuay03', 'followers_url': 'https://api.github.com/users/joshuay03/followers', 'following_url': 'https://api.github.com/users/joshuay03/following{/other_user}', 'gists_url': 'https://api.github.com/users/joshuay03/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/joshuay03/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/joshuay03/subscriptions', 'organizations_url': 'https://api.github.com/users/joshuay03/orgs', 'repos_url': 'https://api.github.com/users/joshuay03/repos', 'events_url': 'https://api.github.com/users/joshuay03/events{/privacy}', 'received_events_url': 'https://api.github.com/users/joshuay03/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-07-09T21:24:03Z,2023-07-18T06:35:49Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48700', 'html_url': 'https://github.com/rails/rails/pull/48700', 'diff_url': 'https://github.com/rails/rails/pull/48700.diff', 'patch_url': 'https://github.com/rails/rails/pull/48700.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created to update some inconsistent documentation for the public methods  `ActiveRecord::QueryMethods#structurally_compatible?`, `ActiveRecord::QueryMethods#and?` and `ActiveRecord::QueryMethods#or?`.

### Detail

In https://github.com/rails/rails/pull/39634, `#structurally_incompatible_values_for` was updated so that a given relation is only considered structurally incompatible to the current relation if it explicitly uses multi value relation value methods that either vary from (eg. joining on a different table) or are not included in the current relation.

The public method `#structurally_compatible?` was affected by this change but currently has an example in its documentation that is inconsistent with the current functionality:

**Expected:**
https://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/relation/query_methods.rb#L1011-L1012

**Actual**
```ruby
Post.joins(:comments).structurally_compatible?(Post.where(""id = 1""))
# => true
```

The descriptions for `#structurally_compatible?`, `#and` and `#or` also imply that the two relations need to include the exact same relation value methods, which is no longer true.

This PR simply updates the documentation for these methods so that:
1. The 'new' functionality is reflected in the descriptions.
2. The incorrect result for the example in `#structurally_compatible?` is fixed.

I've also added 2 more examples to `#structurally_compatible?` to make the expected output clearer.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

Originally, I opened this issue https://github.com/rails/rails/issues/48694 and a PR https://github.com/rails/rails/pull/48695 to address it by reverting the changes in https://github.com/rails/rails/pull/39634. However, I concluded that:
- The changes and reasoning in https://github.com/rails/rails/pull/39634 make sense in that a majority of the time the given relation will probably just vary by `#where`. I was a bit on the fence at first cause I felt like consistently raising an error here might prevent unexpected query results and provide a more meaningful error than the ones you might get due to a malformed query (like referencing a table in the given relation that's only been joined to in the current relation), but at the same time I can see how that approach can be considered to be a bit too heavy handed.
- https://github.com/rails/rails/pull/39634 was merged 3 years ago and I don't see any other open issues relating to it, so I think it's more reasonable to just update the documentation at this point than to revert the changes in that PR which might result in breaking changes on apps running on edge or when upgrading to the version this commit ends up in.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48700/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48700/timeline,,
https://api.github.com/repos/rails/rails/issues/48696,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48696/labels{/name},https://api.github.com/repos/rails/rails/issues/48696/comments,https://api.github.com/repos/rails/rails/issues/48696/events,https://github.com/rails/rails/issues/48696,1795296330,I_kwDNIULOawIMSg,48696,Line filtering doesn't work for plugin tests,"{'login': 'lewispb', 'id': 1773614, 'node_id': 'MDQ6VXNlcjE3NzM2MTQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1773614?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lewispb', 'html_url': 'https://github.com/lewispb', 'followers_url': 'https://api.github.com/users/lewispb/followers', 'following_url': 'https://api.github.com/users/lewispb/following{/other_user}', 'gists_url': 'https://api.github.com/users/lewispb/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lewispb/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lewispb/subscriptions', 'organizations_url': 'https://api.github.com/users/lewispb/orgs', 'repos_url': 'https://api.github.com/users/lewispb/repos', 'events_url': 'https://api.github.com/users/lewispb/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lewispb/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,3,2023-07-09T08:29:24Z,2023-09-08T17:27:01Z,,CONTRIBUTOR,,,,"### Steps to reproduce

- Checkout [rails/kredis](https://github.com/rails/kredis)
- Run `bin/test test/attributes_test.rb:82`

### Expected behavior

Only one test runs

### Actual behavior

All tests in test/attributes_test.rb run

### More info

I've fixed this for Kredis only, in this PR: https://github.com/rails/kredis/pull/122

Kredis has a standard `require ""rails/plugin/test""` in `bin/test`.

[`rails/plugin/test`](https://github.com/rails/rails/blob/main/railties/lib/rails/plugin/test.rb) does not support line filtering in the same way line filtering is installed for Rails apps or [Rails itself](https://github.com/rails/rails/blob/main/tools/test.rb#L9).

","{'url': 'https://api.github.com/repos/rails/rails/issues/48696/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48696/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/48691,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48691/labels{/name},https://api.github.com/repos/rails/rails/issues/48691/comments,https://api.github.com/repos/rails/rails/issues/48691/events,https://github.com/rails/rails/pull/48691,1794521666,PR_kwDNIULOVPiJGQ,48691,Create an `ActiveSupport::Callable` object to do case-equality with objects that implement `#call`,"{'login': 'bensheldon', 'id': 47554, 'node_id': 'MDQ6VXNlcjQ3NTU0', 'avatar_url': 'https://avatars.githubusercontent.com/u/47554?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bensheldon', 'html_url': 'https://github.com/bensheldon', 'followers_url': 'https://api.github.com/users/bensheldon/followers', 'following_url': 'https://api.github.com/users/bensheldon/following{/other_user}', 'gists_url': 'https://api.github.com/users/bensheldon/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bensheldon/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bensheldon/subscriptions', 'organizations_url': 'https://api.github.com/users/bensheldon/orgs', 'repos_url': 'https://api.github.com/users/bensheldon/repos', 'events_url': 'https://api.github.com/users/bensheldon/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bensheldon/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,1,2023-07-07T23:12:18Z,2023-09-20T16:26:16Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48691', 'html_url': 'https://github.com/rails/rails/pull/48691', 'diff_url': 'https://github.com/rails/rails/pull/48691.diff', 'patch_url': 'https://github.com/rails/rails/pull/48691.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Rails has some configuration options that explicitly type-check on `Proc` instead of allowing duck-typing. This PR introduces `ActiveSupport::Callable` which case-equals any object that responds to `call`. 

```ruby
class CustomQueryWarningsAction
  def self.call
    new.very_complex_method
  end
  # ....
end

# This PR allows this:
config.active_record.db_warnings_action = CustomQueryWarningsAction

# ...instead of previously requiring this:
config.active_record.db_warnings_action = CustomQueryWarningsAction.method(:call).to_proc
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48691/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48691/timeline,,
https://api.github.com/repos/rails/rails/issues/48689,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48689/labels{/name},https://api.github.com/repos/rails/rails/issues/48689/comments,https://api.github.com/repos/rails/rails/issues/48689/events,https://github.com/rails/rails/issues/48689,1793880804,I_kwDNIULOauxy5A,48689,Custom serialization & storage in ActiveRecord::Encryption (beyond strings),"{'login': 'maximerety', 'id': 58582, 'node_id': 'MDQ6VXNlcjU4NTgy', 'avatar_url': 'https://avatars.githubusercontent.com/u/58582?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maximerety', 'html_url': 'https://github.com/maximerety', 'followers_url': 'https://api.github.com/users/maximerety/followers', 'following_url': 'https://api.github.com/users/maximerety/following{/other_user}', 'gists_url': 'https://api.github.com/users/maximerety/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maximerety/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maximerety/subscriptions', 'organizations_url': 'https://api.github.com/users/maximerety/orgs', 'repos_url': 'https://api.github.com/users/maximerety/repos', 'events_url': 'https://api.github.com/users/maximerety/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maximerety/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,2,2023-07-07T17:17:19Z,2023-09-14T10:07:31Z,,CONTRIBUTOR,,,,"### Steps to reproduce

In https://guides.rubyonrails.org/active_record_encryption.html#supported-types, it is clearly stated:

> **`active_record.encryption` will serialize values using the underlying type before encrypting them, but they must be serializable as strings**. Structured types like serialized are supported out of the box.

As long as you only have string values, a `text`/`varchar` column in the database, and a message serializer that emits and consumes strings (the situation currently described in the docs), everything works just fine.

But I'd like to propose to support a wider range of use cases by **allowing custom serializers that output another type than strings**.

A typical use case would be to use a binary column in the database (e.g. `bytea` in PostgreSQL) and serialize encrypted values using a compact binary format such as the one provided by [MessagePack](https://github.com/msgpack/msgpack-ruby) (example given below), instead of the default JSON string format provided by the default message serializer.

Setting a custom serializer via `config.active_record.encryption.message_serializer` is already supported (https://guides.rubyonrails.org/active_record_encryption.html#encryption-contexts). Unfortunately, it's not possible to make your custom serializer produce binary values and have things work right out of the box.

One small inconvenience is the problem described in https://github.com/rails/rails/issues/48685 (quite straitghforward to fix: https://github.com/rails/rails/pull/48686), but a bigger problem lies in the current design of `ActiveRecord::Encryption::EncryptedAttributeType`.

To make my explanation a bit visual, this is what we have today:

```plaintext
Attribute without encryption:
                               
  user-provided value  cast  value for the db
                               
                                        
                               
   value for the user  cast  db-provided value
                               


Attribute with encryption:
                                           
  user-provided value  cast A  encrypt   serialize   cast B  value for the db
                                           
                                                                                         
                                           
   value for the user  cast A  decrypt  deserialize  cast B  db-provided value
                                           
```

As of today, the default implementation of `ActiveRecord::Encryption::EncryptedAttributeType` uses the type of the database column as `cast_type` to perform the `cast A` step in the figure, and there is no `cast B` step.

When a value is extracted from the database, there is no type casting before sending it to the message serializer for deserialization. Conversely, a value serialized with the message serializer is sent directly to the database without any further type casting. So, by default, there is no `cast B` step, and only strings are expected to be sent to/received from the database.

As long as you only have string values, a `text`/`varchar` column in the database, and a message serializer that emits and consumes strings (the situation currently described in the docs), everything works just fine.

But with this model, you can't easily switch to a `bytea` column and serialize in database-compatible binary format, because you have no built-in way to perform a `cast B` (binary) which is different from `cast A` (strings).

I think we should recognize the need for two distinct types of casting:

* Casting clear values before encryption (e.g. ensuring correct type/encoding), and;
* Casting encrypted+serialized values before sending them to the database (e.g. sending a message that is serialized in binary format).

Ideally, the framework should allow developers to specify the type of casting they need in a particular place, instead of using the database column type for `cast A` (not always appropriate), and providing no support for `cast B`.

**If you think this could be a good addition to the framework, I would volunteer to help make this happen.**

For completeness, a possible workaround is:

1. To declare the attribute as a string (despite the attribute being stored in a binary format in the database) in order to trick the framework to use a `:string` attribute type when performing `cast A` (see figure above):

    ```diff
      create_table(:records, force: true) do |t|
        t.bytea :some_attribute
      end

      class Record < ActiveRecord::Base
    +   attribute :some_attribute, :string
        encrypts :some_attribute
      end
    ```

2. To perform `cast B` yourself in the serializer, here an example of a binary message serializer using [MessagePack](https://github.com/msgpack/msgpack-ruby) (some details omitted - don't use this in your project):

    ```ruby
    class ByteaSerializer < ActiveRecord::Encryption::MessageSerializer
      def load(escaped_content)  
        encoded_content = binary_type.deserialize(escaped_content)
        parse_message(MessagePack.unpack(encoded_content), 1)
      end
    
      def dump(message)
        encoded_content = MessagePack.pack message_to_json(message)
        binary_type.serialize(encoded_content)
      end
    
      private
    
      def encode_if_needed(value) = value
      def decode_if_needed(value) = value
    
      def binary_type
        @binary_type ||= ActiveRecord::Type.lookup(:binary, adapter: :postgresql)
      end
    end
    ```

Although this gives us a picture of what we're trying to achieve, I think we'd do better to make `ActiveRecord::Encryption::EncryptedAttributeType` more versatile so that it's possible to achieve this goal without using dangerous tricks.

### Expected behavior

Various database column types and message serializers are supported for encrypted attributes.

### Actual behavior

You can only have string values, a `text`/`varchar` column in the database, and a message serializer that emits and consumes strings.

### System configuration

**Rails version**: 7.0.6

**Ruby version**: 3.2.2

---------

**Edit on `2023-07-10`**

I reworded the explanations around `cast B`, which is a step that does not exist in the default implementation, but which is needed in custom ones.","{'url': 'https://api.github.com/repos/rails/rails/issues/48689/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48689/timeline,,
https://api.github.com/repos/rails/rails/issues/48688,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48688/labels{/name},https://api.github.com/repos/rails/rails/issues/48688/comments,https://api.github.com/repos/rails/rails/issues/48688/events,https://github.com/rails/rails/issues/48688,1793824215,I_kwDNIULOauuV1w,48688,Callbacks called twice when parent accepts_nested_attributes_for child,"{'login': 'jakemiller13', 'id': 34395972, 'node_id': 'MDQ6VXNlcjM0Mzk1OTcy', 'avatar_url': 'https://avatars.githubusercontent.com/u/34395972?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jakemiller13', 'html_url': 'https://github.com/jakemiller13', 'followers_url': 'https://api.github.com/users/jakemiller13/followers', 'following_url': 'https://api.github.com/users/jakemiller13/following{/other_user}', 'gists_url': 'https://api.github.com/users/jakemiller13/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jakemiller13/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jakemiller13/subscriptions', 'organizations_url': 'https://api.github.com/users/jakemiller13/orgs', 'repos_url': 'https://api.github.com/users/jakemiller13/repos', 'events_url': 'https://api.github.com/users/jakemiller13/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jakemiller13/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,1,2023-07-07T16:25:45Z,2023-07-19T14:44:08Z,,NONE,,,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string :name
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.string :name
  end
end

class Post < ActiveRecord::Base
  has_one :comment

  before_validation :before_validation_callback_post
  after_validation :after_validation_callback_post

  before_save :before_save_callback_post
  after_save :after_save_callback_post

  before_create :before_create_callback_post
  after_create :after_create_callback_post

  def before_validation_callback_post
    puts 'Post: before_validation_callback'
  end

  def after_validation_callback_post
    puts 'Post: after_validation_callback'
  end

  def before_save_callback_post
    puts 'Post: before_save_callback'
  end

  def after_save_callback_post
    puts 'Post: after_save_callback'
  end

  def before_create_callback_post
    puts 'Post: before_create_callback'
  end

  def after_create_callback_post
    puts 'Post: after_create_callback'
  end
end

class Comment < ActiveRecord::Base
  belongs_to :post

  accepts_nested_attributes_for :post

  before_validation :before_validation_callback_comment
  after_validation :after_validation_callback_comment

  before_save :before_save_callback_comment
  after_save :after_save_callback_comment

  before_create :before_create_callback_comment
  after_create :after_create_callback_comment

  def before_validation_callback_comment
    puts 'Comment: before_validation_callback'
  end

  def after_validation_callback_comment
    puts 'Comment: after_validation_callback'
  end

  def before_save_callback_comment
    puts 'Comment: before_save_callback'
  end

  def after_save_callback_comment
    puts 'Comment: after_save_callback'
  end

  def before_create_callback_comment
    puts 'Comment: before_create_callback'
  end

  def after_create_callback_comment
    puts 'Comment: after_create_callback'
  end
end

class BugTest < Minitest::Test
  def test_association_stuff
    Comment.create!(name: 'foo', post_attributes: {name: 'bar'})
  end
end

```

### Expected behavior
`before_validation`, `after_validation`, `before_save`, `after_save` callbacks should only be called once when saving a parent record that accepts nested attributes for a child record. Note that `before_create`, `after_create` callbacks **are** only called once, so this inconsistency is especially confusing.

### Actual behavior
`before_validation`, `after_validation`, `before_save`, `after_save` are all called twice on parent record.

```
(base) m-apd-jmiller:models jmiller$ ruby active_record_main.rb 
Fetching https://github.com/rails/rails.git
Fetching gem metadata from https://rubygems.org/......
Resolving dependencies...
Using rake 13.0.6
Using connection_pool 2.4.1
Using minitest 5.18.1
Using webrick 1.8.1
Using erubi 1.12.0
Using rack 3.0.8
Using websocket-extensions 0.1.5
Using marcel 1.0.2
Using rack-test 2.1.0
Using bundler 2.4.7
Using websocket-driver 0.7.5
Using nio4r 2.5.9
Using zeitwerk 2.6.8
Using date 3.3.3
Using timeout 0.4.0
Using builder 3.2.4
Using io-console 0.6.0
Using racc 1.7.1
Using crass 1.0.6
Using thor 1.2.2
Using sqlite3 1.6.3 (x86_64-darwin)
Using rack-session 2.0.0
Using mini_mime 1.1.2
Using rackup 2.1.0
Using concurrent-ruby 1.2.2
Using net-protocol 0.2.1
Using reline 0.3.5
Using i18n 1.14.1
Using net-imap 0.3.6
Using nokogiri 1.15.3 (x86_64-darwin)
Using net-pop 0.1.2
Using net-smtp 0.3.3
Using loofah 2.21.3
Using irb 1.7.1
Using rails-html-sanitizer 1.6.0
Using tzinfo 2.0.6
Using mail 2.8.1
Using activesupport 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using activemodel 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using rails-dom-testing 2.1.1
Using activerecord 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using actionview 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using globalid 1.1.0
Using actionpack 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using activejob 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using actioncable 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using activestorage 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using actionmailer 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using actionmailbox 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using actiontext 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using railties 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
Using rails 7.1.0.alpha from https://github.com/rails/rails.git (at main@a5fc471)
-- create_table(:posts, {:force=>true})
D, [2023-07-07T12:17:20.483607 #2897] DEBUG -- :    (0.1ms)  DROP TABLE IF EXISTS ""posts""
D, [2023-07-07T12:17:20.485077 #2897] DEBUG -- :    (1.1ms)  CREATE TABLE ""posts"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""name"" varchar)
   -> 0.0286s
-- create_table(:comments, {:force=>true})
D, [2023-07-07T12:17:20.485698 #2897] DEBUG -- :    (0.0ms)  DROP TABLE IF EXISTS ""comments""
D, [2023-07-07T12:17:20.486042 #2897] DEBUG -- :    (0.1ms)  CREATE TABLE ""comments"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""post_id"" integer, ""name"" varchar)
   -> 0.0009s
D, [2023-07-07T12:17:20.488263 #2897] DEBUG -- :    (0.1ms)  CREATE TABLE ""schema_migrations"" (""version"" varchar NOT NULL PRIMARY KEY)
D, [2023-07-07T12:17:20.490839 #2897] DEBUG -- :    (0.1ms)  CREATE TABLE ""ar_internal_metadata"" (""key"" varchar NOT NULL PRIMARY KEY, ""value"" varchar, ""created_at"" datetime(6) NOT NULL, ""updated_at"" datetime(6) NOT NULL)
D, [2023-07-07T12:17:20.532633 #2897] DEBUG -- :   ActiveRecord::InternalMetadata Load (2.7ms)  SELECT * FROM ""ar_internal_metadata"" WHERE ""ar_internal_metadata"".""key"" = ? ORDER BY ""ar_internal_metadata"".""key"" ASC LIMIT 1  [[nil, ""environment""]]
D, [2023-07-07T12:17:20.533215 #2897] DEBUG -- :   ActiveRecord::InternalMetadata Create (0.1ms)  INSERT INTO ""ar_internal_metadata"" (""key"", ""value"", ""created_at"", ""updated_at"") VALUES ('environment', 'development', '2023-07-07 16:17:20.532735', '2023-07-07 16:17:20.532743')
Run options: --seed 61519

# Running:

Comment: before_validation_callback
Post: before_validation_callback
Post: after_validation_callback
Comment: after_validation_callback
Post: before_save_callback
Post: before_create_callback
D, [2023-07-07T12:17:20.661392 #2897] DEBUG -- :   TRANSACTION (0.1ms)  begin transaction
D, [2023-07-07T12:17:20.661656 #2897] DEBUG -- :   Post Create (0.4ms)  INSERT INTO ""posts"" (""name"") VALUES (?)  [[""name"", ""bar""]]
Comment: before_validation_callback
Comment: after_validation_callback
Comment: before_save_callback
Comment: before_create_callback
D, [2023-07-07T12:17:20.662908 #2897] DEBUG -- :   Comment Create (0.1ms)  INSERT INTO ""comments"" (""post_id"", ""name"") VALUES (?, ?)  [[""post_id"", 1], [""name"", ""foo""]]
Comment: after_create_callback
Comment: after_save_callback
Post: after_create_callback
Post: after_save_callback
Comment: before_save_callback
Comment: after_save_callback
D, [2023-07-07T12:17:20.663528 #2897] DEBUG -- :   TRANSACTION (0.1ms)  commit transaction
```

### System configuration
**Rails version**: 5.2.8.1, 7.0.6 (tested both)

**Ruby version**: 2.7.6, 3.2.1 (tested both)
","{'url': 'https://api.github.com/repos/rails/rails/issues/48688/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/48688/timeline,,
https://api.github.com/repos/rails/rails/issues/48686,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48686/labels{/name},https://api.github.com/repos/rails/rails/issues/48686/comments,https://api.github.com/repos/rails/rails/issues/48686/events,https://github.com/rails/rails/pull/48686,1793537744,PR_kwDNIULOVOrDyQ,48686,[Fix #48685] Make the encryptor agnostic of the type of data to decrypt,"{'login': 'maximerety', 'id': 58582, 'node_id': 'MDQ6VXNlcjU4NTgy', 'avatar_url': 'https://avatars.githubusercontent.com/u/58582?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maximerety', 'html_url': 'https://github.com/maximerety', 'followers_url': 'https://api.github.com/users/maximerety/followers', 'following_url': 'https://api.github.com/users/maximerety/following{/other_user}', 'gists_url': 'https://api.github.com/users/maximerety/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maximerety/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maximerety/subscriptions', 'organizations_url': 'https://api.github.com/users/maximerety/orgs', 'repos_url': 'https://api.github.com/users/maximerety/repos', 'events_url': 'https://api.github.com/users/maximerety/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maximerety/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-07-07T13:18:03Z,2023-07-07T20:30:26Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48686', 'html_url': 'https://github.com/rails/rails/pull/48686', 'diff_url': 'https://github.com/rails/rails/pull/48686.diff', 'patch_url': 'https://github.com/rails/rails/pull/48686.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created to fix https://github.com/rails/rails/issues/48685.

### Detail

[Fix #48685] Make the encryptor agnostic of the type of data to decrypt
    
The default message serializer will raise a `TypeError` when invoking `JSON.parse` on any non-`String` input. This error will subsequently be translated into an `ActiveRecord::Encryption::Errors::Encoding` error and then a `ActiveRecord::Encryption::Errors::Decryption` error by the encryptor, which does not change the current behavior at the encryptor level.

This change clarifies that it is the role of the underlying serializer to accept or reject the data to decrypt depending on its type. This behavior mirrors what is done at encryption, where the serializer asserts that the input is an `ActiveRecord::Encryption::Message`.

This change is a no-op when using the default `MessageSerializer` class, but it enables the use a wider variety of custom serializers.

By being agnostic of the type of data to decrypt at the encryptor level, it is now possible to serialize and store messages in a binary format (e.g. in a `bytea` column in PostgreSQL). A custom message serializer is now able to decrypt binary values coming from the database (`String`) or from user input (`ActiveModel::Type::Binary::Data`) without having an exception raised at the encryptor level because the type is not `String`.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48686/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48686/timeline,,
https://api.github.com/repos/rails/rails/issues/48685,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48685/labels{/name},https://api.github.com/repos/rails/rails/issues/48685/comments,https://api.github.com/repos/rails/rails/issues/48685/events,https://github.com/rails/rails/issues/48685,1793527161,I_kwDNIULOaucNeQ,48685,Make ActiveRecord Encryptor agnostic of the type of serialized data to be decrypted,"{'login': 'maximerety', 'id': 58582, 'node_id': 'MDQ6VXNlcjU4NTgy', 'avatar_url': 'https://avatars.githubusercontent.com/u/58582?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maximerety', 'html_url': 'https://github.com/maximerety', 'followers_url': 'https://api.github.com/users/maximerety/followers', 'following_url': 'https://api.github.com/users/maximerety/following{/other_user}', 'gists_url': 'https://api.github.com/users/maximerety/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maximerety/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maximerety/subscriptions', 'organizations_url': 'https://api.github.com/users/maximerety/orgs', 'repos_url': 'https://api.github.com/users/maximerety/repos', 'events_url': 'https://api.github.com/users/maximerety/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maximerety/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,0,2023-07-07T13:11:02Z,2023-07-19T14:44:48Z,,CONTRIBUTOR,,,,"### Steps to reproduce

I am using [ActiveRecord Encryption](https://guides.rubyonrails.org/active_record_encryption.html) with latest Rails `7.0.*`, and a custom serializer instead of the default one.

This custom serializer outputs binary values that are stored in a `bytea` column in PostgreSQL, instead of a JSON value in a `text` column, as the default MessageSerializer would do.

It works pretty well except that the `ActiveRecord::Encryption::Encryptor#deserialize_message` prevents `ActiveModel::Type::Binary::Data` objects to be passed to the custom serializer for decryption. (Note: we get this type of data for user inputs subsequently decrypted, e.g. during attribute validation).

I would expect the `Encryptor` to be agnostic about the type of values to decrypt, and let the underlying serializer assert the actual types that it supports.

Note that the default `MessageSerializer` is already able to reject any input which is not a `String`:

1. A  `TypeError` is raised by `JSON.parse` (not caught here)
https://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/message_serializer.rb#L24-L29
2. The `TypeError` is caught and replaced by an `Encoding` error:
https://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/encryptor.rb#L102-L107
3. And finally caught again and replaced by  a `Decryption` error:
https://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/encryptor.rb#L52-L59

So there is no need for this duplicate preventive check at `Encryptor` level in step 2.:

https://github.com/rails/rails/blob/a5fc471b3f4bbd02e6be38dae023526a49e7d049/activerecord/lib/active_record/encryption/encryptor.rb#L103

When I remove that duplicate check, the behavior is unchanged when using the default `MessageSerializer`, but I am able to use a custom serializer too.

### Expected behavior

I would expect the `Encryptor` to be agnostic about the type of values to decrypt, and let the underlying serializer assert the actual types that it supports.

### Actual behavior

The `Encryptor` assumes that the input to be deserialized/decrypted is always a `String` when it could be something else. This unnecessarily prevents the use of custom serializers.

### System configuration

**Rails version**: 7.0.6 / 7.1

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48685/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48685/timeline,,
https://api.github.com/repos/rails/rails/issues/48683,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48683/labels{/name},https://api.github.com/repos/rails/rails/issues/48683/comments,https://api.github.com/repos/rails/rails/issues/48683/events,https://github.com/rails/rails/pull/48683,1792862016,PR_kwDNIULOVOGMAA,48683,HasOne `create_association` should raise if association already exists,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2023-07-07T06:13:00Z,2023-07-12T01:07:02Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48683', 'html_url': 'https://github.com/rails/rails/pull/48683', 'diff_url': 'https://github.com/rails/rails/pull/48683.diff', 'patch_url': 'https://github.com/rails/rails/pull/48683.patch', 'merged_at': None}","The goal is to raise an exception when calling `create_association` which would replace an already persisted association.

Here is a failing test report as well:

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""active_support/testing/assertions""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :authors, force: true

  create_table :books, force: true do |t|
    t.integer :author_id
  end
end

class Author < ActiveRecord::Base
  has_one :book
end

class Book < ActiveRecord::Base
  belongs_to :author
  validates :author_id, uniqueness: true
end

class BugTest < Minitest::Test
  include ActiveSupport::Testing::Assertions

  def test_association_stuff
    author = Author.create!
    author.create_book!

    assert_no_difference -> { Book.count } do
      assert_raises ActiveRecord::RecordNotSaved do
        author.create_book!
      end
    end
  end
end
```","{'url': 'https://api.github.com/repos/rails/rails/issues/48683/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48683/timeline,,
https://api.github.com/repos/rails/rails/issues/48672,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48672/labels{/name},https://api.github.com/repos/rails/rails/issues/48672/comments,https://api.github.com/repos/rails/rails/issues/48672/events,https://github.com/rails/rails/pull/48672,1790353946,PR_kwDNIULOVL9Bpw,48672,Refactor CollectionAssociation to improve thread-safety; Fixes #48671,"{'login': 'mullican', 'id': 347652, 'node_id': 'MDQ6VXNlcjM0NzY1Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/347652?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mullican', 'html_url': 'https://github.com/mullican', 'followers_url': 'https://api.github.com/users/mullican/followers', 'following_url': 'https://api.github.com/users/mullican/following{/other_user}', 'gists_url': 'https://api.github.com/users/mullican/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mullican/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mullican/subscriptions', 'organizations_url': 'https://api.github.com/users/mullican/orgs', 'repos_url': 'https://api.github.com/users/mullican/repos', 'events_url': 'https://api.github.com/users/mullican/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mullican/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-05T21:22:38Z,2023-07-13T21:18:33Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48672', 'html_url': 'https://github.com/rails/rails/pull/48672', 'diff_url': 'https://github.com/rails/rails/pull/48672.diff', 'patch_url': 'https://github.com/rails/rails/pull/48672.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created to resolve race conditions in threaded code when loading instances of `CollectionAssociation` on an object which is shared across threads, as described in issue #48671

### Detail

This Pull Request changes the implementation of two methods to prevent them from mutating an instance variable in ways that would violate the expectations of other methods which rely on the state of that variable. 

Specifically, in the current state, the instance variable `@target` is:

1. Initialized as `nil`, then subsequently reinitialized to an empty array (many methods depend on it being enumerable and will raise errors if called during the window of time in which it is `nil`)
2. Mutated by calling `delete` on each of its elements prior to overwriting it with a new value (creating a window of time where it contains partial data or no data)

Both of these situations present a race condition when the object is shared by multiple threads.

The changes in this pull request:
1. Resolve the first issue by replacing a call to `super` with explicit initializations appropriate to the subclass
2. Resolve the second issue by replacing the call to `delete` with an index lookup, which makes the reassignment behavior atomic.

### Additional information

**Performance**: the array lookup in `merge_target_lists` could be done in other ways; the `index` lookup measures at least as fast as `delete` on my hardware; other approaches using enumerable methods like `detect` would be slower.

**Testing:** although the linked issue includes a test script that can demonstrate the problem, the nature of it is timing-dependent in a way that makes it difficult to write explicit tests to reproduce, and the changes are straightforward. I think that a lack of regression in existing tests should be sufficient verification.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] ~Tests are added or updated if you fix a bug or add a feature.~
* [x] ~CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.~
","{'url': 'https://api.github.com/repos/rails/rails/issues/48672/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/48672/timeline,,
https://api.github.com/repos/rails/rails/issues/48671,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48671/labels{/name},https://api.github.com/repos/rails/rails/issues/48671/comments,https://api.github.com/repos/rails/rails/issues/48671/events,https://github.com/rails/rails/issues/48671,1790337154,I_kwDNIULOarZggg,48671,Loading a CollectionAssociation is not threadsafe in all contexts,"{'login': 'mullican', 'id': 347652, 'node_id': 'MDQ6VXNlcjM0NzY1Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/347652?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mullican', 'html_url': 'https://github.com/mullican', 'followers_url': 'https://api.github.com/users/mullican/followers', 'following_url': 'https://api.github.com/users/mullican/following{/other_user}', 'gists_url': 'https://api.github.com/users/mullican/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mullican/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mullican/subscriptions', 'organizations_url': 'https://api.github.com/users/mullican/orgs', 'repos_url': 'https://api.github.com/users/mullican/repos', 'events_url': 'https://api.github.com/users/mullican/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mullican/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-05T21:13:21Z,2023-07-24T17:33:57Z,,CONTRIBUTOR,,,,"### Steps to reproduce
The superclass `CollectionAssociation` applies to `has_many` and HABTM relations. Its implementation of the `load_target` method relies on the value of an instance variable `@target` which is initialized in `reset` to an empty array. When a given association has not been loaded, this variable is passed as an argument to the method `merge_target_lists`, where database results are compared to the current copy of the records held in memory.

This presents two potential race conditions in threaded code:
1. The `reset` method calls `super` before assigning the empty array to `@target`. On the `Association` superclass, `@target` is assigned as `nil`, so there is a brief moment between the two assignments where it may evaluate as `nil`. Many methods on `CollectionAssociation` assume that its value is always an array and will throw a `NoMethodError` exception if called in this state.
2. The implementation of `merge_target_lists` mutates the value of the passed argument by calling `delete` on its elements before subsequently returning a final result back to the caller, where it is reassigned to the `@target` variable. Thus, there is also a brief moment, while this method is iterating over a result set, where `@target` may contain either partial data or no data. If another thread relies on the value of `@target` at this point in time, it will see inconsistent results.

Consider the following scenario:
```ruby
class Post < ApplicationRecord
  has_many :comments
end

@post = Post.find(1)
Thread.new { @post.comments.do_some_work }
Thread.new { @post.comments.do_other_work }
```

### Expected behavior
Because the call to `comments` will lazily load the association, and there is no guaranteed order of execution, either thread, or both, may load records from the database, depending on when the value of `@loaded` is read and written. However, the load should occur atomically, so that if both threads evaluate `@loaded` as false, they both fetch and return the correct records consistently. In the current implementation, a thread in this scenario may see no data, partial data, or throw an exception.

### Actual behavior
For example:
```ruby
@post = Post.first
expected_result_count = @post.comments.count
thread_count = @post.class.connection_pool.size-1

1_000.times { |i|
  @post.association(:comments).reset
  thread_count.times.map { |j|
    Thread.new {
      begin
        actual_count = @post.comments.load.size
        if actual_count != expected_result_count
          STDOUT.puts ""Thread ##{j}[#{i}]: Expected #{expected_result_count}, found #{actual_count}""
        end
      rescue => e
        STDOUT.puts ""Thread ##{j}[#{i}]: Caught exception #{e}""
      end
    }
  }.each(&:join)
}
```

Output of an example run on my hardware, using 50 threads with 1K iterations  14 of the 50K loads returned inconsistent data or errors:
```
Thread #5[246]: Caught exception undefined method `persisted?' for nil:NilClass
Thread #20[246]: Caught exception undefined method `persisted?' for nil:NilClass
Thread #29[246]: Caught exception undefined method `persisted?' for nil:NilClass
Thread #40[246]: Caught exception undefined method `persisted?' for nil:NilClass
Thread #41[246]: Caught exception undefined method `persisted?' for nil:NilClass
Thread #36[246]: Caught exception undefined method `persisted?' for nil:NilClass
Thread #49[246]: Caught exception undefined method `persisted?' for nil:NilClass
Thread #45[268]: Expected 500, found 468
Thread #42[268]: Expected 500, found 468
Thread #39[268]: Expected 500, found 468
Thread #49[268]: Expected 500, found 468
Thread #46[495]: Expected 500, found 469
Thread #46[533]: Expected 500, found 454
Thread #47[810]: Caught exception undefined method `persisted?' for nil:NilClass
```

### System configuration
**Rails version**: 6.1, 7.0
**Ruby version**: 3.0, 3.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48671/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48671/timeline,,
https://api.github.com/repos/rails/rails/issues/48658,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48658/labels{/name},https://api.github.com/repos/rails/rails/issues/48658/comments,https://api.github.com/repos/rails/rails/issues/48658/events,https://github.com/rails/rails/pull/48658,1789059821,PR_kwDNIULOVK2Lbw,48658,Fix `include_hidden` documentation for File Upload,"{'login': 'alexpapworth', 'id': 25950768, 'node_id': 'MDQ6VXNlcjI1OTUwNzY4', 'avatar_url': 'https://avatars.githubusercontent.com/u/25950768?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/alexpapworth', 'html_url': 'https://github.com/alexpapworth', 'followers_url': 'https://api.github.com/users/alexpapworth/followers', 'following_url': 'https://api.github.com/users/alexpapworth/following{/other_user}', 'gists_url': 'https://api.github.com/users/alexpapworth/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/alexpapworth/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/alexpapworth/subscriptions', 'organizations_url': 'https://api.github.com/users/alexpapworth/orgs', 'repos_url': 'https://api.github.com/users/alexpapworth/repos', 'events_url': 'https://api.github.com/users/alexpapworth/events{/privacy}', 'received_events_url': 'https://api.github.com/users/alexpapworth/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2023-07-05T08:34:27Z,2023-07-12T14:36:43Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48658', 'html_url': 'https://github.com/rails/rails/pull/48658', 'diff_url': 'https://github.com/rails/rails/pull/48658.diff', 'patch_url': 'https://github.com/rails/rails/pull/48658.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

The current [documentation](https://api.rubyonrails.org/v7.0.4/classes/ActionView/Helpers/FormHelper.html#method-i-file_field) implies calling `multiple: true` and `include_hidden: true` will stop existing files from being replaced when saving a record that has ActiveStorage attached. However it appears `include_hidden: false` is needed to achieve this functionality.

Fixes #48006

### Detail

Updating documentation to reflect the current functionality of `multiple: true` and `include_hidden: false`

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48658/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48658/timeline,,
https://api.github.com/repos/rails/rails/issues/48647,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48647/labels{/name},https://api.github.com/repos/rails/rails/issues/48647/comments,https://api.github.com/repos/rails/rails/issues/48647/events,https://github.com/rails/rails/pull/48647,1788005162,PR_kwDNIULOVJ9DBQ,48647,Fix has_many_inversing records with same references,"{'login': 'abaldwin88', 'id': 15172605, 'node_id': 'MDQ6VXNlcjE1MTcyNjA1', 'avatar_url': 'https://avatars.githubusercontent.com/u/15172605?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/abaldwin88', 'html_url': 'https://github.com/abaldwin88', 'followers_url': 'https://api.github.com/users/abaldwin88/followers', 'following_url': 'https://api.github.com/users/abaldwin88/following{/other_user}', 'gists_url': 'https://api.github.com/users/abaldwin88/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/abaldwin88/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/abaldwin88/subscriptions', 'organizations_url': 'https://api.github.com/users/abaldwin88/orgs', 'repos_url': 'https://api.github.com/users/abaldwin88/repos', 'events_url': 'https://api.github.com/users/abaldwin88/events{/privacy}', 'received_events_url': 'https://api.github.com/users/abaldwin88/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-07-04T14:08:03Z,2023-07-31T14:10:06Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48647', 'html_url': 'https://github.com/rails/rails/pull/48647', 'diff_url': 'https://github.com/rails/rails/pull/48647.diff', 'patch_url': 'https://github.com/rails/rails/pull/48647.patch', 'merged_at': None}","### Motivation / Background

Resolves #47559

Properly handle an intermediate model with has_many_inversing when creating two records with the same references.

- Prevents database error when references have a NOT NULL constraint
- When NULLS are permitted avoid an extra UPDATE statement by inserting the correct values from the outset

### Detail

```rb
ActiveRecord::Base.has_many_inversing = true

class Comment < ActiveRecord::Base
  belongs_to :post, inverse_of: :comments
  belongs_to :author, inverse_of: :comments
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Author < ActiveRecord::Base
  has_many :comments
end

post = Post.new
author = Author.new
post.comments.build(author: author)
post.comments.build(author: author)
post.save!
```

Before:
```sql
BEGIN
  INSERT INTO ""posts"" DEFAULT VALUES RETURNING ""id""
  INSERT INTO ""authors"" DEFAULT VALUES RETURNING ""id""
  INSERT INTO ""comments"" (""post_id"", ""author_id"") VALUES ($1, $2) RETURNING ""id""  [[""post_id"", 1], [""author_id"", 1]]
  -- Error if NOT NULL constraint on post_id
  INSERT INTO ""comments"" (""author_id"") VALUES ($1) RETURNING ""id""  [[""author_id"", 1]]
  UPDATE ""comments"" SET ""post_id"" = $1 WHERE ""comments"".""id"" = $2  [[""post_id"", 1], [""id"", 2]]
COMMIT
```

After:
```sql
BEGIN
  INSERT INTO ""posts"" DEFAULT VALUES RETURNING ""id""
  INSERT INTO ""authors"" DEFAULT VALUES RETURNING ""id""
  INSERT INTO ""comments"" (""post_id"", ""author_id"") VALUES ($1, $2) RETURNING ""id""  [[""post_id"", 1], [""author_id"", 1]]
  INSERT INTO ""comments"" (""post_id"", ""author_id"") VALUES ($1, $2) RETURNING ""id""  [[""post_id"", 1], [""author_id"", 1]]
COMMIT
```

`insert_record` within `save_collection_association` will trigger a recursive call. By fully processing `set_inverse_instance` for each layer we ensure associations are up to date before `INSERT INTO comments` statements are sent to the database.


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48647/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48647/timeline,,
https://api.github.com/repos/rails/rails/issues/48640,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48640/labels{/name},https://api.github.com/repos/rails/rails/issues/48640/comments,https://api.github.com/repos/rails/rails/issues/48640/events,https://github.com/rails/rails/pull/48640,1786550343,PR_kwDNIULOVIuzww,48640,fix: Raise an exception on `has_one` failed to autosave,"{'login': 'wata727', 'id': 9624059, 'node_id': 'MDQ6VXNlcjk2MjQwNTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9624059?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/wata727', 'html_url': 'https://github.com/wata727', 'followers_url': 'https://api.github.com/users/wata727/followers', 'following_url': 'https://api.github.com/users/wata727/following{/other_user}', 'gists_url': 'https://api.github.com/users/wata727/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/wata727/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/wata727/subscriptions', 'organizations_url': 'https://api.github.com/users/wata727/orgs', 'repos_url': 'https://api.github.com/users/wata727/repos', 'events_url': 'https://api.github.com/users/wata727/events{/privacy}', 'received_events_url': 'https://api.github.com/users/wata727/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2023-07-03T17:12:25Z,2023-08-08T13:41:27Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48640', 'html_url': 'https://github.com/rails/rails/pull/48640', 'diff_url': 'https://github.com/rails/rails/pull/48640.diff', 'patch_url': 'https://github.com/rails/rails/pull/48640.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Fixes https://github.com/rails/rails/issues/36833
Fixes https://github.com/rails/rails/issues/48633

Previously, failure to autosave a `has_one` association returned `nil` instead of raising an exception.

```ruby
class Supplier < ActiveRecord::Base
  has_one :account, autosave: true
end

class Account < ActiveRecord::Base
  before_save { throw(:abort) }
end

supplier = Supplier.new
supplier.build_account
supplier.save! # => nil
```

But it's counter-intuitive for `save!` to fail without raising an exception.

### Detail

This pull request changes the `save_has_one_association` to raise `ActiveRecord::RecordInvalid` instead of `ActiveRecord::Rollback`. This allows it to raise an exception if it fails to autosave the `has_one` association with `save!`.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

This pull request is very similar to [the pull request for `has_many` association](https://github.com/rails/rails/pull/36210).

Also, it seems that the reason why `ActiveRecord::Rollback` was raised was to return `false` while rolling back with `save`, but there is also no problem with `ActiveRecord::RecordInvalid`.
https://github.com/rails/rails/commit/f2aacd51405724cdf7cfd36a439c9dbfce16973a

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48640/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48640/timeline,,
https://api.github.com/repos/rails/rails/issues/48633,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48633/labels{/name},https://api.github.com/repos/rails/rails/issues/48633/comments,https://api.github.com/repos/rails/rails/issues/48633/events,https://github.com/rails/rails/issues/48633,1785850610,I_kwDNIULOanHq8g,48633,Throwing abort on an autosaved `has_one` association does not raise an exception,"{'login': 'wata727', 'id': 9624059, 'node_id': 'MDQ6VXNlcjk2MjQwNTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9624059?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/wata727', 'html_url': 'https://github.com/wata727', 'followers_url': 'https://api.github.com/users/wata727/followers', 'following_url': 'https://api.github.com/users/wata727/following{/other_user}', 'gists_url': 'https://api.github.com/users/wata727/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/wata727/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/wata727/subscriptions', 'organizations_url': 'https://api.github.com/users/wata727/orgs', 'repos_url': 'https://api.github.com/users/wata727/repos', 'events_url': 'https://api.github.com/users/wata727/events{/privacy}', 'received_events_url': 'https://api.github.com/users/wata727/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2023-07-03T10:16:56Z,2023-07-05T04:06:07Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""7.0.6""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :suppliers, force: true do |t|
  end
  create_table :accounts, force: true do |t|
    t.integer :supplier_id
  end
end

class Supplier < ActiveRecord::Base
  has_one :account, autosave: true
end

class Account < ActiveRecord::Base
  before_save { throw(:abort) }
end

class BugTest < Minitest::Test
  def test_has_one
    supplier = Supplier.new
    supplier.build_account
    assert_raises(ActiveRecord::RecordNotSaved) { supplier.save! }

    assert_equal 0, Supplier.count
    assert_equal 0, Account.count
  end
end
```

### Expected behavior
<!-- Tell us what should happen -->

The tests should pass without errors.

### Actual behavior
<!-- Tell us what happens instead -->

`ActiveRecord::RecordNotSaved` is not raised.

```
# Running:

Finished in 0.004507s, 221.8771 runs/s, 221.8771 assertions/s.

  1) Failure:
BugTest#test_has_one [has_one_abort_autosave.rb:43]:
ActiveRecord::RecordNotSaved expected but nothing was raised.

1 runs, 1 assertions, 1 failures, 0 errors, 0 skips
```

### Detailed description

When I first encountered this issue, I wasn't sure if this was a bug or intended behavior. So, I investigated the behavior of `has_many`, `has_one`, `belongs_to`. Below is the test:

<details>

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""7.0.6""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end
  create_table :comments, force: true do |t|
    t.integer :post_id
    t.text :content
  end

  create_table :suppliers, force: true do |t|
  end
  create_table :accounts, force: true do |t|
    t.integer :supplier_id
    t.string :name
  end

  create_table :books, force: true do |t|
    t.integer :author_id
  end
  create_table :authors, force: true do |t|
    t.string :name
  end
end

class Post < ActiveRecord::Base
  has_many :comments
  has_many :autosave_comments, class_name: 'Comment', autosave: true
  has_many :abort_comments
  has_many :abort_autosave_comments, class_name: 'AbortComment', autosave: true
  has_many :invalid_comments
  has_many :invalid_autosave_comments, class_name: 'InvalidComment', autosave: true
end

class Comment < ActiveRecord::Base; end
class AbortComment < Comment
  before_save { throw(:abort) }
end
class InvalidComment < Comment
  validates :content, presence: true
end

class Supplier < ActiveRecord::Base
  has_one :account
  has_one :autosave_account, class_name: 'Account', autosave: true
  has_one :abort_account
  has_one :abort_autosave_account, class_name: 'AbortAccount', autosave: true
  has_one :invalid_account
  has_one :invalid_autosave_account, class_name: 'InvalidAccount', autosave: true
end

class Account < ActiveRecord::Base; end
class AbortAccount < Account
  before_save { throw(:abort) }
end
class InvalidAccount < Account
  validates :name, presence: true
end

class Book < ActiveRecord::Base
  belongs_to :author
  belongs_to :autosave_author, class_name: 'Author', foreign_key: 'author_id', autosave: true
  belongs_to :abort_author, foreign_key: 'author_id'
  belongs_to :abort_autosave_author, class_name: 'AbortAuthor', foreign_key: 'author_id', autosave: true
  belongs_to :invalid_author, foreign_key: 'author_id'
  belongs_to :invalid_autosave_author, class_name: 'InvalidAuthor', foreign_key: 'author_id', autosave: true
end

class Author < ActiveRecord::Base; end
class AbortAuthor < Author
  before_save { throw(:abort) }
end
class InvalidAuthor < Author
  validates :name, presence: true
end

class BugTest < Minitest::Test
  def teardown
    Post.delete_all
    Comment.delete_all
    Supplier.delete_all
    Account.delete_all
    Book.delete_all
    Author.delete_all
  end

  def test_has_many
    post = Post.new
    post.comments.build
    assert post.save!

    assert_equal 1, Post.count
    assert_equal 1, Comment.count
  end

  def test_has_many_autosave
    post = Post.new
    post.autosave_comments.build
    assert post.save!

    assert_equal 1, Post.count
    assert_equal 1, Comment.count
  end

  def test_has_many_abort
    post = Post.new
    post.abort_comments.build
    assert_raises(ActiveRecord::RecordInvalid) { post.save!}

    assert_equal 0, Post.count
    assert_equal 0, Comment.count
  end

  def test_has_many_abort_autosave
    post = Post.new
    post.abort_autosave_comments.build
    assert_raises(ActiveRecord::RecordInvalid) { post.save!}

    assert_equal 0, Post.count
    assert_equal 0, Comment.count
  end

  def test_has_many_invalid
    post = Post.new
    post.invalid_comments.build
    assert_raises(ActiveRecord::RecordInvalid) { post.save!}

    assert_equal 0, Post.count
    assert_equal 0, Comment.count
  end

  def test_has_many_invalid_autosave
    post = Post.new
    post.invalid_autosave_comments.build
    assert_raises(ActiveRecord::RecordInvalid) { post.save!}

    assert_equal 0, Post.count
    assert_equal 0, Comment.count
  end

  def test_has_one
    supplier = Supplier.new
    supplier.build_account
    assert supplier.save!

    assert_equal 1, Supplier.count
    assert_equal 1, Account.count
  end

  def test_has_one_autosave
    supplier = Supplier.new
    supplier.build_autosave_account
    assert supplier.save!

    assert_equal 1, Supplier.count
    assert_equal 1, Account.count
  end

  def test_has_one_abort
    supplier = Supplier.new
    supplier.build_abort_account
    assert supplier.save!

    assert_equal 1, Supplier.count
    assert_equal 0, Account.count
  end

  def test_has_one_abort_autosave
    supplier = Supplier.new
    supplier.build_abort_autosave_account
    assert_raises(ActiveRecord::RecordNotSaved) { supplier.save! }

    assert_equal 0, Supplier.count
    assert_equal 0, Account.count
  end

  def test_has_one_invalid
    supplier = Supplier.new
    supplier.build_invalid_account
    assert supplier.save!

    assert_equal 1, Supplier.count
    assert_equal 0, Account.count
  end

  def test_has_one_invalid_autosave
    supplier = Supplier.new
    supplier.build_invalid_autosave_account
    assert_raises(ActiveRecord::RecordInvalid) { supplier.save! }

    assert_equal 0, Supplier.count
    assert_equal 0, Account.count
  end

  def test_belongs_to
    book = Book.new
    book.build_author
    assert book.save!

    assert_equal 1, Book.count
    assert_equal 1, Author.count
  end

  def test_belongs_to_autosave
    book = Book.new
    book.build_autosave_author
    assert book.save!

    assert_equal 1, Book.count
    assert_equal 1, Author.count
  end

  def test_belongs_to_abort
    book = Book.new
    book.build_abort_author
    assert book.save!

    assert_equal 1, Book.count
    assert_equal 0, Author.count
  end

  def test_belongs_to_abort_autosave
    book = Book.new
    book.build_abort_autosave_author
    assert_raises(ActiveRecord::RecordNotSaved) { book.save! }

    assert_equal 0, Book.count
    assert_equal 0, Author.count
  end

  def test_belongs_to_invalid
    book = Book.new
    book.build_invalid_author
    assert book.save!

    assert_equal 1, Book.count
    assert_equal 0, Author.count
  end

  def test_belongs_to_invalid_autosave
    book = Book.new
    book.build_invalid_autosave_author
    assert_raises(ActiveRecord::RecordInvalid) { book.save! }

    assert_equal 0, Book.count
    assert_equal 0, Author.count
  end
end
```

</details>

This test describes the consistent behavior of each association, but when I run it the test fails only in the case of `has_one` + abort + autosave:

```
Finished in 0.073115s, 246.1875 runs/s, 711.2084 assertions/s.

  1) Failure:
BugTest#test_has_one_abort_autosave [test.rb:191]:
ActiveRecord::RecordNotSaved expected but nothing was raised.

18 runs, 52 assertions, 1 failures, 0 errors, 0 skips
```

Also, in Active Record's documentation on callbacks, you'll find something like this:

> If a before_* callback cancels the action a ROLLBACK is issued. You can also trigger a ROLLBACK raising an exception in any of the callbacks, including after_* hooks. Note, however, that in that case the client needs to be aware of it because an ordinary [#save](https://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-save) will raise such exception instead of quietly returning false.

https://github.com/rails/rails/blob/v7.0.6/activerecord/lib/active_record/callbacks.rb#L268-L272

The current behavior of `has_one` seems to contradict this explanation.

Note that this behavior has been around for a long time and is not a regression. As far as I can see, https://github.com/rails/rails/issues/22184 mentions the same issue.

A possible fix would be to `throw(:abort)` if `save_has_one_association` returns `false`, as with `belongs_to`, but we need to investigate whether it works correctly under multiple conditions.
https://github.com/rails/rails/blob/v7.0.6/activerecord/lib/active_record/autosave_association.rb#L198
https://github.com/rails/rails/blob/v7.0.6/activerecord/lib/active_record/autosave_association.rb#L210

### System configuration
**Rails version**:
```
7.0.6
```

**Ruby version**:
```
ruby 3.0.6p216 (2023-03-30 revision 23a532679b) [arm64-darwin22]
```","{'url': 'https://api.github.com/repos/rails/rails/issues/48633/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48633/timeline,,
https://api.github.com/repos/rails/rails/issues/48629,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48629/labels{/name},https://api.github.com/repos/rails/rails/issues/48629/comments,https://api.github.com/repos/rails/rails/issues/48629/events,https://github.com/rails/rails/issues/48629,1785111394,I_kwDNIULOamajYg,48629,Rails 7.0.6 label_for translations not working in index views,"{'login': 'augustosamame', 'id': 16038063, 'node_id': 'MDQ6VXNlcjE2MDM4MDYz', 'avatar_url': 'https://avatars.githubusercontent.com/u/16038063?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/augustosamame', 'html_url': 'https://github.com/augustosamame', 'followers_url': 'https://api.github.com/users/augustosamame/followers', 'following_url': 'https://api.github.com/users/augustosamame/following{/other_user}', 'gists_url': 'https://api.github.com/users/augustosamame/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/augustosamame/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/augustosamame/subscriptions', 'organizations_url': 'https://api.github.com/users/augustosamame/orgs', 'repos_url': 'https://api.github.com/users/augustosamame/repos', 'events_url': 'https://api.github.com/users/augustosamame/events{/privacy}', 'received_events_url': 'https://api.github.com/users/augustosamame/received_events', 'type': 'User', 'site_admin': False}","[{'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,4,2023-07-03T01:29:09Z,2023-10-02T21:51:34Z,,NONE,,,,"### Steps to reproduce

generate a new rails project
generate a scaffold: `rails g scaffold Post title body`
run migrations
modify i18n `en.yml` file with the following content:

```
en:
  hello: ""Hello world""
  activerecord:
    attributes:
      post:
        title: ""Title from i18n""
        body: ""Body from i18n""
```

Replace the labels in both index and show views with `<%= label(:post, :body) %>`
Or you can even do the replace in the single `posts` shared partial

```
<div id=""<%= dom_id post %>"">
  <p>
    <strong>Title:</strong>
    <%= post.title %>
  </p>

  <p>
    <strong><%= label(:post, :body) %>:</strong>
    <%= post.body %>
  </p>

</div>

```

### Expected behavior

The body label should show 'Body from i18n' in all views

### Actual behavior

All views show correct translated label. Index view shows the incorrect (default) `body` label

I did some testing and all views are fine, but for some reason, index view fails.


### System configuration

**Rails version 7.0.6**:

**Ruby version 3.2.2**:
","{'url': 'https://api.github.com/repos/rails/rails/issues/48629/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48629/timeline,,
https://api.github.com/repos/rails/rails/issues/48628,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48628/labels{/name},https://api.github.com/repos/rails/rails/issues/48628/comments,https://api.github.com/repos/rails/rails/issues/48628/events,https://github.com/rails/rails/pull/48628,1784594954,PR_kwDNIULOVHEbRg,48628,PostgreSQL reload virtual columns on update via RETURNING clause,"{'login': 'abaldwin88', 'id': 15172605, 'node_id': 'MDQ6VXNlcjE1MTcyNjA1', 'avatar_url': 'https://avatars.githubusercontent.com/u/15172605?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/abaldwin88', 'html_url': 'https://github.com/abaldwin88', 'followers_url': 'https://api.github.com/users/abaldwin88/followers', 'following_url': 'https://api.github.com/users/abaldwin88/following{/other_user}', 'gists_url': 'https://api.github.com/users/abaldwin88/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/abaldwin88/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/abaldwin88/subscriptions', 'organizations_url': 'https://api.github.com/users/abaldwin88/orgs', 'repos_url': 'https://api.github.com/users/abaldwin88/repos', 'events_url': 'https://api.github.com/users/abaldwin88/events{/privacy}', 'received_events_url': 'https://api.github.com/users/abaldwin88/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-07-02T11:30:36Z,2023-09-19T18:18:05Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48628', 'html_url': 'https://github.com/rails/rails/pull/48628', 'diff_url': 'https://github.com/rails/rails/pull/48628.diff', 'patch_url': 'https://github.com/rails/rails/pull/48628.patch', 'merged_at': None}","Extends Active Record to automatically reload virtual columns on update when using PostgreSQL. This is done by issuing a single UPDATE query that includes a RETURNING clause.

### Motivation

Saves an extra round trip to the database for reload and removes a developer pitfall around stale values.

### Detail

Given a `Post` model represented by the following schema:
```ruby
create_table :posts do |t|
  t.integer :upvotes_count
  t.integer :downvotes_count
  t.virtual :total_votes_count, type: :integer, as: ""upvotes_count + downvotes_count"", stored: true
end
```
`total_votes_count` will reflect the sum of upvotes and downvotes after `update` is successfully called. Prior to this change calling `reload` would have been necessary to obtain the value calculated by the database.
```ruby
post = Post.find(1)
post.update(upvotes_count: 2, downvotes_count: 2)
# Calling `post.reload` no longer necessary
post.total_votes => 4
```

* At this moment MySQL and SQLite adapters do not support this behavior

### Additional information

* Follow-up from PR #48241
* Related to PR #48434
* Closes #48423 when using Postgresql

CC: @nvasilevski

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

","{'url': 'https://api.github.com/repos/rails/rails/issues/48628/reactions', 'total_count': 7, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 3, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48628/timeline,,
https://api.github.com/repos/rails/rails/issues/48619,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48619/labels{/name},https://api.github.com/repos/rails/rails/issues/48619/comments,https://api.github.com/repos/rails/rails/issues/48619/events,https://github.com/rails/rails/pull/48619,1783188419,PR_kwDNIULOVF22eQ,48619,Add attributes_with_aliases and attribute_names_with_aliases,"{'login': 'kawamotosatoshi', 'id': 18253416, 'node_id': 'MDQ6VXNlcjE4MjUzNDE2', 'avatar_url': 'https://avatars.githubusercontent.com/u/18253416?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kawamotosatoshi', 'html_url': 'https://github.com/kawamotosatoshi', 'followers_url': 'https://api.github.com/users/kawamotosatoshi/followers', 'following_url': 'https://api.github.com/users/kawamotosatoshi/following{/other_user}', 'gists_url': 'https://api.github.com/users/kawamotosatoshi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kawamotosatoshi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kawamotosatoshi/subscriptions', 'organizations_url': 'https://api.github.com/users/kawamotosatoshi/orgs', 'repos_url': 'https://api.github.com/users/kawamotosatoshi/repos', 'events_url': 'https://api.github.com/users/kawamotosatoshi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kawamotosatoshi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-30T21:34:32Z,2023-07-01T03:21:54Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48619', 'html_url': 'https://github.com/rails/rails/pull/48619', 'diff_url': 'https://github.com/rails/rails/pull/48619.diff', 'patch_url': 'https://github.com/rails/rails/pull/48619.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because get attributes with aliases.

For more information, please check here.
https://discuss.rubyonrails.org/t/i-would-like-an-idea-to-create-an-issue-about-add-alias-attribute-to-method-attributes/82793

### Detail

This Pull Request changes ActiveModel and ActiveRecord

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

```
% cd activemodel
% bin/test test/cases/attributes_test.rb 
Run options: --seed 887

# Running:

................

Finished in 0.009967s, 1605.2975 runs/s, 3411.2571 assertions/s.
16 runs, 34 assertions, 0 failures, 0 errors, 0 skips
```

```
% cd activerecord
% bin/test test/cases/attribute_methods_test.rb
Using sqlite3
Run options: --seed 19232

# Running:

................................................................................................................

Finished in 0.629886s, 177.8100 runs/s, 779.5061 assertions/s.
112 runs, 491 assertions, 0 failures, 0 errors, 0 skips
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48619/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48619/timeline,,
https://api.github.com/repos/rails/rails/issues/48607,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48607/labels{/name},https://api.github.com/repos/rails/rails/issues/48607/comments,https://api.github.com/repos/rails/rails/issues/48607/events,https://github.com/rails/rails/pull/48607,1780019106,PR_kwDNIULOVDMDYA,48607,Add option apply_on_subqueries to associations,"{'login': 'lazaronixon', 'id': 2651240, 'node_id': 'MDQ6VXNlcjI2NTEyNDA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2651240?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lazaronixon', 'html_url': 'https://github.com/lazaronixon', 'followers_url': 'https://api.github.com/users/lazaronixon/followers', 'following_url': 'https://api.github.com/users/lazaronixon/following{/other_user}', 'gists_url': 'https://api.github.com/users/lazaronixon/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lazaronixon/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lazaronixon/subscriptions', 'organizations_url': 'https://api.github.com/users/lazaronixon/orgs', 'repos_url': 'https://api.github.com/users/lazaronixon/repos', 'events_url': 'https://api.github.com/users/lazaronixon/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lazaronixon/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-06-29T02:35:40Z,2023-07-31T14:00:00Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48607', 'html_url': 'https://github.com/rails/rails/pull/48607', 'diff_url': 'https://github.com/rails/rails/pull/48607.diff', 'patch_url': 'https://github.com/rails/rails/pull/48607.patch', 'merged_at': None}","### Motivation / Background

Add option to merge association scopes to subqueries.

It removes a breaking change introduced by #48487. Conditions that were not applied in
previous versions would be applied giving people different results.

Set the option on an association:

```ruby
class Author < ApplicationRecord
  has_many :welcome_posts, -> { where(title: ""welcome"") } , class_name: ""Post""
  has_many :welcome_posts_scoped, -> { where(title: ""Welcome"") }, class_name: ""Post"", apply_on_subqueries: true
end
```

Then the association scope will be merged into the subquery.

```ruby
Author.where(welcome_posts: Post.all)
#=> SELECT (...) WHERE ""authors"".""id"" IN (SELECT ""posts"".""author_id"" FROM ""posts"")

Author.where(welcome_posts_scoped: Post.all)
#=> SELECT (...) WHERE ""authors"".""id"" IN (SELECT ""posts"".""author_id"" FROM ""posts"" WHERE ""posts"".""title"" = 'welcome')    
```

### Additional information

https://github.com/rails/rails/pull/48487#issuecomment-1612150489

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48607/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48607/timeline,,
https://api.github.com/repos/rails/rails/issues/48601,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48601/labels{/name},https://api.github.com/repos/rails/rails/issues/48601/comments,https://api.github.com/repos/rails/rails/issues/48601/events,https://github.com/rails/rails/issues/48601,1779265516,I_kwDNIULOag1v7A,48601,Test Fixture Not Decrypting Properly with store_accessor,"{'login': 'donnfelker', 'id': 91827, 'node_id': 'MDQ6VXNlcjkxODI3', 'avatar_url': 'https://avatars.githubusercontent.com/u/91827?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/donnfelker', 'html_url': 'https://github.com/donnfelker', 'followers_url': 'https://api.github.com/users/donnfelker/followers', 'following_url': 'https://api.github.com/users/donnfelker/following{/other_user}', 'gists_url': 'https://api.github.com/users/donnfelker/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/donnfelker/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/donnfelker/subscriptions', 'organizations_url': 'https://api.github.com/users/donnfelker/orgs', 'repos_url': 'https://api.github.com/users/donnfelker/repos', 'events_url': 'https://api.github.com/users/donnfelker/events{/privacy}', 'received_events_url': 'https://api.github.com/users/donnfelker/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 5511275119, 'node_id': 'LA_kwDNIULPAAAAAUh_Ym8', 'url': 'https://api.github.com/repos/rails/rails/labels/encryption', 'name': 'encryption', 'color': '8D3EA8', 'default': False, 'description': ''}]",open,False,,[],,3,2023-06-28T16:07:31Z,2023-09-29T20:29:14Z,,NONE,,,,"### Steps to reproduce
1. Create new rails app with postgresql as db
2. Add jsonb field to model via migration with name `settings`
3. Add store_accessor to model
4. encrypt store_accessor field with `encrypts` 
5. Add encryption keys to envs as per [docs](https://guides.rubyonrails.org/active_record_encryption.html#setup)
6. Add `config.active_record.encryption.encrypt_fixtures = true` to `test.rb`
7. Add data to test fixture (posts.yml) with the field that needs to be encrypted
8. Write test to obtain test fixture and ensure it is being encrypted/decrypted properly
9. Test fails with `Minitest::UnexpectedError: ActiveRecord::Encryption::Errors::Decryption: ActiveRecord::Encryption::Errors::Decryption`

### Executable Test Case
You will also need a value in the `posts.yml` file as such: 
```yml
one:
  name: Hello World
  settings:
    public_key: ""some-fake-public-key""
```

Test Case
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.0.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""postgresql"", database: ""jsonb-test"")
ActiveRecord::Base.logger = Logger.new(STDOUT)
ActiveRecord::Encryption.configure \
      primary_key: ""nYlllafgBdhQ7Vn37dlWAoqfDbTPl4Fl"",
      deterministic_key: ""CK7x2oUEeu06bKehhKGiKYAHoytPaOPg"",
      key_derivation_salt: ""Fol1dR03ZXnL8k4hEUYj7IMr0UlgOMHC""

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.jsonb :settings
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_many :comments

  store_accessor :settings, [:public_key], suffix: :setting
  encrypts :settings
end

class Comment < ActiveRecord::Base
  belongs_to :post
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = posts(:one)
    assert_equal ""some-fake-public-key"", post.public_key_setting
  end
end

```

### Expected behavior
The test should be able to store the value for the fixture, encrypted and then it should be able to retrieve it and decrypt it.

### Actual behavior
Test fails with error: `Minitest::UnexpectedError: ActiveRecord::Encryption::Errors::Decryption: ActiveRecord::Encryption::Errors::Decryption`

### System configuration
**Rails version**: 7.0.5.1

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48601/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48601/timeline,,
https://api.github.com/repos/rails/rails/issues/48591,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48591/labels{/name},https://api.github.com/repos/rails/rails/issues/48591/comments,https://api.github.com/repos/rails/rails/issues/48591/events,https://github.com/rails/rails/pull/48591,1776767023,PR_kwDNIULOVAZ7nQ,48591,Add support for :prefix option in relations.,"{'login': 'Nerian', 'id': 259568, 'node_id': 'MDQ6VXNlcjI1OTU2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/259568?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Nerian', 'html_url': 'https://github.com/Nerian', 'followers_url': 'https://api.github.com/users/Nerian/followers', 'following_url': 'https://api.github.com/users/Nerian/following{/other_user}', 'gists_url': 'https://api.github.com/users/Nerian/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Nerian/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Nerian/subscriptions', 'organizations_url': 'https://api.github.com/users/Nerian/orgs', 'repos_url': 'https://api.github.com/users/Nerian/repos', 'events_url': 'https://api.github.com/users/Nerian/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Nerian/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-27T12:00:28Z,2023-06-27T12:11:09Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48591', 'html_url': 'https://github.com/rails/rails/pull/48591', 'diff_url': 'https://github.com/rails/rails/pull/48591.diff', 'patch_url': 'https://github.com/rails/rails/pull/48591.patch', 'merged_at': None}","### Motivation / Background

Our application is multi-tenant and storing files in S3 was an organizational issue due to ActiveStorage storing the files at the root level in a flat structure. Instead we would like some semantic structure, for example we would like to have all files related  to active storage to be in the active_storage top folder, and then for each tenant our of application we will further namespace. Example of the intended structure:

S3/active_storage/tenant_id/some_file_uid
S3/active_storage/tenant_id/some_file_uid

This Pull Request has been created in order to support this kind of structure.

Allows for configuring a custom prefix for Blob keys.

```
    Rails.application.configure do
      config.active_storage.blob_prefix = 'active_storage'
    end
```

This will store Blobs in a path like active_storage/<random_key>. You may also configure an additional level of prefix on each relation.

```
    class User < ActiveRecord::Base
      has_one_attached :avatar, prefix: 'avatars'
    end
```

This will store Blobs in a path like active_storage/avatars/<random_key>. Or even generate it using information on the record:

```
    class User < ActiveRecord::Base
      belongs_to :tenant
      has_one_attached :avatar, prefix: -> (record, attachment) { record.tenant.name }
    end
```

This will store Blobs in a path like active_storage/account_1/<random_key>

### Detail

This Pull Request changes to Active Storage. Particularly it makes the association macros determine the blob id, if given the option `:prefix`.

### Additional information

We are using this in production right now. Working fine so far. We do not use direct upload. Unsure if this may affect it.

Other people interested in this sort of functionality:
* https://github.com/rails/rails/issues/38161
* https://github.com/rails/rails/issues/32790

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48591/reactions', 'total_count': 8, '+1': 7, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48591/timeline,,
https://api.github.com/repos/rails/rails/issues/48585,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48585/labels{/name},https://api.github.com/repos/rails/rails/issues/48585/comments,https://api.github.com/repos/rails/rails/issues/48585/events,https://github.com/rails/rails/pull/48585,1775913042,PR_kwDNIULOU_r34g,48585,Active Job: Correctly use the desired test adapter in tests,"{'login': 'ghiculescu', 'id': 509837, 'node_id': 'MDQ6VXNlcjUwOTgzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/509837?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ghiculescu', 'html_url': 'https://github.com/ghiculescu', 'followers_url': 'https://api.github.com/users/ghiculescu/followers', 'following_url': 'https://api.github.com/users/ghiculescu/following{/other_user}', 'gists_url': 'https://api.github.com/users/ghiculescu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ghiculescu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ghiculescu/subscriptions', 'organizations_url': 'https://api.github.com/users/ghiculescu/orgs', 'repos_url': 'https://api.github.com/users/ghiculescu/repos', 'events_url': 'https://api.github.com/users/ghiculescu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ghiculescu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-27T01:01:04Z,2023-09-25T20:28:16Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48585', 'html_url': 'https://github.com/rails/rails/pull/48585', 'diff_url': 'https://github.com/rails/rails/pull/48585.diff', 'patch_url': 'https://github.com/rails/rails/pull/48585.patch', 'merged_at': None}","### Motivation / Background

Currently if you set `config.active_job.queue_adapter = (anything)` in `config/application.rb` or `config/environments/test.rb`, this config will be respected by some test cases but not others.

Specifically, in `ActionDispatch::IntegrationTest`, `ActionMailer::TestCase`, and `ActiveJob::TestCase`, the test adapter will still be `TestAdapter`, while in other test cases it will be `InlineAdapter`.

I think you'd expect that if you set the test adapter for an environment, that test adapter would be available everywhere in that environment. For example, you might want to use the Delayed Job test adapter in your test environment so that you can have your test code more closely match production. The feedback on https://github.com/rails/rails/issues/37270 echoes this, but the workaround suggested there of disabling the test adapter on specific klasses is not reliable.

### Detail

The logic to determine which queue adapter a job uses is quite confusing.

Here is how it works on `main` currently:

1. If running in a test, and the test class includes `ActiveJob::TestHelper` and overrides `queue_adapter_for_test`, then the `queue_adapter_for_test` adapter is used.
2. Otherwise, if running in a test, and the test class includes `ActiveJob::TestHelper`, then the `:test` adapter is used.
3. Otherwise, if `self.queue_adapter` is set on the job class, that adapter is used.
4. Otherwise, if `self.queue_adapter` is set on the job's superclass (eg. `ApplicationJob`), that adapter is used. 
5. Fall back to `Rails.application.config.active_job.queue_adapter` as configured by the user.
6. If not configured by the user, `Rails.application.config.active_job.queue_adapter` defaults to `:async`.
7. Fall back to `:async` if no Rails config set (eg. using Active Job as a standalone).

As noted above, only some of the built in test classes include `ActiveJob::TestHelper`. Also, setting a queue adapter on a specific job class is rare (typically you would not want different jobs to be performed by different backends). So in practice, in development/production, option 5 is used. And in test, options 2 and 5 are used, depending on the type of test.

This PR changes the logic to work as follows:

1. If `self.queue_adapter` is set on the job class, that adapter is used.
2. Otherwise, if `self.queue_adapter` is set on the job's superclass (eg. `ApplicationJob`), that adapter is used. 
3. If running in a test, and the test class includes `ActiveJob::TestHelper` and overrides `queue_adapter_for_test`, then the `queue_adapter_for_test` adapter is used.
4. Fall back to `Rails.application.config.active_job.queue_adapter` as configured by the user.
5. If not configured by the user, `Rails.application.config.active_job.queue_adapter` defaults to `:test` if `Rails.env.test?`, otherwise it defaults to `:async`.
6. If running in a test, and the test class includes `ActiveJob::TestHelper`, and no other adapter has been set (eg. using Active Job as a standalone), then use `:test`.
7. Otherwise, fall back to `:async`.

The key changes are:

- Now, if you set a `queue_adapter` on a job class, that will always be respected.
- The `queue_adapter_for_test` override still works, but it no longer takes priority over a queue adapter set on a specific job class. Since I think both of these techniques are rare, and the impact of this change only exists in a test environment, I think it is a relatively safe change.
- The default queue adapter in Rails config is now env-dependent. (It's `:test` in the `test` environment, and `:async` in all others.)

The default rails environment templates suggest [setting a specific queue adapter only in production](https://github.com/rails/rails/blob/f46d3452ae30c46d3e213c687decbbca0cee9119/railties/lib/rails/generators/rails/app/templates/config/environments/production.rb.tt#L79C12-L79C12). For users who do that, there will be no changes to behaviour with this PR.

For users who are more granular, by setting per-job queue adapters, things should continue to work as expected with this PR.

**The real change is for users who set a default queue adapter across all environments (as in this issue: https://github.com/rails/rails/issues/37270). For them, this PR solves the issue where some tests use the desired queue adapter, and other tests don't.**

### Additional information

Fixes: https://github.com/rails/rails/issues/37270

ref: https://github.com/bensheldon/good_job/issues/846
ref: https://github.com/rails/rails/issues/26360 - this PR changes the behavior here, which I think was overzealous.

I extracted out some other PRs to fix internal issues while working on this: https://github.com/rails/rails/pull/48623, https://github.com/rails/rails/pull/48626. I also extracted https://github.com/rails/rails/pull/48599 out as a non-controversial fix prior to this PR.



### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48585/reactions', 'total_count': 11, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 4, 'rocket': 3, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48585/timeline,,
https://api.github.com/repos/rails/rails/issues/48583,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48583/labels{/name},https://api.github.com/repos/rails/rails/issues/48583/comments,https://api.github.com/repos/rails/rails/issues/48583/events,https://github.com/rails/rails/pull/48583,1775775216,PR_kwDNIULOU_klww,48583,Add a rake task for checking various release related utilities,"{'login': 'tenderlove', 'id': 3124, 'node_id': 'MDQ6VXNlcjMxMjQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3124?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/tenderlove', 'html_url': 'https://github.com/tenderlove', 'followers_url': 'https://api.github.com/users/tenderlove/followers', 'following_url': 'https://api.github.com/users/tenderlove/following{/other_user}', 'gists_url': 'https://api.github.com/users/tenderlove/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/tenderlove/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/tenderlove/subscriptions', 'organizations_url': 'https://api.github.com/users/tenderlove/orgs', 'repos_url': 'https://api.github.com/users/tenderlove/repos', 'events_url': 'https://api.github.com/users/tenderlove/events{/privacy}', 'received_events_url': 'https://api.github.com/users/tenderlove/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,0,2023-06-26T22:26:30Z,2023-06-27T19:00:05Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48583', 'html_url': 'https://github.com/rails/rails/pull/48583', 'diff_url': 'https://github.com/rails/rails/pull/48583.diff', 'patch_url': 'https://github.com/rails/rails/pull/48583.patch', 'merged_at': None}","This commit adds a rake task that checks various utilities are working before releasing Rails.  The problem we're trying to avoid is commands failing halfway through the release (for example maybe you're not logged in to npmjs). The check task is fairly opinionated, it requires that:

* Use a YubiKey for storing OTPs
  * The `ykman` utility is installed
  * The OTP name for RubyGems has `rubygems.org` in the name
  * The OTP name for NPM has `npmjs.com` in the name
* You are logged in to RubyGems
* You are logged in to npmjs
* You are logged in to the `gh` utility

If the task fails, then no gems will be pushed and it gives you an opportunity to fix your environment.  Basically I want to automate [this section](https://github.com/rails/rails/blob/main/RELEASING_RAILS.md#check-credentials-for-rubygems-npm-and-github) in our release documentation.

See [this blog post](https://tenderlovemaking.com/2021/10/26/publishing-gems-with-your-yubikey.html) for configuring your YubiKey.","{'url': 'https://api.github.com/repos/rails/rails/issues/48583/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48583/timeline,,
https://api.github.com/repos/rails/rails/issues/48582,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48582/labels{/name},https://api.github.com/repos/rails/rails/issues/48582/comments,https://api.github.com/repos/rails/rails/issues/48582/events,https://github.com/rails/rails/pull/48582,1775657560,PR_kwDNIULOU_e__A,48582,Introduce ActiveRecord::Base#preload on a record,"{'login': 'kirs', 'id': 522155, 'node_id': 'MDQ6VXNlcjUyMjE1NQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/522155?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kirs', 'html_url': 'https://github.com/kirs', 'followers_url': 'https://api.github.com/users/kirs/followers', 'following_url': 'https://api.github.com/users/kirs/following{/other_user}', 'gists_url': 'https://api.github.com/users/kirs/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kirs/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kirs/subscriptions', 'organizations_url': 'https://api.github.com/users/kirs/orgs', 'repos_url': 'https://api.github.com/users/kirs/repos', 'events_url': 'https://api.github.com/users/kirs/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kirs/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 257468118, 'node_id': 'MDU6TGFiZWwyNTc0NjgxMTg=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20work', 'name': 'needs work', 'color': '000000', 'default': False, 'description': None}]",open,False,,[],,5,2023-06-26T21:32:12Z,2023-06-27T22:32:32Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48582', 'html_url': 'https://github.com/rails/rails/pull/48582', 'diff_url': 'https://github.com/rails/rails/pull/48582.diff', 'patch_url': 'https://github.com/rails/rails/pull/48582.patch', 'merged_at': None}","Sometimes you might want to `preload` relations for a record that has already been loaded.
If you were to do it today, you'd either have to use private API (`ActiveRecord::Associations::Preloader`) or do something like

```
def method_that_wants_to_preload_and_receives_record(user)
  user = User.preload(:address, friends: [:address, :followers]).find(user.id)
end
```

However, that seems ugly and may result to unnecessary (but probably cached) query on `users` to find a record by a primary key.

It seems like an simple addition to introduce `preload` on a record that has already been loaded. That's what this PR does.","{'url': 'https://api.github.com/repos/rails/rails/issues/48582/reactions', 'total_count': 4, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 4, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48582/timeline,,
https://api.github.com/repos/rails/rails/issues/48569,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48569/labels{/name},https://api.github.com/repos/rails/rails/issues/48569/comments,https://api.github.com/repos/rails/rails/issues/48569/events,https://github.com/rails/rails/pull/48569,1772684021,PR_kwDNIULOU9Am5A,48569,Update datetime_local_field.rb,"{'login': 'chaffeqa', 'id': 287640, 'node_id': 'MDQ6VXNlcjI4NzY0MA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/287640?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/chaffeqa', 'html_url': 'https://github.com/chaffeqa', 'followers_url': 'https://api.github.com/users/chaffeqa/followers', 'following_url': 'https://api.github.com/users/chaffeqa/following{/other_user}', 'gists_url': 'https://api.github.com/users/chaffeqa/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/chaffeqa/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/chaffeqa/subscriptions', 'organizations_url': 'https://api.github.com/users/chaffeqa/orgs', 'repos_url': 'https://api.github.com/users/chaffeqa/repos', 'events_url': 'https://api.github.com/users/chaffeqa/events{/privacy}', 'received_events_url': 'https://api.github.com/users/chaffeqa/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2023-06-24T12:56:20Z,2023-07-06T03:03:24Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48569', 'html_url': 'https://github.com/rails/rails/pull/48569', 'diff_url': 'https://github.com/rails/rails/pull/48569.diff', 'patch_url': 'https://github.com/rails/rails/pull/48569.patch', 'merged_at': None}","Defaulted datetime-local to not use seconds


### Motivation / Background

Input of `datetime-local` specifies that the [value must be excluding seconds](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/datetime-local#value).  Although Chrome supports seconds, safari will validate client-side that the value is `not valid` and the form will not be submittable.



This Pull Request has been created because the default for rails should not error out in a popular browser.

### Detail

This Pull Request changes the default for `datetime-local` value conversion

### Additional information

<img width=""770"" alt=""Screenshot 2023-06-24 at 6 54 09 AM"" src=""https://github.com/rails/rails/assets/287640/917cf010-82fb-4f95-a2fc-54b85f6ab193"">

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48569/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48569/timeline,,
https://api.github.com/repos/rails/rails/issues/48568,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48568/labels{/name},https://api.github.com/repos/rails/rails/issues/48568/comments,https://api.github.com/repos/rails/rails/issues/48568/events,https://github.com/rails/rails/pull/48568,1772444158,PR_kwDNIULOU8ztrw,48568,Use `~=` instead of `IS NOT DISTINCT FROM` for the PostgreSQL geometric data types,"{'login': 'thukim', 'id': 1097697, 'node_id': 'MDQ6VXNlcjEwOTc2OTc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1097697?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/thukim', 'html_url': 'https://github.com/thukim', 'followers_url': 'https://api.github.com/users/thukim/followers', 'following_url': 'https://api.github.com/users/thukim/following{/other_user}', 'gists_url': 'https://api.github.com/users/thukim/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/thukim/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/thukim/subscriptions', 'organizations_url': 'https://api.github.com/users/thukim/orgs', 'repos_url': 'https://api.github.com/users/thukim/repos', 'events_url': 'https://api.github.com/users/thukim/events{/privacy}', 'received_events_url': 'https://api.github.com/users/thukim/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-24T04:24:06Z,2023-09-17T14:36:37Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48568', 'html_url': 'https://github.com/rails/rails/pull/48568', 'diff_url': 'https://github.com/rails/rails/pull/48568.diff', 'patch_url': 'https://github.com/rails/rails/pull/48568.patch', 'merged_at': None}","### Motivation / Background

The `~=` operator is available for 4 types point, box, polygon, circle, which represents the usual notion of equality. (other geometric data types, which are line, lseg, path, still work with `IS NOT DISTINCT FROM` / = operator)

A typical example of how `~=` works is: box '((3,4),(5,5))' ~=  box '((3,4),(5,5))' -> t; box '((3,4),(5,5))' ~=  box '((5,5),(3,4))' -> t 
Ref https://www.postgresql.org/docs/15/functions-geometry.html

<img width=""1292"" alt=""Screenshot 2023-06-24 at 16 09 58"" src=""https://github.com/rails/rails/assets/1097697/0dd4b8c9-5096-4b5b-bcf8-8d726f09cafb"">


Fixes #48497

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48568/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48568/timeline,,
https://api.github.com/repos/rails/rails/issues/48562,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48562/labels{/name},https://api.github.com/repos/rails/rails/issues/48562/comments,https://api.github.com/repos/rails/rails/issues/48562/events,https://github.com/rails/rails/pull/48562,1770396868,PR_kwDNIULOU7HLxw,48562,[Fix #46653] `becomes` losing target class default value,"{'login': 'abaldwin88', 'id': 15172605, 'node_id': 'MDQ6VXNlcjE1MTcyNjA1', 'avatar_url': 'https://avatars.githubusercontent.com/u/15172605?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/abaldwin88', 'html_url': 'https://github.com/abaldwin88', 'followers_url': 'https://api.github.com/users/abaldwin88/followers', 'following_url': 'https://api.github.com/users/abaldwin88/following{/other_user}', 'gists_url': 'https://api.github.com/users/abaldwin88/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/abaldwin88/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/abaldwin88/subscriptions', 'organizations_url': 'https://api.github.com/users/abaldwin88/orgs', 'repos_url': 'https://api.github.com/users/abaldwin88/repos', 'events_url': 'https://api.github.com/users/abaldwin88/events{/privacy}', 'received_events_url': 'https://api.github.com/users/abaldwin88/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-22T21:07:04Z,2023-06-22T21:38:22Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48562', 'html_url': 'https://github.com/rails/rails/pull/48562', 'diff_url': 'https://github.com/rails/rails/pull/48562.diff', 'patch_url': 'https://github.com/rails/rails/pull/48562.patch', 'merged_at': None}","### Motivation / Background

Fixes #46653

### Detail

`becomes` is coping the `@attributes` from the original instance but the defaults are not being applied from the target class during initialization. Following the comments from the linked issue this PR will apply the default value if an attribute is nil and hasn't been changed.

","{'url': 'https://api.github.com/repos/rails/rails/issues/48562/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48562/timeline,,
https://api.github.com/repos/rails/rails/issues/48549,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48549/labels{/name},https://api.github.com/repos/rails/rails/issues/48549/comments,https://api.github.com/repos/rails/rails/issues/48549/events,https://github.com/rails/rails/pull/48549,1767971997,PR_kwDNIULOU5FRBA,48549,Qualify association unscope values with table names,"{'login': 'philip-maina', 'id': 76848245, 'node_id': 'MDQ6VXNlcjc2ODQ4MjQ1', 'avatar_url': 'https://avatars.githubusercontent.com/u/76848245?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/philip-maina', 'html_url': 'https://github.com/philip-maina', 'followers_url': 'https://api.github.com/users/philip-maina/followers', 'following_url': 'https://api.github.com/users/philip-maina/following{/other_user}', 'gists_url': 'https://api.github.com/users/philip-maina/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/philip-maina/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/philip-maina/subscriptions', 'organizations_url': 'https://api.github.com/users/philip-maina/orgs', 'repos_url': 'https://api.github.com/users/philip-maina/repos', 'events_url': 'https://api.github.com/users/philip-maina/events{/privacy}', 'received_events_url': 'https://api.github.com/users/philip-maina/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-21T16:24:58Z,2023-08-13T22:48:38Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48549', 'html_url': 'https://github.com/rails/rails/pull/48549', 'diff_url': 'https://github.com/rails/rails/pull/48549.diff', 'patch_url': 'https://github.com/rails/rails/pull/48549.patch', 'merged_at': None}","### Motivation

Fixes #48548 

### Checklist
Before submitting the PR make sure the following are checked:

- [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
- [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: [Fix #issue-number]
- [x] Tests are added or updated if you fix a bug or add a feature.
- [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48549/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48549/timeline,,
https://api.github.com/repos/rails/rails/issues/48548,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48548/labels{/name},https://api.github.com/repos/rails/rails/issues/48548/comments,https://api.github.com/repos/rails/rails/issues/48548/events,https://github.com/rails/rails/issues/48548,1767971401,I_kwDNIULOaWEaSQ,48548,`unscope` on `through` associations fails to respect default scope of join models,"{'login': 'philip-maina', 'id': 76848245, 'node_id': 'MDQ6VXNlcjc2ODQ4MjQ1', 'avatar_url': 'https://avatars.githubusercontent.com/u/76848245?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/philip-maina', 'html_url': 'https://github.com/philip-maina', 'followers_url': 'https://api.github.com/users/philip-maina/followers', 'following_url': 'https://api.github.com/users/philip-maina/following{/other_user}', 'gists_url': 'https://api.github.com/users/philip-maina/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/philip-maina/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/philip-maina/subscriptions', 'organizations_url': 'https://api.github.com/users/philip-maina/orgs', 'repos_url': 'https://api.github.com/users/philip-maina/repos', 'events_url': 'https://api.github.com/users/philip-maina/events{/privacy}', 'received_events_url': 'https://api.github.com/users/philip-maina/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-21T16:24:31Z,2023-06-30T07:56:23Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
Reproduction script:
<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
  end

  create_table :posts, force: true do |t|
    t.integer :user_id
    t.datetime :deleted_at
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.datetime :deleted_at
  end
end

class User < ActiveRecord::Base
  has_many :posts
  has_many :comments, through: :posts
end

class Post < ActiveRecord::Base
  default_scope -> { where deleted_at: nil }

  belongs_to :user
  has_many :comments, -> { with_deleted }
end

class Comment < ActiveRecord::Base
  default_scope -> { where deleted_at: nil }
  scope :with_deleted, -> { unscope where: :deleted_at }

  belongs_to :post
end

class BugTest < Minitest::Test
  def test_unscope_applied_on_correct_association
    user = User.create!

    active_post  = Post.create!(user: user)
    deleted_post = Post.create!(user: user, deleted_at: Time.now)


    active_post_active_comment   = Comment.create!(post: active_post)
    active_post_deleted_comment  = Comment.create!(post: active_post, deleted_at: Time.now)
    deleted_post_deleted_comment = Comment.create!(post: deleted_post, deleted_at: Time.now)

    # Should find only 2 comments (active_post_active_comment & active_post_deleted_comment) but finds all three
    assert_equal 2, user.comments.count
  end
end

```

### Expected behavior
The test should pass and return a count of 2

### Actual behavior
The test fails with a count of 3

### System configuration
**Rails version**: 7.0.4.3 / main

**Ruby version**: 3.1.3 / 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48548/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48548/timeline,,
https://api.github.com/repos/rails/rails/issues/48543,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48543/labels{/name},https://api.github.com/repos/rails/rails/issues/48543/comments,https://api.github.com/repos/rails/rails/issues/48543/events,https://github.com/rails/rails/issues/48543,1767071963,I_kwDNIULOaVNg2w,48543,ActionCable subscriptions are never created because welcome event is not received,"{'login': 'Georgegriff', 'id': 9056958, 'node_id': 'MDQ6VXNlcjkwNTY5NTg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9056958?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Georgegriff', 'html_url': 'https://github.com/Georgegriff', 'followers_url': 'https://api.github.com/users/Georgegriff/followers', 'following_url': 'https://api.github.com/users/Georgegriff/following{/other_user}', 'gists_url': 'https://api.github.com/users/Georgegriff/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Georgegriff/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Georgegriff/subscriptions', 'organizations_url': 'https://api.github.com/users/Georgegriff/orgs', 'repos_url': 'https://api.github.com/users/Georgegriff/repos', 'events_url': 'https://api.github.com/users/Georgegriff/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Georgegriff/received_events', 'type': 'User', 'site_admin': False}","[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,1,2023-06-21T08:33:29Z,2023-09-27T01:31:22Z,,NONE,,,,"### Steps to reproduce
I apologise upfront that i've not been able to produce a reproduction case, it involves some network conditions which breaks actioncable's default usage

We've been working with some of our customers who have reported our application not working as expected. The area relies on Action Cable subscriptions. We have observed the following behaviour.

1. We Create ActionCable in js
2. We immediately add a subscriber
```js
const consumer = ActionCable.createConsumer(""wss://..."");
consumer.subscriptions.create(
            ....
);
```
3. Server opens the connection and sends the welcome message (this is the rails code i've been looking at)
4. Websocket opens, but [welcome even](https://github.com/rails/rails/blob/e446ef82c8174a4bd6c98f670912bb395b3091d6/actioncable/lib/action_cable/connection/base.rb#L188)t is never received.

The result is that subscriptions are never  reloaded - (internal actioncable code)(https://github.com/rails/rails/blob/e446ef82c8174a4bd6c98f670912bb395b3091d6/actioncable/app/assets/javascripts/actioncable.esm.js#L253) when welcome is received, which should have created the subscription.

It's possible the reason this doesn't come up more is due to some specific network conditions, but we have enough diagnostics gathered in our system to show that this is the issue, we have open websockets but no subscriptions are established.

It is possible to workaround this by creating the subscriptions in the onOpen handler of the websocket instead, but this is circumventing the design of action cable.

In our logging we have collected we have no observed any connection instability.

> The logs are a combination of the action cable logs and some custom event handlers we have added to on message/open, to detect the issue.

```
  [
    ""[ActionCable]"",
    ""Opening WebSocket, current state is null, subprotocols: actioncable-v1-json,actioncable-unsupported"",
    1687331929209,
    ""Wed, 21 Jun 2023 07:18:49 GMT""
  ],
  [
    ""[ActionCable]"",
    ""ConnectionMonitor started. stale threshold = 6 s"",
    1687331929210,
    ""Wed, 21 Jun 2023 07:18:49 GMT""
  ],
  [
    ""[SUCCESS]"",
    ""WebSocket onopen event"",
    ""Wed, 21 Jun 2023 07:18:49 GMT""
  ],
  [
    ""[ActionCable]"",
    ""WebSocket onopen event, using 'actioncable-v1-json' subprotocol"",
    1687331929446,
    ""Wed, 21 Jun 2023 07:18:49 GMT""
  ],
   [
    ""[WARN]"",
    ""Welcome not received within 20s"",
    ""Wed, 21 Jun 2023 07:19:09 GMT""
  ]
```
(These are extracted from logs where we have put a work around in place, but we have alerting to detect if the welcome event was never received)

[It's a different library but its possible that something like this might describe the issue? I'd just be guessing though
](https://github.com/pocoproject/poco/issues/1212)

### Expected behavior
ActionCable subscriptions should be initialised once the websocket has opened. The welcome should not be ""lost""
<!-- Tell us what should happen -->

### Actual behavior
Subscriptions never establish, websocket just is left open doing nothing.

### System configuration
**Rails version**:
6.1.7.2

[Looks like the logic that linked is broadly the same for actioncable in the version im using.
](https://github.com/rails/rails/blob/8798a6f2aa95e12f37993ba3c5a80fd0ac813dbb/actioncable/lib/action_cable/connection/base.rb#L175)**Ruby version**:
3.1.3
**Action cable NPM version**:
    ""@rails/actioncable"": ""^7.0.4-3"",

","{'url': 'https://api.github.com/repos/rails/rails/issues/48543/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48543/timeline,,
https://api.github.com/repos/rails/rails/issues/48541,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48541/labels{/name},https://api.github.com/repos/rails/rails/issues/48541/comments,https://api.github.com/repos/rails/rails/issues/48541/events,https://github.com/rails/rails/pull/48541,1766847053,PR_kwDNIULOU4HvDQ,48541,Add GlobalID to the API docs,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-21T06:29:25Z,2023-06-21T06:36:55Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48541', 'html_url': 'https://github.com/rails/rails/pull/48541', 'diff_url': 'https://github.com/rails/rails/pull/48541.diff', 'patch_url': 'https://github.com/rails/rails/pull/48541.patch', 'merged_at': None}","### Motivation / Background

GlobalID is a dependency of Active Job and Action Text. It adds `to_gid` and `to_sgid` methods to Active Model and Active Record classes.

Trying to find the documentation of these methods can be confusing as they are not present in the API docs.

### Detail

By symlinking the globalid gem from the Gemfile we can include it in the API documentation. After the `rdoc` task has run we can remove the symlink. I'd prefer to remove to symlink in an `ensure` block but that doesn't seem to be supported by Rake.

### Additional information

This could also be used to add all the `turbo-rails` methods to the API docs, like ` broadcast_append_to`  and `turbo_stream_from` (that is used in video demo on https://rubyonrails.org/.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48541/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48541/timeline,,
https://api.github.com/repos/rails/rails/issues/48540,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48540/labels{/name},https://api.github.com/repos/rails/rails/issues/48540/comments,https://api.github.com/repos/rails/rails/issues/48540/events,https://github.com/rails/rails/pull/48540,1766832528,PR_kwDNIULOU4G83Q,48540,Added Dockerfile instructions to remove artifacts and node_modules,"{'login': 'igor-alexandrov', 'id': 100725, 'node_id': 'MDQ6VXNlcjEwMDcyNQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/100725?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/igor-alexandrov', 'html_url': 'https://github.com/igor-alexandrov', 'followers_url': 'https://api.github.com/users/igor-alexandrov/followers', 'following_url': 'https://api.github.com/users/igor-alexandrov/following{/other_user}', 'gists_url': 'https://api.github.com/users/igor-alexandrov/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/igor-alexandrov/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/igor-alexandrov/subscriptions', 'organizations_url': 'https://api.github.com/users/igor-alexandrov/orgs', 'repos_url': 'https://api.github.com/users/igor-alexandrov/repos', 'events_url': 'https://api.github.com/users/igor-alexandrov/events{/privacy}', 'received_events_url': 'https://api.github.com/users/igor-alexandrov/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-21T06:16:44Z,2023-06-21T07:32:04Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48540', 'html_url': 'https://github.com/rails/rails/pull/48540', 'diff_url': 'https://github.com/rails/rails/pull/48540.diff', 'patch_url': 'https://github.com/rails/rails/pull/48540.patch', 'merged_at': None}","### Motivation / Background

I've tested Rails 7.1 Dockerfile template in Rails 7.0 app with MRSK on GitHub Actions and found that a bit more optimization can be applied.

### Detail

This Pull Request adds minor optimization to dockerignore template.

During the build process, the setup-ruby@v1 GitHub Action leaves artifacts in the ~/vendor/bundle folder, resulting in two full bundles in the final build: one in the default /usr/local/bundle directory specified in the Dockerfile template, and another in the /rails/vendor/bundle directory. By ignoring the /rails/vendor/bundle directory, we can significantly reduce the size of the final image. 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48540/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48540/timeline,,
https://api.github.com/repos/rails/rails/issues/48538,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48538/labels{/name},https://api.github.com/repos/rails/rails/issues/48538/comments,https://api.github.com/repos/rails/rails/issues/48538/events,https://github.com/rails/rails/pull/48538,1766634165,PR_kwDNIULOU3-OyA,48538,Support queries with regular expressions,"{'login': 'lazaronixon', 'id': 2651240, 'node_id': 'MDQ6VXNlcjI2NTEyNDA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2651240?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lazaronixon', 'html_url': 'https://github.com/lazaronixon', 'followers_url': 'https://api.github.com/users/lazaronixon/followers', 'following_url': 'https://api.github.com/users/lazaronixon/following{/other_user}', 'gists_url': 'https://api.github.com/users/lazaronixon/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lazaronixon/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lazaronixon/subscriptions', 'organizations_url': 'https://api.github.com/users/lazaronixon/orgs', 'repos_url': 'https://api.github.com/users/lazaronixon/repos', 'events_url': 'https://api.github.com/users/lazaronixon/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lazaronixon/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-21T03:57:38Z,2023-06-22T06:37:41Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48538', 'html_url': 'https://github.com/rails/rails/pull/48538', 'diff_url': 'https://github.com/rails/rails/pull/48538.diff', 'patch_url': 'https://github.com/rails/rails/pull/48538.patch', 'merged_at': None}","### Motivation / Background

Support queries with regular expressions on supported databases. (PostgreSQL/MySQL/SQLite)

```ruby
Post.where(title: /ThInKiNg/)
#=> SELECT * FROM posts WHERE title REGEXP 'ThInKiNg'; --MySQL/SQLite
#=> SELECT * FROM posts WHERE title ~* 'ThInKiNg'; --PostgreSQL

Post.where.not(title: /ThInKiNg/)
#=> SELECT * FROM posts WHERE title NOT REGEXP 'ThInKiNg'; --MySQL/SQLite
#=> SELECT * FROM posts WHERE title !~* 'ThInKiNg'; --PostgreSQL    
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48538/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48538/timeline,,
https://api.github.com/repos/rails/rails/issues/48535,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48535/labels{/name},https://api.github.com/repos/rails/rails/issues/48535/comments,https://api.github.com/repos/rails/rails/issues/48535/events,https://github.com/rails/rails/issues/48535,1766266191,I_kwDNIULOaUcVTw,48535,Change in ActiveRecord JSON/JSONB Query Behavior from Rails 6.0 to 6.1,"{'login': 'JohnAnon9771', 'id': 42195321, 'node_id': 'MDQ6VXNlcjQyMTk1MzIx', 'avatar_url': 'https://avatars.githubusercontent.com/u/42195321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JohnAnon9771', 'html_url': 'https://github.com/JohnAnon9771', 'followers_url': 'https://api.github.com/users/JohnAnon9771/followers', 'following_url': 'https://api.github.com/users/JohnAnon9771/following{/other_user}', 'gists_url': 'https://api.github.com/users/JohnAnon9771/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JohnAnon9771/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JohnAnon9771/subscriptions', 'organizations_url': 'https://api.github.com/users/JohnAnon9771/orgs', 'repos_url': 'https://api.github.com/users/JohnAnon9771/repos', 'events_url': 'https://api.github.com/users/JohnAnon9771/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JohnAnon9771/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2023-06-20T22:03:23Z,2023-06-26T16:19:42Z,,CONTRIBUTOR,,,,"### Steps to reproduce
In Rails 6.0, create a query on a JSON/JSONB column in PostgreSQL using an array of hashes:

```ruby
store_ids = [{ ""store_id"" => 7 }, { ""store_id"" => 8 }]
where(dimensions: store_ids) # This works as expected in Rails 6.0
```

Then, run the same query in Rails 6.1:

```ruby
store_ids = [{ ""store_id"" => 7 }, { ""store_id"" => 8 }]
where(dimensions: store_ids) # This returns [] in Rails 6.1
```

### Expected behavior
The query should return the same results in Rails 6.1 as it did in Rails 6.0. The ActiveRecord should convert the array of hashes into a JSON representation that PostgreSQL can understand.

### Actual behavior
In Rails 6.1, the query returns an empty array. It appears that ActiveRecord is no longer converting the array of hashes into a JSON representation that PostgreSQL can understand.

As a workaround, I've had to convert the store IDs into strings and use PostgreSQL's `->>` operator syntax:

```ruby
store_ids = [7, 8].map(&:to_s)
where(""dimensions->>'store_id' in (?)"", store_ids) # This works as expected in Rails 6.1
```

### System configuration
**Rails version**: 6.1

**Ruby version**: 2.7.7","{'url': 'https://api.github.com/repos/rails/rails/issues/48535/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48535/timeline,,
https://api.github.com/repos/rails/rails/issues/48531,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48531/labels{/name},https://api.github.com/repos/rails/rails/issues/48531/comments,https://api.github.com/repos/rails/rails/issues/48531/events,https://github.com/rails/rails/pull/48531,1765654298,PR_kwDNIULOU3Osuw,48531,Fix unscope with multiple not conditions,"{'login': 'lazaronixon', 'id': 2651240, 'node_id': 'MDQ6VXNlcjI2NTEyNDA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2651240?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lazaronixon', 'html_url': 'https://github.com/lazaronixon', 'followers_url': 'https://api.github.com/users/lazaronixon/followers', 'following_url': 'https://api.github.com/users/lazaronixon/following{/other_user}', 'gists_url': 'https://api.github.com/users/lazaronixon/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lazaronixon/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lazaronixon/subscriptions', 'organizations_url': 'https://api.github.com/users/lazaronixon/orgs', 'repos_url': 'https://api.github.com/users/lazaronixon/repos', 'events_url': 'https://api.github.com/users/lazaronixon/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lazaronixon/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-20T15:29:58Z,2023-06-21T14:59:52Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48531', 'html_url': 'https://github.com/rails/rails/pull/48531', 'diff_url': 'https://github.com/rails/rails/pull/48531.diff', 'patch_url': 'https://github.com/rails/rails/pull/48531.patch', 'merged_at': None}","### Motivation / Background

Fix unscope with multiple not conditions

Before:
```ruby
Post.where.not(body: ""hello"", title: ""sti me"").unscope(where: :title)
#=> SELECT * FROM posts WHERE NOT (body = 'hello' AND title = 'sti me')
```

Later:
```ruby
Post.where.not(body: ""hello"", title: ""sti me"").unscope(where: :title)
#=> SELECT * FROM posts WHERE NOT (body = 'hello')
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48531/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48531/timeline,,
https://api.github.com/repos/rails/rails/issues/48528,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48528/labels{/name},https://api.github.com/repos/rails/rails/issues/48528/comments,https://api.github.com/repos/rails/rails/issues/48528/events,https://github.com/rails/rails/issues/48528,1764558038,I_kwDNIULOaS0E1g,48528,Should ActionDispatch::Executor be moved higher up the middleware stack?,"{'login': 'KJTsanaktsidis', 'id': 1418177, 'node_id': 'MDQ6VXNlcjE0MTgxNzc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1418177?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/KJTsanaktsidis', 'html_url': 'https://github.com/KJTsanaktsidis', 'followers_url': 'https://api.github.com/users/KJTsanaktsidis/followers', 'following_url': 'https://api.github.com/users/KJTsanaktsidis/following{/other_user}', 'gists_url': 'https://api.github.com/users/KJTsanaktsidis/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/KJTsanaktsidis/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/KJTsanaktsidis/subscriptions', 'organizations_url': 'https://api.github.com/users/KJTsanaktsidis/orgs', 'repos_url': 'https://api.github.com/users/KJTsanaktsidis/repos', 'events_url': 'https://api.github.com/users/KJTsanaktsidis/events{/privacy}', 'received_events_url': 'https://api.github.com/users/KJTsanaktsidis/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,9,2023-06-20T03:38:25Z,2023-09-18T12:19:04Z,,NONE,,,,"### Steps to reproduce

Currently, the `ActionDispatch::HostAuthorization` and `ActionDispatch::Static` middlewares, amongst others, are ordered before `ActionDispatch::Executor`. Let's say we want to include a custom middleware to instrument requests. This middleware should go before `HostAuthorization` and `Static`, because we want to instrument requests which fail host authorization or hit static files; on the other hand, they should go after `Executor` because the [threading and code execution](https://guides.rubyonrails.org/threading_and_code_execution.html) rails guide says that user code should be wrapped in an Executor.

I suspect this might cause problems with the autoloader not working on such middleware, but actually there is another practical problem with including the instrumentation before `Executor`. If the instrumentation middleware wants to use a `ActiveSupport::CurrentAttributes` class, the values stored in there are cleared when the executor middleware calls the `run` callbacks.

### Expected behavior
I believe the Executor middleware should come first, perhaps? The only reason I can think of not to do this is an efficiency concern of booting up the executor unnecessarily for serving static files without user code intervention. 

* Is there any reason I shouldn't re-order this middleware in my own app?
* Would this be something that should be changed in Rails by default?


### Actual behavior
Any values stored in `ActiveSupport::CurrentAttributes` in middlewares before `Executor` are cleared when Executor is run.","{'url': 'https://api.github.com/repos/rails/rails/issues/48528/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48528/timeline,,
https://api.github.com/repos/rails/rails/issues/48513,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48513/labels{/name},https://api.github.com/repos/rails/rails/issues/48513/comments,https://api.github.com/repos/rails/rails/issues/48513/events,https://github.com/rails/rails/pull/48513,1762301242,PR_kwDNIULOU0bBnw,48513,Allow insert_all/upsert_all to use an array of models,"{'login': 'TakuyaKurimoto', 'id': 75765648, 'node_id': 'MDQ6VXNlcjc1NzY1NjQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/75765648?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/TakuyaKurimoto', 'html_url': 'https://github.com/TakuyaKurimoto', 'followers_url': 'https://api.github.com/users/TakuyaKurimoto/followers', 'following_url': 'https://api.github.com/users/TakuyaKurimoto/following{/other_user}', 'gists_url': 'https://api.github.com/users/TakuyaKurimoto/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/TakuyaKurimoto/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/TakuyaKurimoto/subscriptions', 'organizations_url': 'https://api.github.com/users/TakuyaKurimoto/orgs', 'repos_url': 'https://api.github.com/users/TakuyaKurimoto/repos', 'events_url': 'https://api.github.com/users/TakuyaKurimoto/events{/privacy}', 'received_events_url': 'https://api.github.com/users/TakuyaKurimoto/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-06-18T13:30:51Z,2023-06-22T11:23:06Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48513', 'html_url': 'https://github.com/rails/rails/pull/48513', 'diff_url': 'https://github.com/rails/rails/pull/48513.diff', 'patch_url': 'https://github.com/rails/rails/pull/48513.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background
Currently, insert_all/upsert_all only accept array of hashes, so I want to make it accept array of models as well.
Example:
```
Book.insert_all([
  Book.new(title: ""Rework"", author: ""David""),
  Book.new(title: ""Eloquent Ruby"", author: ""Russ"")
])
```


<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

### Detail

### Additional information

If you do not want timestamp values to be updated automatically, you must set record_timestamps to false.
Example:
```
Book.insert_all([Book.new(title: ""Rework"", author: ""David"")])
Book.last.updated_at = '2023-05-23 20:37:10.97 UTC'

Book.insert_all([Book.new(title: ""Rework"", author: ""David"")], record_timestamps: false)
Book.last.updated_at = nil
```
### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48513/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48513/timeline,,
https://api.github.com/repos/rails/rails/issues/48510,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48510/labels{/name},https://api.github.com/repos/rails/rails/issues/48510/comments,https://api.github.com/repos/rails/rails/issues/48510/events,https://github.com/rails/rails/pull/48510,1762165544,PR_kwDNIULOU0UE5Q,48510,Allow default CSP setup to work with empty sessions,"{'login': 'ghiculescu', 'id': 509837, 'node_id': 'MDQ6VXNlcjUwOTgzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/509837?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ghiculescu', 'html_url': 'https://github.com/ghiculescu', 'followers_url': 'https://api.github.com/users/ghiculescu/followers', 'following_url': 'https://api.github.com/users/ghiculescu/following{/other_user}', 'gists_url': 'https://api.github.com/users/ghiculescu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ghiculescu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ghiculescu/subscriptions', 'organizations_url': 'https://api.github.com/users/ghiculescu/orgs', 'repos_url': 'https://api.github.com/users/ghiculescu/repos', 'events_url': 'https://api.github.com/users/ghiculescu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ghiculescu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,9,2023-06-18T07:50:25Z,2023-09-16T22:54:57Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48510', 'html_url': 'https://github.com/rails/rails/pull/48510', 'diff_url': 'https://github.com/rails/rails/pull/48510.diff', 'patch_url': 'https://github.com/rails/rails/pull/48510.patch', 'merged_at': None}","### Motivation / Background

Fixes https://github.com/rails/rails/issues/48463

Since https://github.com/rails/rails/pull/43227, the default CSP suggested in the initializer does not work with empty sessions. See [this comment](https://github.com/rails/rails/pull/43227#issuecomment-1191692615) for an example issue and workaround.

### Detail

This PR just adds a fallback in case the session has not been loaded. I also updated the railties test to match the config in the default initializer.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48510/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48510/timeline,,
https://api.github.com/repos/rails/rails/issues/48509,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48509/labels{/name},https://api.github.com/repos/rails/rails/issues/48509/comments,https://api.github.com/repos/rails/rails/issues/48509/events,https://github.com/rails/rails/pull/48509,1761877912,PR_kwDNIULOU0Fqcg,48509,"[Fix #47357] Inconsistent update, delete, reload behaviour with `#scoping` and default scopes","{'login': 'joshuay03', 'id': 54629302, 'node_id': 'MDQ6VXNlcjU0NjI5MzAy', 'avatar_url': 'https://avatars.githubusercontent.com/u/54629302?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/joshuay03', 'html_url': 'https://github.com/joshuay03', 'followers_url': 'https://api.github.com/users/joshuay03/followers', 'following_url': 'https://api.github.com/users/joshuay03/following{/other_user}', 'gists_url': 'https://api.github.com/users/joshuay03/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/joshuay03/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/joshuay03/subscriptions', 'organizations_url': 'https://api.github.com/users/joshuay03/orgs', 'repos_url': 'https://api.github.com/users/joshuay03/repos', 'events_url': 'https://api.github.com/users/joshuay03/events{/privacy}', 'received_events_url': 'https://api.github.com/users/joshuay03/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-06-17T14:33:33Z,2023-08-30T20:16:45Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48509', 'html_url': 'https://github.com/rails/rails/pull/48509', 'diff_url': 'https://github.com/rails/rails/pull/48509.diff', 'patch_url': 'https://github.com/rails/rails/pull/48509.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created to fix https://github.com/rails/rails/issues/47357.

### Detail

This Pull Request ensures that when using `scoping` on update, delete and reload, scopes are only applied if `all_queries: true` and only default scopes with `all_queries: true` are applied. Because all default scopes are applied initially with the `where` clause when scoping, my approach was to remove the unneeded scopes after the fact in these three scenarios.

Except for the update and delete cases **without** `scoping(all_queries: true)`, all other tests failed initially.

### Additional information

Added @pjambet as a co-author since they thoroughly documented all the expected and actual behaviour and tests.

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48509/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48509/timeline,,
https://api.github.com/repos/rails/rails/issues/48497,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48497/labels{/name},https://api.github.com/repos/rails/rails/issues/48497/comments,https://api.github.com/repos/rails/rails/issues/48497/events,https://github.com/rails/rails/issues/48497,1760229595,I_kwDNIULOaOr42w,48497,Not possible to use upsert_all with point type column,"{'login': 'morgoth', 'id': 10766, 'node_id': 'MDQ6VXNlcjEwNzY2', 'avatar_url': 'https://avatars.githubusercontent.com/u/10766?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/morgoth', 'html_url': 'https://github.com/morgoth', 'followers_url': 'https://api.github.com/users/morgoth/followers', 'following_url': 'https://api.github.com/users/morgoth/following{/other_user}', 'gists_url': 'https://api.github.com/users/morgoth/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/morgoth/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/morgoth/subscriptions', 'organizations_url': 'https://api.github.com/users/morgoth/orgs', 'repos_url': 'https://api.github.com/users/morgoth/repos', 'events_url': 'https://api.github.com/users/morgoth/events{/privacy}', 'received_events_url': 'https://api.github.com/users/morgoth/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2023-06-16T09:05:13Z,2023-09-14T17:15:49Z,,MEMBER,,,,"When using `upsert_all` with a table having column with a type `point` and the `updated_at` timestamp, the error is raised:
```
D, [2023-06-16T10:58:12.115714 #3553784] DEBUG -- :   Location Upsert (0.4ms)  INSERT INTO ""locations"" (""identifier"",""coordinates"",""created_at"",""updated_at"") VALUES ('test', '(1.1,1.2)', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP) ON CONFLICT (""identifier"") DO UPDATE SET updated_at=(CASE WHEN (""locations"".""coordinates"" IS NOT DISTINCT FROM excluded.""coordinates"") THEN ""locations"".updated_at ELSE CURRENT_TIMESTAMP END),""coordinates""=excluded.""coordinates"" RETURNING ""id""
E

Error:
BugTest#test_association_stuff:
ActiveRecord::StatementInvalid: PG::UndefinedFunction: ERROR:  operator does not exist: point = point
LINE 1: ... updated_at=(CASE WHEN (""locations"".""coordinates"" IS NOT DIS...
                                                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
```

It's possible to workaround the issue by including the ""updated_at"" timestamp manually.

The reproducible script is as follows:
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""pg""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""postgresql"", database: ""upsert-bug"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :locations, force: true do |t|
    t.string :identifier
    t.point :coordinates
    t.timestamps
    t.index :identifier, unique: true
  end
end

class Location < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_association_stuff
    assert Location.upsert_all([identifier: ""test"", coordinates: [1.1, 1.2], updated_at: Time.current], unique_by: [:identifier]) # Works fine

    assert Location.upsert_all([identifier: ""test"", coordinates: [1.1, 1.2]], unique_by: [:identifier]) # raises
  end
end
```","{'url': 'https://api.github.com/repos/rails/rails/issues/48497/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48497/timeline,,
https://api.github.com/repos/rails/rails/issues/48482,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48482/labels{/name},https://api.github.com/repos/rails/rails/issues/48482/comments,https://api.github.com/repos/rails/rails/issues/48482/events,https://github.com/rails/rails/pull/48482,1758404452,PR_kwDNIULOUxL4Fg,48482,Improve error messages of `assert_changes` and `assert_no_changes`,"{'login': 'pcreux', 'id': 45299, 'node_id': 'MDQ6VXNlcjQ1Mjk5', 'avatar_url': 'https://avatars.githubusercontent.com/u/45299?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pcreux', 'html_url': 'https://github.com/pcreux', 'followers_url': 'https://api.github.com/users/pcreux/followers', 'following_url': 'https://api.github.com/users/pcreux/following{/other_user}', 'gists_url': 'https://api.github.com/users/pcreux/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pcreux/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pcreux/subscriptions', 'organizations_url': 'https://api.github.com/users/pcreux/orgs', 'repos_url': 'https://api.github.com/users/pcreux/repos', 'events_url': 'https://api.github.com/users/pcreux/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pcreux/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-15T09:18:25Z,2023-10-06T08:17:30Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48482', 'html_url': 'https://github.com/rails/rails/pull/48482', 'diff_url': 'https://github.com/rails/rails/pull/48482.diff', 'patch_url': 'https://github.com/rails/rails/pull/48482.patch', 'merged_at': None}","### Motivation / Background

Make `assert_changes` error messages show objects with `.inspect` so that `nil` is displayed as ""nil"" instead of an empty string, we can differentiate strings and symbols, etc.

Make `assert_no_changes` error messages surface the actual value.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

Let me know if I should update the CHANGELOG as this is a minor change.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48482/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48482/timeline,,
https://api.github.com/repos/rails/rails/issues/48480,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48480/labels{/name},https://api.github.com/repos/rails/rails/issues/48480/comments,https://api.github.com/repos/rails/rails/issues/48480/events,https://github.com/rails/rails/pull/48480,1758171062,PR_kwDNIULOUw_RUQ,48480,Add unique option to belongs_to association,"{'login': 'lazaronixon', 'id': 2651240, 'node_id': 'MDQ6VXNlcjI2NTEyNDA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2651240?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lazaronixon', 'html_url': 'https://github.com/lazaronixon', 'followers_url': 'https://api.github.com/users/lazaronixon/followers', 'following_url': 'https://api.github.com/users/lazaronixon/following{/other_user}', 'gists_url': 'https://api.github.com/users/lazaronixon/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lazaronixon/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lazaronixon/subscriptions', 'organizations_url': 'https://api.github.com/users/lazaronixon/orgs', 'repos_url': 'https://api.github.com/users/lazaronixon/repos', 'events_url': 'https://api.github.com/users/lazaronixon/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lazaronixon/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-15T07:00:03Z,2023-06-17T19:55:43Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48480', 'html_url': 'https://github.com/rails/rails/pull/48480', 'diff_url': 'https://github.com/rails/rails/pull/48480.diff', 'patch_url': 'https://github.com/rails/rails/pull/48480.patch', 'merged_at': None}","Since version 7.0.5 https://github.com/rails/rails/commit/bdbe58b50461dc44c42df4d5427fa78aeb1debcb  we are able to properly keep integrity in `has_one` relationships, so when we create a new record `account.create_client(...)` it will prevent duplication, but we can still bypass it on the other side of the relationship using `Client.create!(..., account: existing_account)`. 

That said I'm proposing to add a new option `unique` to the `belongs_to` method. Here are some advantages of this approach...

- Unique indexes are not required.
- Different from unique indexes we can use it with an optional association.
- Take advantage of the new `belongs_to_required_validates_foreign_key`.
- Validation API, messages, etc...

Before:

```ruby    
class Client
  belongs_to :account; validates_uniqueness_of(:account, allow_nil: true, message: :unique)
end
```

Later:

  ```ruby
class Client
    belongs_to :account, unique: true
end
 ```

### Additional information

https://thoughtbot.com/blog/rails-has-one-limitations

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48480/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48480/timeline,,
https://api.github.com/repos/rails/rails/issues/48479,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48479/labels{/name},https://api.github.com/repos/rails/rails/issues/48479/comments,https://api.github.com/repos/rails/rails/issues/48479/events,https://github.com/rails/rails/issues/48479,1757851394,I_kwDNIULOaMavAg,48479,Enhancements to the Rails Generate Command for Easier Setup,"{'login': 'ptamarshall', 'id': 136658618, 'node_id': 'U_kgDOCCU-ug', 'avatar_url': 'https://avatars.githubusercontent.com/u/136658618?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ptamarshall', 'html_url': 'https://github.com/ptamarshall', 'followers_url': 'https://api.github.com/users/ptamarshall/followers', 'following_url': 'https://api.github.com/users/ptamarshall/following{/other_user}', 'gists_url': 'https://api.github.com/users/ptamarshall/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ptamarshall/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ptamarshall/subscriptions', 'organizations_url': 'https://api.github.com/users/ptamarshall/orgs', 'repos_url': 'https://api.github.com/users/ptamarshall/repos', 'events_url': 'https://api.github.com/users/ptamarshall/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ptamarshall/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,2,2023-06-15T00:48:31Z,2023-09-08T16:40:18Z,,NONE,,,,"Dear Rails Development Team,

I'm writing to suggest potential improvements to the `rails generate` command, specifically around setting up complex model associations and setting default values.

1. **Complex Model Associations**: Currently, `rails generate model` can create a polymorphic association at the database level but doesn't specify the polymorphic association in the model files. It would be beneficial if the command could also update the model files with the appropriate association. 

    Consider a blogging platform where a Comment can belong to either a Post or another Comment:

    ```bash
    rails generate model Comment user:references commentable:references{polymorphic} content:text
    rails generate model Post user:references title:string content:text
    ```

    In this scenario, developers still need to manually edit the model files to add the correct associations. If `rails generate model` could also add these associations, it would save developers time and reduce potential errors.

2. **Default Values**: The `rails generate model` command does not currently provide an option to set default values for fields. If this functionality was added, developers could specify default values right in the `rails generate model` command.

    For example:

    ```sh
    rails generate model Post user:references title:string content:text views:integer{default:0}
    ```

    In this example, a `Post` model is generated with a `views` field that has a default value of `0`.

Thank you for considering these suggestions. Your work is greatly appreciated.

Best regards,

Pete Marshall
","{'url': 'https://api.github.com/repos/rails/rails/issues/48479/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48479/timeline,,
https://api.github.com/repos/rails/rails/issues/48468,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48468/labels{/name},https://api.github.com/repos/rails/rails/issues/48468/comments,https://api.github.com/repos/rails/rails/issues/48468/events,https://github.com/rails/rails/issues/48468,1756341024,I_kwDNIULOaK-jIA,48468,Test suite hangs after upgrading from 6.1 to 7.0,"{'login': 'krebbl', 'id': 951433, 'node_id': 'MDQ6VXNlcjk1MTQzMw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/951433?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/krebbl', 'html_url': 'https://github.com/krebbl', 'followers_url': 'https://api.github.com/users/krebbl/followers', 'following_url': 'https://api.github.com/users/krebbl/following{/other_user}', 'gists_url': 'https://api.github.com/users/krebbl/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/krebbl/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/krebbl/subscriptions', 'organizations_url': 'https://api.github.com/users/krebbl/orgs', 'repos_url': 'https://api.github.com/users/krebbl/repos', 'events_url': 'https://api.github.com/users/krebbl/events{/privacy}', 'received_events_url': 'https://api.github.com/users/krebbl/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,17,2023-06-14T08:26:54Z,2023-10-06T01:50:15Z,,NONE,,,,"### Steps to reproduce

We have a project with a multi-database (2 databases) configuration. 
When executing the test suite like follows the tests hang after some time.

```ruby
PARALLEL_WORKERS=1 bin/rails test
```

As you can see in the sigdump all threads get stuck in `load_interlock_aware_monitor.rb:17:in 'enter' `
I am currently trying to create an example project to reproduce this issue but maybe this info is enough for now to make some conclusions.

```
Sigdump at 2023-06-14 10:11:32 +0200 process 90089 (bin/rails)
  Thread #<Thread:0x00000001023db0f0 run> status=run priority=0
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:52:in `backtrace'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:52:in `dump_backtrace'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:34:in `block in dump_all_thread_backtrace'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:33:in `each'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:33:in `dump_all_thread_backtrace'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:16:in `block in dump'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:136:in `open'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:136:in `_open_dump_path'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:14:in `dump'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/sigdump-0.2.4/lib/sigdump.rb:7:in `block in setup'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:91:in `clear_query_cache'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:343:in `block in clear_on_handler'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:342:in `each'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:342:in `clear_on_handler'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_handling.rb:272:in `clear_query_caches_for_current_thread'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:21:in `insert'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:496:in `_insert_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:1096:in `_create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/counter_cache.rb:166:in `_create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/locking/optimistic.rb:79:in `_create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/attribute_methods/dirty.rb:222:in `_create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:459:in `block in _create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:107:in `run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:929:in `_run_create_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:459:in `_create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/timestamp.rb:108:in `_create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:6:in `_create_record'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:1067:in `create_or_update'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:455:in `block in create_or_update'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/autosave_association.rb:370:in `around_save_collection_association'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:929:in `_run_save_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/callbacks.rb:455:in `create_or_update'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/timestamp.rb:126:in `create_or_update'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/persistence.rb:648:in `save!'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/validations.rb:53:in `save!'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:302:in `block in save!'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:354:in `block in with_transaction_returning_status'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/transaction.rb:319:in `block in within_new_transaction'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/transaction.rb:317:in `within_new_transaction'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/database_statements.rb:316:in `transaction'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:350:in `with_transaction_returning_status'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/transactions.rb:302:in `save!'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/suppressor.rb:54:in `save!'
      /Users/krebbl/Projects/ProCarement/care-center/app/models/medical_report.rb:121:in `save_report_as_document'
      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:167:in `block (3 levels) in <class:MedicalReportTest>'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:34:in `assert_nothing_raised'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:250:in `_assert_nothing_raised_or_warn'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/testing/assertions.rb:102:in `assert_difference'
      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:165:in `block (2 levels) in <class:MedicalReportTest>'
      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:172:in `instance_exec'
      /Users/krebbl/Projects/ProCarement/care-center/test/models/medical_report_test.rb:172:in `block in create_test_from_should_hash'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:102:in `block (3 levels) in run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:199:in `capture_exceptions'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:97:in `block (2 levels) in run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:296:in `time_it'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:96:in `block in run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:391:in `on_signal'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:247:in `with_info_handler'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/test.rb:95:in `run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-reporters-1.4.3/lib/minitest/reporters.rb:48:in `run_with_hooks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:1051:in `run_one_method'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:365:in `run_one_method'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:352:in `block (2 levels) in run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:351:in `each'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:351:in `block in run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:391:in `on_signal'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:378:in `with_info_handler'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:350:in `run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/railties-7.0.5/lib/rails/test_unit/line_filtering.rb:10:in `run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `block in __run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `map'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:182:in `__run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:159:in `run'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest.rb:83:in `block in autorun'
  Thread #<Thread:0x0000000109047888 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:40 sleep> status=sleep priority=0
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:46:in `sleep'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb:46:in `block in spawn_thread'
  Thread #<Thread:0x0000000109443018@Timeout stdlib thread /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:101 sleep> status=sleep priority=0
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `sleep'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `wait'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:113:in `block (2 levels) in create_timeout_thread'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:111:in `synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/timeout-0.3.2/lib/timeout.rb:111:in `block in create_timeout_thread'
  Thread #<Thread:0x000000010c94b918 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010c94b800 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010c94b710 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010c94b620 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010c94b530 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010c94b440 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010c94b350 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010c94b260 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:28 sleep_forever> status=sleep priority=0
      <internal:thread_sync>:18:in `pop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/minitest-5.18.0/lib/minitest/parallel.rb:30:in `block (2 levels) in start'
  Thread #<Thread:0x000000010ce4f180@worker-1 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:332 sleep_forever> status=sleep priority=0
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:128:in `cache_sql'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:107:in `select_all'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:54:in `_query_by_sql'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:942:in `block in exec_main_query'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:928:in `exec_main_query'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:914:in `block in exec_queries'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:908:in `exec_queries'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:695:in `load'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:250:in `records'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:46:in `records'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:520:in `find_take'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:98:in `take'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:473:in `find_one'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:457:in `find_with_ids'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:69:in `find'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:22:in `find'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/core.rb:271:in `find'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:129:in `locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `block in locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `block in unscoped'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:881:in `_scoping'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:428:in `scoping'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/scoping/default.rb:43:in `unscoped'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `unscoped'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:16:in `locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:148:in `deserialize_global_id'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:132:in `deserialize_argument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `block in deserialize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `map'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `deserialize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:190:in `deserialize_arguments'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:180:in `deserialize_arguments_if_needed'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:44:in `perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `block in perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:25:in `block in instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `block in instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:35:in `instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `block in perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `block in tagged'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:37:in `tagged'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `tagged'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:25:in `tag_logger'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:24:in `block in execute'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:54:in `block (4 levels) in <class:Railtie>'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:72:in `block in wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:71:in `wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:53:in `block (3 levels) in <class:Railtie>'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `instance_exec'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:22:in `execute'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/queue_adapters/async_adapter.rb:70:in `perform'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:352:in `run_task'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:343:in `block (3 levels) in create_worker'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `loop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `block (2 levels) in create_worker'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `catch'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `block in create_worker'
  Thread #<Thread:0x000000010d989d20@worker-2 /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:332 sleep_forever> status=sleep priority=0
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:128:in `cache_sql'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/connection_adapters/abstract/query_cache.rb:107:in `select_all'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:54:in `_query_by_sql'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:942:in `block in exec_main_query'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:928:in `exec_main_query'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:914:in `block in exec_queries'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:962:in `skip_query_cache_if_necessary'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:908:in `exec_queries'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:695:in `load'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:250:in `records'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/bullet-7.0.7/lib/bullet/active_record70.rb:46:in `records'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:520:in `find_take'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:98:in `take'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:473:in `find_one'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:457:in `find_with_ids'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation/finder_methods.rb:69:in `find'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/querying.rb:22:in `find'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/core.rb:271:in `find'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:129:in `locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `block in locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `block in unscoped'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:881:in `_scoping'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/relation.rb:428:in `scoping'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activerecord-7.0.5/lib/active_record/scoping/default.rb:43:in `unscoped'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:164:in `unscoped'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:154:in `locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/globalid-1.1.0/lib/global_id/locator.rb:16:in `locate'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:148:in `deserialize_global_id'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:132:in `deserialize_argument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `block in deserialize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `map'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/arguments.rb:43:in `deserialize'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:190:in `deserialize_arguments'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/core.rb:180:in `deserialize_arguments_if_needed'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:44:in `perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `block in perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:25:in `block in instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `block in instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/notifications.rb:206:in `instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:35:in `instrument'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/instrumentation.rb:14:in `perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `block in perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `block in tagged'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:37:in `tagged'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/tagged_logging.rb:99:in `tagged'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:25:in `tag_logger'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/logging.rb:18:in `perform_now'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:24:in `block in execute'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:118:in `block in run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:54:in `block (4 levels) in <class:Railtie>'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:72:in `block in wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/execution_wrapper.rb:92:in `wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/reloader.rb:71:in `wrap'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/railtie.rb:53:in `block (3 levels) in <class:Railtie>'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `instance_exec'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:127:in `block in run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activesupport-7.0.5/lib/active_support/callbacks.rb:138:in `run_callbacks'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/execution.rb:22:in `execute'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/activejob-7.0.5/lib/active_job/queue_adapters/async_adapter.rb:70:in `perform'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:352:in `run_task'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:343:in `block (3 levels) in create_worker'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `loop'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `block (2 levels) in create_worker'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `catch'
      /Users/krebbl/.rbenv/versions/3.2.0/lib/ruby/gems/3.2.0/gems/concurrent-ruby-1.2.2/lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `block in create_worker'

```

### Expected behavior

The tests should just run through

### Actual behavior

The tests get stuck after some while

### System configuration
**Rails version**: 7.0.5
**Ruby version**: 3.2.0
","{'url': 'https://api.github.com/repos/rails/rails/issues/48468/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48468/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/48463,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48463/labels{/name},https://api.github.com/repos/rails/rails/issues/48463/comments,https://api.github.com/repos/rails/rails/issues/48463/events,https://github.com/rails/rails/issues/48463,1755595459,I_kwDNIULOaKRCww,48463,Suggested CSP nonce generator doesn't work the first time a page is loaded,"{'login': 'olbrich', 'id': 22176, 'node_id': 'MDQ6VXNlcjIyMTc2', 'avatar_url': 'https://avatars.githubusercontent.com/u/22176?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/olbrich', 'html_url': 'https://github.com/olbrich', 'followers_url': 'https://api.github.com/users/olbrich/followers', 'following_url': 'https://api.github.com/users/olbrich/following{/other_user}', 'gists_url': 'https://api.github.com/users/olbrich/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/olbrich/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/olbrich/subscriptions', 'organizations_url': 'https://api.github.com/users/olbrich/orgs', 'repos_url': 'https://api.github.com/users/olbrich/repos', 'events_url': 'https://api.github.com/users/olbrich/events{/privacy}', 'received_events_url': 'https://api.github.com/users/olbrich/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,5,2023-06-13T20:24:17Z,2023-09-16T07:20:36Z,,NONE,,,,"https://github.com/rails/rails/blob/d12f1a2f84128085ee0bdbbbe28df9ec27a9bc64/actiontext/test/dummy/config/initializers/content_security_policy.rb#L20

If a cookie containing the session ID doesn't exist when this suggested nonce generator is executed (usually the first time a page is loaded), then the generated nonce will be blank. This causes problems with turbo frames since the nonce won't be the same on the next request, causing any nonced JS to fail since it won't match the nonce on the page.

Since sessions are lazily initialized, there is no guarantee that the session exists at the time the nonce generator is called. If the session is not yet initialized, referring to its `id` returns `nil`.

An alternative would be something like 

```
config.content_security_policy_nonce_generator = ->(request) { request.session[:nonce] ||= SecureRandom.hex }
```

This will force the session cookie to be set earlier in the request cycle and will populate it with a random number instead of using the session id. 
","{'url': 'https://api.github.com/repos/rails/rails/issues/48463/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48463/timeline,,
https://api.github.com/repos/rails/rails/issues/48434,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48434/labels{/name},https://api.github.com/repos/rails/rails/issues/48434/comments,https://api.github.com/repos/rails/rails/issues/48434/events,https://github.com/rails/rails/pull/48434,1750183204,PR_kwDNIULOUqOaLQ,48434,Add `ActiveRecord.reload_attributes`,"{'login': 'abaldwin88', 'id': 15172605, 'node_id': 'MDQ6VXNlcjE1MTcyNjA1', 'avatar_url': 'https://avatars.githubusercontent.com/u/15172605?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/abaldwin88', 'html_url': 'https://github.com/abaldwin88', 'followers_url': 'https://api.github.com/users/abaldwin88/followers', 'following_url': 'https://api.github.com/users/abaldwin88/following{/other_user}', 'gists_url': 'https://api.github.com/users/abaldwin88/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/abaldwin88/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/abaldwin88/subscriptions', 'organizations_url': 'https://api.github.com/users/abaldwin88/orgs', 'repos_url': 'https://api.github.com/users/abaldwin88/repos', 'events_url': 'https://api.github.com/users/abaldwin88/events{/privacy}', 'received_events_url': 'https://api.github.com/users/abaldwin88/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,"{'login': 'matthewd', 'id': 1034, 'node_id': 'MDQ6VXNlcjEwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthewd', 'html_url': 'https://github.com/matthewd', 'followers_url': 'https://api.github.com/users/matthewd/followers', 'following_url': 'https://api.github.com/users/matthewd/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthewd/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthewd/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthewd/subscriptions', 'organizations_url': 'https://api.github.com/users/matthewd/orgs', 'repos_url': 'https://api.github.com/users/matthewd/repos', 'events_url': 'https://api.github.com/users/matthewd/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthewd/received_events', 'type': 'User', 'site_admin': True}","[{'login': 'matthewd', 'id': 1034, 'node_id': 'MDQ6VXNlcjEwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthewd', 'html_url': 'https://github.com/matthewd', 'followers_url': 'https://api.github.com/users/matthewd/followers', 'following_url': 'https://api.github.com/users/matthewd/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthewd/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthewd/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthewd/subscriptions', 'organizations_url': 'https://api.github.com/users/matthewd/orgs', 'repos_url': 'https://api.github.com/users/matthewd/repos', 'events_url': 'https://api.github.com/users/matthewd/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthewd/received_events', 'type': 'User', 'site_admin': True}]",,7,2023-06-09T16:30:33Z,2023-09-25T20:18:33Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48434', 'html_url': 'https://github.com/rails/rails/pull/48434', 'diff_url': 'https://github.com/rails/rails/pull/48434.diff', 'patch_url': 'https://github.com/rails/rails/pull/48434.patch', 'merged_at': None}","### Motivation / Background

PR #48241 detects when certain auto-populated columns should be appended to a `RETURNING` clause. However, in certain cases it may be necessary for the application to explicitly specify additional columns. e.g. Database Triggers.

This feature was discussed in #45736 and briefly with Matthew Draper in the Discord channel.

### Detail

This PR adds the ability for the application to specify those attributes with the `reload_attributes` class method.

### Additional information

Additionally a very minor edge case was handled. The application could try to assign a value to a virtual column which essentially results in a no-op. The values persisted in the database would be the same regardless. However, in doing so the value from `RETURNING` wasn't being reflected on the instance attributes after create. See the newly added test and removal of the `_read_attribute` check.

Performing this nil check with `_read_attribute` will also not be compatible when `RETURNING` is implemented on `UPDATE`.  As it is expected that the instance's attributes will be prepopulated with non-nil values. (See related PR here: https://github.com/rails/rails/pull/48628)

---

Paging: @nvasilevski","{'url': 'https://api.github.com/repos/rails/rails/issues/48434/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48434/timeline,,
https://api.github.com/repos/rails/rails/issues/48428,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48428/labels{/name},https://api.github.com/repos/rails/rails/issues/48428/comments,https://api.github.com/repos/rails/rails/issues/48428/events,https://github.com/rails/rails/pull/48428,1748918898,PR_kwDNIULOUpJX4Q,48428,Remove custom `exec_insert` method from Trilogy adapter,"{'login': 'nvasilevski', 'id': 5512772, 'node_id': 'MDQ6VXNlcjU1MTI3NzI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5512772?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nvasilevski', 'html_url': 'https://github.com/nvasilevski', 'followers_url': 'https://api.github.com/users/nvasilevski/followers', 'following_url': 'https://api.github.com/users/nvasilevski/following{/other_user}', 'gists_url': 'https://api.github.com/users/nvasilevski/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nvasilevski/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nvasilevski/subscriptions', 'organizations_url': 'https://api.github.com/users/nvasilevski/orgs', 'repos_url': 'https://api.github.com/users/nvasilevski/repos', 'events_url': 'https://api.github.com/users/nvasilevski/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nvasilevski/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-09T01:16:25Z,2023-06-12T18:52:17Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48428', 'html_url': 'https://github.com/rails/rails/pull/48428', 'diff_url': 'https://github.com/rails/rails/pull/48428.diff', 'patch_url': 'https://github.com/rails/rails/pull/48428.patch', 'merged_at': None}","`Trilogy` adapter has a custom implementation of `exec_insert` method which is a complete duplication of the abstract `exec_insert` with the **only difference**:  Trilogy's exec insert used to return an unwrapped result while abstract implementation returns `ActiveRecord::Result`. Though we believe it goes against the method signature as trilogy result and `AR::Result` do not implement the same interface. Changing the result type to be Active Record result causes only one issue - `last_insert_method` can not fetch the last inserted id value from `ActiveRecord::Result` as it doesn't provide such value.  In order to address it we are introducing a new `ActiveRecord::TrilogyResult` class which is a child class of `Result` with the only difference - it implements `last_insert_id` to be used by the `last_inserted_id` method. The `Result` itself had to be extended to store the reference to the `raw_result` 

### Alternative solutions for `last_inserted_id`

1. Instead of introducing new `TrilogyResult` class we could have added `last_inserted_id` method directly to the `Result` but it doesn't seem correct as not every adapter has such concept as `last_inserted_id`. For example being able to call `last_inserted_id` when using `PostgresqlAdapter` won't make much sense. 
2. We could have done the same what `mysql2` adapter does - reach into `@connection` to get the value:
https://github.com/rails/rails/blob/2a904bf58828e79c10e7838cb5a7550f8a1b5581/activerecord/lib/active_record/connection_adapters/mysql2/database_statements.rb#L69 as Trilogy raw connection also provides `last_insert_id` method. Though it feels much lower-level to reach into the raw connection and relying on `Result` seems to be a much better abstraction","{'url': 'https://api.github.com/repos/rails/rails/issues/48428/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48428/timeline,,
https://api.github.com/repos/rails/rails/issues/48423,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48423/labels{/name},https://api.github.com/repos/rails/rails/issues/48423/comments,https://api.github.com/repos/rails/rails/issues/48423/events,https://github.com/rails/rails/issues/48423,1747958155,I_kwDNIULOaC-5iw,48423,Virtual stored columns should return new values on update,"{'login': 'abaldwin88', 'id': 15172605, 'node_id': 'MDQ6VXNlcjE1MTcyNjA1', 'avatar_url': 'https://avatars.githubusercontent.com/u/15172605?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/abaldwin88', 'html_url': 'https://github.com/abaldwin88', 'followers_url': 'https://api.github.com/users/abaldwin88/followers', 'following_url': 'https://api.github.com/users/abaldwin88/following{/other_user}', 'gists_url': 'https://api.github.com/users/abaldwin88/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/abaldwin88/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/abaldwin88/subscriptions', 'organizations_url': 'https://api.github.com/users/abaldwin88/orgs', 'repos_url': 'https://api.github.com/users/abaldwin88/repos', 'events_url': 'https://api.github.com/users/abaldwin88/events{/privacy}', 'received_events_url': 'https://api.github.com/users/abaldwin88/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2023-06-08T14:02:05Z,2023-09-23T18:45:59Z,,CONTRIBUTOR,,,,"Follow-up from https://github.com/rails/rails/issues/45736
Same idea except this issue reflects the behavior on `update` rather than on `create`

### Steps to reproduce
Generate a model with a virtual stored column. Using Postgres as the database update a record and check the ActiveRecord attribute of the virtual stored column. It will not have the newly computed value from the database.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem 'pg', '~> 1.4'
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection ""postgresql:///test""
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.integer :counter1, null: false, default: 7
    t.integer :counter2, null: false, default: 7
    t.virtual :counter_sum, type: :integer, as: ""counter1 + counter2"", stored: true
  end
end

class Post < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_virtual_column_value_updated
    post = Post.create!
    post.update!(counter1: 2, counter2: 2)

    assert_equal 4, post.counter_sum
  end
end
```

```
Failure:
BugTest#test_virtual_column_value_updated [test.rb:38]:
Expected: 4
  Actual: 14
```

### Expected behavior
The SQL `UPDATE` statement sent to the database should include a `RETURNING` clause. ActiveRecord will then update the instance attributes on save with the returned values. The behavior should match between create and update.

### Actual behavior
The attribute's value from when the record was last read or inserted is reflected instead.

### System configuration
**Rails version**: edge
**Ruby version**: 3.2.1
**PostgreSQL version**: 14.7","{'url': 'https://api.github.com/repos/rails/rails/issues/48423/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48423/timeline,,
https://api.github.com/repos/rails/rails/issues/48420,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48420/labels{/name},https://api.github.com/repos/rails/rails/issues/48420/comments,https://api.github.com/repos/rails/rails/issues/48420/events,https://github.com/rails/rails/issues/48420,1747488400,I_kwDNIULOaCiOkA,48420,Type of keys returned by grouped count inconsistent after 7.0.5,"{'login': 'thefloweringash', 'id': 42933, 'node_id': 'MDQ6VXNlcjQyOTMz', 'avatar_url': 'https://avatars.githubusercontent.com/u/42933?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/thefloweringash', 'html_url': 'https://github.com/thefloweringash', 'followers_url': 'https://api.github.com/users/thefloweringash/followers', 'following_url': 'https://api.github.com/users/thefloweringash/following{/other_user}', 'gists_url': 'https://api.github.com/users/thefloweringash/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/thefloweringash/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/thefloweringash/subscriptions', 'organizations_url': 'https://api.github.com/users/thefloweringash/orgs', 'repos_url': 'https://api.github.com/users/thefloweringash/repos', 'events_url': 'https://api.github.com/users/thefloweringash/events{/privacy}', 'received_events_url': 'https://api.github.com/users/thefloweringash/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-06-08T09:36:12Z,2023-06-28T19:27:53Z,,NONE,,,,"### Steps to reproduce
(Also available as a [gist](https://gist.github.com/thefloweringash/3f4deabebb7920fbae3898d175743dc2) with docker-compose configuration).
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true
#
# Requires a postgres database, for example
#
#     createdb group_by_test
#     DATABASE_URL=postgres://localhost/group-by-test ruby ./group-by-test.rb
#
# Also supports checking other Rails versions via the RAILS_VERSION
# environment variable. For example:
#
#     createdb group_by_test
#     RAILS_VERSION=7.0.4.3 DATABASE_URL=postgres://localhost/group-by-test ruby ./group-by-test.rb

begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  if (rails_version = ENV['RAILS_VERSION'])
    gem ""rails"", rails_version
  else
    gem ""rails"", github: ""rails/rails"", branch: ""main""
  end

  gem ""pg""

  gem 'timeout', '=0.3.2' # workaround for bundler/inline
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection
# ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :bookings, force: true
end

class Booking < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def setup
    Booking.create!
  end

  def teardown
    Booking.delete_all
  end

  def test_group_by
    grouped_count =
      Booking
        .group(""tsrange(timestamp '2020-01-01', timestamp '2020-01-02', '[)') "")
        .count(:id)

    assert_equal Range, grouped_count.keys.first.class # passes
  end

  def test_group_by_join
    grouped_count =
      Booking
        .joins(""JOIN (SELECT tsrange(timestamp '2020-01-01', timestamp '2020-01-02', '[)') AS range) ranges ON TRUE"")
        .group('ranges.range')
        .count(:id)

    assert_equal Range, grouped_count.keys.first.class # fails
  end
end
```

### Expected behavior
Ideally the type of the keys would be inferred based on the actual data and be converted to Ruby `Range`s.

### Actual behavior
The type of the keys is `String`.

### System configuration
**Rails version**: 7.0.5

**Ruby version**: 3.2

---

The keys returned from a `.group(...).count(...)` have inconsistent type handling. In my case, I'm using a time range expression. If the expression is directly specified in the `.group(...)` call, the return type is `Range`, as expected. If the expression comes through a join, then the return type is `String`. On Rails 7.0.4.3, both of these returned `Range` keys.

More verbosely:

```ruby
# This produces a hash with Range keys on current master
Booking
  .group(""tsrange(timestamp '2020-01-01', timestamp '2020-01-02', '[)') "")
  .count(:id)

# This produces a hash with String keys on current master
Booking
  .joins(""JOIN (SELECT tsrange(timestamp '2020-01-01', timestamp '2020-01-02', '[)') AS range) ranges ON TRUE"")
  .group('ranges.range')
  .count(:id)
```

Obviously these are reduced examples to show the bug. In the actual code the joined values come from a postgres `generate_series` call.

Possibly related change: https://github.com/rails/rails/pull/46923

---

If I were to speculate, prior to #46923 the case where rails does not know anything about the column would fall through to the type of the returned data. After the change the unknown column's default ""Value"" type is used instead.

Breaking on the expression in `execute_grouped_calculation`

```ruby
        key_types = group_columns.each_with_object({}) do |(aliaz, col_name), types|
          types[aliaz] = col_name.try(:type_caster) ||
            type_for(col_name) do
              calculated_data.column_types.fetch(aliaz, Type.default_value)
            end
        end
```

I can see that
```
col_name.try(:type_caster)
 => #<ActiveModel::Type::Value:0x00000001291ff4a8 @precision=nil, @scale=nil, @limit=nil>

type_for(col_name) do
  calculated_data.column_types.fetch(aliaz, Type.default_value)
end
 => #<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Range:0x00000001295f9ba8 @subtype=#<ActiveRecord::ConnectionAdapters::PostgreSQL::OID::Timestamp:0x0000000128ef68b0 @precision=nil, @scale=nil, @limit=nil>, @type=:tsrange>
```

The latter is more useful in this case.

I also observed that if the alias of the joined subquery matches the name of an existing table, it will use type information from that table, even if it's unrelated to the current query. This could lead to some surprising results.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48420/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48420/timeline,,
https://api.github.com/repos/rails/rails/issues/48418,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48418/labels{/name},https://api.github.com/repos/rails/rails/issues/48418/comments,https://api.github.com/repos/rails/rails/issues/48418/events,https://github.com/rails/rails/pull/48418,1746076572,PR_kwDNIULOUmxkvQ,48418,Raise if `exec_insert` and `insert` are used with an unsupported `returning` value,"{'login': 'nvasilevski', 'id': 5512772, 'node_id': 'MDQ6VXNlcjU1MTI3NzI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5512772?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nvasilevski', 'html_url': 'https://github.com/nvasilevski', 'followers_url': 'https://api.github.com/users/nvasilevski/followers', 'following_url': 'https://api.github.com/users/nvasilevski/following{/other_user}', 'gists_url': 'https://api.github.com/users/nvasilevski/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nvasilevski/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nvasilevski/subscriptions', 'organizations_url': 'https://api.github.com/users/nvasilevski/orgs', 'repos_url': 'https://api.github.com/users/nvasilevski/repos', 'events_url': 'https://api.github.com/users/nvasilevski/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nvasilevski/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-06-07T14:44:41Z,2023-06-22T19:53:11Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48418', 'html_url': 'https://github.com/rails/rails/pull/48418', 'diff_url': 'https://github.com/rails/rails/pull/48418.diff', 'patch_url': 'https://github.com/rails/rails/pull/48418.patch', 'merged_at': None}","`exec_insert` and `insert` methods accept a `returning` argument, however only PostgreSQL adapter fully supports it. This commit adds a validation that raises in case if value passed as `returning` is not supported by the adapter.

Since now Rails doesn't allow using `returning` argument if adapter doesn't support RETURNING statement Rails itself as a caller of this method should explicitly pass `nil` for non-postgresql adapters to preserve the default return value which is the last inserted id


### Implementation details

Since `insert` method eventually calls into `exec_insert` and `exec_insert` calls into `sql_for_insert`  the validation only exists in the `sql_for_insert` method
","{'url': 'https://api.github.com/repos/rails/rails/issues/48418/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48418/timeline,,
https://api.github.com/repos/rails/rails/issues/48393,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48393/labels{/name},https://api.github.com/repos/rails/rails/issues/48393/comments,https://api.github.com/repos/rails/rails/issues/48393/events,https://github.com/rails/rails/pull/48393,1740349032,PR_kwDNIULOUh5-fw,48393,Support nested array bind parameter for PostgreSQL parameter.,"{'login': 'simi', 'id': 193936, 'node_id': 'MDQ6VXNlcjE5MzkzNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/193936?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/simi', 'html_url': 'https://github.com/simi', 'followers_url': 'https://api.github.com/users/simi/followers', 'following_url': 'https://api.github.com/users/simi/following{/other_user}', 'gists_url': 'https://api.github.com/users/simi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/simi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/simi/subscriptions', 'organizations_url': 'https://api.github.com/users/simi/orgs', 'repos_url': 'https://api.github.com/users/simi/repos', 'events_url': 'https://api.github.com/users/simi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/simi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,13,2023-06-04T12:31:54Z,2023-06-06T10:44:04Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48393', 'html_url': 'https://github.com/rails/rails/pull/48393', 'diff_url': 'https://github.com/rails/rails/pull/48393.diff', 'patch_url': 'https://github.com/rails/rails/pull/48393.patch', 'merged_at': None}","### Motivation / Background

Add support for multi column where syntax (aka `WHERE (id, user) IN ((1, 'Josef'), (2, 'Jimmy'))`) for PostgreSQL adapter.

```ruby
values = [[1, 'Josef'], [2, 'Jimmy']]
User.where('(id, name) IN (?)', values).to_sql
# => SELECT ""users"".* FROM ""users"" WHERE ((id, name) IN ((1, 'Josef'),(2, 'Jimmy')))
```

currently this raises an exception

```
/app/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.4.3/lib/active_record/connection_adapters/abstract/quoting.rb:25:in `quote': can't quote Array (TypeError)
```

### Detail

It is possible to chain `OR` conditions like `WHERE (id = 1 AND user = 'Josef') OR (id = 2 AND user = 'Jimmy')`, but in my use case I do need to handle ten thousands of individual values. Per my testing this approach is heavy for PostgreSQL planner and affects planning time according to `EXPLAIN`.

- 1 000 conditions of 2 values combined by OR
  - Planning Time: 280.032 ms
- 10 000 conditions of 2 values combined by OR
  - Planning Time: 27598.735 ms

compared to multi-column WHERE
- 1 000 conditions of 2 values using ""multi-where""
  - Planning Time: 8.722 ms
- 10 000 conditions of 2 values using ""multi-where""
  - Planning Time: 131.082 ms


### Additional information

It is also easier to compose query this way. Using `or` query needs to be composed in iterative way.

```ruby
values = [ [1, 'Josef'], ... ] # array of 10 000 values
scope = User.all

values.each do |value|
  scope = scope.or(User.where(id: value[0], name: value[1])
end

scope.load # execute
```

_I had troubles even with this approach since `or` doesn't work properly when called without starting where chain already on scope. But I'm not 100% sure I wasn't doing something wrong. I had to do following actually._

```ruby
values = [ [1, 'Josef'], ... ] # array of 10 000 values
scope = User.all

# start where chain first
first_value = values.shift 
scope = scope.where(id: first_value[0], name: first_value[1])

# handle rest with or
values.each do |value|
  scope = scope.or(User.where(id: value[0], name: value[1])
end

scope.load # execute
```

If welcomed, this could be later turned into feature of hash version of where arguments and being supported across all adapters just using the most optimised way available.

```ruby
User.where([:id, :name] => [[1, 'Josef'], [2, 'Jimmy']])
# => uses multi-where when supported (PostgreSQL only) or OR chained combinations for the rest
```

### Tip

_for quick local test, I used following patch_

```ruby
module CustomPostgreSQLQuoting
  def quote(value)
    if value.is_a?(Array)
      ""(#{value.map { |v| super(v) }.join(', ')})""
    else
      super
    end
  end
end

ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.prepend(CustomPostgreSQLQuoting)
```

related to https://github.com/rails/rails/pull/47410#issuecomment-1434957200 as well

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48393/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48393/timeline,,
https://api.github.com/repos/rails/rails/issues/48390,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48390/labels{/name},https://api.github.com/repos/rails/rails/issues/48390/comments,https://api.github.com/repos/rails/rails/issues/48390/events,https://github.com/rails/rails/pull/48390,1738942686,PR_kwDNIULOUgrfsw,48390,Add :public_id_column option to accepts_nested_attributes_for,"{'login': 'westonganger', 'id': 3414795, 'node_id': 'MDQ6VXNlcjM0MTQ3OTU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3414795?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/westonganger', 'html_url': 'https://github.com/westonganger', 'followers_url': 'https://api.github.com/users/westonganger/followers', 'following_url': 'https://api.github.com/users/westonganger/following{/other_user}', 'gists_url': 'https://api.github.com/users/westonganger/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/westonganger/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/westonganger/subscriptions', 'organizations_url': 'https://api.github.com/users/westonganger/orgs', 'repos_url': 'https://api.github.com/users/westonganger/repos', 'events_url': 'https://api.github.com/users/westonganger/events{/privacy}', 'received_events_url': 'https://api.github.com/users/westonganger/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,9,2023-06-02T23:25:48Z,2023-07-15T19:20:05Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48390', 'html_url': 'https://github.com/rails/rails/pull/48390', 'diff_url': 'https://github.com/rails/rails/pull/48390.diff', 'patch_url': 'https://github.com/rails/rails/pull/48390.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

This Pull Request has been created because I would like to use `accepts_nested_attributes_for` and `fields_for` with a public_id column instead of the PK. `fields_for` doesnt seem to honor `to_param` because it continues to place the PK in the hidden ID field.

### Detail

This Pull Request changes` accepts_nested_attributes_for` and `fields_for` behaviour by adding an additional option to `accepts_nested_attributes_for` called `:public_id_column`

This new argument is intended to allow to specify a public ID column to use for the value of the forms hidden `[id]` input rather than the default public key.

```ruby
class Post < ApplicationRecord
  accepts_nested_attributes_for :comments, public_id_column: :public_id
end
```

When used in views/forms with `fields_for` it should automatically output the following hidden ID field.

```html
<input 
  type=""hidden""
  name=""post[comments_attributes][0][id]"" 
  value=""value-of-the-public_id-column""
  ...etc...
>
```

I chose add an argument to `accepts_nested_attributes_for` because its a lot simpler to add an argument to this method rather than to change the basics of ActiveRecord::Base by adding a new method similar to how `to_param` works. Looking for productive feedback here if we want to take the route of defining a class method or something instead.

### Additional information

Discussion on reddit: https://www.reddit.com/r/rails/comments/13xulzr/how_can_i_use_accepts_nested_attributes_for/

Video walkthrough on how the [`brick` gem ](https://github.com/lorint/brick) is currently hacking in this functionality with `friendly_id`. https://www.reddit.com/r/rails/comments/13z4hfq/hey_uwestonganger_accepts_nested_attributes_for/

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48390/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48390/timeline,,
https://api.github.com/repos/rails/rails/issues/48386,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48386/labels{/name},https://api.github.com/repos/rails/rails/issues/48386/comments,https://api.github.com/repos/rails/rails/issues/48386/events,https://github.com/rails/rails/pull/48386,1738812717,PR_kwDNIULOUgkbLQ,48386,Add ability to specify resulting key names for `as_json` `:methods` option,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,1,2023-06-02T20:50:53Z,2023-06-02T21:18:11Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48386', 'html_url': 'https://github.com/rails/rails/pull/48386', 'diff_url': 'https://github.com/rails/rails/pull/48386.diff', 'patch_url': 'https://github.com/rails/rails/pull/48386.patch', 'merged_at': None}","I recently had a need to specify an alternative name for the key when used ActiveModel's `as_json` method with `:methods` option. For example, I have a `User` model and I want to render its `nick` as a `unique_id`.

While this can be achieved by using `alias`/`alias_method` for methods (and `alias_attribute` for attributes) in the model itself, it does not always makes sense to have them in the model, because the name can be from a different domain (vocabulary etc) and so be confusing when defined there.

Now, this is possible with the following syntax:
```ruby
user.as_json(methods: [:permalink, { unique_id: :nick }])
# => { ""id"" => 1, ""name"" => ""Konata Izumi"", ""age"" => 16, ""nick"" => ""kozumi"",
#      ""permalink"" => ""1-konata-izumi"", ""unique_id"" => ""kozumi"" }
```

This works for attributes too:
```ruby
user.as_json(except: [:name], methods: { nickname: :name })
```","{'url': 'https://api.github.com/repos/rails/rails/issues/48386/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48386/timeline,,
https://api.github.com/repos/rails/rails/issues/48375,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48375/labels{/name},https://api.github.com/repos/rails/rails/issues/48375/comments,https://api.github.com/repos/rails/rails/issues/48375/events,https://github.com/rails/rails/issues/48375,1737590067,I_kwDNIULOZ5GFMw,48375,Server-Timings reported for partials are incorrect (too high) when nested partials are used,"{'login': 'tgaff', 'id': 1916144, 'node_id': 'MDQ6VXNlcjE5MTYxNDQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1916144?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/tgaff', 'html_url': 'https://github.com/tgaff', 'followers_url': 'https://api.github.com/users/tgaff/followers', 'following_url': 'https://api.github.com/users/tgaff/following{/other_user}', 'gists_url': 'https://api.github.com/users/tgaff/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/tgaff/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/tgaff/subscriptions', 'organizations_url': 'https://api.github.com/users/tgaff/orgs', 'repos_url': 'https://api.github.com/users/tgaff/repos', 'events_url': 'https://api.github.com/users/tgaff/events{/privacy}', 'received_events_url': 'https://api.github.com/users/tgaff/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-06-02T07:06:49Z,2023-09-05T18:05:42Z,,NONE,,,,"Server Timings reported for partials are longer than the entire request as reported by the browser.

### Steps to reproduce

1. Use an endpoint with a lot of nested-partials.
1. Look at server timings in browser network tabs
2. Observe that the timing for `render_partial.action_view` is longer than the entire duration the browser reports for the request. 
4. Observe that the timing for `render_partial.action_view` is longer than the duration reported in the Rails log

Example:
 Rails might report `Completed 200 OK in 2796ms` but in the Server-Timings you'll see a higher number for `render_partial.action_view` such as 3725.8ms

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

**Note: the test-case requires views.  Please see the repo https://github.com/tgaff/rails-server-timing-issue-demo/tree/main/executable_test_case** or add your own views.
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""rails"", '=7.0.4.3'
  gem ""rack"", ""~> 2.0""
  gem ""debug"", platforms: %i[ mri mingw x64_mingw ]
  gem ""pry""
end

require ""action_controller/railtie""

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""example.org""
  secrets.secret_key_base = ""secret_key_base""
  config.server_timing = true

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    get ""/nested"" => ""test#nested""
    get ""/not_nested"" => ""test#not_nested""
  end
end

class TestController < ActionController::Base
  include Rails.application.routes.url_helpers

  def nested
    self.append_view_path('./views')
    @nesting = true
    render 'index'
  end

  def not_nested
    self.append_view_path('./views')
    @nesting = false
    render 'index'
  end
end

require ""minitest/autorun""
require ""rack/test""

class ServerTimingBugTest < Minitest::Test
  include Rack::Test::Methods

  def test_nested_response_ok
    get ""/nested""
    assert last_response.ok?
  end

  def test_nested_partial_timing_less_than_total_controller
    get ""/nested""
    assert_operator render_partial_timing_dur, :<, process_action_timing_dur, ""partial rendering should be less than total action time""
  end

  def test_not_nested_response_ok
    get ""/not_nested""
    assert last_response.ok?
  end

  def test_not_nested_partial_timing_less_than_total_controller
    get ""/not_nested""
    assert_operator render_partial_timing_dur, :<, process_action_timing_dur, ""partial rendering should be less than total action time""
  end

  private
    def app
      Rails.application
    end

    def reported_server_timings
      last_response.headers[""Server-Timing""]
    end

    def reported_timing_durations
      timings = {}
      reported_server_timings.split(',').each do |entry|
        k, almost_v = entry.strip.split(';')
        timings[k.strip] = almost_v.delete('dur=').to_f
      end
      timings
    end

    def render_partial_timing_dur
      reported_timing_durations['render_partial.action_view']
    end

    def process_action_timing_dur
      reported_timing_durations['process_action.action_controller']
    end
end
```

This is a little easier to understand in the browser where you can easily see the entire request time.  As such I've uploaded a demo app: https://github.com/tgaff/rails-server-timing-issue-demo
The executable test case is also in that repo in a sub-directory.


### Expected behavior
<!-- Tell us what should happen -->
* Server-timings reported for partials should be accurate.
* Server-timings reported for partials should be less than the total request time.


### Actual behavior
<!-- Tell us what happens instead -->
* Server timings reported to chrome, when partials are involved indicate a longer duration than the entirety of the request.

### System configuration
**Rails version**: 7.0.4.3 && main
**Ruby version**:  3.2.0

### screenshot

<img width=""572"" alt=""Screen Shot 2023-06-02 at 3 52 03 PM"" src=""https://github.com/rails/rails/assets/1916144/2ebada20-2d97-4244-9e86-0550a8ca9d71"">

Note in the above request:
* the browser says the request took 13.70 seconds.
* server reported that partials took 23.39 seconds.


#### other info / commentary

* I'm aware of https://github.com/rails/rails/issues/41452 and believe this is a separate issue.
* My guess is that if `_a` render's partial `_b`, then the timing info for `_a` includes `_b`'s render time, but `_b`'s timing is also added in the final sum.
* Reproducible with logging turned off (`ActionView::Base.logger = nil`)
* Manual wristwatch verification of browser total time shows it to be correct-ish.
* Partials aren't processed in parallel are they?","{'url': 'https://api.github.com/repos/rails/rails/issues/48375/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48375/timeline,,
https://api.github.com/repos/rails/rails/issues/48372,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48372/labels{/name},https://api.github.com/repos/rails/rails/issues/48372/comments,https://api.github.com/repos/rails/rails/issues/48372/events,https://github.com/rails/rails/issues/48372,1737187584,I_kwDNIULOZ4thAA,48372,Rails 6.1.x `rails new; rake assets:precompile` is broken,"{'login': 'schneems', 'id': 59744, 'node_id': 'MDQ6VXNlcjU5NzQ0', 'avatar_url': 'https://avatars.githubusercontent.com/u/59744?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/schneems', 'html_url': 'https://github.com/schneems', 'followers_url': 'https://api.github.com/users/schneems/followers', 'following_url': 'https://api.github.com/users/schneems/following{/other_user}', 'gists_url': 'https://api.github.com/users/schneems/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/schneems/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/schneems/subscriptions', 'organizations_url': 'https://api.github.com/users/schneems/orgs', 'repos_url': 'https://api.github.com/users/schneems/repos', 'events_url': 'https://api.github.com/users/schneems/events{/privacy}', 'received_events_url': 'https://api.github.com/users/schneems/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,7,2023-06-01T22:32:07Z,2023-08-03T09:48:33Z,,MEMBER,,,,"### Steps to reproduce

```
mkdir -p /tmp/79de2b03fd57b181232892d89e7e9920; cd /tmp/79de2b03fd57b181232892d89e7e9920
rails _6.1.7.3_ new myapp --database=postgresql
cd myapp
RAILS_ENV=production SECRET_KEY_BASE=asdf bundle exec rake assets:precompile assets:clean
```


### Expected behavior

It precompiles fine

### Actual behavior

```
Compiling...
Compilation failed:
node:internal/process/promises:289
            triggerUncaughtException(err, true /* fromPromise */);
            ^

Error: Cannot find package '@babel/plugin-proposal-private-methods' imported from /private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/babel-virtual-resolve-base.js
    at new NodeError (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/vendor/import-meta-resolve.js:203:5)
    at packageResolve (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/vendor/import-meta-resolve.js:873:9)
    at moduleResolve (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/vendor/import-meta-resolve.js:902:20)
    at defaultResolve (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/vendor/import-meta-resolve.js:985:15)
    at resolve (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/vendor/import-meta-resolve.js:999:12)
    at resolve (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/files/import-meta-resolve.js:13:10)
    at tryImportMetaResolve (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/files/plugins.js:123:45)
    at resolveStandardizedNameForImport (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/files/plugins.js:145:19)
    at resolveStandardizedName (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/files/plugins.js:154:12)
    at loadPlugin (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/files/plugins.js:47:20)
    at loadPlugin.next (<anonymous>)
    at createDescriptor (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/config-descriptors.js:139:16)
    at createDescriptor.next (<anonymous>)
    at step (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/gensync/index.js:261:32)
    at evaluateAsync (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/gensync/index.js:291:5)
    at /private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/gensync/index.js:44:11
    at Array.forEach (<anonymous>)
    at Function.async (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/gensync/index.js:43:15)
    at Function.all (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/gensync/index.js:216:13)
    at Generator.next (<anonymous>)
    at createDescriptors (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/config-descriptors.js:101:41)
    at createDescriptors.next (<anonymous>)
    at createPluginDescriptors (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/config-descriptors.js:98:17)
    at createPluginDescriptors.next (<anonymous>)
    at /private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/gensync-utils/functional.js:21:23
    at Generator.next (<anonymous>)
    at mergeChainOpts (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/config-chain.js:349:34)
    at mergeChainOpts.next (<anonymous>)
    at chainWalker (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/config-chain.js:316:14)
    at chainWalker.next (<anonymous>)
    at loadFileChain (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/config-chain.js:192:24)
    at loadFileChain.next (<anonymous>)
    at buildRootChain (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/config-chain.js:78:27)
    at buildRootChain.next (<anonymous>)
    at loadPrivatePartialConfig (/private/tmp/79de2b03fd57b181232892d89e7e9920/myapp/node_modules/@babel/core/lib/config/partial.js:79:62)
    at loadPrivatePartialConfig.next (<anonymous>) {
  code: 'ERR_MODULE_NOT_FOUND'
}
```

### System configuration
**Rails version**: 6.1.7.3

**Ruby version**: 3.0.6

### Notes

This appears to be happening because webpacker generates a `babel.config.js` https://github.com/rails/webpacker/blob/1cec8408d9c30e458c9f83b0c50ef53a255a4352/lib/install/config/babel.config.js#L57-L60 that includes `plugin-proposal-private-methods`, however it does not add a dependency to `plugin-proposal-private-methods`. Instead, it depends on a package that depends on `plugin-proposal-private-methods`. 

Recently that package was re-named to `plugin-transform-private-methods` https://github.com/babel/babel/pull/15614 and I believe it was released https://github.com/babel/babel/commit/389ecb08ed502cd13671928c1ab9caccb72f0a6f. 

So now when babel tries to execute it reads in the `babel.config.js` file, sees that it needs `plugin-proposal-private-methods`. Tries to load it, but that fails because `plugin-proposal-private-methods` is not installed (since it is no longer a dependency).

A suggested path forward: Update the `babel.config.js` to reference the new file name. Or explicitly depend on all plugins in the `babel.config.js`. Maybe lock down some dependency versions.

To anyone hitting this error in your app you can change the name in your `babel.config.js` like this:

```diff
-       '@babel/plugin-proposal-private-methods',
+       '@babel/plugin-transform-private-methods', 
```

There are more ""proposal"" items in there. As this happens again, people will hit the same bug.

","{'url': 'https://api.github.com/repos/rails/rails/issues/48372/reactions', 'total_count': 16, '+1': 16, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48372/timeline,,
https://api.github.com/repos/rails/rails/issues/48364,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48364/labels{/name},https://api.github.com/repos/rails/rails/issues/48364/comments,https://api.github.com/repos/rails/rails/issues/48364/events,https://github.com/rails/rails/pull/48364,1735698066,PR_kwDNIULOUd5h7g,48364,Add support using `load_async()` inside `connected_to` block.,"{'login': 'r-plus', 'id': 425216, 'node_id': 'MDQ6VXNlcjQyNTIxNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/425216?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/r-plus', 'html_url': 'https://github.com/r-plus', 'followers_url': 'https://api.github.com/users/r-plus/followers', 'following_url': 'https://api.github.com/users/r-plus/following{/other_user}', 'gists_url': 'https://api.github.com/users/r-plus/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/r-plus/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/r-plus/subscriptions', 'organizations_url': 'https://api.github.com/users/r-plus/orgs', 'repos_url': 'https://api.github.com/users/r-plus/repos', 'events_url': 'https://api.github.com/users/r-plus/events{/privacy}', 'received_events_url': 'https://api.github.com/users/r-plus/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-06-01T07:46:37Z,2023-06-01T07:46:40Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48364', 'html_url': 'https://github.com/rails/rails/pull/48364', 'diff_url': 'https://github.com/rails/rails/pull/48364.diff', 'patch_url': 'https://github.com/rails/rails/pull/48364.patch', 'merged_at': None}","### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because `load_async()` used ActiveRecord::Relation return value inside the `connected_to` block will immediately back to foreground execution by calling `load` method.


already discussed at https://github.com/rails/rails/issues/48351

### Detail

This Pull Request add support usage of `load_async()` inside the `connected_to` block to asynchronous query execution 
 to specific replica/shard database like below code.

```ruby
@foo = ActiveRecord::Base.connected_to(role: :reading) do
  User.where(id: 1).load_async
end
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->
added test case and others in the `connection_handlers_multi_db_test.rb` are passed in my local machine.

```sh
vscode  /workspaces/rails/activerecord (feature/load-async-support-in-connected-to) $ bin/test test/cases/connection_adapters/connection_handlers_multi_db_test.rb
Using sqlite3
Run options: --seed 55330

# Running:

.......................

Finished in 0.342922s, 67.0706 runs/s, 224.5408 assertions/s.
23 runs, 77 assertions, 0 failures, 0 errors, 0 skips
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48364/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48364/timeline,,
https://api.github.com/repos/rails/rails/issues/48358,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48358/labels{/name},https://api.github.com/repos/rails/rails/issues/48358/comments,https://api.github.com/repos/rails/rails/issues/48358/events,https://github.com/rails/rails/pull/48358,1734952069,PR_kwDNIULOUdRBrQ,48358,Signed id with polymorphic name purpose,"{'login': 'alxckn', 'id': 11556013, 'node_id': 'MDQ6VXNlcjExNTU2MDEz', 'avatar_url': 'https://avatars.githubusercontent.com/u/11556013?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/alxckn', 'html_url': 'https://github.com/alxckn', 'followers_url': 'https://api.github.com/users/alxckn/followers', 'following_url': 'https://api.github.com/users/alxckn/following{/other_user}', 'gists_url': 'https://api.github.com/users/alxckn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/alxckn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/alxckn/subscriptions', 'organizations_url': 'https://api.github.com/users/alxckn/orgs', 'repos_url': 'https://api.github.com/users/alxckn/repos', 'events_url': 'https://api.github.com/users/alxckn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/alxckn/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-05-31T20:17:36Z,2023-06-06T15:19:44Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48358', 'html_url': 'https://github.com/rails/rails/pull/48358', 'diff_url': 'https://github.com/rails/rails/pull/48358.diff', 'patch_url': 'https://github.com/rails/rails/pull/48358.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because moving an ActiveRecord class makes previously generated signed ids invalid.

### Detail

This Pull Request changes what base purpose is chosen for a signed id and uses `base_class.polymorphic_name` instead of `base_class.name`.
The rationale behind this proposal would be that `polymorphic_name` is the representation of the class/table in external systems.

### Additional information

I am not 100% sure `polymorphic_name` is the best fit, it is convenient because overriding it would solve multiple issues at once (polymorphic relations, signed ids) when having to move an ActiveRecord class.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48358/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48358/timeline,,
https://api.github.com/repos/rails/rails/issues/48351,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48351/labels{/name},https://api.github.com/repos/rails/rails/issues/48351/comments,https://api.github.com/repos/rails/rails/issues/48351/events,https://github.com/rails/rails/issues/48351,1733815194,I_kwDNIULOZ1frmg,48351,[Question] any plan to support `load_async()` with `ActiveRecord::Base.connected_to` ?,"{'login': 'r-plus', 'id': 425216, 'node_id': 'MDQ6VXNlcjQyNTIxNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/425216?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/r-plus', 'html_url': 'https://github.com/r-plus', 'followers_url': 'https://api.github.com/users/r-plus/followers', 'following_url': 'https://api.github.com/users/r-plus/following{/other_user}', 'gists_url': 'https://api.github.com/users/r-plus/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/r-plus/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/r-plus/subscriptions', 'organizations_url': 'https://api.github.com/users/r-plus/orgs', 'repos_url': 'https://api.github.com/users/r-plus/repos', 'events_url': 'https://api.github.com/users/r-plus/events{/privacy}', 'received_events_url': 'https://api.github.com/users/r-plus/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,"{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,8,2023-05-31T09:56:27Z,2023-09-09T20:45:06Z,,NONE,,,,"Hi guys

Is it possible to use async query by `load_async()` inside the block of `ActiveRecord::Base#connected_to` method to connect to replica database?

In my investigation, currently no.
Because `connected_to` method immediately call `load` method if return value is `ActiveRecord::Relation`, as the result asynchronous query execution back to foreground.
https://github.com/rails/rails/blob/4e71edfca8525417597b079440d876310dd6290d/activerecord/lib/active_record/connection_handling.rb#L355

Do you have any plan to support `load_async()` support inside the `ActiveRecord::Base#connected_to` ?","{'url': 'https://api.github.com/repos/rails/rails/issues/48351/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48351/timeline,,
https://api.github.com/repos/rails/rails/issues/48341,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48341/labels{/name},https://api.github.com/repos/rails/rails/issues/48341/comments,https://api.github.com/repos/rails/rails/issues/48341/events,https://github.com/rails/rails/issues/48341,1731516319,I_kwDNIULOZzTXnw,48341,Rails cache prefix is not properly configured for isolated caching during parallel tests.,"{'login': 'rbroemeling', 'id': 149464, 'node_id': 'MDQ6VXNlcjE0OTQ2NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/149464?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rbroemeling', 'html_url': 'https://github.com/rbroemeling', 'followers_url': 'https://api.github.com/users/rbroemeling/followers', 'following_url': 'https://api.github.com/users/rbroemeling/following{/other_user}', 'gists_url': 'https://api.github.com/users/rbroemeling/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rbroemeling/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rbroemeling/subscriptions', 'organizations_url': 'https://api.github.com/users/rbroemeling/orgs', 'repos_url': 'https://api.github.com/users/rbroemeling/repos', 'events_url': 'https://api.github.com/users/rbroemeling/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rbroemeling/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,21,2023-05-30T05:10:08Z,2023-09-30T06:21:01Z,,NONE,,,,"I've been investigating why I am seeing a lot of transient test failures due to cache collisions with parallelized tests. I thought it was because Rails doesn't update the cache prefix to protect from collisions but after looking at it; it's looking like Rails _tries_ to do that (by appending `Process.pid` and `Thread.current.object_id` to the namespace), but that it isn't working properly.

For the moment I've worked around it by adding namespace delineation myself in the `parallelize_setup` block of the test helper, but it'd be better if Rails handled this automatically so that no-one has to worry about it.

### Steps to reproduce

Replace `test/test_helper.rb` contents with the following:

```ruby
module ActiveSupport
  class TestCase
    # Run tests in parallel with specified workers
    parallelize(workers: :number_of_processors)

    # Setup all fixtures in test/fixtures/*.yml for all tests in alphabetical order.
    fixtures :all

    parallelize_setup do |worker|
      puts ""#{worker.inspect}: #{Rails.cache.options[:namespace]}""
    end

    # Add more helper methods to be used by all tests here...
  end
end
```

### Expected Behavior

The namespaces listed should be unique per worker to isolate the test runners so that they do not collide during parallelization. It should look something like this (assuming that the cache prefix configured is `test:20230518:`, which is what mine is configured to be).


```
6: test:20230518:63512:3580:
5: test:20230518:63513:3580:
0: test:20230518:63514:3580:
3: test:20230518:63515:3580:
7: test:20230518:63516:3580:
4: test:20230518:63517:3580:
1: test:20230518:63518:3580:
2: test:20230518:63519:3580:
```

### Actual Behavior

Instead, the namespaces listed all share identical process identifiers and thread identifiers.

```
6: test:20230518:63512:3580:
5: test:20230518:63512:3580:
0: test:20230518:63512:3580:
3: test:20230518:63512:3580:
7: test:20230518:63512:3580:
4: test:20230518:63512:3580:
1: test:20230518:63512:3580:
2: test:20230518:63512:3580:
```

### System configuration
**Rails version**:

```
% fgrep rails Gemfile.lock
      rails-dom-testing (~> 2.0)
      rails-dom-testing (~> 2.0)
      rails-html-sanitizer (~> 1.0, >= 1.2.0)
      rails-dom-testing (~> 2.0)
      rails-html-sanitizer (~> 1.1, >= 1.2.0)
    importmap-rails (1.1.6)
    rails (7.0.5)
    rails-dom-testing (2.0.3)
    rails-html-sanitizer (1.6.0)
    sentry-rails (5.9.0)
    sprockets-rails (3.4.2)
    tailwindcss-rails (2.0.29-arm64-darwin)
    tailwindcss-rails (2.0.29-x86_64-darwin)
    tailwindcss-rails (2.0.29-x86_64-linux)
    turbo-rails (1.4.0)
  importmap-rails (~> 1.1)
  rails (~> 7.0.5)
  sentry-rails
  sprockets-rails
  tailwindcss-rails (~> 2.0)
  turbo-rails
```

**Ruby version**:

```
% ruby --version
ruby 3.2.2 (2023-03-30 revision e51014f9c0) [arm64-darwin21]
```
","{'url': 'https://api.github.com/repos/rails/rails/issues/48341/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48341/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/48338,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48338/labels{/name},https://api.github.com/repos/rails/rails/issues/48338/comments,https://api.github.com/repos/rails/rails/issues/48338/events,https://github.com/rails/rails/pull/48338,1731436350,PR_kwDNIULOUaRm5g,48338,Add rename option to serializable_hash method,"{'login': 'dongcheolpark', 'id': 36955431, 'node_id': 'MDQ6VXNlcjM2OTU1NDMx', 'avatar_url': 'https://avatars.githubusercontent.com/u/36955431?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dongcheolpark', 'html_url': 'https://github.com/dongcheolpark', 'followers_url': 'https://api.github.com/users/dongcheolpark/followers', 'following_url': 'https://api.github.com/users/dongcheolpark/following{/other_user}', 'gists_url': 'https://api.github.com/users/dongcheolpark/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dongcheolpark/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dongcheolpark/subscriptions', 'organizations_url': 'https://api.github.com/users/dongcheolpark/orgs', 'repos_url': 'https://api.github.com/users/dongcheolpark/repos', 'events_url': 'https://api.github.com/users/dongcheolpark/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dongcheolpark/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-05-30T03:07:36Z,2023-09-19T07:40:08Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48338', 'html_url': 'https://github.com/rails/rails/pull/48338', 'diff_url': 'https://github.com/rails/rails/pull/48338.diff', 'patch_url': 'https://github.com/rails/rails/pull/48338.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

Hello contibutors  thank you for your efforts to keep the project alive.

### Motivation / Background
When I use `as_json` method to make the body of the response, There was one inconvenience.
As per Ruby's convention I usually put a question mark in the name of a method. (ex: has_value?)
It's not a problem inside Ruby, but it causes problems when used in other applications accessing the rails server.
To solve this, I had to manipulate the hash returned by `as_json`, which wasn't very clean.

### Detail
To solve the above problem I add a new option called `rename` to the `serializable_hash` method.
It can be used when you want to rename attributes or methods.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48338/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48338/timeline,,
https://api.github.com/repos/rails/rails/issues/48328,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48328/labels{/name},https://api.github.com/repos/rails/rails/issues/48328/comments,https://api.github.com/repos/rails/rails/issues/48328/events,https://github.com/rails/rails/pull/48328,1730124233,PR_kwDNIULOUZKbBA,48328,Deprecate ActionController::MissingRenderer,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,1,2023-05-29T05:59:17Z,2023-05-30T19:34:48Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48328', 'html_url': 'https://github.com/rails/rails/pull/48328', 'diff_url': 'https://github.com/rails/rails/pull/48328.diff', 'patch_url': 'https://github.com/rails/rails/pull/48328.patch', 'merged_at': None}","When working on #48327, I noticed the comment for this class references a method which has moved to the [responders gem](https://github.com/heartcombo/responders). Nothing else in Rails uses it internally, so I think we can move it to that gem and deprecate it from Rails.

I've opened a PR to move it in heartcombo/responders#245.

Inspiration for the constant deprecation path came from 3e2552db899160266f175f2fda61e44be258aecd but LMK if there is a better way! :bow:","{'url': 'https://api.github.com/repos/rails/rails/issues/48328/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48328/timeline,,
https://api.github.com/repos/rails/rails/issues/48326,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48326/labels{/name},https://api.github.com/repos/rails/rails/issues/48326/comments,https://api.github.com/repos/rails/rails/issues/48326/events,https://github.com/rails/rails/issues/48326,1730003454,I_kwDNIULOZx3B_g,48326,"SyntaxError in an autoloading class referenced from a view causes ""TypeError: Thread::Backtrace::Location object expected""","{'login': 'zarqman', 'id': 22556, 'node_id': 'MDQ6VXNlcjIyNTU2', 'avatar_url': 'https://avatars.githubusercontent.com/u/22556?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zarqman', 'html_url': 'https://github.com/zarqman', 'followers_url': 'https://api.github.com/users/zarqman/followers', 'following_url': 'https://api.github.com/users/zarqman/following{/other_user}', 'gists_url': 'https://api.github.com/users/zarqman/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zarqman/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zarqman/subscriptions', 'organizations_url': 'https://api.github.com/users/zarqman/orgs', 'repos_url': 'https://api.github.com/users/zarqman/repos', 'events_url': 'https://api.github.com/users/zarqman/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zarqman/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2023-05-29T04:10:01Z,2023-08-17T12:09:13Z,,CONTRIBUTOR,,,,"If a view renders code that autoloads a class that has a syntax error, `DebugExceptions` fails with a `TypeError: Thread::Backtrace::Location object expected`.

<details>
<summary>Backtrace</summary>

```
TypeError: Thread::Backtrace::Location object expected
 <internal:ast>:112:in `node_id_for_backtrace_location'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionview/lib/action_view/template.rb:172:in `spot'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/exception_wrapper.rb:252:in `spot'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/exception_wrapper.rb:302:in `extract_source'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/exception_wrapper.rb:206:in `block in source_extracts'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/exception_wrapper.rb:205:in `map'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/exception_wrapper.rb:205:in `source_extracts'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/debug_exceptions.rb:125:in `create_template'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/debug_exceptions.rb:77:in `render_for_browser_request'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/debug_exceptions.rb:69:in `render_exception'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/debug_exceptions.rb:44:in `rescue in call'
~/.rvm/gems/ruby-3.2.2@rails71/bundler/gems/rails-294be7c7de34/actionpack/lib/action_dispatch/middleware/debug_exceptions.rb:28:in `call'
```

</details>

### Steps to reproduce

`test.rb`:
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""rack"", ""~> 2.0""
end

require ""action_controller/railtie""

# since DebugExceptions throws its own exception, display it here
module ActionDispatch
  class ShowExceptions
    def call(env)
      @app.call(env)
    rescue Exception => exception
      request = ActionDispatch::Request.new env
      backtrace_cleaner = request.get_header(""action_dispatch.backtrace_cleaner"")
      wrapper = ExceptionWrapper.new(backtrace_cleaner, exception)
      puts ""[SE] #{exception.inspect}""
      puts ""[SE]   #{exception.backtrace.join(""\n[SE]  "")}""
      if wrapper.show?(request)
        render_exception(request, wrapper)
      else
        raise exception
      end
    end
  end
end

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""example.org""
  secrets.secret_key_base = ""secret_key_base""
  config.consider_all_requests_local = true

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    get ""/"" => ""test#index""
  end
end

class TestController < ActionController::Base
  include Rails.application.routes.url_helpers
  append_view_path '.'

  def index
    render '/view_test_1'
  end

  # simulate a syntax error in an external, auto-loading class
  def helper_1
    eval %(
      'abc' + pluralize 'def'
    )
  end
  helper_method :helper_1
end

require ""minitest/autorun""
require ""rack/test""

class BugTest < Minitest::Test
  include Rack::Test::Methods

  def test_returns_success
    get ""/""
    # expecting a DebugExceptions response
    assert_match %r{<header role=""banner"">|<main role=""main""}, last_response.body
  end

  private
    def app
      Rails.application
    end
end
```

`view_test_1.html.erb` (placed in same base dir as test.rb):
```erb
-view-
<%= helper_1 %>
```


### Expected behavior
A standard DebugExceptions response should display the initial `SyntaxError` exception.

### Actual behavior
DebugExceptions itself raises a `TypeError` with message `Thread::Backtrace::Location object expected`, in turn causing a generic 500 error to be returned.

### System configuration
**Rails version**: main

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48326/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48326/timeline,,
https://api.github.com/repos/rails/rails/issues/48305,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48305/labels{/name},https://api.github.com/repos/rails/rails/issues/48305/comments,https://api.github.com/repos/rails/rails/issues/48305/events,https://github.com/rails/rails/pull/48305,1726654211,PR_kwDNIULOUWOj-g,48305,Add syntax for CTE materialization hint to ActiveRecord,"{'login': '97jaz', 'id': 984854, 'node_id': 'MDQ6VXNlcjk4NDg1NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/984854?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/97jaz', 'html_url': 'https://github.com/97jaz', 'followers_url': 'https://api.github.com/users/97jaz/followers', 'following_url': 'https://api.github.com/users/97jaz/following{/other_user}', 'gists_url': 'https://api.github.com/users/97jaz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/97jaz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/97jaz/subscriptions', 'organizations_url': 'https://api.github.com/users/97jaz/orgs', 'repos_url': 'https://api.github.com/users/97jaz/repos', 'events_url': 'https://api.github.com/users/97jaz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/97jaz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,7,2023-05-26T00:35:36Z,2023-06-27T00:17:35Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48305', 'html_url': 'https://github.com/rails/rails/pull/48305', 'diff_url': 'https://github.com/rails/rails/pull/48305.diff', 'patch_url': 'https://github.com/rails/rails/pull/48305.patch', 'merged_at': None}","### Motivation / Background

Following on the Arel work in #48261, this commit adds the ability to provide a materialization hint to a CTE in ActiveRecord. To support the hint, a more verbose syntax for CTE values is introduced:

```ruby
Post.with(posts_with_comments: { query: Post.where(""comments_count > ?"", 0), materialized: true })
```

The CTE value is described as a hash that contains a required `:query` key and an optional `:materialized` key. The set of available options could be expanded in the future to accommodate, for example, postgres's various options for recursive CTEs.

### Additional information

I don't know whether there's any appetite within the core team to expose this functionality in AR's public API. But if there is, this approach seemed like the most plausible choice, given the current `#with` interface. That said, I'm more than happy to talk about alternatives.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48305/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48305/timeline,,
https://api.github.com/repos/rails/rails/issues/48292,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48292/labels{/name},https://api.github.com/repos/rails/rails/issues/48292/comments,https://api.github.com/repos/rails/rails/issues/48292/events,https://github.com/rails/rails/issues/48292,1724476640,I_kwDNIULOZsls4A,48292,"ActionCable sporadically fails to confirm subscribe because the subscription ""already exists""","{'login': 'shoffing', 'id': 2903742, 'node_id': 'MDQ6VXNlcjI5MDM3NDI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2903742?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shoffing', 'html_url': 'https://github.com/shoffing', 'followers_url': 'https://api.github.com/users/shoffing/followers', 'following_url': 'https://api.github.com/users/shoffing/following{/other_user}', 'gists_url': 'https://api.github.com/users/shoffing/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shoffing/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shoffing/subscriptions', 'organizations_url': 'https://api.github.com/users/shoffing/orgs', 'repos_url': 'https://api.github.com/users/shoffing/repos', 'events_url': 'https://api.github.com/users/shoffing/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shoffing/received_events', 'type': 'User', 'site_admin': False}","[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,8,2023-05-24T17:43:44Z,2023-09-27T10:21:56Z,,NONE,,,,"### Steps to reproduce

- Create a very basic channel that simply streams for the current user:

```rb
class PerfTestChannel < ApplicationCable::Channel
  def subscribed
    stream_for current_user
  end
end
```

- On page load, subscribe to the channel.

```js
App.cable.subscriptions.create('PerfTestChannel');
```

### Expected behavior

The ActionCable client should be able to reliably subscribe to a channel.

### Actual behavior

- On a development instance with browser network latency simulation, or any staging/production instance, the `subscribe` command will sporadically (varying from 5%-70% depending on load) fail to be confirmed. The `SubscriptionGuarantor` will repeatedly attempt to resubscribe every 500ms, but no confirmation will ever be received.

![image](https://github.com/rails/rails/assets/2903742/8dc591b4-ef3a-4d7b-867d-b92ee6f5b906)

- I wrote a JS script to assist in reproducing this error. It repeatedly disconnects & subscribes to the channel until the subscription fails to leave the pendingSubscriptions state in under 600ms. Running this in browser JS console reliably reproduces the issue on a staging/production instance:

```js
(async function() {
  let i = 0;
  while (true) {
    i++;
    App.cable.subscriptions.subscriptions.forEach(sub => App.cable.subscriptions.remove(sub));
    App.cable.disconnect();
    App.cable.subscriptions.create('PerfTestChannel');
    await new Promise(resolve => setTimeout(resolve, 600));
    const pendingSubs = App.cable.subscriptions.guarantor.pendingSubscriptions;
    if (pendingSubs.length > 0) {
      break;
    } else { console.log('...' + i); }
  }
})()
```

### Investigation

This bug was tricky to investigate as there was nothing useful in our logs. The `/cable` request was successfully being upgraded to websockets as expected. We saw some errors that might have been relevant, but none of them occurred reliably with the issue being observed. After digging through the ActionCable source code, we have determined the issue is caused by this line in `subscriptions.rb`: https://github.com/rails/rails/blob/0f5c8c5bc61b7e382e64cad4846406021bc8cd35/actioncable/lib/action_cable/connection/subscriptions.rb#L34

It returns silently if the subscription ""already exists"". We confirmed this is the source of the error by monkey-patching the class in a `config/initializers` to add some logging with the `return`:

```rb
# config/initializers/monkeypatch_actioncable.rb
# frozen_string_literal: true

require ""active_support/core_ext/hash/indifferent_access""

module ActionCable
  module Connection
    # Collection class for all the channel subscriptions established on a given connection. Responsible for routing incoming commands that arrive on
    # the connection to the proper channel.
    class Subscriptions # :nodoc:
      def add(data)
        id_key = data[""identifier""]
        id_options = ActiveSupport::JSON.decode(id_key).with_indifferent_access

        if subscriptions.key?(id_key)
          Rails.logger.info(""[Action Cable] Already subscribed to #{id_key}..."")
          return
        end

        subscription_klass = id_options[:channel].safe_constantize

        if subscription_klass && ActionCable::Channel::Base > subscription_klass
          subscription = subscription_klass.new(connection, id_key, id_options)
          subscriptions[id_key] = subscription
          subscription.subscribe_to_channel
        else
          logger.error ""Subscription class not found: #{id_options[:channel].inspect}""
        end
      end
    end
  end
end
```

We deployed the patch to staging and verified that when the error occurs and `subscribe` is being repeatedly attempted, our logs are filled with the ""Already subscribed..."" message. This appears to confirms that it's not an issue with our load balancer or nginx or something, the `subscribe` command is successfully making its way all the way to the Rails server. It's just being ignored, and failing silently.

### Possible Fix

Simply calling `subscribe_to_channel` if the subscription already exists seems to fix the issue:

```rb
return subscriptions[id_key].subscribe_to_channel if subscriptions.key?(id_key)
```

However, I'm not familiar enough with ActionCable to fully understand the implications of that logic. For example, I think that may result in multiple `subscribed` callbacks being invoked in some cases where multiple `subscribe` commands are sent from the client. There also seems to be some counting-semaphore logic wrapped around the connection to redis, which multiple subscribes could maybe interfere with.

### Impact

This bug is blocking our team's adoption of ActionCable. We cannot rely on the system if it fails to connect with even the most basic of setups.

### System configuration

**Rails version**: 7.0.4.3

**Ruby version**: 3.2.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/48292/reactions', 'total_count': 5, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 2}",https://api.github.com/repos/rails/rails/issues/48292/timeline,,
https://api.github.com/repos/rails/rails/issues/48290,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48290/labels{/name},https://api.github.com/repos/rails/rails/issues/48290/comments,https://api.github.com/repos/rails/rails/issues/48290/events,https://github.com/rails/rails/pull/48290,1724244773,PR_kwDNIULOUUL_xA,48290,Support nested elements inside <button>,"{'login': 'marckohlbrugge', 'id': 93276, 'node_id': 'MDQ6VXNlcjkzMjc2', 'avatar_url': 'https://avatars.githubusercontent.com/u/93276?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/marckohlbrugge', 'html_url': 'https://github.com/marckohlbrugge', 'followers_url': 'https://api.github.com/users/marckohlbrugge/followers', 'following_url': 'https://api.github.com/users/marckohlbrugge/following{/other_user}', 'gists_url': 'https://api.github.com/users/marckohlbrugge/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/marckohlbrugge/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/marckohlbrugge/subscriptions', 'organizations_url': 'https://api.github.com/users/marckohlbrugge/orgs', 'repos_url': 'https://api.github.com/users/marckohlbrugge/repos', 'events_url': 'https://api.github.com/users/marckohlbrugge/events{/privacy}', 'received_events_url': 'https://api.github.com/users/marckohlbrugge/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,2,2023-05-24T15:19:15Z,2023-06-28T00:22:44Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48290', 'html_url': 'https://github.com/rails/rails/pull/48290', 'diff_url': 'https://github.com/rails/rails/pull/48290.diff', 'patch_url': 'https://github.com/rails/rails/pull/48290.patch', 'merged_at': None}","### Motivation / Background

This change is necessary to address a potential issue that could arise when a button or an input of type submit contains child elements, such as spans, icons, or other HTML elements. 

Currently, ActiveStorage's `didClick` event listener checks the target of the click event to determine if a submit button was clicked. The target property of the event refers to the specific HTML element that was clicked.

In cases where a submit button contains child elements, and one of these child elements is the element that actually gets clicked, the target would refer to this child element, not the button itself. 

Since the `didClick` function checks if the target is a button or an input of type submit, this check would fail, and the button wouldn't be stored in `submitButtonsByForm`.

As a result, if the form is then submitted after a direct upload, the first submit button in the form could be incorrectly used to submit the form, even if a different button was originally clicked. This could cause unexpected behavior, as different submit buttons might be intended to trigger different actions on form submission.

### Detail

By using the `Element.closest()` method to find the nearest ancestor of the clicked element that is a button or an input of type submit, we ensure that the correct button is stored in `submitButtonsByForm`, even if the click event was triggered by a child element of the button. This addresses the issue and ensures that the correct button is used to submit the form after a direct upload.","{'url': 'https://api.github.com/repos/rails/rails/issues/48290/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48290/timeline,,
https://api.github.com/repos/rails/rails/issues/48284,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48284/labels{/name},https://api.github.com/repos/rails/rails/issues/48284/comments,https://api.github.com/repos/rails/rails/issues/48284/events,https://github.com/rails/rails/pull/48284,1722103394,PR_kwDNIULOUSXymQ,48284,Fixing invert_where method to handle empty where conditions,"{'login': 'a5-stable', 'id': 52599949, 'node_id': 'MDQ6VXNlcjUyNTk5OTQ5', 'avatar_url': 'https://avatars.githubusercontent.com/u/52599949?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/a5-stable', 'html_url': 'https://github.com/a5-stable', 'followers_url': 'https://api.github.com/users/a5-stable/followers', 'following_url': 'https://api.github.com/users/a5-stable/following{/other_user}', 'gists_url': 'https://api.github.com/users/a5-stable/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/a5-stable/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/a5-stable/subscriptions', 'organizations_url': 'https://api.github.com/users/a5-stable/orgs', 'repos_url': 'https://api.github.com/users/a5-stable/repos', 'events_url': 'https://api.github.com/users/a5-stable/events{/privacy}', 'received_events_url': 'https://api.github.com/users/a5-stable/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-05-23T13:35:39Z,2023-06-05T12:20:20Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48284', 'html_url': 'https://github.com/rails/rails/pull/48284', 'diff_url': 'https://github.com/rails/rails/pull/48284.diff', 'patch_url': 'https://github.com/rails/rails/pull/48284.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

Currently, when`invert_where` is called without any existing where conditions, it throws an error with invalid query. 
```
Post.invert_where.to_sql
#=> SELECT ""posts"".* FROM ""posts"" WHERE NOT ()
```

modified the `invert_where` to return the receiver as is when there are no `where` conditions to invert. 
```
Post.order(:id).invert_where.to_sql
#=>  ""SELECT \""posts\"".* FROM \""posts\"" ORDER BY \""posts\"".\""id\"" ASC""
```

### Detail

When the method chain of `ActiveRecord_Relation` includes an unintentional method such as `unscope(:where)` and I use invert_where after that, unexpected errors occur.
```
relation = Post.where(id: 2)
relation = relation.unscope(:where)
relation.invert_where
```

Also, this change has some kind of consistency with how `unscope(:where)` behaves when there are no scopes defined, I think  
```
Post.order(:id).unscope(:where)
#=> ""SELECT \""posts\"".* FROM \""posts\"" ORDER BY \""posts\"".\""id\"" ASC""
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [ ] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48284/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48284/timeline,,
https://api.github.com/repos/rails/rails/issues/48280,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48280/labels{/name},https://api.github.com/repos/rails/rails/issues/48280/comments,https://api.github.com/repos/rails/rails/issues/48280/events,https://github.com/rails/rails/pull/48280,1721527143,PR_kwDNIULOUR4W1A,48280,ActiveRecord: make query timeout errors inherit from the base connection error,"{'login': 'casperisfine', 'id': 19192189, 'node_id': 'MDQ6VXNlcjE5MTkyMTg5', 'avatar_url': 'https://avatars.githubusercontent.com/u/19192189?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/casperisfine', 'html_url': 'https://github.com/casperisfine', 'followers_url': 'https://api.github.com/users/casperisfine/followers', 'following_url': 'https://api.github.com/users/casperisfine/following{/other_user}', 'gists_url': 'https://api.github.com/users/casperisfine/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/casperisfine/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/casperisfine/subscriptions', 'organizations_url': 'https://api.github.com/users/casperisfine/orgs', 'repos_url': 'https://api.github.com/users/casperisfine/repos', 'events_url': 'https://api.github.com/users/casperisfine/events{/privacy}', 'received_events_url': 'https://api.github.com/users/casperisfine/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-05-23T08:35:46Z,2023-05-23T10:57:55Z,,CONTRIBUTOR,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48280', 'html_url': 'https://github.com/rails/rails/pull/48280', 'diff_url': 'https://github.com/rails/rails/pull/48280.diff', 'patch_url': 'https://github.com/rails/rails/pull/48280.patch', 'merged_at': None}","In my experience, to enable efficient handling of exceptions, network clients must clearly categorize their exceptions in two categories:

  - Network/Connection errors: whenever we didn't actually get a response from the server and perhaps the issue is transient and retrying now or later will work. e.g. Timeout, authentication error, DNS error, etc.

  - Client errors: when the client did something wrong, and it's likely a bug in the user code and they should fix something. e.g. SQL Syntax error, unkown column, etc.

Such categorization allows for better automated handling of exceptions, like retrying or not, sending the exception to a reporting service or just emitting a health metric, etc.

Historically Active Record was quite bad at translating the underlying adapter errors into clean errors of its own, and lots of network related errors were translated into `SatementInvalid` as a big catch all.

In 2019 we started better tranlating these errors (https://github.com/rails/rails/pull/36692, https://github.com/rails/rails/pull/36694) but for backward compatibility reasons these new errors still inherited from `StatementInvalid`.

I think now would be a good time to consider fixing this historical cruft.

Note: opening as a draft as this PR isn't necessarily exactly what I want to change, I'm more interested in gathering thoughts from interested parties.

cc @matthewd @eileencodes @rafaelfranca any opinions?
","{'url': 'https://api.github.com/repos/rails/rails/issues/48280/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48280/timeline,,
https://api.github.com/repos/rails/rails/issues/48278,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48278/labels{/name},https://api.github.com/repos/rails/rails/issues/48278/comments,https://api.github.com/repos/rails/rails/issues/48278/events,https://github.com/rails/rails/issues/48278,1720474166,I_kwDNIULOZoxaNg,48278,Rails new succeeds (exit status zero) even when it does not bundle install Redis,"{'login': 'schneems', 'id': 59744, 'node_id': 'MDQ6VXNlcjU5NzQ0', 'avatar_url': 'https://avatars.githubusercontent.com/u/59744?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/schneems', 'html_url': 'https://github.com/schneems', 'followers_url': 'https://api.github.com/users/schneems/followers', 'following_url': 'https://api.github.com/users/schneems/following{/other_user}', 'gists_url': 'https://api.github.com/users/schneems/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/schneems/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/schneems/subscriptions', 'organizations_url': 'https://api.github.com/users/schneems/orgs', 'repos_url': 'https://api.github.com/users/schneems/repos', 'events_url': 'https://api.github.com/users/schneems/events{/privacy}', 'received_events_url': 'https://api.github.com/users/schneems/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-05-22T20:33:14Z,2023-05-22T22:35:53Z,,MEMBER,,,,"### Steps to reproduce

```term
$ gem install rails --no-document
Successfully installed rails-7.0.4.3
1 gem installed
```

Uninstall all redis gems:

```
$ gem uninstall redis --all
```

Create a Rails app:

```term
$ rails new myapp --database=postgresql
...
$ echo $?
0
$ cd myapp
```

Fails to boot:

```
$ rails c
Could not find redis-4.8.1 in locally installed gems
```

### Expected behavior

After `rails new` returns a zero status code I expect that everything is installed correctly and that I can use it.

### Actual behavior

Rails fails to install the redis gem, but continues anyway

```
$ rails new myapp --database=postgresql
      create  
      create  README.md
      create  Rakefile
      create  .ruby-version
      create  config.ru
      create  .gitignore
      create  .gitattributes
      create  Gemfile
         run  git init from "".""
Initialized empty Git repository in /Users/rschneeman/Documents/projects/rundoc/test/fixtures/rails_7/tmp/myapp/.git/
      create  app
      create  app/assets/config/manifest.js
      create  app/assets/stylesheets/application.css
      create  app/channels/application_cable/channel.rb
      create  app/channels/application_cable/connection.rb
      create  app/controllers/application_controller.rb
      create  app/helpers/application_helper.rb
      create  app/jobs/application_job.rb
      create  app/mailers/application_mailer.rb
      create  app/models/application_record.rb
      create  app/views/layouts/application.html.erb
      create  app/views/layouts/mailer.html.erb
      create  app/views/layouts/mailer.text.erb
      create  app/assets/images
      create  app/assets/images/.keep
      create  app/controllers/concerns/.keep
      create  app/models/concerns/.keep
      create  bin
      create  bin/rails
      create  bin/rake
      create  bin/setup
      create  config
      create  config/routes.rb
      create  config/application.rb
      create  config/environment.rb
      create  config/cable.yml
      create  config/puma.rb
      create  config/storage.yml
      create  config/environments
      create  config/environments/development.rb
      create  config/environments/production.rb
      create  config/environments/test.rb
      create  config/initializers
      create  config/initializers/assets.rb
      create  config/initializers/content_security_policy.rb
      create  config/initializers/cors.rb
      create  config/initializers/filter_parameter_logging.rb
      create  config/initializers/inflections.rb
      create  config/initializers/new_framework_defaults_7_0.rb
      create  config/initializers/permissions_policy.rb
      create  config/locales
      create  config/locales/en.yml
      create  config/master.key
      append  .gitignore
      create  config/boot.rb
      create  config/database.yml
      create  db
      create  db/seeds.rb
      create  lib
      create  lib/tasks
      create  lib/tasks/.keep
      create  lib/assets
      create  lib/assets/.keep
      create  log
      create  log/.keep
      create  public
      create  public/404.html
      create  public/422.html
      create  public/500.html
      create  public/apple-touch-icon-precomposed.png
      create  public/apple-touch-icon.png
      create  public/favicon.ico
      create  public/robots.txt
      create  tmp
      create  tmp/.keep
      create  tmp/pids
      create  tmp/pids/.keep
      create  tmp/cache
      create  tmp/cache/assets
      create  vendor
      create  vendor/.keep
      create  test/fixtures/files
      create  test/fixtures/files/.keep
      create  test/controllers
      create  test/controllers/.keep
      create  test/mailers
      create  test/mailers/.keep
      create  test/models
      create  test/models/.keep
      create  test/helpers
      create  test/helpers/.keep
      create  test/integration
      create  test/integration/.keep
      create  test/channels/application_cable/connection_test.rb
      create  test/test_helper.rb
      create  test/system
      create  test/system/.keep
      create  test/application_system_test_case.rb
      create  storage
      create  storage/.keep
      create  tmp/storage
      create  tmp/storage/.keep
      remove  config/initializers/cors.rb
      remove  config/initializers/new_framework_defaults_7_0.rb
         run  bundle install
Fetching gem metadata from https://rubygems.org/...........
Resolving dependencies...
Using rake 13.0.6
Using concurrent-ruby 1.2.2
Using minitest 5.18.0
Using builder 3.2.4
Using racc 1.6.2
Using rack 2.2.7
Using websocket-extensions 0.1.5
Using marcel 1.0.2
Using mini_mime 1.1.2
Using public_suffix 5.0.1
Using bindex 0.8.1
Using bundler 2.4.13
Using erubi 1.12.0
Using crass 1.0.6
Using nio4r 2.5.9
Using date 3.3.3
Using timeout 0.3.2
Using msgpack 1.7.1
Using matrix 0.4.2
Using regexp_parser 2.8.0
Using io-console 0.6.0
Using method_source 1.0.0
Using thor 1.2.2
Using zeitwerk 2.6.8
Using pg 1.5.3
Using rexml 3.2.5
Using rubyzip 2.3.2
Using websocket 1.2.9
Using tzinfo 2.0.6
Using i18n 1.13.0
Using nokogiri 1.15.1 (x86_64-darwin)
Using rack-test 2.1.0
Using websocket-driver 0.7.5
Using sprockets 4.2.0
Using addressable 2.8.4
Using bootsnap 1.16.0
Using activesupport 7.0.4.3
Using puma 5.6.5
Using reline 0.3.4
Using globalid 1.1.0
Using activemodel 7.0.4.3
Using irb 1.6.4
Using activerecord 7.0.4.3
Using debug 1.8.0
Using net-protocol 0.2.1
Using activejob 7.0.4.3
Using selenium-webdriver 4.9.1
Using rails-dom-testing 2.0.3
Using loofah 2.21.3
Using xpath 3.2.0
Using webdrivers 5.2.0
Using rails-html-sanitizer 1.5.0
Using capybara 3.39.1
Using actionview 7.0.4.3
Using net-smtp 0.3.3
Using net-imap 0.3.4
Using net-pop 0.1.2
Using jbuilder 2.11.5
Using actionpack 7.0.4.3
Using mail 2.8.1
Using actioncable 7.0.4.3
Using activestorage 7.0.4.3
Using railties 7.0.4.3
Using sprockets-rails 3.4.2
Using actionmailer 7.0.4.3
Using actionmailbox 7.0.4.3
Using actiontext 7.0.4.3
Using importmap-rails 1.1.6
Using stimulus-rails 1.2.1
Using turbo-rails 1.4.0
Using web-console 4.2.0
Using rails 7.0.4.3
Bundle complete! 15 Gemfile dependencies, 72 gems now installed.
Use `bundle info [gemname]` to see where a bundled gem is installed.
         run  bundle binstubs bundler
       rails  importmap:install
Add Importmap include tags in application layout
      insert  app/views/layouts/application.html.erb
Create application.js module as entrypoint
      create  app/javascript/application.js
Use vendor/javascript for downloaded pins
      create  vendor/javascript
      create  vendor/javascript/.keep
Ensure JavaScript files are in the Sprocket manifest
      append  app/assets/config/manifest.js
Configure importmap paths in config/importmap.rb
      create  config/importmap.rb
Copying binstub
      create  bin/importmap
       rails  turbo:install stimulus:install
Import Turbo
      append  app/javascript/application.js
Pin Turbo
      append  config/importmap.rb
Enable redis in bundle
        gsub  Gemfile
         run  bundle install
/Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:290:in `raise_not_found!': Could not find gem 'redis (~> 4.0)' in locally installed gems. (Bundler::GemNotFound)

The source contains the following gems matching 'redis':
  * redis-5.0.5
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:343:in `block in prepare_dependencies'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:328:in `each'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:328:in `map'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:328:in `prepare_dependencies'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:53:in `setup_solver'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:28:in `start'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:554:in `start_resolution'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:289:in `resolve'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:507:in `materialize'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:197:in `specs'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:254:in `specs_for'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/runtime.rb:18:in `setup'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler.rb:162:in `setup'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/setup.rb:23:in `block in <top (required)>'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/ui/shell.rb:159:in `with_level'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/ui/shell.rb:111:in `silence'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/setup.rb:23:in `<top (required)>'
	from <internal:/Users/rschneeman/.rubies/ruby-3.1.4/lib/ruby/3.1.0/rubygems/core_ext/kernel_require.rb>:85:in `require'
	from <internal:/Users/rschneeman/.rubies/ruby-3.1.4/lib/ruby/3.1.0/rubygems/core_ext/kernel_require.rb>:85:in `require'
Switch development cable to use redis
        gsub  config/cable.yml
/Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:290:in `raise_not_found!': Could not find gem 'redis (~> 4.0)' in locally installed gems. (Bundler::GemNotFound)

The source contains the following gems matching 'redis':
  * redis-5.0.5
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:343:in `block in prepare_dependencies'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:328:in `each'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:328:in `map'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:328:in `prepare_dependencies'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:53:in `setup_solver'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/resolver.rb:28:in `start'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:554:in `start_resolution'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:289:in `resolve'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:507:in `materialize'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:197:in `specs'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/definition.rb:254:in `specs_for'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/runtime.rb:18:in `setup'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler.rb:162:in `setup'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/setup.rb:23:in `block in <top (required)>'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/ui/shell.rb:159:in `with_level'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/ui/shell.rb:111:in `silence'
	from /Users/rschneeman/.gem/ruby/3.1.4/gems/bundler-2.4.13/lib/bundler/setup.rb:23:in `<top (required)>'
	from <internal:/Users/rschneeman/.rubies/ruby-3.1.4/lib/ruby/3.1.0/rubygems/core_ext/kernel_require.rb>:85:in `require'
	from <internal:/Users/rschneeman/.rubies/ruby-3.1.4/lib/ruby/3.1.0/rubygems/core_ext/kernel_require.rb>:85:in `require'
$ echo $?
0
```

Slightly different (not sure why):

```
$ rails new myapp --database=postgresql
      create
      create  README.md
      create  Rakefile
      create  .ruby-version
      create  config.ru
      create  .gitignore
      create  .gitattributes
      create  Gemfile
         run  git init from "".""
Initialized empty Git repository in /private/tmp/myapp/.git/
      create  app
      create  app/assets/config/manifest.js
      create  app/assets/stylesheets/application.css
      create  app/channels/application_cable/channel.rb
      create  app/channels/application_cable/connection.rb
      create  app/controllers/application_controller.rb
      create  app/helpers/application_helper.rb
      create  app/jobs/application_job.rb
      create  app/mailers/application_mailer.rb
      create  app/models/application_record.rb
      create  app/views/layouts/application.html.erb
      create  app/views/layouts/mailer.html.erb
      create  app/views/layouts/mailer.text.erb
      create  app/assets/images
      create  app/assets/images/.keep
      create  app/controllers/concerns/.keep
      create  app/models/concerns/.keep
      create  bin
      create  bin/rails
      create  bin/rake
      create  bin/setup
      create  config
      create  config/routes.rb
      create  config/application.rb
      create  config/environment.rb
      create  config/cable.yml
      create  config/puma.rb
      create  config/storage.yml
      create  config/environments
      create  config/environments/development.rb
      create  config/environments/production.rb
      create  config/environments/test.rb
      create  config/initializers
      create  config/initializers/assets.rb
      create  config/initializers/content_security_policy.rb
      create  config/initializers/cors.rb
      create  config/initializers/filter_parameter_logging.rb
      create  config/initializers/inflections.rb
      create  config/initializers/new_framework_defaults_7_0.rb
      create  config/initializers/permissions_policy.rb
      create  config/locales
      create  config/locales/en.yml
      create  config/master.key
      append  .gitignore
      create  config/boot.rb
      create  config/database.yml
      create  db
      create  db/seeds.rb
      create  lib
      create  lib/tasks
      create  lib/tasks/.keep
      create  lib/assets
      create  lib/assets/.keep
      create  log
      create  log/.keep
      create  public
      create  public/404.html
      create  public/422.html
      create  public/500.html
      create  public/apple-touch-icon-precomposed.png
      create  public/apple-touch-icon.png
      create  public/favicon.ico
      create  public/robots.txt
      create  tmp
      create  tmp/.keep
      create  tmp/pids
      create  tmp/pids/.keep
      create  tmp/cache
      create  tmp/cache/assets
      create  vendor
      create  vendor/.keep
      create  test/fixtures/files
      create  test/fixtures/files/.keep
      create  test/controllers
      create  test/controllers/.keep
      create  test/mailers
      create  test/mailers/.keep
      create  test/models
      create  test/models/.keep
      create  test/helpers
      create  test/helpers/.keep
      create  test/integration
      create  test/integration/.keep
      create  test/channels/application_cable/connection_test.rb
      create  test/test_helper.rb
      create  test/system
      create  test/system/.keep
      create  test/application_system_test_case.rb
      create  storage
      create  storage/.keep
      create  tmp/storage
      create  tmp/storage/.keep
      remove  config/initializers/cors.rb
      remove  config/initializers/new_framework_defaults_7_0.rb
         run  bundle install
Fetching gem metadata from https://rubygems.org/...........
Resolving dependencies...
Using rake 13.0.6
Using minitest 5.18.0
Using builder 3.2.4
Using racc 1.6.2
Using crass 1.0.6
Using rack 2.2.7
Using nio4r 2.5.9
Using marcel 1.0.2
Using zeitwerk 2.6.8
Using mini_mime 1.1.2
Using bundler 2.4.13
Using rexml 3.2.5
Using concurrent-ruby 1.2.2
Using websocket 1.2.9
Using websocket-extensions 0.1.5
Using date 3.3.3
Using public_suffix 5.0.1
Using msgpack 1.7.1
Using regexp_parser 2.8.0
Using sprockets 4.2.0
Using method_source 1.0.0
Using thor 1.2.2
Using timeout 0.3.2
Using bindex 0.8.1
Using pg 1.5.3
Using matrix 0.4.2
Using rubyzip 2.3.2
Using erubi 1.12.0
Using selenium-webdriver 4.9.1
Using rack-test 2.1.0
Using puma 5.6.5
Using i18n 1.13.0
Using tzinfo 2.0.6
Using io-console 0.6.0
Using websocket-driver 0.7.5
Using addressable 2.8.4
Using bootsnap 1.16.0
Using net-protocol 0.2.1
Using nokogiri 1.15.1 (x86_64-darwin)
Using activesupport 7.0.4.3
Using reline 0.3.4
Using net-smtp 0.3.3
Using net-imap 0.3.4
Using irb 1.6.4
Using loofah 2.21.3
Using xpath 3.2.0
Using webdrivers 5.2.0
Using activemodel 7.0.4.3
Using rails-dom-testing 2.0.3
Using globalid 1.1.0
Using activerecord 7.0.4.3
Using debug 1.8.0
Using activejob 7.0.4.3
Using capybara 3.39.1
Using net-pop 0.1.2
Using rails-html-sanitizer 1.5.0
Using mail 2.8.1
Using actionview 7.0.4.3
Using actionpack 7.0.4.3
Using jbuilder 2.11.5
Using actioncable 7.0.4.3
Using activestorage 7.0.4.3
Using actionmailer 7.0.4.3
Using railties 7.0.4.3
Using actiontext 7.0.4.3
Using web-console 4.2.0
Using sprockets-rails 3.4.2
Using actionmailbox 7.0.4.3
Using importmap-rails 1.1.6
Using stimulus-rails 1.2.1
Using rails 7.0.4.3
Using turbo-rails 1.4.0
Bundle complete! 15 Gemfile dependencies, 72 gems now installed.
Use `bundle info [gemname]` to see where a bundled gem is installed.
         run  bundle binstubs bundler
       rails  importmap:install
Add Importmap include tags in application layout
      insert  app/views/layouts/application.html.erb
Create application.js module as entrypoint
      create  app/javascript/application.js
Use vendor/javascript for downloaded pins
      create  vendor/javascript
      create  vendor/javascript/.keep
Ensure JavaScript files are in the Sprocket manifest
      append  app/assets/config/manifest.js
Configure importmap paths in config/importmap.rb
      create  config/importmap.rb
Copying binstub
      create  bin/importmap
       rails  turbo:install stimulus:install
Import Turbo
      append  app/javascript/application.js
Pin Turbo
      append  config/importmap.rb
Enable redis in bundle
        gsub  Gemfile
         run  bundle install
Could not find gem 'redis (~> 4.0)' in locally installed gems.
Run `bundle install` to install missing gems.
Switch development cable to use redis
        gsub  config/cable.yml
Could not find gem 'redis (~> 4.0)' in locally installed gems.
Run `bundle install` to install missing gems.
$ echo $?
0
```

### System configuration
**Rails version**: 

```
$ rails -v
Rails 7.0.4.3
```

**Ruby version**:

```
$ ruby -v
ruby 3.1.4p223 (2023-03-30 revision 957bb7cb81) [x86_64-darwin22]
```","{'url': 'https://api.github.com/repos/rails/rails/issues/48278/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48278/timeline,,
https://api.github.com/repos/rails/rails/issues/48276,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48276/labels{/name},https://api.github.com/repos/rails/rails/issues/48276/comments,https://api.github.com/repos/rails/rails/issues/48276/events,https://github.com/rails/rails/issues/48276,1719870612,I_kwDNIULOZoMklA,48276,Inconsistency between route helpers and url_for expectation in nested routes for resources with the same namespace,"{'login': 'vzelenko', 'id': 8058697, 'node_id': 'MDQ6VXNlcjgwNTg2OTc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8058697?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/vzelenko', 'html_url': 'https://github.com/vzelenko', 'followers_url': 'https://api.github.com/users/vzelenko/followers', 'following_url': 'https://api.github.com/users/vzelenko/following{/other_user}', 'gists_url': 'https://api.github.com/users/vzelenko/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/vzelenko/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/vzelenko/subscriptions', 'organizations_url': 'https://api.github.com/users/vzelenko/orgs', 'repos_url': 'https://api.github.com/users/vzelenko/repos', 'events_url': 'https://api.github.com/users/vzelenko/events{/privacy}', 'received_events_url': 'https://api.github.com/users/vzelenko/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,7,2023-05-22T14:57:57Z,2023-09-11T17:34:38Z,,NONE,,,,"> I'm not sure if this is actually an issue with rails or my misunderstanding of it.  To demonstrate the problem I would have to build a small version of the full application, and I'm happy to do that if requested.
>
> If the rails core team agrees this to be an actual issue, I'd be happy to make a PR.

### Problem Description
I have a model (RealEstate::Deal) that has another model (RealEstate::Payment) associated to it via `has_many`.  They both are stored in directory `app/real_estate/***` and have corresponding controllers.

I use nested routes like this:

```ruby
# config/routes.rb
Rails.application.routes.draw do
  namespace :real_estate do
    resources :deals do
      resources :payments
    end
  end
end
```

In the form for entering payment I must generate the `url` myself:

```erb
<!-- app/views/real_estate/payments/_form.html.erb -->
<% 
  url = @payment.persisted? ? 
          real_estate_deal_payment_path(@deal, @payment) : 
          real_estate_deal_payemnts_path(@deal) 
%>
<%= form_for [@deal, @payment], url: url do %>
  <%# irrelevant code %>
<% end %>
```


### Expected behavior
<!-- Tell us what should happen -->
```ruby
# url_helper generated from the route definition (`namespace :real_estate { resources :deals { resources :payments } }`):
real_estate_deal_payments_path(@deal) || real_estate_deal_payment_path(@deal, @payment) 

# url_helper EXPECTED by `url_for(@deal) || url_for(@deal, @payment)` (more specifically, form_for([@deal, @payment]):
real_estate_deal_payments_path(@deal) || real_estate_deal_payment_path(@deal, @payment) 
```

That is, when the namespace is the same for both objects, only apply it once to the generated url helper.

### Actual behavior
<!-- Tell us what happens instead -->

```ruby
# url_helper generated from the route definition (`namespace :real_estate { resources :deals { resources :payments } }`)
real_estate_deal_payments_path(@deal) || real_estate_deal_payment_path(@deal, @payment) 

# url_helper EXPECTED by `url_for(@deal) || url_for(@deal, @payment)` (more specifically, form_for([@deal, @payment]):
real_estate_deal_real_estate_payments_path(@deal) || real_estate_deal_real_estate_payment_path(@deal, @payment) 
```

### System configuration
**Rails version**:
Rails 7.0.4.3
**Ruby version**:
ruby 2.7.8p225 (2023-03-30 revision 1f4d455848) [x86_64-darwin22]
","{'url': 'https://api.github.com/repos/rails/rails/issues/48276/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48276/timeline,,
https://api.github.com/repos/rails/rails/issues/48267,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48267/labels{/name},https://api.github.com/repos/rails/rails/issues/48267/comments,https://api.github.com/repos/rails/rails/issues/48267/events,https://github.com/rails/rails/pull/48267,1718385974,PR_kwDNIULOUPNPAA,48267,FIX correctly sort records with the in_batches method,"{'login': 'TakuyaKurimoto', 'id': 75765648, 'node_id': 'MDQ6VXNlcjc1NzY1NjQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/75765648?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/TakuyaKurimoto', 'html_url': 'https://github.com/TakuyaKurimoto', 'followers_url': 'https://api.github.com/users/TakuyaKurimoto/followers', 'following_url': 'https://api.github.com/users/TakuyaKurimoto/following{/other_user}', 'gists_url': 'https://api.github.com/users/TakuyaKurimoto/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/TakuyaKurimoto/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/TakuyaKurimoto/subscriptions', 'organizations_url': 'https://api.github.com/users/TakuyaKurimoto/orgs', 'repos_url': 'https://api.github.com/users/TakuyaKurimoto/repos', 'events_url': 'https://api.github.com/users/TakuyaKurimoto/events{/privacy}', 'received_events_url': 'https://api.github.com/users/TakuyaKurimoto/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,7,2023-05-21T06:17:51Z,2023-06-26T16:15:03Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48267', 'html_url': 'https://github.com/rails/rails/pull/48267', 'diff_url': 'https://github.com/rails/rails/pull/48267.diff', 'patch_url': 'https://github.com/rails/rails/pull/48267.patch', 'merged_at': None}","Fixed incorrect sorting using order keyword in in_batches method

<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->
Fix incorrect sorting using order keyword in in_batches method.

example (posts table has id as the primary key)
```
Post.in_batches(order: :desc, use_ranges: false).first.pluck(:id)
:actual => [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
:expected  => [11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
```

### Additional information
if use_ranges keyword is true, the sorting does not work either because of [this code](https://github.com/rails/rails/blob/55c3066da325703ff7a9524dbdc479b860db3970/activerecord/lib/active_record/relation/batches.rb#LL278), but I am not sure if this is the expected behavior.
### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48267/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48267/timeline,,
https://api.github.com/repos/rails/rails/issues/48263,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48263/labels{/name},https://api.github.com/repos/rails/rails/issues/48263/comments,https://api.github.com/repos/rails/rails/issues/48263/events,https://github.com/rails/rails/pull/48263,1718157178,PR_kwDNIULOUPCf7g,48263,Add down only and migrating helpers to migration,"{'login': 'goulvench', 'id': 419086, 'node_id': 'MDQ6VXNlcjQxOTA4Ng==', 'avatar_url': 'https://avatars.githubusercontent.com/u/419086?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/goulvench', 'html_url': 'https://github.com/goulvench', 'followers_url': 'https://api.github.com/users/goulvench/followers', 'following_url': 'https://api.github.com/users/goulvench/following{/other_user}', 'gists_url': 'https://api.github.com/users/goulvench/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/goulvench/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/goulvench/subscriptions', 'organizations_url': 'https://api.github.com/users/goulvench/orgs', 'repos_url': 'https://api.github.com/users/goulvench/repos', 'events_url': 'https://api.github.com/users/goulvench/events{/privacy}', 'received_events_url': 'https://api.github.com/users/goulvench/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-05-20T12:27:00Z,2023-07-19T09:30:29Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48263', 'html_url': 'https://github.com/rails/rails/pull/48263', 'diff_url': 'https://github.com/rails/rails/pull/48263.diff', 'patch_url': 'https://github.com/rails/rails/pull/48263.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

In migrations, the `up_only` helper and the `reverting?` predicate allow constraining operations in either direction. Adding `down_only` and `migrating?` allows defining blocks that need to run when reverting, or running one-liners when migrating without using double negatives. Plus, you no longer need to remember which ones exist and which ones don't.

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->
Fixes #48245 

### Detail

This Pull Request adds `down_only` and `migrating?`.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change.
* [x] Commit message has a detailed description of what changed and why.
* [x] Tests are added or updated if you fix a bug or add a feature. (Original methods are not tested)
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48263/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48263/timeline,,
https://api.github.com/repos/rails/rails/issues/48247,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48247/labels{/name},https://api.github.com/repos/rails/rails/issues/48247/comments,https://api.github.com/repos/rails/rails/issues/48247/events,https://github.com/rails/rails/pull/48247,1714159397,PR_kwDNIULOULqGGw,48247,Introduce Active Record config to enable database queries to be retried,"{'login': 'adrianna-chang-shopify', 'id': 22918438, 'node_id': 'MDQ6VXNlcjIyOTE4NDM4', 'avatar_url': 'https://avatars.githubusercontent.com/u/22918438?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/adrianna-chang-shopify', 'html_url': 'https://github.com/adrianna-chang-shopify', 'followers_url': 'https://api.github.com/users/adrianna-chang-shopify/followers', 'following_url': 'https://api.github.com/users/adrianna-chang-shopify/following{/other_user}', 'gists_url': 'https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/adrianna-chang-shopify/subscriptions', 'organizations_url': 'https://api.github.com/users/adrianna-chang-shopify/orgs', 'repos_url': 'https://api.github.com/users/adrianna-chang-shopify/repos', 'events_url': 'https://api.github.com/users/adrianna-chang-shopify/events{/privacy}', 'received_events_url': 'https://api.github.com/users/adrianna-chang-shopify/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,"{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,1,2023-05-17T15:26:51Z,2023-05-22T16:04:21Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48247', 'html_url': 'https://github.com/rails/rails/pull/48247', 'diff_url': 'https://github.com/rails/rails/pull/48247.diff', 'patch_url': 'https://github.com/rails/rails/pull/48247.patch', 'merged_at': None}","### Motivation / Background

Certain applications (e.g. Shopify, GitHub), retry all database queries and have been patching `#execute` / `#raw_execute` to change the `allow_retry` kwarg to true. This is brittle. Enabling retries globally should be an option for apps that are willing to accept the risks.

### Additional information

Wondering if it's safe to retry transaction-related db methods (e.g. `#commit_db_transaction`, `#exec_restart_db_transaction`). As it stands, Shopify's retry patch _will_ retry all of these queries, but our retry patch used to be transaction-aware. Should we stick to avoiding retries, even if the the application has configured retries globally, with these methods or are they fine to retry?

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

cc @eileencodes @rafaelfranca ","{'url': 'https://api.github.com/repos/rails/rails/issues/48247/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48247/timeline,,
https://api.github.com/repos/rails/rails/issues/48244,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48244/labels{/name},https://api.github.com/repos/rails/rails/issues/48244/comments,https://api.github.com/repos/rails/rails/issues/48244/events,https://github.com/rails/rails/pull/48244,1713601546,PR_kwDNIULOULLSxA,48244,Fix method name for `InsertAll#keys_including_timestamps`,"{'login': 'asberel', 'id': 110363331, 'node_id': 'U_kgDOBpQCww', 'avatar_url': 'https://avatars.githubusercontent.com/u/110363331?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/asberel', 'html_url': 'https://github.com/asberel', 'followers_url': 'https://api.github.com/users/asberel/followers', 'following_url': 'https://api.github.com/users/asberel/following{/other_user}', 'gists_url': 'https://api.github.com/users/asberel/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/asberel/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/asberel/subscriptions', 'organizations_url': 'https://api.github.com/users/asberel/orgs', 'repos_url': 'https://api.github.com/users/asberel/repos', 'events_url': 'https://api.github.com/users/asberel/events{/privacy}', 'received_events_url': 'https://api.github.com/users/asberel/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-05-17T10:32:51Z,2023-05-18T00:34:49Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48244', 'html_url': 'https://github.com/rails/rails/pull/48244', 'diff_url': 'https://github.com/rails/rails/pull/48244.diff', 'patch_url': 'https://github.com/rails/rails/pull/48244.patch', 'merged_at': None}","

### Motivation / Background

This is what the file said.

 `TODO: Consider renaming this method, as it only conditionally extends keys, not always`, 

so I changed the method name.




### Detail

Removed the `TODO:` and renamed it to the `append_if_exist_keys_including_timestamps`.



### Additional information



### Checklist

Before submitting the PR make sure the following are checked:

* [ ] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48244/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48244/timeline,,
https://api.github.com/repos/rails/rails/issues/48227,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48227/labels{/name},https://api.github.com/repos/rails/rails/issues/48227/comments,https://api.github.com/repos/rails/rails/issues/48227/events,https://github.com/rails/rails/issues/48227,1709789546,I_kwDNIULOZelRag,48227,Wrong query generated when merging unscoping scopes with eager_loaded associations,"{'login': 'pzac', 'id': 272278, 'node_id': 'MDQ6VXNlcjI3MjI3OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/272278?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pzac', 'html_url': 'https://github.com/pzac', 'followers_url': 'https://api.github.com/users/pzac/followers', 'following_url': 'https://api.github.com/users/pzac/following{/other_user}', 'gists_url': 'https://api.github.com/users/pzac/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pzac/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pzac/subscriptions', 'organizations_url': 'https://api.github.com/users/pzac/orgs', 'repos_url': 'https://api.github.com/users/pzac/repos', 'events_url': 'https://api.github.com/users/pzac/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pzac/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2023-05-15T10:24:54Z,2023-08-27T23:11:02Z,,NONE,,,,"Merging a scope that unscopes a default_scope also unscopes the conditions on eager_loaded associations with the same column name.

### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
    t.datetime :deleted_at
  end

  create_table :posts, force: true do |t|
    t.integer :user_id
    t.datetime :deleted_at
  end
end

class User < ActiveRecord::Base
  has_many :posts
end

class Post < ActiveRecord::Base
  belongs_to :user
  default_scope -> { where deleted_at: nil }
  scope :with_deleted, -> { unscope(where: :deleted_at) }
end

class BugTest < Minitest::Test
  def test_association_stuff
    active_user = User.create!
    former_user = User.create!(deleted_at: Time.new)

    active_user_post = Post.create!(user: active_user)
    active_user_deleted_post = Post.create!(user: active_user, deleted_at: Time.new)
    former_user_post = Post.create!(user: former_user)
    former_user_deleted_post = Post.create!(user: former_user, deleted_at: Time.new)

    assert_equal [active_user_post, former_user_post].to_set, Post.all.to_set # default_scope
    assert_equal [active_user, former_user].to_set, User.all.to_set

    assert_equal [active_user_post, former_user_post].to_set, Post.eager_load(:user).to_set
    assert_equal 4, Post.with_deleted.eager_load(:user).count


    # only current posts of active user
    assert_equal [active_user_post].to_set, Post.eager_load(:user).where(users: {deleted_at: nil}).to_set

    # all posts of active users - works
    assert_equal [active_user_post, active_user_deleted_post].to_set, Post.with_deleted.eager_load(:user).where(users: {deleted_at: nil}).to_set
    assert_equal [active_user_post, active_user_deleted_post].to_set, Post.unscope(where: :deleted_at).eager_load(:user).where(users: {deleted_at: nil}).to_set

    # with a left join - works
    assert_equal [active_user_post, active_user_deleted_post].to_set, Post.with_deleted.left_outer_joins(:user).merge(User.where(deleted_at: nil)).to_set

    # all posts of active users - doesn't work: removes the deleted_at condition from users
    assert_equal [active_user_post, active_user_deleted_post].to_set, Post.eager_load(:user).where(users: {deleted_at: nil}).merge(Post.with_deleted).to_set
    # all posts of active users - doesn't work: removes the deleted_at condition from users
    assert_equal [active_user_post, active_user_deleted_post].to_set, Post.eager_load(:user).where(users: {deleted_at: nil}).merge(Post.unscope(where: :deleted_at)).to_set
  end
end

```

### Expected behavior
It should generate this SQL
```sql
SELECT ""posts"".""id"" AS t0_r0, ""posts"".""user_id"" AS t0_r1, ""posts"".""deleted_at"" AS t0_r2, 
""users"".""id"" AS t1_r0, ""users"".""deleted_at"" AS t1_r1 
FROM ""posts"" LEFT OUTER JOIN ""users"" ON ""users"".""id"" = ""posts"".""user_id"" WHERE ""users"".""deleted_at"" IS NULL
```

### Actual behavior
But actually generates
```sql
SELECT ""posts"".""id"" AS t0_r0, ""posts"".""user_id"" AS t0_r1, ""posts"".""deleted_at"" AS t0_r2, 
""users"".""id"" AS t1_r0, ""users"".""deleted_at"" AS t1_r1 
FROM ""posts"" LEFT OUTER JOIN ""users"" ON ""users"".""id"" = ""posts"".""user_id""
```
### System configuration
**Rails version**: 7.0.4.3

**Ruby version**: 3.2.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/48227/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48227/timeline,,
https://api.github.com/repos/rails/rails/issues/48202,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48202/labels{/name},https://api.github.com/repos/rails/rails/issues/48202/comments,https://api.github.com/repos/rails/rails/issues/48202/events,https://github.com/rails/rails/pull/48202,1707181581,PR_kwDNIULOUF1Hog,48202,Add namelist rake task,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2023-05-12T08:19:42Z,2023-10-05T10:42:20Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48202', 'html_url': 'https://github.com/rails/rails/pull/48202', 'diff_url': 'https://github.com/rails/rails/pull/48202.diff', 'patch_url': 'https://github.com/rails/rails/pull/48202.patch', 'merged_at': None}","### Motivation / Background

We want a way to be able to audit the public API of Rails, and find things that are missing `:nodoc:`.

This was implemented in rails/sdoc#222, and we're pulling in the latest branch to use it here.

In the future we might want a way to diff this data in some way, for example to provide PRs with feedback that introduce new classes or methods for reviewers to quickly check.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48202/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48202/timeline,,
https://api.github.com/repos/rails/rails/issues/48201,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48201/labels{/name},https://api.github.com/repos/rails/rails/issues/48201/comments,https://api.github.com/repos/rails/rails/issues/48201/events,https://github.com/rails/rails/pull/48201,1707105531,PR_kwDNIULOUFxDBg,48201,Allow url_for to prioritize the current route on ambiguous recall.,"{'login': 'JoeDupuis', 'id': 1518299, 'node_id': 'MDQ6VXNlcjE1MTgyOTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1518299?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JoeDupuis', 'html_url': 'https://github.com/JoeDupuis', 'followers_url': 'https://api.github.com/users/JoeDupuis/followers', 'following_url': 'https://api.github.com/users/JoeDupuis/following{/other_user}', 'gists_url': 'https://api.github.com/users/JoeDupuis/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JoeDupuis/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JoeDupuis/subscriptions', 'organizations_url': 'https://api.github.com/users/JoeDupuis/orgs', 'repos_url': 'https://api.github.com/users/JoeDupuis/repos', 'events_url': 'https://api.github.com/users/JoeDupuis/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JoeDupuis/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2023-05-12T07:27:29Z,2023-06-10T01:38:59Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48201', 'html_url': 'https://github.com/rails/rails/pull/48201', 'diff_url': 'https://github.com/rails/rails/pull/48201.diff', 'patch_url': 'https://github.com/rails/rails/pull/48201.patch', 'merged_at': None}","

Fix #48013


If two routes end up with the same score when trying to recall the url from url_for, we currently pick the one with highest precedence (order of the route file).

This change bumps the current route (if matched) in front of the others.

The repro for the issue could help understand what this is trying to fix: https://gist.github.com/JoeDupuis/e0f18020c85a05d5188ee35485685387

### Motivation / Background

Fixes #48013

We are already trying to recall the current request with `url_for`, this helps recalling the correct route when there is multiple hit.

Currently, only the router knows which route is served. This adds the current route in the rack env allowing class further in the request to infer things from it.


### Detail

- I don't know if we should merge this. I could see it as confusing if someone is calling url_for in the context of a request vs outside of a request (test or mailer). But then again, [it's also confusing to users if we don't](https://github.com/rails/rails/issues/48013).


### Additional information

A bit of fun trivia. The current (7.0.4.2) guide for `ActionController::UrlFor` mention:


> This module requires the host class to implement env which needs to be Rack-compatible and request which is either an instance of ActionDispatch::Request **or an object that responds to the host, optional_port, protocol, and symbolized_path_parameter methods.**


Which led me to write an initial version of this where I was checking if the request object responds to `current_route` to make sure the code would still work if the request is not an `ActionDispatch::Request`.

Then I noticed while reading the same doc through the code that [this was changed](https://github.com/rails/rails/commit/d69501a3d60f07dc68578278041ed74682084c9a) and I was unnecessarily playing hard mode :man_facepalming: :laughing: 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48201/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48201/timeline,,
https://api.github.com/repos/rails/rails/issues/48189,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48189/labels{/name},https://api.github.com/repos/rails/rails/issues/48189/comments,https://api.github.com/repos/rails/rails/issues/48189/events,https://github.com/rails/rails/pull/48189,1705439324,PR_kwDNIULOUEXbIQ,48189,Support more direct upload services by customize HTTP method and respose type,"{'login': 'xiaohui-zhangxh', 'id': 674321, 'node_id': 'MDQ6VXNlcjY3NDMyMQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/674321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/xiaohui-zhangxh', 'html_url': 'https://github.com/xiaohui-zhangxh', 'followers_url': 'https://api.github.com/users/xiaohui-zhangxh/followers', 'following_url': 'https://api.github.com/users/xiaohui-zhangxh/following{/other_user}', 'gists_url': 'https://api.github.com/users/xiaohui-zhangxh/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/xiaohui-zhangxh/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/xiaohui-zhangxh/subscriptions', 'organizations_url': 'https://api.github.com/users/xiaohui-zhangxh/orgs', 'repos_url': 'https://api.github.com/users/xiaohui-zhangxh/repos', 'events_url': 'https://api.github.com/users/xiaohui-zhangxh/events{/privacy}', 'received_events_url': 'https://api.github.com/users/xiaohui-zhangxh/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2023-05-11T09:34:11Z,2023-05-11T09:34:16Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48189', 'html_url': 'https://github.com/rails/rails/pull/48189', 'diff_url': 'https://github.com/rails/rails/pull/48189.diff', 'patch_url': 'https://github.com/rails/rails/pull/48189.patch', 'merged_at': None}","### Motivation / Background

When building a new Service for ActiveStorage, we got two requirements:

1. We need to direct upload a file with `POST` method instead of `PUT`, and send credential(token), key(filename) and file(binary to upload) with `Content-Type:   multipart/form-data; boundary=<frontier>`, instead of sending them with headers.
2. We are creating a SaaS that make each Tenant has their own Cloud Service configuration, hence it's not possible to write all service configurations into `config/storage.yml`. For now, `ActiveStorage::Blob` has an anonymous validator to check `service_name` has to be declared in `ActiveStorage::Blob.services`, we can't disable this validator.

### Detail

**I think it's better to make them configurable like this:**

```ruby
# write my own service
module ActiveStorage
  class Service::QiniumService < Service

    # declare direct upload with HTTP POST method
    def http_method_for_direct_upload
      'POST'
    end

   # declare direct upload response type, ""text"" or ""json""
    def http_response_type_for_direct_upload
      'json'
    end

    # declare direct upload file as multipart/form-data, the value of ':file' is the form data key to file
    def form_data_for_direct_upload(key, expires_in:, content_type:, content_length:, checksum:, **)
      put_policy = Qinium::PutPolicy.new(config, key: key, expires_in: expires_in)
      put_policy.fsize_limit = content_length.to_i + 1000
      put_policy.mime_limit = content_type
      put_policy.detect_mime = 1
      put_policy.insert_only = 1
      {
        key: key,
        token: put_policy.to_token,
        ':file': 'file'
      }
    end
end
```

With above changes, `ActiveStorage::Service` can support all types of HTTP methods, send token to cloud service with HTTP header or form data.

**change `activestorage/app/models/active_storage/blob.rb` anonymous validator to named one:**

```ruby
  validate do
    if service_name_changed? && service_name.present?
      services.fetch(service_name) do
        errors.add(:service_name, :invalid)
      end
    end
  end
```

changes to 

```ruby
validate :validate_service_name_in_services, if: -> { service_name_changed? && service_name.present? }
private
    def validate_service_name_in_services
      services.fetch(service_name) do
        errors.add(:service_name, :invalid)
      end
    end
```

Now, we can write our own Module prepend to ActiveStorage::Blob, to override `validate_service_name_in_services`, such as:

```ruby
module ActiveStorageSaas::BlobModelMixin
  private
    def validate_service_name_in_services
      # dynamically define service name per TenantStorageService#id, later we can resolve tenant storage
      #   configuration by parsing TenantStorageService:1 to tenant_storage = TenantStorageService.find(1)
      #   tenant_storage.service_name => Real Storage Service Name
      #.  tenant_storage.service_options => options to make instance of Service
      /^TenantStorageService:\d+$/.match?(service_name) || super
    end
end

ActiveSupport.on_load(:active_storage_blob) do
  prepend ActiveStorageSaas::BlobModelMixin
end
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

- This is another PR #45442 that has the same requirement to customize HTTP Method
- This is my real project that is working on this PR : https://github.com/xiaohui-zhangxh/activestorage_qinium/blob/main/lib/active_storage/service/qinium_service.rb
- This is my real project that need to make our Tenants have their own storage configurations : https://github.com/xiaohui-zhangxh/activestorage_saas/blob/main/lib/active_storage/service/saas_service.rb
- A duplicate PR #45839 to fix tests errors

","{'url': 'https://api.github.com/repos/rails/rails/issues/48189/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48189/timeline,,
https://api.github.com/repos/rails/rails/issues/48181,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48181/labels{/name},https://api.github.com/repos/rails/rails/issues/48181/comments,https://api.github.com/repos/rails/rails/issues/48181/events,https://github.com/rails/rails/pull/48181,1702767579,PR_kwDNIULOUCH5oQ,48181,Raises an error if the credentials cannot be decrypted,"{'login': 'ajee10x', 'id': 93165947, 'node_id': 'U_kgDOBY2Zew', 'avatar_url': 'https://avatars.githubusercontent.com/u/93165947?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ajee10x', 'html_url': 'https://github.com/ajee10x', 'followers_url': 'https://api.github.com/users/ajee10x/followers', 'following_url': 'https://api.github.com/users/ajee10x/following{/other_user}', 'gists_url': 'https://api.github.com/users/ajee10x/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ajee10x/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ajee10x/subscriptions', 'organizations_url': 'https://api.github.com/users/ajee10x/orgs', 'repos_url': 'https://api.github.com/users/ajee10x/repos', 'events_url': 'https://api.github.com/users/ajee10x/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ajee10x/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-05-09T21:16:16Z,2023-05-21T21:49:24Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48181', 'html_url': 'https://github.com/rails/rails/pull/48181', 'diff_url': 'https://github.com/rails/rails/pull/48181.diff', 'patch_url': 'https://github.com/rails/rails/pull/48181.patch', 'merged_at': None}","I have added a new test case that raises an error if the credentials cannot be decrypted.

<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because [This test case aims to verify that an error is raised if the credentials cannot be decrypted. By adding this new test case, the codebase's testing coverage will be improved, which can help detect and fix potential issues and bugs.]

### Detail

This Pull Request changes [Raises an error if the credentials cannot be decrypted.]

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48181/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48181/timeline,,
https://api.github.com/repos/rails/rails/issues/48179,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48179/labels{/name},https://api.github.com/repos/rails/rails/issues/48179/comments,https://api.github.com/repos/rails/rails/issues/48179/events,https://github.com/rails/rails/pull/48179,1702374834,PR_kwDNIULOUByn_A,48179,Add `Object#isolated_copy`,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,2,2023-05-09T16:37:22Z,2023-05-10T18:03:32Z,,MEMBER,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48179', 'html_url': 'https://github.com/rails/rails/pull/48179', 'diff_url': 'https://github.com/rails/rails/pull/48179.diff', 'patch_url': 'https://github.com/rails/rails/pull/48179.patch', 'merged_at': None}","This adds `Object#isolated_copy` (as a private API) which performs a `deep_dup` unless the object is frozen or a non-anonymous module.  In which case, it simply returns `self`.


TODO:
- [ ] tests
- [ ] update `thread_mattr_accessor` docs

---

@byroot `Module#deep_dup` returning `self` may cause unexpected behavior (see #48178).  What do you think of replacing `Module#deep_dup` with `Module#isolated_copy`?  (In other words, restoring the original behavior of `Module#deep_dup`, and defining `Module#isolated_copy` with the specialized behavior instead.)
","{'url': 'https://api.github.com/repos/rails/rails/issues/48179/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48179/timeline,,
https://api.github.com/repos/rails/rails/issues/48139,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48139/labels{/name},https://api.github.com/repos/rails/rails/issues/48139/comments,https://api.github.com/repos/rails/rails/issues/48139/events,https://github.com/rails/rails/pull/48139,1697808530,PR_kwDNIULOT9-dnw,48139,Fix active record insert values of type cast and serialize,"{'login': 'OuYangJinTing', 'id': 33079237, 'node_id': 'MDQ6VXNlcjMzMDc5MjM3', 'avatar_url': 'https://avatars.githubusercontent.com/u/33079237?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/OuYangJinTing', 'html_url': 'https://github.com/OuYangJinTing', 'followers_url': 'https://api.github.com/users/OuYangJinTing/followers', 'following_url': 'https://api.github.com/users/OuYangJinTing/following{/other_user}', 'gists_url': 'https://api.github.com/users/OuYangJinTing/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/OuYangJinTing/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/OuYangJinTing/subscriptions', 'organizations_url': 'https://api.github.com/users/OuYangJinTing/orgs', 'repos_url': 'https://api.github.com/users/OuYangJinTing/repos', 'events_url': 'https://api.github.com/users/OuYangJinTing/events{/privacy}', 'received_events_url': 'https://api.github.com/users/OuYangJinTing/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-05-05T15:28:14Z,2023-05-12T03:34:22Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48139', 'html_url': 'https://github.com/rails/rails/pull/48139', 'diff_url': 'https://github.com/rails/rails/pull/48139.diff', 'patch_url': 'https://github.com/rails/rails/pull/48139.patch', 'merged_at': None}","### Motivation / Background

This is a problem that has existed since the introduction of [ActiveRecord::InsertAll](https://github.com/rails/rails/pull/35077/files#r260410047).
Initially, `ActiveRecord::InsertAll` used `ActiveRecord::Relation::QueryAttribute#value_for_database` to convert values. As the code evolved, it switched to using `ActiveModel::Type::XXX#serialize` to serialize values. 
This is inconsistent with how attributes are converted in `Model#save`, which uses `ActiveModel::Attribute::FromUser#value_for_database`. 
Therefore, in some cases, data created using `Model#insert` and `Model#create` may be inconsistent. This PR fixes this issue.

### Detail

- Fix value conversion of ActiveRecord::InsertAll::Builder#values_list

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

cc @boblail @tenderlove @kamipo 

_PS: English is not my native language; please excuse typing errors._","{'url': 'https://api.github.com/repos/rails/rails/issues/48139/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48139/timeline,,
https://api.github.com/repos/rails/rails/issues/48132,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48132/labels{/name},https://api.github.com/repos/rails/rails/issues/48132/comments,https://api.github.com/repos/rails/rails/issues/48132/events,https://github.com/rails/rails/pull/48132,1696610507,PR_kwDNIULOT89Vkg,48132,Postgresql improvements to create_schema and drop_schema ,"{'login': 'Adam-Stomski', 'id': 8878264, 'node_id': 'MDQ6VXNlcjg4NzgyNjQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8878264?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Adam-Stomski', 'html_url': 'https://github.com/Adam-Stomski', 'followers_url': 'https://api.github.com/users/Adam-Stomski/followers', 'following_url': 'https://api.github.com/users/Adam-Stomski/following{/other_user}', 'gists_url': 'https://api.github.com/users/Adam-Stomski/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Adam-Stomski/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Adam-Stomski/subscriptions', 'organizations_url': 'https://api.github.com/users/Adam-Stomski/orgs', 'repos_url': 'https://api.github.com/users/Adam-Stomski/repos', 'events_url': 'https://api.github.com/users/Adam-Stomski/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Adam-Stomski/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-05-04T19:55:09Z,2023-05-11T22:36:39Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48132', 'html_url': 'https://github.com/rails/rails/pull/48132', 'diff_url': 'https://github.com/rails/rails/pull/48132.diff', 'patch_url': 'https://github.com/rails/rails/pull/48132.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

We are working a lot with postgresql and schemas. I noticed that the ActiveRecord does not support many options for them. I want to enable possible options while maintaining similar behavior to `create_table` and `drop_table`

### Detail

- Added support of **IF NOT EXISTS** statement in `create_schema`
- Added support for `force: cascade` option in `create_schema` 
- **BREAKING CHANGE** Changed default behavior of `drop_schema`
  - no longer runs **CASCADE** by default
  - supports `force: :cascade` option, similar to `drop_table`
","{'url': 'https://api.github.com/repos/rails/rails/issues/48132/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48132/timeline,,
https://api.github.com/repos/rails/rails/issues/48130,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48130/labels{/name},https://api.github.com/repos/rails/rails/issues/48130/comments,https://api.github.com/repos/rails/rails/issues/48130/events,https://github.com/rails/rails/pull/48130,1696394730,PR_kwDNIULOT8xfRw,48130,Fix belongs to with has one association multiple savings,"{'login': 'briu', 'id': 3942920, 'node_id': 'MDQ6VXNlcjM5NDI5MjA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3942920?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/briu', 'html_url': 'https://github.com/briu', 'followers_url': 'https://api.github.com/users/briu/followers', 'following_url': 'https://api.github.com/users/briu/following{/other_user}', 'gists_url': 'https://api.github.com/users/briu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/briu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/briu/subscriptions', 'organizations_url': 'https://api.github.com/users/briu/orgs', 'repos_url': 'https://api.github.com/users/briu/repos', 'events_url': 'https://api.github.com/users/briu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/briu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,3,2023-05-04T17:19:08Z,2023-05-24T13:40:36Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48130', 'html_url': 'https://github.com/rails/rails/pull/48130', 'diff_url': 'https://github.com/rails/rails/pull/48130.diff', 'patch_url': 'https://github.com/rails/rails/pull/48130.patch', 'merged_at': None}","### Motivation / Background
""Fixes #[48077](https://github.com/rails/rails/issues/48077)""

copy of [PR](https://github.com/rails/rails/pull/48078) that was closed because of wrong rebase

### Detail

When object is saved with `belongs_to` association, that associated to object with `has_one` relation, object actually saved   twice. For example:
```
class Post < ActiveRecord::Base
  belongs_to :user
  belongs_to :poll

  after_commit :test_after_commit
  # after_save :test_after_commit saved_changes here are exists
  after_save :test_after_save

  attr_reader :after_save_counter

  def test_after_commit
    # saved_changes here are blank
    if saved_change_to_release_stage?(to: 'published')
      user.increment(:published_posts_count)
    end
  end

  def test_after_save
    # invokes twice
    @after_save_counter ||= 0
    @after_save_counter += 1
  end
end

class Poll < ActiveRecord::Base
  has_one :post
end

post = Post.new(
  user: user,
  title: 'yoyo',
  release_stage: 'published'
)

post.poll = Poll.new(multiple: true)

post.save
```

First poll object is saved, then AR try to save post from `save_has_one_association`, after that invokes `save` method second time and this second `save` call clears saved_changes.

I decided to add variable that show that object already saving and prevent second save from `save_has_one_association` callback 

","{'url': 'https://api.github.com/repos/rails/rails/issues/48130/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48130/timeline,,
https://api.github.com/repos/rails/rails/issues/48117,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48117/labels{/name},https://api.github.com/repos/rails/rails/issues/48117/comments,https://api.github.com/repos/rails/rails/issues/48117/events,https://github.com/rails/rails/pull/48117,1693695844,PR_kwDNIULOT6dbMg,48117,Support upsert in Postgres temp tables,"{'login': 'rschellhorn', 'id': 260602, 'node_id': 'MDQ6VXNlcjI2MDYwMg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/260602?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rschellhorn', 'html_url': 'https://github.com/rschellhorn', 'followers_url': 'https://api.github.com/users/rschellhorn/followers', 'following_url': 'https://api.github.com/users/rschellhorn/following{/other_user}', 'gists_url': 'https://api.github.com/users/rschellhorn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rschellhorn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rschellhorn/subscriptions', 'organizations_url': 'https://api.github.com/users/rschellhorn/orgs', 'repos_url': 'https://api.github.com/users/rschellhorn/repos', 'events_url': 'https://api.github.com/users/rschellhorn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rschellhorn/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,5,2023-05-03T09:19:29Z,2023-06-08T14:03:41Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48117', 'html_url': 'https://github.com/rails/rails/pull/48117', 'diff_url': 'https://github.com/rails/rails/pull/48117.diff', 'patch_url': 'https://github.com/rails/rails/pull/48117.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

### Detail

This Pull Request changes the Postgres database adapter. It allows me to create models that are backed by a temporary table and use them just like regular tables. Without this change e.g. `insert_all` and `upsert_all` are not possible.

### Test

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""activerecord"", path: './activerecord'
  gem ""pg""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""postgresql"", url: ""postgres://localhost/rails-issue"") rescue puts 'Please create a DB ""rails-issue"" yourself first'
ActiveRecord::Base.logger = Logger.new(STDOUT)

class Post < ActiveRecord::Base
  def self.with_temp_table(as:)
    transaction do
      connection.create_table(table_name, temporary: true, force: true, as: as)
      yield
    end
  end
end

class BugTest < Minitest::Test
  def test_upsert_in_temp_table

    # Create a model backed by a temp table. Prefill the table with some data from a query.
    Post.with_temp_table(as: ""select 1 as id, 'foo' as some_column"") do
      # Upserts require a unique constraint
      Post.connection.add_index(Post.table_name, :id, unique: true)

      assert_equal Post.new(id: 1, some_column: 'foo'), Post.sole

      # The following line fails on master with:
      #
      #   ActiveRecord::StatementInvalid: PG::SyntaxError: ERROR:  syntax error at or near "")""
      #   LINE 1: ...id"",""some_column"") VALUES (1, 'bar') ON CONFLICT () DO UPDAT...
      #
      # The temp table, including all indices, constraints, etc are not 'seen'
      # by Rails. The PostgreSQL adapter only considers stuff in the schemas
      # returned by current_schemas(false). The temporary namespace
      # 'pg_temp_xyz' is excluded.
      #
      # See https://www.postgresql.org/docs/15/functions-info.html
      #
      #   current_schemas ( include_implicit boolean )  name[]
      #
      #   Returns an array of the names of all schemas presently in the
      #   effective search path, in their priority order. (Items in the current
      #   search_path setting that do not correspond to existing, searchable
      #   schemas are omitted.) If the Boolean argument is true, then
      #   implicitly-searched system schemas such as pg_catalog are included in
      #   the result.
      #
      # If you include implicit tables, via current_schemas(true), the
      # temporary table is found, but that is also true for the other system
      # schemas that we don't want.
      #
      # Luckily Postgres provides a means to find the temp schema name via:
      #
      #   pg_my_temp_schema ()  oid
      #
      #   Returns the OID of the current session's temporary schema, or zero if
      #   it has none (because it has not created any temporary tables).
      #
      # If we add that to the search path, then temp tables work just like
      # regular tables.
      Post.upsert_all([{ id: 1, some_column: 'bar' }], unique_by: :id)

      assert_equal Post.new(id: 1, some_column: 'bar'), Post.sole
    end
  end
end
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48117/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48117/timeline,,
https://api.github.com/repos/rails/rails/issues/48114,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48114/labels{/name},https://api.github.com/repos/rails/rails/issues/48114/comments,https://api.github.com/repos/rails/rails/issues/48114/events,https://github.com/rails/rails/pull/48114,1692957556,PR_kwDNIULOT51ntA,48114,Add `:limit` to `validates_numericality_of`,"{'login': 'edaroit', 'id': 13070410, 'node_id': 'MDQ6VXNlcjEzMDcwNDEw', 'avatar_url': 'https://avatars.githubusercontent.com/u/13070410?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/edaroit', 'html_url': 'https://github.com/edaroit', 'followers_url': 'https://api.github.com/users/edaroit/followers', 'following_url': 'https://api.github.com/users/edaroit/following{/other_user}', 'gists_url': 'https://api.github.com/users/edaroit/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/edaroit/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/edaroit/subscriptions', 'organizations_url': 'https://api.github.com/users/edaroit/orgs', 'repos_url': 'https://api.github.com/users/edaroit/repos', 'events_url': 'https://api.github.com/users/edaroit/events{/privacy}', 'received_events_url': 'https://api.github.com/users/edaroit/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-05-02T19:09:43Z,2023-05-14T08:21:19Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48114', 'html_url': 'https://github.com/rails/rails/pull/48114', 'diff_url': 'https://github.com/rails/rails/pull/48114.diff', 'patch_url': 'https://github.com/rails/rails/pull/48114.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because Rails doesn't provide by default a way to validate if a number is within the database limit. That's problematic when one is trying to store an ID to another table without foreign key since one would need to manually add the logic for this validation, possibly using `validates_numericality_of` range.

```ruby
MAX_EIGHT_BYTES_SIGNED_NUMBER = 2**63 - 1
private_constant :MAX_EIGHT_BYTES_SIGNED_NUMBER

# It should store a valid database record; thus, it should not be negative and it can go up to the maximum value
# supported by the column, which is using the default bigint type size of 8 bytes.
VALID_ID_RANGE = (..MAX_EIGHT_BYTES_SIGNED_NUMBER)
private_constant :VALID_ID_RANGE

validates :model_id, numericality: { in: VALID_ID_RANGE }
```

### Detail

This Pull Request changes `ActiveRecord::Validations::NumericalityValidator` to support a new value for the `in:` option: `:limit`.

`:limit` will verify the column's SQL type metadata limit to create a range with it. If the value is a `virtual attribute`, an exception is raised. If the column doesn't have a `limit` value set, the validation will be ignored.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48114/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48114/timeline,,
https://api.github.com/repos/rails/rails/issues/48102,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48102/labels{/name},https://api.github.com/repos/rails/rails/issues/48102/comments,https://api.github.com/repos/rails/rails/issues/48102/events,https://github.com/rails/rails/pull/48102,1690898479,PR_kwDNIULOT4GS2Q,48102,Retry select prepared statements in postgres,"{'login': 'shayonj', 'id': 1100970, 'node_id': 'MDQ6VXNlcjExMDA5NzA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1100970?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shayonj', 'html_url': 'https://github.com/shayonj', 'followers_url': 'https://api.github.com/users/shayonj/followers', 'following_url': 'https://api.github.com/users/shayonj/following{/other_user}', 'gists_url': 'https://api.github.com/users/shayonj/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shayonj/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shayonj/subscriptions', 'organizations_url': 'https://api.github.com/users/shayonj/orgs', 'repos_url': 'https://api.github.com/users/shayonj/repos', 'events_url': 'https://api.github.com/users/shayonj/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shayonj/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-05-01T14:42:28Z,2023-05-17T18:58:53Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48102', 'html_url': 'https://github.com/rails/rails/pull/48102', 'diff_url': 'https://github.com/rails/rails/pull/48102.diff', 'patch_url': 'https://github.com/rails/rails/pull/48102.patch', 'merged_at': None}","### Motivation / Background

We have monkey patched ActiveRecord internally to perform query retry and connection retry to recover from failures automatically with Postgres. Part of that functionality is to retry the select statements. The support for `allow_retry` today doesn't not retry select statements in Postgres.


### Detail

This PR proposes that we retry prepared select statements for Postgres automatically by passing in `allow_retry: true` to `internal_exec_query` on `select` method inside `ActiveRecord::ConnectionAdapters::DatabaseStatements`.  Doing so allows Rails to automatically retry the select queries on connection disruption to Postgres database, in an even of a failover, crash or similar. Since it uses the existing work done on `allow_retry` the behavior should be consistent with what is supplied via `connection_retries`. Lastly,  `internal_exec_query` only accepts `allow_retry` as a method argument for the Postgres adapter currently.

This PR also ensures that we re-build the prepared statement in an even of a retry since the statement pool cache will be cleared when a **[`reconnect!`](https://github.com/rails/rails/blob/912096d4ce930b8e7e5d91e0c86bae2091fda0e4/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb#L1030)** is called 

### Additional information
Also, intentionally only making it work for Postgres. Happy to take a pass on MySQL and other adapters if it makes sense in separate PRs. 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48102/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48102/timeline,,
https://api.github.com/repos/rails/rails/issues/48077,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48077/labels{/name},https://api.github.com/repos/rails/rails/issues/48077/comments,https://api.github.com/repos/rails/rails/issues/48077/events,https://github.com/rails/rails/issues/48077,1686385518,I_kwDNIULOZIQzbg,48077,has_one associated object saved twice and clears saved_changes ,"{'login': 'briu', 'id': 3942920, 'node_id': 'MDQ6VXNlcjM5NDI5MjA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3942920?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/briu', 'html_url': 'https://github.com/briu', 'followers_url': 'https://api.github.com/users/briu/followers', 'following_url': 'https://api.github.com/users/briu/following{/other_user}', 'gists_url': 'https://api.github.com/users/briu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/briu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/briu/subscriptions', 'organizations_url': 'https://api.github.com/users/briu/orgs', 'repos_url': 'https://api.github.com/users/briu/repos', 'events_url': 'https://api.github.com/users/briu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/briu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-04-27T08:34:19Z,2023-06-03T14:52:50Z,,NONE,,,,"### Steps to reproduce
```
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users do |t|
    t.integer :published_posts_count, default: 0
    t.timestamps
  end

  create_table :posts do |t|
    t.integer :user_id
    t.integer :poll_id
    t.string :title
    t.string :status, default: 'unreleased'
    t.datetime :release_at
    t.timestamps
  end

  create_table :polls do |t|
    t.boolean :multiple
    t.timestamps
  end
end

class User < ActiveRecord::Base
  has_many :posts
end

class Post < ActiveRecord::Base
  belongs_to :user
  belongs_to :poll

  after_commit :test_after_commit
  # after_save :test_after_commit saved_changes here are exists
  after_save :test_after_save

  attr_reader :after_save_counter

  def test_after_commit
    # saved_changes here are blank
    if saved_change_to_status?(to: 'published')
      user.increment(:published_posts_count)
    end
  end

  def test_after_save
    # invokes twice when saved with belongs_to association
    @after_save_counter ||= 0
    @after_save_counter += 1
  end
end

class Poll < ActiveRecord::Base
  has_one :post
end

class BugTest < Minitest::Test
  def setup
    Post.destroy_all
    Poll.destroy_all
  end

  def test_creating_post_with_poll_and_poll_options
    user = User.create

    post = Post.new(
      user: user,
      title: 'yoyo',
      status: 'published'
    )

    post.poll = Poll.new(multiple: true)

    post.save

    # after_save invokes twice
    assert_equal 2, post.after_save_counter
    assert_equal 1, user.published_posts_count
  end

  def test_creating_post_with_poll_only
    user = User.create

    post = Post.new(user: user, title: 'yoyo', status: 'published')
    post.save

    # after_save invokes once as expected
    assert_equal 1, post.after_save_counter
    assert_equal 1, user.published_posts_count
  end
end
```

### Expected behavior
`post.saved_changes` are available in `after_commit` callback, also after_save callback invokes only once

### Actual behavior
`post.saved_changes` are blank in `after_commit` callback

### System configuration
**Rails version**: main branch

**Ruby version**:  `ruby 3.2.2 (2023-03-30 revision e51014f9c0) [arm64-darwin21]`
","{'url': 'https://api.github.com/repos/rails/rails/issues/48077/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48077/timeline,,
https://api.github.com/repos/rails/rails/issues/48073,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48073/labels{/name},https://api.github.com/repos/rails/rails/issues/48073/comments,https://api.github.com/repos/rails/rails/issues/48073/events,https://github.com/rails/rails/pull/48073,1685600755,PR_kwDNIULOTzsd6Q,48073,Add system tests screenshots rotation,"{'login': 'palkan', 'id': 1516722, 'node_id': 'MDQ6VXNlcjE1MTY3MjI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1516722?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/palkan', 'html_url': 'https://github.com/palkan', 'followers_url': 'https://api.github.com/users/palkan/followers', 'following_url': 'https://api.github.com/users/palkan/following{/other_user}', 'gists_url': 'https://api.github.com/users/palkan/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/palkan/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/palkan/subscriptions', 'organizations_url': 'https://api.github.com/users/palkan/orgs', 'repos_url': 'https://api.github.com/users/palkan/repos', 'events_url': 'https://api.github.com/users/palkan/events{/privacy}', 'received_events_url': 'https://api.github.com/users/palkan/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,7,2023-04-26T19:35:59Z,2023-04-27T18:39:03Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48073', 'html_url': 'https://github.com/rails/rails/pull/48073', 'diff_url': 'https://github.com/rails/rails/pull/48073.diff', 'patch_url': 'https://github.com/rails/rails/pull/48073.patch', 'merged_at': None}","### Motivation / Background

The `tmp/screenshots` (or `Capybara.save_path`) folder can grow pretty quickly, especially when you try to debug/profile/de-flaky system tests. The life a screenshot (or HTML snapshot) is short: we either check it right after the failure or don't pay attention to it at all. Thus, it makes sense to automatically clean up older screenshots to keep the folder's size under control and don't waste local disk space.

### Detail

This Pull Request introduces a new method, `ActionDispatch::SystemTesting.rotate_screenshots(ttl: Numeric)`, to trigger the rotation.

### Additional information

Current implementation is not automatic. The main reason why we can not invoke this method right on the module load (like we do with the `.start_application`) is that it relies on the `Capybara.save_path` value that may be configured after we loaded the system testing code.

I think, making this feature ON by default makes sense, and I see two ways to proceed:

1) Just add the `ActionDispatch::SystemTesting.rotate_screenshots` line to the generated `test_helper.rb` and encourage developers to update their existing applications to add this line.

2) Consider introducing a _before suite hook_ (as a separate feature, similar to RSpec's `config.before(:suite)`), and use it to handle screenshots rotation. Suggested API: `ActiveSupport::Testing.run_before_suite(&block)`. I think, we can put the execution of these hooks into the `testing/autorun` file (or, maybe, there is a better option?).

I like option 2, but that would require some amount of work/time. Probably, we can start with 1) for 7.1 and think about further improvements for the next release.

/cc @eileencodes 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48073/reactions', 'total_count': 5, '+1': 5, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48073/timeline,,
https://api.github.com/repos/rails/rails/issues/48072,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48072/labels{/name},https://api.github.com/repos/rails/rails/issues/48072/comments,https://api.github.com/repos/rails/rails/issues/48072/events,https://github.com/rails/rails/issues/48072,1685480928,I_kwDNIULOZHZl4A,48072,Cannot query string columns that use `serialize` using array of values,"{'login': 'evansalter', 'id': 10549733, 'node_id': 'MDQ6VXNlcjEwNTQ5NzMz', 'avatar_url': 'https://avatars.githubusercontent.com/u/10549733?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/evansalter', 'html_url': 'https://github.com/evansalter', 'followers_url': 'https://api.github.com/users/evansalter/followers', 'following_url': 'https://api.github.com/users/evansalter/following{/other_user}', 'gists_url': 'https://api.github.com/users/evansalter/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/evansalter/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/evansalter/subscriptions', 'organizations_url': 'https://api.github.com/users/evansalter/orgs', 'repos_url': 'https://api.github.com/users/evansalter/repos', 'events_url': 'https://api.github.com/users/evansalter/events{/privacy}', 'received_events_url': 'https://api.github.com/users/evansalter/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-26T18:02:47Z,2023-09-07T22:46:31Z,,NONE,,,,"### Steps to reproduce

- Create a table with a string column
- Add a serializer on the column that transforms the string value
- Try to query the model with multiple values (i.e. `Model.where(serialized_field: ['value1', 'value2'])`)

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""6.1.7.3""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string :user_id
  end
end

class Base64Coder
  def self.dump(value)
    return unless value
    Base64.encode64(value)
  end

  def self.load(value)
    return unless value
    Base64.decode64(value)
  end
end

class Post < ActiveRecord::Base
  serialize :user_id, Base64Coder
end

class BugTest < Minitest::Test
  p1 = Post.create!(user_id: '123')
  p2 = Post.create!(user_id: '456')

  def test_query_by_single_user_id
    assert_equal 1, Post.where(user_id: '123').count # Works - returns [p1]
  end

  def test_query_by_array_of_single_user_ids
    assert_equal 1, Post.where(user_id: ['123']).count, 1 # Works - returns [p1]
  end

  def test_query_by_array_of_user_ids
    assert_equal 2, Post.where(user_id: ['123', '456']).count # Doesn't work - returns []
  end

  def test_workaround
    assert_equal 2, Post.where(""user_id IN (?)"", ['123', '456'].map{|val| Base64.encode64(val)}).count # Works [p1, p2]
  end
end
```

### Expected behavior

`Post.where(user_id: ['123', '456'])` works (as it did in v6.0.6.1)

### Actual behavior

`Post.where(user_id: ['123', '456'])` returns an empty list.

If we look at the logs, we can see this is the query that is getting run:

```
 SELECT COUNT(*) FROM ""posts"" WHERE ""posts"".""user_id"" IN (?, ?)  [[""user_id"", ""TVRJego=\n""], [""user_id"", ""TkRVMgo=\n""]]
```

The issue is that the values are getting serialized twice before getting passed into the query:

```ruby
[15] pry(main)> user_id = '123'
=> ""123""
[16] pry(main)> Base64.encode64(user_id)
=> ""MTIz\n""
[17] pry(main)> Base64.encode64(""MTIz\n"")
=> ""TVRJego=\n""
```

### System configuration
**Rails version**: 6.1.7.3

**Ruby version**: 2.6
","{'url': 'https://api.github.com/repos/rails/rails/issues/48072/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48072/timeline,,
https://api.github.com/repos/rails/rails/issues/48064,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48064/labels{/name},https://api.github.com/repos/rails/rails/issues/48064/comments,https://api.github.com/repos/rails/rails/issues/48064/events,https://github.com/rails/rails/pull/48064,1683889760,PR_kwDNIULOTyRB9A,48064,Guides top navigation like Rails homepage,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,2,2023-04-25T21:19:49Z,2023-05-19T23:31:32Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48064', 'html_url': 'https://github.com/rails/rails/pull/48064', 'diff_url': 'https://github.com/rails/rails/pull/48064.diff', 'patch_url': 'https://github.com/rails/rails/pull/48064.patch', 'merged_at': None}","This makes the top navigation of guides more similar to the Rails homepage by using the same fonts, styling and logo as the Rails homepage.

The ""home"" and ""Contribute"" links in the secondary navigation are removed, as these are directly visible in the top navigation.

### Before
<img width=""880"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/234406068-0e42434f-295b-467b-9d53-160a7cdc35b3.png"">
<img width=""497"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/234406166-3e3e74cd-4a16-4718-ae88-12dbf2d34a29.png"">
<img width=""517"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/234406437-338b01d6-d359-4a1f-8892-0ba379a7fcb0.png"">

### After

<img width=""879"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/234405966-7233644d-8b32-412d-b6be-e39353c300e4.png"">
<img width=""515"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/234406308-7b3213e9-81e0-4d79-a09f-3c75c41ddc01.png"">
<img width=""518"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/234406371-6898b6ee-b49d-42a2-bdba-c1eea071eab6.png"">


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/48064/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48064/timeline,,
https://api.github.com/repos/rails/rails/issues/48057,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48057/labels{/name},https://api.github.com/repos/rails/rails/issues/48057/comments,https://api.github.com/repos/rails/rails/issues/48057/events,https://github.com/rails/rails/pull/48057,1682233786,PR_kwDNIULOTw32pw,48057,tmp:create creates the same dirs that tmp:clear removes,"{'login': 'jasonkarns', 'id': 119972, 'node_id': 'MDQ6VXNlcjExOTk3Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/119972?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jasonkarns', 'html_url': 'https://github.com/jasonkarns', 'followers_url': 'https://api.github.com/users/jasonkarns/followers', 'following_url': 'https://api.github.com/users/jasonkarns/following{/other_user}', 'gists_url': 'https://api.github.com/users/jasonkarns/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jasonkarns/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jasonkarns/subscriptions', 'organizations_url': 'https://api.github.com/users/jasonkarns/orgs', 'repos_url': 'https://api.github.com/users/jasonkarns/repos', 'events_url': 'https://api.github.com/users/jasonkarns/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jasonkarns/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-04-25T00:34:01Z,2023-04-27T19:44:56Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48057', 'html_url': 'https://github.com/rails/rails/pull/48057', 'diff_url': 'https://github.com/rails/rails/pull/48057.diff', 'patch_url': 'https://github.com/rails/rails/pull/48057.patch', 'merged_at': None}","After running tmp:clear, tmp:create should ensure the same folders that are cleared are created.

### Motivation / Background

This Pull Request has been created because the current tmp:clear and tmp:create tasks are opposites of each other, but do not currently affect the same directories. `tmp:clear` presently clears cache, sockets, screenshots and storage, but `tmp:create` only creates the directories for cache, sockets, and pids.

Thus there is some incongruency between `tmp:clear` and `tmp:create`. Running `tmp:create`, for instance, does not result in a `tmp/storage/` directory and thus any ActiveStorage tests must create the directory themselves.


### Detail

This Pull Request changes the `tmp:create` rake task to additional ensure screenshots and storage directories are created.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/48057/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48057/timeline,,
https://api.github.com/repos/rails/rails/issues/48041,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48041/labels{/name},https://api.github.com/repos/rails/rails/issues/48041/comments,https://api.github.com/repos/rails/rails/issues/48041/events,https://github.com/rails/rails/pull/48041,1680275577,PR_kwDNIULOTvNrMQ,48041,Bump karma and dependencies,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,4,2023-04-24T01:13:06Z,2023-04-27T21:39:07Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48041', 'html_url': 'https://github.com/rails/rails/pull/48041', 'diff_url': 'https://github.com/rails/rails/pull/48041.diff', 'patch_url': 'https://github.com/rails/rails/pull/48041.patch', 'merged_at': None}","My only question is how does the global `yarn.lock` file get updated?
https://github.com/rails/rails/blob/main/yarn.lock

There is also a problem with `karma-sauce-launcher` with 4.0.0 that we will want to avoid specifically:
https://github.com/karma-runner/karma-sauce-launcher/issues/190","{'url': 'https://api.github.com/repos/rails/rails/issues/48041/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48041/timeline,,
https://api.github.com/repos/rails/rails/issues/48032,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/48032/labels{/name},https://api.github.com/repos/rails/rails/issues/48032/comments,https://api.github.com/repos/rails/rails/issues/48032/events,https://github.com/rails/rails/pull/48032,1679965651,PR_kwDNIULOTu-m-g,48032,Improve SauceLabs connection handling for CI,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2023-04-23T10:22:34Z,2023-04-23T10:22:38Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/48032', 'html_url': 'https://github.com/rails/rails/pull/48032', 'diff_url': 'https://github.com/rails/rails/pull/48032.diff', 'patch_url': 'https://github.com/rails/rails/pull/48032.patch', 'merged_at': None}","When debugging the SauceLabs integration in my local CI environment, I discovered this option for connection logs.

Also, the example from the karma-sauce-launcher recommends adding this check for the environment variables: https://github.com/karma-runner/karma-sauce-launcher/blob/69dcb822a45d29e57297b0eda7af4123ae55aafd/examples/karma.conf-ci.js#L2-L5

Even though we hard code the SauceLabs connection info for CI, that doesn't guarantee it will always be there in the same place, or work.","{'url': 'https://api.github.com/repos/rails/rails/issues/48032/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/48032/timeline,,
https://api.github.com/repos/rails/rails/issues/47984,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47984/labels{/name},https://api.github.com/repos/rails/rails/issues/47984/comments,https://api.github.com/repos/rails/rails/issues/47984/events,https://github.com/rails/rails/pull/47984,1674509783,PR_kwDNIULOTqbPYA,47984,Active storage proxy setting filename,"{'login': 'neudabei', 'id': 4841167, 'node_id': 'MDQ6VXNlcjQ4NDExNjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4841167?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/neudabei', 'html_url': 'https://github.com/neudabei', 'followers_url': 'https://api.github.com/users/neudabei/followers', 'following_url': 'https://api.github.com/users/neudabei/following{/other_user}', 'gists_url': 'https://api.github.com/users/neudabei/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/neudabei/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/neudabei/subscriptions', 'organizations_url': 'https://api.github.com/users/neudabei/orgs', 'repos_url': 'https://api.github.com/users/neudabei/repos', 'events_url': 'https://api.github.com/users/neudabei/events{/privacy}', 'received_events_url': 'https://api.github.com/users/neudabei/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-04-19T09:16:06Z,2023-04-19T09:16:10Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47984', 'html_url': 'https://github.com/rails/rails/pull/47984', 'diff_url': 'https://github.com/rails/rails/pull/47984.diff', 'patch_url': 'https://github.com/rails/rails/pull/47984.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

The current version of the guides states that we can set proxying for ActiveStorage. However, it mentions that this is set in config/initializers/active_storage.rb

This file does not seem to exist, so I suggest that this config is set in one of the environment files. In the case of proxying it makes sense to set this in config/environments/production.rb.

Alternatively it could be set in config/application.rb

This Pull Request has been created because it fixes a small error in the ActiveStorage guides.

### Detail

This Pull Request changes `config/initializers/active_storage.rb` to `config/environments/production.rb` in https://edgeguides.rubyonrails.org/active_storage_overview.html#proxy-mode

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47984/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47984/timeline,,
https://api.github.com/repos/rails/rails/issues/47969,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47969/labels{/name},https://api.github.com/repos/rails/rails/issues/47969/comments,https://api.github.com/repos/rails/rails/issues/47969/events,https://github.com/rails/rails/pull/47969,1672161826,PR_kwDNIULOToeJQg,47969,Permit frozen models to be validated,"{'login': 'npezza93', 'id': 5059927, 'node_id': 'MDQ6VXNlcjUwNTk5Mjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5059927?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/npezza93', 'html_url': 'https://github.com/npezza93', 'followers_url': 'https://api.github.com/users/npezza93/followers', 'following_url': 'https://api.github.com/users/npezza93/following{/other_user}', 'gists_url': 'https://api.github.com/users/npezza93/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/npezza93/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/npezza93/subscriptions', 'organizations_url': 'https://api.github.com/users/npezza93/orgs', 'repos_url': 'https://api.github.com/users/npezza93/repos', 'events_url': 'https://api.github.com/users/npezza93/events{/privacy}', 'received_events_url': 'https://api.github.com/users/npezza93/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2023-04-18T00:40:01Z,2023-04-26T12:46:15Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47969', 'html_url': 'https://github.com/rails/rails/pull/47969', 'diff_url': 'https://github.com/rails/rails/pull/47969.diff', 'patch_url': 'https://github.com/rails/rails/pull/47969.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

Recently stumbled upon `composed_of` and started to use it to model a concept. One nice thing about it I noticed was i could isolate all logic related to that value object outside of a model, like for example validations. Take for example:

```ruby
class HourlyRate
  include ActiveModel::Validations

  attr_reader :rate

  validates :rate, numericality: { greater_than_or_equal_to: 0 }

  def initialize(rate)
    @rate = rate
  end
end

class Person < ApplicationRecord
  composed_of :hourly_rate, mapping: [%w[hourly_rate rate]]

  validates_associated :hourly_rate
end
```

With this setup you can validate existing people no problem, but if you change the hourly_rate you run into issues.

### Detail

When you set a value using `composed_of` the value is frozen (see: https://github.com/rails/rails/blob/main/activerecord/lib/active_record/aggregations.rb#L279). But when you try to validate the object is raises a `FrozenError: can't modify frozen Person`. This is due to it trying to set the `errors` instance variable and keeping track of `validation_context`. My $0.02 is that validating shouldn't be seen as altering an object so these changes retain existing public API while making validation possible on frozen object.

This is done by memoizing errors prior to freezing, and moving the validation context into a separate object that can be altered during validation and memoizing that object prior to freezing.

### Additional information

I did find a related issue that was a blast from the past https://github.com/rails/rails/issues/1513. It looks to have been closed on the belief that `composed_of` was on its way out which turned out to not be the case.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47969/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47969/timeline,,
https://api.github.com/repos/rails/rails/issues/47961,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47961/labels{/name},https://api.github.com/repos/rails/rails/issues/47961/comments,https://api.github.com/repos/rails/rails/issues/47961/events,https://github.com/rails/rails/pull/47961,1671099109,PR_kwDNIULOTnkj-Q,47961,Specify maximum compatible Ruby version for Rails 5,"{'login': 'chris-hewitt', 'id': 4896702, 'node_id': 'MDQ6VXNlcjQ4OTY3MDI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4896702?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/chris-hewitt', 'html_url': 'https://github.com/chris-hewitt', 'followers_url': 'https://api.github.com/users/chris-hewitt/followers', 'following_url': 'https://api.github.com/users/chris-hewitt/following{/other_user}', 'gists_url': 'https://api.github.com/users/chris-hewitt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/chris-hewitt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/chris-hewitt/subscriptions', 'organizations_url': 'https://api.github.com/users/chris-hewitt/orgs', 'repos_url': 'https://api.github.com/users/chris-hewitt/repos', 'events_url': 'https://api.github.com/users/chris-hewitt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/chris-hewitt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,5,2023-04-17T12:47:56Z,2023-05-18T10:46:57Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47961', 'html_url': 'https://github.com/rails/rails/pull/47961', 'diff_url': 'https://github.com/rails/rails/pull/47961.diff', 'patch_url': 'https://github.com/rails/rails/pull/47961.patch', 'merged_at': None}","This is important to note because the section goes on to say ""Upgrade to the latest Ruby you can first, and then upgrade Rails.""

### Checklist
Before submitting the PR make sure the following are checked:
- [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
- [x]  Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: [Fix #issue-number]","{'url': 'https://api.github.com/repos/rails/rails/issues/47961/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47961/timeline,,
https://api.github.com/repos/rails/rails/issues/47939,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47939/labels{/name},https://api.github.com/repos/rails/rails/issues/47939/comments,https://api.github.com/repos/rails/rails/issues/47939/events,https://github.com/rails/rails/pull/47939,1667222794,PR_kwDNIULOTkYogQ,47939,[Fix: 47938] self is undefined for actioncable,"{'login': 'sirwolfgang', 'id': 722517, 'node_id': 'MDQ6VXNlcjcyMjUxNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/722517?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sirwolfgang', 'html_url': 'https://github.com/sirwolfgang', 'followers_url': 'https://api.github.com/users/sirwolfgang/followers', 'following_url': 'https://api.github.com/users/sirwolfgang/following{/other_user}', 'gists_url': 'https://api.github.com/users/sirwolfgang/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sirwolfgang/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sirwolfgang/subscriptions', 'organizations_url': 'https://api.github.com/users/sirwolfgang/orgs', 'repos_url': 'https://api.github.com/users/sirwolfgang/repos', 'events_url': 'https://api.github.com/users/sirwolfgang/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sirwolfgang/received_events', 'type': 'User', 'site_admin': False}","[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-13T22:34:07Z,2023-05-19T08:28:23Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47939', 'html_url': 'https://github.com/rails/rails/pull/47939', 'diff_url': 'https://github.com/rails/rails/pull/47939.diff', 'patch_url': 'https://github.com/rails/rails/pull/47939.patch', 'merged_at': None}","### Motivation / Background
This Pull Request has been created because ActionCable is unable to build with SSR systems due to `self is undefined` errors, see #47938

### Detail
- replace `self` with `globalThis` and allow `logger` and `WebSocket` to be undefined rather than erroring

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47939/reactions', 'total_count': 5, '+1': 5, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47939/timeline,,
https://api.github.com/repos/rails/rails/issues/47938,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47938/labels{/name},https://api.github.com/repos/rails/rails/issues/47938/comments,https://api.github.com/repos/rails/rails/issues/47938/events,https://github.com/rails/rails/issues/47938,1667212960,I_kwDNIULOY1-moA,47938,Unable to use actioncable with SSR build systems [w/ PR],"{'login': 'sirwolfgang', 'id': 722517, 'node_id': 'MDQ6VXNlcjcyMjUxNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/722517?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sirwolfgang', 'html_url': 'https://github.com/sirwolfgang', 'followers_url': 'https://api.github.com/users/sirwolfgang/followers', 'following_url': 'https://api.github.com/users/sirwolfgang/following{/other_user}', 'gists_url': 'https://api.github.com/users/sirwolfgang/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sirwolfgang/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sirwolfgang/subscriptions', 'organizations_url': 'https://api.github.com/users/sirwolfgang/orgs', 'repos_url': 'https://api.github.com/users/sirwolfgang/repos', 'events_url': 'https://api.github.com/users/sirwolfgang/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sirwolfgang/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2023-04-13T22:25:26Z,2023-04-14T15:47:51Z,,NONE,,,,"### Steps to reproduce
1. Create an App in something like NextJS that has SSR
2. Create a file that uses ActionCable
  ```typescript
    import { createConsumer } from '@rails/actioncable'

    const cable = createConsumer()
  ````
3. build for errors
```bash
Error occurred prerendering page ""/accounts"". Read more: https://nextjs.org/docs/messages/prerender-error
ReferenceError: self is not defined
```

### Expected behavior
Should not blow up when being used in SSR environments.

### Actual behavior
Blows up when being built in SSR environments

### System configuration
**Rails version**: All
**Ruby version**: All

### Solution
h/t @zubairaziz
```javascript
// actioncable/adapters.ts
export default {
  logger: typeof globalThis !== 'undefined' ? globalThis.console : undefined,
  WebSocket: typeof globalThis !== 'undefined' ? globalThis.WebSocket : undefined,
}
```","{'url': 'https://api.github.com/repos/rails/rails/issues/47938/reactions', 'total_count': 4, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47938/timeline,,
https://api.github.com/repos/rails/rails/issues/47927,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47927/labels{/name},https://api.github.com/repos/rails/rails/issues/47927/comments,https://api.github.com/repos/rails/rails/issues/47927/events,https://github.com/rails/rails/pull/47927,1665136312,PR_kwDNIULOTioWfg,47927,Fix filtering params for encrypted attributes when using child models or nested parameters,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-04-12T19:40:24Z,2023-04-12T20:23:09Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47927', 'html_url': 'https://github.com/rails/rails/pull/47927', 'diff_url': 'https://github.com/rails/rails/pull/47927.diff', 'patch_url': 'https://github.com/rails/rails/pull/47927.patch', 'merged_at': None}","Fixes https://github.com/rails/rails/issues/47913 (see there for the problem description and investigation details).

cc @jorgemanrubia ","{'url': 'https://api.github.com/repos/rails/rails/issues/47927/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47927/timeline,,
https://api.github.com/repos/rails/rails/issues/47926,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47926/labels{/name},https://api.github.com/repos/rails/rails/issues/47926/comments,https://api.github.com/repos/rails/rails/issues/47926/events,https://github.com/rails/rails/pull/47926,1665112740,PR_kwDNIULOTinGVQ,47926,ignore (mrsk) deployment configuration,"{'login': 'ncreuschling', 'id': 637855, 'node_id': 'MDQ6VXNlcjYzNzg1NQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/637855?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ncreuschling', 'html_url': 'https://github.com/ncreuschling', 'followers_url': 'https://api.github.com/users/ncreuschling/followers', 'following_url': 'https://api.github.com/users/ncreuschling/following{/other_user}', 'gists_url': 'https://api.github.com/users/ncreuschling/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ncreuschling/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ncreuschling/subscriptions', 'organizations_url': 'https://api.github.com/users/ncreuschling/orgs', 'repos_url': 'https://api.github.com/users/ncreuschling/repos', 'events_url': 'https://api.github.com/users/ncreuschling/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ncreuschling/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-04-12T19:20:06Z,2023-05-13T01:53:23Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47926', 'html_url': 'https://github.com/rails/rails/pull/47926', 'diff_url': 'https://github.com/rails/rails/pull/47926.diff', 'patch_url': 'https://github.com/rails/rails/pull/47926.patch', 'merged_at': None}","### Summary

This pull request adds `/config/deploy.yml` to dockerignore template file.

### Motivation / Background

This aforementioned file is used by [mrsk](https://github.com/mrsked/mrsk).

It is sensible to ignore this file by default for several reasons:

- The file may contain sensitive information about the infrastructure setup.
- Changing this configuration file triggers an unnecessary container rebuild.

","{'url': 'https://api.github.com/repos/rails/rails/issues/47926/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47926/timeline,,
https://api.github.com/repos/rails/rails/issues/47913,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47913/labels{/name},https://api.github.com/repos/rails/rails/issues/47913/comments,https://api.github.com/repos/rails/rails/issues/47913/events,https://github.com/rails/rails/issues/47913,1661789164,I_kwDNIULOYwzj7A,47913,Automatic Filtering Params Named as Encrypted Columns does not filter params of child models or when params are nested,"{'login': 'annettemmm', 'id': 79126438, 'node_id': 'MDQ6VXNlcjc5MTI2NDM4', 'avatar_url': 'https://avatars.githubusercontent.com/u/79126438?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/annettemmm', 'html_url': 'https://github.com/annettemmm', 'followers_url': 'https://api.github.com/users/annettemmm/followers', 'following_url': 'https://api.github.com/users/annettemmm/following{/other_user}', 'gists_url': 'https://api.github.com/users/annettemmm/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/annettemmm/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/annettemmm/subscriptions', 'organizations_url': 'https://api.github.com/users/annettemmm/orgs', 'repos_url': 'https://api.github.com/users/annettemmm/repos', 'events_url': 'https://api.github.com/users/annettemmm/events{/privacy}', 'received_events_url': 'https://api.github.com/users/annettemmm/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-11T05:20:58Z,2023-04-12T21:01:47Z,,NONE,,,,"Found two unexpected behaviors w/r/t automatic filtering of encrypted columns. Encrypted columns are configured to be [automatically filtered in Rails logs](https://edgeguides.rubyonrails.org/action_controller_overview.html#parameters-filtering) BUT
1. models that inherit from a model with encrypted columns do not have the corresponding parameters filtered in the Rails logs
2. when a model with encrypted columns is passed as_nested_paramaters, the parameters are not filtered in the Rails logs

## Case 1: inheritance
### Steps to reproduce
```ruby
class User < ActiveRecord::Base
  encrypts(:email)
end

class SpecialUser < User
end
```
post with params: {email: 'secret@shh.com'} 

### Expected behavior
email value would be filtered out in logs for User & SpecialUser

### Actual behavior
params for User will get correctly filtered in the logs, e.g. `Parameters: {""user""=>{""email""=>""[FILTERED]""}}`
params for Special will not e.g. `Parameters: {""special_user""=>{""email""=>""secret@shh.com""}}`

## Case 2: nested parameters
```ruby
class User < ActiveRecord::Base
  encrypts(:email)

  belongs_to :organization
end

class Organization < ActiveRecord::Base
  has_one :user
  accepts_nested_attributes_for :user
end
```
post to organizations with params: {users_attributes: {new0: {email: 'secret@shh.com'}}}

### Expected behavior
email value would be filtered out in Rail logs

### Actual behavior
email not filtered out e.g. `Parameters: {""organization""=>{""user_attributes""=>{""email""=>""secret@shh.com""}}}`

### System configuration
**Rails version**: Rails 7.0.4.3

**Ruby version**: ruby 3.2.1 (2023-02-08 revision 31819e82c8) [arm64-darwin21]

## Why Issue?
To address issues, one can explicitly add `special_user.email` & `user_attributes.email` to filtered parameters, but it was definitely unexpected for me that nested attributes & child models were not being filtered in the logs. If this is the intended behavior I think there should at least be a warning in the docs.

## Why Happening?
Both behaviors stem from the how encrypts add the encrypted columns to `application.config.filter_parameters`:
https://github.com/rails/rails/blob/7c41d97ccbff2feb98544de784cabdc9714773f8/activerecord/lib/active_record/encryption/configurable.rb#L52-L58
in the example above, when User encrypts(:email), 'user.email' will be added to `application.config.filter_parameters` and so will not match & filter `{""special_user"" => {""email""=>""secret@shh.com""}}` or `{""user_attributes""=>{""email""=> ""secret@shh.com""}}`

### my chill-enough local fix
I was able to generate the behavior I wanted with
```ruby
class ApplicationRecord < ActiveRecord::Base
  self.abstract_class = true

  extend MyFilteredParams
end

module MyFilteredParams
  def encrypts(*names, **options)
    Rails.application.config.filter_parameters += names.map { |x| /^#{x}$/ }
    super
  end
end
```
super for MyFilteredParams.encrypts: https://github.com/rails/rails/blob/b96ddea5f0b4ff8ed6e9dfe4df62f7571b147b11/activerecord/lib/active_record/encryption/encryptable_record.rb#L45-L53

This adds '/^email$/' to filter parameters, not scoped to anything, so it would correctly filter logs `{""special_user"" => {""email""=>""[FILTERED]""}}` or `{""user_attributes""=>{""email""=> ""[FILTERED]""}}` 
BUT
it would also filter any attribute 'email' on any model. For my purposes that's chill because I'd rather over- than under-filter, but it's not a perfect solution. 
","{'url': 'https://api.github.com/repos/rails/rails/issues/47913/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47913/timeline,,
https://api.github.com/repos/rails/rails/issues/47900,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47900/labels{/name},https://api.github.com/repos/rails/rails/issues/47900/comments,https://api.github.com/repos/rails/rails/issues/47900/events,https://github.com/rails/rails/pull/47900,1659988354,PR_kwDNIULOTeS7RA,47900,Add `COPY .. TO` to read queries for PostgreSQL,"{'login': 'nickborromeo', 'id': 1518902, 'node_id': 'MDQ6VXNlcjE1MTg5MDI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1518902?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nickborromeo', 'html_url': 'https://github.com/nickborromeo', 'followers_url': 'https://api.github.com/users/nickborromeo/followers', 'following_url': 'https://api.github.com/users/nickborromeo/following{/other_user}', 'gists_url': 'https://api.github.com/users/nickborromeo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nickborromeo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nickborromeo/subscriptions', 'organizations_url': 'https://api.github.com/users/nickborromeo/orgs', 'repos_url': 'https://api.github.com/users/nickborromeo/repos', 'events_url': 'https://api.github.com/users/nickborromeo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nickborromeo/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-09T20:05:59Z,2023-05-16T21:32:44Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47900', 'html_url': 'https://github.com/rails/rails/pull/47900', 'diff_url': 'https://github.com/rails/rails/pull/47900.diff', 'patch_url': 'https://github.com/rails/rails/pull/47900.patch', 'merged_at': None}","### Motivation / Background

Fixes https://github.com/rails/rails/issues/47870

It was pointed out in the report that

> COPY moves data between PostgreSQL tables and standard file-system files. COPY TO copies the contents of a table to a file, while COPY FROM copies data from a file to a table (appending the data to whatever is in the table already). COPY TO can also copy the results of a SELECT query.

### Detail

Using COPY .. TO with a read only connection should not be a problem because we do not write to the database but only read the records that will be written somewhere else.

This change adds the regex `/copy.*to/i` to the list of read only markers for postgres. I decided to use a regex here so that we can also make sure that `COPY .. FROM` cannot be used with a read only connection.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* ~[ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.~
","{'url': 'https://api.github.com/repos/rails/rails/issues/47900/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47900/timeline,,
https://api.github.com/repos/rails/rails/issues/47897,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47897/labels{/name},https://api.github.com/repos/rails/rails/issues/47897/comments,https://api.github.com/repos/rails/rails/issues/47897/events,https://github.com/rails/rails/pull/47897,1659703321,PR_kwDNIULOTeF4KQ,47897,Extend `ActiveRecord::Core#strict_loading!` to accept a block,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-09T01:50:21Z,2023-09-26T21:27:17Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47897', 'html_url': 'https://github.com/rails/rails/pull/47897', 'diff_url': 'https://github.com/rails/rails/pull/47897.diff', 'patch_url': 'https://github.com/rails/rails/pull/47897.patch', 'merged_at': None}","### Motivation / Background

Once a record enables or disables strict loading, that change is permanent. By extending the `#strict_loading!` method to support a block, that change can be temporarily applied **only within the block**, then reverted.

### Detail

For parity, this commit also introduces a class-level `ActiveRecord::Core.strict_loading!` that configure `strict_loading_by_default` with the same support for a self-contained blocks:

Instance method:

```ruby
user = User.first
user.strict_loading! do
  user.comments # => raises ActiveRecord::StrictLoadingViolationError
end
user.comments   # => #<ActiveRecord::Associations::CollectionProxy>
```

Class method:

```ruby
User.strict_loading!(true) do
  user = User.first
  user.comments # => raises ActiveRecord::StrictLoadingViolationError
end
user = User.first
user.comments   # => #<ActiveRecord::Associations::CollectionProxy>
```

### Additional information

The newly introduced [Object#with](https://edgeapi.rubyonrails.org/classes/Object.html#method-i-with) would be perfect candidate for the self-contained configurations. Unfortunately:

1. Active Record classes define [ActiveRecord::QueryMethods#with](https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-with) for querying
2. Active Record instances store strict loading internally as instance variables

Without the `Object#with` abstraction, the implementation's setup and teardown is messy.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47897/reactions', 'total_count': 3, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 3, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47897/timeline,,
https://api.github.com/repos/rails/rails/issues/47895,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47895/labels{/name},https://api.github.com/repos/rails/rails/issues/47895/comments,https://api.github.com/repos/rails/rails/issues/47895/events,https://github.com/rails/rails/issues/47895,1659518770,I_kwDNIULOYuo_Mg,47895,"find_each have different behavior for different batch_size, with illegitimate has_one association","{'login': 'yskkin', 'id': 5965113, 'node_id': 'MDQ6VXNlcjU5NjUxMTM=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5965113?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/yskkin', 'html_url': 'https://github.com/yskkin', 'followers_url': 'https://api.github.com/users/yskkin/followers', 'following_url': 'https://api.github.com/users/yskkin/following{/other_user}', 'gists_url': 'https://api.github.com/users/yskkin/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/yskkin/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/yskkin/subscriptions', 'organizations_url': 'https://api.github.com/users/yskkin/orgs', 'repos_url': 'https://api.github.com/users/yskkin/repos', 'events_url': 'https://api.github.com/users/yskkin/events{/privacy}', 'received_events_url': 'https://api.github.com/users/yskkin/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-08T13:07:39Z,2023-08-04T21:11:41Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
  end

  create_table :post_comments, force: true do |t|
    t.integer :post_id
    t.integer :comment_id
  end
end

class Post < ActiveRecord::Base
  has_one :post_comment, dependent: :destroy
  has_one :comment, through: :post_comment
end

class PostComment < ActiveRecord::Base
  belongs_to :post, dependent: :destroy
  belongs_to :comment, dependent: :destroy
end

class Comment < ActiveRecord::Base
  has_many :post_comments
  has_many :post, through: :post_comments
end

class BugTest < Minitest::Test
  def setup
    bad_post = Post.create!
    comment = Comment.create!
    # bad_post has inlegitimate has_one association with post_comment and comment
    2.times { PostComment.create!(post: bad_post, comment: comment) }

    3.times do
      post = Post.create!
      comment = Comment.create!
      PostComment.create!(post: post, comment: comment)
    end
  end

  def teardown
    Post.destroy_all
  end

  def test_post_find_each_l000_ok
    assert_equal 4, Post.includes({ post_comment: :post }, :comment).where(comments: { id: 1.. }).find_each.to_a.count
  end

  def test_post_find_each_2_ng
    assert_equal 4, Post.includes({ post_comment: :post }, :comment).where(comments: { id: 1.. }).find_each(batch_size: 2).to_a.count
  end
end

```

### Expected behavior
<!-- Tell us what should happen -->
Both test case pass or fail.

I'm not sure this is a bug or not since there is multiple records in the database for has_one association.
This is hard to notice since things work fine when record volume is small with respect to batch_size.
Some mechanism like warning is desirable even if this is not a bug.

### Actual behavior
<!-- Tell us what happens instead -->
Only `test_post_find_each_l000_ok` pass.

### System configuration
**Rails version**:

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/47895/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47895/timeline,,
https://api.github.com/repos/rails/rails/issues/47894,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47894/labels{/name},https://api.github.com/repos/rails/rails/issues/47894/comments,https://api.github.com/repos/rails/rails/issues/47894/events,https://github.com/rails/rails/pull/47894,1659490198,PR_kwDNIULOTd8zxw,47894,Add `pluck_each` and `pluck_in_batches` batching methods,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-04-08T11:12:06Z,2023-05-16T11:14:32Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47894', 'html_url': 'https://github.com/rails/rails/pull/47894', 'diff_url': 'https://github.com/rails/rails/pull/47894.diff', 'patch_url': 'https://github.com/rails/rails/pull/47894.patch', 'merged_at': None}","Example:
```ruby
Person.pluck_in_batches(:name, :email) do |batch|
  jobs = batch.map { |name, email| PartyReminderJob.new(name, email) }
  ActiveJob.perform_all_later(jobs)
end

Person.pluck_each(:email) do |email|
  PartyMailer.with(email: email).welcome_email.deliver_later
end
```

Plucking in batches is a very popular feature I saw many projects reimplement themselves to gain some performance.
I saw this in 2 my previous projects, in OSS projects (was able to find in [mastodon](https://github.com/mastodon/mastodon/blob/main/lib/active_record/batches.rb)), a few popular [gems](https://rubygems.org/search?query=pluck).

## Benchmarks

Tested on a table with 50M records. 
Compared to the recently introduced [optimization](https://github.com/rails/rails/pull/45414) for range batching.

```sql
CREATE TABLE users (id bigserial PRIMARY KEY, val integer);
INSERT INTO users (val) SELECT floor(random() * 30 + 1)::int FROM generate_series(1, 50000000) AS i;
ANALYZE users;
```

### Whole table batching

Using ranges:
```ruby
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
User.in_batches(use_ranges: true) do |batch|
  batch.pluck(:id, :val)
end

elapsed = Process.clock_gettime(Process::CLOCK_MONOTONIC) - start
puts ""Elapsed: #{elapsed}s""
```

`Elapsed: 209.20533800008707s`

Plucking in batches:
```ruby
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
User.pluck_in_batches(:id, :val) { }
elapsed = Process.clock_gettime(Process::CLOCK_MONOTONIC) - start
puts ""Elapsed: #{elapsed}s""
```

`Elapsed: 113.7704949999461s`  

### Batching with conditions

Using ranges:
```ruby
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
User.where(""val = 21"").in_batches(use_ranges: true) do |batch|
  batch.pluck(:id, :val)
end
elapsed = Process.clock_gettime(Process::CLOCK_MONOTONIC) - start
puts ""Elapsed: #{elapsed}s""
```

`Elapsed: 28.136486999923363s`

No ranges:
```ruby
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
User.where(""val = 21"").in_batches do |batch|
  batch.pluck(:id, :val)
end
elapsed = Process.clock_gettime(Process::CLOCK_MONOTONIC) - start
puts ""Elapsed: #{elapsed}s""
```

`Elapsed: 39.96518399997149s`

Plucking in batches:
```ruby
start = Process.clock_gettime(Process::CLOCK_MONOTONIC)
User.where(""val = 21"").pluck_in_batches(:id, :val) do |batch|
end
elapsed = Process.clock_gettime(Process::CLOCK_MONOTONIC) - start
puts ""Elapsed: #{elapsed}s""
```

`Elapsed: 16.415813000057824s`  

These numbers are for the db on my local machine. The improvement will be much larger in production due to simpler queries and SQL queries reduction by half.

Also, implementing this feature would make https://github.com/rails/rails/pull/47466 unneeded.

The logic in `pluck_in_batches` looks similar to `in_batches`, but trying to dry it (extracting similar logic into helper methods or trying to reuse `pluck_in_batches` inside `in_batches`) will make the code more complex and less understandable.

cc @nvasilevski (as we discussed it in https://discuss.rubyonrails.org/t/yield-record-ids-to-in-batches-block/81102) ","{'url': 'https://api.github.com/repos/rails/rails/issues/47894/reactions', 'total_count': 12, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 2, 'confused': 0, 'heart': 3, 'rocket': 2, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/47894/timeline,,
https://api.github.com/repos/rails/rails/issues/47882,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47882/labels{/name},https://api.github.com/repos/rails/rails/issues/47882/comments,https://api.github.com/repos/rails/rails/issues/47882/events,https://github.com/rails/rails/issues/47882,1658188739,I_kwDNIULOYtXzww,47882,"""Run pending migrations"" button does not respect multiple migration paths","{'login': 'aedwardg', 'id': 44326005, 'node_id': 'MDQ6VXNlcjQ0MzI2MDA1', 'avatar_url': 'https://avatars.githubusercontent.com/u/44326005?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/aedwardg', 'html_url': 'https://github.com/aedwardg', 'followers_url': 'https://api.github.com/users/aedwardg/followers', 'following_url': 'https://api.github.com/users/aedwardg/following{/other_user}', 'gists_url': 'https://api.github.com/users/aedwardg/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/aedwardg/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/aedwardg/subscriptions', 'organizations_url': 'https://api.github.com/users/aedwardg/orgs', 'repos_url': 'https://api.github.com/users/aedwardg/repos', 'events_url': 'https://api.github.com/users/aedwardg/events{/privacy}', 'received_events_url': 'https://api.github.com/users/aedwardg/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-07T00:09:35Z,2023-07-08T18:29:26Z,,NONE,,,,"The ActionableError page to run pending migrations does not respect multiple migration paths that are otherwise respected by `bin/rails db:migrate`. 

We first became aware of this at my company because we use [packwerk](https://github.com/Shopify/packwerk) and [packs-rails](https://github.com/rubyatscale/packs-rails) to help modularize our Rails monolith app. When breaking the app apart into packs, it helps to have migrations live in the same pack as the models that they represent. We used the suggestions in [this issue](https://github.com/rubyatscale/packs-rails/issues/25) to dynamically add all the packs' migration paths to the application config. 

The `bin/rails db:migrate` command respects the application config changes, but the <kbd>Run pending migrations</kbd> button does not. 

This lack of feature parity between the CLI command and the UI button is confusing for developers and can lead to teams having different development environments depending on whether they ran the command or clicked the button.

I'd be happy to work on a PR to fix this  

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
1. Create new app
2. Create migration, e.g., generate a model with `bin/rails generate model Article title:string body:text`
3. Create a subdirectory where you would like other migrations to live, e.g., `packs/stories/db/migrate`
4. Create another migration and move it to that subdir. e.g., `bin/rails generate model Longform title:string body:text`
     and move xxxxx_create_longforms.rb from `db/migrate` -> `packs/stories/db/migrate`
5. Inside of your `Application` class in `config/application.rb` add the following line:
    ```rb
     config.paths[""db/migrate""] << ""packs/stories/db/migrate""
    ```
7. Check your migration status: `bin/rails db:migrate:status`
  a. See that you have 2 pending migrations
    ![Screenshot 2023-04-07 at 11 07 55 AM](https://user-images.githubusercontent.com/44326005/230656787-e6983592-e102-4e17-bd6a-0e574f3b84df.png)
8. Start Rails server and go to http://127.0.0.1:3000
  a. See that the ActionableError only tells you about one of your migrations
    ![Screenshot 2023-04-06 at 4 45 20 PM](https://user-images.githubusercontent.com/44326005/230513437-192e0009-8b20-4937-afa4-c5f003ea3484.png)
9. Run migrations with `bin/rails db:migrate`
  a. See that BOTH migrations are run
10. Rollback the migrations: `STEP=2 bin/rails db:rollback`
11. Restart Rails server and run migrations from the <kbd>Run pending migrations</kbd> button in the browser
  a. See that only the one migration in `db/migrate` gets run 


### Expected behavior
<!-- Tell us what should happen -->
- The actionable error page should list _all_ pending migrations that `bin/rails db:migrate:status` lists
- Clicking the <kbd>Run pending migrations</kbd> button should run all migrations that `bin/rails db:migrate` does

### Actual behavior
<!-- Tell us what happens instead -->
- The actionable error page only lists migrations under the top-level `db/migrate` directory, no matter how the application is configured.
- Clicking the <kbd>Run pending migrations</kbd> button only runs migrations located in top-level `db/migrate` directory

### System configuration
**Rails version**: 6.x, 7.x, `main` branch

**Ruby version**: 3.1.2, 3.2.0, 3.2.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/47882/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47882/timeline,,
https://api.github.com/repos/rails/rails/issues/47874,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47874/labels{/name},https://api.github.com/repos/rails/rails/issues/47874/comments,https://api.github.com/repos/rails/rails/issues/47874/events,https://github.com/rails/rails/pull/47874,1656462286,PR_kwDNIULOTbh8WQ,47874, Add `trim_empty_fractional` to `ActiveSupport::NumberHelper.number_to_currency`,"{'login': 'danielvdao', 'id': 6646409, 'node_id': 'MDQ6VXNlcjY2NDY0MDk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6646409?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/danielvdao', 'html_url': 'https://github.com/danielvdao', 'followers_url': 'https://api.github.com/users/danielvdao/followers', 'following_url': 'https://api.github.com/users/danielvdao/following{/other_user}', 'gists_url': 'https://api.github.com/users/danielvdao/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/danielvdao/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/danielvdao/subscriptions', 'organizations_url': 'https://api.github.com/users/danielvdao/orgs', 'repos_url': 'https://api.github.com/users/danielvdao/repos', 'events_url': 'https://api.github.com/users/danielvdao/events{/privacy}', 'received_events_url': 'https://api.github.com/users/danielvdao/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,8,2023-04-05T23:54:29Z,2023-05-05T22:34:08Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47874', 'html_url': 'https://github.com/rails/rails/pull/47874', 'diff_url': 'https://github.com/rails/rails/pull/47874.diff', 'patch_url': 'https://github.com/rails/rails/pull/47874.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

If I am wrong or this should be closed, please correct or let me know.

One issue that I've found when working with `ActiveSupport::NumberHelper.number_to_currency` was that it lacks support for truncating whole numbers.

Here's an example of what I think could be useful:

```
$30.05 => $30.05
$30.10 => $30.10
$30.00 => $30 # Doesn't exist today
```

I looked on Stackoverflow [here](https://stackoverflow.com/questions/11661592/rails-number-to-currency-delete-trailing-zeros) and the best answer came from supporting precision based on `round`. I'm not a big fan of that because under the hood, rounding is already done for `number_to_currency`, if anything, we should allow for whole number truncation.

**Note** I can also add a `CHANGELOG` if we think this is a viable path forward  

### Detail

This Pull Request changes how `number_to_currency` works and adds a new parameter `strip_final_zeros`. I'd gladly accept feedback, parameter rename, and more tests if needed.

### Additional information

An alternative solution can be found in StackOverflow link above, but essentially: [here](https://stackoverflow.com/a/11661630/3788419).

```ruby
num = 30.00
number_to_currency(num, :precision => (num.round == num) ? 0 : 2)
  => $30

num = 30.05
number_to_currency(num, :precision => (num.round == num) ? 0 : 2)
  => $30.05
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47874/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47874/timeline,,
https://api.github.com/repos/rails/rails/issues/47870,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47870/labels{/name},https://api.github.com/repos/rails/rails/issues/47870/comments,https://api.github.com/repos/rails/rails/issues/47870/events,https://github.com/rails/rails/issues/47870,1655923604,I_kwDNIULOYrNjlA,47870,COPY ... TO cannot be executed on a readonly database connection (postgresql),"{'login': 'kholbekj', 'id': 2786571, 'node_id': 'MDQ6VXNlcjI3ODY1NzE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2786571?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kholbekj', 'html_url': 'https://github.com/kholbekj', 'followers_url': 'https://api.github.com/users/kholbekj/followers', 'following_url': 'https://api.github.com/users/kholbekj/following{/other_user}', 'gists_url': 'https://api.github.com/users/kholbekj/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kholbekj/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kholbekj/subscriptions', 'organizations_url': 'https://api.github.com/users/kholbekj/orgs', 'repos_url': 'https://api.github.com/users/kholbekj/repos', 'events_url': 'https://api.github.com/users/kholbekj/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kholbekj/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}]",open,False,,[],,3,2023-04-05T16:11:29Z,2023-04-21T18:20:36Z,,NONE,,,,"### Steps to reproduce
```
ActiveRecord::Base.connected_to(role: :reading) { ActiveRecord::Base.connection.execute('COPY (SELECT id FROM users WHERE id = 1) TO example.csv WITH CSV HEADER') }
#=> ActiveRecord::ReadOnlyError: Write query attempted while in readonly mode:
```

I guess the issue is that the regex simply considers COPY statements not read. But while COPY .. FROM _is_ a write query, COPY .. TO is not. It writes to a file in the filesystem, but only reads from the DB.

### Expected behavior
No error should be raised, the query should run.

### Actual behavior
`ActiveRecord::ReadOnlyError: Write query attempted while in readonly mode:` is raised

### System configuration
**Rails version**: 6.1.6.1 (but as far as I can tell the regex for rails 7 has the same issue)

**Ruby version**: 3.0.4p208
","{'url': 'https://api.github.com/repos/rails/rails/issues/47870/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47870/timeline,,
https://api.github.com/repos/rails/rails/issues/47861,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47861/labels{/name},https://api.github.com/repos/rails/rails/issues/47861/comments,https://api.github.com/repos/rails/rails/issues/47861/events,https://github.com/rails/rails/pull/47861,1654572159,PR_kwDNIULOTZ8x4g,47861,Allows the default env key of `RAILS_MASTER_KEY` to be configurable by using `config.credentials.env_key` and `--env-key`.,"{'login': 'arianf', 'id': 7397857, 'node_id': 'MDQ6VXNlcjczOTc4NTc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7397857?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/arianf', 'html_url': 'https://github.com/arianf', 'followers_url': 'https://api.github.com/users/arianf/followers', 'following_url': 'https://api.github.com/users/arianf/following{/other_user}', 'gists_url': 'https://api.github.com/users/arianf/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/arianf/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/arianf/subscriptions', 'organizations_url': 'https://api.github.com/users/arianf/orgs', 'repos_url': 'https://api.github.com/users/arianf/repos', 'events_url': 'https://api.github.com/users/arianf/events{/privacy}', 'received_events_url': 'https://api.github.com/users/arianf/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-04-04T21:01:09Z,2023-05-15T22:49:30Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47861', 'html_url': 'https://github.com/rails/rails/pull/47861', 'diff_url': 'https://github.com/rails/rails/pull/47861.diff', 'patch_url': 'https://github.com/rails/rails/pull/47861.patch', 'merged_at': None}","Allows the default env key of `RAILS_MASTER_KEY` to be configurable by using `config.credentials.env_key` and `--env-key`.

### Motivation / Background

Rails uses a default key name: `RAILS_MASTER_KEY`, which is currently not configurable.

At Apple, were [working](https://developer.apple.com/news/?id=1o9zxsxl) to remove and replace non-inclusive language across our applications.

https://support.apple.com/guide/applestyleguide/m-apsg72b28652/1.0/web/1.0#apdef6d37bb5

> The term master can have oppressive associations, even when used in a technological context. For this reason, avoid using master when referring to the following:

This is an important objective for our team which uses Rails.

### Detail

Solved this by allowing the default key of `RAILS_MASTER_KEY` to be configurable by using `config.credentials.env_key`.

The Rails Credentials Command now respects this option as well:

```ruby
# ./config/application.rb
config.credentials.env_key = 'RAILS_MAIN_KEY'
# RAILS_MAIN_KEY=""*******"" rails credentials:edit
# RAILS_MAIN_KEY=""*******"" rails credentials:show

# ./config/environments/production.rb
config.credentials.env_key = 'RAILS_PROD_KEY'
# RAILS_PROD_KEY=""*******"" rails credentials:edit --environment production
# RAILS_PROD_KEY=""*******"" rails credentials:show --environment production

# ./config/environments/development.rb
config.credentials.env_key = 'RAILS_DEV_KEY'
# RAILS_DEV_KEY=""*******"" rails credentials:edit --environment development
# RAILS_DEV_KEY=""*******"" rails credentials:show --environment development
```

In addition, when using the `rails encrypted:edit`, you can also pass in an option for `--env-key` to override the name of default env key.

```bash
RAILS_MAIN_KEY=""*******"" rails encrypted:edit config/encrypted_file.yml.enc --env-key=""RAILS_MAIN_KEY""
RAILS_MAIN_KEY=""*******"" rails encrypted:show config/encrypted_file.yml.enc --env-key=""RAILS_MAIN_KEY""
```

### Additional information

Other approaches:

Modifying `RAILS_MASTER_KEY` to something like `RAILS_PRIMARY_KEY`, or `RAILS_MAIN_KEY`.

Opted not to take this approach, in an effort to not create a breaking change and minimize amount of impact for existing applications.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47861/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47861/timeline,,
https://api.github.com/repos/rails/rails/issues/47809,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47809/labels{/name},https://api.github.com/repos/rails/rails/issues/47809/comments,https://api.github.com/repos/rails/rails/issues/47809/events,https://github.com/rails/rails/issues/47809,1646596155,I_kwDNIULOYiUQOw,47809,load_async on associations does not load the association,"{'login': 'mikerobe', 'id': 1505137, 'node_id': 'MDQ6VXNlcjE1MDUxMzc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1505137?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mikerobe', 'html_url': 'https://github.com/mikerobe', 'followers_url': 'https://api.github.com/users/mikerobe/followers', 'following_url': 'https://api.github.com/users/mikerobe/following{/other_user}', 'gists_url': 'https://api.github.com/users/mikerobe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mikerobe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mikerobe/subscriptions', 'organizations_url': 'https://api.github.com/users/mikerobe/orgs', 'repos_url': 'https://api.github.com/users/mikerobe/repos', 'events_url': 'https://api.github.com/users/mikerobe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mikerobe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,2,2023-03-29T22:00:33Z,2023-03-30T07:33:45Z,,NONE,,,,"### Steps to reproduce

If you have a model called User that `has_many` notes for example,
``` ruby
class User < ApplicationRecord
  has_many :notes, dependent: :destroy, as: :notable
end
```

``` ruby
class Note < ApplicationRecord
  belongs_to :notable, polymorphic: true
end
```

and you then load the `notes` association using `load_async`,

``` ruby
user = User.find(1)
user.notes.load_async
user.notes.loaded? # false
sleep 3
puts user.notes # Kicks off another SELECT query
```

the asynchronously loaded data is not used on subsequent requests to the association.

The only way to get the async loaded association to be used is to save the result of `load_async` to a variable, and the result is then only usable from that variable rather than the association itself:
``` ruby
user = User.find(1)
notes = user.notes.load_async
notes.loaded? # true
sleep 3
puts notes # uses the async results
```

### Expected behavior
I would expect `user.notes` to use the result of the async load rather than kicking off another query, and I would expect `user.notes.loaded?` to be true after the call to `user.notes.load_async`.

### Actual behavior
It kicks off another query when accessing the association and `user.notes.loaded?` is false after `user.notes.load_async`.

### System configuration
**Rails version**: 7.0.4.3

**Ruby version**: 3.1.3
","{'url': 'https://api.github.com/repos/rails/rails/issues/47809/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47809/timeline,,
https://api.github.com/repos/rails/rails/issues/47804,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47804/labels{/name},https://api.github.com/repos/rails/rails/issues/47804/comments,https://api.github.com/repos/rails/rails/issues/47804/events,https://github.com/rails/rails/pull/47804,1645678109,PR_kwDNIULOTSjiYg,47804,Unify shapes of ActiveModel::Attributes,"{'login': 'casperisfine', 'id': 19192189, 'node_id': 'MDQ6VXNlcjE5MTkyMTg5', 'avatar_url': 'https://avatars.githubusercontent.com/u/19192189?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/casperisfine', 'html_url': 'https://github.com/casperisfine', 'followers_url': 'https://api.github.com/users/casperisfine/followers', 'following_url': 'https://api.github.com/users/casperisfine/following{/other_user}', 'gists_url': 'https://api.github.com/users/casperisfine/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/casperisfine/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/casperisfine/subscriptions', 'organizations_url': 'https://api.github.com/users/casperisfine/orgs', 'repos_url': 'https://api.github.com/users/casperisfine/repos', 'events_url': 'https://api.github.com/users/casperisfine/events{/privacy}', 'received_events_url': 'https://api.github.com/users/casperisfine/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,13,2023-03-29T12:10:15Z,2023-03-31T10:28:58Z,,CONTRIBUTOR,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47804', 'html_url': 'https://github.com/rails/rails/pull/47804', 'diff_url': 'https://github.com/rails/rails/pull/47804.diff', 'patch_url': 'https://github.com/rails/rails/pull/47804.patch', 'merged_at': None}","`if defined?(@ivar)` a performance anti-pattern in Ruby 3.2+ even more so with YJIT.

This pattern cause the object shape to be inconsistent which slow downs instance variable access.

```
ruby 3.2.1 (2023-02-08 revision 31819e82c8) [arm64-darwin22]
       #value (orig):  1811240.2 i/s
        #value (opt):  2045238.9 i/s - 1.13x  faster
```

```
ruby 3.2.1 (2023-02-08 revision 31819e82c8) +YJIT [arm64-darwin22]
       #value (orig):  4379180.3 i/s
        #value (opt):  6347280.7 i/s - 1.45x  faster
```

Benchmark: https://gist.github.com/casperisfine/872f0a486b5ccdf90d9feb830c76d9ad

### Backward compatibility

There is a big backward compatibility concern here, and I'm not sure we can actually make this change safety.

Until https://github.com/rails/rails/pull/47747, when you serialized an `ActiveRecord::Base` instance, lots of `ActiveModel::Attribute` instances would be serialized with it. Which means this optimization would break any instance serialized with an older Rails.

Currently the PR is only enabling the optimization if you switched to the new AR Marshal format, but:

  - You can switch to that format and still deserialize old payloads, this PR would break that.
  - Active Record may not be the only way these are serialized. We may break more stuff.

I can't think of any decent way to do this optimization while still retaining perfect backward/forward compatibility...

cc @tenderlove, I wonder if you have opinions here.","{'url': 'https://api.github.com/repos/rails/rails/issues/47804/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47804/timeline,,
https://api.github.com/repos/rails/rails/issues/47798,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47798/labels{/name},https://api.github.com/repos/rails/rails/issues/47798/comments,https://api.github.com/repos/rails/rails/issues/47798/events,https://github.com/rails/rails/pull/47798,1644772288,PR_kwDNIULOTRy2Dg,47798,Support custom autocomplete for hidden fields,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2023-03-28T23:03:02Z,2023-09-23T10:49:47Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47798', 'html_url': 'https://github.com/rails/rails/pull/47798', 'diff_url': 'https://github.com/rails/rails/pull/47798.diff', 'patch_url': 'https://github.com/rails/rails/pull/47798.patch', 'merged_at': None}","See:

* https://github.com/rails/rails/issues/46405#issuecomment-1472365329
* https://github.com/rails/rails/pull/43280
* https://github.com/rails/rails/issues/46470","{'url': 'https://api.github.com/repos/rails/rails/issues/47798/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47798/timeline,,
https://api.github.com/repos/rails/rails/issues/47756,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47756/labels{/name},https://api.github.com/repos/rails/rails/issues/47756/comments,https://api.github.com/repos/rails/rails/issues/47756/events,https://github.com/rails/rails/pull/47756,1638534052,PR_kwDNIULOTMnbeA,47756,Generalize check for foreign keys when checking for the inverse of a record,"{'login': 'nickborromeo', 'id': 1518902, 'node_id': 'MDQ6VXNlcjE1MTg5MDI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1518902?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nickborromeo', 'html_url': 'https://github.com/nickborromeo', 'followers_url': 'https://api.github.com/users/nickborromeo/followers', 'following_url': 'https://api.github.com/users/nickborromeo/following{/other_user}', 'gists_url': 'https://api.github.com/users/nickborromeo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nickborromeo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nickborromeo/subscriptions', 'organizations_url': 'https://api.github.com/users/nickborromeo/orgs', 'repos_url': 'https://api.github.com/users/nickborromeo/repos', 'events_url': 'https://api.github.com/users/nickborromeo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nickborromeo/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-24T00:34:33Z,2023-04-24T21:19:20Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47756', 'html_url': 'https://github.com/rails/rails/pull/47756', 'diff_url': 'https://github.com/rails/rails/pull/47756.diff', 'patch_url': 'https://github.com/rails/rails/pull/47756.patch', 'merged_at': None}","### Motivation / Background

Fixes https://github.com/rails/rails/issues/47574

It was reported that when you have an association that uses a scope, querying for inverses do not correctly return the same object.

@andrewberls provided the reproduction steps in the issue that was filed.

### Detail
It turns out, when rails needs to check if the foreign key matches the record in `matches_foreign_key?` it uses the `id` of the record. This works majority of the time but unfortunately does not work when the foreign key is not an `id` but something else like a `token` or a `uuid`.

This change updates the check to call `association_primary_key` from the reflection to properly match the record.


### Additional information

A check for `polymorphic?` needed to be added because when the change was ran against the whole ActiveRecord suite, there were tests that failed with the following trace 

```
ArgumentError: Polymorphic associations do not support computing the class.
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/reflection.rb:447:in `compute_class'
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/reflection.rb:406:in `klass'
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/reflection.rb:787:in `association_primary_key'
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/associations/association.rb:387:in `matches_foreign_key?'
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/associations/association.rb:375:in `inversable?'
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/associations/association.rb:143:in `inversed_from_queries'
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/associations/association.rb:126:in `set_inverse_instance_from_queries'
    /Users/nickborromeo/nickborromeo/rails/activerecord/lib/active_record/association_relation.rb:45:in `block in exec_queries'
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* ~[ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.~
","{'url': 'https://api.github.com/repos/rails/rails/issues/47756/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47756/timeline,,
https://api.github.com/repos/rails/rails/issues/47755,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47755/labels{/name},https://api.github.com/repos/rails/rails/issues/47755/comments,https://api.github.com/repos/rails/rails/issues/47755/events,https://github.com/rails/rails/pull/47755,1638463869,PR_kwDNIULOTMjmbA,47755,Update prevents_write docs,"{'login': 'AlexMooney', 'id': 8269566, 'node_id': 'MDQ6VXNlcjgyNjk1NjY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8269566?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/AlexMooney', 'html_url': 'https://github.com/AlexMooney', 'followers_url': 'https://api.github.com/users/AlexMooney/followers', 'following_url': 'https://api.github.com/users/AlexMooney/following{/other_user}', 'gists_url': 'https://api.github.com/users/AlexMooney/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/AlexMooney/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/AlexMooney/subscriptions', 'organizations_url': 'https://api.github.com/users/AlexMooney/orgs', 'repos_url': 'https://api.github.com/users/AlexMooney/repos', 'events_url': 'https://api.github.com/users/AlexMooney/events{/privacy}', 'received_events_url': 'https://api.github.com/users/AlexMooney/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2023-03-23T23:07:51Z,2023-09-15T09:40:41Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47755', 'html_url': 'https://github.com/rails/rails/pull/47755', 'diff_url': 'https://github.com/rails/rails/pull/47755.diff', 'patch_url': 'https://github.com/rails/rails/pull/47755.patch', 'merged_at': None}","### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

I noticed that the comment about the `READ_QUERY` was backwards (it's a list of allowed queries, not blocked queries) and that `role: :reading` always sets `prevents_writes: true`.  I've removed the reference to `READ_QUERY` because it's a private constant.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->
Let me know if you folks would prefer these commits to be squished or split to different PRs.

Demo for `prevents_writes` always being set for `:reading`:
```ruby
> ActiveRecord::Base.connected_to(role: :primary) { ActiveRecord::Base.current_preventing_writes }
false
> ActiveRecord::Base.connected_to(role: :primary, prevent_writes: true) { ActiveRecord::Base.current_preventing_writes }
true
> ActiveRecord::Base.connected_to(role: :reading) { ActiveRecord::Base.current_preventing_writes }
true
> ActiveRecord::Base.connected_to(role: :reading, prevent_writes: false) { ActiveRecord::Base.current_preventing_writes }
true
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] ~~CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and~~ documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/47755/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47755/timeline,,
https://api.github.com/repos/rails/rails/issues/47751,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47751/labels{/name},https://api.github.com/repos/rails/rails/issues/47751/comments,https://api.github.com/repos/rails/rails/issues/47751/events,https://github.com/rails/rails/pull/47751,1637598019,PR_kwDNIULOTL0rNA,47751,ActiveRecord::Relation#async_pending? for introspecting async relations,"{'login': 'joeldrapper', 'id': 246692, 'node_id': 'MDQ6VXNlcjI0NjY5Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/246692?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/joeldrapper', 'html_url': 'https://github.com/joeldrapper', 'followers_url': 'https://api.github.com/users/joeldrapper/followers', 'following_url': 'https://api.github.com/users/joeldrapper/following{/other_user}', 'gists_url': 'https://api.github.com/users/joeldrapper/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/joeldrapper/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/joeldrapper/subscriptions', 'organizations_url': 'https://api.github.com/users/joeldrapper/orgs', 'repos_url': 'https://api.github.com/users/joeldrapper/repos', 'events_url': 'https://api.github.com/users/joeldrapper/events{/privacy}', 'received_events_url': 'https://api.github.com/users/joeldrapper/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,25,2023-03-23T13:56:58Z,2023-03-28T08:27:08Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47751', 'html_url': 'https://github.com/rails/rails/pull/47751', 'diff_url': 'https://github.com/rails/rails/pull/47751.diff', 'patch_url': 'https://github.com/rails/rails/pull/47751.patch', 'merged_at': None}","Add `pending?` predicate to `ActiveRecord::Relation` that returns `true` if the relation is pending on the background thread pool; otherwise, returns `false`.

### Motivation / Background

This Pull Request has been created because there is currently no way to tell if an asynchronous `ActiveRecord::Relation` has actually loaded, since `loaded?` returns `true` even if the future is still pending.

An alternative approach might be to update the `loading?` predicate to return `false` when a future result is still pending. That would be a breaking change, and I don't know what else it might impact.

### Detail

This Pull Request adds a `pending?` predicate that returns `true` if the future result is pending; otherwise, returns `false`.

### Additional information

This change is based on [this discussion](https://discuss.rubyonrails.org/t/is-there-a-way-to-check-of-an-async-database-query-has-actually-loaded/82538).

I tried to write a test but wasnt able to work out how to artificially slow an SQLite query to the point where it would still be pending by the time we check the predicate. There doesnt seem to be a way to make an SQLite query sleep so let me know if you have any suggestions on how to do this.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47751/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47751/timeline,,
https://api.github.com/repos/rails/rails/issues/47745,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47745/labels{/name},https://api.github.com/repos/rails/rails/issues/47745/comments,https://api.github.com/repos/rails/rails/issues/47745/events,https://github.com/rails/rails/pull/47745,1636884653,PR_kwDNIULOTLONMw,47745,TimeWithZone#today? should respect non UTC timezones,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-23T05:38:32Z,2023-03-23T05:38:36Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47745', 'html_url': 'https://github.com/rails/rails/pull/47745', 'diff_url': 'https://github.com/rails/rails/pull/47745.diff', 'patch_url': 'https://github.com/rails/rails/pull/47745.patch', 'merged_at': None}","This attempts to fix the bug identified in #46361

---

It seems like the test should also change, since it was failing on my machine (+09:00).","{'url': 'https://api.github.com/repos/rails/rails/issues/47745/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47745/timeline,,
https://api.github.com/repos/rails/rails/issues/47744,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47744/labels{/name},https://api.github.com/repos/rails/rails/issues/47744/comments,https://api.github.com/repos/rails/rails/issues/47744/events,https://github.com/rails/rails/pull/47744,1636847534,PR_kwDNIULOTLMMDA,47744,Introduces ActiveRecord::Base#alert,"{'login': 'dorianmariefr', 'id': 58794487, 'node_id': 'MDQ6VXNlcjU4Nzk0NDg3', 'avatar_url': 'https://avatars.githubusercontent.com/u/58794487?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dorianmariefr', 'html_url': 'https://github.com/dorianmariefr', 'followers_url': 'https://api.github.com/users/dorianmariefr/followers', 'following_url': 'https://api.github.com/users/dorianmariefr/following{/other_user}', 'gists_url': 'https://api.github.com/users/dorianmariefr/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dorianmariefr/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dorianmariefr/subscriptions', 'organizations_url': 'https://api.github.com/users/dorianmariefr/orgs', 'repos_url': 'https://api.github.com/users/dorianmariefr/repos', 'events_url': 'https://api.github.com/users/dorianmariefr/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dorianmariefr/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-23T04:53:26Z,2023-03-23T04:58:08Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47744', 'html_url': 'https://github.com/rails/rails/pull/47744', 'diff_url': 'https://github.com/rails/rails/pull/47744.diff', 'patch_url': 'https://github.com/rails/rails/pull/47744.patch', 'merged_at': None}","```ruby
def alert
  errors.full_messages.to_sentence
end
```

Example:

```ruby
if @post.update(post_params)
  redirect_to @post
else
  flash.now.alert = @post.alert
  render :edit
end
```

### Motivation / Background

In all my personal Ruby on Rails projects I add this alias so I thought it would be helpful for more people.

This Pull Request has been created to make dealing with validation errors easier.

### Detail

This Pull Request changes ActiveRecord::Base to include the method `alert`.

### Additional information

I'm thinking it would be a nice default for the generators to use flash for alerts instead of iterating over errors in the forms.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47744/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47744/timeline,,
https://api.github.com/repos/rails/rails/issues/47740,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47740/labels{/name},https://api.github.com/repos/rails/rails/issues/47740/comments,https://api.github.com/repos/rails/rails/issues/47740/events,https://github.com/rails/rails/issues/47740,1636588935,I_kwDNIULOYYxdhw,47740,[ActiveSupport::Inflector] Acronyms preceded by digits behave differently in `camelize` and `underscore`,"{'login': 'b-loyola', 'id': 16454659, 'node_id': 'MDQ6VXNlcjE2NDU0NjU5', 'avatar_url': 'https://avatars.githubusercontent.com/u/16454659?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/b-loyola', 'html_url': 'https://github.com/b-loyola', 'followers_url': 'https://api.github.com/users/b-loyola/followers', 'following_url': 'https://api.github.com/users/b-loyola/following{/other_user}', 'gists_url': 'https://api.github.com/users/b-loyola/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/b-loyola/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/b-loyola/subscriptions', 'organizations_url': 'https://api.github.com/users/b-loyola/orgs', 'repos_url': 'https://api.github.com/users/b-loyola/repos', 'events_url': 'https://api.github.com/users/b-loyola/events{/privacy}', 'received_events_url': 'https://api.github.com/users/b-loyola/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,5,2023-03-22T22:33:42Z,2023-07-25T17:54:01Z,,NONE,,,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""activesupport"", ""~> 7.0.0""
end

require ""active_support""
require ""active_support/inflector""
require ""minitest/autorun""

class BugTest < Minitest::Test
  def setup
    ActiveSupport::Inflector.inflections(:en) do |inflect|
      inflect.acronym(""HTTP"")
    end
  end

  def test_camelize_and_underscore_acronym
    assert_equal ""http"", ""HTTP"".underscore
    assert_equal ""HTTP"", ""http"".camelize
    assert_equal ""http_one"", ""HTTPOne"".underscore
    assert_equal ""HTTPOne"", ""http_one"".camelize
    assert_equal ""http1.1"", ""HTTP1.1"".underscore
    assert_equal ""HTTP1.1"", ""http1.1"".camelize
  end
end
```

### Expected behavior

Should acronyms followed by numbers be considered their own words for `camelize` in the same way they are for `underscore`? The `underscore` method seems to transform `HTTP1` to `http1` and `HTTPOne` to `http_one`, seemingly recognizing the acronym regardless of the character that follows it, whereas `camelize` will consider digits as part of the same word for acronyms, failing to recognize the `HTTP` acronym when followed by digits. Perhaps the behaviour should be consistent?

I know there is some reluctance to change inflections ""to avoid breaking legacy applications which may be relying on errant inflections"" but perhaps this could be done through an inflector option and/or configuration so that we can fix things like these while allowing previous errant inflections with default configuration?

I'd be happy to work on something like this, but wanted to check first if it would be acceptable.

E.g.:
```ruby
ActiveSupport::Inflector.configure do |config|
  config.camelize_with_digits = false # defaults to `true`
end

ActiveSupport::Inflector.inflections(:en) do |inflect|
  inflect.acronym(""HTTP"")
end

""http1.1"".camelize
#=> ""HTTP1.1""
```

### Actual behavior
```
  1) Failure:
BugTest#test_camelize_and_underscore_acronym [test_inflection.rb:30]:
Expected: ""HTTP1.1""
  Actual: ""Http1.1""

1 runs, 6 assertions, 1 failures, 0 errors, 0 skips
```

### System configuration
**Rails version**: `Using activesupport 7.0.4.3`

**Ruby version**: `ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-darwin20]`
","{'url': 'https://api.github.com/repos/rails/rails/issues/47740/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47740/timeline,,
https://api.github.com/repos/rails/rails/issues/47730,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47730/labels{/name},https://api.github.com/repos/rails/rails/issues/47730/comments,https://api.github.com/repos/rails/rails/issues/47730/events,https://github.com/rails/rails/pull/47730,1634853139,PR_kwDNIULOTJhnAA,47730,Allow route constraints to be arrays converted to Regexes,"{'login': 'dorianmariefr', 'id': 58794487, 'node_id': 'MDQ6VXNlcjU4Nzk0NDg3', 'avatar_url': 'https://avatars.githubusercontent.com/u/58794487?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dorianmariefr', 'html_url': 'https://github.com/dorianmariefr', 'followers_url': 'https://api.github.com/users/dorianmariefr/followers', 'following_url': 'https://api.github.com/users/dorianmariefr/following{/other_user}', 'gists_url': 'https://api.github.com/users/dorianmariefr/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dorianmariefr/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dorianmariefr/subscriptions', 'organizations_url': 'https://api.github.com/users/dorianmariefr/orgs', 'repos_url': 'https://api.github.com/users/dorianmariefr/repos', 'events_url': 'https://api.github.com/users/dorianmariefr/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dorianmariefr/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,1,2023-03-21T23:53:22Z,2023-07-18T13:49:55Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47730', 'html_url': 'https://github.com/rails/rails/pull/47730', 'diff_url': 'https://github.com/rails/rails/pull/47730.diff', 'patch_url': 'https://github.com/rails/rails/pull/47730.patch', 'merged_at': None}","```ruby
get(
  '/download/:platform' => 'download#platform',
  constraints: { patform: %w[windows linux macos] },
  as: :download_platform
)
```

The route will be matched if any element matches.

Fixes #47726

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47730/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47730/timeline,,
https://api.github.com/repos/rails/rails/issues/47727,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47727/labels{/name},https://api.github.com/repos/rails/rails/issues/47727/comments,https://api.github.com/repos/rails/rails/issues/47727/events,https://github.com/rails/rails/pull/47727,1634698837,PR_kwDNIULOTJZfBg,47727,"Rename ""Mail"" to ""Mail extensions"" in API sidebar","{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,2,2023-03-21T21:15:18Z,2023-03-22T09:53:25Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47727', 'html_url': 'https://github.com/rails/rails/pull/47727', 'diff_url': 'https://github.com/rails/rails/pull/47727.diff', 'patch_url': 'https://github.com/rails/rails/pull/47727.patch', 'merged_at': None}","Similar to the ""Core extensions"" we should move the documentation of the extensions to `Mail` to ""Mail extensions"".
This also move both ""Core extensions"" and ""Mail extensions"" to the bottom of the list, as these are both less important than the main frameworks like ActiveSupport and ActiveRecord.

### Before
<img width=""299"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/226742634-0a253650-9d06-4c6f-8ae0-54b54c0fcb9b.png"">

### After
<img width=""300"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/226742487-552660e8-6499-4b41-a8a5-b5fbf9e50574.png"">

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47727/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47727/timeline,,
https://api.github.com/repos/rails/rails/issues/47726,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47726/labels{/name},https://api.github.com/repos/rails/rails/issues/47726/comments,https://api.github.com/repos/rails/rails/issues/47726/events,https://github.com/rails/rails/issues/47726,1634631079,I_kwDNIULOYW59pw,47726,Route constraints with an array do not allow building a path only parsing a path.,"{'login': 'urkle', 'id': 101123, 'node_id': 'MDQ6VXNlcjEwMTEyMw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/101123?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/urkle', 'html_url': 'https://github.com/urkle', 'followers_url': 'https://api.github.com/users/urkle/followers', 'following_url': 'https://api.github.com/users/urkle/following{/other_user}', 'gists_url': 'https://api.github.com/users/urkle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/urkle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/urkle/subscriptions', 'organizations_url': 'https://api.github.com/users/urkle/orgs', 'repos_url': 'https://api.github.com/users/urkle/repos', 'events_url': 'https://api.github.com/users/urkle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/urkle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,6,2023-03-21T20:16:22Z,2023-08-20T14:45:11Z,,CONTRIBUTOR,,,,"### Steps to reproduce
```ruby
# Given a route like this.
MyApplication::Application.routes.draw do
    get '/download/:platform' => 'download#platform',
        constraints: {
          platform: %w[windows linux macos],
        },
        as: :download_platform
end
```

### Expected behavior
Routing test (rspec)
```ruby
expect(get(""/download/windows"")).to route_to('download#platform',
                                                         platform: platform)
```

url building test (rspec)
```ruby
def some_function(platform)
    download_platform_path(platform: platform)
end

expect(some_function('windows')).to eq(download_platform_path('windows'))
```

### Actual behavior
The routing spec passes, but the url building test fails with a `No route matches ... possible unmatched constraints: [:platform]` error.

However,

If I change the constraint to this
```ruby
MyApplication::Application.routes.draw do
    get '/download/:platform' => 'download#platform',
        constraints: {
          platform: /(windows|linux|macos)/,
        },
        as: :download_platform
end
```

both pass correctly.

### System configuration
**Rails version**: 2.7.3

**Ruby version**: 6.0.5
","{'url': 'https://api.github.com/repos/rails/rails/issues/47726/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47726/timeline,,
https://api.github.com/repos/rails/rails/issues/47719,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47719/labels{/name},https://api.github.com/repos/rails/rails/issues/47719/comments,https://api.github.com/repos/rails/rails/issues/47719/events,https://github.com/rails/rails/pull/47719,1632881233,PR_kwDNIULOTH3WAg,47719,Add `test:prepare` to `bin/setup` template for new apps,"{'login': 'ghiculescu', 'id': 509837, 'node_id': 'MDQ6VXNlcjUwOTgzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/509837?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ghiculescu', 'html_url': 'https://github.com/ghiculescu', 'followers_url': 'https://api.github.com/users/ghiculescu/followers', 'following_url': 'https://api.github.com/users/ghiculescu/following{/other_user}', 'gists_url': 'https://api.github.com/users/ghiculescu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ghiculescu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ghiculescu/subscriptions', 'organizations_url': 'https://api.github.com/users/ghiculescu/orgs', 'repos_url': 'https://api.github.com/users/ghiculescu/repos', 'events_url': 'https://api.github.com/users/ghiculescu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ghiculescu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-20T21:19:38Z,2023-03-25T18:26:35Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47719', 'html_url': 'https://github.com/rails/rails/pull/47719', 'diff_url': 'https://github.com/rails/rails/pull/47719.diff', 'patch_url': 'https://github.com/rails/rails/pull/47719.patch', 'merged_at': None}","Suggested by @etiennebarrie [here](https://github.com/rails/rails/pull/47210#issuecomment-1476420481), I think this is a good idea. This way if you clone a repo and want to run a single test, you will be able to successfully do so if you ran `bin/setup` first (which is a good idea as it also tries to set up everything else you need).

Note that this does *not* also call `db:test:prepare`, as that is called automatically when you run your tests (see [here](https://github.com/rails/rails/pull/46664#issuecomment-1379522169)).","{'url': 'https://api.github.com/repos/rails/rails/issues/47719/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47719/timeline,,
https://api.github.com/repos/rails/rails/issues/47713,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47713/labels{/name},https://api.github.com/repos/rails/rails/issues/47713/comments,https://api.github.com/repos/rails/rails/issues/47713/events,https://github.com/rails/rails/pull/47713,1632305308,PR_kwDNIULOTHYTpw,47713,Use Thor for built-in stats task,"{'login': 'JuanVqz', 'id': 7331511, 'node_id': 'MDQ6VXNlcjczMzE1MTE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7331511?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JuanVqz', 'html_url': 'https://github.com/JuanVqz', 'followers_url': 'https://api.github.com/users/JuanVqz/followers', 'following_url': 'https://api.github.com/users/JuanVqz/following{/other_user}', 'gists_url': 'https://api.github.com/users/JuanVqz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JuanVqz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JuanVqz/subscriptions', 'organizations_url': 'https://api.github.com/users/JuanVqz/orgs', 'repos_url': 'https://api.github.com/users/JuanVqz/repos', 'events_url': 'https://api.github.com/users/JuanVqz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JuanVqz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,2,2023-03-20T15:07:17Z,2023-03-27T08:33:33Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47713', 'html_url': 'https://github.com/rails/rails/pull/47713', 'diff_url': 'https://github.com/rails/rails/pull/47713.diff', 'patch_url': 'https://github.com/rails/rails/pull/47713.patch', 'merged_at': None}","### Motivation / Background

Currently, we use both Thor and Rake for `bin/rails` commands. We eventually want to get all the built-ins task promoted to Thor Commands. This migrates the `stats` task to Thor.

### Detail



### Additional information



### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47713/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47713/timeline,,
https://api.github.com/repos/rails/rails/issues/47707,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47707/labels{/name},https://api.github.com/repos/rails/rails/issues/47707/comments,https://api.github.com/repos/rails/rails/issues/47707/events,https://github.com/rails/rails/pull/47707,1629916773,PR_kwDNIULOTFacwA,47707,Replace deprecated use of Event.initevent has been deprecated with Event constructor in activestorage.js,"{'login': 'vipulnsward', 'id': 567626, 'node_id': 'MDQ6VXNlcjU2NzYyNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/567626?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/vipulnsward', 'html_url': 'https://github.com/vipulnsward', 'followers_url': 'https://api.github.com/users/vipulnsward/followers', 'following_url': 'https://api.github.com/users/vipulnsward/following{/other_user}', 'gists_url': 'https://api.github.com/users/vipulnsward/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/vipulnsward/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/vipulnsward/subscriptions', 'organizations_url': 'https://api.github.com/users/vipulnsward/orgs', 'repos_url': 'https://api.github.com/users/vipulnsward/repos', 'events_url': 'https://api.github.com/users/vipulnsward/events{/privacy}', 'received_events_url': 'https://api.github.com/users/vipulnsward/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-17T20:51:13Z,2023-03-18T19:28:30Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47707', 'html_url': 'https://github.com/rails/rails/pull/47707', 'diff_url': 'https://github.com/rails/rails/pull/47707.diff', 'patch_url': 'https://github.com/rails/rails/pull/47707.patch', 'merged_at': None}","
### Motivation / Background

Usage of `Event.initevent` has been deprecated - https://developer.mozilla.org/en-US/docs/web/api/event/initevent

Replace and make use of `Event` constructor instead- https://developer.mozilla.org/en-US/docs/Web/API/Event/Event

### Detail

- Replace usage of `Event.initevent` and ` document.createEvent(""Event"")`  with simplified `Event` constructor instead
- Pass down same options to constructor as before
- Also runs yarn build to update current builds of AS.js and esm modules

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47707/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47707/timeline,,
https://api.github.com/repos/rails/rails/issues/47705,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47705/labels{/name},https://api.github.com/repos/rails/rails/issues/47705/comments,https://api.github.com/repos/rails/rails/issues/47705/events,https://github.com/rails/rails/pull/47705,1629389028,PR_kwDNIULOTE-ByA,47705,Add alias methods to ActiveRecord::Store's dirty API,"{'login': 'a5-stable', 'id': 52599949, 'node_id': 'MDQ6VXNlcjUyNTk5OTQ5', 'avatar_url': 'https://avatars.githubusercontent.com/u/52599949?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/a5-stable', 'html_url': 'https://github.com/a5-stable', 'followers_url': 'https://api.github.com/users/a5-stable/followers', 'following_url': 'https://api.github.com/users/a5-stable/following{/other_user}', 'gists_url': 'https://api.github.com/users/a5-stable/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/a5-stable/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/a5-stable/subscriptions', 'organizations_url': 'https://api.github.com/users/a5-stable/orgs', 'repos_url': 'https://api.github.com/users/a5-stable/repos', 'events_url': 'https://api.github.com/users/a5-stable/events{/privacy}', 'received_events_url': 'https://api.github.com/users/a5-stable/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-03-17T14:11:55Z,2023-06-08T07:23:16Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47705', 'html_url': 'https://github.com/rails/rails/pull/47705', 'diff_url': 'https://github.com/rails/rails/pull/47705.diff', 'patch_url': 'https://github.com/rails/rails/pull/47705.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

ActiveRecord provides corresponding methods for `attribute_changed?` and `attribute_change`, namely `will_save_change_to_attribute?` and `attribute_to_be_saved`, respectively. These methods are named in a way that makes them easy to use in callbacks.

These are not defined in ActiveRecord::Store. To promote consistency, I propose adding alias methods to ActiveRecord::Store that would allow the use of these naming conventions.


### Checklist

Before submitting the PR make sure the following are checked:

* [ ] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47705/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47705/timeline,,
https://api.github.com/repos/rails/rails/issues/47699,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47699/labels{/name},https://api.github.com/repos/rails/rails/issues/47699/comments,https://api.github.com/repos/rails/rails/issues/47699/events,https://github.com/rails/rails/issues/47699,1628294060,I_kwDNIULOYQ3LrA,47699,Weird interaction between AS::Concern and Module#ancestors,"{'login': 'fxn', 'id': 3387, 'node_id': 'MDQ6VXNlcjMzODc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3387?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fxn', 'html_url': 'https://github.com/fxn', 'followers_url': 'https://api.github.com/users/fxn/followers', 'following_url': 'https://api.github.com/users/fxn/following{/other_user}', 'gists_url': 'https://api.github.com/users/fxn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fxn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fxn/subscriptions', 'organizations_url': 'https://api.github.com/users/fxn/orgs', 'repos_url': 'https://api.github.com/users/fxn/repos', 'events_url': 'https://api.github.com/users/fxn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fxn/received_events', 'type': 'User', 'site_admin': False}","[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,8,2023-03-16T21:13:11Z,2023-08-29T21:05:45Z,,MEMBER,,,,"If you throw this file into an application:

```ruby
# app/models/foo.rb
module Foo
  extend ActiveSupport::Concern
end

module Bar
  extend ActiveSupport::Concern
  include Foo
  p ancestors
end
```

The command `bin/rails r Foo` prints `[Bar]`, but it should be `[Bar, Foo]`. You get the correct result if `Foo` does not extend `AS::Concern`.","{'url': 'https://api.github.com/repos/rails/rails/issues/47699/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47699/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/47698,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47698/labels{/name},https://api.github.com/repos/rails/rails/issues/47698/comments,https://api.github.com/repos/rails/rails/issues/47698/events,https://github.com/rails/rails/pull/47698,1628278003,PR_kwDNIULOTECmuA,47698,Use Thor for built-in tmp task,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,1,2023-03-16T21:03:32Z,2023-03-21T10:55:45Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47698', 'html_url': 'https://github.com/rails/rails/pull/47698', 'diff_url': 'https://github.com/rails/rails/pull/47698.diff', 'patch_url': 'https://github.com/rails/rails/pull/47698.patch', 'merged_at': None}","Currently we use both Thor and Rake for `bin/rails` commands. We eventually want to get all the built-ins task promoted to Thor Commands. This migrates the `tmp` task to Thor.

As `tmp` directories are sometimes hidden by editors, I've used `temp` instead.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47698/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47698/timeline,,
https://api.github.com/repos/rails/rails/issues/47695,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47695/labels{/name},https://api.github.com/repos/rails/rails/issues/47695/comments,https://api.github.com/repos/rails/rails/issues/47695/events,https://github.com/rails/rails/issues/47695,1628074975,I_kwDNIULOYQpz3w,47695,AR's before_last_save tracking wrong for nested callback,"{'login': 'MaxLap', 'id': 894561, 'node_id': 'MDQ6VXNlcjg5NDU2MQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/894561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/MaxLap', 'html_url': 'https://github.com/MaxLap', 'followers_url': 'https://api.github.com/users/MaxLap/followers', 'following_url': 'https://api.github.com/users/MaxLap/following{/other_user}', 'gists_url': 'https://api.github.com/users/MaxLap/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/MaxLap/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/MaxLap/subscriptions', 'organizations_url': 'https://api.github.com/users/MaxLap/orgs', 'repos_url': 'https://api.github.com/users/MaxLap/repos', 'events_url': 'https://api.github.com/users/MaxLap/events{/privacy}', 'received_events_url': 'https://api.github.com/users/MaxLap/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-03-16T18:41:47Z,2023-07-02T15:46:59Z,,CONTRIBUTOR,,,,"Nested callback executions in ActiveRecord (ex: a after_save does a update, which trigger another chain of callbacks) have a weird (IMO wrong) interaction with the `saved_change_to_*?`, `saved_changes`, `*_before_last_save` and friends.

The behavior changed in Rails 5.1. Rails 5.0's behavior was more intuitive.

### Steps to reproduce

( I got repro scripts below )

0) A model with 2 attributes, ex: `name` and `foo`

1) Have a after_save (or any other after_something) that does an update to `foo` of the model (with a condition, so that you don't get infinite recursion). Ex: `update(foo: 1) if foo != 1`

2) Have another after_save (called after the one in (1)) which checks if the other attribute was changed. Ex: `$saw_saved_change_to_name = true if saved_change_to_name?`

3) Create an instance setting only the name: Ex: `Post.create(name: 'hi')`

The second callback will never see `saved_change_to_name?` as true, because the first callback, triggering anothere save, fully overwrites the tracking.

I added a print of the saved_changes in the test to show what's going on. There is a failing script for main and 5.1, and a passing one for 5.0.

Here is the failing case in main:
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3"", '~> 1.4'
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.text :name
    t.integer :foo
  end
end

class Post < ActiveRecord::Base
  after_save :set_foo_after_save
  after_save :check_saved_change_to_name

  def set_foo_after_save
    update(foo: 1) if foo != 1
  end

  def check_saved_change_to_name
    puts ""* Saved changes: #{saved_changes}""
    $saw_saved_change_to_name = true if saved_change_to_name?
  end
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!(name: 'hi')

    assert($saw_saved_change_to_name)
  end
end
```
```
* Saved changes: {""foo""=>[nil, 1]}
* Saved changes: {""foo""=>[nil, 1]}
Expected nil to be truthy
```

Here is the failing case in 5.1:
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""5.1.7""
  gem ""sqlite3"", '1.3.13'
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.text :name
    t.integer :foo
  end
end

class Post < ActiveRecord::Base
  after_save :set_foo_after_save
  after_save :check_saved_change_to_name_after_save

  def set_foo_after_save
    update(foo: 1) if foo != 1
  end

  def check_saved_change_to_name_after_save
    puts ""* Saved changes: #{saved_changes}""
    $saw_saved_change_to_name = true if saved_change_to_name?
  end
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!(name: 'hi')

    assert($saw_saved_change_to_name)
  end
end
```
```
* Saved changes: {""foo""=>[nil, 1]}
* Saved changes: {""foo""=>[nil, 1]}
Expected nil to be truthy
```

And here is the passing case in 5.0, which was before Rails switched to `saved_change_to_*?` and friends:
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""5.0.7.2""
  gem ""sqlite3"", '1.3.13'
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.text :name
    t.integer :foo
  end
end

class Post < ActiveRecord::Base
  after_create :set_foo_after_save
  after_save :check_saved_change_to_name_after_save

  def set_foo_after_save
    update(foo: 1) if foo != 1
  end

  def check_saved_change_to_name_after_save
    puts ""* Saved changes: #{changes}""
    $saw_saved_change_to_name = true if name_changed?
  end
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!(name: 'hi')

    assert($saw_saved_change_to_name)
  end
end
```
```
* Saved changes: {""id""=>[nil, 1], ""name""=>[nil, ""hi""], ""foo""=>[nil, 1]}
* Saved changes: {}
Passes the test
```


### Expected behavior

I expect a  `after_*` callback that reacts to `saved_change_to_*?` to be called at least once with said change of `true` when the attribute gets changed.

### Actual behavior

The callback never gets called with `saved_change_to_name?` being `true` because the nested change 

In my opinion, the priority should be on handling the 1st expected behavior

This means that if I make code with such a callback, everything could work, and someone doing a nested update in a different callback could completely break the first callback.

### System configuration
**Rails version**: 5.1, main

**Ruby version**: 2.4 and 3.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/47695/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47695/timeline,,
https://api.github.com/repos/rails/rails/issues/47686,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47686/labels{/name},https://api.github.com/repos/rails/rails/issues/47686/comments,https://api.github.com/repos/rails/rails/issues/47686/events,https://github.com/rails/rails/pull/47686,1626893208,PR_kwDNIULOTC26Sw,47686,Add `ActiveRecord::Base.extend_relations`,"{'login': 'casperisfine', 'id': 19192189, 'node_id': 'MDQ6VXNlcjE5MTkyMTg5', 'avatar_url': 'https://avatars.githubusercontent.com/u/19192189?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/casperisfine', 'html_url': 'https://github.com/casperisfine', 'followers_url': 'https://api.github.com/users/casperisfine/followers', 'following_url': 'https://api.github.com/users/casperisfine/following{/other_user}', 'gists_url': 'https://api.github.com/users/casperisfine/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/casperisfine/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/casperisfine/subscriptions', 'organizations_url': 'https://api.github.com/users/casperisfine/orgs', 'repos_url': 'https://api.github.com/users/casperisfine/repos', 'events_url': 'https://api.github.com/users/casperisfine/events{/privacy}', 'received_events_url': 'https://api.github.com/users/casperisfine/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-16T07:42:57Z,2023-03-16T07:43:01Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47686', 'html_url': 'https://github.com/rails/rails/pull/47686', 'diff_url': 'https://github.com/rails/rails/pull/47686.diff', 'patch_url': 'https://github.com/rails/rails/pull/47686.patch', 'merged_at': None}","Ref: https://github.com/rails/rails/pull/47314 (fixes what I believe to be the most common use case).

Based on what I could see, a very common use case for extending (in our code base at least) is akin to:

```ruby
class MyModel < AR::Base
  default_scope { extending(MutationGuard::Relation) }
end
```

This use case would be much better served by directly including that module in all the relation delegators.

@rafaelfranca @jhawthorn @matthewd any opinion?","{'url': 'https://api.github.com/repos/rails/rails/issues/47686/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47686/timeline,,
https://api.github.com/repos/rails/rails/issues/47654,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47654/labels{/name},https://api.github.com/repos/rails/rails/issues/47654/comments,https://api.github.com/repos/rails/rails/issues/47654/events,https://github.com/rails/rails/pull/47654,1620832664,PR_kwDNIULOS9wOFA,47654,Add `rake guides:lint` task that raises error for broken anchors,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-03-13T06:25:01Z,2023-03-14T02:20:02Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47654', 'html_url': 'https://github.com/rails/rails/pull/47654', 'diff_url': 'https://github.com/rails/rails/pull/47654.diff', 'patch_url': 'https://github.com/rails/rails/pull/47654.patch', 'merged_at': None}","The guides generator would previous print an warning when it finds a broken anchor link during page generation.

This task uses that ability and raises an exception when that occurs.

For example:

```
Generating configuring.md as configuring.html
*** BROKEN LINK: #config-active-record-default-column-serialize, perhaps you meant #config-active-record-default-column-serializer.
*** BROKEN LINK: #config-active-record-encryption-hash-digest-class, perhaps you meant #config-active-record-automatic-scope-inversing.
Generating form_helpers.md as form_helpers.html
Generating command_line.md as command_line.html
*** BROKEN LINK: #fixme, perhaps you meant #.
Generating 5_2_release_notes.md as 5_2_release_notes.html
Generating 7_1_release_notes.md as 7_1_release_notes.html
[WARN] BROKEN LINK(s): association_basics.md: #bi-drectional-associations
[WARN] BROKEN LINK(s): configuring.md: #config-active-record-default-column-serialize, #config-active-record-encryption-hash-digest-class
[WARN] BROKEN LINK(s): command_line.md: #fixme
rake aborted!
Command failed with status (1): [/Users/zzak/.rubies/ruby-3.3.0/bin/ruby -E...]
```

","{'url': 'https://api.github.com/repos/rails/rails/issues/47654/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47654/timeline,,
https://api.github.com/repos/rails/rails/issues/47646,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47646/labels{/name},https://api.github.com/repos/rails/rails/issues/47646/comments,https://api.github.com/repos/rails/rails/issues/47646/events,https://github.com/rails/rails/pull/47646,1620462424,PR_kwDNIULOS9dEOQ,47646,Use Thor for built-in Time zone tasks,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,4,2023-03-12T18:23:32Z,2023-03-18T16:00:08Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47646', 'html_url': 'https://github.com/rails/rails/pull/47646', 'diff_url': 'https://github.com/rails/rails/pull/47646.diff', 'patch_url': 'https://github.com/rails/rails/pull/47646.patch', 'merged_at': None}","Currently we use both Thor and Rake for `bin/rails` commands.
We eventually want to get all the built-in tasks promoted to Thor Commands.

This migrates the `time:zones` tasks to Thor.

This also fixes passing `US` or `-8` as an argument, as the Rake implementation was broken. The arguments have to be passed without square brackets though.

The existing description has the following example, but it doesn't work:
```bash
bin/rails time:zones[-8]
no matches found: time:zones[-8]
```

With this PR we can pass `-8`:

```bash
bin/rails time:zones -8

* UTC -08:00 *
Pacific Time (US & Canada)
Tijuana

```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47646/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47646/timeline,,
https://api.github.com/repos/rails/rails/issues/47634,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47634/labels{/name},https://api.github.com/repos/rails/rails/issues/47634/comments,https://api.github.com/repos/rails/rails/issues/47634/events,https://github.com/rails/rails/pull/47634,1619577940,PR_kwDNIULOS8x2fw,47634,Lazy require dependencies in Rails commands,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,6,2023-03-10T20:30:28Z,2023-03-13T18:42:08Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47634', 'html_url': 'https://github.com/rails/rails/pull/47634', 'diff_url': 'https://github.com/rails/rails/pull/47634.diff', 'patch_url': 'https://github.com/rails/rails/pull/47634.patch', 'merged_at': None}","Some commands only require dependencies when the command is performed,
while others require them in advance.
By only requiring the dependencies when needed we can speed up other
commands, as they don't need to load these files.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47634/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47634/timeline,,
https://api.github.com/repos/rails/rails/issues/47623,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47623/labels{/name},https://api.github.com/repos/rails/rails/issues/47623/comments,https://api.github.com/repos/rails/rails/issues/47623/events,https://github.com/rails/rails/pull/47623,1618025444,PR_kwDNIULOS7fGtA,47623,Introduce `bin/rails clear` command for clearing logs,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,8,2023-03-09T21:34:01Z,2023-04-01T20:31:08Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47623', 'html_url': 'https://github.com/rails/rails/pull/47623', 'diff_url': 'https://github.com/rails/rails/pull/47623.diff', 'patch_url': 'https://github.com/rails/rails/pull/47623.patch', 'merged_at': None}","Currently we use both Thor and Rake for `bin/rails` commands.
We eventually want to get all the built-in tasks promoted to Thor Commands:
https://github.com/rails/rails/pull/47610#issuecomment-1461520271
This migrates the `log:clear` task to Thor.

Currently logs and the tmp directory can be cleared with a single invocation:

```bash
bin/rails log:clear tmp:clear
```

With Thor we can't run multiple commands with a single invocation, as
additional commands will be seen as arguments to the first command.

This introduces a single `clear` command that will combine the existing
`log:clear` and `tmp:clear` commands. For now it's limited to clearing logs:

```bash
bin/rails clear --logs
```

The `--logs` option also supports passing `all` or a list of environments:

```bash
bin/rails log:clear --logs all # similar to `bin/rails log:clear LOGS=all`
bin/rails log:clear --logs development test # similar to `bin/rails log:clear LOGS=development,test`
```

Thor doesn't support Rake's FileList, so for truncating all log files we
use a glob pattern and filter out directories.


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47623/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47623/timeline,,
https://api.github.com/repos/rails/rails/issues/47620,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47620/labels{/name},https://api.github.com/repos/rails/rails/issues/47620/comments,https://api.github.com/repos/rails/rails/issues/47620/events,https://github.com/rails/rails/pull/47620,1617977782,PR_kwDNIULOS7cjJQ,47620,Add more guidance for people who are creating their first Rails app,"{'login': 'bradgessler', 'id': 4628, 'node_id': 'MDQ6VXNlcjQ2Mjg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4628?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bradgessler', 'html_url': 'https://github.com/bradgessler', 'followers_url': 'https://api.github.com/users/bradgessler/followers', 'following_url': 'https://api.github.com/users/bradgessler/following{/other_user}', 'gists_url': 'https://api.github.com/users/bradgessler/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bradgessler/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bradgessler/subscriptions', 'organizations_url': 'https://api.github.com/users/bradgessler/orgs', 'repos_url': 'https://api.github.com/users/bradgessler/repos', 'events_url': 'https://api.github.com/users/bradgessler/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bradgessler/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,7,2023-03-09T20:51:48Z,2023-03-29T14:27:31Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47620', 'html_url': 'https://github.com/rails/rails/pull/47620', 'diff_url': 'https://github.com/rails/rails/pull/47620.diff', 'patch_url': 'https://github.com/rails/rails/pull/47620.patch', 'merged_at': None}","### Motivation / Background

I tweeted at https://twitter.com/bradgessler/status/1630655637096108032 that with relatively low effort, Rails could be more welcoming to new folks if we can give them a little more guidance. I expanded on that thought a bit with the post at https://fly.io/ruby-dispatch/little-gestures-of-confidence/.

Both of those links should be sufficient to describe the motivation and background.

### Detail

Adds a blurb to `rails new` that tells people to boot the server or enter `rails help`

```
$ rails new hello-rails
# stuff happens...
Appending: pin ""@hotwired/stimulus-loading"", to: ""stimulus-loading.js"", preload: true
      append  config/importmap.rb
Pin all controllers
Appending: pin_all_from ""app/javascript/controllers"", under: ""controllers""
      append  config/importmap.rb

Rails project created and dependencies installed.

Now switch to the directory where the Rails app was created:

  $ cd hello-rails

Then boot the development server:

  $ ./bin/rails server

You can always get help by running:

  $ ./bin/rails help
```

Adds a blurb to the rails welcome screen that tells people where they can find their code:

<img width=""1185"" alt=""image"" src=""https://user-images.githubusercontent.com/4628/224154034-71fa4ab1-eeea-4e32-b18b-d4795594c6c5.png"">

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47620/reactions', 'total_count': 12, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 12, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47620/timeline,,
https://api.github.com/repos/rails/rails/issues/47599,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47599/labels{/name},https://api.github.com/repos/rails/rails/issues/47599/comments,https://api.github.com/repos/rails/rails/issues/47599/events,https://github.com/rails/rails/pull/47599,1614274807,PR_kwDNIULOS4T_5A,47599,Ignore joins on #and calls,"{'login': 'marcelobarreto', 'id': 1276556, 'node_id': 'MDQ6VXNlcjEyNzY1NTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1276556?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/marcelobarreto', 'html_url': 'https://github.com/marcelobarreto', 'followers_url': 'https://api.github.com/users/marcelobarreto/followers', 'following_url': 'https://api.github.com/users/marcelobarreto/following{/other_user}', 'gists_url': 'https://api.github.com/users/marcelobarreto/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/marcelobarreto/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/marcelobarreto/subscriptions', 'organizations_url': 'https://api.github.com/users/marcelobarreto/orgs', 'repos_url': 'https://api.github.com/users/marcelobarreto/repos', 'events_url': 'https://api.github.com/users/marcelobarreto/events{/privacy}', 'received_events_url': 'https://api.github.com/users/marcelobarreto/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,5,2023-03-07T22:01:33Z,2023-03-27T23:36:40Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47599', 'html_url': 'https://github.com/rails/rails/pull/47599', 'diff_url': 'https://github.com/rails/rails/pull/47599.diff', 'patch_url': 'https://github.com/rails/rails/pull/47599.patch', 'merged_at': None}","### Motivation / Background

`#and` and `#or` should support different behaviours when joining, this PR fixes that. 

Also, I would like to get some suggestion about what to do with, is that okay how is now?

```ruby
def structurally_compatible?(other)
  structurally_incompatible_values_for(other, STRUCTURAL_VALUE_METHODS_FOR_OR).empty?
end
```

### Detail

This PR closes #47571 

This PR changes the constant that checks the structural pattern to allow or not the and/or to be completed and now each one have their one check.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47599/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47599/timeline,,
https://api.github.com/repos/rails/rails/issues/47598,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47598/labels{/name},https://api.github.com/repos/rails/rails/issues/47598/comments,https://api.github.com/repos/rails/rails/issues/47598/events,https://github.com/rails/rails/pull/47598,1614045272,PR_kwDNIULOS4HnJw,47598,Fix `NoMethodError` when testing content_type of `nil`,"{'login': 'rubendinho', 'id': 12505660, 'node_id': 'MDQ6VXNlcjEyNTA1NjYw', 'avatar_url': 'https://avatars.githubusercontent.com/u/12505660?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rubendinho', 'html_url': 'https://github.com/rubendinho', 'followers_url': 'https://api.github.com/users/rubendinho/followers', 'following_url': 'https://api.github.com/users/rubendinho/following{/other_user}', 'gists_url': 'https://api.github.com/users/rubendinho/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rubendinho/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rubendinho/subscriptions', 'organizations_url': 'https://api.github.com/users/rubendinho/orgs', 'repos_url': 'https://api.github.com/users/rubendinho/repos', 'events_url': 'https://api.github.com/users/rubendinho/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rubendinho/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,1,2023-03-07T19:10:54Z,2023-03-27T06:32:56Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47598', 'html_url': 'https://github.com/rails/rails/pull/47598', 'diff_url': 'https://github.com/rails/rails/pull/47598.diff', 'patch_url': 'https://github.com/rails/rails/pull/47598.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because if a test case sets `request.content_type = nil`, the test will raise an unexpected `NoMethodError` since the `when nil` case is not reachable.


### Detail

This Pull Request changes the `content_type` check in `GET` requests. 

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

I did not see relevant tests for this functionality, but I'm not sure if they're needed given what this is touching. 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47598/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47598/timeline,,
https://api.github.com/repos/rails/rails/issues/47596,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47596/labels{/name},https://api.github.com/repos/rails/rails/issues/47596/comments,https://api.github.com/repos/rails/rails/issues/47596/events,https://github.com/rails/rails/pull/47596,1613861277,PR_kwDNIULOS39qcA,47596,Ignore action on scopes,"{'login': 'marcelobarreto', 'id': 1276556, 'node_id': 'MDQ6VXNlcjEyNzY1NTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1276556?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/marcelobarreto', 'html_url': 'https://github.com/marcelobarreto', 'followers_url': 'https://api.github.com/users/marcelobarreto/followers', 'following_url': 'https://api.github.com/users/marcelobarreto/following{/other_user}', 'gists_url': 'https://api.github.com/users/marcelobarreto/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/marcelobarreto/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/marcelobarreto/subscriptions', 'organizations_url': 'https://api.github.com/users/marcelobarreto/orgs', 'repos_url': 'https://api.github.com/users/marcelobarreto/repos', 'events_url': 'https://api.github.com/users/marcelobarreto/events{/privacy}', 'received_events_url': 'https://api.github.com/users/marcelobarreto/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-07T17:04:42Z,2023-03-08T20:47:33Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47596', 'html_url': 'https://github.com/rails/rails/pull/47596', 'diff_url': 'https://github.com/rails/rails/pull/47596.diff', 'patch_url': 'https://github.com/rails/rails/pull/47596.patch', 'merged_at': None}","### Motivation / Background

This pull request fixes #47576

### Detail

I noticed that the default scope was override the action, I also tried a different approach changing the param `to` before passing it to the method but it looks like it could be a large problem than it looked like at first. So this place looks like the better one to me.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47596/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47596/timeline,,
https://api.github.com/repos/rails/rails/issues/47589,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47589/labels{/name},https://api.github.com/repos/rails/rails/issues/47589/comments,https://api.github.com/repos/rails/rails/issues/47589/events,https://github.com/rails/rails/pull/47589,1612004853,PR_kwDNIULOS2ZYyg,47589,Improve custom Rake task documentation [ci-skip],"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2023-03-06T18:35:54Z,2023-03-09T21:56:06Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47589', 'html_url': 'https://github.com/rails/rails/pull/47589', 'diff_url': 'https://github.com/rails/rails/pull/47589.diff', 'patch_url': 'https://github.com/rails/rails/pull/47589.patch', 'merged_at': None}","It's currently unclear that custom Rake tasks can be called through the `bin/rails` command. By documenting its usage in the Rakefile we can make things more clear.
This also replaces the less used `capistrano` example with a more generic example.

### Motivation / Background

This was inspired by the following blog post, where the author was confused by the difference between `rake` and `rails`.
https://dev.to/youngbloodcyb/rake-junior-rails-review-13cc

cc @youngbloodcyb

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47589/reactions', 'total_count': 3, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 3, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47589/timeline,,
https://api.github.com/repos/rails/rails/issues/47576,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47576/labels{/name},https://api.github.com/repos/rails/rails/issues/47576/comments,https://api.github.com/repos/rails/rails/issues/47576/events,https://github.com/rails/rails/issues/47576,1609828664,I_kwDNIULOX_QJOA,47576,The action: option specified for a route under scope with action: is ignored,"{'login': 'YusukeTakeuchi', 'id': 21221942, 'node_id': 'MDQ6VXNlcjIxMjIxOTQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/21221942?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/YusukeTakeuchi', 'html_url': 'https://github.com/YusukeTakeuchi', 'followers_url': 'https://api.github.com/users/YusukeTakeuchi/followers', 'following_url': 'https://api.github.com/users/YusukeTakeuchi/following{/other_user}', 'gists_url': 'https://api.github.com/users/YusukeTakeuchi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/YusukeTakeuchi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/YusukeTakeuchi/subscriptions', 'organizations_url': 'https://api.github.com/users/YusukeTakeuchi/orgs', 'repos_url': 'https://api.github.com/users/YusukeTakeuchi/repos', 'events_url': 'https://api.github.com/users/YusukeTakeuchi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/YusukeTakeuchi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-04T15:25:05Z,2023-03-27T05:58:04Z,,NONE,,,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""rails"", ""~> 7.0.0""
end

require ""rack/test""
require ""action_controller/railtie""

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""example.org""
  config.session_store :cookie_store, key: ""cookie_store_key""
  secrets.secret_key_base = ""secret_key_base""

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    resources :tests do
      scope action: :scope_action do
        get :foo, action: :foo_action
      end
    end
  end
end

class TestsController < ActionController::Base
  include Rails.application.routes.url_helpers

  def foo_action
    render plain: ""Home""
  end

  def scope_action
    raise 'scope_action called'
  end
end

require ""minitest/autorun""

class BugTest < Minitest::Test
  include Rack::Test::Methods

  def test_returns_success
    get ""/tests/2/foo""
    assert last_response.ok?
  end

  private
    def app
      Rails.application
    end
end
```

### Expected behavior
`TestsController#foo_action` is called and returns ok.

### Actual behavior
`TestsController#scope_action` is called.
```
I, [2023-03-05T00:04:39.266468 #38680]  INFO -- : Started GET ""/tests/2/foo"" for 127.0.0.1 at 2023-03-05 00:04:39 +0900
F, [2023-03-05T00:04:39.414911 #38680] FATAL -- :   
RuntimeError (scope_action called):
```

### System configuration
**Rails version**: 7.0.4.2

**Ruby version**: 3.0.4
","{'url': 'https://api.github.com/repos/rails/rails/issues/47576/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47576/timeline,,
https://api.github.com/repos/rails/rails/issues/47574,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47574/labels{/name},https://api.github.com/repos/rails/rails/issues/47574/comments,https://api.github.com/repos/rails/rails/issues/47574/events,https://github.com/rails/rails/issues/47574,1609391423,I_kwDNIULOX-1dPw,47574,Inverses are not properly set for belongs_to associations using foreign keys and scopes,"{'login': 'andrewberls', 'id': 644004, 'node_id': 'MDQ6VXNlcjY0NDAwNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/644004?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/andrewberls', 'html_url': 'https://github.com/andrewberls', 'followers_url': 'https://api.github.com/users/andrewberls/followers', 'following_url': 'https://api.github.com/users/andrewberls/following{/other_user}', 'gists_url': 'https://api.github.com/users/andrewberls/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/andrewberls/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/andrewberls/subscriptions', 'organizations_url': 'https://api.github.com/users/andrewberls/orgs', 'repos_url': 'https://api.github.com/users/andrewberls/repos', 'events_url': 'https://api.github.com/users/andrewberls/events{/privacy}', 'received_events_url': 'https://api.github.com/users/andrewberls/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,1,2023-03-03T23:17:35Z,2023-03-26T22:10:22Z,,NONE,,,,"### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  # See note; bug was introduced in 6.1.0 and persists through HEAD
  gem ""activerecord"", ""~> 6.1.7.2""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :authors, force: true do |t|
    t.string :token
  end

  create_table :posts, force: true do |t|
    t.string :author_token
    t.string :status
  end
end

class Author < ActiveRecord::Base
  has_one :post,
    -> { where(status: 'published') },
    primary_key: :token,
    foreign_key: :author_token,
    inverse_of: :author
end

class Post < ActiveRecord::Base
  belongs_to :author,
    primary_key: :token,
    foreign_key: :author_token
end

class BugTest < Minitest::Test
  def test_inversing
    author = Author.create!(token: 'A-123')
    Post.create!(author: author, status: 'published')

    assert_equal author.post.author.object_id, author.object_id
  end
end
```

I also have a skeleton repo demonstrating this issue [here](https://github.com/andrewberls/rails_6_1_association_inverse_bug), with branches showing failure for versions >= 6.1.0.

### Expected behavior
The `Post#author` association should be inversed, and `author.post.author.object_id` should exactly equal `author.object_id`

### Actual behavior
The association does not inverse and the DB is queried to retrieve `post.author`.

I believe the bug was introduced in https://github.com/rails/rails/commit/c6f46564771413f4a06703fc6b1f82ed09a0c4c9 as part of 6.1.0, and exists through HEAD as the code has not changed. In this instance we can see are comparing the foreign key attribute (`token`) to the ID [here](https://github.com/rails/rails/blob/f0c5e60aed8bdce96c385cad05b1e34d7d757038/activerecord/lib/active_record/associations/association.rb#L353), which clearly fails and thus the association is not properly considered `inversable?`.

Comparing instead to `record.send(reflection.association_primary_key)` may fix although I am not familiar with Rails internals and would need some assistance to submit a properly-scoped and tested PR.

The bug is NOT observed in the absence of a scope; specifically only the `set_inverse_instance_from_queries` pathway  seems to demonstrate the bug.

### System configuration
**Rails version**: The spec demonstrates **6.1.7.2** but fails beginning at **6.1.0** and persists through **HEAD**

**Ruby version**: 2.7.6 (bug also present on 3.0.x)

Thank you!
","{'url': 'https://api.github.com/repos/rails/rails/issues/47574/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47574/timeline,,
https://api.github.com/repos/rails/rails/issues/47571,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47571/labels{/name},https://api.github.com/repos/rails/rails/issues/47571/comments,https://api.github.com/repos/rails/rails/issues/47571/events,https://github.com/rails/rails/issues/47571,1608670320,I_kwDNIULOX-JccA,47571,Support for combining structurally incompatible relations with `and`,"{'login': 'maxnotarangelo', 'id': 2966419, 'node_id': 'MDQ6VXNlcjI5NjY0MTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2966419?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maxnotarangelo', 'html_url': 'https://github.com/maxnotarangelo', 'followers_url': 'https://api.github.com/users/maxnotarangelo/followers', 'following_url': 'https://api.github.com/users/maxnotarangelo/following{/other_user}', 'gists_url': 'https://api.github.com/users/maxnotarangelo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maxnotarangelo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maxnotarangelo/subscriptions', 'organizations_url': 'https://api.github.com/users/maxnotarangelo/orgs', 'repos_url': 'https://api.github.com/users/maxnotarangelo/repos', 'events_url': 'https://api.github.com/users/maxnotarangelo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maxnotarangelo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2023-03-03T13:45:15Z,2023-05-07T09:07:15Z,,CONTRIBUTOR,,,,"To combine multiple relations, you can use `relation.merge`, which has no problem when the two relations are joined to different tables, have different preloading, etc. When the relations both have a `where` clause for the same key, the second relation's condition is used, just like `Hash.merge`:

https://github.com/rails/rails/blob/556025d94b13ef76ec4bed26ccb62f37ef360220/activerecord/test/cases/relation/merging_test.rb#L113

The behavior I want is to keep both filters. As far as I can tell, this is how `merge` used to work, at least in most cases (see https://github.com/rails/rails/pull/39328). The `and` method was added in Rails 6.1 as a replacement (see https://github.com/rails/rails/pull/39558):

https://github.com/rails/rails/blob/556025d94b13ef76ec4bed26ccb62f37ef360220/activerecord/test/cases/relation/merging_test.rb#L115

However, it won't let you combine two relations if they're ""structurally incompatible"": if the two relations are joined to different tables, have different preloading, etc. This means that if you have a join or preloading on one of the relations, you can't combine them with `and`:

<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :categories, force: true do |t|
  end

  create_table :posts, force: true do |t|
    t.integer :category_id
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.integer :score
  end
end

class Category < ActiveRecord::Base
  has_many :posts
  has_many :quality_comments, -> { where(score: 4..6) }, through: :posts, source: :comments
end

class Post < ActiveRecord::Base
  belongs_to :category
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
end

class RelationAndTest < Minitest::Test
  def test_relation_and
    category = Category.create!
    post = Post.create!(category:)
    post.comments << Comment.create!(score: 3)
    post.comments << Comment.create!(score: 4)
    post.comments << Comment.create!(score: 5)

    mediocre_comments = Comment.where(score: 2..4)

    merged = mediocre_comments.merge(category.quality_comments)
    assert_equal [4, 5], merged.pluck(:score).sort

    anded = mediocre_comments.and(category.quality_comments)
    # => raises ArgumentError: Relation passed to #and must be structurally compatible. Incompatible values: [:joins]
  end
end
```

I was able to work around it by using `merge` and then combining the where relations manually:

```ruby
combined_wheres = mediocre_comments.where_clause | category.quality_comments.where_clause
valid_anded = merged
valid_anded.where_clause = combined_wheres
assert_equal [4], valid_anded.pluck(:score)
```

I'd rather just be able to use `and`, but I don't know if there's some reason that combining all the non-filtering parts of two relations would cause problems for `and` that it doesn't cause for `merge`.

### System configuration
**Rails version**: 7.1.0
**Ruby version**: 3.1.1","{'url': 'https://api.github.com/repos/rails/rails/issues/47571/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47571/timeline,,
https://api.github.com/repos/rails/rails/issues/47559,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47559/labels{/name},https://api.github.com/repos/rails/rails/issues/47559/comments,https://api.github.com/repos/rails/rails/issues/47559/events,https://github.com/rails/rails/issues/47559,1607337313,I_kwDNIULOX84FYQ,47559,Attempting to save duplicate records with has_many_inversing enabled leads to SQL error,"{'login': 'jhottenstein', 'id': 302333, 'node_id': 'MDQ6VXNlcjMwMjMzMw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/302333?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jhottenstein', 'html_url': 'https://github.com/jhottenstein', 'followers_url': 'https://api.github.com/users/jhottenstein/followers', 'following_url': 'https://api.github.com/users/jhottenstein/following{/other_user}', 'gists_url': 'https://api.github.com/users/jhottenstein/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jhottenstein/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jhottenstein/subscriptions', 'organizations_url': 'https://api.github.com/users/jhottenstein/orgs', 'repos_url': 'https://api.github.com/users/jhottenstein/repos', 'events_url': 'https://api.github.com/users/jhottenstein/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jhottenstein/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2023-03-02T19:01:03Z,2023-07-04T12:13:21Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
When attempting to build multiple in-memory associations from an AR object to the same in-memory AR object:
- with ActiveRecord::Base.has_many_inversing = true
- when explicitly including  `inverse_of:` on the `belongs_to`

activerecord generates sql that loses the association to the original AR object

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)
ActiveRecord::Base.has_many_inversing = true

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.references :post, null: false
    t.references :author, null: false
  end

  create_table :authors, force: true do |t|
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Author < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post, inverse_of: :comments
  belongs_to :author, inverse_of: :comments
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.new
    author = Author.new
    post.comments.build(author: author)
    post.comments.build(author: author)

    post.save! 
  end
end

```

### Expected behavior
This case is similar to https://github.com/rails/rails/issues/43222 so I would expect the second comments.build command to be a NOOP as it is trying to make another link to the same author.  

It would also be understandable if there were multiple comments rows created with the same author and post.

### Actual behavior
When attempting to save the second comment, activerecord omits the post_id and it fails on NOT NULL constraint.
```
D, [2023-03-02T13:44:04.811276 #52249] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2023-03-02T13:44:04.811336 #52249] DEBUG -- :   Post Create (0.1ms)  INSERT INTO ""posts"" DEFAULT VALUES
D, [2023-03-02T13:44:04.811591 #52249] DEBUG -- :   Author Create (0.0ms)  INSERT INTO ""authors"" DEFAULT VALUES
D, [2023-03-02T13:44:04.811787 #52249] DEBUG -- :   Comment Create (0.0ms)  INSERT INTO ""comments"" (""post_id"", ""author_id"") VALUES (?, ?)  [[""post_id"", 1], [""author_id"", 1]]
D, [2023-03-02T13:44:04.812018 #52249] DEBUG -- :   Comment Create (0.1ms)  INSERT INTO ""comments"" (""author_id"") VALUES (?)  [[""author_id"", 1]]
D, [2023-03-02T13:44:04.812076 #52249] DEBUG -- :   TRANSACTION (0.0ms)  rollback transaction

Error:
BugTest#test_association_stuff:
ActiveRecord::NotNullViolation: SQLite3::ConstraintException: NOT NULL constraint failed: comments.post_id
```
If there are no NOT NULL constraints, it eventually gets the association correct with an UPDATE statement
```
D, [2023-03-02T14:00:24.734133 #52815] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2023-03-02T14:00:24.734195 #52815] DEBUG -- :   Post Create (0.1ms)  INSERT INTO ""posts"" DEFAULT VALUES
D, [2023-03-02T14:00:24.734628 #52815] DEBUG -- :   Author Create (0.0ms)  INSERT INTO ""authors"" DEFAULT VALUES
D, [2023-03-02T14:00:24.734831 #52815] DEBUG -- :   Comment Create (0.0ms)  INSERT INTO ""comments"" (""post_id"", ""author_id"") VALUES (?, ?)  [[""post_id"", 1], [""author_id"", 1]]
D, [2023-03-02T14:00:24.734968 #52815] DEBUG -- :   Comment Create (0.0ms)  INSERT INTO ""comments"" (""author_id"") VALUES (?)  [[""author_id"", 1]]
D, [2023-03-02T14:00:24.735838 #52815] DEBUG -- :   Comment Update (0.0ms)  UPDATE ""comments"" SET ""post_id"" = ? WHERE ""comments"".""id"" = ?  [[""post_id"", 1], [""id"", 2]]
D, [2023-03-02T14:00:24.735919 #52815] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
```


### System configuration
**Rails version**:
Above repro is from main template.  Can repro all versions that include has_many_inversing (back to 6.1)
**Ruby version**:
ruby 3.1.3p185 (2022-11-24 revision 1a6b16756e) [arm64-darwin22]","{'url': 'https://api.github.com/repos/rails/rails/issues/47559/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47559/timeline,,
https://api.github.com/repos/rails/rails/issues/47558,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47558/labels{/name},https://api.github.com/repos/rails/rails/issues/47558/comments,https://api.github.com/repos/rails/rails/issues/47558/events,https://github.com/rails/rails/issues/47558,1607092968,I_kwDNIULOX8pK6A,47558,`belongs_to` relation SQL merges with and overwrites the `default_scope`,"{'login': 'JeremyC-za', 'id': 21086480, 'node_id': 'MDQ6VXNlcjIxMDg2NDgw', 'avatar_url': 'https://avatars.githubusercontent.com/u/21086480?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JeremyC-za', 'html_url': 'https://github.com/JeremyC-za', 'followers_url': 'https://api.github.com/users/JeremyC-za/followers', 'following_url': 'https://api.github.com/users/JeremyC-za/following{/other_user}', 'gists_url': 'https://api.github.com/users/JeremyC-za/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JeremyC-za/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JeremyC-za/subscriptions', 'organizations_url': 'https://api.github.com/users/JeremyC-za/orgs', 'repos_url': 'https://api.github.com/users/JeremyC-za/repos', 'events_url': 'https://api.github.com/users/JeremyC-za/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JeremyC-za/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-03-02T16:11:47Z,2023-08-30T17:47:55Z,,NONE,,,,"### Steps to reproduce
I've only tested this with a `belongs_to` relation, I'm not sure if there are similar issues with other relations. It looks like the default scope conditions are being merged with and overwritten by the relation sql conditions when they are dealing with the same column (most commonly `id`).

I have seen from [this commit](https://github.com/rails/rails/commit/159cc3421ce1963cb10e98920b621fb327fd87a6) that the intended behaviour going forward is that the latter condition replaces former, but it doesn't seem like that makes sense in the case of the default scope. I'd expect the default scope to take precedence.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # gem ""rails"", github: ""rails/rails"", branch: ""6-0-stable""
  # gem ""rails"", github: ""rails/rails"", branch: ""6-1-stable""
  # gem ""rails"", github: ""rails/rails"", branch: ""7-0-stable""
  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
  gem ""pry""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_many :comments

  # The same scope defined in different ways.
  SCOPES = {
    scope_1: -> { $scope_active ? where(table[:id].eq(20)) : nil },
    scope_2: -> { $scope_active ? where(table[""id""].eq(20)) : nil },
    scope_3: -> { $scope_active ? where(id: 20) : nil },
    scope_4: -> { $scope_active ? where(""id"" => 20) : nil },
    scope_5: -> { $scope_active ? where(""id = ?"", 20) : nil },
    scope_6: -> { $scope_active ? where(""id IN (?)"", [20]) : nil },
    scope_7: -> { $scope_active ? where(""#{self.klass.table_name}.id = ?"", 20) : nil },
  }

  def self.set_default_scope(scope_key)
    default_scope SCOPES[scope_key]
  end
end

class Comment < ActiveRecord::Base
  belongs_to :post
end

class BugTest < Minitest::Test
  def test_default_scope_bug
    # Default unscoped case
    $scope_active = false
    post = Post.create!
    comment = Comment.create!(post_id: post.id)
    assert Post.find_by_id(post.id)
    assert Comment.find(comment.id).post

    # Test each default scope
    $scope_active = true
    Post::SCOPES.keys.each do |scope_key|
      puts scope_key
      Post.default_scopes = [] # Clear them each time.
      Post.set_default_scope(scope_key)

      assert_nil Post.find_by_id(post.id), ""Post should be scoped to id == 20 (#{scope_key})""
      assert_nil Comment.find(comment.id).post, ""Relation sql should not overwrite default scope (#{scope_key})""
    end
  end
end
```

### Expected behavior
I'd expect the Post that was created at the beginning of the test (with `id == 1`) should never be reachable due to the default scope restricting all queries to `id == 20`. This should apply when selecting the Post directly, and through the Comment's relation.

### Actual behavior
Finding the Post directly does respect the default scope, but `comment.post` ignores (merges and overwrites) it. This is the SQL from the final two `assert_nil` commands for `scope_1`:
```sql
-- Post.find_by_id(post.id)
Post Load (0.1ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" = 20 AND ""posts"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]

-- Comment.find(comment.id).post
Comment Load (0.0ms)  SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
Post Load (0.0ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
```


### System configuration
**Rails version**: >= 6.0

**Ruby version**: 2.7.0
","{'url': 'https://api.github.com/repos/rails/rails/issues/47558/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47558/timeline,,
https://api.github.com/repos/rails/rails/issues/47555,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47555/labels{/name},https://api.github.com/repos/rails/rails/issues/47555/comments,https://api.github.com/repos/rails/rails/issues/47555/events,https://github.com/rails/rails/issues/47555,1606880343,I_kwDNIULOX8cMVw,47555,`counter_cache` is double incremented with disabled partial_inserts.,"{'login': 'konalegi', 'id': 1387057, 'node_id': 'MDQ6VXNlcjEzODcwNTc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1387057?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/konalegi', 'html_url': 'https://github.com/konalegi', 'followers_url': 'https://api.github.com/users/konalegi/followers', 'following_url': 'https://api.github.com/users/konalegi/following{/other_user}', 'gists_url': 'https://api.github.com/users/konalegi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/konalegi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/konalegi/subscriptions', 'organizations_url': 'https://api.github.com/users/konalegi/orgs', 'repos_url': 'https://api.github.com/users/konalegi/repos', 'events_url': 'https://api.github.com/users/konalegi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/konalegi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2023-03-02T14:12:22Z,2023-08-04T21:11:15Z,,NONE,,,,"### Steps to reproduce

This happens only when defined with `has_many through` association and with `partial_inserts` set to `false`

The query difference with enabled and disable partial_inserts 
with enabled
```
Step Create (0.1ms)  INSERT INTO ""steps"" DEFAULT VALUES
Step Update All (0.1ms)  UPDATE ""steps"" SET ""specializations_count"" = COALESCE(""specializations_count"", 0) + ? WHERE ""steps"".""id"" = ?  [[""specializations_count"", 1], [""id"", 1]]
```

with disabled 
```
Step Create (0.1ms)  INSERT INTO ""steps"" (""specializations_count"") VALUES (?)  [[""specializations_count"", 1]]
Step Update All (0.1ms)  UPDATE ""steps"" SET ""specializations_count"" = COALESCE(""specializations_count"", 0) + ? WHERE ""steps"".""id"" = ?  [[""specializations_count"", 1], [""id"", 1]]
```

As you might see, with disabled `partial_inserts`, `specializations_count` is set to `1`, but when enabled, it's set to its default value.

```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  gem ""rails"", '~> 7.0.4.2'
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)
ActiveRecord::Base.partial_inserts = false

ActiveRecord::Schema.define do
  create_table :steps, force: true do |t|
    t.integer ""specializations_count"", default: 0
  end

  create_table :specialization_steps, force: true do |t|
    t.integer ""specialization_id"", null: false
    t.integer ""step_id"", null: false
  end

  create_table :specializations, force: true do |t|
  end
end

class SpecializationStep < ActiveRecord::Base
  belongs_to :specialization
  belongs_to :step, counter_cache: :specializations_count
end

class Step < ActiveRecord::Base
  has_many :specialization_steps
  has_many :specializations, through: :specialization_steps, counter_cache: :specializations_count
end

class Specialization < ActiveRecord::Base
  has_many :specialization_steps
  has_many :steps, through: :specialization_steps
end

class BugTest < Minitest::Test
  def test_1
    step = Step.create!(specializations: [Specialization.create!])

    assert_equal 1, step.reload.specializations_count
  end

  def test_2
    step = Step.new(specializations: [Specialization.create!])
    assert_equal 1, step.specializations_count
  end
end
```

### Expected behavior
```
.

Finished in 0.021899s, 91.3284 runs/s, 91.3284 assertions/s.
2 runs, 2 assertions, 0 failures, 0 errors, 0 skips
```

### Actual behavior
```
F

Failure:
BugTest#test_1 [reproduce_github.rb:51]:
Expected: 1
  Actual: 2
```

### System configuration
**Rails version**: 7.0.4.2

**Ruby version**:  ruby 3.0.4p208 (2022-04-12 revision 3fa771dded) [x86_64-darwin20]
","{'url': 'https://api.github.com/repos/rails/rails/issues/47555/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47555/timeline,,
https://api.github.com/repos/rails/rails/issues/47521,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47521/labels{/name},https://api.github.com/repos/rails/rails/issues/47521/comments,https://api.github.com/repos/rails/rails/issues/47521/events,https://github.com/rails/rails/issues/47521,1601842079,I_kwDNIULOX3ornw,47521,saved_changes from ActiveRecord::Dirty does not include some changes on nested attributes,"{'login': 'Tao-Galasse', 'id': 32199278, 'node_id': 'MDQ6VXNlcjMyMTk5Mjc4', 'avatar_url': 'https://avatars.githubusercontent.com/u/32199278?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Tao-Galasse', 'html_url': 'https://github.com/Tao-Galasse', 'followers_url': 'https://api.github.com/users/Tao-Galasse/followers', 'following_url': 'https://api.github.com/users/Tao-Galasse/following{/other_user}', 'gists_url': 'https://api.github.com/users/Tao-Galasse/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Tao-Galasse/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Tao-Galasse/subscriptions', 'organizations_url': 'https://api.github.com/users/Tao-Galasse/orgs', 'repos_url': 'https://api.github.com/users/Tao-Galasse/repos', 'events_url': 'https://api.github.com/users/Tao-Galasse/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Tao-Galasse/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2023-02-27T19:50:37Z,2023-05-31T14:21:23Z,,NONE,,,,"### Steps to reproduce

I have those two classes (same example than the `has_one` association documentation from the [Active Record Associations guide](https://guides.rubyonrails.org/association_basics.html)) : 
```ruby
class Supplier < ApplicationRecord
  has_one :account, inverse_of: :supplier
end

class Account < ApplicationRecord
  belongs_to :supplier, inverse_of: :account
  accepts_nested_attributes_for :supplier
end

```
and I am updating the supplier from the account like this : `account.update(supplier_attributes: { name: 'new supplier' })`

See this test in my dummy app => https://github.com/Tao-Galasse/rails-test-app/blob/main/test/models/account_test.rb

### Expected behavior
I expect `account.saved_changes` to return something like `{""supplier_id""=>[1, 2]}`

### Actual behavior
`account.saved_changes` returns an empty hash `{}`

### System configuration
**Rails version**:
Tested with Rails 6.1.7.2 & Rails 7.0.4.2

**Ruby version**:
3.2.0","{'url': 'https://api.github.com/repos/rails/rails/issues/47521/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47521/timeline,,
https://api.github.com/repos/rails/rails/issues/47498,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47498/labels{/name},https://api.github.com/repos/rails/rails/issues/47498/comments,https://api.github.com/repos/rails/rails/issues/47498/events,https://github.com/rails/rails/issues/47498,1599050728,I_kwDNIULOX0-T6A,47498,`ActiveRecord::StrictLoadingViolationError` raised on `has_one :through` associations,"{'login': 'MatheusRich', 'id': 20938712, 'node_id': 'MDQ6VXNlcjIwOTM4NzEy', 'avatar_url': 'https://avatars.githubusercontent.com/u/20938712?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/MatheusRich', 'html_url': 'https://github.com/MatheusRich', 'followers_url': 'https://api.github.com/users/MatheusRich/followers', 'following_url': 'https://api.github.com/users/MatheusRich/following{/other_user}', 'gists_url': 'https://api.github.com/users/MatheusRich/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/MatheusRich/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/MatheusRich/subscriptions', 'organizations_url': 'https://api.github.com/users/MatheusRich/orgs', 'repos_url': 'https://api.github.com/users/MatheusRich/repos', 'events_url': 'https://api.github.com/users/MatheusRich/events{/privacy}', 'received_events_url': 'https://api.github.com/users/MatheusRich/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2023-02-24T17:40:08Z,2023-09-29T20:28:13Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)
ActiveRecord::Base.strict_loading_by_default = true

ActiveRecord::Schema.define do
  create_table :employees, force: true do |t|
    t.integer :team_id
  end

  create_table :teams, force: true do |t|
    t.integer :company_id
  end

  create_table :companies, force: true do |t|
    t.string :name
  end
end

class Employee < ActiveRecord::Base
  belongs_to :team
  has_one :company, through: :team

  def company_name
    company.name
  end
end

class Team < ActiveRecord::Base
  has_many :employees
  belongs_to :company
end

class Company < ActiveRecord::Base
  has_many :teams
end

class BugTest < Minitest::Test
  def test_has_one_lazy_loading_raises_error
    company_name = ""test""
    company = Company.create(name: company_name)
    team = Team.create(company: company)

    # This simulates what a controller would do
    employee_params = {
      team_id: team.id
    }
    employee = Employee.new(employee_params)
    employee.save

    assert_raises(ActiveRecord::StrictLoadingViolationError) do
      employee.company_name
    end
  end
end
```

### Expected behavior

While this is not a bug, I think the development experience could be improved when using `strict_loading_by_default = true`. The main use case for this feature is to avoid N + 1 queries, which is not the case in this example (it's just lazy loading).

We can set the strict loading mode to `:n_plus_one_only` on a per-record basis to avoid the exception

```ruby
  def test_has_one_lazy_loading_with_mode_n_plus_one_only_doesnt_raise_error
    company_name = ""test""
    company = Company.create(name: company_name)
    team = Team.create(company: company)

    # This simulates what a controller would do
    employee_params = {
      team_id: team.id
    }
    employee = Employee.new(employee_params)
    employee.save
    employee.strict_loading!(mode: :n_plus_one_only) # this could be done in the `company_name` method as well

    assert_equal company_name, employee.company_name
  end
```

but doing it for every record is a bit cumbersome. Is there a way to avoid this? I'm considering the following alternatives:

1. Allow setting the strict loading mode per-model
   ```rb
   ActiveRecord::Base.strict_loading_by_default = true
   ActiveRecord::Base.strict_loading_mode = :n_plus_one_only
   ```
1. Allow setting the strict loading mode globally
   ```rb
   config.active_record.strict_loading_by_default = true
   config.active_record.strict_loading_mode = :n_plus_one_only
   ```

I'm happy to hear y'alls thoughts on this. I'm also happy to provide a patch for this.

### Actual behavior

Loading a has_one association leads to a StrictLoading violation even for non-N+1 queries.

### System configuration

**Rails version**: 7.1.0.alpha
**Ruby version**: 3.2.0","{'url': 'https://api.github.com/repos/rails/rails/issues/47498/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47498/timeline,,
https://api.github.com/repos/rails/rails/issues/47497,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47497/labels{/name},https://api.github.com/repos/rails/rails/issues/47497/comments,https://api.github.com/repos/rails/rails/issues/47497/events,https://github.com/rails/rails/pull/47497,1598899252,PR_kwDNIULOSrcJsA,47497,Batch custom orders,"{'login': 'djmb', 'id': 1734607, 'node_id': 'MDQ6VXNlcjE3MzQ2MDc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1734607?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/djmb', 'html_url': 'https://github.com/djmb', 'followers_url': 'https://api.github.com/users/djmb/followers', 'following_url': 'https://api.github.com/users/djmb/following{/other_user}', 'gists_url': 'https://api.github.com/users/djmb/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/djmb/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/djmb/subscriptions', 'organizations_url': 'https://api.github.com/users/djmb/orgs', 'repos_url': 'https://api.github.com/users/djmb/repos', 'events_url': 'https://api.github.com/users/djmb/events{/privacy}', 'received_events_url': 'https://api.github.com/users/djmb/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-02-24T16:02:56Z,2023-02-27T15:52:38Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47497', 'html_url': 'https://github.com/rails/rails/pull/47497', 'diff_url': 'https://github.com/rails/rails/pull/47497.diff', 'patch_url': 'https://github.com/rails/rails/pull/47497.patch', 'merged_at': None}","
### Motivation / Background

Adds extra order options for in_batches, so we can order by non primary key columns.

This allows you to specific orders like:

```
Comments.in_batches(order: :post_id)
Comments.in_batches(order: [:post_id, :parent_id])
Comments.in_batches(order: {post_id :asc, parent_id: desc})
Comments.joins(:post).in_batches(order: [:""posts.id"", :parent_id])
```

Ordering by primary key can be inefficient if the database needs to examine all the matched rows and sort them. Allowing custom ordering can lead to much more efficient batching queries.

### Detail

`ActiveRecord::Batches#in_batches` was fairly complicated and just plugging these changes into it would have made it a lot worse, so I've implemented this in three commits to fix that and make review easier.

1. Move most of the `in_batches` code into `ActiveRecord::Batches::BatchEnumerator`
2. Extract it from there into `ActiveRecord::Batches::BatchRelations`
3. Add the ability to custom sort orders.

**Preventing missed rows due to sort key duplication**
If the sort key provided is not unique then we may start missing rows between batches. To prevent this the primary key is appended to the end of key if it is not included in it. We could provide an argument to indicate that we know the sort by is unique to allow the caller to control this behaviour, but I haven't implemented this at the moment.

**Handling nulls**
Except for the primary key, we assume that any column listed in the orders could be NULL. We could I guess check the metadata and only do it for those that are? The batch queries are designed to correctly batch through the NULLs.

The adapter has been updated to report whether nulls are sorted first or not so we can correctly batch through them. We could instead force the order with `nulls_first` but ignoring the natural database sort order might reduce the performance benefit of the custom ordering.

**Batching queries**
When sorting just by primary key, we'll use the exact same queries as before, so there shouldn't be any change there.

When sorting by a custom order, there is an additional pluck query to grab the sort column values for the last row from the previous batch. We then construct a where statement that will continue on from the previous batch.

Assuming we are sorting by `a`, `b`, `id` (all ascending), the where clause (ignoring null handling for now) will look like this:

Given values for the last batch of a = 4, b = 6, id = 10
```
WHERE (a > 4) OR (a = 4 AND b > 6) OR (a = 4 AND b = 6 AND id > 10)
```

We can pick sorting ascending and descending, with the same example but sorting `b` descending we would have:

```
WHERE (a > 4) OR (a = 4 AND b < 6) OR (a = 4 AND b = 6 AND id > 10)
```

Null handling leads to more complicated queries. Assuming nulls are sorted first, then with a = 4, b = 6, id = 10, all sorted ascending we would get the same query as before. If however we had the values a = 4, b = NULL, id = 10, we would have

```
WHERE (a > 4) OR (a = 4 AND b IS NOT NULL) OR (a = 4 AND b IS NULL AND id > 10)
```

If b was sorted descended and we have a = 4, b = NULL, id = 10, then the query would be:

```
WHERE (a > 4) OR (a = 4 AND b IS NULL AND id > 10)
```
The second clause was removed here, since there's not going to be anything ""before"" NULL.

Finally if we have a sorted descending, b and id ascending and the values a = 4, b = NULL, id = 10, we'll have:

```
WHERE (a < 4 OR a IS NULL) OR (a = 4 AND b IS NOT NULL) OR (a = 4 AND b IS NULL AND id > 10)
```

### Additional information

I've benchmarked sorting by `:asc` to ensure that batching performance hasn't changed for that.

Here's the script:
```
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  if ENV[""BATCH_CUSTOM_ORDERS""]
    gem ""rails"", github: ""djmb/rails"", branch: ""batch-custom-orders""
  else
    gem ""rails"", github: ""rails/rails"", branch: ""main""
  end
  gem ""sqlite3""
  gem ""benchmark-ips""
  gem ""stackprof""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""
require ""stackprof""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string :text
    t.integer :number
    t.boolean :bool
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

10000.times.map do |i|
  Post.create!(text: Digest::SHA256.base64digest(i.to_s), number: i, bool: i.even?)
end

tests = {
  ""in-batches"": Post.in_batches,
  ""in-batches-no-use-ranges"": Post.in_batches(use_ranges: false),
  ""in-batches-small"": Post.in_batches(of: 10),
  ""in-batches-condition"": Post.where(bool: true).in_batches,
  ""find-each"": Post.find_each,
  ""find-each-small"": Post.find_each(batch_size: 10),
  ""find-each-condition"": Post.where(bool: true).find_each,
  ""find-in-batches"": Post.find_in_batches,
  ""find-in-batches-small"": Post.find_in_batches(batch_size: 10),
  ""find-in-batches-condition"": Post.where(bool: true).find_each
}

branch = ENV[""BATCH_CUSTOM_ORDERS""] ? ""branch"" : ""main""
results_dir = ""/tmp/custom_order_benchmarks""
FileUtils.mkdir_p(results_dir)

tests.each do |name, relation|
  Benchmark.ips do |x|
    x.time = 10
    x.report(""#{name}-#{branch}"") { relation.map { |batch| Array(batch).map(&:id) } }
    x.save!(""#{results_dir}/#{name}"")
    x.compare!
  end
end
```

And the output (from a 16GB 2021 M1 MacBook Pro):
```
$ ruby custom_batch_order_benchmark.rb && BATCH_CUSTOM_ORDERS=true ruby custom_batch_order_benchmark.rb
<SNIP>
Warming up --------------------------------------
   in-batches-branch     2.000  i/100ms
Calculating -------------------------------------
   in-batches-branch     29.347  ( 3.4%) i/s -    294.000  in  10.021589s

Comparison:
   in-batches-branch:       29.3 i/s
     in-batches-main:       29.1 i/s - same-ish: difference falls within error

Warming up --------------------------------------
in-batches-no-use-ranges-branch
                         1.000  i/100ms
Calculating -------------------------------------
in-batches-no-use-ranges-branch
                         17.206  ( 0.0%) i/s -    172.000  in  10.002446s

Comparison:
in-batches-no-use-ranges-branch:       17.2 i/s
in-batches-no-use-ranges-main:       17.2 i/s - 1.00x  slower

Warming up --------------------------------------
in-batches-small-branch
                         1.000  i/100ms
Calculating -------------------------------------
in-batches-small-branch
                          6.902  ( 0.0%) i/s -     69.000  in  10.000174s

Comparison:
in-batches-small-branch:        6.9 i/s
in-batches-small-main:        6.9 i/s - 1.00x  slower

Warming up --------------------------------------
in-batches-condition-branch
                         3.000  i/100ms
Calculating -------------------------------------
in-batches-condition-branch
                         33.527  ( 3.0%) i/s -    336.000  in  10.024163s

Comparison:
in-batches-condition-branch:       33.5 i/s
in-batches-condition-main:       33.5 i/s - same-ish: difference falls within error

Warming up --------------------------------------
    find-each-branch     2.000  i/100ms
Calculating -------------------------------------
    find-each-branch     22.541  ( 4.4%) i/s -    226.000  in  10.058540s

Comparison:
    find-each-branch:       22.5 i/s
      find-each-main:       22.5 i/s - same-ish: difference falls within error

Warming up --------------------------------------
find-each-small-branch
                         1.000  i/100ms
Calculating -------------------------------------
find-each-small-branch
                          7.641  ( 0.0%) i/s -     77.000  in  10.080318s

Comparison:
find-each-small-main:        7.7 i/s
find-each-small-branch:        7.6 i/s - 1.00x  slower

Warming up --------------------------------------
find-each-condition-branch
                         4.000  i/100ms
Calculating -------------------------------------
find-each-condition-branch
                         44.563  ( 4.5%) i/s -    448.000  in  10.089475s

Comparison:
find-each-condition-main:       44.6 i/s
find-each-condition-branch:       44.6 i/s - same-ish: difference falls within error

Warming up --------------------------------------
find-in-batches-branch
                         3.000  i/100ms
Calculating -------------------------------------
find-in-batches-branch
                         29.801  ( 6.7%) i/s -    300.000  in  10.109160s

Comparison:
find-in-batches-main:       29.9 i/s
find-in-batches-branch:       29.8 i/s - same-ish: difference falls within error

Warming up --------------------------------------
find-in-batches-small-branch
                         1.000  i/100ms
Calculating -------------------------------------
find-in-batches-small-branch
                          8.552  ( 0.0%) i/s -     86.000  in  10.059261s

Comparison:
find-in-batches-small-main:        8.6 i/s
find-in-batches-small-branch:        8.6 i/s - 1.00x  slower

Warming up --------------------------------------
find-in-batches-condition-branch
                         4.000  i/100ms
Calculating -------------------------------------
find-in-batches-condition-branch
                         44.743  ( 4.5%) i/s -    448.000  in  10.045859s

Comparison:
find-in-batches-condition-branch:       44.7 i/s
find-in-batches-condition-main:       44.6 i/s - same-ish: difference falls within error
```

","{'url': 'https://api.github.com/repos/rails/rails/issues/47497/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47497/timeline,,
https://api.github.com/repos/rails/rails/issues/47466,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47466/labels{/name},https://api.github.com/repos/rails/rails/issues/47466/comments,https://api.github.com/repos/rails/rails/issues/47466/events,https://github.com/rails/rails/pull/47466,1595875696,PR_kwDNIULOSo32Aw,47466,Return record ids additionally to the relation in `Batches#in_batches`,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2023-02-22T21:41:34Z,2023-02-23T17:45:09Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47466', 'html_url': 'https://github.com/rails/rails/pull/47466', 'diff_url': 'https://github.com/rails/rails/pull/47466.diff', 'patch_url': 'https://github.com/rails/rails/pull/47466.patch', 'merged_at': None}","Relevant - https://github.com/rails/rails/issues/47462.

Currently, `in_batches` yields only relations, but people often use something like `relation.pluck(:ids)` to get record ids inside the block to schedule a worker with ids, for example.

```ruby
# Before
User.in_batches do |relation|
  ids = relation.pluck(:id) # will perform additional SQL query
  SomeWorker.perform_async(ids)
end

# After
User.in_batches do |relation, ids|
  SomeWorker.perform_async(ids)
end
```

There was a discussion about this some time ago - https://discuss.rubyonrails.org/t/yield-record-ids-to-in-batches-block/81102.

Note: I had a need to change a few tests a bit, because `in_batches` now yields 2 values. Is this OK?

cc @nvasilevski (since you were at that discussion)","{'url': 'https://api.github.com/repos/rails/rails/issues/47466/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47466/timeline,,
https://api.github.com/repos/rails/rails/issues/47462,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47462/labels{/name},https://api.github.com/repos/rails/rails/issues/47462/comments,https://api.github.com/repos/rails/rails/issues/47462/events,https://github.com/rails/rails/issues/47462,1595518911,I_kwDNIULOXxmvvw,47462,Avoid second query on in_batches.pluck,"{'login': 'sobrinho', 'id': 26460, 'node_id': 'MDQ6VXNlcjI2NDYw', 'avatar_url': 'https://avatars.githubusercontent.com/u/26460?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sobrinho', 'html_url': 'https://github.com/sobrinho', 'followers_url': 'https://api.github.com/users/sobrinho/followers', 'following_url': 'https://api.github.com/users/sobrinho/following{/other_user}', 'gists_url': 'https://api.github.com/users/sobrinho/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sobrinho/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sobrinho/subscriptions', 'organizations_url': 'https://api.github.com/users/sobrinho/orgs', 'repos_url': 'https://api.github.com/users/sobrinho/repos', 'events_url': 'https://api.github.com/users/sobrinho/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sobrinho/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,19,2023-02-22T17:34:41Z,2023-09-21T23:56:15Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require 'bundler/inline'

gemfile do
  gem 'activerecord'
  gem 'sqlite3'
end

require 'active_record'
require 'sqlite3'

ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Base.establish_connection(
  adapter: 'sqlite3',
  database: ':memory:'
)

ActiveRecord::Base.connection.create_table :people, id: :uuid do |t|
  t.string :name
end

class Person < ActiveRecord::Base
end

data = 100_000.times.map { |i| { id: SecureRandom.uuid, name: ""Person #{i}"" } }
Person.insert_all(data)

Person.in_batches.each do |batch|
  batch.pluck(:id)
end
```

```
ruby script.rb | grep 'SELECT ""people""' | wc -l
[DEPRECATED] This Gemfile does not include an explicit global source. Not using an explicit global source may result in a different lockfile being generated depending on the gems you have installed locally before bundler is run. Instead, define a global source in your Gemfile like this: source ""https://rubygems.org"".
     201
````

### Expected behavior
I would expect to see 100 queries.

### Actual behavior
I see 200 queries, one to get the ids and a second one to get the ids from a list of ids.

### System configuration
**Rails version**: 7.0.4.2

**Ruby version**: 2.7.6
","{'url': 'https://api.github.com/repos/rails/rails/issues/47462/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 1, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47462/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/47448,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47448/labels{/name},https://api.github.com/repos/rails/rails/issues/47448/comments,https://api.github.com/repos/rails/rails/issues/47448/events,https://github.com/rails/rails/pull/47448,1593655425,PR_kwDNIULOSnBc6A,47448,Add configuration to ignore path extensions in the MIME negotiation,"{'login': 'youpy', 'id': 9128, 'node_id': 'MDQ6VXNlcjkxMjg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9128?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/youpy', 'html_url': 'https://github.com/youpy', 'followers_url': 'https://api.github.com/users/youpy/followers', 'following_url': 'https://api.github.com/users/youpy/following{/other_user}', 'gists_url': 'https://api.github.com/users/youpy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/youpy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/youpy/subscriptions', 'organizations_url': 'https://api.github.com/users/youpy/orgs', 'repos_url': 'https://api.github.com/users/youpy/repos', 'events_url': 'https://api.github.com/users/youpy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/youpy/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-02-21T15:13:23Z,2023-02-23T01:21:14Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47448', 'html_url': 'https://github.com/rails/rails/pull/47448', 'diff_url': 'https://github.com/rails/rails/pull/47448.diff', 'patch_url': 'https://github.com/rails/rails/pull/47448.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Related to #22747

This pull request adds a configuration to prevent unintended behavior in the MIME negotiation when the value of the final route segment contains ""."".

Example:

```ruby
# route
get ""/foo/:value"", to: ""foo#index"", value: /.+/

# controller
class FooController < ActionController::Base
  def index
    respond_to do |format|
      format.html { render plain: ""HTML"" }
    end
  end
end

get ""/foo/bar""      # => ""HTML""
get ""/foo/bar.html"" # => ""HTML""
get ""/foo/bar.jpg""  # => 406 error
```

### Detail

- This pull request adds a configuration `config.action_dispatch.ignore_format_from_path_extension`.
- Default value is `false`.
- If this value is set to `false`, the value of the path extension is treated as a format in the MIME negotiation. This is the same behavior as before.
- If this value is set to `true`, the value of the path extension is ignored in the MIME negotiation.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47448/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47448/timeline,,
https://api.github.com/repos/rails/rails/issues/47437,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47437/labels{/name},https://api.github.com/repos/rails/rails/issues/47437/comments,https://api.github.com/repos/rails/rails/issues/47437/events,https://github.com/rails/rails/pull/47437,1591375423,PR_kwDNIULOSlHspA,47437,Add test for Gemfile.lock after 'bundle install' finishes,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,5,2023-02-20T08:23:14Z,2023-03-29T20:32:37Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47437', 'html_url': 'https://github.com/rails/rails/pull/47437', 'diff_url': 'https://github.com/rails/rails/pull/47437.diff', 'patch_url': 'https://github.com/rails/rails/pull/47437.patch', 'merged_at': None}","This test produces the following output (but passes) on my local machine:

```
/Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/resolver.rb:293:in `raise_not_found!': Could not find gem 'rails (~> 7.1.0.alpha)' in locally installed gems. (Bundler::GemNotFound)
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/resolver.rb:346:in `block in prepare_dependencies'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/resolver.rb:331:in `each'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/resolver.rb:331:in `map'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/resolver.rb:331:in `prepare_dependencies'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/resolver.rb:51:in `setup_solver'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/resolver.rb:28:in `start'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/definition.rb:554:in `start_resolution'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/definition.rb:289:in `resolve'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/definition.rb:507:in `materialize'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/definition.rb:197:in `specs'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/definition.rb:254:in `specs_for'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/runtime.rb:18:in `setup'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler.rb:170:in `setup'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/setup.rb:20:in `block in <top (required)>'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/ui/shell.rb:159:in `with_level'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/ui/shell.rb:111:in `silence'
	from /Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/bundler/setup.rb:20:in `<top (required)>'
	from <internal:/Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/rubygems/core_ext/kernel_require.rb>:88:in `require'
	from <internal:/Users/zzak/.rubies/ruby-3.3.0/lib/ruby/3.3.0+0/rubygems/core_ext/kernel_require.rb>:88:in `require'
```

I'd like to verify bundle install finishes in CI.","{'url': 'https://api.github.com/repos/rails/rails/issues/47437/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47437/timeline,,
https://api.github.com/repos/rails/rails/issues/47430,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47430/labels{/name},https://api.github.com/repos/rails/rails/issues/47430/comments,https://api.github.com/repos/rails/rails/issues/47430/events,https://github.com/rails/rails/pull/47430,1590466622,PR_kwDNIULOSkZizA,47430,Add response fields to request.action_dispatch,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-02-18T20:51:32Z,2023-09-26T07:55:40Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47430', 'html_url': 'https://github.com/rails/rails/pull/47430', 'diff_url': 'https://github.com/rails/rails/pull/47430.diff', 'patch_url': 'https://github.com/rails/rails/pull/47430.patch', 'merged_at': None}","### Motivation / Background

Ref: #46869 

An issue was opened about Rails logging a 200 status when the actual status returned to the client was a 304 (because it was changed by Rack::ConditionalGet). This is due to requests being logged from the process_action.action_controller instrumentation, which is at the very bottom of the Rack middleware stack.

### Detail

To help fix this issue, request.action_dispatch has been improved to include response status and headers. This makes the instrumentation more usable for request logging, as the payload now contains references to almost all of the data provided in process_action.action_controller. In addition, its much higher position in the middleware stack means that it will return a ""more accurate"" status than  is available in process_action.action_controller.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47430/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47430/timeline,,
https://api.github.com/repos/rails/rails/issues/47426,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47426/labels{/name},https://api.github.com/repos/rails/rails/issues/47426/comments,https://api.github.com/repos/rails/rails/issues/47426/events,https://github.com/rails/rails/issues/47426,1589718847,I_kwDNIULOXsEvPw,47426,accepts_nested_attributes_for does not set ActiveRecord_Associations_CollectionProxy instance cache for unpersisted records until it is called using to_a,"{'login': 'sampatbadhe', 'id': 5279284, 'node_id': 'MDQ6VXNlcjUyNzkyODQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5279284?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sampatbadhe', 'html_url': 'https://github.com/sampatbadhe', 'followers_url': 'https://api.github.com/users/sampatbadhe/followers', 'following_url': 'https://api.github.com/users/sampatbadhe/following{/other_user}', 'gists_url': 'https://api.github.com/users/sampatbadhe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sampatbadhe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sampatbadhe/subscriptions', 'organizations_url': 'https://api.github.com/users/sampatbadhe/orgs', 'repos_url': 'https://api.github.com/users/sampatbadhe/repos', 'events_url': 'https://api.github.com/users/sampatbadhe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sampatbadhe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2023-02-17T17:26:02Z,2023-05-19T08:43:07Z,,CONTRIBUTOR,,,,"### Steps to reproduce

While exploring `ActiveRecord.build` with `has_many` association came across following scenario.

accepts_nested_attributes_for does not set ActiveRecord_Associations_CollectionProxy instance cache for unpersisted records until it is called using to_a, is this expected?

```
ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string :title
    t.text :body
    t.integer :user_id
  end

  create_table :users, force: true do |t|
    t.string :name
    t.string :email
  end
end

class Post < ApplicationRecord
  belongs_to :user, inverse_of: :posts
end

class User < ApplicationRecord
  has_many :posts, inverse_of: :user

  accepts_nested_attributes_for :posts
end
```

```
Loading development environment (Rails 7.1.0.alpha)
3.0.0 :001 > user = User.build(name: 'Jamie', posts_attributes: [{ title: ""Intro Post 1"" }, { title: ""Intro Post 2"" }] )
 => #<User:0x00007f929fc37cb8 id: nil, name: ""Jamie"", email: nil, created_at: nil, updated_at: nil> 
3.0.0 :002 > user.posts.class
 => Post::ActiveRecord_Associations_CollectionProxy 
3.0.0 :003 > user.posts
 => [] 
3.0.0 :004 > user.posts.to_a
 => 
[#<Post:0x00007f92a85fe708 id: nil, body: nil, title: ""Intro Post 1"", user_id: nil, created_at: nil, updated_at: nil>,
 #<Post:0x00007f92a48cd1e0 id: nil, body: nil, title: ""Intro Post 2"", user_id: nil, created_at: nil, updated_at: nil>] 
3.0.0 :005 > user.posts
 => 
[#<Post:0x00007f92a85fe708 id: nil, body: nil, title: ""Intro Post 1"", user_id: nil, created_at: nil, updated_at: nil>,
 #<Post:0x00007f92a48cd1e0 id: nil, body: nil, title: ""Intro Post 2"", user_id: nil, created_at: nil, updated_at: nil>] 
3.0.0 :006 > user.posts.class
 => Post::ActiveRecord_Associations_CollectionProxy 
3.0.0 :007 > user.posts.to_a.class
 => Array 
```

### System configuration
**Rails version**: 7.1.0.alpha

**Ruby version**: 3.0.0p0
","{'url': 'https://api.github.com/repos/rails/rails/issues/47426/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47426/timeline,,
https://api.github.com/repos/rails/rails/issues/47416,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47416/labels{/name},https://api.github.com/repos/rails/rails/issues/47416/comments,https://api.github.com/repos/rails/rails/issues/47416/events,https://github.com/rails/rails/issues/47416,1587795098,I_kwDNIULOXqPUmg,47416,Track yarn version,"{'login': 'rubys', 'id': 4815, 'node_id': 'MDQ6VXNlcjQ4MTU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4815?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rubys', 'html_url': 'https://github.com/rubys', 'followers_url': 'https://api.github.com/users/rubys/followers', 'following_url': 'https://api.github.com/users/rubys/following{/other_user}', 'gists_url': 'https://api.github.com/users/rubys/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rubys/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rubys/subscriptions', 'organizations_url': 'https://api.github.com/users/rubys/orgs', 'repos_url': 'https://api.github.com/users/rubys/repos', 'events_url': 'https://api.github.com/users/rubys/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rubys/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,5,2023-02-16T14:38:21Z,2023-09-12T21:21:57Z,,CONTRIBUTOR,,,,"### Steps to reproduce

`rails new` with 7.1, specifying a javavascript option

### Expected behavior

package manager should be set in package.json

### Actual behavior

No package manager in package.json

### System configuration
**Rails version**: 7.1

**Ruby version**: 3.2.1

## See also

* https://github.com/rails/rails/pull/46794#issuecomment-1375738559
* https://nodejs.org/dist/latest-v16.x/docs/api/all.html#all_packages_packagemanager
* https://github.com/rubys/dockerfile-rails/commit/c1184c58e4b032b629009b537d80a51e239db5e1
","{'url': 'https://api.github.com/repos/rails/rails/issues/47416/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47416/timeline,,
https://api.github.com/repos/rails/rails/issues/47360,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47360/labels{/name},https://api.github.com/repos/rails/rails/issues/47360/comments,https://api.github.com/repos/rails/rails/issues/47360/events,https://github.com/rails/rails/pull/47360,1580240116,PR_kwDNIULOSb35_g,47360,Duplicate default attributes when they are mutable non-procs,"{'login': 'jesse-shopify', 'id': 85650604, 'node_id': 'MDQ6VXNlcjg1NjUwNjA0', 'avatar_url': 'https://avatars.githubusercontent.com/u/85650604?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jesse-shopify', 'html_url': 'https://github.com/jesse-shopify', 'followers_url': 'https://api.github.com/users/jesse-shopify/followers', 'following_url': 'https://api.github.com/users/jesse-shopify/following{/other_user}', 'gists_url': 'https://api.github.com/users/jesse-shopify/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jesse-shopify/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jesse-shopify/subscriptions', 'organizations_url': 'https://api.github.com/users/jesse-shopify/orgs', 'repos_url': 'https://api.github.com/users/jesse-shopify/repos', 'events_url': 'https://api.github.com/users/jesse-shopify/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jesse-shopify/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,7,2023-02-10T19:53:20Z,2023-08-10T18:21:41Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47360', 'html_url': 'https://github.com/rails/rails/pull/47360', 'diff_url': 'https://github.com/rails/rails/pull/47360.diff', 'patch_url': 'https://github.com/rails/rails/pull/47360.patch', 'merged_at': None}","Fixes #42959
Fixes #41854

<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because when default attributes are mutable, they are shared between ActiveModel instances. See #41854 #42959 #42977

### Detail

This Pull Request changes default attributes so that if they are mutable non-procs they `deep_dup` is called to copy the default rather than return a reference to shared state.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->
- Alternative solution: it was proposed to deprecate non-proc default attributes. I think the current PR is preferable because it works as expected with minimal changes.
- Alternative solution: use this approach but perhaps locate it elsewhere. I started with a modification of `attribute_registration.rb` then switched to `user_provided_default` which seemed more appropriate.

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47360/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47360/timeline,,
https://api.github.com/repos/rails/rails/issues/47359,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47359/labels{/name},https://api.github.com/repos/rails/rails/issues/47359/comments,https://api.github.com/repos/rails/rails/issues/47359/events,https://github.com/rails/rails/pull/47359,1580189354,PR_kwDNIULOSb1Lrg,47359,Add `#update_if` to perform optimistic updates,"{'login': 'pjambet', 'id': 717637, 'node_id': 'MDQ6VXNlcjcxNzYzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/717637?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pjambet', 'html_url': 'https://github.com/pjambet', 'followers_url': 'https://api.github.com/users/pjambet/followers', 'following_url': 'https://api.github.com/users/pjambet/following{/other_user}', 'gists_url': 'https://api.github.com/users/pjambet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pjambet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pjambet/subscriptions', 'organizations_url': 'https://api.github.com/users/pjambet/orgs', 'repos_url': 'https://api.github.com/users/pjambet/repos', 'events_url': 'https://api.github.com/users/pjambet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pjambet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-02-10T19:09:28Z,2023-02-10T21:24:20Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47359', 'html_url': 'https://github.com/rails/rails/pull/47359', 'diff_url': 'https://github.com/rails/rails/pull/47359.diff', 'patch_url': 'https://github.com/rails/rails/pull/47359.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

SQL Optimistic updates are a convenient way to perform an `UPDATE` while confirming that the current values in the database match some expectation. I've used this pattern extensively in the past with tables having a lifecycle following a determined state machine. For instance, with the following model:

```ruby
class Charge < ActiveRecord::Base
  validates :status, inclusion: [""pending"", ""success"", ""failure""]
end
```

A charge status can be updated from `""pending""` to `""success""` or from `""pending""` to `""failure""` but never from `""failure""` to `""success""` and vice versa. With optimistic updates, the following is now possible:

```ruby
charge.update_if(status: ""pending"") { charge.update!(status: ""success"") }
# UPDATE charges SET status = 'success' WHERE id = ? AND status = 'pending'
# UnexpectedValueInDatabase will be raised if charge.status == ""failure""
```

### Detail

Introduce the method `update_if` for instance of `ActiveRecord::Base`.
The method is used to perform optimistic updates. This is similar to
`Locking::Optimistic`, but does not require a integer version to store the
version of the records.

We can now do the following:

```ruby
charge.update_if(status: ""pending"") do
  charge.update!(status: ""success"")
  # UPDATE ""charges"" SET ""charges"".""status"" = 'success' WHERE ""charges"".""id"" = ? AND ""charges"".""status"" = 'pending'
end
```

If the `UPDATE` statement does not match any queries, because the value
of the `status` column in the DB was not `'pending'`, an exception is raised:

```ruby
charge.update!(status: ""success"")

charge.update_if(status: ""pending"") do
  charge.update!(status: ""success"") # raises an ActiveRecord::UnexpectedValueInDatabase
end
```

A version without block is available, but requires developers to clear
the conditions manually (the block version automatically clears them):

```ruby
charge.update_if(status: ""pending"")
charge.update!(status: ""success"")
charge.clear_update_conditions
```

Conditions can be stacked:

```ruby
charge.update_if(status: ""pending"") do
  charge.update_if(deleted_at: nil) do
    charge.update!(status: ""success"", deleted_at: Time.now)
    # UPDATE ""charges"" SET ""charges"".""status"" = 'success', ""charges"".""deleted_at"" = ? WHERE ""charges"".""id"" = ? AND ""charges"".""status"" = 'pending' AND ""charges"".""deleted_at"" IS NULL
  end
end

charge.update_if(status: ""pending"") do
charge.update_if(deleted_at: nil) do
charge.update!(status: ""success"", deleted_at: Time.now)
 # UPDATE ""charges"" SET ""charges"".""status"" = 'success', ""charges"".""deleted_at"" = ? WHERE ""charges"".""id"" = ? AND ""charges"".""status"" = 'pending' AND ""charges"".""deleted_at"" IS NULL
charge.clear_update_conditions
```

`update_if` can be used similarly to `where`, so for instance the
following options are possible:

```ruby
charge.update_if(""status LIKE ?"", ""pend%"")
charge.update_if(""status = :status"", status: ""pending"")
charge.update!(status: ""success"")
 # UPDATE ""charges"" SET ""charges"".""status"" = 'success' WHERE ""charges"".""id"" = ? AND ""charges"".""status"" LIKE 'pend%' AND ""charges"".""status"" = 'pending'
```

### Additional information

Some of the comments were added as a way to facilitate review, and explain some of the decisions, and would likely be removed if the feature is approved.

Similarly, I didn't write any public facing API documentation. I figured I would take the time to do it if the feature is approved

The first commit is a small refactor of the `capture_sql` test helper, so that logs can be captured even if the underlying operation throws an exception.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included. _Not yet, as mentioned earlier, I figured I would take the time to do that only if the feature is approved_
","{'url': 'https://api.github.com/repos/rails/rails/issues/47359/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47359/timeline,,
https://api.github.com/repos/rails/rails/issues/47358,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47358/labels{/name},https://api.github.com/repos/rails/rails/issues/47358/comments,https://api.github.com/repos/rails/rails/issues/47358/events,https://github.com/rails/rails/pull/47358,1580091532,PR_kwDNIULOSbwBdA,47358,Use current scope for `CounterCache::ClassMethods#update_counters`,"{'login': 'pjambet', 'id': 717637, 'node_id': 'MDQ6VXNlcjcxNzYzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/717637?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pjambet', 'html_url': 'https://github.com/pjambet', 'followers_url': 'https://api.github.com/users/pjambet/followers', 'following_url': 'https://api.github.com/users/pjambet/following{/other_user}', 'gists_url': 'https://api.github.com/users/pjambet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pjambet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pjambet/subscriptions', 'organizations_url': 'https://api.github.com/users/pjambet/orgs', 'repos_url': 'https://api.github.com/users/pjambet/repos', 'events_url': 'https://api.github.com/users/pjambet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pjambet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-02-10T17:45:46Z,2023-02-10T21:30:34Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47358', 'html_url': 'https://github.com/rails/rails/pull/47358', 'diff_url': 'https://github.com/rails/rails/pull/47358.diff', 'patch_url': 'https://github.com/rails/rails/pull/47358.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Prior to this change, calling `.update_counters` on an ActiveRecord class would use `unscoped` and therefore ignore existing scopes, both default scopes set in the model, or dynamic scopes set with `.scoping`.

With this change, `update_counters` is more consistent with similar methods such as `.update_all` and use existing scopes before applying the update.

Because `#increment!` & `#decrement!` use `update_counters` internally, I ended up changing their behaviors as well, but if it's preferable, we could totally keep this PR focused on `update_counters` only, and keep the `increment!`/`decrement!` behaviors the same, and address that in a separate PR.

### Detail

Assuming this `Comment` class

```ruby
class Comment < ActiveRecord::Base
  default_scope -> { where(post_id: 1) }
end
```

The current behavior on main is:

```ruby
Comment.where(""1=1"").scoping { Comment.update_counters(1, views_count: 0) }
 # UPDATE ""comments"" SET ""views_count"" = COALESCE(""views_count"", 0) + ? WHERE ""comments"".""id"" = ?
```

And the behavior on this branch is:

```ruby
Comment.where(""1=1"").scoping { Comment.update_counters(1, views_count: 0) }
 # UPDATE ""comments"" SET ""views_count"" = COALESCE(""views_count"", 0) + ? WHERE ""comments"".""post_id"" = ? AND (1=1) AND ""comments"".""id"" = ?
```

For reference, here is how `update_all` behaves:

```ruby
Comment.where(""1=1"").scoping { Comment.update_all(""updated_at=CURRENT_TIMESTAMP"") }
 # UPDATE ""comments"" SET updated_at=CURRENT_TIMESTAMP WHERE (1=1)
```

The changes to `#increment!` were made to keep the behavior consistent with `#reload`, as in, ""regular"" scopes, the ones without `all_queries: true` are ignored, whether explicit with `.scoping` or default, and the scopes with `all_queries: true` are applied.

Quoting @eileencodes from [a previous PR](https://github.com/rails/rails/pull/40805#issuecomment-743353343):

> all_queries should mean all_queries so it makes sense to add reload to this if you have that option set.

### Additional information

Note that there seems to be a bug with `#reload`, and therefore this new version of `#increment!` since they now match, when using `.scoping` around an operation, all scopes, even the ones without `all_queries: true` end up applied.

See this issue: #47357

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included. _Not yet, I thought I would add it once it's decided that this PR makes sense_
","{'url': 'https://api.github.com/repos/rails/rails/issues/47358/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47358/timeline,,
https://api.github.com/repos/rails/rails/issues/47357,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47357/labels{/name},https://api.github.com/repos/rails/rails/issues/47357/comments,https://api.github.com/repos/rails/rails/issues/47357/events,https://github.com/rails/rails/issues/47357,1580073071,I_kwDNIULOXi4Abw,47357,Inconsistent scoping rules for `all queries: true` scopes and `#reload`,"{'login': 'pjambet', 'id': 717637, 'node_id': 'MDQ6VXNlcjcxNzYzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/717637?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pjambet', 'html_url': 'https://github.com/pjambet', 'followers_url': 'https://api.github.com/users/pjambet/followers', 'following_url': 'https://api.github.com/users/pjambet/following{/other_user}', 'gists_url': 'https://api.github.com/users/pjambet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pjambet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pjambet/subscriptions', 'organizations_url': 'https://api.github.com/users/pjambet/orgs', 'repos_url': 'https://api.github.com/users/pjambet/repos', 'events_url': 'https://api.github.com/users/pjambet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pjambet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2023-02-10T17:28:44Z,2023-06-20T04:54:13Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

<details>
  <summary>Collapsed because the test is pretty long</summary>
  
```ruby
# frozen_string_literal: true

require ""bundler/inline""
require ""debug""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.boolean :deleted, default: false
  end
end

class SQLCounter
  class << self
    attr_accessor :ignored_sql, :log, :log_all
    def clear_log; self.log = []; self.log_all = []; end
  end

  clear_log

  def call(name, start, finish, message_id, values)
    return if values[:cached]

    sql = values[:sql]
    self.class.log_all << sql
    self.class.log << sql unless [""SCHEMA"", ""TRANSACTION""].include? values[:name]
  end
end

ActiveSupport::Notifications.subscribe(""sql.active_record"", SQLCounter.new)

def capture_sql(output = nil)
  ActiveRecord::Base.connection.materialize_transactions
  SQLCounter.clear_log
  yield
  log = SQLCounter.log.dup.first # I only care about the first here
  log
ensure
  log = SQLCounter.log.dup.first if log.nil?
  output.concat(log) if output
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
  default_scope -> { where(deleted: false) }
  default_scope -> { where(post_id: 1) }, all_queries: true
end

class CommentWithOnlyDefaultScopeWithoutAllQueries < ActiveRecord::Base
  self.table_name = ""comments""
  belongs_to :post
  default_scope -> { where(deleted: false) }
end

class CommentWithOnlyDefaultScopeWithAllQueries < ActiveRecord::Base
  self.table_name = ""comments""
  belongs_to :post
  default_scope -> { where(post_id: 1) }, all_queries: true
end

class BugTest < Minitest::Test
  def setup
    if Post.find_by(id: 1) # only run this before once
      @post1 = Post.find(1)
      @comment1 = Comment.unscoped.find(1)

      @post2 = Post.find(2)
      @comment2 = Comment.unscoped.find(2)
    else
      @post1 = Post.create!
      @comment1 = @post1.comments.create!

      @post2 = Post.create!
      @comment2 = @post2.comments.create!
    end
  end

  def test_scope_without_all_queries_is_ignored_on_reload_on_a_model_without_default_scopes
    # Expected behavior: scope not flagged with all_queries, is ignored, currently works:
    assert Post.where(""1=2"").scoping { @post1.reload }
  end

  def test_scope_with_all_queries_is_applied_on_reload_on_a_model_without_default_scopes
    # Expected behavior: scope flagged with all_queries, is applied, currently works:
    assert_raises(ActiveRecord::RecordNotFound) { Post.where(""1=2"").scoping(all_queries: true) { @post1.reload } }
  end

  ###

  def test_default_scope_with_all_queries_is_applied_on_reload_on_a_model_with_both_default_scopes_with_and_without_all_queries
    # Expected behavior: default scope is flagged with all_queries, scope is applied, currently works:
    sql = capture_sql { assert @comment1.reload } # where post_id = 1 matches that row
    assert_match(/WHERE ""comments"".""post_id"" = \? AND ""comments"".""id"" = \? LIMIT \?\Z/, sql)
    sql = +""""
    assert_raises(ActiveRecord::RecordNotFound) { capture_sql(sql) { @comment2.reload } }  # where post_id = 1 doesn't match that row
    assert_match(/WHERE ""comments"".""post_id"" = \? AND ""comments"".""id"" = \? LIMIT \?\Z/, sql)
  end

  def test_scope_without_all_queries_is_ignored_on_reload_on_a_model_with_both_default_scopes_with_and_without_all_queries
    # skip(""doesnt work"")
    # Expected behavior: only the default scope flagged with all_queries: true is applied, the other ones, on deleted = false and 1=1, are not, does not work:
    sql = capture_sql { Comment.where(""1=1"").scoping { @comment1.reload } }
    assert_match(/WHERE ""comments"".""post_id"" = \? AND ""comments"".""id"" = \? LIMIT \?\Z/, sql) # fails because 1=1 & deleted = false are incorrectly applied
  end

  def test_scope_with_all_queries_is_applied_but_only_default_scope_with_all_queries_on_reload_on_a_model_with_both_default_scopes_with_and_without_all_queries
    # skip(""doesnt work"")
    # Expected behavior: only the default scope flagged with all_queries: true is applied, does not work:
    sql = capture_sql { Comment.where(""1=1"").scoping(all_queries: true) { @comment1.reload } }
    assert_match(/WHERE ""comments"".""post_id"" = \? AND \(1=1\) AND ""comments"".""id"" = \? LIMIT \?\Z/, sql) # fails because deleted = false is incorrectly applied
  end

  def test_scope_without_all_queries_is_ignored_on_reload_on_a_model_with_only_a_default_scope_without_all_queries
    # Expected behavior: only the default scope flagged with all_queries: true is applied, currently works:
    comment1 = CommentWithOnlyDefaultScopeWithoutAllQueries.find(1)
    sql = capture_sql {  CommentWithOnlyDefaultScopeWithoutAllQueries.where(""1=2"").scoping { comment1.reload } }
    assert_match(/WHERE ""comments"".""id"" = \? LIMIT \?\Z/, sql)
  end

  def test_scope_with_all_queries_is_applied_on_reload_on_a_model_with_only_a_default_scope_without_all_queries
    # skip(""doesnt work"")
    # Expected behavior: only the explicit scope flagged with all_queries: true is applied, does not work:
    comment1 = CommentWithOnlyDefaultScopeWithoutAllQueries.find(1)
    sql = capture_sql { CommentWithOnlyDefaultScopeWithoutAllQueries.where(""1=1"").scoping(all_queries: true) { comment1.reload } }
    assert_match(/WHERE \(1=1\) AND ""comments"".""id"" = \? LIMIT \?\Z/, sql) # Fails because deleted = false is incorrectly included
  end

  def test_scope_without_all_queries_is_ignored_on_reload_on_a_model_with_only_a_default_scope_with_all_queries
    # skip(""does not work"")
    # Expected behavior: only the default scope flagged with all_queries: true is applied, does not work:
    comment1 = CommentWithOnlyDefaultScopeWithAllQueries.find(1)
    sql = capture_sql { CommentWithOnlyDefaultScopeWithAllQueries.where(""1=1"").scoping { comment1.reload } }
    assert_match(/WHERE ""comments"".""post_id"" = \? AND ""comments"".""id"" = \? LIMIT \?\Z/, sql) # Fails because 1=1 is incorrectly included
  end

  def test_scope_with_all_queries_is_applied_on_reload_on_a_model_with_only_a_default_scope_with_all_queries
    # Expected behavior: the default scope flagged with all_queries: true and the explicit scope flagged with all_queries: true are applied, works:
    comment1 = CommentWithOnlyDefaultScopeWithAllQueries.find(1)
    sql = capture_sql { CommentWithOnlyDefaultScopeWithAllQueries.where(""1=1"").scoping(all_queries: true) { comment1.reload } }
    assert_match(/WHERE ""comments"".""post_id"" = \? AND \(1=1\) AND ""comments"".""id"" = \? LIMIT \?\Z/, sql)
  end
end
```
</details>


### Expected behavior
<!-- Tell us what should happen -->

I would expect all tests to pass. In other words, scopes not flagged with `all_queries: true` should never be applied on `#reload`, whether they are added as default scopes on the model, or created explicitly with `.scoping`.

### Actual behavior
<!-- Tell us what happens instead -->

The following cases lead to scopes not flagged with `all_queries: true` to be applied: 

- Calling `.scoping()` on a model with two default scopes, one with `all_queries: true`, one without, causes all three scopes to be applied, instead of only the default one with `all_queries: true`. See test `test_scope_without_all_queries_is_ignored_on_reload_on_a_model_with_both_default_scopes_with_and_without_all_queries` above
- Calling `.scoping(all_queries: true)` on a model with two default scopes, one with `all_queries: true`, one without, causes all three scopes to be applied, instead of only the two scopes with `all_queries: true` one. See test `test_scope_with_all_queries_is_applied_but_only_default_scope_with_all_queries_on_reload_on_a_model_with_both_default_scopes_with_and_without_all_queries` above
- Calling `.scoping(all_queries: true)` on a model with a default scope not flagged with `all_queries: true` causes both scopes to be applied, instead of only the `all_queries: true` one. See test `test_scope_with_all_queries_is_applied_on_reload_on_a_model_with_only_a_default_scope_without_all_queries` above
- Calling `.scoping()` on a model with a default scope flagged with `all_queries: true` causes both scopes to be applied instead of only the default one with `all_queries: true`. See test `test_scope_without_all_queries_is_ignored_on_reload_on_a_model_with_only_a_default_scope_with_all_queries` above

All four cases are probably the same underlying issue in terms of how scopes are applied but I figured I would make an exhaustive list of all combinations and expected outcome.

Related issue: https://github.com/rails/rails/issues/46731 (and [PR](https://github.com/rails/rails/pull/46742) that fixed it)

---

I didn't get a chance yet, but I'm curious if the same issue happens with other instance methods such as `#update` and `#destroy`, as in, only scopes with `all_queries: true` should be applied.

### System configuration
**Rails version**: main@c88ca3b

**Ruby version**:  ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [arm64-darwin21]
","{'url': 'https://api.github.com/repos/rails/rails/issues/47357/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47357/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/47355,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47355/labels{/name},https://api.github.com/repos/rails/rails/issues/47355/comments,https://api.github.com/repos/rails/rails/issues/47355/events,https://github.com/rails/rails/pull/47355,1579917454,PR_kwDNIULOSbmopg,47355,Respect `unscoped` for update & delete operations,"{'login': 'pjambet', 'id': 717637, 'node_id': 'MDQ6VXNlcjcxNzYzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/717637?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pjambet', 'html_url': 'https://github.com/pjambet', 'followers_url': 'https://api.github.com/users/pjambet/followers', 'following_url': 'https://api.github.com/users/pjambet/following{/other_user}', 'gists_url': 'https://api.github.com/users/pjambet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pjambet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pjambet/subscriptions', 'organizations_url': 'https://api.github.com/users/pjambet/orgs', 'repos_url': 'https://api.github.com/users/pjambet/repos', 'events_url': 'https://api.github.com/users/pjambet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pjambet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-02-10T15:42:51Z,2023-02-14T22:19:27Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47355', 'html_url': 'https://github.com/rails/rails/pull/47355', 'diff_url': 'https://github.com/rails/rails/pull/47355.diff', 'patch_url': 'https://github.com/rails/rails/pull/47355.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Calling `.unscoped` around an update or delete operation, such as `#update` or `#destroy` is currently a no-op and does not ignore scopes marked with `all_queries: true`.

This feels like an issue as other methods, such as `#reload` respect the scoping rules set by calling `.unscoped`, i.e. assuming a default_scope on `Comment` for `where(post_id: 1)`,  `Comment.unscoped { comment.reload }` will only use the primary key in the `WHERE` clause and not include the `AND post_id = 1` piece.

Additionally, without the change in this PR, there is no ""escape hatch"" (or at least no obvious ones), once a model has defined a default scope with `all_queries: true`, there is no way to opt out of it, which is now possible with `Comment.unscoped { comment.touch }`.

Related issue: #44823

<details>
  <summary>Executable test case</summary>
  
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.timestamps
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
  default_scope -> { where(post_id: 1) }, all_queries: true
end

class BugTest < Minitest::Test
  def test_association_stuff
    post1 = Post.create!
    comment1 = post1.comments.create!

    post2 = Post.create!
    comment2 = post2.comments.create!

    assert comment1.touch # query includes WHERE post_id = 1

    comment2.touch # query includes WHERE post_id = 1, returns nothing and is a no-op
    # confirm that the value in the DB is different than what the in-memory instance has, since nothing was persisted
    # see https://github.com/rails/rails/issues/44823 for the ""ignored update"" issue
    refute_equal Comment.unscoped.find(comment2.id).updated_at, comment2.updated_at

    # I would expect the following to _actually_ perform the update, thanks to `unscoped`, but it doesn't
    Comment.unscoped { comment2.touch } # query includes WHERE post_id = 1, returns nothing and is a no-op
    assert_equal Comment.unscoped.find(comment2.id).updated_at, comment2.updated_at # Fails on main, not on this branch
  end
end
```
</details>


### Detail

There are two commits in this PR, only the first one fixes the issue, the second one is a small refactor after I realized that in some cases the default scope could be applied twice. They could be squashed, but I kept them separate, at least for now, since the second one doesn't change any _real_ behavior.

The fix I used in the first commit was to return early from `Persistence#build_default_constraint` if `current_scope` returns anything. I am still not sure if it's the best approach, but this is the only way I found to detect that `.uncoped` was called earlier and to prevent applying the default scopes to the current operation.

In the second commit I refactored what used to be a two step process in both `_update_record` & `_delete_record`, first apply the default constraints with `build_constraints`, if any, and then apply `global_current_scope`, if any.

The issue there was that if you had a model with a default scope and `all_queries: true`, and you also created an explicit scope with `all_queries: true`, something like `Comment.where(""1=1"").scoping(all_queries: true)`, then the default scope was applied twice, once from `build_default_constraint` and once from `global_current_scope`.

So I opted to consolidate the logic in a new method, which also has the added benefit to remove some duplication.

Additionally, I changed the behavior of `Default::ClassMethods#unscoped` to pass `all_queries: true` to `.scoping`, so that in the new `build_scope_constraints` method we can start checking for the presence of `global_current_scope`, which would be true in the `Comment.where(""1=1"").scoping(all_queries: true)` example, and would contain both the default scope and the explicit one with `scoping`.


### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

cc @nvasilevski since you worked on #42517

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included. _not yet, figured I would add it in case it's decided that this PR makes sense)_
","{'url': 'https://api.github.com/repos/rails/rails/issues/47355/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47355/timeline,,
https://api.github.com/repos/rails/rails/issues/47350,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47350/labels{/name},https://api.github.com/repos/rails/rails/issues/47350/comments,https://api.github.com/repos/rails/rails/issues/47350/events,https://github.com/rails/rails/pull/47350,1579277948,PR_kwDNIULOSbDubA,47350,added ActiveRecord::Calculations.pluck_as_hash,"{'login': 'krtschmr', 'id': 13366714, 'node_id': 'MDQ6VXNlcjEzMzY2NzE0', 'avatar_url': 'https://avatars.githubusercontent.com/u/13366714?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/krtschmr', 'html_url': 'https://github.com/krtschmr', 'followers_url': 'https://api.github.com/users/krtschmr/followers', 'following_url': 'https://api.github.com/users/krtschmr/following{/other_user}', 'gists_url': 'https://api.github.com/users/krtschmr/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/krtschmr/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/krtschmr/subscriptions', 'organizations_url': 'https://api.github.com/users/krtschmr/orgs', 'repos_url': 'https://api.github.com/users/krtschmr/repos', 'events_url': 'https://api.github.com/users/krtschmr/events{/privacy}', 'received_events_url': 'https://api.github.com/users/krtschmr/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2023-02-10T08:53:57Z,2023-02-20T20:06:05Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47350', 'html_url': 'https://github.com/rails/rails/pull/47350', 'diff_url': 'https://github.com/rails/rails/pull/47350.diff', 'patch_url': 'https://github.com/rails/rails/pull/47350.patch', 'merged_at': None}","which works like pluck but returns an array of hashes with the column names as keys



Often we find ourself in a situation where we want a fast way to return a list of objects returned where the keys of the columns are already existing. This often appen on JSON APIs.
A common way, but quite some code is the following

````
attrs = [:id, :title, :created_at, :updated_at, :template_id]
documents = Document.published.pluck(*attrs).collect { _1.collect.with_index { |attr, i| [attrs[i], attr] }.to_h }
````

this can be now replaced with
````
documents = Document.published.pluck_as_hash(:id, :title, :created_at, :updated_at, :template_id)
````


### Checklist
* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47350/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47350/timeline,,
https://api.github.com/repos/rails/rails/issues/47341,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47341/labels{/name},https://api.github.com/repos/rails/rails/issues/47341/comments,https://api.github.com/repos/rails/rails/issues/47341/events,https://github.com/rails/rails/pull/47341,1578511221,PR_kwDNIULOSaaofg,47341,Robust current_page? compare,"{'login': 'bradhuskins', 'id': 107579835, 'node_id': 'U_kgDOBmmJuw', 'avatar_url': 'https://avatars.githubusercontent.com/u/107579835?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bradhuskins', 'html_url': 'https://github.com/bradhuskins', 'followers_url': 'https://api.github.com/users/bradhuskins/followers', 'following_url': 'https://api.github.com/users/bradhuskins/following{/other_user}', 'gists_url': 'https://api.github.com/users/bradhuskins/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bradhuskins/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bradhuskins/subscriptions', 'organizations_url': 'https://api.github.com/users/bradhuskins/orgs', 'repos_url': 'https://api.github.com/users/bradhuskins/repos', 'events_url': 'https://api.github.com/users/bradhuskins/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bradhuskins/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2023-02-09T20:05:54Z,2023-02-14T22:00:33Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47341', 'html_url': 'https://github.com/rails/rails/pull/47341', 'diff_url': 'https://github.com/rails/rails/pull/47341.diff', 'patch_url': 'https://github.com/rails/rails/pull/47341.patch', 'merged_at': None}","### Motivation / Background

This MR updates UrlHelper#current_page? to compare target {:controller, :action} that will be routed to as opposed to comparison of URL strings.
To this end, we have added a couple of new methods to RouteSet (which is already loaded as a part of the request) to parse the 2 resultant URLs and determine controller and action names to be targeted [descoping the check to verify they are actual classes].
The usage of these new methods is restricted to the root route since, as pointed out in review, broader application is problematic.

FIXES #47184

### Detail

This Pull Request adds lighter weight path recognition to route_set, and then uses this to compare target controller/action combinations of the 2 URLs in the current_page? check, rather than just raw string comparison.

### Additional information

To test this, the test case from [Issue 47184](https://github.com/rails/rails/issues/47184), along with a few others, were imported into url_helper_test.rb, to ensure consistency.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47341/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47341/timeline,,
https://api.github.com/repos/rails/rails/issues/47334,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47334/labels{/name},https://api.github.com/repos/rails/rails/issues/47334/comments,https://api.github.com/repos/rails/rails/issues/47334/events,https://github.com/rails/rails/issues/47334,1577661837,I_kwDNIULOXgk1jQ,47334,Error does not bubble up from invalid associated record to parent (more detailed),"{'login': 'loqimean', 'id': 49816584, 'node_id': 'MDQ6VXNlcjQ5ODE2NTg0', 'avatar_url': 'https://avatars.githubusercontent.com/u/49816584?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/loqimean', 'html_url': 'https://github.com/loqimean', 'followers_url': 'https://api.github.com/users/loqimean/followers', 'following_url': 'https://api.github.com/users/loqimean/following{/other_user}', 'gists_url': 'https://api.github.com/users/loqimean/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/loqimean/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/loqimean/subscriptions', 'organizations_url': 'https://api.github.com/users/loqimean/orgs', 'repos_url': 'https://api.github.com/users/loqimean/repos', 'events_url': 'https://api.github.com/users/loqimean/events{/privacy}', 'received_events_url': 'https://api.github.com/users/loqimean/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2023-02-09T10:52:24Z,2023-08-04T21:11:31Z,,NONE,,,,"### Steps to reproduce
```ruby
class Parent
  has_many :child_parents
  has_many :children, through: :child_parents
end

class ChildParent
  belongs_to :parent
  belongs_to :child
end

class Child
  has_many :child_parents
  has_many :parents, through: :child_parents

  validates :name, uniqueness: { scope: :parent }
end


first_child = Child.create(name: ""John"")
second_child = Child.create(name: ""John"")

parent = Parent.create

parent.update(children_ids: [first_child.id, second_child.id])

parent.save #=> false
parent.errors.full_messages #=> ""Children invalid""
parent.children.map(&:errors).compact.map(&:full_messages) #=> ""[[""Child's name already taken""]]""
```

### Expected behavior
Expected to have message more detailed, like ""Child with id '45' has already taken name"" on parent model

### Actual behavior
It just returns an error message ""Children are invalid""  

### System configuration
**Rails version**: 7.0.4

**Ruby version**: 3.1.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/47334/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47334/timeline,,
https://api.github.com/repos/rails/rails/issues/47324,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47324/labels{/name},https://api.github.com/repos/rails/rails/issues/47324/comments,https://api.github.com/repos/rails/rails/issues/47324/events,https://github.com/rails/rails/pull/47324,1576877855,PR_kwDNIULOSZC4nw,47324,Include nil when serializing ActiveModel to include a singular association that is nil,"{'login': 'bemky', 'id': 841033, 'node_id': 'MDQ6VXNlcjg0MTAzMw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/841033?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bemky', 'html_url': 'https://github.com/bemky', 'followers_url': 'https://api.github.com/users/bemky/followers', 'following_url': 'https://api.github.com/users/bemky/following{/other_user}', 'gists_url': 'https://api.github.com/users/bemky/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bemky/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bemky/subscriptions', 'organizations_url': 'https://api.github.com/users/bemky/orgs', 'repos_url': 'https://api.github.com/users/bemky/repos', 'events_url': 'https://api.github.com/users/bemky/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bemky/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,1,2023-02-08T22:20:48Z,2023-02-13T14:41:00Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47324', 'html_url': 'https://github.com/rails/rails/pull/47324', 'diff_url': 'https://github.com/rails/rails/pull/47324.diff', 'patch_url': 'https://github.com/rails/rails/pull/47324.patch', 'merged_at': None}","### Motivation / Background

For my specific use case, we need to inject all the data for a record and it's sub-resources into HTML. When including a `belongs_to` or `has_one` association, if the association is nil, the key is simply not included in the data. For reasons, this is problematic because it triggers our client-side code to request that resource. It would be ideal if it knew it didn't need to make the request.

### Detail

This change allows nil values for `record.send(...)` to be included in the serialization of associations.

```ruby
 user.as_json(include: :phone)
 # => {name: 'Ben Ehmke', email_address: 'ben.ehmke@email.com', phone: nil}
```
","{'url': 'https://api.github.com/repos/rails/rails/issues/47324/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47324/timeline,,
https://api.github.com/repos/rails/rails/issues/47306,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47306/labels{/name},https://api.github.com/repos/rails/rails/issues/47306/comments,https://api.github.com/repos/rails/rails/issues/47306/events,https://github.com/rails/rails/pull/47306,1575743146,PR_kwDNIULOSYFscA,47306,Follow up to HTTP::Request#route_uri_pattern,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,1,2023-02-08T09:05:46Z,2023-03-22T02:10:58Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47306', 'html_url': 'https://github.com/rails/rails/pull/47306', 'diff_url': 'https://github.com/rails/rails/pull/47306.diff', 'patch_url': 'https://github.com/rails/rails/pull/47306.patch', 'merged_at': None}","My goal is to add some more coverage for #47129.

Also, spotted a tiny RDoc style bug in f38c21b.

Even though `route_uri_pattern=` is private, I thought we should add a test for it?
I'm still thinking about how to test it.","{'url': 'https://api.github.com/repos/rails/rails/issues/47306/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47306/timeline,,
https://api.github.com/repos/rails/rails/issues/47301,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47301/labels{/name},https://api.github.com/repos/rails/rails/issues/47301/comments,https://api.github.com/repos/rails/rails/issues/47301/events,https://github.com/rails/rails/pull/47301,1575520128,PR_kwDNIULOSX53JA,47301,Add config.form_with_generates_local_forms,"{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2023-02-08T05:42:46Z,2023-03-22T16:50:13Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47301', 'html_url': 'https://github.com/rails/rails/pull/47301', 'diff_url': 'https://github.com/rails/rails/pull/47301.diff', 'patch_url': 'https://github.com/rails/rails/pull/47301.patch', 'merged_at': None}","Deprecates config.form_with_generates_remote_forms

cc #41276

The idea is that `form_with_generates_remote_forms` is confusing, and to introduce a new config option to avoid having to understand the inverse logic.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47301/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47301/timeline,,
https://api.github.com/repos/rails/rails/issues/47292,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47292/labels{/name},https://api.github.com/repos/rails/rails/issues/47292/comments,https://api.github.com/repos/rails/rails/issues/47292/events,https://github.com/rails/rails/pull/47292,1574763921,PR_kwDNIULOSXRqLg,47292,Fix envelope provider DEK decrypting after previous scheme,"{'login': 'exosty', 'id': 14030560, 'node_id': 'MDQ6VXNlcjE0MDMwNTYw', 'avatar_url': 'https://avatars.githubusercontent.com/u/14030560?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/exosty', 'html_url': 'https://github.com/exosty', 'followers_url': 'https://api.github.com/users/exosty/followers', 'following_url': 'https://api.github.com/users/exosty/following{/other_user}', 'gists_url': 'https://api.github.com/users/exosty/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/exosty/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/exosty/subscriptions', 'organizations_url': 'https://api.github.com/users/exosty/orgs', 'repos_url': 'https://api.github.com/users/exosty/repos', 'events_url': 'https://api.github.com/users/exosty/events{/privacy}', 'received_events_url': 'https://api.github.com/users/exosty/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,5,2023-02-07T17:34:04Z,2023-07-31T07:56:26Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47292', 'html_url': 'https://github.com/rails/rails/pull/47292', 'diff_url': 'https://github.com/rails/rails/pull/47292.diff', 'patch_url': 'https://github.com/rails/rails/pull/47292.patch', 'merged_at': None}","DEK decrypting was failing if you tried to decrypt ciphertext which was previously encrypted with a different scheme without using envelope/DEK approach at all

### Detail

If your data is encrypted with non-envelope provider (for example with `DerivedSecretKeyProvider`) and now you want to change it to `EnvelopeEncryptionKeyProvider` using _previous scheme approach_:
  ```
    encrypts :phone, key_provider: ActiveRecord::Encryption::EnvelopeEncryptionKeyProvider.new,
                     previous: { key_provider: ActiveRecord::Encryption.key_provider }
  ```

you won't succeed because `EnvelopeEncryptionKeyProvider` expects DEK to be always present and decryption fails because of that:
```
NoMethodError: undefined method `payload' for nil:NilClass

          encrypted_data = encrypted_message.payload
                                            ^^^^^^^^
from ... activerecord-7.0.3.1/lib/active_record/encryption/cipher/aes256_gcm.rb:57:in `decrypt'
```


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47292/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47292/timeline,,
https://api.github.com/repos/rails/rails/issues/47290,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47290/labels{/name},https://api.github.com/repos/rails/rails/issues/47290/comments,https://api.github.com/repos/rails/rails/issues/47290/events,https://github.com/rails/rails/pull/47290,1574362431,PR_kwDNIULOSW8FSg,47290,Exception is raised when using dependent: :restrict_with_error,"{'login': 'yoones', 'id': 1333898, 'node_id': 'MDQ6VXNlcjEzMzM4OTg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1333898?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/yoones', 'html_url': 'https://github.com/yoones', 'followers_url': 'https://api.github.com/users/yoones/followers', 'following_url': 'https://api.github.com/users/yoones/following{/other_user}', 'gists_url': 'https://api.github.com/users/yoones/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/yoones/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/yoones/subscriptions', 'organizations_url': 'https://api.github.com/users/yoones/orgs', 'repos_url': 'https://api.github.com/users/yoones/repos', 'events_url': 'https://api.github.com/users/yoones/events{/privacy}', 'received_events_url': 'https://api.github.com/users/yoones/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-02-07T13:45:01Z,2023-06-10T12:30:04Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47290', 'html_url': 'https://github.com/rails/rails/pull/47290', 'diff_url': 'https://github.com/rails/rails/pull/47290.diff', 'patch_url': 'https://github.com/rails/rails/pull/47290.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because there is a behavior in ActiveRecord that does not seem logical IMO. `dependent: :restrict_with_error` promises that failures will be handled using errors, not exceptions, but `ActiveRecord::RecordNotDestroyed` is raised.

### Detail

I wrote a test to reproduce the behavior. I am more than willing to propose a patch if the maintainers consider it to be a bug, however I'd be grateful for any guidance as ActiveRecord's source code is a bit overwhelming at first.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [X] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47290/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47290/timeline,,
https://api.github.com/repos/rails/rails/issues/47248,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47248/labels{/name},https://api.github.com/repos/rails/rails/issues/47248/comments,https://api.github.com/repos/rails/rails/issues/47248/events,https://github.com/rails/rails/pull/47248,1570556104,PR_kwDNIULOST2ggA,47248,Add `binstubs:change` command,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,7,2023-02-03T22:20:10Z,2023-02-19T18:02:22Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47248', 'html_url': 'https://github.com/rails/rails/pull/47248', 'diff_url': 'https://github.com/rails/rails/pull/47248.diff', 'patch_url': 'https://github.com/rails/rails/pull/47248.patch', 'merged_at': None}","The `binstubs:change` command changes binstubs to have a specific shebang, Unix-style line endings, and execute permission.  For example, Windows users can use `binstubs:change` to update their app's binstubs to target a Unix-like platform.  In particular, this can be used when copying binstubs from a Windows system to a Docker image.

  ```console
  $ cd my_cool_app

  $ stat --printf=""%A  %n\n"" bin/*
  -rw-r--r--  bin/bundle
  -rw-r--r--  bin/docker-entrypoint
  -rw-r--r--  bin/importmap
  -rw-r--r--  bin/rails
  -rw-r--r--  bin/rake
  -rw-r--r--  bin/setup

  $ cat -v bin/rails
  #!/usr/bin/env ruby.exe^M
  APP_PATH = File.expand_path(""../config/application"", __dir__)^M
  require_relative ""../config/boot""^M
  require ""rails/commands""^M

  $ bundle exec rails binstubs:change
  .../ruby-3.1.2/bin/ruby: warning: shebang line ending with \r may cause problems

  $ stat --printf=""%A  %n\n"" bin/*
  -rwxr-xr-x  bin/bundle
  -rwxr-xr-x  bin/docker-entrypoint
  -rwxr-xr-x  bin/importmap
  -rwxr-xr-x  bin/rails
  -rwxr-xr-x  bin/rake
  -rwxr-xr-x  bin/setup

  $ cat -v bin/rails
  #!/usr/bin/env ruby
  APP_PATH = File.expand_path(""../config/application"", __dir__)
  require_relative ""../config/boot""
  require ""rails/commands""
  ```
","{'url': 'https://api.github.com/repos/rails/rails/issues/47248/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47248/timeline,,
https://api.github.com/repos/rails/rails/issues/47229,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47229/labels{/name},https://api.github.com/repos/rails/rails/issues/47229/comments,https://api.github.com/repos/rails/rails/issues/47229/events,https://github.com/rails/rails/pull/47229,1568166739,PR_kwDNIULOSR25rg,47229,Add Channel Actions to ActionCable guide [ci skip],"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-02-02T14:32:15Z,2023-02-08T16:22:17Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47229', 'html_url': 'https://github.com/rails/rails/pull/47229', 'diff_url': 'https://github.com/rails/rails/pull/47229.diff', 'patch_url': 'https://github.com/rails/rails/pull/47229.patch', 'merged_at': None}","### Detail

Actions defined on Channels were not explained in the ActionCable guide, including what methods are callable and how routing works.

This commit copies the documentation from https://github.com/rails/rails/blob/main/actioncable/lib/action_cable/channel/base.rb with small modifications to make it fit in the guides.

The `unsubscribed` method is added in the example above to make it's appearance in the actions example less confusing.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47229/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47229/timeline,,
https://api.github.com/repos/rails/rails/issues/47218,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47218/labels{/name},https://api.github.com/repos/rails/rails/issues/47218/comments,https://api.github.com/repos/rails/rails/issues/47218/events,https://github.com/rails/rails/pull/47218,1566841564,PR_kwDNIULOSQvneA,47218,Fix preview variants in ActiveStorage proxy mode,"{'login': 'alexandreruban', 'id': 33979976, 'node_id': 'MDQ6VXNlcjMzOTc5OTc2', 'avatar_url': 'https://avatars.githubusercontent.com/u/33979976?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/alexandreruban', 'html_url': 'https://github.com/alexandreruban', 'followers_url': 'https://api.github.com/users/alexandreruban/followers', 'following_url': 'https://api.github.com/users/alexandreruban/following{/other_user}', 'gists_url': 'https://api.github.com/users/alexandreruban/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/alexandreruban/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/alexandreruban/subscriptions', 'organizations_url': 'https://api.github.com/users/alexandreruban/orgs', 'repos_url': 'https://api.github.com/users/alexandreruban/repos', 'events_url': 'https://api.github.com/users/alexandreruban/events{/privacy}', 'received_events_url': 'https://api.github.com/users/alexandreruban/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2023-02-01T21:15:02Z,2023-02-01T23:18:51Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47218', 'html_url': 'https://github.com/rails/rails/pull/47218', 'diff_url': 'https://github.com/rails/rails/pull/47218.diff', 'patch_url': 'https://github.com/rails/rails/pull/47218.patch', 'merged_at': None}","Fixes #47071

Before this commit, when using ActiveStorage proxy mode, it was impossible to apply variations to the generated preview of a video or a PDF. This is because `ActiveStorage::Preview#image` (which is called in the `ActiveStorage::Representations::ProxyController`) always returned the blob's preview image without applying any variations.

This commit fixes the issue by changing `ActiveStorage::Preview#image` so that it takes into account the variations.","{'url': 'https://api.github.com/repos/rails/rails/issues/47218/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47218/timeline,,
https://api.github.com/repos/rails/rails/issues/47197,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47197/labels{/name},https://api.github.com/repos/rails/rails/issues/47197/comments,https://api.github.com/repos/rails/rails/issues/47197/events,https://github.com/rails/rails/pull/47197,1563791880,PR_kwDNIULOSOL9uQ,47197,Update default_helper_module code in guide [ci skip],"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-01-31T07:20:14Z,2023-02-03T23:38:36Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47197', 'html_url': 'https://github.com/rails/rails/pull/47197', 'diff_url': 'https://github.com/rails/rails/pull/47197.diff', 'patch_url': 'https://github.com/rails/rails/pull/47197.patch', 'merged_at': None}","### Motivation / Background

The method was updated in 5b28a0e972da31da570ed24be505ef7958ab4b5e, but the example referencing it in the docs was not.

### Detail

Update default_helper_module code in guide

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* ~[ ] Tests are added or updated if you fix a bug or add a feature.~
* ~[ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.~
","{'url': 'https://api.github.com/repos/rails/rails/issues/47197/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47197/timeline,,
https://api.github.com/repos/rails/rails/issues/47193,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47193/labels{/name},https://api.github.com/repos/rails/rails/issues/47193/comments,https://api.github.com/repos/rails/rails/issues/47193/events,https://github.com/rails/rails/pull/47193,1562645577,PR_kwDNIULOSNNxUg,47193,Adds support for CTEs (`WITH`) to `INSERT`/`UPDATE`/`DELETE` statements,"{'login': 'benedikt', 'id': 9696, 'node_id': 'MDQ6VXNlcjk2OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9696?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/benedikt', 'html_url': 'https://github.com/benedikt', 'followers_url': 'https://api.github.com/users/benedikt/followers', 'following_url': 'https://api.github.com/users/benedikt/following{/other_user}', 'gists_url': 'https://api.github.com/users/benedikt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/benedikt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/benedikt/subscriptions', 'organizations_url': 'https://api.github.com/users/benedikt/orgs', 'repos_url': 'https://api.github.com/users/benedikt/repos', 'events_url': 'https://api.github.com/users/benedikt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/benedikt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,5,2023-01-30T15:18:58Z,2023-02-15T01:49:15Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47193', 'html_url': 'https://github.com/rails/rails/pull/47193', 'diff_url': 'https://github.com/rails/rails/pull/47193.diff', 'patch_url': 'https://github.com/rails/rails/pull/47193.patch', 'merged_at': None}","### Motivation / Background

Common Table Expressions (CTE, `WITH`) are a useful tool and they've been supported on `SELECT` queries in Arel for quite a while. However, databases support CTEs on other query types as well. 

CTEs are a useful tool combine multiple queries into one statement while making the resulting statement more readable and allowing reuse of the queries result in multiple parts of the parent query. 

### Detail

This pull request moves the `#with` method from `Arel::SelectManager` to `Arel::TreeManager` and adds `#with` to `Arel::Nodes::InsertStatement`, `Arel::Nodes::UpdateStatement`, `Arel::Nodes::DeleteStatement` and adjusts the `Arel::Visitors::ToSql` and `Arel::Visitors::Dot` visitors accordingly. This way CTEs are supported on all query types. 


The following made up example counts the number of comments for all users and deletes the spammy users with more than 1000 comments:

```ruby 
users = Table.new(:users)
comments = Table.new(:comments)
comments_count = Table.new(:comments_count)

count_manager   = comments
  .project(comments[:user_id], Arel.star.count)
  .group(comments[:user_id])

spammer_manager = comments_count
  .project(comments_count[:user_id])
  .where(comments_count[:count].gt(1000))

Arel::DeleteManager.new
  .from(users)
  .with(Arel::Nodes::TableAlias.new(count_manager, Arel.sql(comments_count.name.to_s)))
  .where(users[:id].in(spammer_manager.ast))
```

```sql 
WITH comments_count AS (
  SELECT
    ""comments"".""user_id"",
    COUNT(*)
  FROM
    ""comments""
  GROUP BY
    ""comments"".""user_id""
)
DELETE FROM
  ""users""
WHERE
  ""users"".""id"" IN (
    SELECT
      ""comments_count"".""user_id""
    FROM
      ""comments_count""
    WHERE
      ""comments_count"".""count"" > 1000
  )
```

### Additional information

The examples in the tests (and above) are a bit cumbersome to set up. The pull requests #47157 and #47189 attempt to improve that by adding support for `UPDATE ... FROM ...` statements and an easier way to create aliases for `INSERT`, `UPDATE`, and `DELETE` managers. 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47193/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47193/timeline,,
https://api.github.com/repos/rails/rails/issues/47189,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47189/labels{/name},https://api.github.com/repos/rails/rails/issues/47189/comments,https://api.github.com/repos/rails/rails/issues/47189/events,https://github.com/rails/rails/pull/47189,1562334308,PR_kwDNIULOSM82nA,47189,Adds `#as` helper method to create aliases to all Arel managers,"{'login': 'benedikt', 'id': 9696, 'node_id': 'MDQ6VXNlcjk2OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9696?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/benedikt', 'html_url': 'https://github.com/benedikt', 'followers_url': 'https://api.github.com/users/benedikt/followers', 'following_url': 'https://api.github.com/users/benedikt/following{/other_user}', 'gists_url': 'https://api.github.com/users/benedikt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/benedikt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/benedikt/subscriptions', 'organizations_url': 'https://api.github.com/users/benedikt/orgs', 'repos_url': 'https://api.github.com/users/benedikt/repos', 'events_url': 'https://api.github.com/users/benedikt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/benedikt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-01-30T12:16:36Z,2023-02-10T09:01:29Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47189', 'html_url': 'https://github.com/rails/rails/pull/47189', 'diff_url': 'https://github.com/rails/rails/pull/47189.diff', 'patch_url': 'https://github.com/rails/rails/pull/47189.patch', 'merged_at': None}","### Motivation / Background

Creating an alias for a (sub-)query is pretty involved right now. It requires a `Arel::Nodes::TableAlias` that wraps a `Arel::Nodes::Grouping` that wraps the query statement and a `Arel::Nodes::SqlLiteral` for the alias name. 

```ruby 
query = Arel::Table.new(:users).project(:name).ast

Arel::Nodes::TableAlias.new(
  Arel::Nodes::Grouping.new(query),
  Arel::Nodes::SqlLiteral.new(""query_alias"")
)
```

```sql 
""(SELECT name FROM \""users\"") query_alias""
```

Luckily, `Arel::SelectManager` implements a handy `#as` helper method that makes very convenient and easy: 

```ruby 
Arel::Table.new(:users).project(:name).as('query_alias')
```

```sql 
""(SELECT name FROM \""users\"") query_alias""
```

Unfortunately, there's no such helper method for `Arel::InsertManager`, `Arel::UpdateManager`, and `Arel::DeleteManager`. So to alias one of those still requires the rather cumbersome code from above. 


### Detail

This pull request moves the `#as` helper method from `Arel::SelectManager` into it's parent `Arel::TreeManager` class. This way it's also available on all other manager classes. In the spirit of #47158, it also allows symbols as aliases. 

```ruby 
users = Arel::Table.new(:users) 

manager = Arel::InsertManager.new
  .insert([[users[:name], 'Testing']])

# Previously 
Arel::Nodes::TableAlias.new(
  Arel::Nodes::Grouping.new(manager.ast),
  Arel::Nodes::SqlLiteral.new(""query_alias"")
)

# Now
manager.as(:query_alias)
```

```sql 
""(INSERT INTO \""users\"" (\""name\"") VALUES ('Testing')) query_alias""
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47189/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47189/timeline,,
https://api.github.com/repos/rails/rails/issues/47184,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47184/labels{/name},https://api.github.com/repos/rails/rails/issues/47184/comments,https://api.github.com/repos/rails/rails/issues/47184/events,https://github.com/rails/rails/issues/47184,1561659937,I_kwDNIULOXRUKIQ,47184,`current_page?` wrong with root route,"{'login': 'user073', 'id': 63527968, 'node_id': 'MDQ6VXNlcjYzNTI3OTY4', 'avatar_url': 'https://avatars.githubusercontent.com/u/63527968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/user073', 'html_url': 'https://github.com/user073', 'followers_url': 'https://api.github.com/users/user073/followers', 'following_url': 'https://api.github.com/users/user073/following{/other_user}', 'gists_url': 'https://api.github.com/users/user073/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/user073/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/user073/subscriptions', 'organizations_url': 'https://api.github.com/users/user073/orgs', 'repos_url': 'https://api.github.com/users/user073/repos', 'events_url': 'https://api.github.com/users/user073/events{/privacy}', 'received_events_url': 'https://api.github.com/users/user073/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 35206628, 'node_id': 'MDU6TGFiZWwzNTIwNjYyOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/routing', 'name': 'routing', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2023-01-30T03:08:45Z,2023-02-10T03:09:03Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""rails"", ""~> 7.0.0""
end

require ""rack/test""
require ""action_controller/railtie""
require ""minitest/autorun""

class BugTest < ActiveSupport::TestCase
  attr_accessor :controller, :request

  routes = ActionDispatch::Routing::RouteSet.new
  routes.draw do
    root ""posts#index""
    resources :posts, only: :index
  end

  include ActionView::Helpers::UrlHelper
  include routes.url_helpers

  def request_for_url(url, opts = {})
    env = Rack::MockRequest.env_for(""http://www.example.com#{url}"", opts)
    ActionDispatch::Request.new(env)
  end

  def test_returns_success
    @request = request_for_url(""/posts"", method: :head)
    assert current_page?(controller: ""posts"", action: ""index"")
  end
end
```

### Expected behavior
<!-- Tell us what should happen -->

`current_page?(controller: ""posts"", action: ""index"")` returns true.

### Actual behavior
<!-- Tell us what happens instead -->

`current_page?(controller: ""posts"", action: ""index"")` returns false.

It appears that the issue is `url_for(options)` here:

https://github.com/rails/rails/blob/6d82760d5a0125fdbcf040fef590fc78bdf1d840/actionview/lib/action_view/helpers/url_helper.rb#L596


`current_page?(controller: ""posts"", action: ""index"")` returns false because `url_for(controller: ""spots"", action: ""index"")` returns `""/""`, which does not equal the `request_uri`, `""/posts""`.

### System configuration
**Rails version**: 7.0.4.2

**Ruby version**: 3.1.0
","{'url': 'https://api.github.com/repos/rails/rails/issues/47184/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47184/timeline,,
https://api.github.com/repos/rails/rails/issues/47180,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47180/labels{/name},https://api.github.com/repos/rails/rails/issues/47180/comments,https://api.github.com/repos/rails/rails/issues/47180/events,https://github.com/rails/rails/pull/47180,1561334573,PR_kwDNIULOSMHn5g,47180,Initializable improvements of doc and parameter name,"{'login': 'okuramasafumi', 'id': 1012014, 'node_id': 'MDQ6VXNlcjEwMTIwMTQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1012014?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/okuramasafumi', 'html_url': 'https://github.com/okuramasafumi', 'followers_url': 'https://api.github.com/users/okuramasafumi/followers', 'following_url': 'https://api.github.com/users/okuramasafumi/following{/other_user}', 'gists_url': 'https://api.github.com/users/okuramasafumi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/okuramasafumi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/okuramasafumi/subscriptions', 'organizations_url': 'https://api.github.com/users/okuramasafumi/orgs', 'repos_url': 'https://api.github.com/users/okuramasafumi/repos', 'events_url': 'https://api.github.com/users/okuramasafumi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/okuramasafumi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,0,2023-01-29T15:23:45Z,2023-03-28T06:18:43Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47180', 'html_url': 'https://github.com/rails/rails/pull/47180', 'diff_url': 'https://github.com/rails/rails/pull/47180.diff', 'patch_url': 'https://github.com/rails/rails/pull/47180.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because I noticed small room of improvement in `Initializable` module.

### Detail

This Pull Request does two things.

* Hide internal classes from documentation
* Change parameter name so that it doesn't override Kernel method

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47180/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47180/timeline,,
https://api.github.com/repos/rails/rails/issues/47175,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47175/labels{/name},https://api.github.com/repos/rails/rails/issues/47175/comments,https://api.github.com/repos/rails/rails/issues/47175/events,https://github.com/rails/rails/issues/47175,1561115608,I_kwDNIULOXQy72A,47175,The eager load associations need check association scope ,"{'login': 'OuYangJinTing', 'id': 33079237, 'node_id': 'MDQ6VXNlcjMzMDc5MjM3', 'avatar_url': 'https://avatars.githubusercontent.com/u/33079237?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/OuYangJinTing', 'html_url': 'https://github.com/OuYangJinTing', 'followers_url': 'https://api.github.com/users/OuYangJinTing/followers', 'following_url': 'https://api.github.com/users/OuYangJinTing/following{/other_user}', 'gists_url': 'https://api.github.com/users/OuYangJinTing/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/OuYangJinTing/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/OuYangJinTing/subscriptions', 'organizations_url': 'https://api.github.com/users/OuYangJinTing/orgs', 'repos_url': 'https://api.github.com/users/OuYangJinTing/repos', 'events_url': 'https://api.github.com/users/OuYangJinTing/events{/privacy}', 'received_events_url': 'https://api.github.com/users/OuYangJinTing/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,8,2023-01-29T04:08:06Z,2023-08-19T02:20:55Z,,CONTRIBUTOR,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org/""
  # source ""https://gems.ruby-china.com/""

  gem ""minitest"", ""~> 5.15""
  gem ""minitest-reporters""
  gem ""activerecord"", ""~> 7.0.2""
  gem ""sqlite3""
end

require ""minitest/autorun""
require ""minitest/reporters""
require ""active_record""

Minitest::Reporters.use!

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
    t.string :name, null: false
  end

  create_table :posts, force: true do |t|
    t.belongs_to :user
    t.string :title, null: false
  end
end

class User < ActiveRecord::Base
  has_many :posts, dependent: :destroy

  has_one :latest_post, -> { order(id: :desc) }, class_name: ""Post""
end

class Post < ActiveRecord::Base
  belongs_to :user
end

class BugTest < Minitest::Test
  def setup
    3.times do |i|
      User.create(name: ""foo-#{i + 1}"").tap do |user|
        10.times do |j|
          user.posts.create(title: ""bar-#{j + 1}"")
        end
      end
    end
  end


  def test_correct_query
    assert_equal 10, User.first.latest_post.id
    assert_equal 10, User.includes(:latest_post).first.latest_post.id
  end

  def test_wrong_query
    assert_equal 10, User.eager_load(:latest_post).first.latest_post.id
  end
end

```

### Expected behavior
<!-- Tell us what should happen -->

The `ActiveRecord` should raise error when try to execute `User.eager_load(:latest_post)`.
~~For example, like the `#check_eager_loadable!` method handles~~

### Actual behavior
<!-- Tell us what happens instead -->

The result of eager load is wrong

### System configuration
**Rails version**: 7

**Ruby version**: 3
","{'url': 'https://api.github.com/repos/rails/rails/issues/47175/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47175/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/47171,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47171/labels{/name},https://api.github.com/repos/rails/rails/issues/47171/comments,https://api.github.com/repos/rails/rails/issues/47171/events,https://github.com/rails/rails/issues/47171,1561049658,I_kwDNIULOXQu6Og,47171,`Child` is created twice when `Parent has_one Child` and update `Parent` from `before_create` of `Child`.,"{'login': 'kyanagi', 'id': 181194, 'node_id': 'MDQ6VXNlcjE4MTE5NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/181194?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kyanagi', 'html_url': 'https://github.com/kyanagi', 'followers_url': 'https://api.github.com/users/kyanagi/followers', 'following_url': 'https://api.github.com/users/kyanagi/following{/other_user}', 'gists_url': 'https://api.github.com/users/kyanagi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kyanagi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kyanagi/subscriptions', 'organizations_url': 'https://api.github.com/users/kyanagi/orgs', 'repos_url': 'https://api.github.com/users/kyanagi/repos', 'events_url': 'https://api.github.com/users/kyanagi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kyanagi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2023-01-28T23:29:19Z,2023-07-26T04:28:24Z,,NONE,,,,"### Steps to reproduce

This problem is not reproduced if we set `has_many :comments` instead of `has_one :comment`.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.integer :status
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_one :comment
end

class Comment < ActiveRecord::Base
  belongs_to :post
  before_create :update_post_status

  def update_post_status
    post.update!(status: 2)
  end
end

class BugTest < Minitest::Test
  def test_comment_is_created_only_once
    post = Post.create!
    Comment.create!(post:)

    pp Comment.all
    assert_equal 1, Comment.count
  end
end
```

### Expected behavior

`Comment` is created only once.

### Actual behavior

`Comment` is created twice.

```
% ruby b.rb
Fetching https://github.com/rails/rails.git
Fetching gem metadata from https://rubygems.org/......
Resolving dependencies...
Using rake 13.0.6
Using concurrent-ruby 1.2.0
Using connection_pool 2.3.0
Using minitest 5.17.0
Using builder 3.2.4
Using erubi 1.12.0
Using racc 1.6.2
Using crass 1.0.6
Using rack 3.0.4.1
Using nio4r 2.5.8
Using websocket-extensions 0.1.5
Using zeitwerk 2.6.6
Using marcel 1.0.2
Using mini_mime 1.1.2
Using date 3.3.3
Using timeout 0.3.1
Using bundler 2.4.1
Using thor 1.2.1
Using webrick 1.8.1
Using sqlite3 1.6.0 (arm64-darwin)
Using i18n 1.12.0
Using tzinfo 2.0.6
Using nokogiri 1.14.0 (arm64-darwin)
Using rack-session 2.0.0
Using websocket-driver 0.7.5
Using net-protocol 0.2.1
Using rack-test 2.0.2
Using activesupport 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using loofah 2.19.1
Using net-imap 0.3.4
Using net-pop 0.1.2
Using net-smtp 0.3.3
Using rackup 2.1.0
Using rails-dom-testing 2.0.3
Using rails-html-sanitizer 1.5.0
Using activemodel 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using mail 2.8.0.1
Using globalid 1.1.0
Using actionview 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using activerecord 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using actionpack 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using activejob 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using actioncable 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using railties 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using activestorage 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using actionmailer 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using actionmailbox 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using actiontext 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
Using rails 7.1.0.alpha from https://github.com/rails/rails.git (at main@0258cc4)
-- create_table(:posts, {:force=>true})
D, [2023-01-29T08:17:44.598399 #32858] DEBUG -- :    (0.0ms)  DROP TABLE IF EXISTS ""posts""
D, [2023-01-29T08:17:44.598584 #32858] DEBUG -- :    (0.1ms)  CREATE TABLE ""posts"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""status"" integer)
   -> 0.0045s
-- create_table(:comments, {:force=>true})
D, [2023-01-29T08:17:44.598686 #32858] DEBUG -- :    (0.0ms)  DROP TABLE IF EXISTS ""comments""
D, [2023-01-29T08:17:44.598756 #32858] DEBUG -- :    (0.0ms)  CREATE TABLE ""comments"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""post_id"" integer)
   -> 0.0001s
D, [2023-01-29T08:17:44.599317 #32858] DEBUG -- :    (0.0ms)  CREATE TABLE ""schema_migrations"" (""version"" varchar NOT NULL PRIMARY KEY)
D, [2023-01-29T08:17:44.599833 #32858] DEBUG -- :    (0.0ms)  CREATE TABLE ""ar_internal_metadata"" (""key"" varchar NOT NULL PRIMARY KEY, ""value"" varchar, ""created_at"" datetime(6) NOT NULL, ""updated_at"" datetime(6) NOT NULL)
D, [2023-01-29T08:17:44.607881 #32858] DEBUG -- :   ActiveRecord::InternalMetadata Load (0.6ms)  SELECT * FROM ""ar_internal_metadata"" WHERE ""ar_internal_metadata"".""key"" = ? ORDER BY ""ar_internal_metadata"".""key"" ASC LIMIT 1  [[nil, ""environment""]]
D, [2023-01-29T08:17:44.608046 #32858] DEBUG -- :   ActiveRecord::InternalMetadata Create (0.0ms)  INSERT INTO ""ar_internal_metadata"" (""key"", ""value"", ""created_at"", ""updated_at"") VALUES ('environment', 'development', '2023-01-28 23:17:44.607921', '2023-01-28 23:17:44.607923')
Run options: --seed 3183

# Running:

D, [2023-01-29T08:17:44.627165 #32858] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2023-01-29T08:17:44.627216 #32858] DEBUG -- :   Post Create (0.1ms)  INSERT INTO ""posts"" DEFAULT VALUES
D, [2023-01-29T08:17:44.627310 #32858] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
D, [2023-01-29T08:17:44.632578 #32858] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2023-01-29T08:17:44.632635 #32858] DEBUG -- :   Post Update (0.1ms)  UPDATE ""posts"" SET ""status"" = ? WHERE ""posts"".""id"" = ?  [[""status"", 2], [""id"", 1]]
D, [2023-01-29T08:17:44.632850 #32858] DEBUG -- :   Comment Create (0.0ms)  INSERT INTO ""comments"" (""post_id"") VALUES (?)  [[""post_id"", 1]]
D, [2023-01-29T08:17:44.632919 #32858] DEBUG -- :   Comment Create (0.0ms)  INSERT INTO ""comments"" DEFAULT VALUES
D, [2023-01-29T08:17:44.632982 #32858] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
D, [2023-01-29T08:17:44.637644 #32858] DEBUG -- :   Comment Load (0.0ms)  SELECT ""comments"".* FROM ""comments"" /* loading for pp */ LIMIT ?  [[""LIMIT"", 11]]
[#<Comment:0x000000010b649388 id: 1, post_id: 1>, #<Comment:0x000000010b649108 id: 2, post_id: nil>]
D, [2023-01-29T08:17:44.637970 #32858] DEBUG -- :   Comment Count (0.0ms)  SELECT COUNT(*) FROM ""comments""
F

Failure:
BugTest#test_comment_is_created_only_once [b.rb:51]:
Expected: 1
  Actual: 2


rails test b.rb:46



Finished in 0.013718s, 72.8969 runs/s, 72.8969 assertions/s.
1 runs, 1 assertions, 1 failures, 0 errors, 0 skips
```


### System configuration
**Rails version**: main@0258cc4

**Ruby version**: ruby 3.2.0 (2022-12-25 revision a528908271) [arm64-darwin21]
","{'url': 'https://api.github.com/repos/rails/rails/issues/47171/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 2}",https://api.github.com/repos/rails/rails/issues/47171/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/47163,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47163/labels{/name},https://api.github.com/repos/rails/rails/issues/47163/comments,https://api.github.com/repos/rails/rails/issues/47163/events,https://github.com/rails/rails/pull/47163,1560356969,PR_kwDNIULOSLVxxw,47163,Make `tag.attributes` token-list aware,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2023-01-27T20:00:58Z,2023-10-02T17:03:30Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47163', 'html_url': 'https://github.com/rails/rails/pull/47163', 'diff_url': 'https://github.com/rails/rails/pull/47163.diff', 'patch_url': 'https://github.com/rails/rails/pull/47163.patch', 'merged_at': None}","### Motivation / Background

Follow-up to [rails/rails#47159][]

Attribute merging will account for token lists attributes (like `class` and `aria-labelledby`) by combining values from left to right

```erb
<% weight = { class: ""font-bold"" } %>
<% color = { class: [""text-sm"", ""text-gray-700""] } %>
<% padding = { class: ""p-2"" } %>

<input <%= tag.attributes(weight, color, padding) %> >
  # => <input class=""font-bold text-sm text-gray-700 p-2"" >
```

### Detail

Introduce internal `ActionView::Attributes` class to account for
`tag.attributes` calls.

When merging attributes that are token lists (like `class` or
`aria-labelledby`, transform combine their values as they're merged
together.

For example:

```ruby
primary = { class: ""bg-red-500 text-white"" }
large = { class: ""text-lg p-4"" }
    
attributes = tag.attributes(primary, large)
attributes.to_h # => { class: ""bg-red-500 text-white text-lg p-4"" }
attributes.to_s # => ""class=\""bg-red-500 text-white text-lg p-4\""""
```

Similarly, the same applies for nested keys:

```ruby
attributes = tag.attributes({ aria: { labelledby: ""label_part_1"" } }, aria: { labelledby: ""label_part_2"" })
attributes.to_h # => { aria: { labelledby: ""label_part_1 label_part_2"" } }
attributes.to_s # => ""aria-labelledby=\""label_part_1 label_part_2\""""
```

#### Configuring token list support

To treat addition attributes as token lists, add values to the `config.action_view.token_lists` value:

```ruby
config.action_view.token_lists << ""data-action""
config.action_view.token_lists << ""data-controller""
config.action_view.token_lists << /data-(.*)-target/
```

[rails/rails#47159]: https://github.com/rails/rails/pull/47159

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47163/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47163/timeline,,
https://api.github.com/repos/rails/rails/issues/47161,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47161/labels{/name},https://api.github.com/repos/rails/rails/issues/47161/comments,https://api.github.com/repos/rails/rails/issues/47161/events,https://github.com/rails/rails/pull/47161,1560093276,PR_kwDNIULOSLHMXA,47161,Add support for `RETURNING` to `INSERT`/`UPDATE`/`DELETE` statements,"{'login': 'benedikt', 'id': 9696, 'node_id': 'MDQ6VXNlcjk2OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9696?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/benedikt', 'html_url': 'https://github.com/benedikt', 'followers_url': 'https://api.github.com/users/benedikt/followers', 'following_url': 'https://api.github.com/users/benedikt/following{/other_user}', 'gists_url': 'https://api.github.com/users/benedikt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/benedikt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/benedikt/subscriptions', 'organizations_url': 'https://api.github.com/users/benedikt/orgs', 'repos_url': 'https://api.github.com/users/benedikt/repos', 'events_url': 'https://api.github.com/users/benedikt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/benedikt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-01-27T16:59:33Z,2023-01-29T03:54:19Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47161', 'html_url': 'https://github.com/rails/rails/pull/47161', 'diff_url': 'https://github.com/rails/rails/pull/47161.diff', 'patch_url': 'https://github.com/rails/rails/pull/47161.patch', 'merged_at': None}","### Motivation / Background

This pull request adds support for `RETURNING` clauses to `INSERT`/`UPDATE`/`DELETE` statements in Arel. This is useful to build queries that modify data and return it (or something else) in the same query. 

The following example builds a query that deletes all data from a counter queue table and returns the aggregated counter delta values. 

```ruby 
counter_queue = Arel::Table.new(:counter_queue)
flush = Arel::Table.new(:flush)

delete_manager = Arel::DeleteManager.new 
  .from(counter_queue)
  .returning([counter_queue[:post_id], counter_queue[:delta]])

select_manager = Arel::SelectManager.new 
  .with(Arel::Nodes::TableAlias.new(Arel::Nodes::Grouping.new(delete_manager.ast), flush.name))
  .from(flush)
  .project(flush[:post_id], flush[:delta].sum) 
  .group(flush[:post_id])
```

```sql 
WITH ""flush"" AS (
  DELETE FROM
    ""counter_queue"" 
  RETURNING 
    ""counter_queue"".""post_id"",
    ""counter_queue"".""delta""
)
SELECT
  ""flush"".""post_id"",
  SUM(""flush"".""delta"")
FROM
  ""flush""
GROUP BY
  ""flush"".""post_id""
```


### Detail

To add support for `RETURNING`, this pull request adds a returning method to the sStatement and manager classes for insert, upsert, and delete. It also modifies the ToSql and Dot visitors to incorporate the returning statement (should there be one) into their output. 

### Additional information

The `RETURNING` syntax is supported in both PostgreSQL ([INSERT](https://www.postgresql.org/docs/current/sql-insert.html), [UPDATE](https://www.postgresql.org/docs/current/sql-update.html), [DELETE](https://www.postgresql.org/docs/current/sql-delete.html)) and Sqlite3 ([INSERT](https://www.sqlite.org/lang_insert.html), [UPDATE](https://www.sqlite.org/lang_update.html), [DELETE](https://www.sqlite.org/lang_delete.html)). MySQL does not support `RETURNING` on any of these statements at the moment. 

This pull request does not add `RETURNING` support to ActiveRecord itself (as discussed in #39968 and #42955). Nonetheless, I think this change to just Arel is useful in its own right to build more complex queries when needed.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47161/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47161/timeline,,
https://api.github.com/repos/rails/rails/issues/47159,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47159/labels{/name},https://api.github.com/repos/rails/rails/issues/47159/comments,https://api.github.com/repos/rails/rails/issues/47159/events,https://github.com/rails/rails/pull/47159,1559951775,PR_kwDNIULOSK_erQ,47159,`tag.attributes` accept variable number of `Hash`,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2023-01-27T15:27:46Z,2023-10-02T17:03:05Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47159', 'html_url': 'https://github.com/rails/rails/pull/47159', 'diff_url': 'https://github.com/rails/rails/pull/47159.diff', 'patch_url': 'https://github.com/rails/rails/pull/47159.patch', 'merged_at': None}","### Motivation / Background

The `tag.attributes` helper introduced in `7.0` can currently only transform a single `Hash` into an HTML attribute string. If that `Hash` is sourced from multiple pre-defined `Hash` instances, callers are responsible for merging or deep-merging their contents ahead of the call.

### Detail

This commit extends `tag.attributes` to accept a variable number of `Hash` arguments, deep merging them from left to right.

Considering a hypothetical where the following key-value pairings are appropriate, calls prior to this commit would resemble something like:

```erb
<%# elsewhere, or maybe from a view helper %>
<% first  = {aria: {label: 1}} %>
<% second = {aria: {label: 2, disabled: true}} %>
<% third  = {aria: {selected: false}} %>

<%# the call site %>
<%= tag.attributes(first.deep_merge(second).deep_merge(third)) %>
<%# or, if they're feeling clever %>
<%= tag.attributes([first, second, third].reduce(:deep_merge)) %>
```

With this change, the caller isn't responsible for merging:

```erb
<%# elsewhere, or maybe from a view helper %>
<% first  = {aria: {label: 1}} %>
<% second = {aria: {label: 2, disabled: true}} %>
<% third  = {aria: {selected: false}} %>

<%# the call site %>
<%= tag.attributes(first, second, third) %>
```

### Additional notes

We're calling `Hash#deep_merge` here to support `aria: {...}` and `data: {...}` attributes. Without it, subsequent `Hash` instances with `aria:` or `data:` keys would entirely clobber the ones passed before them.

There's still some improvements to be made here, in cases where callers would want to handle merging the _values_ in addition to the _keys_.

Take, for example, the `class:` attribute. Calling `tag.attributes({class: ""1""}, {class: ""2""}, class: ""3""})` would result in `class=""3""`. Since the [class](https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/class) attribute is a [DOMTokenList](https://developer.mozilla.org/en-US/docs/Web/API/DOMTokenList), there is an opportunity for Action View to know that ahead of time and resolve a merge conflict with a call to [token_list](https://edgeapi.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-token_list):

```ruby
tag.attributes({class: ""1""}, {class: ""2""}, {class: ""3""})
# => ""class=\""1 2 3\""""
```

In addition to `class`, there are other attributes known to be token lists, including [aria-labelledby](https://www.w3.org/TR/wai-aria/#aria-labelledby) (known as an [ID reference list](https://www.w3.org/TR/wai-aria/#valuetype_idref_list)). Action View could provide out-of-the-box token list support, and could also provide hooks to extend that to include other known token lists like [data-controller](https://stimulus.hotwired.dev/reference/controllers#multiple-controllers) and [data-action](https://stimulus.hotwired.dev/reference/actions#multiple-actions).

~I'm happy to explore this in a subsequent set of work if this style of `tag.attributes` invocation is accepted.~

I've opened https://github.com/rails/rails/pull/47163 to add this behavior.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47159/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47159/timeline,,
https://api.github.com/repos/rails/rails/issues/47158,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47158/labels{/name},https://api.github.com/repos/rails/rails/issues/47158/comments,https://api.github.com/repos/rails/rails/issues/47158/events,https://github.com/rails/rails/pull/47158,1559754005,PR_kwDNIULOSK0vjA,47158,Allow passing Symbols as aliases in Arel,"{'login': 'benedikt', 'id': 9696, 'node_id': 'MDQ6VXNlcjk2OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9696?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/benedikt', 'html_url': 'https://github.com/benedikt', 'followers_url': 'https://api.github.com/users/benedikt/followers', 'following_url': 'https://api.github.com/users/benedikt/following{/other_user}', 'gists_url': 'https://api.github.com/users/benedikt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/benedikt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/benedikt/subscriptions', 'organizations_url': 'https://api.github.com/users/benedikt/orgs', 'repos_url': 'https://api.github.com/users/benedikt/repos', 'events_url': 'https://api.github.com/users/benedikt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/benedikt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,0,2023-01-27T13:15:02Z,2023-02-10T09:00:51Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47158', 'html_url': 'https://github.com/rails/rails/pull/47158', 'diff_url': 'https://github.com/rails/rails/pull/47158.diff', 'patch_url': 'https://github.com/rails/rails/pull/47158.patch', 'merged_at': None}","### Motivation / Background

The following parts of Arel allow both Strings and Symbols to name things: 

```ruby
# Tables 
users = Arel::Table.new('users')
users = Arel::Table.new(:users)

# Columns
users['name']
users[:name]

# Table Alias
admins = users.alias('admins')
admins = users.alias(:admins)

# As 
users[:name].as('first_name')
users[:name].as(:first_name) # Currently raises an exception that symbols can't be convered into strings
```

The mismatch in behavior is very surprising and I keep stumbling over this while working with Arel, especially as using symbols with these methods is pretty common, even across the Rails codebase itself. 

### Detail

This pull request converts symbols to strings before wrapping them with an `Arel::Nodes::SqlLiteral` (which is a subclass of `String`). 

### Additional information

In the past, there used to be a `.to_s` call that was always applied to whatever was passed as name, but that was [expliclty removed](https://github.com/rails/rails/commit/1f5ed8eb20231644525bdad9a94a91e810191186). To keep the spirit of this change, this pull request explicitly only converts symbols into strings.


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47158/reactions', 'total_count': 3, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 3, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47158/timeline,,
https://api.github.com/repos/rails/rails/issues/47157,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47157/labels{/name},https://api.github.com/repos/rails/rails/issues/47157/comments,https://api.github.com/repos/rails/rails/issues/47157/events,https://github.com/rails/rails/pull/47157,1559693436,PR_kwDNIULOSKxbrw,47157,Adds support for `UPDATE ... FROM ...` syntax to Arel,"{'login': 'benedikt', 'id': 9696, 'node_id': 'MDQ6VXNlcjk2OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9696?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/benedikt', 'html_url': 'https://github.com/benedikt', 'followers_url': 'https://api.github.com/users/benedikt/followers', 'following_url': 'https://api.github.com/users/benedikt/following{/other_user}', 'gists_url': 'https://api.github.com/users/benedikt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/benedikt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/benedikt/subscriptions', 'organizations_url': 'https://api.github.com/users/benedikt/orgs', 'repos_url': 'https://api.github.com/users/benedikt/repos', 'events_url': 'https://api.github.com/users/benedikt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/benedikt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,2,2023-01-27T12:32:42Z,2023-02-14T10:27:08Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47157', 'html_url': 'https://github.com/rails/rails/pull/47157', 'diff_url': 'https://github.com/rails/rails/pull/47157.diff', 'patch_url': 'https://github.com/rails/rails/pull/47157.patch', 'merged_at': None}","### Motivation / Background

This Pull Request adds support for the `UPDATE ... FROM ...` syntax to Arel's `UpdateStatement` and `UpdateManager`. This syntax is particularly useful when updating records in bulk based on data in a different table or a subexpression. 

One example where this is useful is bulk updating counter cache columns in a single query. The following Ruby code creates an update statement that updates the comments_count columns of all users with the number of comments they posted. 

```ruby 
users = Arel::Table.new(:users)
comments = Arel::Table.new(:comments)

comments_count = comments
  .project(comments[:user_id], Arel.star.count)
  .group(comments[:user_id])
  .as(""comments_count"")

update_manager = Arel::UpdateManager.new
  .table(users)
  .from(comments_count)
  .set([[users[:comments_count], comments_count[:count]]])
  .where(users[:id].eq(comments_count[:user_id]))
```

This will generate a query like this:

```sql 
UPDATE
  ""users""
SET
  ""comments_count"" = comments_count.""count""
FROM
  (
    SELECT
      ""comments"".""user_id"",
      COUNT(*)
    FROM
      ""comments""
    GROUP BY
      ""comments"".""user_id""
  ) comments_count
WHERE
  ""users"".""id"" = comments_count.""user_id""
```

### Detail

To add support for `UPDATE ... FROM ...` this pull requests add a `#from` method to both `Arel::UpdateManager` and `Arel::Nodes::UpdateStatement`. It also modifies the `Arel::Visitor::ToSql` and `Arel::Visitors::Dot` visitors to generate the respective SQL snippet and graph edge. 

### Additional information

The `UPDATE ... FROM ...` syntax is supported in both [PostgreSQL](https://www.postgresql.org/docs/current/sql-update.html) and [Sqlite3](https://www.sqlite.org/lang_update.html). 

The syntax is not supported in MySQL at the moment. There's [a way of adding similar behavior](https://dev.mysql.com/doc/refman/8.0/en/update.html) by adding the `from` table to the list of tables to be updated. This pull request doesn't implement this, though.

Very similar work has been done by @quentindemetz in #47188 and @lazaronixon in #46487. 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47157/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47157/timeline,,
https://api.github.com/repos/rails/rails/issues/47154,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47154/labels{/name},https://api.github.com/repos/rails/rails/issues/47154/comments,https://api.github.com/repos/rails/rails/issues/47154/events,https://github.com/rails/rails/pull/47154,1558392812,PR_kwDNIULOSJq1zg,47154,Visit all arel nodes when compiling a values list to SQL,"{'login': 'benedikt', 'id': 9696, 'node_id': 'MDQ6VXNlcjk2OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9696?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/benedikt', 'html_url': 'https://github.com/benedikt', 'followers_url': 'https://api.github.com/users/benedikt/followers', 'following_url': 'https://api.github.com/users/benedikt/following{/other_user}', 'gists_url': 'https://api.github.com/users/benedikt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/benedikt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/benedikt/subscriptions', 'organizations_url': 'https://api.github.com/users/benedikt/orgs', 'repos_url': 'https://api.github.com/users/benedikt/repos', 'events_url': 'https://api.github.com/users/benedikt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/benedikt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-01-26T16:09:57Z,2023-02-14T10:34:56Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47154', 'html_url': 'https://github.com/rails/rails/pull/47154', 'diff_url': 'https://github.com/rails/rails/pull/47154.diff', 'patch_url': 'https://github.com/rails/rails/pull/47154.patch', 'merged_at': None}","### Detail

This pull request relaxes the requirements for a value inside a ValueList to be visited by the ToSql visitor. Previously, anything but Nodes::BindParam or Nodes::SqlLiteral would be quoted (which fails because nodes can't be quoted). This change makes sure that all types of nodes are visited. This makes it possible to use function calls or type casts or other computations (like summing to values) within a values list.

### Additional information 

A similar change has been suggested by @quentindemetz in #47187

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47154/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47154/timeline,,
https://api.github.com/repos/rails/rails/issues/47153,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47153/labels{/name},https://api.github.com/repos/rails/rails/issues/47153/comments,https://api.github.com/repos/rails/rails/issues/47153/events,https://github.com/rails/rails/pull/47153,1558092244,PR_kwDNIULOSJajgw,47153,Fix test:units and test:functionals commands for a new application,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,2,2023-01-26T12:50:11Z,2023-02-01T20:59:43Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47153', 'html_url': 'https://github.com/rails/rails/pull/47153', 'diff_url': 'https://github.com/rails/rails/pull/47153.diff', 'patch_url': 'https://github.com/rails/rails/pull/47153.patch', 'merged_at': None}","### Motivation / Background

When creating a new application the `test/unit` and `test/functional` directories are no longer created. Running `bin/rails test:units` or `bin/rails test:functionals` tries to run tests in these directories but will fail when any of the directories are missing.

### Detail

By using a glob pattern for the tests the task will no longer fail when run.

### Additional information

Another option would be checking if the directories exist, or removing these test tasks altogether.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47153/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47153/timeline,,
https://api.github.com/repos/rails/rails/issues/47151,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47151/labels{/name},https://api.github.com/repos/rails/rails/issues/47151/comments,https://api.github.com/repos/rails/rails/issues/47151/events,https://github.com/rails/rails/pull/47151,1557542208,PR_kwDNIULOSI9ZzQ,47151,[Fix #47135] Replace target on `belongs_to` and `has_one` multiple assignment,"{'login': 'joshuay03', 'id': 54629302, 'node_id': 'MDQ6VXNlcjU0NjI5MzAy', 'avatar_url': 'https://avatars.githubusercontent.com/u/54629302?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/joshuay03', 'html_url': 'https://github.com/joshuay03', 'followers_url': 'https://api.github.com/users/joshuay03/followers', 'following_url': 'https://api.github.com/users/joshuay03/following{/other_user}', 'gists_url': 'https://api.github.com/users/joshuay03/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/joshuay03/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/joshuay03/subscriptions', 'organizations_url': 'https://api.github.com/users/joshuay03/orgs', 'repos_url': 'https://api.github.com/users/joshuay03/repos', 'events_url': 'https://api.github.com/users/joshuay03/events{/privacy}', 'received_events_url': 'https://api.github.com/users/joshuay03/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2023-01-26T02:32:52Z,2023-06-10T00:39:44Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47151', 'html_url': 'https://github.com/rails/rails/pull/47151', 'diff_url': 'https://github.com/rails/rails/pull/47151.diff', 'patch_url': 'https://github.com/rails/rails/pull/47151.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created to address https://github.com/rails/rails/issues/47135.

### Detail

This Pull Request updates `ActiveRecord::Associations::HasOneAssociation#replace` to reload the target if the record's foreign key has been changed when carrying out a multiple `belongs_to` and `has_one` assignment. This resets the loaded target when assigning the `belongs_to` and ensures that the existing target is actually replaced.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

See comment below for the drawback of this solution.

Also, I had a bad rebase initially resulting in incorrect labelling, I'd appreciate it if someone could update the labels.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47151/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47151/timeline,,
https://api.github.com/repos/rails/rails/issues/47149,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47149/labels{/name},https://api.github.com/repos/rails/rails/issues/47149/comments,https://api.github.com/repos/rails/rails/issues/47149/events,https://github.com/rails/rails/pull/47149,1557399622,PR_kwDNIULOSI1-Zw,47149,Add `InheritableOptions#override?`,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2023-01-25T23:19:04Z,2023-02-08T06:46:25Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47149', 'html_url': 'https://github.com/rails/rails/pull/47149', 'diff_url': 'https://github.com/rails/rails/pull/47149.diff', 'patch_url': 'https://github.com/rails/rails/pull/47149.patch', 'merged_at': None}","`InheritableOptions#override?` returns true if a given key has an associated value that is not inherited.  This can be used, for example, to detect whether a `config.*` value was explicitly set by the user.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47149/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47149/timeline,,
https://api.github.com/repos/rails/rails/issues/47136,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47136/labels{/name},https://api.github.com/repos/rails/rails/issues/47136/comments,https://api.github.com/repos/rails/rails/issues/47136/events,https://github.com/rails/rails/pull/47136,1556770087,PR_kwDNIULOSIUCpA,47136,Use `sole` when calling has_one predicate accessor,"{'login': 'stevepolitodesign', 'id': 5122678, 'node_id': 'MDQ6VXNlcjUxMjI2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5122678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/stevepolitodesign', 'html_url': 'https://github.com/stevepolitodesign', 'followers_url': 'https://api.github.com/users/stevepolitodesign/followers', 'following_url': 'https://api.github.com/users/stevepolitodesign/following{/other_user}', 'gists_url': 'https://api.github.com/users/stevepolitodesign/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/stevepolitodesign/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/stevepolitodesign/subscriptions', 'organizations_url': 'https://api.github.com/users/stevepolitodesign/orgs', 'repos_url': 'https://api.github.com/users/stevepolitodesign/repos', 'events_url': 'https://api.github.com/users/stevepolitodesign/events{/privacy}', 'received_events_url': 'https://api.github.com/users/stevepolitodesign/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2023-01-25T14:41:08Z,2023-01-27T14:55:40Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47136', 'html_url': 'https://github.com/rails/rails/pull/47136', 'diff_url': 'https://github.com/rails/rails/pull/47136.diff', 'patch_url': 'https://github.com/rails/rails/pull/47136.patch', 'merged_at': None}","Introduces `other!` to the list of [generated methods][] for singular associations.

```ruby
account.beneficiary
#=> nil

account.benificiary!
#=> #<ActiveRecord::RecordNotFound>

Benificiary.create!(account: account)
account.benificiary!
#=> #<Benificiary>

Benificiary.create!(account: account)
account.benificiary!
#=> #<ActiveRecord::SoleRecordExceeded>
```

Rails provides the ability to [find the sole matching record via sole][sole]. I thought adding this predicate method would compliment that existing behavior.

[generated methods]: https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#module-ActiveRecord::Associations::ClassMethods-label-Singular+associations+-28one-to-one-29
[sole]: https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-sole","{'url': 'https://api.github.com/repos/rails/rails/issues/47136/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47136/timeline,,
https://api.github.com/repos/rails/rails/issues/47135,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47135/labels{/name},https://api.github.com/repos/rails/rails/issues/47135/comments,https://api.github.com/repos/rails/rails/issues/47135/events,https://github.com/rails/rails/issues/47135,1556576975,I_kwDNIULOXMd6zw,47135,"has_one multiple assignment, update lost ","{'login': 'montdidier', 'id': 1673628, 'node_id': 'MDQ6VXNlcjE2NzM2Mjg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1673628?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/montdidier', 'html_url': 'https://github.com/montdidier', 'followers_url': 'https://api.github.com/users/montdidier/followers', 'following_url': 'https://api.github.com/users/montdidier/following{/other_user}', 'gists_url': 'https://api.github.com/users/montdidier/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/montdidier/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/montdidier/subscriptions', 'organizations_url': 'https://api.github.com/users/montdidier/orgs', 'repos_url': 'https://api.github.com/users/montdidier/repos', 'events_url': 'https://api.github.com/users/montdidier/events{/privacy}', 'received_events_url': 'https://api.github.com/users/montdidier/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2023-01-25T12:37:18Z,2023-02-07T15:35:45Z,,CONTRIBUTOR,,,,"### Steps to reproduce

```ruby
#!/usr/bin/env ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  gem ""rails"", '~> 6.1.0'
  gem ""sqlite3""
  gem ""byebug""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :subscriptions do |t|
    t.string :name
  end

  create_table :payment_accounts do |t|
    t.string :name
    t.references :subscription
  end
end

class Subscription < ActiveRecord::Base
  has_one :payment_account, inverse_of: :subscription, dependent: :destroy
end

class PaymentAccount < ActiveRecord::Base
  belongs_to :subscription, inverse_of: :payment_account, optional: true
end

class TestDoubleBackwardsAssigment < Minitest::Test
  def test_double_backward_assignment
    subscription = Subscription.create(name: 'Example subsciption')
    originl_payment_account = PaymentAccount.create(subscription: subscription, name: ""Bob's account"")
    assert_equal ""Bob's account"", subscription.payment_account.name

    new_payment_account = PaymentAccount.new(name: ""Fran's account"")
    new_payment_account.subscription = subscription

    subscription.payment_account = new_payment_account

    subscription.save!

    assert_equal ""Fran's account"", subscription.reload.payment_account.name

    assert_equal 1, PaymentAccount.count
  end
end

```

### Expected behaviour

One would be least surprised to see that Fran's account has been persisted and that there is only one PaymentAccount in the database. The test should show Fran's account as being the associated persisted account and that total PaymentAccounts would be 1.

Upon inspecting the code it appears the problem probably lies in the area of:

`ActiveRecord::Associations::HasOneAssociation#replace`

### Actual behaviour

What seems to be happening is that that the has_one association , when assigned via the inverse belongs_to relationship, that then receives an additional assignment from the front - does not understand that the has_one entity needs to be persisted and that the existing has_one persisted target needs to be deleted. It seem that the unpersisted target is not checked to see if it is a new record and is assumed to have not changed.  I think it should detect the target is unpersisted, respect the last assignment , reload the the target from the db, destroy it and then make the assignment, then persist the new assignment.

It is quite close to doing the right thing. For example there is a check [here](https://github.com/rails/rails/blob/bcc1eb727b368aab7b83077643e7681ef63619ea/activerecord/lib/active_record/associations/has_one_association.rb#L57) where the target could potentially be reloaded but I don't quite understand the logic in `load_target` here with respect to detecting `staleness` or whether the most up-to-date entity is loaded.

### System configuration
**Rails version**: 6.1.7.2
**Ruby version**: 3.0.4
","{'url': 'https://api.github.com/repos/rails/rails/issues/47135/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47135/timeline,,
https://api.github.com/repos/rails/rails/issues/47130,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47130/labels{/name},https://api.github.com/repos/rails/rails/issues/47130/comments,https://api.github.com/repos/rails/rails/issues/47130/events,https://github.com/rails/rails/pull/47130,1555851241,PR_kwDNIULOSHjHKg,47130,Fix grouped count for arel attributes,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2023-01-25T00:06:21Z,2023-01-25T02:02:28Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47130', 'html_url': 'https://github.com/rails/rails/pull/47130', 'diff_url': 'https://github.com/rails/rails/pull/47130.diff', 'patch_url': 'https://github.com/rails/rails/pull/47130.patch', 'merged_at': None}",Fixes #47125.,"{'url': 'https://api.github.com/repos/rails/rails/issues/47130/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47130/timeline,,
https://api.github.com/repos/rails/rails/issues/47125,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47125/labels{/name},https://api.github.com/repos/rails/rails/issues/47125/comments,https://api.github.com/repos/rails/rails/issues/47125/events,https://github.com/rails/rails/issues/47125,1555430017,I_kwDNIULOXLX6gQ,47125,`COUNT(DISTINCT ..)` using a column name from `arel_table` returns incorrect result against MariaDB,"{'login': 'kwojcik', 'id': 8961787, 'node_id': 'MDQ6VXNlcjg5NjE3ODc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8961787?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kwojcik', 'html_url': 'https://github.com/kwojcik', 'followers_url': 'https://api.github.com/users/kwojcik/followers', 'following_url': 'https://api.github.com/users/kwojcik/following{/other_user}', 'gists_url': 'https://api.github.com/users/kwojcik/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kwojcik/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kwojcik/subscriptions', 'organizations_url': 'https://api.github.com/users/kwojcik/orgs', 'repos_url': 'https://api.github.com/users/kwojcik/repos', 'events_url': 'https://api.github.com/users/kwojcik/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kwojcik/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2023-01-24T18:04:01Z,2023-01-31T13:03:59Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

Test passes against homebrew MySQL `5.7.40 Homebrew` and fails against MariaDB `5.5.5-10.10.2-MariaDB-1:10.10.2+maria~ubu2204`. MySQL was run using homebrew. MariaDB was run using `docker run --name mariadb -e MARIADB_ALLOW_EMPTY_ROOT_PASSWORD=true -p 3306:3306 -d mariadb`.

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.0.0""
  gem ""mysql2""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""mysql2"", database: ""bug_test"", user: 'root', host: '127.0.0.1', port: 3306)
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.string :status
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!
    post.comments << Comment.create!(status: 'a')
    post.comments << Comment.create!(status: 'b')

    expected = {'a' => 1, 'b' => 1}
    assert_equal expected, Comment.group(:status).distinct.count(:post_id)
    assert_equal expected, Comment.group(:status).distinct.count(Comment.arel_table[:post_id])
  end
end
```

### Expected behavior
Both queries should return the same result

### Actual behavior
Using an `arel_table` column name in the `count` clause causes the result to always set the count to `0` on MariaDB.

### System configuration
**Rails version**: `7.0.4.1`

**Ruby version**: `3.1.1`
","{'url': 'https://api.github.com/repos/rails/rails/issues/47125/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47125/timeline,,
https://api.github.com/repos/rails/rails/issues/47088,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47088/labels{/name},https://api.github.com/repos/rails/rails/issues/47088/comments,https://api.github.com/repos/rails/rails/issues/47088/events,https://github.com/rails/rails/pull/47088,1551379967,PR_kwDNIULOSD3CVA,47088,fix(autosave-association): 4 -> 4.1 number does not generate error messages in nested_attributes,"{'login': 'JohnAnon9771', 'id': 42195321, 'node_id': 'MDQ6VXNlcjQyMTk1MzIx', 'avatar_url': 'https://avatars.githubusercontent.com/u/42195321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/JohnAnon9771', 'html_url': 'https://github.com/JohnAnon9771', 'followers_url': 'https://api.github.com/users/JohnAnon9771/followers', 'following_url': 'https://api.github.com/users/JohnAnon9771/following{/other_user}', 'gists_url': 'https://api.github.com/users/JohnAnon9771/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/JohnAnon9771/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/JohnAnon9771/subscriptions', 'organizations_url': 'https://api.github.com/users/JohnAnon9771/orgs', 'repos_url': 'https://api.github.com/users/JohnAnon9771/repos', 'events_url': 'https://api.github.com/users/JohnAnon9771/events{/privacy}', 'received_events_url': 'https://api.github.com/users/JohnAnon9771/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2023-01-20T20:04:20Z,2023-08-19T19:35:30Z,,CONTRIBUTOR,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47088', 'html_url': 'https://github.com/rails/rails/pull/47088', 'diff_url': 'https://github.com/rails/rails/pull/47088.diff', 'patch_url': 'https://github.com/rails/rails/pull/47088.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This PR is just an initial idea of how to resolve issue #46509 where changes to nested_attributes do not generate error messages when the model has `only_integer` validation

The initial idea is to create a new attribute that detects when it hears changes before the type cast happens. With this, it is able to detect fractional changes such as 4 -> 4.1 and notify autosave that it needs to generate exceptions.

Please, this is my first Rails code change, so if there's any ""dumb"" code, forgive me, I'm still figuring out how things work 

### Detail

I think everything you need to know about the problem is in #46509

About PR also came two new attributes... I don't know if they really make sense to exist, I left it just for discussion

`comment.likes_count_raw_changed?`
`comment.has_changes_to_validate?`

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/47088/reactions', 'total_count': 4, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 1, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47088/timeline,,
https://api.github.com/repos/rails/rails/issues/47071,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47071/labels{/name},https://api.github.com/repos/rails/rails/issues/47071/comments,https://api.github.com/repos/rails/rails/issues/47071/events,https://github.com/rails/rails/issues/47071,1550532696,I_kwDNIULOXGtAWA,47071,Active Storage previewable not resized when using proxy mode on storage service local,"{'login': 'mbodlund', 'id': 185284, 'node_id': 'MDQ6VXNlcjE4NTI4NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/185284?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mbodlund', 'html_url': 'https://github.com/mbodlund', 'followers_url': 'https://api.github.com/users/mbodlund/followers', 'following_url': 'https://api.github.com/users/mbodlund/following{/other_user}', 'gists_url': 'https://api.github.com/users/mbodlund/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mbodlund/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mbodlund/subscriptions', 'organizations_url': 'https://api.github.com/users/mbodlund/orgs', 'repos_url': 'https://api.github.com/users/mbodlund/repos', 'events_url': 'https://api.github.com/users/mbodlund/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mbodlund/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2023-01-20T09:16:27Z,2023-02-10T03:15:49Z,,NONE,,,,"### Steps to reproduce

Active proxy mode or use rails_storage_proxy_path to generate preview of a video or pdf.
Rails.application.config.active_storage.resolve_model_to_route = :rails_storage_proxy

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
development.rb
config.active_storage.service = :local

active_storage.rb
Rails.application.config.active_storage.resolve_model_to_route = :rails_storage_proxy

In a view
image_tag message.video.preview(resize_to_limit: [100, 100]) 
```


### Expected behavior
An jpg version resized to limit 100x100


### Actual behavior
Returns a jpg version in the same size as the original video (or pdf)

If you turn off rails_storage_proxy it works as expected.


### System configuration
Rails 7.0.4.1
ffmpeg version 5.1.2 (also tried version 3.x and 4.x with the same result)
mutool version 1.20.0

Ruby 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/47071/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47071/timeline,,
https://api.github.com/repos/rails/rails/issues/47047,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47047/labels{/name},https://api.github.com/repos/rails/rails/issues/47047/comments,https://api.github.com/repos/rails/rails/issues/47047/events,https://github.com/rails/rails/issues/47047,1537738526,I_kwDNIULOW6gHHg,47047,ActiveStorage::FileNotFoundError due to upload after commit,"{'login': 'sbungartz', 'id': 7670818, 'node_id': 'MDQ6VXNlcjc2NzA4MTg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7670818?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sbungartz', 'html_url': 'https://github.com/sbungartz', 'followers_url': 'https://api.github.com/users/sbungartz/followers', 'following_url': 'https://api.github.com/users/sbungartz/following{/other_user}', 'gists_url': 'https://api.github.com/users/sbungartz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sbungartz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sbungartz/subscriptions', 'organizations_url': 'https://api.github.com/users/sbungartz/orgs', 'repos_url': 'https://api.github.com/users/sbungartz/repos', 'events_url': 'https://api.github.com/users/sbungartz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sbungartz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,10,2023-01-18T10:16:33Z,2023-10-02T10:51:00Z,,NONE,,,,"We were getting `ActiveStorage::FileNotFoundError`s spuriously and are fairly confident that this is a race condition in the way ActiveStorage handles uploads and attachment.

### Steps to reproduce
In the [rails guides](https://guides.rubyonrails.org/active_storage_overview.html#has-one-attached), the recommended set up for a controller that attaches a file to a model is as follows:

```ruby
class SignupController < ApplicationController
  def create
    user = User.create!(user_params)
    redirect_to root_path
  end

  private
  def user_params
    params.require(:user).permit(:email_address, :password, :avatar)
  end
end
```

When using this recommended set up Rails will upload the file [_after committing_](https://github.com/rails/rails/blob/18707ab17fa492eb25ad2e8f9818a320dc20b823/activestorage/lib/active_storage/attached/model.rb#L77) the creation and attachment of the `Blob` to the model.
Within the same thread this is not a problem because the hook will obviously wait until the upload is finished and other code runs that might depend on that file.
However since the `Blob` and `Attachment` are already committed in the database, parallel processes like integrations polling for updates, or even just users clicking on the entity at just the wrong moment, will already see the attachment and try to download it causing an `ActiveStorage::FileNotFoundError`.

### Expected behavior
Before the file is actually uploaded, the `User` should not be committed to the database.
For updates, the `Attachment` should not be committed to the database before upload is finished.

### Actual behavior
The new user is committed with the `Blob` attached before the file is uploaded. Other requests or background tasks can find that `User` causing an `ActiveStorage::FileNotFoundError` when they try to download the avatar.

### Our workaround
Rewriting the controller like this solves the problem as the file is uploaded before the change is committed to the database:
_Edit:_ The original version of the workaround that I posted broke presence-validation. With this updated variant, we still just assign `nil` to the `avatar`, if the param is not sent, so displaying form errors still works normally.

```ruby
class SignupController < ApplicationController
  def create
    user = User.new(user_params.except(:avatar)) # Note this change, to avoid creating the attachment twice.
    user.avatar = try_create_and_upload_blob!(user_params.fetch(:avatar, nil))

    user.save!
    redirect_to root_path
  end

  private
  def user_params
    params.require(:user).permit(:email_address, :password, :avatar)
  end

  # This can also be put somewhere as a static method for reuse in different controllers.
  def try_create_and_upload_blob!(uploaded_file)
    return nil if uploaded_file.blank?
    ActiveStorage::Blob.create_and_upload!(
      io: uploaded_file.to_io,
      filename: uploaded_file.original_filename,
    )
  end
end
```

This makes sure, that the file is completely uploaded before the `Blob` is attached to the `User`. Of course this is quite a bit more cumbersome.

### Other considerations
I could also see other problems arising from doing a long upload within a transaction, so I was wondering if this was intentional.

If upload it is really supposed to be happening in the `after_commit`, at least the guide should point out these potential issues and maybe we can even find a way to make uploading before committing less verbose and cumbersome.

### Potentially related issues
These issues might be related:
- #42003
- #39107

### System configuration
**Rails version**: `6.1.6`

**Ruby version**: `3.1.3`","{'url': 'https://api.github.com/repos/rails/rails/issues/47047/reactions', 'total_count': 5, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47047/timeline,,
https://api.github.com/repos/rails/rails/issues/47035,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47035/labels{/name},https://api.github.com/repos/rails/rails/issues/47035/comments,https://api.github.com/repos/rails/rails/issues/47035/events,https://github.com/rails/rails/pull/47035,1536859474,PR_kwDNIULOR5Ef_w,47035,Support nested middleware stacks,"{'login': 'nickh', 'id': 6218, 'node_id': 'MDQ6VXNlcjYyMTg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6218?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nickh', 'html_url': 'https://github.com/nickh', 'followers_url': 'https://api.github.com/users/nickh/followers', 'following_url': 'https://api.github.com/users/nickh/following{/other_user}', 'gists_url': 'https://api.github.com/users/nickh/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nickh/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nickh/subscriptions', 'organizations_url': 'https://api.github.com/users/nickh/orgs', 'repos_url': 'https://api.github.com/users/nickh/repos', 'events_url': 'https://api.github.com/users/nickh/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nickh/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,6,2023-01-17T18:40:55Z,2023-06-06T19:00:39Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47035', 'html_url': 'https://github.com/rails/rails/pull/47035', 'diff_url': 'https://github.com/rails/rails/pull/47035.diff', 'patch_url': 'https://github.com/rails/rails/pull/47035.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because middleware configuration can be unwieldy/confusing when an application needs to add many middlewares in specific locations on the stack relative to the default stack.

For example, to add a list of app-specific middleware `A`, `B,` and `C` in order before the start of the default Rails middleware stack, one might use:

```ruby
config.middleware.insert_before ActionDispatch::HostAuthorization, A
config.middleware.insert_before ActionDispatch::HostAuthorization, B
config.middleware.insert_before ActionDispatch::HostAuthorization, C
```

This is slightly nonintuitive in that each successive middleware is being sandwiched between the last app-specific middleware and `ActionDispatch::HostAuthorization`, and is also more brittle with a dependency on the presence and location of `ActionDispatch::HostAuthorization`.

One could also use:

```ruby
config.middleware.unshift C
config.middleware.unshift B
config.middleware.unshift A
```

This ensures that the app-specific middleware is located before the Rails middleware, but must be added in reverse to get the desired order.


### Detail

This Pull Request changes middleware configuration to allow stacks to be nested. In the above example, the app-specific middleware could be configured in its own stack proxy, and then added to the Rails root stack proxy with one configuration directive:

```ruby
app_stack = config.middleware.create_stack
app_stack.use A
app_stack.use B
app_stack.use C

config.middleware.unshift app_stack
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

This change defers flattening of the nested middleware stacks until the top-level stack proxy is merged into a stack, so later changes to a nested stack are still included:

```ruby
app_stack = config.middleware.create_stack
app_stack.use A
app_stack.use B

config.middleware.unshift app_stack

# This middleware will be at the expected location in the app's middleware stack when it is built
app_stack.use C
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/47035/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47035/timeline,,
https://api.github.com/repos/rails/rails/issues/47000,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/47000/labels{/name},https://api.github.com/repos/rails/rails/issues/47000/comments,https://api.github.com/repos/rails/rails/issues/47000/events,https://github.com/rails/rails/pull/47000,1532571715,PR_kwDNIULOR1gueA,47000,Add create_! and build_ methods for collection associations,"{'login': 'keshavbiswa', 'id': 27268721, 'node_id': 'MDQ6VXNlcjI3MjY4NzIx', 'avatar_url': 'https://avatars.githubusercontent.com/u/27268721?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/keshavbiswa', 'html_url': 'https://github.com/keshavbiswa', 'followers_url': 'https://api.github.com/users/keshavbiswa/followers', 'following_url': 'https://api.github.com/users/keshavbiswa/following{/other_user}', 'gists_url': 'https://api.github.com/users/keshavbiswa/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/keshavbiswa/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/keshavbiswa/subscriptions', 'organizations_url': 'https://api.github.com/users/keshavbiswa/orgs', 'repos_url': 'https://api.github.com/users/keshavbiswa/repos', 'events_url': 'https://api.github.com/users/keshavbiswa/events{/privacy}', 'received_events_url': 'https://api.github.com/users/keshavbiswa/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2023-01-13T16:18:40Z,2023-08-10T15:15:31Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/47000', 'html_url': 'https://github.com/rails/rails/pull/47000', 'diff_url': 'https://github.com/rails/rails/pull/47000.diff', 'patch_url': 'https://github.com/rails/rails/pull/47000.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background
This Pull Request has been created to add create_! and build_ methods for collection associations. These methods allow for a more expressive and consistent syntax when creating and building associated objects.

This Pull Request has been created because `user.create_post` is more intuitive `user.posts.create!`
### Detail

- adds new methods create_! and build_ to collection associations. 
- methods are defined in the `CollectionAssociation` class in the `activerecord/lib/active_record/associations/builder/collection_association.rb` file. 
- Add define_constructors to Association for all reflection except polymorphic and has_many_through.
- Added has_many? method in reflection.rb
- Added define_association_name in association.rb to be implemented in children classes.

### Additional information

This change is a small enhancement in the API and will not affect the current behavior of the framework.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.

PS: **This is my first time contributing to Rails, I may have not added all the tests, please let me know if there are other tests to be added. Also need help with the Changelog **
","{'url': 'https://api.github.com/repos/rails/rails/issues/47000/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/47000/timeline,,
https://api.github.com/repos/rails/rails/issues/46918,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46918/labels{/name},https://api.github.com/repos/rails/rails/issues/46918/comments,https://api.github.com/repos/rails/rails/issues/46918/events,https://github.com/rails/rails/pull/46918,1523944491,PR_kwDNIULORuQjfA,46918,Trivial performance improvements for Inflector methods,"{'login': 'amatsuda', 'id': 11493, 'node_id': 'MDQ6VXNlcjExNDkz', 'avatar_url': 'https://avatars.githubusercontent.com/u/11493?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/amatsuda', 'html_url': 'https://github.com/amatsuda', 'followers_url': 'https://api.github.com/users/amatsuda/followers', 'following_url': 'https://api.github.com/users/amatsuda/following{/other_user}', 'gists_url': 'https://api.github.com/users/amatsuda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/amatsuda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/amatsuda/subscriptions', 'organizations_url': 'https://api.github.com/users/amatsuda/orgs', 'repos_url': 'https://api.github.com/users/amatsuda/repos', 'events_url': 'https://api.github.com/users/amatsuda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/amatsuda/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2023-01-07T16:07:07Z,2023-01-27T05:14:23Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46918', 'html_url': 'https://github.com/rails/rails/pull/46918', 'diff_url': 'https://github.com/rails/rails/pull/46918.diff', 'patch_url': 'https://github.com/rails/rails/pull/46918.patch', 'merged_at': None}","### Detail

Here are some patches that make Inflector methods a little bit more effective and GC friendly.

### Benchmark Results

```ruby
Benchmark.ips do |x|
  x.report('old') do
    ActiveSupport::Inflector.humanize_old('foo')
  end
  x.report('new') do
    ActiveSupport::Inflector.humanize('foo')
  end
  x.compare!
end
```

```
Warming up --------------------------------------
                 old    53.656k i/100ms
                 new    59.915k i/100ms
Calculating -------------------------------------
                 old    534.355k ( 1.1%) i/s -      2.683M in   5.021228s
                 new    595.682k ( 1.0%) i/s -      2.996M in   5.029576s

Comparison:
                 new:   595682.2 i/s
                 old:   534354.7 i/s - 1.11x  ( 0.00) slower
```
<hr>

```ruby
Benchmark.ips do |x|
  x.report('old') do
    ActiveSupport::Inflector.upcase_first_old('x')
  end
  x.report('new') do
    ActiveSupport::Inflector.upcase_first('x')
  end
  x.compare!
end
```

```
Warming up --------------------------------------
                 old   571.482k i/100ms
                 new   841.763k i/100ms
Calculating -------------------------------------
                 old      7.202M ( 0.8%) i/s -     36.575M in   5.078753s
                 new     11.487M ( 1.3%) i/s -     58.082M in   5.057086s

Comparison:
                 new: 11487367.0 i/s
                 old:  7202053.4 i/s - 1.60x  ( 0.00) slower
```
<hr>

```ruby
Benchmark.ips do |x|
  x.report('old') do
    ActiveSupport::Inflector.upcase_first_old('hello')
  end
  x.report('new') do
    ActiveSupport::Inflector.upcase_first('hello')
  end
  x.compare!
end
```

```
Warming up --------------------------------------
                 old   569.202k i/100ms
                 new   645.977k i/100ms
Calculating -------------------------------------
                 old      6.930M ( 3.8%) i/s -     34.721M in   5.018755s
                 new      7.305M ( 1.0%) i/s -     36.821M in   5.041038s

Comparison:
                 new:  7304880.0 i/s
                 old:  6929655.8 i/s - 1.05x  ( 0.00) slower
```
<hr>

```ruby
Benchmark.ips do |x|
  x.report('old') do
    ActiveSupport::Inflector.foreign_key_old('Hello')
  end
  x.report('new') do
    ActiveSupport::Inflector.foreign_key('Hello')
  end
  x.compare!
end
```

```
Warming up --------------------------------------
                 old   114.517k i/100ms
                 new   117.846k i/100ms
Calculating -------------------------------------
                 old      1.116M ( 4.2%) i/s -      5.666M in   5.088369s
                 new      1.193M ( 1.4%) i/s -      5.985M in   5.017492s

Comparison:
                 new:  1193154.1 i/s
                 old:  1115716.2 i/s - 1.07x  ( 0.00) slower

```

```ruby
Benchmark.ips do |x|
  x.report('old') do
    ActiveSupport::Inflector.classify_old('foo.bars')
  end
  x.report('new') do
    ActiveSupport::Inflector.classify('foo.bars')
  end
  x.compare!
end
```

```
Warming up --------------------------------------
                 old    12.110k i/100ms
                 new    12.568k i/100ms
Calculating -------------------------------------
                 old    122.328k ( 1.0%) i/s -    617.610k in   5.049271s
                 new    126.656k ( 1.0%) i/s -    640.968k in   5.061174s

Comparison:
                 new:   126656.2 i/s
                 old:   122328.3 i/s - 1.04x  ( 0.00) slower
```


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46918/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46918/timeline,,
https://api.github.com/repos/rails/rails/issues/46900,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46900/labels{/name},https://api.github.com/repos/rails/rails/issues/46900/comments,https://api.github.com/repos/rails/rails/issues/46900/events,https://github.com/rails/rails/pull/46900,1521124372,PR_kwDNIULORr3XVw,46900,Allow migration generator to parse select key-value options from CLI,"{'login': 'fractaledmind', 'id': 5077225, 'node_id': 'MDQ6VXNlcjUwNzcyMjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5077225?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fractaledmind', 'html_url': 'https://github.com/fractaledmind', 'followers_url': 'https://api.github.com/users/fractaledmind/followers', 'following_url': 'https://api.github.com/users/fractaledmind/following{/other_user}', 'gists_url': 'https://api.github.com/users/fractaledmind/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fractaledmind/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fractaledmind/subscriptions', 'organizations_url': 'https://api.github.com/users/fractaledmind/orgs', 'repos_url': 'https://api.github.com/users/fractaledmind/repos', 'events_url': 'https://api.github.com/users/fractaledmind/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fractaledmind/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,7,2023-01-05T17:40:26Z,2023-08-22T10:01:01Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46900', 'html_url': 'https://github.com/rails/rails/pull/46900', 'diff_url': 'https://github.com/rails/rails/pull/46900.diff', 'patch_url': 'https://github.com/rails/rails/pull/46900.patch', 'merged_at': None}","### Motivation / Background

The current generators that create migration files (`migration`, `model`, `resource`, `scaffold`) allow a small subset of column options to be passed from the command line:
* You can pass a `limit` to `string`, `text`, `binary`, or `integer` fields using an integer within curly braces (e.g. `name:string{255}`).
* You can pass `precision` and `scale` to `decimal` fields using two integers within curly braces (e.g. `latitude:decimal{15,10}`).
* You can also pass the `polymorphic` option to `belongs_to` or `references` fields (e.g. `commentable:references{polymorphic}`).

There are, however, various other column options that can't be passed in via the command line, like `null` or `default`.

In my opinion, Rails' generators are one of its key features. And I'm confident we have all written a generator command that we _knew_ was going to require us to open up the migration file _just_ to add `null: false` to one or two fields. Frustrating and unnecessary. Let's get make the migration generator powerful.

### Detail

This PR powers up the column definition string passed from the CLI to contain key-value options, both for columns and for indexes. Like the existing single keyword options, the key-value options are passed within curly braces (`{}`) using a format like `column_name:type{key:value}`. As with precision and scale options, multiple options can be passed in if separated by a comma, like so `column_name:type{key:value,foo:bar}`. As seen in the new `AVAILABLE_COLUMN_OPTIONS ` constant, the allows keys are `%w(limit default null precision scale array polymorphic foreign_key if_exists)`, which matches the options documented across the various migration methods for fields. Acceptable values include `true`, `false`, `[]`, `{}`, and any quote-wrapped string or integer or float. Moreover, this PR allows column definitions to include spaces so that the CLI test can be more easily scanned.

Tests provide some examples:
* `title:string{null:false}`
* `description:text{default: 'hello, world!'}`
* `tags:text{array, null:false, default:[]}`
* `owner:references{foreign_key:{table_name:users}}`

As said, users would also now be able to pass options for indexes as well. Key-value options accept the same range of values, and only a specified set of keys are permitted: `%w(unique length order opclass where type using comment algorithm name if_not_exists internal polymorphic)` (as set in the `AVAILABLE_INDEX_OPTIONS` constant). This allows for column definitions like:

* `title:string{null: false}:uniq{name: by_title}`
* `title:string:index{length:{title:15}}`

Altogether, these additions (column options, index options, spaces allowed) make many generators immediately more powerful.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46900/reactions', 'total_count': 42, '+1': 18, '-1': 0, 'laugh': 0, 'hooray': 4, 'confused': 0, 'heart': 14, 'rocket': 6, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46900/timeline,,
https://api.github.com/repos/rails/rails/issues/46893,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46893/labels{/name},https://api.github.com/repos/rails/rails/issues/46893/comments,https://api.github.com/repos/rails/rails/issues/46893/events,https://github.com/rails/rails/pull/46893,1520015579,PR_kwDNIULORq59Yw,46893,Define each SafeBuffer method with same arity with String's original method,"{'login': 'amatsuda', 'id': 11493, 'node_id': 'MDQ6VXNlcjExNDkz', 'avatar_url': 'https://avatars.githubusercontent.com/u/11493?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/amatsuda', 'html_url': 'https://github.com/amatsuda', 'followers_url': 'https://api.github.com/users/amatsuda/followers', 'following_url': 'https://api.github.com/users/amatsuda/following{/other_user}', 'gists_url': 'https://api.github.com/users/amatsuda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/amatsuda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/amatsuda/subscriptions', 'organizations_url': 'https://api.github.com/users/amatsuda/orgs', 'repos_url': 'https://api.github.com/users/amatsuda/repos', 'events_url': 'https://api.github.com/users/amatsuda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/amatsuda/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,5,2023-01-05T03:51:28Z,2023-01-11T23:36:00Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46893', 'html_url': 'https://github.com/rails/rails/pull/46893', 'diff_url': 'https://github.com/rails/rails/pull/46893.diff', 'patch_url': 'https://github.com/rails/rails/pull/46893.patch', 'merged_at': None}","Here's another patch on delegation improvement, targeting on AS::SafeBuffer.

### Motivation / Background

Currently, when SafeBuffer delegates its methods to its parent String, it defines almost all wrapper methods with `*args` parameter, which allocates an Array object on each method call.

### Detail

This patch tries to avoid that extra runtime allocation by counting each original method's arity and defining its wrapper method with proper arity.

### Additional information

As a result, this patch improves the IPS benchmark result of `SafeBuffer#chop` 1.8 times faster (this is just an example, and this patch improves so many others as well).

```
before
Warming up --------------------------------------
                       554.435k i/100ms
Calculating -------------------------------------
                          6.318M ( 4.6%) i/s -     31.603M in   5.014815s

after
Warming up --------------------------------------
                       839.767k i/100ms
Calculating -------------------------------------
                         11.222M ( 1.0%) i/s -     56.264M in   5.014127s
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/46893/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46893/timeline,,
https://api.github.com/repos/rails/rails/issues/46872,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46872/labels{/name},https://api.github.com/repos/rails/rails/issues/46872/comments,https://api.github.com/repos/rails/rails/issues/46872/events,https://github.com/rails/rails/pull/46872,1516847180,PR_kwDNIULORoMyJg,46872,TZ offset minute has to be negated in the Western Hemisphere,"{'login': 'amatsuda', 'id': 11493, 'node_id': 'MDQ6VXNlcjExNDkz', 'avatar_url': 'https://avatars.githubusercontent.com/u/11493?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/amatsuda', 'html_url': 'https://github.com/amatsuda', 'followers_url': 'https://api.github.com/users/amatsuda/followers', 'following_url': 'https://api.github.com/users/amatsuda/following{/other_user}', 'gists_url': 'https://api.github.com/users/amatsuda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/amatsuda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/amatsuda/subscriptions', 'organizations_url': 'https://api.github.com/users/amatsuda/orgs', 'repos_url': 'https://api.github.com/users/amatsuda/repos', 'events_url': 'https://api.github.com/users/amatsuda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/amatsuda/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2023-01-03T01:52:32Z,2023-01-03T01:52:36Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46872', 'html_url': 'https://github.com/rails/rails/pull/46872', 'diff_url': 'https://github.com/rails/rails/pull/46872.diff', 'patch_url': 'https://github.com/rails/rails/pull/46872.patch', 'merged_at': None}","This patch fixes a bug in our AMo Time type caster that it doesn't handle minus offset in a given string correctly.

### Background / Detail

When the TZ in the given string contains minus offset, both hour and minute value has to be negated, but the current code nagates hour only.

For instance in Newfoundland Time Zone (UTC03:30), the offset part goes like ""-03:30"" which has to be treated as ""-3 hours and -30 minutes"", but it used to be calculated as ""-3 hours and +30 minutes"", then it used to return 1 hour advanced value than the actual.

### Additional information

Parsing Time ourselves is too hard for non-professional. This bug may tell why I'm proposing to switch to Ruby's built in Time parser in #46868. And, this bug was found and reported by Time pro @nobu via https://bugs.ruby-lang.org/issues/19293#note-1 (thanks!)

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/46872/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46872/timeline,,
https://api.github.com/repos/rails/rails/issues/46869,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46869/labels{/name},https://api.github.com/repos/rails/rails/issues/46869/comments,https://api.github.com/repos/rails/rails/issues/46869/events,https://github.com/rails/rails/issues/46869,1516609172,I_kwDNIULOWmWelA,46869,Rails logs a 200 even if Rack::ConditionalGet has replaced it with a 304,"{'login': 'matteoredz', 'id': 4482159, 'node_id': 'MDQ6VXNlcjQ0ODIxNTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4482159?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matteoredz', 'html_url': 'https://github.com/matteoredz', 'followers_url': 'https://api.github.com/users/matteoredz/followers', 'following_url': 'https://api.github.com/users/matteoredz/following{/other_user}', 'gists_url': 'https://api.github.com/users/matteoredz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matteoredz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matteoredz/subscriptions', 'organizations_url': 'https://api.github.com/users/matteoredz/orgs', 'repos_url': 'https://api.github.com/users/matteoredz/repos', 'events_url': 'https://api.github.com/users/matteoredz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matteoredz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2023-01-02T17:58:04Z,2023-05-19T07:57:39Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# Create a new Rails api_only application and run it.
rails new my_api --api

# Make an HTTP call, I'm using HTTPie here.
http -h get http://localhost:3000

# Get the ETag header from the response
# and submit again the same request with the `If-None-Match` header.
http -h get http://localhost:3000 'If-None-Match:W/""cda84c1039ef9b25d5aed03568965293""'
```

### Expected behavior
The `Rack::ConditionalGet` replaces the 200 with a 304 and `Rails` logs the 304

### Actual behavior
The `Rack::ConditionalGet` replaces the 200 with a 304 but `Rails` still logs the 200

```shell
Started GET ""/"" for ::1 at 2023-01-02 18:52:50 +0100
Processing by Rails::WelcomeController#index as */*
Completed 200 OK in 0ms (Views: 0.2ms | ActiveRecord: 0.0ms | Allocations: 213)
```

### System configuration
**Rails version**: 7.0.4

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46869/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46869/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/46859,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46859/labels{/name},https://api.github.com/repos/rails/rails/issues/46859/comments,https://api.github.com/repos/rails/rails/issues/46859/events,https://github.com/rails/rails/pull/46859,1514188000,PR_kwDNIULORl802Q,46859,Allow adding/removing of existing `Content-Security-Policy` and `Permissions-Policy` directives,"{'login': 'agrobbin', 'id': 46724, 'node_id': 'MDQ6VXNlcjQ2NzI0', 'avatar_url': 'https://avatars.githubusercontent.com/u/46724?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/agrobbin', 'html_url': 'https://github.com/agrobbin', 'followers_url': 'https://api.github.com/users/agrobbin/followers', 'following_url': 'https://api.github.com/users/agrobbin/following{/other_user}', 'gists_url': 'https://api.github.com/users/agrobbin/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/agrobbin/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/agrobbin/subscriptions', 'organizations_url': 'https://api.github.com/users/agrobbin/orgs', 'repos_url': 'https://api.github.com/users/agrobbin/repos', 'events_url': 'https://api.github.com/users/agrobbin/events{/privacy}', 'received_events_url': 'https://api.github.com/users/agrobbin/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2022-12-30T02:16:30Z,2023-04-22T01:23:14Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46859', 'html_url': 'https://github.com/rails/rails/pull/46859', 'diff_url': 'https://github.com/rails/rails/pull/46859.diff', 'patch_url': 'https://github.com/rails/rails/pull/46859.patch', 'merged_at': None}","### Motivation / Background

Previously, if you wanted to add/remove directives from either header, you had to redefine the defaults in the controller.

```ruby
Rails.application.configure do
  config.content_security_policy do |policy|
    policy.default_src :none

    policy.script_src :self, 'a.com', 'b.com'
  end
end

class FooController < ApplicationController
  content_security_policy do |policy|
    policy.script_src :self, 'a.com', 'b.com', 'c.com'
  end
end
```

### Detail

Now, you can adjust the policy directives without overwriting the global configuration.

```ruby
Rails.application.configure do
  config.content_security_policy do |policy|
    policy.default_src :none

    policy.script_src :self, 'a.com', 'b.com'
  end
end

class FooController < ApplicationController
  content_security_policy do |policy|
    policy.add_script_src 'c.com'
  end
end
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46859/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46859/timeline,,
https://api.github.com/repos/rails/rails/issues/46844,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46844/labels{/name},https://api.github.com/repos/rails/rails/issues/46844/comments,https://api.github.com/repos/rails/rails/issues/46844/events,https://github.com/rails/rails/pull/46844,1512485894,PR_kwDNIULORkhTYQ,46844,Avoid calling useless core-ext method,"{'login': 'postmodern', 'id': 12671, 'node_id': 'MDQ6VXNlcjEyNjcx', 'avatar_url': 'https://avatars.githubusercontent.com/u/12671?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/postmodern', 'html_url': 'https://github.com/postmodern', 'followers_url': 'https://api.github.com/users/postmodern/followers', 'following_url': 'https://api.github.com/users/postmodern/following{/other_user}', 'gists_url': 'https://api.github.com/users/postmodern/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/postmodern/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/postmodern/subscriptions', 'organizations_url': 'https://api.github.com/users/postmodern/orgs', 'repos_url': 'https://api.github.com/users/postmodern/repos', 'events_url': 'https://api.github.com/users/postmodern/events{/privacy}', 'received_events_url': 'https://api.github.com/users/postmodern/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-28T07:14:10Z,2022-12-29T00:08:57Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46844', 'html_url': 'https://github.com/rails/rails/pull/46844', 'diff_url': 'https://github.com/rails/rails/pull/46844.diff', 'patch_url': 'https://github.com/rails/rails/pull/46844.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

I stumbled across this because one of my other libraries defined it's own `Integer#bytes` method which conflicted with `activesupport`'s `Numeric#bytes`, which prevented `ActiveRecord` from being loaded/initialized. As it turns out `Numeric#bytes` only returns `self` and can be safely omitted.

### Detail

Removed useless call to `Numeric#bytes`. [Numeric#bytes](https://github.com/rails/rails/blob/v7.0.4/activesupport/lib/active_support/core_ext/numeric/bytes.rb#L14-L16) does not actually do anything and can be safely omitted.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46844/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46844/timeline,,
https://api.github.com/repos/rails/rails/issues/46825,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46825/labels{/name},https://api.github.com/repos/rails/rails/issues/46825/comments,https://api.github.com/repos/rails/rails/issues/46825/events,https://github.com/rails/rails/pull/46825,1510396379,PR_kwDNIULORixU2A,46825,ActiveStorage::MirrorJob should honor the `service:` option,"{'login': 'jnimety', 'id': 70484, 'node_id': 'MDQ6VXNlcjcwNDg0', 'avatar_url': 'https://avatars.githubusercontent.com/u/70484?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jnimety', 'html_url': 'https://github.com/jnimety', 'followers_url': 'https://api.github.com/users/jnimety/followers', 'following_url': 'https://api.github.com/users/jnimety/following{/other_user}', 'gists_url': 'https://api.github.com/users/jnimety/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jnimety/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jnimety/subscriptions', 'organizations_url': 'https://api.github.com/users/jnimety/orgs', 'repos_url': 'https://api.github.com/users/jnimety/repos', 'events_url': 'https://api.github.com/users/jnimety/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jnimety/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2022-12-25T19:13:50Z,2023-02-15T04:00:53Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46825', 'html_url': 'https://github.com/rails/rails/pull/46825', 'diff_url': 'https://github.com/rails/rails/pull/46825.diff', 'patch_url': 'https://github.com/rails/rails/pull/46825.patch', 'merged_at': None}","### Motivation / Background

Fixes #46806

This Pull Request has been created because `ActiveStorage::MirrorJob` always uses the global/default service, even if an alternate service was specified via the `:service` option for `has_*_attached`

### Detail

This Pull Request changes `ActiveStorage::MirrorJob` so the blob's service can be used to find mirrors instead of always using the global/default service.

### Additional information

n/a

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46825/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46825/timeline,,
https://api.github.com/repos/rails/rails/issues/46824,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46824/labels{/name},https://api.github.com/repos/rails/rails/issues/46824/comments,https://api.github.com/repos/rails/rails/issues/46824/events,https://github.com/rails/rails/pull/46824,1510371892,PR_kwDNIULORiwF8A,46824,Fix Getting Started documentation,"{'login': 'Nabellaleen', 'id': 3717607, 'node_id': 'MDQ6VXNlcjM3MTc2MDc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3717607?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Nabellaleen', 'html_url': 'https://github.com/Nabellaleen', 'followers_url': 'https://api.github.com/users/Nabellaleen/followers', 'following_url': 'https://api.github.com/users/Nabellaleen/following{/other_user}', 'gists_url': 'https://api.github.com/users/Nabellaleen/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Nabellaleen/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Nabellaleen/subscriptions', 'organizations_url': 'https://api.github.com/users/Nabellaleen/orgs', 'repos_url': 'https://api.github.com/users/Nabellaleen/repos', 'events_url': 'https://api.github.com/users/Nabellaleen/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Nabellaleen/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-25T17:04:35Z,2022-12-26T21:21:21Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46824', 'html_url': 'https://github.com/rails/rails/pull/46824', 'diff_url': 'https://github.com/rails/rails/pull/46824.diff', 'patch_url': 'https://github.com/rails/rails/pull/46824.patch', 'merged_at': None}","- Configure bundle to install dependencies locally, to avoid any access rights issues on some systems (Fedora for example)
- Add commands needed to initialize Turbo and make the Delete Article example works","{'url': 'https://api.github.com/repos/rails/rails/issues/46824/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46824/timeline,,
https://api.github.com/repos/rails/rails/issues/46822,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46822/labels{/name},https://api.github.com/repos/rails/rails/issues/46822/comments,https://api.github.com/repos/rails/rails/issues/46822/events,https://github.com/rails/rails/issues/46822,1510320164,I_kwDNIULOWgWoJA,46822,Unexpected routes in console using app.,"{'login': 'woto', 'id': 146704, 'node_id': 'MDQ6VXNlcjE0NjcwNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/146704?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/woto', 'html_url': 'https://github.com/woto', 'followers_url': 'https://api.github.com/users/woto/followers', 'following_url': 'https://api.github.com/users/woto/following{/other_user}', 'gists_url': 'https://api.github.com/users/woto/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/woto/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/woto/subscriptions', 'organizations_url': 'https://api.github.com/users/woto/orgs', 'repos_url': 'https://api.github.com/users/woto/repos', 'events_url': 'https://api.github.com/users/woto/events{/privacy}', 'received_events_url': 'https://api.github.com/users/woto/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,6,2022-12-25T12:41:48Z,2023-07-13T22:27:08Z,,CONTRIBUTOR,,,,"### Steps to reproduce
```ruby
irb(main):013:0> host = ""https://host.ru:443""
=> ""https://host.ru:443""

irb(main):014:0> Rails.application.routes.url_helpers.tests_url(host: host)
=> ""https://host.ru/tests""

irb(main):015:0> app.tests_url(host: host)
=> ""http://host.ru:443/tests""

irb(main):016:0> 
irb(main):017:0> 

irb(main):018:0> host = ""https://host.ru:443/""
=> ""https://host.ru:443/""

irb(main):019:0> Rails.application.routes.url_helpers.tests_url(host: host)
=> ""https://host.ru/tests""

irb(main):020:0> app.tests_url(host: host)
=> ""http://host.ru/tests""

```

### Expected behavior
In all cases I expect that output will be `https://host.ru/tests`

### Actual behavior
Unexpected results built with `app.` are `http://host.ru:443/tests` and `http://host.ru/tests`

### System configuration
**Rails version**:
7.0.4

**Ruby version**:
ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]

Cheers!","{'url': 'https://api.github.com/repos/rails/rails/issues/46822/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46822/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/46809,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46809/labels{/name},https://api.github.com/repos/rails/rails/issues/46809/comments,https://api.github.com/repos/rails/rails/issues/46809/events,https://github.com/rails/rails/issues/46809,1509771607,I_kwDNIULOWf1JVw,46809,Deterministically encrypted attributes do not support joins for queries with `support_unencrypted_data`,"{'login': 'ezekg', 'id': 6979737, 'node_id': 'MDQ6VXNlcjY5Nzk3Mzc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6979737?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ezekg', 'html_url': 'https://github.com/ezekg', 'followers_url': 'https://api.github.com/users/ezekg/followers', 'following_url': 'https://api.github.com/users/ezekg/following{/other_user}', 'gists_url': 'https://api.github.com/users/ezekg/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ezekg/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ezekg/subscriptions', 'organizations_url': 'https://api.github.com/users/ezekg/orgs', 'repos_url': 'https://api.github.com/users/ezekg/repos', 'events_url': 'https://api.github.com/users/ezekg/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ezekg/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-23T20:58:13Z,2023-02-07T15:40:16Z,,CONTRIBUTOR,,,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Encryption.configure(
  primary_key: SecureRandom.alphanumeric(32),
  deterministic_key: SecureRandom.alphanumeric(32),
  key_derivation_salt: SecureRandom.alphanumeric(32),
  support_unencrypted_data: true,
)

ActiveRecord::Encryption::ExtendedDeterministicQueries.install_support

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
    t.string :email
  end

  create_table :posts, force: true do |t|
    t.references :user
  end
end

class User < ActiveRecord::Base
  encrypts :email, deterministic: true

  has_many :posts
end

class Post < ActiveRecord::Base
  belongs_to :user

  scope :by_user, -> email { joins(:user).where(users: { email: }) }
end

class BugTest < Minitest::Test
  def test_encrypted_join_on_deterministically_encrypted_attributes
    user = User.create!(email: ""user@test.example"")
    post = Post.create!(user:)

    assert_includes Post.by_user(user.email), post
  end

  def test_unencrypted_join_on_deterministically_encrypted_attributes
    user = ActiveRecord::Encryption.without_encryption { User.create!(email: ""user@test.example"") }
    post = Post.create!(user:)

    assert_includes Post.by_user(user.email), post
  end
end
```

### Expected behavior

When joining an association on an encrypted attribute with an unencrypted value, when `support_unencrypted_data` is enabled, I would expect to be able to join on the deterministically encrypted attributes.

I would expect AR to produce a query using `IN`:

```sql
SELECT ""posts"".* FROM ""posts"" INNER JOIN ""users"" ON ""users"".""id"" = ""posts"".""user_id"" WHERE ""users"".""email"" IN ('{""p"":""PEwzUcqZSnt+OyndCbySB1Q="",""h"":{""iv"":""AYWjFGhQ2JM4gRCc"",""at"":""ZpbYXFfPirsF7Ew7JW5Sbw==""}}', 'user@test.example')
```

### Actual behavior

The query does not use `IN`. AR joins on the encrypted value only, instead of both the encrypted and unencrypted values:

```sql
SELECT ""posts"".* FROM ""posts"" INNER JOIN ""users"" ON ""users"".""id"" = ""posts"".""user_id"" WHERE ""users"".""email"" = '{""p"":""PEwzUcqZSnt+OyndCbySB1Q="",""h"":{""iv"":""AYWjFGhQ2JM4gRCc"",""at"":""ZpbYXFfPirsF7Ew7JW5Sbw==""}}'
```

Similar issue to #46788.

### System configuration

**Rails version**: `7.0.4`

**Ruby version**: `ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-darwin19]`
","{'url': 'https://api.github.com/repos/rails/rails/issues/46809/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46809/timeline,,
https://api.github.com/repos/rails/rails/issues/46807,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46807/labels{/name},https://api.github.com/repos/rails/rails/issues/46807/comments,https://api.github.com/repos/rails/rails/issues/46807/events,https://github.com/rails/rails/pull/46807,1509704604,PR_kwDNIULORiOJ5g,46807,Invoke `.focus()` on `<trix-editor>` after calling `fill_in_rich_text_area`,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,2,2022-12-23T19:12:55Z,2023-09-24T15:30:02Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46807', 'html_url': 'https://github.com/rails/rails/pull/46807', 'diff_url': 'https://github.com/rails/rails/pull/46807.diff', 'patch_url': 'https://github.com/rails/rails/pull/46807.patch', 'merged_at': None}","### Motivation / Background

Follow-up to [rails/rails#46249][]
Closes [rails/rails#46803][]

### Detail

Invoke [HTMLElement.focus][] on the element instead of the `Trix.Editor` instance when calling `fill_in_rich_text_area`.

### Additional information

Defer merging this until https://github.com/rails/rails/pull/46808 is merged and https://github.com/rails/rails/issues/46804 is closed, this PR will re-introduce the focus behavior and test coverage.

[rails/rails#46803]: https://github.com/rails/rails/issues/46803
[rails/rails#46249]: https://github.com/rails/rails/pull/46249
[HTMLElement.focus]: https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/focus

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46807/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46807/timeline,,
https://api.github.com/repos/rails/rails/issues/46806,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46806/labels{/name},https://api.github.com/repos/rails/rails/issues/46806/comments,https://api.github.com/repos/rails/rails/issues/46806/events,https://github.com/rails/rails/issues/46806,1509671077,I_kwDNIULOWfvApQ,46806,"ActiveStorage::MirrorJob always uses the default service, even if overridden via `has_*_attached ..., service: :another_service`","{'login': 'jnimety', 'id': 70484, 'node_id': 'MDQ6VXNlcjcwNDg0', 'avatar_url': 'https://avatars.githubusercontent.com/u/70484?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jnimety', 'html_url': 'https://github.com/jnimety', 'followers_url': 'https://api.github.com/users/jnimety/followers', 'following_url': 'https://api.github.com/users/jnimety/following{/other_user}', 'gists_url': 'https://api.github.com/users/jnimety/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jnimety/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jnimety/subscriptions', 'organizations_url': 'https://api.github.com/users/jnimety/orgs', 'repos_url': 'https://api.github.com/users/jnimety/repos', 'events_url': 'https://api.github.com/users/jnimety/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jnimety/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,3,2022-12-23T18:56:11Z,2023-01-04T03:42:53Z,,CONTRIBUTOR,,,,"I ran into this when trying to migrate all of my attached from local storage to s3. After setting up mirroring and running `ActiveStorage::Blob.find_each &:mirror_later` I was surprised to find all of my attachments in the default storage service, even if a different service had been specified via `has_*_attached ..., service: ...`

I think the culprit is here:

https://github.com/rails/rails/blob/a7902034089e8b6bff747c08d93eeac4b1377032/activestorage/app/jobs/active_storage/mirror_job.rb#L13

`ActiveStorage::Blob.service` the default service. The other jobs pass `blob` to perform... Is there any reason not to pass `blob` here as well, and use `blob.service` instead of `ActiveStorage::Blob.service`?

If that's acceptable I'm happy to submit a PR. Thanks!
","{'url': 'https://api.github.com/repos/rails/rails/issues/46806/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46806/timeline,,
https://api.github.com/repos/rails/rails/issues/46805,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46805/labels{/name},https://api.github.com/repos/rails/rails/issues/46805/comments,https://api.github.com/repos/rails/rails/issues/46805/events,https://github.com/rails/rails/pull/46805,1509588020,PR_kwDNIULORiIIrg,46805,Reduce usage of method delegations to gain more speed,"{'login': 'amatsuda', 'id': 11493, 'node_id': 'MDQ6VXNlcjExNDkz', 'avatar_url': 'https://avatars.githubusercontent.com/u/11493?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/amatsuda', 'html_url': 'https://github.com/amatsuda', 'followers_url': 'https://api.github.com/users/amatsuda/followers', 'following_url': 'https://api.github.com/users/amatsuda/following{/other_user}', 'gists_url': 'https://api.github.com/users/amatsuda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/amatsuda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/amatsuda/subscriptions', 'organizations_url': 'https://api.github.com/users/amatsuda/orgs', 'repos_url': 'https://api.github.com/users/amatsuda/repos', 'events_url': 'https://api.github.com/users/amatsuda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/amatsuda/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,7,2022-12-23T17:36:27Z,2023-01-07T18:20:19Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46805', 'html_url': 'https://github.com/rails/rails/pull/46805', 'diff_url': 'https://github.com/rails/rails/pull/46805.diff', 'patch_url': 'https://github.com/rails/rails/pull/46805.patch', 'merged_at': None}","This PR is a suggestion to refrain from using Active Support delegation within the Rails framework codebase.

### Motivation / Background

As I reported here on bugs.r-l.o, https://bugs.ruby-lang.org/issues/19165
delegating a method that is defined to take `...`, or `*, **` and calling it without an argument performs measurably slowly.
And, this is what exactly is happening inside Active Support's `delegate`. It internally uses the `...` literal to define the delegation method, and in most cases the delegations in the framework are called without passing in any arguments.

### Detail

As I reported to Ruby bugs, we can speed up such delegations by not using the `...` literal, like 10 times faster on micro-benchmark basis. So, as an experiment, I replaced some occurrences of such delegation in the Rails codebase to be normal direct method call, and did a very simple more real-ish benchmark. In order to purely measure Action Pack request handling and filter out all other noise such as network overhead and logging, I benchmarked the controller `send_action` method on a simple action that returns HEAD OK response.

Here's the action code,
```ruby
class HelloController < ApplicationController
  def index
    head :ok
  end
end
```

and the benchmark code.
```ruby
class ApplicationController < ActionController::Base
  def send_action(*)
    ret = super
    Benchmark.ips do |x|
      x.report do
        super
      end
    end
    ret
  end
end
```

Then, the benchmark result on Ruby 3.2 (GH master as of today, with which delegation performs faster than 3.2.0-rc1) + newly created Rails 7.1 (edge) app is as follows.

```
before this patch
391.769k ( 1.2%) i/s -      1.965M in   5.017064s

after this patch
555.944k ( 1.1%) i/s -      2.780M in   5.001781s
```

It resulted in 42% performance improvement.

Honestly, I do like Active Support's `delegate` very much. It's easier to read and write than Ruby's Forwardable, and it shrinks the lines of delegation code from 3 lines to 1 line. It's certainly a good friend for the framework core maintainers and contributors. But... is it worth burdening the 40% extra load on all the application developers and the end users?


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46805/reactions', 'total_count': 4, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 4, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46805/timeline,,
https://api.github.com/repos/rails/rails/issues/46802,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46802/labels{/name},https://api.github.com/repos/rails/rails/issues/46802/comments,https://api.github.com/repos/rails/rails/issues/46802/events,https://github.com/rails/rails/pull/46802,1509479608,PR_kwDNIULORiCL7w,46802,Support attaching files with `URI` instances,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,5,2022-12-23T15:39:20Z,2023-09-22T15:25:48Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46802', 'html_url': 'https://github.com/rails/rails/pull/46802', 'diff_url': 'https://github.com/rails/rails/pull/46802.diff', 'patch_url': 'https://github.com/rails/rails/pull/46802.patch', 'merged_at': None}","### Motivation / Background

Active Storage attachments require a handle to a blob or open `IO` instance. A `URI` is neither, but can transform itself into an open `IO` instance.

### Detail

Extend the `attach` method to accept instances of `URI` to download and attach files directly inline.

### Additional information

Related to [rails/rails#46801][]

[rails/rails#46801]: https://github.com/rails/rails/pull/46801

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46802/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46802/timeline,,
https://api.github.com/repos/rails/rails/issues/46801,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46801/labels{/name},https://api.github.com/repos/rails/rails/issues/46801/comments,https://api.github.com/repos/rails/rails/issues/46801/events,https://github.com/rails/rails/pull/46801,1509445700,PR_kwDNIULORiAU-Q,46801,Introduce ActiveStorage::AttachRemoteFileJob,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-23T15:04:17Z,2023-09-22T15:23:13Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46801', 'html_url': 'https://github.com/rails/rails/pull/46801', 'diff_url': 'https://github.com/rails/rails/pull/46801.diff', 'patch_url': 'https://github.com/rails/rails/pull/46801.patch', 'merged_at': None}","### Motivation / Background

Active Support expects a `File` instance, or at the very least an open `IO` instance.
Unfortunately, a `URL` is neither, but can be transformed into one.

### Detail

 This commit introduces the `ActiveStorage::AttachRemoteFileJob` to download the remote file referenced by the `URL`.

When saving a record with attachments, support assignment to `#{name}_url` and `#{name}_urls` (for `has_one_attached` and `has_many_attached`, respectively), then download those for their underlying attachments.

```ruby
url = ""http://example.com/racecar.jpg""
record = User.new(...)

assert_enqueued_with job: ActiveStorage::AttachRemoteFileJob, args: [record, :avatar, url] do
  record.update! avatar_url: url
end

 # some time later

record.avatar.attached? #=> true
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46801/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46801/timeline,,
https://api.github.com/repos/rails/rails/issues/46797,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46797/labels{/name},https://api.github.com/repos/rails/rails/issues/46797/comments,https://api.github.com/repos/rails/rails/issues/46797/events,https://github.com/rails/rails/issues/46797,1508859778,I_kwDNIULOWe9fgg,46797,Active Job async adapter may use connections without a lease,"{'login': 'georgeclaghorn', 'id': 94129, 'node_id': 'MDQ6VXNlcjk0MTI5', 'avatar_url': 'https://avatars.githubusercontent.com/u/94129?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/georgeclaghorn', 'html_url': 'https://github.com/georgeclaghorn', 'followers_url': 'https://api.github.com/users/georgeclaghorn/followers', 'following_url': 'https://api.github.com/users/georgeclaghorn/following{/other_user}', 'gists_url': 'https://api.github.com/users/georgeclaghorn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/georgeclaghorn/subscriptions', 'organizations_url': 'https://api.github.com/users/georgeclaghorn/orgs', 'repos_url': 'https://api.github.com/users/georgeclaghorn/repos', 'events_url': 'https://api.github.com/users/georgeclaghorn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/georgeclaghorn/received_events', 'type': 'User', 'site_admin': False}","[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,13,2022-12-23T04:15:25Z,2023-05-24T19:18:55Z,,CONTRIBUTOR,,,,"On latest main, tests for an application of mine reliably stall locally and in CI. Sometimes warnings like the following are printed:

```
WARNING:  there is already a transaction in progress
message type 0x43 arrived from server while idle
message type 0x5a arrived from server while idle
```

Environment:
* The app uses a single Postgres DB and ARs Postgres adapter.

* It uses RSpec and FactoryBot, not Minitest or AR fixtures.
  
  ```
  rspec-core (3.12.0)
    rspec-support (~> 3.12.0)
  rspec-expectations (3.12.0)
    diff-lcs (>= 1.2.0, < 2.0)
    rspec-support (~> 3.12.0)
  rspec-mocks (3.12.0)
    diff-lcs (>= 1.2.0, < 2.0)
    rspec-support (~> 3.12.0)
  rspec-rails (6.0.1)
    actionpack (>= 6.1)
    activesupport (>= 6.1)
    railties (>= 6.1)
    rspec-core (~> 3.11)
    rspec-expectations (~> 3.11)
    rspec-mocks (~> 3.11)
    rspec-support (~> 3.11)
  rspec-support (3.12.0)
  ```
 
* Its on Ruby 3.1.3.

A `git bisect` pointed to 1a2ca1920c62abdd08c809df1fa98fe0acf14bc3 (cc @byroot). That change does seem relevant, but I havent been able to reproduce the issue in a minimal app yet. Ive tried with both Minitest and RSpec.

The tests usually stall in around the same place with the same seed, but not *exactly* the same place. And I looked at two stalled runs with different seeds that didnt run any common tests before their stalls.

This has been difficult to pin down so far but I will keep looking.","{'url': 'https://api.github.com/repos/rails/rails/issues/46797/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46797/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/46795,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46795/labels{/name},https://api.github.com/repos/rails/rails/issues/46795/comments,https://api.github.com/repos/rails/rails/issues/46795/events,https://github.com/rails/rails/pull/46795,1508441368,PR_kwDNIULORhJ3AA,46795,"GMT+0, GMT-0, GMT0 and GMT for timezone tests","{'login': 'kaiquekandykoga', 'id': 6296479, 'node_id': 'MDQ6VXNlcjYyOTY0Nzk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6296479?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kaiquekandykoga', 'html_url': 'https://github.com/kaiquekandykoga', 'followers_url': 'https://api.github.com/users/kaiquekandykoga/followers', 'following_url': 'https://api.github.com/users/kaiquekandykoga/following{/other_user}', 'gists_url': 'https://api.github.com/users/kaiquekandykoga/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kaiquekandykoga/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kaiquekandykoga/subscriptions', 'organizations_url': 'https://api.github.com/users/kaiquekandykoga/orgs', 'repos_url': 'https://api.github.com/users/kaiquekandykoga/repos', 'events_url': 'https://api.github.com/users/kaiquekandykoga/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kaiquekandykoga/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-22T19:30:33Z,2022-12-22T19:30:37Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46795', 'html_url': 'https://github.com/rails/rails/pull/46795', 'diff_url': 'https://github.com/rails/rails/pull/46795.diff', 'patch_url': 'https://github.com/rails/rails/pull/46795.patch', 'merged_at': None}","FreeBSD does not have GMT file in /usr/share/zoneinfo. FreeBSD has GMT0, GMT+0 and GMT-0.

```
ls /usr/share/zoneinfo
Africa          CET             Egypt           GMT-0           Israel          Mexico          Portugal        UTC
America         CST6CDT         Eire            GMT0            Jamaica         NZ              ROC             Universal
Antarctica      Canada          Etc             Greenwich       Japan           NZ-CHAT         ROK             W-SU
Arctic          Chile           Europe          HST             Kwajalein       Navajo          Singapore       WET
Asia            Cuba            Factory         Hongkong        Libya           PRC             SystemV         Zulu
Atlantic        EET             GB              Iceland         MET             PST8PDT         Turkey          posixrules
Australia       EST             GB-Eire         Indian          MST             Pacific         UCT             zone.tab
Brazil          EST5EDT         GMT+0           Iran            MST7MDT         Poland          US              zone1970.tab
```

```
irb(main):001:0> irb_info
=>
Ruby version: 3.1.3
IRB version: irb 1.6.1 (2022-12-13)
InputMethod: RelineInputMethod with Reline 0.3.2
RUBY_PLATFORM: x86_64-freebsd13.1
LANG env: C.UTF-8
East Asian Ambiguous Width: 1

irb(main):002:0> require ""tzinfo""
=> true
irb(main):003:0> TZInfo::Timezone.all_identifiers.select { _1.match? /^GMT/ }
=> [""GMT+0"", ""GMT-0"", ""GMT0""]
```","{'url': 'https://api.github.com/repos/rails/rails/issues/46795/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46795/timeline,,
https://api.github.com/repos/rails/rails/issues/46783,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46783/labels{/name},https://api.github.com/repos/rails/rails/issues/46783/comments,https://api.github.com/repos/rails/rails/issues/46783/events,https://github.com/rails/rails/pull/46783,1505647739,PR_kwDNIULORexOvQ,46783,Only register CurrentAttributes hooks if used,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,3,2022-12-21T03:14:34Z,2022-12-22T20:52:12Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46783', 'html_url': 'https://github.com/rails/rails/pull/46783', 'diff_url': 'https://github.com/rails/rails/pull/46783.diff', 'patch_url': 'https://github.com/rails/rails/pull/46783.patch', 'merged_at': None}","### Motivation / Background

Previously, executor hooks were always defined to clear ActiveSupport::CurrentAttributes whether or not an application defines a Current class. However, those apps without CurrentAttributes will end up autoloading the class when the executor hooks run, which adds additional overhead to the first request or job processed.

### Detail

One possible solution would be to eager load CurrentAttributes to prevent it from being autoloaded mid request, however this would be extraneous for applications not using it. Therefore a better solution is to only register the executor hooks when CurrentAttributes is loaded.

### Additional Information

Should all load hooks be documented in https://edgeguides.rubyonrails.org/engines.html ? If so I can add this one

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46783/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46783/timeline,,
https://api.github.com/repos/rails/rails/issues/46781,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46781/labels{/name},https://api.github.com/repos/rails/rails/issues/46781/comments,https://api.github.com/repos/rails/rails/issues/46781/events,https://github.com/rails/rails/pull/46781,1504695407,PR_kwDNIULORd_onw,46781,make bypass_local_cache as public method,"{'login': 'OuYangJinTing', 'id': 33079237, 'node_id': 'MDQ6VXNlcjMzMDc5MjM3', 'avatar_url': 'https://avatars.githubusercontent.com/u/33079237?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/OuYangJinTing', 'html_url': 'https://github.com/OuYangJinTing', 'followers_url': 'https://api.github.com/users/OuYangJinTing/followers', 'following_url': 'https://api.github.com/users/OuYangJinTing/following{/other_user}', 'gists_url': 'https://api.github.com/users/OuYangJinTing/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/OuYangJinTing/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/OuYangJinTing/subscriptions', 'organizations_url': 'https://api.github.com/users/OuYangJinTing/orgs', 'repos_url': 'https://api.github.com/users/OuYangJinTing/repos', 'events_url': 'https://api.github.com/users/OuYangJinTing/events{/privacy}', 'received_events_url': 'https://api.github.com/users/OuYangJinTing/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-20T14:55:04Z,2022-12-22T10:40:50Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46781', 'html_url': 'https://github.com/rails/rails/pull/46781', 'diff_url': 'https://github.com/rails/rails/pull/46781.diff', 'patch_url': 'https://github.com/rails/rails/pull/46781.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because:
There is no way to easily skip `ActiveSupport::Cache::Strategy::LocalCache` at present.

### Detail

This Pull Request changes as follows:
- `ActiveSupport::Cache::Strategy::LocalCache#bypass_local_cache` changed private method to public method.
-  Added `Rails::Cache::Store#bypass_local_cache` public method, so that ensure all cache store implementations support call `bypass_local_cache` method.

### Additional information

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included. (_I'm not sure about this option. please let me know if necessary_)

_PS: English is not my native language; please excuse typing errors._","{'url': 'https://api.github.com/repos/rails/rails/issues/46781/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46781/timeline,,
https://api.github.com/repos/rails/rails/issues/46773,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46773/labels{/name},https://api.github.com/repos/rails/rails/issues/46773/comments,https://api.github.com/repos/rails/rails/issues/46773/events,https://github.com/rails/rails/pull/46773,1503204024,PR_kwDNIULORcvgIg,46773,Serialized attributes assigned with accepts_nested_attributes_for throw Psych::DisallowedClass errors,"{'login': 'akaspick', 'id': 24056, 'node_id': 'MDQ6VXNlcjI0MDU2', 'avatar_url': 'https://avatars.githubusercontent.com/u/24056?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/akaspick', 'html_url': 'https://github.com/akaspick', 'followers_url': 'https://api.github.com/users/akaspick/followers', 'following_url': 'https://api.github.com/users/akaspick/following{/other_user}', 'gists_url': 'https://api.github.com/users/akaspick/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/akaspick/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/akaspick/subscriptions', 'organizations_url': 'https://api.github.com/users/akaspick/orgs', 'repos_url': 'https://api.github.com/users/akaspick/repos', 'events_url': 'https://api.github.com/users/akaspick/events{/privacy}', 'received_events_url': 'https://api.github.com/users/akaspick/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,16,2022-12-19T16:07:15Z,2023-06-26T12:48:42Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46773', 'html_url': 'https://github.com/rails/rails/pull/46773', 'diff_url': 'https://github.com/rails/rails/pull/46773.diff', 'patch_url': 'https://github.com/rails/rails/pull/46773.patch', 'merged_at': None}","YAML by default now uses safe loading and only accepts a limited number of classes which includes `Hash`, but not `HashWithIndifferentAccess`.

When using `accepts_nested_attributes_for` with a serialized Hash attribute, a `Psych::DisallowedClass: Tried to load unspecified class: ActiveSupport::HashWithIndifferentAccess` error would be thrown even if the nested attribute is a regular hash.

This patch forces the nested attribute to a regular Hash attribute when using a serialized Hash. In general, the nested attributes are converted to a HashWithIndifferentAccess for processing, but this breaks the safe loading for YAML which doesn't accept HashWithIndifferentAccess, so the serialized attribute must be forced to a Hash.

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Safe YAML loading is enabled by default now and `accepts_nested_attributes_for` accepts serialized attributes, but if the serialized attribute is a Hash, then a `Psych::DisallowedClass` error is thrown.  There is no way to force the nested value to a Hash as the code for `accepts_nested_attributes_for` converts the parameters to a HashWithIndifferentAccess and thus generating an error serializing the serialized attribute.

Fixes #46684

### Detail

This Pull Request changes the ability to allow serialized hash attributes with `accepts_nested_attributes_for`

### Additional information

The linked issue number above includes additional information regarding the issue and the location in the rails code where conversion of the Hash to a HashWithIndifferentAccess occurs.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46773/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46773/timeline,,
https://api.github.com/repos/rails/rails/issues/46754,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46754/labels{/name},https://api.github.com/repos/rails/rails/issues/46754/comments,https://api.github.com/repos/rails/rails/issues/46754/events,https://github.com/rails/rails/pull/46754,1500919942,PR_kwDNIULORa215w,46754,Add `config.rotate_message_verifiers`,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-16T21:52:58Z,2022-12-16T21:53:01Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46754', 'html_url': 'https://github.com/rails/rails/pull/46754', 'diff_url': 'https://github.com/rails/rails/pull/46754.diff', 'patch_url': 'https://github.com/rails/rails/pull/46754.patch', 'merged_at': None}","This commit adds `config.rotate_message_verifiers`, which controls the the range of rotated defaults for `Rails.application.message_verifiers`. Currently, there is only one set of defaults, but
`config.rotate_message_verifiers` will allow users to easily opt in to new defaults as we add them, and opt out of old defaults as appropriate.

For example, setting `config.rotate_message_verifiers` to `""7.0""..""7.2""` would first rotate any default options that were added in Rails 7.2, then rotate any default options from Rails 7.1, and lastly rotate any default options from Rails 7.0.

`config.rotate_message_verifiers` may also be set to false to leave `Rails.application.message_verifiers` unconfigured.  In that case, the user is expected to configure `Rails.application.message_verifiers` (e.g. in an initializer) before it is used to create any message verifiers; otherwise, an error will be raised.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46754/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46754/timeline,,
https://api.github.com/repos/rails/rails/issues/46750,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46750/labels{/name},https://api.github.com/repos/rails/rails/issues/46750/comments,https://api.github.com/repos/rails/rails/issues/46750/events,https://github.com/rails/rails/pull/46750,1500394045,PR_kwDNIULORaaP6A,46750,Fix for issue #46587,"{'login': 'virtualfunction', 'id': 14468, 'node_id': 'MDQ6VXNlcjE0NDY4', 'avatar_url': 'https://avatars.githubusercontent.com/u/14468?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/virtualfunction', 'html_url': 'https://github.com/virtualfunction', 'followers_url': 'https://api.github.com/users/virtualfunction/followers', 'following_url': 'https://api.github.com/users/virtualfunction/following{/other_user}', 'gists_url': 'https://api.github.com/users/virtualfunction/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/virtualfunction/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/virtualfunction/subscriptions', 'organizations_url': 'https://api.github.com/users/virtualfunction/orgs', 'repos_url': 'https://api.github.com/users/virtualfunction/repos', 'events_url': 'https://api.github.com/users/virtualfunction/events{/privacy}', 'received_events_url': 'https://api.github.com/users/virtualfunction/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-16T15:10:56Z,2022-12-16T15:11:23Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46750', 'html_url': 'https://github.com/rails/rails/pull/46750', 'diff_url': 'https://github.com/rails/rails/pull/46750.diff', 'patch_url': 'https://github.com/rails/rails/pull/46750.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because ActionView does not correctly always resolve templates when using the `render` method from within a template when overrides are provided. e.g. a JSON request is made and thus sets `formats: [ :json ]`. If one wanted to render a string with HTML/XML using `formats: [ :html ]` this was not previously possible due to the typo 

### Detail

This Pull Request fixes a typo in the render method in rendering_helper.rb

It fixes #46587

### Additional information

Not managed to get my head around making a test case for this, but all existing tests pass given it's only fixing a typo

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46750/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46750/timeline,,
https://api.github.com/repos/rails/rails/issues/46746,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46746/labels{/name},https://api.github.com/repos/rails/rails/issues/46746/comments,https://api.github.com/repos/rails/rails/issues/46746/events,https://github.com/rails/rails/pull/46746,1499371916,PR_kwDNIULORZig4w,46746,Call after_rollback callback on new records,"{'login': 'tenderlove', 'id': 3124, 'node_id': 'MDQ6VXNlcjMxMjQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3124?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/tenderlove', 'html_url': 'https://github.com/tenderlove', 'followers_url': 'https://api.github.com/users/tenderlove/followers', 'following_url': 'https://api.github.com/users/tenderlove/following{/other_user}', 'gists_url': 'https://api.github.com/users/tenderlove/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/tenderlove/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/tenderlove/subscriptions', 'organizations_url': 'https://api.github.com/users/tenderlove/orgs', 'repos_url': 'https://api.github.com/users/tenderlove/repos', 'events_url': 'https://api.github.com/users/tenderlove/events{/privacy}', 'received_events_url': 'https://api.github.com/users/tenderlove/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-16T00:42:57Z,2022-12-16T00:44:58Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46746', 'html_url': 'https://github.com/rails/rails/pull/46746', 'diff_url': 'https://github.com/rails/rails/pull/46746.diff', 'patch_url': 'https://github.com/rails/rails/pull/46746.patch', 'merged_at': None}","This commit makes sure after_rollback callbacks are called on new records.

I have to admit, I really don't understand this patch.  I feel like I'm playing boolean whack-a-mole.

Fixes #36965","{'url': 'https://api.github.com/repos/rails/rails/issues/46746/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46746/timeline,,
https://api.github.com/repos/rails/rails/issues/46696,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46696/labels{/name},https://api.github.com/repos/rails/rails/issues/46696/comments,https://api.github.com/repos/rails/rails/issues/46696/events,https://github.com/rails/rails/pull/46696,1488363670,PR_kwDNIULORP7MJw,46696,Allow `cursor_column` in querying batch methods,"{'login': 'AlfonsoUceda', 'id': 925961, 'node_id': 'MDQ6VXNlcjkyNTk2MQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/925961?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/AlfonsoUceda', 'html_url': 'https://github.com/AlfonsoUceda', 'followers_url': 'https://api.github.com/users/AlfonsoUceda/followers', 'following_url': 'https://api.github.com/users/AlfonsoUceda/following{/other_user}', 'gists_url': 'https://api.github.com/users/AlfonsoUceda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/AlfonsoUceda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/AlfonsoUceda/subscriptions', 'organizations_url': 'https://api.github.com/users/AlfonsoUceda/orgs', 'repos_url': 'https://api.github.com/users/AlfonsoUceda/repos', 'events_url': 'https://api.github.com/users/AlfonsoUceda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/AlfonsoUceda/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,9,2022-12-10T10:37:43Z,2023-09-27T14:34:25Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46696', 'html_url': 'https://github.com/rails/rails/pull/46696', 'diff_url': 'https://github.com/rails/rails/pull/46696.diff', 'patch_url': 'https://github.com/rails/rails/pull/46696.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

The idea of this pull request is to support `cursor_column` option when using `find_each`, `find_in_batches` and `in_batches` querying batch methods.

The primary key in a table is usually an integer but sometimes people use UUIDs as primary key. These methods won't work for UUID primary keys so the idea is to allow to specify the `cursor_column` when using these methods.

### Detail

`cursor_column` is a new param in the following methods: `find_each`, `find_in_batches` and `in_batches`. If it isn't passed they will behave with the primary key as default, no breaking changes. If you pass `cursor_column` it will use that column for sorting the collection in batches.

### Additional information

**Example**
```ruby
require ""active_record""
require ""active_support""
require ""securerandom""

ActiveRecord::Base.logger = ActiveSupport::Logger.new(STDOUT)

class Post < ActiveRecord::Base
  establish_connection adapter: ""sqlite3"", database: ""foobar.db""
  connection.create_table table_name, id: false, force: true do |t|
    t.string :id, primary_key: true
    t.string :title
    t.integer :version
  end
end

Post.create!(id: SecureRandom.uuid, title: ""Post 1"", version: 1)
Post.create!(id: SecureRandom.uuid, title: ""Post 2"", version: 2)
Post.create!(id: SecureRandom.uuid, title: ""Post 3"", version: 3)

Post.find_each(batch_size: 1, cursor_column: :version, order: :asc) do |post|
  pp [post.title, post.version]
end

# Post Load (0.1ms)  SELECT ""posts"".* FROM ""posts"" ORDER BY ""posts"".""version"" ASC LIMIT ?  [[""LIMIT"", 1]]
# [""Post 1"", 1]
# Post Load (0.1ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""version"" > ? ORDER BY ""posts"".""version"" ASC LIMIT ?  [[""version"", 1], [""LIMIT"", 1]]
# [""Post 2"", 2]
# Post Load (0.0ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""version"" > ? ORDER BY ""posts"".""version"" ASC LIMIT ?  [[""version"", 2], [""LIMIT"", 1]]
# [""Post 3"", 3]
# Post Load (0.0ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""version"" > ? ORDER BY ""posts"".""version"" ASC LIMIT ?  [[""version"", 3], [""LIMIT"", 1]]

Post.find_each(batch_size: 1, cursor_column: :version, order: :desc) do |post|
  pp [post.title, post.version]
end

# Post Load (0.2ms)  SELECT ""posts"".* FROM ""posts"" ORDER BY ""posts"".""version"" DESC LIMIT ?  [[""LIMIT"", 1]]
# [""Post 3"", 3]
# Post Load (0.1ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""version"" < ? ORDER BY ""posts"".""version"" DESC LIMIT ?  [[""version"", 3], [""LIMIT"", 1]]
# [""Post 2"", 2]
# Post Load (0.1ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""version"" < ? ORDER BY ""posts"".""version"" DESC LIMIT ?  [[""version"", 2], [""LIMIT"", 1]]
# [""Post 1"", 1]
# Post Load (0.1ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""version"" < ? ORDER BY ""posts"".""version"" DESC LIMIT ?  [[""version"", 1], [""LIMIT"", 1]]
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46696/reactions', 'total_count': 7, '+1': 6, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/46696/timeline,,
https://api.github.com/repos/rails/rails/issues/46684,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46684/labels{/name},https://api.github.com/repos/rails/rails/issues/46684/comments,https://api.github.com/repos/rails/rails/issues/46684/events,https://github.com/rails/rails/issues/46684,1486866645,I_kwDNIULOWJ_I1Q,46684,Serialized attributes assigned with accepts_nested_attributes_for throw Psych::DisallowedClass errors,"{'login': 'akaspick', 'id': 24056, 'node_id': 'MDQ6VXNlcjI0MDU2', 'avatar_url': 'https://avatars.githubusercontent.com/u/24056?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/akaspick', 'html_url': 'https://github.com/akaspick', 'followers_url': 'https://api.github.com/users/akaspick/followers', 'following_url': 'https://api.github.com/users/akaspick/following{/other_user}', 'gists_url': 'https://api.github.com/users/akaspick/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/akaspick/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/akaspick/subscriptions', 'organizations_url': 'https://api.github.com/users/akaspick/orgs', 'repos_url': 'https://api.github.com/users/akaspick/repos', 'events_url': 'https://api.github.com/users/akaspick/events{/privacy}', 'received_events_url': 'https://api.github.com/users/akaspick/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2022-12-09T14:36:18Z,2023-02-07T15:40:51Z,,CONTRIBUTOR,,,,"### Steps to reproduce
Assigning serializable attributes to child associations via accepts_nested_attributes_for throws `Psych::DisallowedClass: Tried to load unspecified class: ActiveSupport::HashWithIndifferentAccess` errors during the serialization process.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", git: 'https://github.com/rails/rails'
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :customers, force: true do |t|
  end
  create_table :orders, force: true do |t|
    t.text :data
    t.belongs_to :customer
  end
end

class Customer < ActiveRecord::Base
  has_many :orders
  accepts_nested_attributes_for :orders
end
class Order < ActiveRecord::Base
  serialize :data, Hash
  belongs_to :customer
end

class BugTest < Minitest::Test
  def test_serialization_for_new_record
    order_attributes = [{'data' => {'test' => 1}}]

    assert_equal Hash, order_attributes.first.class
    assert_equal Hash, order_attributes.first['data'].class

    # NOTE
    # Raises Psych::DisallowedClass: Tried to load unspecified class: ActiveSupport::HashWithIndifferentAccess
    # Error due to conversion of Hash to HashWithIndifferentAccess at https://github.com/rails/rails/blob/main/activerecord/lib/active_record/nested_attributes.rb#L518
    Customer.new orders_attributes: order_attributes
  end
end
```

### Expected behavior
When using a Hash with the `serialize` method, I expect to be able to assign a hash of values with `accepts_nested_attributes_for` without issues.

### Actual behavior
Currently when using a `serialize :data, Hash` attribute, you can't assign an actual hash to the attribute via parameters set using the `accepts_nested_attributes_for` method.  When doing so the hash to be serialized is converted to a HashWithIndifferentAccess which is not allowed with the YAML/Psych loader and a `Psych::DisallowedClass: Tried to load unspecified class: ActiveSupport::HashWithIndifferentAccess` error is thrown.

The issue is due to a hash conversion in the source at https://github.com/rails/rails/blob/main/activerecord/lib/active_record/nested_attributes.rb#L518

`with_indifferent_access` does a deep hash conversion of keys including the hash attribute to be serialized.  The serialized attribute should not be converted and should be left as-is.

### System configuration
**Rails version**: main branch (issue also exists when using 7.0.4)

**Ruby version**: 3.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/46684/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46684/timeline,,
https://api.github.com/repos/rails/rails/issues/46674,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46674/labels{/name},https://api.github.com/repos/rails/rails/issues/46674/comments,https://api.github.com/repos/rails/rails/issues/46674/events,https://github.com/rails/rails/pull/46674,1484960461,PR_kwDNIULORM7A8Q,46674,Allow false options in ConnectionUrlResolver,"{'login': 'agios', 'id': 758908, 'node_id': 'MDQ6VXNlcjc1ODkwOA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/758908?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/agios', 'html_url': 'https://github.com/agios', 'followers_url': 'https://api.github.com/users/agios/followers', 'following_url': 'https://api.github.com/users/agios/following{/other_user}', 'gists_url': 'https://api.github.com/users/agios/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/agios/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/agios/subscriptions', 'organizations_url': 'https://api.github.com/users/agios/orgs', 'repos_url': 'https://api.github.com/users/agios/repos', 'events_url': 'https://api.github.com/users/agios/events{/privacy}', 'received_events_url': 'https://api.github.com/users/agios/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-08T16:14:27Z,2023-01-13T09:30:27Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46674', 'html_url': 'https://github.com/rails/rails/pull/46674', 'diff_url': 'https://github.com/rails/rails/pull/46674.diff', 'patch_url': 'https://github.com/rails/rails/pull/46674.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

Currently DATABASE_URL does not provide a way to pass an option with a `false` value, eg:

```shell
DATABASE_URL=""postgresql://postgres@localhost:5432/db_name?schema_dump=false"" bundle exec rails c
```

### Expected behavior
```ruby
ActiveRecord::Base.connection_db_config.schema_dump
=> false
```

### Actual behavior
```ruby
ActiveRecord::Base.connection_db_config.schema_dump
=> ""false""
```
The problem with this is that it's actually truthy and there is no way to pass a falsy value, as nil is compacted.

### Detail

This changes the option value to `false` if it is a string that equals `""false""` (insensitive) 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46674/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46674/timeline,,
https://api.github.com/repos/rails/rails/issues/46666,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46666/labels{/name},https://api.github.com/repos/rails/rails/issues/46666/comments,https://api.github.com/repos/rails/rails/issues/46666/events,https://github.com/rails/rails/pull/46666,1482900662,PR_kwDNIULORLFgMA,46666,Allow disabling error markup generation on a per-field basis,"{'login': 'camertron', 'id': 575280, 'node_id': 'MDQ6VXNlcjU3NTI4MA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/575280?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/camertron', 'html_url': 'https://github.com/camertron', 'followers_url': 'https://api.github.com/users/camertron/followers', 'following_url': 'https://api.github.com/users/camertron/following{/other_user}', 'gists_url': 'https://api.github.com/users/camertron/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/camertron/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/camertron/subscriptions', 'organizations_url': 'https://api.github.com/users/camertron/orgs', 'repos_url': 'https://api.github.com/users/camertron/repos', 'events_url': 'https://api.github.com/users/camertron/events{/privacy}', 'received_events_url': 'https://api.github.com/users/camertron/received_events', 'type': 'User', 'site_admin': True}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-07T21:32:54Z,2023-09-29T22:38:59Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46666', 'html_url': 'https://github.com/rails/rails/pull/46666', 'diff_url': 'https://github.com/rails/rails/pull/46666.diff', 'patch_url': 'https://github.com/rails/rails/pull/46666.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

This PR is a replacement for https://github.com/rails/rails/pull/46618

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

I'm working on a forms framework on the Primer team at GitHub that allows rendering forms declaratively. My pair and I noticed today that Rails will wrap invalid inputs and labels with a `<div>` containing a class of `field_with_errors`, ostensibly allowing for custom styling of invalid fields. We also learned this behavior can be customized by setting the application-level `ActionView::Base.field_error_proc` option.

Our framework automatically handles styling invalid fields in accordance with our design system. The additional wrapper `<div>`, while something we can work around, unexpectedly led to a visual regression today in our testing:

![image](https://user-images.githubusercontent.com/575280/206300064-047fb2c4-871b-461d-8110-0f7f5f08ad22.png)

As you can see, the little arrows on the right-hand side of the select list are outside the red outline. The arrows are implemented as an `:after` selector and live [here](https://github.com/primer/view_components/blob/main/app/components/primer/alpha/text_field.pcss#L476). The additional `<div>` causes the `:after` selector to place the mask after the `<div>` instead of after the `<select>`.

### Detail

My pair and I were unable to find any field-level option to disable wrapping, so I have submitted this PR. You can now pass  `generate_error_markup: false` to form helpers to skip wrapping fields with the aforementioned `<div>`:

```erb
<%= form_with(model: user) do |f| %>
  <%= f.text_field(:name, generate_error_markup: false) %>
<% end %>
```

### Open Questions

- [ ] As the `generate_error_markup:` option can be passed to all form helpers and form builder methods, I'm not sure where the most appropriate place is to document the changes. Is someone able to help me with that?

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [ ] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46666/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46666/timeline,,
https://api.github.com/repos/rails/rails/issues/46655,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46655/labels{/name},https://api.github.com/repos/rails/rails/issues/46655/comments,https://api.github.com/repos/rails/rails/issues/46655/events,https://github.com/rails/rails/pull/46655,1479067169,PR_kwDNIULORHrxdg,46655,Fix has_many through association with source_type loading records of the wrong type,"{'login': 'monorkin', 'id': 1655218, 'node_id': 'MDQ6VXNlcjE2NTUyMTg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1655218?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/monorkin', 'html_url': 'https://github.com/monorkin', 'followers_url': 'https://api.github.com/users/monorkin/followers', 'following_url': 'https://api.github.com/users/monorkin/following{/other_user}', 'gists_url': 'https://api.github.com/users/monorkin/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/monorkin/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/monorkin/subscriptions', 'organizations_url': 'https://api.github.com/users/monorkin/orgs', 'repos_url': 'https://api.github.com/users/monorkin/repos', 'events_url': 'https://api.github.com/users/monorkin/events{/privacy}', 'received_events_url': 'https://api.github.com/users/monorkin/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-12-06T13:05:41Z,2023-01-30T14:51:31Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46655', 'html_url': 'https://github.com/rails/rails/pull/46655', 'diff_url': 'https://github.com/rails/rails/pull/46655.diff', 'patch_url': 'https://github.com/rails/rails/pull/46655.patch', 'merged_at': None}","### Motivation / Background

Defining `source_type` can cause an association to fetch records from a
different model than the one defined in `source_type`.

For example, if there are three models - `User`, `Device` and `User::Device`.
Defining a `has_many :favorite_devices, through: ...` relationship on
the `User` that uses `source_type: ""Device""` should return objects
of class `Device`, but it returns objects of class `User::Device` instead.

This behavior can be corrected by specifying `class_name: ""::Device""` on the
`has_many :favorite_devices, through: ...` relationship. With it the
association returns objects of type `Device`.

I believe that this is a bug because the behavior changes based on the model
that resolves the association. E.g. if I add a fourth model - `Widget` with
a `has_many :favorite_devices, through: :user` then this association returns
`Device` objects.

<details>
  <summary>Test case</summary>

  ```ruby
  # frozen_string_literal: true

  require ""bundler/inline""

  gemfile(true) do
    source ""https://rubygems.org""

    git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

    rails_options = if ENV.key?(""LOCAL"")
      { path: ""#{Dir.pwd}/rails"" }
    else
      { github: ""rails/rails"", branch: ""main"" }
    end

    gem ""rails"", rails_options
    gem ""sqlite3""
    gem ""timeout"" # Fixes an issue with Ruby 3.1, ignore this
  end

  require ""active_record""
  require ""minitest/autorun""
  require ""logger""

  # This connection will do for database-independent bug reports.
  ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
  ActiveRecord::Base.logger = Logger.new(STDOUT)

  ActiveRecord::Schema.define do
    create_table :users, force: true do |t|
    end

    create_table :user_devices, force: true do |t|
      t.integer :user_id
      # t.string :push_notifification_token
      # t.string :locale
    end

    create_table :widgets, force: true do |t|
      t.integer :user_id
      # t.string :name
    end

    create_table :user_favorites, force: true do |t|
      t.integer :user_id
      t.string :favorable_type
      t.integer :favorable_id
    end

    create_table :devices, force: true do |t|
      # t.string :name
    end
  end

  # A person that uses the app
  class User < ActiveRecord::Base
    has_many :devices,
             class_name: ""User::Device""
    has_many :favorites,
             class_name: ""User::Favorite""
    has_many :favorite_devices,
             through: :favorites,
             source: :favorable,
             source_type: ""Device""
    has_many :widgets
  end

  # Anything the user wants to pin as their favorite
  # E.g. to show up in a dashboard after they sign in
  class User::Favorite < ActiveRecord::Base
    belongs_to :favorable, polymorphic: true
    belongs_to :user
  end

  # Used for session tracking and push notification
  # This model represents a person's phone or browser and would usually store
  # their push notification token, preffered language for that device and other
  # metadata
  class User::Device < ActiveRecord::Base
    belongs_to :user
  end

  # An IoT devices
  # THis model stores all configration data for the device and is used to
  # associate other models to a device
  class Device < ActiveRecord::Base
  end

  # An UI widget
  class Widget < ActiveRecord::Base
    belongs_to :user
    has_many :favorite_devices, through: :user
  end

  class BugTest < Minitest::Test
    def test_association_stuff
      user = User.create!
      widget = user.widgets.create!

      # The ID is important to demo this problem, that's why I set it manually
      # If the ID of the User::Device record and the Device record are the same
      # then this test passes due to a false positive
      user_device = User::Device.create!(id: 13, user: user)
      washing_machine = Device.create!(id: 13)
      vacuum_cleaner = Device.create!(id: 12)

      # The user adds an IoT Device to their favorites
      favorite1 = User::Favorite.create!(user: user, favorable: washing_machine)
      favorite2 = User::Favorite.create!(user: user, favorable: vacuum_cleaner)

      assert_equal [user_device], user.devices,
        ""The user can access their devices (phones / browsers)""
      assert_equal [favorite1, favorite2], user.favorites,
        ""The user can access their favorites""

      assert_equal [""Device"", ""Device""], user.favorites.pluck(:favorable_type),
        ""The user's favorites are models of class Device""
      assert_equal [washing_machine.id, vacuum_cleaner.id].sort,
        user.favorites.pluck(:favorable_id).sort,
        ""The user's favorites have the same IDs as the associated devices""

      assert_equal [washing_machine, vacuum_cleaner],
        [favorite1.favorable, favorite2.favorable]
        ""The user can access their favorite device through the User::Favorite object""
      assert_equal [washing_machine, vacuum_cleaner].sort_by(&:id),
        widget.favorite_devices.sort_by(&:id),
        ""The widget can access the user's favorite devices""

      # These fail because `user.favorite_devices` queries User::Device instead
      # of Device when `#compute_class` is called
      assert_equal [washing_machine, vacuum_cleaner].sort_by(&:id),
        user.favorite_devices.sort_by(&:id),
        ""The user can access their own favorite devices""
      assert_equal [washing_machine.id, vacuum_cleaner.id].sort,
        user.favorite_device_ids.sort,
        ""The user can access the IDs of their own favorite devices""
    end
  end
  ```
</details>

### Detail

When you specify a `source_type` it gets used in the `klass` method which
is responsible for returning the class of the objects returned by the
association.

The `klass` method determines the class using two other methods - `class_name`
and `compute_class`.

`class_name` returns the sanitized value from the `derive_class_name` method,
which returns the value from the passed `source_type` option.

`compute_class` tries to resolve this class name to a class in the usual way.
In the example from before, where the `User` has an association with
`source_type: ""Device""`, it would search for the `User::Device` class first and
then for the `Device` class. Since `User::Device` exists it gets used as the
association's model instead of `Device`.

When a `Widget` calls `favorite_devices` through its
`has_many :favorite_devices, through: :user` association, `compute_class`
returns the `Device` class because it can't find a `Widget::Device` class and
falls back to the `Device` class.

To fix this, I made the returned class name from `derive_class_name`
absolute by prefixing it with `::` if the value comes from the `source_type`
option.

This makes class lookups from `source_type` consistent with the query behavior,
resolves similar issues with mixed-in and inherited associations that use
`source_type`, and it makes the class name in the polymorphic `*_type` column
absolute when used with `source_type` (which seems to be how polymorphic
relationships are supposed to be stored).

The downside of this solution is that it breaks associations that relied on
this lookup behavior for `source_type`.

### Additional information

This patch still allows the use of `class_name` with `source_type` and it works as
usual - `class_name` takes precedence. Maybe the combined use of `source_type`
and `class_name` should prohibited? I haven't investigated this possibility.

---

I'm not sure what the convention for adding new test models is.

I tried extending the `Tag` test model to have an associated `Rating` to avoid
adding three extra models, but that caused other unrelated tests to fail so I
opted for the extra few models instead.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/46655/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46655/timeline,,
https://api.github.com/repos/rails/rails/issues/46653,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46653/labels{/name},https://api.github.com/repos/rails/rails/issues/46653/comments,https://api.github.com/repos/rails/rails/issues/46653/events,https://github.com/rails/rails/issues/46653,1478822248,I_kwDNIULOWCUJaA,46653,becomes lost default value on target class,"{'login': 'oniram88', 'id': 173604, 'node_id': 'MDQ6VXNlcjE3MzYwNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/173604?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/oniram88', 'html_url': 'https://github.com/oniram88', 'followers_url': 'https://api.github.com/users/oniram88/followers', 'following_url': 'https://api.github.com/users/oniram88/following{/other_user}', 'gists_url': 'https://api.github.com/users/oniram88/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/oniram88/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/oniram88/subscriptions', 'organizations_url': 'https://api.github.com/users/oniram88/orgs', 'repos_url': 'https://api.github.com/users/oniram88/repos', 'events_url': 'https://api.github.com/users/oniram88/events{/privacy}', 'received_events_url': 'https://api.github.com/users/oniram88/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2022-12-06T11:00:29Z,2023-03-13T18:25:12Z,,NONE,,,,"### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.0.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :animals, force: true do |t|

    t.string :name
    t.string :type

    t.integer :fly_speed

  end

end

class Animal < ActiveRecord::Base
  attribute :name, :string, default: ""DEFAULT NAME""
end

class Bird < Animal
  attribute :fly_speed, :string, default: 100

end

class BugTest < Minitest::Test
  def test_becomes_with_defaults
    animal = Animal.new

    assert_equal ""DEFAULT NAME"", animal.name

    bird = animal.becomes(Bird)

    assert_equal 100, bird.fly_speed
  end
end
```

### Expected behavior
I expect that the method becomes set correctly the defaults of the model 

### Actual behavior
`becomes` is coping the `@attributes` directly from Animal in this case, and so the new model lost the defaults generated during initialization

### System configuration

**Gems**:
  - activerecord 7.0.4
  
**Ruby version**:
  - 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46653/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46653/timeline,,
https://api.github.com/repos/rails/rails/issues/46652,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46652/labels{/name},https://api.github.com/repos/rails/rails/issues/46652/comments,https://api.github.com/repos/rails/rails/issues/46652/events,https://github.com/rails/rails/pull/46652,1478281245,PR_kwDNIULORG__Zg,46652,Fix performance of CollectionAssociation replace_on_target and include,"{'login': 'jeffcarbs', 'id': 847027, 'node_id': 'MDQ6VXNlcjg0NzAyNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/847027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jeffcarbs', 'html_url': 'https://github.com/jeffcarbs', 'followers_url': 'https://api.github.com/users/jeffcarbs/followers', 'following_url': 'https://api.github.com/users/jeffcarbs/following{/other_user}', 'gists_url': 'https://api.github.com/users/jeffcarbs/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jeffcarbs/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jeffcarbs/subscriptions', 'organizations_url': 'https://api.github.com/users/jeffcarbs/orgs', 'repos_url': 'https://api.github.com/users/jeffcarbs/repos', 'events_url': 'https://api.github.com/users/jeffcarbs/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jeffcarbs/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2022-12-06T05:49:55Z,2022-12-10T20:20:45Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46652', 'html_url': 'https://github.com/rails/rails/pull/46652', 'diff_url': 'https://github.com/rails/rails/pull/46652.diff', 'patch_url': 'https://github.com/rails/rails/pull/46652.patch', 'merged_at': None}","### Motivation / Background

In some production timing traces we noticed large gaps where code that looked like `order.items = items` (i.e. setting an association) seemed to be hanging. In this instance the association had ~7k items and it hung for around 30 seconds. Even more surprising is that no new records were being added/removed - it was essentially `order.items = order.items`.

In profiling the code, we uncovered an n-squared lookup that this PR fixes. The high-level results in iterations/second:
- ~roughly same for collections of size 10
- 5x improvement for collections of size 100
- 50x () improvement for collections of size 1000

### Detail

The n-squared lookup was due to how the code determined the index of an existing record. We looped through every record we were trying to set that was in the existing list, and then tried to find its index using `target.index(record)` which would potentially have to scan the entire array.

This PR introduces a method for finding the index of a record that will build a hash of record-to-index on the first call so subsequent calls are constant time hash lookups.

I also noticed the same array scan behavior in `order.items.include?(item)` that could trivially be replaced with the same `index_for_record` method so this PR updates that as well. For include the speed improvements were:
- 7x for collections of size 10
- 68x for collections of size 100
- 690x for collections of size 1000

See the associated benchmarks

<details>
<summary>Benchmark script for `replace_on_target`</summary>

```ruby
require ""bundler/setup""
require ""active_record""
begin
  require ""benchmark/ips""
rescue LoadError
  raise LoadError, ""Run install `gem install benchmark-ips`""
end

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.connection.create_table(:orders) { |t| }
ActiveRecord::Base.connection.create_table(:items) { |t| t.references :order, null: false }

class Order < ActiveRecord::Base
  has_many :items
  accepts_nested_attributes_for :items
end

class Item < ActiveRecord::Base
end

Benchmark.ips do |x|
  order_10 = Order.create
  Item.insert_all(Array.new(10, { order_id: order_10.id }))
  order_10.reload

  order_100 = Order.create
  Item.insert_all(Array.new(100, { order_id: order_100.id }))
  order_100.reload

  order_1000 = Order.create
  Item.insert_all(Array.new(1000, { order_id: order_1000.id }))
  order_1000.reload

  x.report(""Assoc size   10"") do
    order_10.items.reload
    order_10.items = order_10.items
  end

  x.report(""Assoc size  100"") do
    order_100.items.reload
    order_100.items = order_100.items
  end

  x.report(""Assoc size 1000"") do
    order_1000.items.reload
    order_1000.items = order_1000.items
  end
end
```

</details>

**Before**
```
~[main] $ ruby benchmark_replace_on_target.rb
Warming up --------------------------------------
     Assoc size   10   461.000  i/100ms
     Assoc size  100    29.000  i/100ms
     Assoc size 1000     1.000  i/100ms
Calculating -------------------------------------
     Assoc size   10      4.636k ( 2.6%) i/s -     23.511k in   5.074951s
     Assoc size  100    285.265  ( 3.2%) i/s -      1.450k in   5.089038s
     Assoc size 1000      3.361  ( 0.0%) i/s -     17.000  in   5.058245s
```

**After**
```
~[collection-association-performance] $ ruby benchmark_replace_on_target.rb
Warming up --------------------------------------
     Assoc size   10   493.000  i/100ms
     Assoc size  100   147.000  i/100ms
     Assoc size 1000    16.000  i/100ms
Calculating -------------------------------------
     Assoc size   10      4.982k ( 1.6%) i/s -     25.143k in   5.048535s
     Assoc size  100      1.513k ( 4.9%) i/s -      7.644k in   5.065432s
     Assoc size 1000    168.608  ( 6.5%) i/s -    848.000  in   5.051481s
```

Speed improvements:
- Size 10: roughly same
- Size 100: ~5x improvement
- Size 1000: ~50x improvement

<details>
<summary>Benchmark script for `include?`</summary>

```ruby
require ""bundler/setup""
require ""active_record""
begin
  require ""benchmark/ips""
rescue LoadError
  raise LoadError, ""Run install `gem install benchmark-ips`""
end

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.connection.create_table(:orders) { |t| }
ActiveRecord::Base.connection.create_table(:items) { |t| t.references :order, null: false }

class Order < ActiveRecord::Base
  has_many :items
  accepts_nested_attributes_for :items
end

class Item < ActiveRecord::Base
end

Benchmark.ips do |x|
  order_10 = Order.create
  Item.insert_all(Array.new(10, { order_id: order_10.id }))
  order_10.reload

  order_100 = Order.create
  Item.insert_all(Array.new(100, { order_id: order_100.id }))
  order_100.reload

  order_1000 = Order.create
  Item.insert_all(Array.new(1000, { order_id: order_1000.id }))
  order_1000.reload

  # Use item that's definitely not in the order as worst case
  non_existent_item = Item.create(order_id: Order.create.id)

  # Load association so we use an in-memory lookup
  order_10.items.load_target
  x.report(""Assoc size   10"") do
    order_10.items.include?(non_existent_item)
  end

  # Load association so we use an in-memory lookup
  order_100.items.load_target
  x.report(""Assoc size  100"") do
    order_100.items.include?(non_existent_item)
  end

  # Load association so we use an in-memory lookup
  order_1000.items.load_target
  x.report(""Assoc size 1000"") do
    order_1000.items.include?(non_existent_item)
  end
end
```

</details>

**Before**
```
~[main] $ ruby benchmark_include.rb
Warming up --------------------------------------
     Assoc size   10    14.311k i/100ms
     Assoc size  100     1.543k i/100ms
     Assoc size 1000   155.000  i/100ms
Calculating -------------------------------------
     Assoc size   10    144.877k ( 1.0%) i/s -    729.861k in   5.038337s
     Assoc size  100     15.434k ( 1.1%) i/s -     78.693k in   5.099425s
     Assoc size 1000      1.538k ( 1.4%) i/s -      7.750k in   5.039121s
```

**After**
```
~[collection-association-performance] $ ruby benchmark_include.rb
Warming up --------------------------------------
     Assoc size   10   107.222k i/100ms
     Assoc size  100   105.796k i/100ms
     Assoc size 1000   104.449k i/100ms
Calculating -------------------------------------
     Assoc size   10      1.068M ( 1.1%) i/s -      5.361M in   5.020763s
     Assoc size  100      1.065M ( 0.8%) i/s -      5.396M in   5.067783s
     Assoc size 1000      1.058M ( 1.5%) i/s -      5.327M in   5.035916s
```

Speed improvements:
- Size 10: ~7x
- Size 100: ~68x improvement
- Size 1000: ~690x improvement

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46652/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46652/timeline,,
https://api.github.com/repos/rails/rails/issues/46651,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46651/labels{/name},https://api.github.com/repos/rails/rails/issues/46651/comments,https://api.github.com/repos/rails/rails/issues/46651/events,https://github.com/rails/rails/pull/46651,1477537904,PR_kwDNIULORGWDRg,46651,"Actual parameter value is Rack::Request, make naming consistent","{'login': 'Vasfed', 'id': 135265, 'node_id': 'MDQ6VXNlcjEzNTI2NQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/135265?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Vasfed', 'html_url': 'https://github.com/Vasfed', 'followers_url': 'https://api.github.com/users/Vasfed/followers', 'following_url': 'https://api.github.com/users/Vasfed/following{/other_user}', 'gists_url': 'https://api.github.com/users/Vasfed/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Vasfed/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Vasfed/subscriptions', 'organizations_url': 'https://api.github.com/users/Vasfed/orgs', 'repos_url': 'https://api.github.com/users/Vasfed/repos', 'events_url': 'https://api.github.com/users/Vasfed/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Vasfed/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-05T22:03:59Z,2022-12-05T22:33:54Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46651', 'html_url': 'https://github.com/rails/rails/pull/46651', 'diff_url': 'https://github.com/rails/rails/pull/46651.diff', 'patch_url': 'https://github.com/rails/rails/pull/46651.patch', 'merged_at': None}","### Motivation / Background

Since rack 2.0.0.alpha [request is passed to session objects](https://github.com/rack/rack/blob/main/CHANGELOG.md#200alpha-2015-12-04) instead of rack env:
> Change Session internals to use Request objects for looking up session information. This allows us to only allocate one request object when dealing with session objects (rather than doing it every time we need to manipulate cookies, etc).

And `ActionDispatch::Session:CookieStore` was changed accordingly, but other stores where the parameter was not used (and thus stores were not broken by the change) were not changed.

Leftover name `env` is misleading for anyone writing or debugging a custom session store, because one would expect value to be a rack environment hash.

### Detail

This Pull Request changes parameter names for rack request in abstract and cache stores to be consistent with `ActionDispatch::Session:CookieStore` (from `env` to `req`)

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46651/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46651/timeline,,
https://api.github.com/repos/rails/rails/issues/46645,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46645/labels{/name},https://api.github.com/repos/rails/rails/issues/46645/comments,https://api.github.com/repos/rails/rails/issues/46645/events,https://github.com/rails/rails/pull/46645,1475779712,PR_kwDNIULOREzxVQ,46645,Add how to set default_url_options for integration test,"{'login': 'wakairo', 'id': 6393110, 'node_id': 'MDQ6VXNlcjYzOTMxMTA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6393110?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/wakairo', 'html_url': 'https://github.com/wakairo', 'followers_url': 'https://api.github.com/users/wakairo/followers', 'following_url': 'https://api.github.com/users/wakairo/following{/other_user}', 'gists_url': 'https://api.github.com/users/wakairo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/wakairo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/wakairo/subscriptions', 'organizations_url': 'https://api.github.com/users/wakairo/orgs', 'repos_url': 'https://api.github.com/users/wakairo/repos', 'events_url': 'https://api.github.com/users/wakairo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/wakairo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-12-05T06:23:33Z,2022-12-05T13:48:35Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46645', 'html_url': 'https://github.com/rails/rails/pull/46645', 'diff_url': 'https://github.com/rails/rails/pull/46645.diff', 'patch_url': 'https://github.com/rails/rails/pull/46645.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because I met `ActionController::UrlGenerationError: No route matches` when I follow ""2.2.2 Setting the Locale from URL Params"" of rails guides ([Rails Internationalization (I18n) API](https://edgeguides.rubyonrails.org/i18n.html)) and it was hard to find a solution.

### Detail

This Pull Request adds texts and codes to show how to set `default_url_options` in the test helper to deal with setting of the Locale from URL Params.

### Additional information

Though I referred to [this issue of Rails](https://github.com/rails/rails/issues/546), I am not sure about what code should be shown in the Rails guides as the best practice. So, please let me know if there is the better code than what I wrote in this commit. If there is, I will make a new commit with the better code and remake the pull request with the new commit.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46645/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46645/timeline,,
https://api.github.com/repos/rails/rails/issues/46638,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46638/labels{/name},https://api.github.com/repos/rails/rails/issues/46638/comments,https://api.github.com/repos/rails/rails/issues/46638/events,https://github.com/rails/rails/pull/46638,1474194987,PR_kwDNIULORDaU3g,46638,Fix: TextHelper highlight does sanitisation incorrectly,"{'login': 'psantos10', 'id': 374424, 'node_id': 'MDQ6VXNlcjM3NDQyNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/374424?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/psantos10', 'html_url': 'https://github.com/psantos10', 'followers_url': 'https://api.github.com/users/psantos10/followers', 'following_url': 'https://api.github.com/users/psantos10/following{/other_user}', 'gists_url': 'https://api.github.com/users/psantos10/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/psantos10/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/psantos10/subscriptions', 'organizations_url': 'https://api.github.com/users/psantos10/orgs', 'repos_url': 'https://api.github.com/users/psantos10/repos', 'events_url': 'https://api.github.com/users/psantos10/events{/privacy}', 'received_events_url': 'https://api.github.com/users/psantos10/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,3,2022-12-03T19:20:22Z,2023-09-02T14:03:38Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46638', 'html_url': 'https://github.com/rails/rails/pull/46638', 'diff_url': 'https://github.com/rails/rails/pull/46638.diff', 'patch_url': 'https://github.com/rails/rails/pull/46638.patch', 'merged_at': None}",Fixes #46514 ,"{'url': 'https://api.github.com/repos/rails/rails/issues/46638/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46638/timeline,,
https://api.github.com/repos/rails/rails/issues/46587,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46587/labels{/name},https://api.github.com/repos/rails/rails/issues/46587/comments,https://api.github.com/repos/rails/rails/issues/46587/events,https://github.com/rails/rails/issues/46587,1465190461,I_kwDNIULOV1UIPQ,46587,rendering from templates do now allow you to override contextual details as expected,"{'login': 'virtualfunction', 'id': 14468, 'node_id': 'MDQ6VXNlcjE0NDY4', 'avatar_url': 'https://avatars.githubusercontent.com/u/14468?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/virtualfunction', 'html_url': 'https://github.com/virtualfunction', 'followers_url': 'https://api.github.com/users/virtualfunction/followers', 'following_url': 'https://api.github.com/users/virtualfunction/following{/other_user}', 'gists_url': 'https://api.github.com/users/virtualfunction/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/virtualfunction/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/virtualfunction/subscriptions', 'organizations_url': 'https://api.github.com/users/virtualfunction/orgs', 'repos_url': 'https://api.github.com/users/virtualfunction/repos', 'events_url': 'https://api.github.com/users/virtualfunction/events{/privacy}', 'received_events_url': 'https://api.github.com/users/virtualfunction/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2022-11-26T15:57:19Z,2023-02-28T00:52:48Z,,NONE,,,,"### Steps to reproduce

Rendering from a view doesn't allow you to override context defaults like the format. For instance, when rendering an HTML snippet from a template that was rendering JSON, such as below. 

```ruby
= render partial: 'item', formats: [ :html ] 
```

### Expected behaviour
This renders the HTML format of the template rather than the format inherited. 

### Actual behaviour
It renders the inherited format of the parent template (e.g. JSON)

### Potential cause

rendering_helper.rb needs to be updated to the following

```ruby
in_rendering_context(options) do |renderer|
  if block_given?
    renderer.render_partial(self, options.merge(partial: options[:layout]), &block)
  else
    renderer.render(self, options)
  end
end
```

Currently, it's ignoring the new context yielded from in_rendering_context and using the old view_renderer, which I think is wrong.

### System configuration
**Rails version**: 7.0.4

**Ruby version**: ruby 3.1.3p185 (2022-11-24 revision 1a6b16756e) [x86_64-linux-musl]
","{'url': 'https://api.github.com/repos/rails/rails/issues/46587/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46587/timeline,,
https://api.github.com/repos/rails/rails/issues/46564,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46564/labels{/name},https://api.github.com/repos/rails/rails/issues/46564/comments,https://api.github.com/repos/rails/rails/issues/46564/events,https://github.com/rails/rails/pull/46564,1462799406,PR_kwDNIULOQ54nww,46564,Allow binding a field to a different error message,"{'login': 'lazaronixon', 'id': 2651240, 'node_id': 'MDQ6VXNlcjI2NTEyNDA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2651240?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/lazaronixon', 'html_url': 'https://github.com/lazaronixon', 'followers_url': 'https://api.github.com/users/lazaronixon/followers', 'following_url': 'https://api.github.com/users/lazaronixon/following{/other_user}', 'gists_url': 'https://api.github.com/users/lazaronixon/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/lazaronixon/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/lazaronixon/subscriptions', 'organizations_url': 'https://api.github.com/users/lazaronixon/orgs', 'repos_url': 'https://api.github.com/users/lazaronixon/repos', 'events_url': 'https://api.github.com/users/lazaronixon/events{/privacy}', 'received_events_url': 'https://api.github.com/users/lazaronixon/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-11-24T05:53:59Z,2022-11-24T05:55:38Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46564', 'html_url': 'https://github.com/rails/rails/pull/46564', 'diff_url': 'https://github.com/rails/rails/pull/46564.diff', 'patch_url': 'https://github.com/rails/rails/pull/46564.patch', 'merged_at': None}","### Motivation / Background

This pull request adds a new option to form helpers called `error_key`, this way we can specify a different error key that will be evaluated by `field_error_proc`. It allows us for example to bind the error of a select to the association instead of the foreign_key.

```ruby
class Post < ActiveRecord::Base
  belongs_to :person, optional: false
end
```
```ruby
<%= f.collection_select :person_id, Author.all, :id, :name, error_key: ""person"" %>
```
```html
<div class=""field_with_errors""><select>...</select></div>
```

Fixes https://github.com/rails/rails/issues/28772
Fixes https://github.com/rails/rails/issues/44160

Previous PR: https://github.com/rails/rails/pull/46494","{'url': 'https://api.github.com/repos/rails/rails/issues/46564/reactions', 'total_count': 4, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46564/timeline,,
https://api.github.com/repos/rails/rails/issues/46555,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46555/labels{/name},https://api.github.com/repos/rails/rails/issues/46555/comments,https://api.github.com/repos/rails/rails/issues/46555/events,https://github.com/rails/rails/pull/46555,1460766957,PR_kwDNIULOQ4IfSw,46555,Small PR: Apply Rails backtrace cleaner to ActiveJob backtrace printout,"{'login': 'warrenbhw', 'id': 75187597, 'node_id': 'MDQ6VXNlcjc1MTg3NTk3', 'avatar_url': 'https://avatars.githubusercontent.com/u/75187597?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/warrenbhw', 'html_url': 'https://github.com/warrenbhw', 'followers_url': 'https://api.github.com/users/warrenbhw/followers', 'following_url': 'https://api.github.com/users/warrenbhw/following{/other_user}', 'gists_url': 'https://api.github.com/users/warrenbhw/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/warrenbhw/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/warrenbhw/subscriptions', 'organizations_url': 'https://api.github.com/users/warrenbhw/orgs', 'repos_url': 'https://api.github.com/users/warrenbhw/repos', 'events_url': 'https://api.github.com/users/warrenbhw/events{/privacy}', 'received_events_url': 'https://api.github.com/users/warrenbhw/received_events', 'type': 'User', 'site_admin': False}","[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,2,2022-11-23T00:45:44Z,2022-12-11T11:33:55Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46555', 'html_url': 'https://github.com/rails/rails/pull/46555', 'diff_url': 'https://github.com/rails/rails/pull/46555.diff', 'patch_url': 'https://github.com/rails/rails/pull/46555.patch', 'merged_at': None}","### Motivation / Background

ActiveJob produces a large amount of log noise, because errors that are emitted from ActiveJob don't have the standard Rails BacktraceCleaner applied. This is especially apparent when using Sorbet for Ruby types, since each application method call is wrapped by multiple Sorbet typechecking functions. My application's activejob error backtraces would typically log 4 non-relevant Sorbet function calls for each application function call. My workaround has been to monkey-patch Rails in our application. However, it seems to make sense to simply bring this behavior into ActiveJob as the default, as the backtrace cleaner is a pretty standard piece of Rails machinery that is used for most other backtraces in Rails.

### Additional information

When ActiveJob encounters an error performing a job, rather than printing the full unfiltered (and noisy) exception backtrace, print the cleaned backtrace using Rails's BacktraceCleaner.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46555/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46555/timeline,,
https://api.github.com/repos/rails/rails/issues/46524,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46524/labels{/name},https://api.github.com/repos/rails/rails/issues/46524/comments,https://api.github.com/repos/rails/rails/issues/46524/events,https://github.com/rails/rails/pull/46524,1455963889,PR_kwDNIULOQ0EdbQ,46524,Add ActiveRecord::Relation#increment_all and decrement_all,"{'login': 'shnikola', 'id': 815003, 'node_id': 'MDQ6VXNlcjgxNTAwMw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/815003?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shnikola', 'html_url': 'https://github.com/shnikola', 'followers_url': 'https://api.github.com/users/shnikola/followers', 'following_url': 'https://api.github.com/users/shnikola/following{/other_user}', 'gists_url': 'https://api.github.com/users/shnikola/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shnikola/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shnikola/subscriptions', 'organizations_url': 'https://api.github.com/users/shnikola/orgs', 'repos_url': 'https://api.github.com/users/shnikola/repos', 'events_url': 'https://api.github.com/users/shnikola/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shnikola/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-11-18T23:17:17Z,2022-11-21T12:19:23Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46524', 'html_url': 'https://github.com/rails/rails/pull/46524', 'diff_url': 'https://github.com/rails/rails/pull/46524.diff', 'patch_url': 'https://github.com/rails/rails/pull/46524.patch', 'merged_at': None}","### Motivation / Background

Say you want to update a numeric column on a subset of records. `update_all` is fine:
`Player.active.update_all(""score = score + 10"")`

But using update_all with user input is very unsafe:
`Player.active.update_all(""score = score + #{params[:extra]}"")`

A safe way to do it is to use `update_counters`:
`Player.active.update_counters(score: params[:extra])`

But the naming of that method is a bit weird. Were not updating these columns, were incrementing them. Also, these columns dont need to be counters, they can be any number column.

### Detail

This pull request adds `increment_all` and `decrement_all` methods, corresponding to the ActiveRecord instance `increment` and `decrement`. This allows us to write:

`Player.active.increment_all(:score, 10)`

the result of which is immediately clear.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46524/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46524/timeline,,
https://api.github.com/repos/rails/rails/issues/46521,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46521/labels{/name},https://api.github.com/repos/rails/rails/issues/46521/comments,https://api.github.com/repos/rails/rails/issues/46521/events,https://github.com/rails/rails/issues/46521,1455578808,I_kwDNIULOVsJeuA,46521,ActiveRecord column_defaults should not memoize callable defaults,"{'login': 'stanhu', 'id': 963826, 'node_id': 'MDQ6VXNlcjk2MzgyNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/963826?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/stanhu', 'html_url': 'https://github.com/stanhu', 'followers_url': 'https://api.github.com/users/stanhu/followers', 'following_url': 'https://api.github.com/users/stanhu/following{/other_user}', 'gists_url': 'https://api.github.com/users/stanhu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/stanhu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/stanhu/subscriptions', 'organizations_url': 'https://api.github.com/users/stanhu/orgs', 'repos_url': 'https://api.github.com/users/stanhu/repos', 'events_url': 'https://api.github.com/users/stanhu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/stanhu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2022-11-18T18:09:42Z,2023-05-24T13:34:17Z,,CONTRIBUTOR,,,,"### Steps to reproduce

This is somewhat related to https://github.com/rails/rails/issues/33031, which was fixed via https://github.com/rails/rails/pull/33925. Let's modify the test in that issue to this:

```ruby
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""
  gem ""activerecord""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")

ActiveRecord::Schema.define do
  create_table :widgets, force: true do |t|
    t.string :uuid
  end
end

class Widget < ActiveRecord::Base
  attribute :uuid, :string, default: -> { SecureRandom.uuid }
end

class CallableAttributeDefaultTest < Minitest::Test
  def test_callable_default
    first_default = Widget.column_defaults['uuid']
    second_default = Widget.column_defaults['uuid']

    refute_equal first_default, second_default
  end
end
```

### Expected behavior

Since `uuid` should be generated dynamically, I'd expect each attempt to retrieve the default for the `uuid` column to change with each invocation. 

This is important because gems such as `statemachines_activerecord` call `column_defaults`, which then causes every default procedure to execute. This can have unintended side effects (e.g. database queries, network calls, etc), especially if you only need the default for a single column.

### Actual behavior

Instead, it's memoized: https://github.com/rails/rails/blob/cf2be235771e562393727510ec58e060c18cadd2/activerecord/lib/active_record/model_schema.rb#L482-L490

https://github.com/rails/rails/pull/33925 worked around the issue by doing a deep copy, but I'd argue the correct fix would have been to lazily evaluate the procedure.

Perhaps we could change `AttributeSet` to `LazyAttributeSet`?

### System configuration

**Rails version**: 7.0.4

**Ruby version**: 2.7.5","{'url': 'https://api.github.com/repos/rails/rails/issues/46521/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46521/timeline,,
https://api.github.com/repos/rails/rails/issues/46517,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46517/labels{/name},https://api.github.com/repos/rails/rails/issues/46517/comments,https://api.github.com/repos/rails/rails/issues/46517/events,https://github.com/rails/rails/pull/46517,1454499533,PR_kwDNIULOQy0ZNA,46517,Add ActiveModel::Attributes#==.,"{'login': 'bonobono555', 'id': 29417697, 'node_id': 'MDQ6VXNlcjI5NDE3Njk3', 'avatar_url': 'https://avatars.githubusercontent.com/u/29417697?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bonobono555', 'html_url': 'https://github.com/bonobono555', 'followers_url': 'https://api.github.com/users/bonobono555/followers', 'following_url': 'https://api.github.com/users/bonobono555/following{/other_user}', 'gists_url': 'https://api.github.com/users/bonobono555/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bonobono555/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bonobono555/subscriptions', 'organizations_url': 'https://api.github.com/users/bonobono555/orgs', 'repos_url': 'https://api.github.com/users/bonobono555/repos', 'events_url': 'https://api.github.com/users/bonobono555/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bonobono555/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,1,2022-11-18T05:44:23Z,2022-11-21T22:20:09Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46517', 'html_url': 'https://github.com/rails/rails/pull/46517', 'diff_url': 'https://github.com/rails/rails/pull/46517.diff', 'patch_url': 'https://github.com/rails/rails/pull/46517.patch', 'merged_at': None}","### Motivation / Background

I want to be able to compare identity checks with == method. Because I want to compare attribute identities,
but currently I have to go through the attribute method.

### Detail

```ruby
# before
UserModel.new(id: 1) == UserModel.new(id: 1) # false

# after
UserModel.new(id: 1) == UserModel.new(id: 1) # true
```

### Additional information

I wanted to use AttributeSet#== for the comparison to avoid creating unnecessary objects, but since it does not return true if the value before type cast are different, I used Attributes#attributes instead.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46517/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46517/timeline,,
https://api.github.com/repos/rails/rails/issues/46514,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46514/labels{/name},https://api.github.com/repos/rails/rails/issues/46514/comments,https://api.github.com/repos/rails/rails/issues/46514/events,https://github.com/rails/rails/issues/46514,1452535503,I_kwDNIULOVpPuzw,46514,TextHelper highlight does sanitisation incorrectly,"{'login': 'viraptor', 'id': 188063, 'node_id': 'MDQ6VXNlcjE4ODA2Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/188063?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/viraptor', 'html_url': 'https://github.com/viraptor', 'followers_url': 'https://api.github.com/users/viraptor/followers', 'following_url': 'https://api.github.com/users/viraptor/following{/other_user}', 'gists_url': 'https://api.github.com/users/viraptor/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/viraptor/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/viraptor/subscriptions', 'organizations_url': 'https://api.github.com/users/viraptor/orgs', 'repos_url': 'https://api.github.com/users/viraptor/repos', 'events_url': 'https://api.github.com/users/viraptor/events{/privacy}', 'received_events_url': 'https://api.github.com/users/viraptor/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2022-11-17T01:13:28Z,2023-04-03T10:30:00Z,,NONE,,,,"### Steps to reproduce
```ruby
highlight(""xxx yyy & zzz"", ""a"")
```

### Expected behavior
Sanitisation is done on each matched / not matched part of the string separately. This results in:
```
""xxx yyy &amp; zzz""
```

### Actual behavior
The whole string is sanitised before the highlighting which results in:
```
""xxx yyy &<mark>a</mark>mp; zzz""
```

Instead of sanitising the whole string at once, `highlight` could do something like:

-    split the string into matching / not matching parts
-    escape each part separately
-    wrap the matching parts in `<mark>...</mark>`
-    join them and return with `.html_safe`


### System configuration
**Rails version**: 6+ (main is still affected)

**Ruby version**: any
","{'url': 'https://api.github.com/repos/rails/rails/issues/46514/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46514/timeline,,
https://api.github.com/repos/rails/rails/issues/46510,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46510/labels{/name},https://api.github.com/repos/rails/rails/issues/46510/comments,https://api.github.com/repos/rails/rails/issues/46510/events,https://github.com/rails/rails/pull/46510,1451645404,PR_kwDNIULOQwbnjw,46510,"Add ""attribute_for_pretty_print"" method","{'login': 'jordan-brough', 'id': 23050, 'node_id': 'MDQ6VXNlcjIzMDUw', 'avatar_url': 'https://avatars.githubusercontent.com/u/23050?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jordan-brough', 'html_url': 'https://github.com/jordan-brough', 'followers_url': 'https://api.github.com/users/jordan-brough/followers', 'following_url': 'https://api.github.com/users/jordan-brough/following{/other_user}', 'gists_url': 'https://api.github.com/users/jordan-brough/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jordan-brough/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jordan-brough/subscriptions', 'organizations_url': 'https://api.github.com/users/jordan-brough/orgs', 'repos_url': 'https://api.github.com/users/jordan-brough/repos', 'events_url': 'https://api.github.com/users/jordan-brough/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jordan-brough/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2022-11-16T13:51:13Z,2022-11-16T15:45:49Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46510', 'html_url': 'https://github.com/rails/rails/pull/46510', 'diff_url': 'https://github.com/rails/rails/pull/46510.diff', 'patch_url': 'https://github.com/rails/rails/pull/46510.patch', 'merged_at': None}","I think it'd be helpful to improve the output of records in a Rails console when some of the fields have very long values.

As of IRB version 1.3.1 (released in Jan 2021) records are pretty_printed in the console instead of inspected, so records with large values (e.g. the content of a document) look like this:
<img width=""962"" alt=""c3232d95be8437bd4805342285ea360ffa905c00"" src=""https://user-images.githubusercontent.com/23050/202197117-84b6a66a-3557-44f3-a6b2-70aaef64f99f.png"">
This makes it hard to navigate output in a console. Especially for arrays of items like this.

One option is to override `inspect` (or `attribute_for_inspect`), but then you lose the nice formatting of pretty-printing:
![0846069992b0ec3adf6f7f001da375344085e128](https://user-images.githubusercontent.com/23050/202197523-6577e9cf-c40f-4e0d-913f-e802add8a87b.jpeg)

I think it would be great to:

- Provide a better default for long strings
- Provide a method that can be overridden in applications for customizing the display of fields

Does that seem reasonable?  I can add tests if so.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46510/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46510/timeline,,
https://api.github.com/repos/rails/rails/issues/46509,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46509/labels{/name},https://api.github.com/repos/rails/rails/issues/46509/comments,https://api.github.com/repos/rails/rails/issues/46509/events,https://github.com/rails/rails/issues/46509,1451643704,I_kwDNIULOVoZTOA,46509,[BUG] Active Record `only_integer: true` validation doesn't always work with `accepts_nested_attributes_for`,"{'login': 'mrabets', 'id': 36799843, 'node_id': 'MDQ6VXNlcjM2Nzk5ODQz', 'avatar_url': 'https://avatars.githubusercontent.com/u/36799843?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mrabets', 'html_url': 'https://github.com/mrabets', 'followers_url': 'https://api.github.com/users/mrabets/followers', 'following_url': 'https://api.github.com/users/mrabets/following{/other_user}', 'gists_url': 'https://api.github.com/users/mrabets/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mrabets/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mrabets/subscriptions', 'organizations_url': 'https://api.github.com/users/mrabets/orgs', 'repos_url': 'https://api.github.com/users/mrabets/repos', 'events_url': 'https://api.github.com/users/mrabets/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mrabets/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,11,2022-11-16T13:50:11Z,2023-07-27T21:54:04Z,,NONE,,,,"### Steps to reproduce
**1. Create `Post` and `Comments` models with `has_many` association and `accepts_nested_attributes_for`**

`app/models/post.rb`
```
class Post < ApplicationRecord
  has_many :comments

  accepts_nested_attributes_for :comments
end
```
`app/models/comment.rb`
```
class Comment < ApplicationRecord
  belongs_to :post

  validates :likes_count, numericality: { only_integer: true  }
end
```

**2. Setup posts params for nested attributes in the controller**

`app/controllers/posts_controller.rb`
```
class PostsController < ApplicationController
  before_action :set_post, only: %i[ show edit update destroy ]

  def index
    @posts = Post.all
  end

  def show
  end

  def new
    @post = Post.new
    @post.comments.build
  end

  def edit
  end

  def create
    @post = Post.new(post_params)

    respond_to do |format|
      if @post.save
        format.html { redirect_to post_url(@post), notice: ""Post was successfully created."" }
        format.json { render :show, status: :created, location: @post }
      else
        format.html { render :new, status: :unprocessable_entity }
        format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end

  def update
    respond_to do |format|
      if @post.update(post_params)
        format.html { redirect_to post_url(@post), notice: ""Post was successfully updated."" }
        format.json { render :show, status: :ok, location: @post }
      else
        format.html { render :edit, status: :unprocessable_entity }
        format.json { render json: @post.errors, status: :unprocessable_entity }
      end
    end
  end

  private
    def set_post
      @post = Post.find(params[:id])
    end

    def post_params
      params
        .require(:post)
        .permit(:title,
                comments_attributes: [:id, :post_id, :likes_count])
    end
end

```

**3. Setup posts form**

`app/views/posts/_form.html.erb`
```
<%= form_with(model: @post) do |form| %>
  <% if post.errors.any? %>
    <div id=""error_explanation"">
      <h2><%= pluralize(post.errors.count, ""error"") %> prohibited this post from being saved:</h2>

      <ul>
        <% post.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class=""field"">
    <%= form.label :title %>
    <%= form.text_field :title %>
  </div>

  <div class=""nested_field"">
    <%= form.fields_for :comments do |comment_subform| %>
      <%= comment_subform.label :likes_count %>
      <%= comment_subform.text_field :likes_count %>
    <% end %>
  </div>

  <div class=""actions"">
    <%= form.submit %>
  </div>
<% end %>
```

**4. Create a post with `likes_count = 5`. Go to the edit page of this post and change `likes_count` to `5.1` (or any float number from `5.0` to `5.999...`)**

### Expected behavior
Should generates the error message: **""Must be integer""**

### Actual behavior
It doesn't generate the error message and it saves the record

### System configuration

Rails version: 7.0.4 (tried also with 6.1.5)

Ruby version: 2.7.6

### Video showing the bug

https://user-images.githubusercontent.com/36799843/202196709-13d04e96-483c-4faf-88b2-d4225133f319.mp4
","{'url': 'https://api.github.com/repos/rails/rails/issues/46509/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46509/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/46486,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46486/labels{/name},https://api.github.com/repos/rails/rails/issues/46486/comments,https://api.github.com/repos/rails/rails/issues/46486/events,https://github.com/rails/rails/pull/46486,1446667839,PR_kwDNIULOQsQTyg,46486,Preserve attachment changes when converting record to another class using STI,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-11-13T00:45:07Z,2022-11-13T00:45:10Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46486', 'html_url': 'https://github.com/rails/rails/pull/46486', 'diff_url': 'https://github.com/rails/rails/pull/46486.diff', 'patch_url': 'https://github.com/rails/rails/pull/46486.patch', 'merged_at': None}","Fixes #45778.

cc @rafaelfranca (as we had a discussion in discord)","{'url': 'https://api.github.com/repos/rails/rails/issues/46486/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46486/timeline,,
https://api.github.com/repos/rails/rails/issues/46483,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46483/labels{/name},https://api.github.com/repos/rails/rails/issues/46483/comments,https://api.github.com/repos/rails/rails/issues/46483/events,https://github.com/rails/rails/pull/46483,1446622649,PR_kwDNIULOQsN8CQ,46483,Consider methods defined on ancestors of a channel to be an action,"{'login': 'kyanagi', 'id': 181194, 'node_id': 'MDQ6VXNlcjE4MTE5NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/181194?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kyanagi', 'html_url': 'https://github.com/kyanagi', 'followers_url': 'https://api.github.com/users/kyanagi/followers', 'following_url': 'https://api.github.com/users/kyanagi/following{/other_user}', 'gists_url': 'https://api.github.com/users/kyanagi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kyanagi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kyanagi/subscriptions', 'organizations_url': 'https://api.github.com/users/kyanagi/orgs', 'repos_url': 'https://api.github.com/users/kyanagi/repos', 'events_url': 'https://api.github.com/users/kyanagi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kyanagi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,1,2022-11-12T22:05:20Z,2022-11-15T06:05:39Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46483', 'html_url': 'https://github.com/rails/rails/pull/46483', 'diff_url': 'https://github.com/rails/rails/pull/46483.diff', 'patch_url': 'https://github.com/rails/rails/pull/46483.patch', 'merged_at': None}","### Motivation / Background

A channel has actions corresponding to methods defined on its class.

```ruby
# FooChannel has an action ""appear"".
class FooChannel < ApplicationCable::Channel
  def appear(data)
    # ...
  end
end
```

Inheritance works.

```ruby
# BarChannel also has an action ""appear"".
class BarChannel < FooChannel
end
```

But in the following case, BarChannel does not respond to an action ""display"" although FooChannel does.

```ruby
# FooChannel has an action ""display"".
class FooChannel < ApplicationCable::Channel
  def display(data)
    # ...
  end
end

# BarChannel does not have an action ""display"".
class BarChannel < FooChannel
end
```

This Pull Request fixes this problem.

### Detail

`ActionCable::Channel::Base.action_methods` which determines the action names of a channel is implemented as follows.

```ruby
def action_methods
  @action_methods ||= begin
    # All public instance methods of this class, including ancestors
    methods = (public_instance_methods(true) -
      # Except for public instance methods of Base and its ancestors
      ActionCable::Channel::Base.public_instance_methods(true) +
      # Be sure to include shadowed public instance methods of this class
      public_instance_methods(false)).uniq.map(&:to_s)
    methods.to_set
  end
end
```

`ActionCable::Channel::Base` has `display` method. (Yes, there is `Object#display`!)
So the action `display` is removed unless the channel itself has the method.
I am not sure if it is intentional that only the class itself (not including ancestors) is allowed.
But I think it would be better to be fixed.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [ ] CI is passing.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46483/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46483/timeline,,
https://api.github.com/repos/rails/rails/issues/46438,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46438/labels{/name},https://api.github.com/repos/rails/rails/issues/46438/comments,https://api.github.com/repos/rails/rails/issues/46438/events,https://github.com/rails/rails/pull/46438,1438985106,PR_kwDNIULOQlvogg,46438,Fix an issue where changes will disappear.,"{'login': 'malomalo', 'id': 716, 'node_id': 'MDQ6VXNlcjcxNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/716?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/malomalo', 'html_url': 'https://github.com/malomalo', 'followers_url': 'https://api.github.com/users/malomalo/followers', 'following_url': 'https://api.github.com/users/malomalo/following{/other_user}', 'gists_url': 'https://api.github.com/users/malomalo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/malomalo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/malomalo/subscriptions', 'organizations_url': 'https://api.github.com/users/malomalo/orgs', 'repos_url': 'https://api.github.com/users/malomalo/repos', 'events_url': 'https://api.github.com/users/malomalo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/malomalo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2022-11-07T21:07:28Z,2023-07-21T16:45:41Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46438', 'html_url': 'https://github.com/rails/rails/pull/46438', 'diff_url': 'https://github.com/rails/rails/pull/46438.diff', 'patch_url': 'https://github.com/rails/rails/pull/46438.patch', 'merged_at': None}","### Motivation / Background

When `autosave: true` is set on both ends of a relation `save` and/or `valid?` can be called more than once removing the changes that just happened during the current `save` and making `previous_changes` and empty hash.

### Detail

This PR adds an instance variable on Connection to ensure that each record only gets `save` and/or `valid?` called once while traversing the autosave tree, ensuring the changes are available after saving via the `previous_changes` method.

Fixes #28491.

#28491 suggested adding a variable to avoid clearing the changes on the root record which worked; but would not fix the issue if the two models with the autosave true are related to another separate model that is being saved or updated.

### Checklist

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [ ] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [ ] CI is passing.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46438/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 1, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46438/timeline,,
https://api.github.com/repos/rails/rails/issues/46434,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46434/labels{/name},https://api.github.com/repos/rails/rails/issues/46434/comments,https://api.github.com/repos/rails/rails/issues/46434/events,https://github.com/rails/rails/pull/46434,1437975646,PR_kwDNIULOQk5k6w,46434,rake db:migrate:status emits an exit status of 2 when migrations are required,"{'login': 'gee-forr', 'id': 345730, 'node_id': 'MDQ6VXNlcjM0NTczMA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/345730?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/gee-forr', 'html_url': 'https://github.com/gee-forr', 'followers_url': 'https://api.github.com/users/gee-forr/followers', 'following_url': 'https://api.github.com/users/gee-forr/following{/other_user}', 'gists_url': 'https://api.github.com/users/gee-forr/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/gee-forr/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/gee-forr/subscriptions', 'organizations_url': 'https://api.github.com/users/gee-forr/orgs', 'repos_url': 'https://api.github.com/users/gee-forr/repos', 'events_url': 'https://api.github.com/users/gee-forr/events{/privacy}', 'received_events_url': 'https://api.github.com/users/gee-forr/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,6,2022-11-07T08:41:28Z,2023-01-10T07:03:04Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46434', 'html_url': 'https://github.com/rails/rails/pull/46434', 'diff_url': 'https://github.com/rails/rails/pull/46434.diff', 'patch_url': 'https://github.com/rails/rails/pull/46434.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because previously during deployments I would need to write a hairy grep on the output of `rails db:migrate:status` to determine if I needed to run a migration. I've taken inspiration from `bundle check` which outputs a status code of `1` if a `bundle install` is required.

Now, when running a `rails db:migrate:status`, people can check the exit status, and make a decision to migrate or not based on that value.

### Detail

This Pull Request changes the rake task `db:migrate:status` found in `activerecord/lib/active_record/tasks/database_tasks.rb`

Now, as part of rendering the list of migrations, it checks if any migrations are needed. If so, it will exit with a status code of `2`. No migrations required will exit as normal with a status code of `0`. There is an abort check before the task runs which will exit with a status code of `1`, which is why I elected to use `2`.

### Additional information

Here's how I was checking for outstanding migrations previously with Ansible:

```yaml
---
- block:
  - name: Check for outstanding migrations
    ansible.builtin.shell:
      cmd:   bundle exec rails db:migrate:status  | grep --perl-regex ""^\s+down\s+\d+""
    register:     migration_status
    changed_when: migration_status.rc == 0
    failed_when:  migration_status.rc > 1

  - name: Run any outstanding migrations
    ansible.builtin.shell:
      cmd:   bundle exec rails db:migrate
    when: migration_status.changed
```

This can now be simplified to:

```yaml
---
- block:
  - name: Check for outstanding migrations
    ansible.builtin.shell:
      cmd:   bundle exec rails db:migrate:status
    register:     migration_status
    changed_when: migration_status.rc == 2
# 8< snip other tasks
```

### Checklist

I could not find the documentation for this, and I'm not sure if this requires a CHANGELOG entry. Please let me know and I'll update.

Please also let me know if I must backport these changes to 6.1.x and 6.0.x?

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [X] CI is passing. (unrelated tests are failing, i.e. mysql connection pools, and another suite is being killed after the 30 mins runtime timeout)

","{'url': 'https://api.github.com/repos/rails/rails/issues/46434/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46434/timeline,,
https://api.github.com/repos/rails/rails/issues/46423,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46423/labels{/name},https://api.github.com/repos/rails/rails/issues/46423/comments,https://api.github.com/repos/rails/rails/issues/46423/events,https://github.com/rails/rails/issues/46423,1436532990,I_kwDNIULOVZ_A_g,46423,Collection association callbacks are not fired when set via inverse,"{'login': 'agrobbin', 'id': 46724, 'node_id': 'MDQ6VXNlcjQ2NzI0', 'avatar_url': 'https://avatars.githubusercontent.com/u/46724?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/agrobbin', 'html_url': 'https://github.com/agrobbin', 'followers_url': 'https://api.github.com/users/agrobbin/followers', 'following_url': 'https://api.github.com/users/agrobbin/following{/other_user}', 'gists_url': 'https://api.github.com/users/agrobbin/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/agrobbin/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/agrobbin/subscriptions', 'organizations_url': 'https://api.github.com/users/agrobbin/orgs', 'repos_url': 'https://api.github.com/users/agrobbin/repos', 'events_url': 'https://api.github.com/users/agrobbin/events{/privacy}', 'received_events_url': 'https://api.github.com/users/agrobbin/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-11-04T19:16:05Z,2023-08-06T18:15:28Z,,CONTRIBUTOR,,,,"### Steps to reproduce

When running the below test case, `test_has_many_after_add_via_inverse` fails. @gmcgibbon as I mentioned in https://github.com/rails/rails/pull/37413#issuecomment-1302495483, and as you seemed to agree with in https://github.com/rails/rails/pull/37413#issuecomment-1302756776, these 2 seemingly identical scenarios do not result in the same behavior.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :bars, force: true

  create_table :foos, force: true do |t|
    t.belongs_to :bar, null: false
  end
end

class Foo < ActiveRecord::Base
  belongs_to :bar
end

class Bar < ActiveRecord::Base
  has_many :foos, inverse_of: :bar, after_add: :increment_callback_count

  attr_accessor :callback_count

  def increment_callback_count(*)
    self.callback_count ||= 0
    self.callback_count += 1
  end
end

class BugTest < ActiveSupport::TestCase
  include ActiveRecord::TestFixtures

  self.use_transactional_tests = true

  def test_has_many_after_add
    bar = Bar.new

    bar.foos.build

    assert_equal 1, bar.callback_count
  end

  def test_has_many_after_add_via_inverse
    foo = Foo.new

    foo.build_bar

    assert_equal 1, foo.bar.callback_count
  end
end
```

#37413 turned this off, and I believe it actually should fire in at least this scenario.

### Expected behavior

When building an associated record via a `belongs_to` association, the related `has_many` association with callbacks should have its callbacks invoked.

### Actual behavior

Any `has_many` callbacks are not invoked.

### System configuration
**Rails version**: 7.0.4

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46423/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46423/timeline,,
https://api.github.com/repos/rails/rails/issues/46419,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46419/labels{/name},https://api.github.com/repos/rails/rails/issues/46419/comments,https://api.github.com/repos/rails/rails/issues/46419/events,https://github.com/rails/rails/issues/46419,1435870107,I_kwDNIULOVZWjmw,46419,ActiveJob's retry behavior is not consistent,"{'login': 'shouichi', 'id': 99586, 'node_id': 'MDQ6VXNlcjk5NTg2', 'avatar_url': 'https://avatars.githubusercontent.com/u/99586?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shouichi', 'html_url': 'https://github.com/shouichi', 'followers_url': 'https://api.github.com/users/shouichi/followers', 'following_url': 'https://api.github.com/users/shouichi/following{/other_user}', 'gists_url': 'https://api.github.com/users/shouichi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shouichi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shouichi/subscriptions', 'organizations_url': 'https://api.github.com/users/shouichi/orgs', 'repos_url': 'https://api.github.com/users/shouichi/repos', 'events_url': 'https://api.github.com/users/shouichi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shouichi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2022-11-04T10:37:42Z,2023-07-25T22:51:14Z,,CONTRIBUTOR,,,,"### Steps to reproduce

Run a job with retry attempt 1. The won't be retried.

```ruby
class FooJob < ApplicationJob
  class FooError < StandardError; end

  retry_on FooError, attempts: 1

  def perform
    raise FooError
  end
end
```

### Expected behavior

ActiveJob should retry at most the number of times specified by the attempts option.

### Actual behavior

`attempts: 0`: runs once, no retry
`attempts: 1`: runs once, no retry
`attempts: 2`: runs once, one retry
`attempts: 3`: runs once, two retries

The behavior is not consistent. We can either change the behavior to be consistent (won't happen?) or at least document it very clearly.

https://github.com/rails/rails/issues/33816 also pointed out the problem.

### System configuration
**Rails version**: Rails 7.0.4

**Ruby version**: ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-linux]
","{'url': 'https://api.github.com/repos/rails/rails/issues/46419/reactions', 'total_count': 5, '+1': 5, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46419/timeline,,
https://api.github.com/repos/rails/rails/issues/46412,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46412/labels{/name},https://api.github.com/repos/rails/rails/issues/46412/comments,https://api.github.com/repos/rails/rails/issues/46412/events,https://github.com/rails/rails/issues/46412,1434373643,I_kwDNIULOVX7OCw,46412,main_app.posts_url doesn't include options from constraints,"{'login': 'balvig', 'id': 104138, 'node_id': 'MDQ6VXNlcjEwNDEzOA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/104138?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/balvig', 'html_url': 'https://github.com/balvig', 'followers_url': 'https://api.github.com/users/balvig/followers', 'following_url': 'https://api.github.com/users/balvig/following{/other_user}', 'gists_url': 'https://api.github.com/users/balvig/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/balvig/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/balvig/subscriptions', 'organizations_url': 'https://api.github.com/users/balvig/orgs', 'repos_url': 'https://api.github.com/users/balvig/repos', 'events_url': 'https://api.github.com/users/balvig/events{/privacy}', 'received_events_url': 'https://api.github.com/users/balvig/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,1,2022-11-03T09:47:14Z,2023-03-03T03:43:56Z,,NONE,,,,"### Steps to reproduce

Create route with constraints:

```rb
Rails.application.routes.draw do
  constraints host: ""admin"" do
    resources :posts
  end
end
```

Start console with `bin/rails c` and compare output:

### Expected behavior

```rb
app.posts_url #=> ""http://admin/posts""
app.main_app.posts_url #=> ""http://admin/posts""
```

### Actual behavior

```rb
app.posts_url #=> ""http://admin/posts""
app.main_app.posts_url #=> ""http://www.example.com/posts""
```

### System configuration
**Rails version**: 7.0.4

**Ruby version**: 3.0.0p0

### Anything else

- [Dummy app with failing test case here](https://github.com/balvig/routes_with_host/commit/69ae21b154e610858f94445c7fd9ddaf2b965c0d).
- Possibly related issues:
  - https://github.com/rails/rails/issues/34252
  - https://github.com/thredded/thredded/issues/778","{'url': 'https://api.github.com/repos/rails/rails/issues/46412/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46412/timeline,,
https://api.github.com/repos/rails/rails/issues/46409,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46409/labels{/name},https://api.github.com/repos/rails/rails/issues/46409/comments,https://api.github.com/repos/rails/rails/issues/46409/events,https://github.com/rails/rails/pull/46409,1433456519,PR_kwDNIULOQhLfZw,46409,TypeMap (PG): Store Typemap in Schema Cache and use another cache class to keep it in memory,"{'login': 'mochnatiy', 'id': 843601, 'node_id': 'MDQ6VXNlcjg0MzYwMQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/843601?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mochnatiy', 'html_url': 'https://github.com/mochnatiy', 'followers_url': 'https://api.github.com/users/mochnatiy/followers', 'following_url': 'https://api.github.com/users/mochnatiy/following{/other_user}', 'gists_url': 'https://api.github.com/users/mochnatiy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mochnatiy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mochnatiy/subscriptions', 'organizations_url': 'https://api.github.com/users/mochnatiy/orgs', 'repos_url': 'https://api.github.com/users/mochnatiy/repos', 'events_url': 'https://api.github.com/users/mochnatiy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mochnatiy/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,7,2022-11-02T16:37:35Z,2023-07-21T10:18:37Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46409', 'html_url': 'https://github.com/rails/rails/pull/46409', 'diff_url': 'https://github.com/rails/rails/pull/46409.diff', 'patch_url': 'https://github.com/rails/rails/pull/46409.patch', 'merged_at': None}","### Motivation / Background

This pull request is a rework of the other one after some feedbacks : https://github.com/rails/rails/pull/44478

In our project, we are using PG and Resque.
Right now, for every Resque job processed and new connection spawned, we are executing this method in Rails that run a costly query :

```ruby
def load_additional_types(oids = nil)
  initializer = OID::TypeMapInitializer.new(type_map)

  query = <<~SQL
    SELECT t.oid, t.typname, t.typelem, t.typdelim, t.typinput, r.rngsubtype, t.typtype, t.typbasetype
    FROM pg_type as t
    LEFT JOIN pg_range as r ON oid = rngtypid
  SQL
     
  if oids
    query += ""WHERE t.oid IN (%s)"" % oids.join("", "")
  else
    query += initializer.query_conditions_for_initial_load
  end
      
  execute_and_clear(query, ""SCHEMA"", []) do |records|
    initializer.run(records)
  end
end
```

To fix this issue we have done a monkey patch, basically, the `ConnectionPool` stores a cache of the type_map, and a new connection will inherit from this cache, instead of querying it.

```ruby
module ActiveRecord
  module ConnectionAdapters
    class PoolManager
      attr_accessor :type_map
    end
  end

  class ConnectionAdapters::ConnectionPool
    def adopt_connection(conn)
      ....
      pool_manager = ConnectionAdapters::ConnectionPool.get_pool_manager

      pool_manager.type_map ||= conn.type_map
      ....
    end
  end

  class ConnectionAdapters::PostgreSQLAdapter
    attr_reader :type_map

    def initialize(connection, logger, connection_parameters, config)
      ....

      pool_manager = ConnectionAdapters::ConnectionPool.get_pool_manager
      type_map = pool_manager.type_map

      if type_map
        @type_map = type_map
      else
        @type_map = Type::HashLookupTypeMap.new
        initialize_type_map
      end
 
      ....
    end
  end
end
```

It also makes every Rails upgrade as complicated on our side.

In order not to have monkey patches we want to solve it on a Rails side which could be useful for other developers too.

First of all, we have dug in relevant PRs done in Rails and took some ideas.
The solutions to deal with issues maybe:

    - Store TypeMap into SchemaCache (relevant for PG only)
    - Switch off TypeMap if there is no usage of PG custom types
    - Introduce the monkey patch as the solution for Rails

We have selected the first one and would like to have feedback from Rails maintainers and complete this topic.
If there is something we have missed we are also ready to fix it shortly.

Base PRs for this PR:

#35311
https://github.com/rails/rails/pull/39821/files
https://github.com/rails/rails/pull/39077/files
https://github.com/rails/rails/pull/41288/files

I would like to tag also @piecehealth and @ted-hanson

### Detail

Currently in this PR we have TypeMap as a singleton (after trying to implement it as an instance variable we had issues with concurrency and now we have it as a single example in memory).

The general approach is to keep the TypeMap in the schema cache, and load from the `schema_cache.yml` when create a new connection. If TypeMap is not present in schema cache, it will be retrieved from the database.

The idea is still the same. During deploy, we run migrations and create a dump of schema cache. When initializing a Rails app, we load schema cache into a memory and initialize our `TypeMapCache` instance. Then we don't fire any query and retrieve Typemap from this cache when establish a new connection.

### Additional information

Unfortunately, it does not work with `lazily_load_schema_cache` option enabled since we load schema cache lazily after creating a connection.

### Checklist

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [ ] CI is passing.","{'url': 'https://api.github.com/repos/rails/rails/issues/46409/reactions', 'total_count': 5, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 5, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46409/timeline,,
https://api.github.com/repos/rails/rails/issues/46383,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46383/labels{/name},https://api.github.com/repos/rails/rails/issues/46383/comments,https://api.github.com/repos/rails/rails/issues/46383/events,https://github.com/rails/rails/pull/46383,1428508838,PR_kwDNIULOQdCJzQ,46383,Ensure `reload` sets correct owner for each association (ActiveRecord::Persistence),"{'login': 'dmytro-savochkin', 'id': 1823525, 'node_id': 'MDQ6VXNlcjE4MjM1MjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1823525?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dmytro-savochkin', 'html_url': 'https://github.com/dmytro-savochkin', 'followers_url': 'https://api.github.com/users/dmytro-savochkin/followers', 'following_url': 'https://api.github.com/users/dmytro-savochkin/following{/other_user}', 'gists_url': 'https://api.github.com/users/dmytro-savochkin/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dmytro-savochkin/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dmytro-savochkin/subscriptions', 'organizations_url': 'https://api.github.com/users/dmytro-savochkin/orgs', 'repos_url': 'https://api.github.com/users/dmytro-savochkin/repos', 'events_url': 'https://api.github.com/users/dmytro-savochkin/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dmytro-savochkin/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2022-10-29T23:48:31Z,2022-12-24T12:04:43Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46383', 'html_url': 'https://github.com/rails/rails/pull/46383', 'diff_url': 'https://github.com/rails/rails/pull/46383.diff', 'patch_url': 'https://github.com/rails/rails/pull/46383.patch', 'merged_at': None}","### Motivation / Background

Fixes #46363 which was caused by https://github.com/rails/rails/pull/41112

Currently calling `reload` re-calculates the association cache based on the object freshly loaded from the database. The fresh object gets assigned as `owner` for each association in the association cache. That object however is not the same as `self` (even though they both point to the same record). Under some specific circumstances (using `has_one/has_many through` associations and transactions with `after_commit` callbacks) this might lead to losing the effects of assignments done inside the callback.

This commit fixes it by making `reload` point to `self` as `owner` for each association in the association cache.

I think this is safe because as far as I can see in https://github.com/rails/rails/blob/main/activerecord/lib/active_record/associations.rb#L304 it always passes `self` when creating a new association.

I've added a test case as a separate file because I want to have models defined inside a test case (as I wrote in the comment) and there is no better place for it then other than creating a separate file.

### Detail

This Pull Request changes `ActiveRecord::Persistence#reload` method.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46383/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46383/timeline,,
https://api.github.com/repos/rails/rails/issues/46378,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46378/labels{/name},https://api.github.com/repos/rails/rails/issues/46378/comments,https://api.github.com/repos/rails/rails/issues/46378/events,https://github.com/rails/rails/pull/46378,1428380054,PR_kwDNIULOQc7UCw,46378,Add link to external editor to rescue view,"{'login': 'pedz', 'id': 76111, 'node_id': 'MDQ6VXNlcjc2MTEx', 'avatar_url': 'https://avatars.githubusercontent.com/u/76111?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pedz', 'html_url': 'https://github.com/pedz', 'followers_url': 'https://api.github.com/users/pedz/followers', 'following_url': 'https://api.github.com/users/pedz/following{/other_user}', 'gists_url': 'https://api.github.com/users/pedz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pedz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pedz/subscriptions', 'organizations_url': 'https://api.github.com/users/pedz/orgs', 'repos_url': 'https://api.github.com/users/pedz/repos', 'events_url': 'https://api.github.com/users/pedz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pedz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-29T17:50:08Z,2022-10-29T17:50:11Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46378', 'html_url': 'https://github.com/rails/rails/pull/46378', 'diff_url': 'https://github.com/rails/rails/pull/46378.diff', 'patch_url': 'https://github.com/rails/rails/pull/46378.patch', 'merged_at': None}","This is a somewhat trivial diff.  Currently, when an exception is thrown, a page is rendered and part of the page has the paths and line numbers from the exception stack.  The lines are clickable and when clicked, the upper section changes to show more context of the line in the original source code.

The proposed change is to add an additional link whose text is the Unicode link symbol after the existing link.  The more common glyph was rejected by Unicode.

The href for the link symbol comes from Ruby code that first checks, at render time, to see if ActionDispatch::DebugView#ext_editor is defined.  If it is, it is called passing the ""frame"".  Otherwise, ActionDispatch::DebugView#int_editor is called.

int_editor creates a URL using the `file:` scheme.  While most browsers won't follow the link, it will show to the developer what is possible.  My example of ext_editor creates a URL using the `emacs:` scheme.

I've added a tool tip to try and tell the developers how they can configure the URL to invoke their favorite editor.

I thought the approach of checking to see if a method is defined and calling it would be preferred to having the user redefine the definition of an existing method.

Another piece of work to do would be to add something like the sample I have to the templates so that config/initializers/debug_view.rb would be created when the Rails app is created.

Having both links, the currently existing link that shows the code snippets and the new link that opens the file in the external editor, gives the users the best of both worlds.  They can view in the browser what happened and then click to get them placed in their favorite editor at the line number for the issue.

The key here is ""their favorite editor"" can be customized to their liking via the ext_editor method.

### Motivation / Background

This Pull Request has been created because adding a link to the exception rescue page to the files and lines that are in the exception stack will help the developer edit the area that caused the fault.

### Detail

This Pull Request changes:
M	actionpack/lib/action_dispatch.rb
M	actionpack/lib/action_dispatch/middleware/debug_view.rb
M	actionpack/lib/action_dispatch/middleware/templates/rescues/_trace.html.erb
A     actionpack/lib/action_dispatch/locale/en.yml

### Additional information

My example for what a developer can add to config/initializers/debug_view.rb:
```ruby
# frozen_string_literal: true

module ActionDispatch
  class DebugView < ActionView::Base # :nodoc:
    def ext_editor(frame)
      frame[:trace].sub(/([^:]+):([0-9]+)(:.*)?/, 'emacs:///Users/pedz/Source/hatred/\\1#\\2')
    end
  end
end
```
","{'url': 'https://api.github.com/repos/rails/rails/issues/46378/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46378/timeline,,
https://api.github.com/repos/rails/rails/issues/46376,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46376/labels{/name},https://api.github.com/repos/rails/rails/issues/46376/comments,https://api.github.com/repos/rails/rails/issues/46376/events,https://github.com/rails/rails/pull/46376,1428166082,PR_kwDNIULOQcwQ6Q,46376,Define a predicate method for boolean attributes,"{'login': 'cpjmcquillan', 'id': 25187547, 'node_id': 'MDQ6VXNlcjI1MTg3NTQ3', 'avatar_url': 'https://avatars.githubusercontent.com/u/25187547?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/cpjmcquillan', 'html_url': 'https://github.com/cpjmcquillan', 'followers_url': 'https://api.github.com/users/cpjmcquillan/followers', 'following_url': 'https://api.github.com/users/cpjmcquillan/following{/other_user}', 'gists_url': 'https://api.github.com/users/cpjmcquillan/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/cpjmcquillan/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/cpjmcquillan/subscriptions', 'organizations_url': 'https://api.github.com/users/cpjmcquillan/orgs', 'repos_url': 'https://api.github.com/users/cpjmcquillan/repos', 'events_url': 'https://api.github.com/users/cpjmcquillan/events{/privacy}', 'received_events_url': 'https://api.github.com/users/cpjmcquillan/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,"{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}]",,4,2022-10-29T09:04:31Z,2023-02-28T21:59:36Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46376', 'html_url': 'https://github.com/rails/rails/pull/46376', 'diff_url': 'https://github.com/rails/rails/pull/46376.diff', 'patch_url': 'https://github.com/rails/rails/pull/46376.patch', 'merged_at': None}","<!--
Thanks for contributing to Rails!

Please do not make *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.

Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

The `ActiveModel::Attributes` API allows us to define different types of attributes.

It handles type casting, default values, and defines read/write methods.

Typically when defining a boolean attribute, you will often define the respective predicate method.

For example:

```ruby
class Person
  include ActiveModel::Attributes

  attribute :loves_rails, :boolean

  def loves_rails?
    !!loves_rails
  end
end

person = Person.new

person.loves_rails  # => nil
person.loves_rails? # => false

person.loves_rails = true

person.loves_rails? # => true
```

This Pull Request has been created because it would be useful for boolean 
attributes to automatically have its respective predicate method defined.

### Detail

This Pull Request changes the `attribute` method in `ActiveModel::AttributeRegistration`, 
so that it defines `attribute?` methods for attributes with a boolean type.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46376/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46376/timeline,,
https://api.github.com/repos/rails/rails/issues/46363,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46363/labels{/name},https://api.github.com/repos/rails/rails/issues/46363/comments,https://api.github.com/repos/rails/rails/issues/46363/events,https://github.com/rails/rails/issues/46363,1426165806,I_kwDNIULOVQGQLg,46363,"Loss of state after `reload`, transaction, and after_save_commit callback (regression in ActiveRecord 7.0)","{'login': 'dmytro-savochkin', 'id': 1823525, 'node_id': 'MDQ6VXNlcjE4MjM1MjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1823525?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dmytro-savochkin', 'html_url': 'https://github.com/dmytro-savochkin', 'followers_url': 'https://api.github.com/users/dmytro-savochkin/followers', 'following_url': 'https://api.github.com/users/dmytro-savochkin/following{/other_user}', 'gists_url': 'https://api.github.com/users/dmytro-savochkin/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dmytro-savochkin/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dmytro-savochkin/subscriptions', 'organizations_url': 'https://api.github.com/users/dmytro-savochkin/orgs', 'repos_url': 'https://api.github.com/users/dmytro-savochkin/repos', 'events_url': 'https://api.github.com/users/dmytro-savochkin/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dmytro-savochkin/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2022-10-27T19:27:54Z,2023-03-03T04:00:14Z,,NONE,,,,"During an upgrade of an existing application from Rails 6.1 to 7.0 I stumbled upon a fail in our specs. Initially I noticed the problem because it caused rspec's mock to lose its stub on the record. However, it's not specific to rspec and mocks: the code below shows an example where `record` loses the change made to its `name` inside of a second `after_save_commit` callback. This only happens under several pretty specific conditions including 
a) usage of `reload`, 
b) then a `transaction` 
c) with an update of a has_one/has_many `through` association.

I managed to find that this regression happens after the changes in this commit: https://github.com/rails/rails/commit/3328cd1d69129c7e3a14661d8a0f4b76009ec9b0
In particular this line causes the problem: https://github.com/rails/rails/blob/3328cd1d69129c7e3a14661d8a0f4b76009ec9b0/activerecord/lib/active_record/persistence.rb#L838

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""
  gem ""activerecord"", ""7.0.4""
  gem ""sqlite3"", ""1.5.3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :articles, force: true
  create_table :reviews, force: true do |t|
    t.integer ""desired_article_id""
    t.string ""name""
  end
  create_table :article_reviews, force: true do |t|
    t.integer  ""review_id""
    t.integer  ""article_id""
  end
end

class Review < ActiveRecord::Base
  belongs_to :desired_article, class_name: ""Article"", inverse_of: :review
  has_many :article_reviews
  has_many :articles, through: :article_reviews

  after_initialize do
    self.desired_article = build_desired_article
  end

  after_save_commit :touch_name
  def touch_name
    self.name += ' (touched)'
  end
end

class Article < ActiveRecord::Base
  has_one :review, foreign_key: :desired_article_id, inverse_of: :desired_article
  has_many :article_reviews
end

class ArticleReview < ActiveRecord::Base
  belongs_to :article, required: true
  belongs_to :review, required: true
end

class BugTest < Minitest::Test
  def test_reload_transaction_association
    record = Review.create!(name: 'Some Review Name')
    assert_equal 'Some Review Name (touched)', record.name
    record.reload
    assert_equal 'Some Review Name', record.name
    record.transaction do
      record.articles = [record.build_desired_article]
      record.save!
    end
    assert_equal 'Some Review Name (touched)', record.name # <= this assertion fails
  end
end
```

### Expected behavior
<!-- Tell us what should happen -->

Both assert_equal calls should pass (as they do with ActiveRecord 6.1.7). Below is the result of running the script if I replace `gem ""activerecord"", ""7.0.4""` with `gem ""activerecord"", ""6.1.7""`.

```ruby
D, [2022-10-29T23:13:45.401247 #45166] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2022-10-29T23:13:45.401383 #45166] DEBUG -- :   Article Create (0.1ms)  INSERT INTO ""articles"" DEFAULT VALUES
D, [2022-10-29T23:13:45.401816 #45166] DEBUG -- :   Review Create (0.0ms)  INSERT INTO ""reviews"" (""desired_article_id"", ""name"") VALUES (?, ?)  [[""desired_article_id"", 1], [""name"", ""Some Review Name""]]
D, [2022-10-29T23:13:45.402067 #45166] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
D, [2022-10-29T23:13:45.402561 #45166] DEBUG -- :   Review Load (0.1ms)  SELECT ""reviews"".* FROM ""reviews"" WHERE ""reviews"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
D, [2022-10-29T23:13:45.407101 #45166] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2022-10-29T23:13:45.409435 #45166] DEBUG -- :   Article Load (0.1ms)  SELECT ""articles"".* FROM ""articles"" INNER JOIN ""article_reviews"" ON ""articles"".""id"" = ""article_reviews"".""article_id"" WHERE ""article_reviews"".""review_id"" = ?  [[""review_id"", 1]]
D, [2022-10-29T23:13:45.409797 #45166] DEBUG -- :   Article Create (0.0ms)  INSERT INTO ""articles"" DEFAULT VALUES
D, [2022-10-29T23:13:45.410226 #45166] DEBUG -- :   Review Update (0.0ms)  UPDATE ""reviews"" SET ""desired_article_id"" = ? WHERE ""reviews"".""id"" = ?  [[""desired_article_id"", 2], [""id"", 1]]
D, [2022-10-29T23:13:45.412718 #45166] DEBUG -- :   ArticleReview Create (0.0ms)  INSERT INTO ""article_reviews"" (""review_id"", ""article_id"") VALUES (?, ?)  [[""review_id"", 1], [""article_id"", 2]]
D, [2022-10-29T23:13:45.412999 #45166] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
.

Finished in 0.020931s, 47.7760 runs/s, 143.3281 assertions/s.

1 runs, 3 assertions, 0 failures, 0 errors, 0 skips
```

### Actual behavior
<!-- Tell us what happens instead -->

```ruby
D, [2022-10-29T23:15:04.871483 #45405] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2022-10-29T23:15:04.871593 #45405] DEBUG -- :   Article Create (0.1ms)  INSERT INTO ""articles"" DEFAULT VALUES
D, [2022-10-29T23:15:04.872151 #45405] DEBUG -- :   Review Create (0.1ms)  INSERT INTO ""reviews"" (""desired_article_id"", ""name"") VALUES (?, ?)  [[""desired_article_id"", 1], [""name"", ""Some Review Name""]]
D, [2022-10-29T23:15:04.872412 #45405] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
D, [2022-10-29T23:15:04.873278 #45405] DEBUG -- :   Review Load (0.1ms)  SELECT ""reviews"".* FROM ""reviews"" WHERE ""reviews"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
D, [2022-10-29T23:15:04.877716 #45405] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2022-10-29T23:15:04.879912 #45405] DEBUG -- :   Article Load (0.1ms)  SELECT ""articles"".* FROM ""articles"" INNER JOIN ""article_reviews"" ON ""articles"".""id"" = ""article_reviews"".""article_id"" WHERE ""article_reviews"".""review_id"" = ?  [[""review_id"", 1]]
D, [2022-10-29T23:15:04.880268 #45405] DEBUG -- :   Article Create (0.0ms)  INSERT INTO ""articles"" DEFAULT VALUES
D, [2022-10-29T23:15:04.880719 #45405] DEBUG -- :   Review Update (0.0ms)  UPDATE ""reviews"" SET ""desired_article_id"" = ? WHERE ""reviews"".""id"" = ?  [[""desired_article_id"", 2], [""id"", 1]]
D, [2022-10-29T23:15:04.882989 #45405] DEBUG -- :   ArticleReview Create (0.0ms)  INSERT INTO ""article_reviews"" (""review_id"", ""article_id"") VALUES (?, ?)  [[""review_id"", 1], [""article_id"", 2]]
D, [2022-10-29T23:15:04.883306 #45405] DEBUG -- :   Review Update (0.0ms)  UPDATE ""reviews"" SET ""desired_article_id"" = ? WHERE ""reviews"".""id"" = ?  [[""desired_article_id"", 2], [""id"", 1]]
D, [2022-10-29T23:15:04.883439 #45405] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
F

Finished in 0.020406s, 49.0052 runs/s, 147.0156 assertions/s.

  1) Failure:
BugTest#test_reload_transaction_association [report2.rb:63]:
Expected: ""Some Review Name (touched)""
  Actual: ""Some Review Name""

1 runs, 3 assertions, 1 failures, 0 errors, 0 skips
```

### System configuration
**Rails version**: 7.0.4 (same with `main`)

**Ruby version**: 3.0.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46363/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46363/timeline,,
https://api.github.com/repos/rails/rails/issues/46361,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46361/labels{/name},https://api.github.com/repos/rails/rails/issues/46361/comments,https://api.github.com/repos/rails/rails/issues/46361/events,https://github.com/rails/rails/issues/46361,1425661655,I_kwDNIULOVPne1w,46361,[Bug] ActiveSupport::TimeWithZone's `today?` method returns wrong results when used with timezone other than UTC.,"{'login': 'jatindhankhar', 'id': 2412081, 'node_id': 'MDQ6VXNlcjI0MTIwODE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2412081?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jatindhankhar', 'html_url': 'https://github.com/jatindhankhar', 'followers_url': 'https://api.github.com/users/jatindhankhar/followers', 'following_url': 'https://api.github.com/users/jatindhankhar/following{/other_user}', 'gists_url': 'https://api.github.com/users/jatindhankhar/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jatindhankhar/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jatindhankhar/subscriptions', 'organizations_url': 'https://api.github.com/users/jatindhankhar/orgs', 'repos_url': 'https://api.github.com/users/jatindhankhar/repos', 'events_url': 'https://api.github.com/users/jatindhankhar/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jatindhankhar/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,10,2022-10-27T13:42:52Z,2023-06-28T15:32:26Z,,CONTRIBUTOR,,,,"### Steps to reproduce

`ActiveSupport::TimeWithZone`'s `today?` method returns wrong and inconsistent results when used in conjunction with other predicate methods. 

This was noticed on production when one of the business logic that processed data in local time zone lead to incorrect execution of the data set, on further debugging we discovered it due to the implementation of `today?` that relies on `time` instead of the `utc` and presents wrong and in-correct comparison.

<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

## Gemfile 
```ruby
source ""https://rubygems.org""
git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

ruby ""3.1.0""

# Bundle edge Rails instead: gem ""rails"", github: ""rails/rails"", branch: ""main""
gem ""rails"", ""~> 7.0.3""

# The original asset pipeline for Rails [https://github.com/rails/sprockets-rails]
gem ""sprockets-rails""

# Use sqlite3 as the database for Active Record
gem ""sqlite3"", ""~> 1.4""

# Use the Puma web server [https://github.com/puma/puma]
gem ""puma"", ""~> 5.0""

# Use JavaScript with ESM import maps [https://github.com/rails/importmap-rails]
gem ""importmap-rails""

# Hotwire's SPA-like page accelerator [https://turbo.hotwired.dev]
gem ""turbo-rails""

# Hotwire's modest JavaScript framework [https://stimulus.hotwired.dev]
gem ""stimulus-rails""

# Build JSON APIs with ease [https://github.com/rails/jbuilder]
gem ""jbuilder""

# Use Redis adapter to run Action Cable in production
gem ""redis"", ""~> 4.0""

# Timecop for mocking
gem 'timecop', '~> 0.9.5'

# Use Kredis to get higher-level data types in Redis [https://github.com/rails/kredis]
# gem ""kredis""

# Use Active Model has_secure_password [https://guides.rubyonrails.org/active_model_basics.html#securepassword]
# gem ""bcrypt"", ""~> 3.1.7""

# Windows does not include zoneinfo files, so bundle the tzinfo-data gem
gem ""tzinfo-data"", platforms: %i[ mingw mswin x64_mingw jruby ]

# Reduces boot times through caching; required in config/boot.rb
gem ""bootsnap"", require: false

# Use Sass to process CSS
# gem ""sassc-rails""

# Use Active Storage variants [https://guides.rubyonrails.org/active_storage_overview.html#transforming-images]
# gem ""image_processing"", ""~> 1.2""

group :development, :test do
  # See https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem
  gem ""debug"", platforms: %i[ mri mingw x64_mingw ]
end

group :development do
  # Use console on exceptions pages [https://github.com/rails/web-console]
  gem ""web-console""

  # Add speed badges [https://github.com/MiniProfiler/rack-mini-profiler]
  # gem ""rack-mini-profiler""

  # Speed up commands on slow machines / big apps [https://github.com/rails/spring]
  # gem ""spring""
end

group :test do
  # Use system testing [https://guides.rubyonrails.org/testing.html#system-testing]
  gem ""capybara""
  gem ""selenium-webdriver""
  gem ""webdrivers""
end

```

```ruby
require 'timecop'
processing_date = ""21-Oct-2022""
target_time = ActiveSupport::TimeZone['New Delhi'].parse(""22 Oct 2022 02:00 AM"")
Timecop.freeze(target_time)

local_parsed_date = ActiveSupport::TimeZone['New Delhi'].parse(processing_date)

puts ""Freezed time according to zone is #{ActiveSupport::TimeZone['New Delhi'].now}""
puts ""Parsed time according to zone is #{local_parsed_date}""

local_parsed_date.today? # Is true
local_parsed_date.past? # Is true
```

![Screenshot 2022-10-27 at 6 57 51 PM](https://user-images.githubusercontent.com/2412081/198297624-d97eb912-8c87-48ed-ad12-e89cfc545983.png)

![Screenshot 2022-10-27 at 6 58 12 PM](https://user-images.githubusercontent.com/2412081/198297634-af348eb7-1551-4fef-b4b3-f8b08cc7bdea.png)

### Expected behavior
<!-- Tell us what should happen -->

`local_parsed_date.today?` should return false. 
`local_parsed_date.past?` should return true 

`local_parsed_date` is `Fri, 21 Oct 2022 00:00:00.000000000 IST +05:30` while the current time zone of the system is `Sat, 22 Oct 2022 02:00:00.000000000 IST +05:30` 

There is a difference of one day between both days. 

Also a date can either be `today?` or `past?` but not both. 



### Actual behavior
`local_parsed_date.today?` returns true
`local_parsed_date.past?` returns true as well


### System configuration
**Rails version**: `7.0.3` / `6.0.5`

**Ruby version**: `3.1.0` / `2.6.6`

Although this behaviour is universal for all rails and ruby versions. 

### Possible reason

This seems to be arising due to the implementation difference between `today?` and `past?`, while the `past?` uses correct `utc` object, `today?`use the `time` object, resulting in the inconsistencies between results. 

https://github.com/rails/rails/blob/64cac367374d0f42cba7928b072083039ff62fa3/activesupport/lib/active_support/time_with_zone.rb#L273-L283

![Screenshot 2022-10-27 at 7 06 31 PM](https://user-images.githubusercontent.com/2412081/198299553-adb7c53e-3e25-47f7-a547-2dfca41a65c0.png)

<hr>

```ruby
0> time
=> 2022-10-21 00:00:00 UTC

0> utc
=> 2022-10-20 18:30:00 UTC

0> utc.today?
=> false

0> time.today?
=> true
```
![Screenshot 2022-10-27 at 7 11 49 PM](https://user-images.githubusercontent.com/2412081/198300757-830473c6-29fb-47f6-9dd5-1c7aab58bb03.png)
","{'url': 'https://api.github.com/repos/rails/rails/issues/46361/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/46361/timeline,,
https://api.github.com/repos/rails/rails/issues/46353,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46353/labels{/name},https://api.github.com/repos/rails/rails/issues/46353/comments,https://api.github.com/repos/rails/rails/issues/46353/events,https://github.com/rails/rails/pull/46353,1424675302,PR_kwDNIULOQZ3BSg,46353,Add primary_key_default option to create table migrations,"{'login': 'paulyoder', 'id': 224111, 'node_id': 'MDQ6VXNlcjIyNDExMQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/224111?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/paulyoder', 'html_url': 'https://github.com/paulyoder', 'followers_url': 'https://api.github.com/users/paulyoder/followers', 'following_url': 'https://api.github.com/users/paulyoder/following{/other_user}', 'gists_url': 'https://api.github.com/users/paulyoder/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/paulyoder/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/paulyoder/subscriptions', 'organizations_url': 'https://api.github.com/users/paulyoder/orgs', 'repos_url': 'https://api.github.com/users/paulyoder/repos', 'events_url': 'https://api.github.com/users/paulyoder/events{/privacy}', 'received_events_url': 'https://api.github.com/users/paulyoder/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,5,2022-10-26T20:47:52Z,2023-03-21T14:09:30Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46353', 'html_url': 'https://github.com/rails/rails/pull/46353', 'diff_url': 'https://github.com/rails/rails/pull/46353.diff', 'patch_url': 'https://github.com/rails/rails/pull/46353.patch', 'merged_at': None}","
### Motivation / Background

<!--
Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important?
If you are fixing a specific issue, include ""Fixes #ISSUE"" (replace with the issue number, remove the quotes) and the issue will be linked to this PR.
-->

This Pull Request has been created because I want to automatically set the `default:` argument on create table migrations to ""uuid_generate_v4()"". The primary key type on my tables are :uuid and I want to use the uuid_generate_v4() method from Postgres to generate the id values.

### Detail

It adds the `primary_key_default` option on the migration generator, which allows an initializer to set the value to automatically use on all create table migrations.

```ruby
Rails.application.config.generators do |g|
  g.orm(:active_record, primary_key_type: :uuid)
  g.orm(:active_record, primary_key_default: ""\""uuid_generate_v4()\"""")
end
```

```bash
rails generate migration create_books
```

```ruby
class CreateBooks < ActiveRecord::Migration[7.0]
  def change
    create_table :books, id: :uuid, default: ""uuid_generate_v4()"" do |t|

      t.timestamps
    end
  end
end
```

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46353/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46353/timeline,,
https://api.github.com/repos/rails/rails/issues/46351,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46351/labels{/name},https://api.github.com/repos/rails/rails/issues/46351/comments,https://api.github.com/repos/rails/rails/issues/46351/events,https://github.com/rails/rails/issues/46351,1424597995,I_kwDNIULOVOmj6w,46351,Updating a column using `serialize` to its database default value of `{}` instead tries to save it as NULL,"{'login': 'dfritsch', 'id': 1972157, 'node_id': 'MDQ6VXNlcjE5NzIxNTc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1972157?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dfritsch', 'html_url': 'https://github.com/dfritsch', 'followers_url': 'https://api.github.com/users/dfritsch/followers', 'following_url': 'https://api.github.com/users/dfritsch/following{/other_user}', 'gists_url': 'https://api.github.com/users/dfritsch/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dfritsch/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dfritsch/subscriptions', 'organizations_url': 'https://api.github.com/users/dfritsch/orgs', 'repos_url': 'https://api.github.com/users/dfritsch/repos', 'events_url': 'https://api.github.com/users/dfritsch/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dfritsch/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2022-10-26T19:36:56Z,2023-02-23T16:07:27Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
I originally was noticing issues trying to disable `partial_inserts` as part of upgrading to Rails 7. The oddness was that some models were failing to be created because Rails was now setting a null value for a column that had a database default and didn't allow nulls.

I then debugged that to what I think is consistent behavior in `serialize` that if you try to set the value of a column using `serialize` to its database default, Rails will instead try to set the value to NULL instead of the default value (which ultimately means you don't get the default).

Below is a test case I was able to write against ActiveRecord that I believe isolates the core issue here. At the very least I likely need to use a different model/fixture for adding the new column with null false and a default, but thought I would get some feedback on whether this is a real issue before digging deeper to try to isolate where the nil comes from.

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# new test added here:
# activerecord/test/cases/serialized_attribute_test.rb
  def test_serialized_attribute_with_default_can_update_to_default
    klass = Class.new(ActiveRecord::Base) do
      self.table_name = Topic.table_name
      serialize(:content, Hash)
    end

    t = klass.create!(content: { ""other_key"" => ""new_value"" })
    assert_equal({ ""other_key"" => ""new_value"" }, t.content)

    t.update!(content: {})
    assert_equal({}, t.content)
  end
```

```ruby
# Adjusted the Topic schema in activerecord/test/schema/schema.rb to:
t.text     :content, null: false, default: ""{}""
```

Running
```
bundle exec ruby -Itest test/cases/serialized_attribute_test.rb -n test_serialized_attribute_with_default_can_update_to_default
```

Then gives the failure that you are violating the not null constraint:

```
Error:
SerializedAttributeTestWithYamlSafeLoad#test_serialized_attribute_with_default_can_update_to_default:
ActiveRecord::NotNullViolation: SQLite3::ConstraintException: NOT NULL constraint failed: topics.content
    /Users/dfritsch/.gem/ruby/3.1.2/gems/sqlite3-1.4.4/lib/sqlite3/statement.rb:108:in `step'
    /Users/dfritsch/.gem/ruby/3.1.2/gems/sqlite3-1.4.4/lib/sqlite3/statement.rb:108:in `block in each'
    /Users/dfritsch/.gem/ruby/3.1.2/gems/sqlite3-1.4.4/lib/sqlite3/statement.rb:107:in `loop'
    /Users/dfritsch/.gem/ruby/3.1.2/gems/sqlite3-1.4.4/lib/sqlite3/statement.rb:107:in `each'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/sqlite3/database_statements.rb:54:in `to_a'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/sqlite3/database_statements.rb:54:in `block (2 levels) in exec_query'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb:970:in `block in with_raw_connection'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb:942:in `with_raw_connection'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/sqlite3/database_statements.rb:45:in `block in exec_query'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/notifications/instrumenter.rb:58:in `instrument'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb:1075:in `log'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/sqlite3/database_statements.rb:44:in `exec_query'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/sqlite3/database_statements.rb:72:in `exec_delete'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:180:in `update'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb:22:in `update'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/persistence.rb:513:in `_update_record'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/persistence.rb:1081:in `_update_row'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/locking/optimistic.rb:88:in `_update_row'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/persistence.rb:1103:in `_update_record'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/attribute_methods/dirty.rb:216:in `_update_record'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/callbacks.rb:465:in `block in _update_record'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/callbacks.rb:99:in `run_callbacks'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/callbacks.rb:947:in `_run_update_callbacks'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/callbacks.rb:465:in `_update_record'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/timestamp.rb:121:in `_update_record'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/persistence.rb:1090:in `create_or_update'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/callbacks.rb:457:in `block in create_or_update'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/callbacks.rb:99:in `run_callbacks'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/callbacks.rb:947:in `_run_save_callbacks'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/callbacks.rb:457:in `create_or_update'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/timestamp.rb:126:in `create_or_update'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/persistence.rb:648:in `save!'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/validations.rb:55:in `save!'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/transactions.rb:304:in `block in save!'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/transactions.rb:356:in `block in with_transaction_returning_status'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:320:in `transaction'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/transactions.rb:352:in `with_transaction_returning_status'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/transactions.rb:304:in `save!'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/suppressor.rb:54:in `save!'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/persistence.rb:801:in `block in update!'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/transactions.rb:356:in `block in with_transaction_returning_status'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:455:in `block in within_new_transaction'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'
    /Users/dfritsch/workspace/rails/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:453:in `within_new_transaction'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:322:in `transaction'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/transactions.rb:352:in `with_transaction_returning_status'
    /Users/dfritsch/workspace/rails/activerecord/lib/active_record/persistence.rb:799:in `update!'
    test/cases/serialized_attribute_test.rb:592:in `test_serialized_attribute_with_default_can_update_to_default'
```

### Expected behavior
<!-- Tell us what should happen -->
I'd expect the column to be updated to the serialized format of the column default.

### Actual behavior
<!-- Tell us what happens instead -->
Nil/null is passed as the new column default, violating the not null constraint.

### System configuration
**Rails version**: 7.0.4 and main

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46351/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46351/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/46344,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46344/labels{/name},https://api.github.com/repos/rails/rails/issues/46344/comments,https://api.github.com/repos/rails/rails/issues/46344/events,https://github.com/rails/rails/pull/46344,1423734139,PR_kwDNIULOQZDw4g,46344,Add nil to valid options for dependent,"{'login': 'omegahm', 'id': 178448, 'node_id': 'MDQ6VXNlcjE3ODQ0OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/178448?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/omegahm', 'html_url': 'https://github.com/omegahm', 'followers_url': 'https://api.github.com/users/omegahm/followers', 'following_url': 'https://api.github.com/users/omegahm/following{/other_user}', 'gists_url': 'https://api.github.com/users/omegahm/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/omegahm/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/omegahm/subscriptions', 'organizations_url': 'https://api.github.com/users/omegahm/orgs', 'repos_url': 'https://api.github.com/users/omegahm/repos', 'events_url': 'https://api.github.com/users/omegahm/events{/privacy}', 'received_events_url': 'https://api.github.com/users/omegahm/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-10-26T09:40:55Z,2022-10-26T13:30:51Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46344', 'html_url': 'https://github.com/rails/rails/pull/46344', 'diff_url': 'https://github.com/rails/rails/pull/46344.diff', 'patch_url': 'https://github.com/rails/rails/pull/46344.patch', 'merged_at': None}","### Motivation / Background

`nil` is a valid value for the `dependent` option on `has_many`, `has_one` and `belongs_to`, but the error message you got didn't specify this.

### Detail

This changes what Rails sees as specified valid options for `dependent`

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why.
* [x] Tests are added or updated if you fix a bug or add a feature.
* [ ] ~CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.~
* [ ] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46344/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46344/timeline,,
https://api.github.com/repos/rails/rails/issues/46306,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46306/labels{/name},https://api.github.com/repos/rails/rails/issues/46306/comments,https://api.github.com/repos/rails/rails/issues/46306/events,https://github.com/rails/rails/pull/46306,1419245988,PR_kwDNIULOQVV1Yw,46306,Removes the Content-Length header in Blobs::Proxycontroller#show,"{'login': 'codergeek121', 'id': 4910785, 'node_id': 'MDQ6VXNlcjQ5MTA3ODU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4910785?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/codergeek121', 'html_url': 'https://github.com/codergeek121', 'followers_url': 'https://api.github.com/users/codergeek121/followers', 'following_url': 'https://api.github.com/users/codergeek121/following{/other_user}', 'gists_url': 'https://api.github.com/users/codergeek121/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/codergeek121/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/codergeek121/subscriptions', 'organizations_url': 'https://api.github.com/users/codergeek121/orgs', 'repos_url': 'https://api.github.com/users/codergeek121/repos', 'events_url': 'https://api.github.com/users/codergeek121/events{/privacy}', 'received_events_url': 'https://api.github.com/users/codergeek121/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,4,2022-10-22T11:19:04Z,2022-11-08T17:45:48Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46306', 'html_url': 'https://github.com/rails/rails/pull/46306', 'diff_url': 'https://github.com/rails/rails/pull/46306.diff', 'patch_url': 'https://github.com/rails/rails/pull/46306.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because I researched the cause for #46288. When investigating, I noticed we're setting the header but always remove it later in the code linked below.

### Detail

Even though the Content-Length header is set in the controller action, it will always be removed in https://github.com/rails/rails/blob/7fdcbe747f7ab5ef664b894f73c8e0ada04c5c50/actionpack/lib/action_controller/metal/live.rb#L154 We should not set it in the first place in this action.","{'url': 'https://api.github.com/repos/rails/rails/issues/46306/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46306/timeline,,
https://api.github.com/repos/rails/rails/issues/46292,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46292/labels{/name},https://api.github.com/repos/rails/rails/issues/46292/comments,https://api.github.com/repos/rails/rails/issues/46292/events,https://github.com/rails/rails/issues/46292,1417339764,I_kwDNIULOVHrjdA,46292,"Applications using Sprockets, Rails UJS, but not CoffeeScript cannot consume Rails via git prior to Rails UJS abandoning CoffeeScript","{'login': 'sambostock', 'id': 8219340, 'node_id': 'MDQ6VXNlcjgyMTkzNDA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8219340?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sambostock', 'html_url': 'https://github.com/sambostock', 'followers_url': 'https://api.github.com/users/sambostock/followers', 'following_url': 'https://api.github.com/users/sambostock/following{/other_user}', 'gists_url': 'https://api.github.com/users/sambostock/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sambostock/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sambostock/subscriptions', 'organizations_url': 'https://api.github.com/users/sambostock/orgs', 'repos_url': 'https://api.github.com/users/sambostock/repos', 'events_url': 'https://api.github.com/users/sambostock/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sambostock/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2022-10-20T21:43:31Z,2022-11-30T23:32:22Z,,CONTRIBUTOR,,,,"### Context

Our application continues to run into the bug fixed by #46110, as the fix is not present on any **release**. While discussing temporary monkey patches in Slack, @eileencodes recommended pointing our app to the `7-0-stable` branch of Rails, which contains an unreleased backport. When trying to switch over, we ran into the following error:

```
LoadError: cannot load such file -- coffee_script
```

This same error occurs even if switching from the 7.0.4 published release of the gem to directly to the corresponding `v7.0.4` git tag, indicating the issue is due to consuming Rails via git, as opposed to a commit introduced on `7-0-stable` since the 7.0.4 release.

### Investigation

@bryanparadis and I conducted an investigation and came to the following conclusion:

Prior to #45546, Rails UJS was written as `.coffeescript` files.

When a host app still using Sprockets for Javascript and including Rails UJS in its manifest compiles assets it tries to include those files. In the published versions of Rails, these files have been already [compiled into regular Javascript](https://github.com/rails/rails/blob/a6d0f80d3af575482d826301d947e43fc3c5c649/actionview/package.json#L13), so no additional compilation is necessary.

If Rails is being consumed via git, the files only exist as `.coffeescript` files, so Sprockets tries to load `coffee_script` to compile them.

If the host application does not depend on `coffee_script`, then this raises a `LoadError`.

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

<details><summary>Reproduction Script</summary>

```bash
# /usr/bin/env bash

set -euo pipefail

echo 'Preparing directory...'
rm -rf dummy
mkdir dummy
cd dummy

echo 'Installing Rails...'
echo 'source ""https://rubygems.org""' > Gemfile
echo 'gem ""rails"", git: ""https://github.com/rails/rails.git"", branch: ""7-0-stable""' >> Gemfile
bundle install --quiet

echo 'Initialize Rails app...'
rails new \
	--force \
	--no-rc \
	--quiet \
	--skip-action-cable \
	--skip-action-mailbox \
	--skip-action-mailer \
	--skip-action-text \
	--skip-active-job \
	--skip-active-record \
	--skip-active-storage \
	--skip-bootsnap \
	--skip-git \
	--skip-hotwire \
	--skip-javascript \
	--skip-jbuilder \
	--skip-keeps \
	--skip-system-test \
	--skip-test \
	.

echo 'Using Sprockets for JS...'
mkdir app/assets/javascripts
touch app/assets/javascripts/application.js
echo ""//= link_directory ../javascripts .js"" >> app/assets/config/manifest.js

echo ""Using Rails UJS...""
echo ""//= require rails-ujs"" > app/assets/javascripts/application.js

echo ""Precompiling assets using $(bundle info rails | grep '\*' | sed 's/ *\* //')...""
bundle exec rails assets:precompile

echo 'Switching to 7-0-stable version of Rails...'
sed -i '' 's/gem ""rails"", ""[^""]*""/gem ""rails"", github: ""rails\/rails"", branch: ""7-0-stable""/' Gemfile
bundle install --quiet

echo ""Precompiling assets using $(bundle info rails | grep '\*' | sed 's/ *\* //')...""
bundle exec rails assets:precompile

```

</details>

### Expected behavior
<!-- Tell us what should happen -->

Consuming a released version of Rails or its equivalent git tag should behave the same.

### Actual behavior
<!-- Tell us what happens instead -->

Applications that work with a released version of Rails (e.g. 7.0.4) do not work with the equivalent git tag (e.g. `v7.0.4`) under certain circumstances:
- Not depending on `coffee-script`
- Using Sprockets for JavaScript, not Import Maps
- Depending on Rails UJS

### System configuration
**Rails version**: `v7.0.4`

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46292/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46292/timeline,,
https://api.github.com/repos/rails/rails/issues/46266,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46266/labels{/name},https://api.github.com/repos/rails/rails/issues/46266/comments,https://api.github.com/repos/rails/rails/issues/46266/events,https://github.com/rails/rails/pull/46266,1413575589,PR_kwDNIULOQQjtVg,46266,Make TagBuilder#attributes documentation public [ci-skip],"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-18T17:17:00Z,2022-10-18T19:12:17Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46266', 'html_url': 'https://github.com/rails/rails/pull/46266', 'diff_url': 'https://github.com/rails/rails/pull/46266.diff', 'patch_url': 'https://github.com/rails/rails/pull/46266.patch', 'merged_at': None}","The `TagBuilder#attributes` seems to be [public AP](https://github.com/rails/rails/pull/40657)I but because TagBuilder is defined as `:nodoc` it doesn't show up in the API docs.

By adding `:doc:` for this method, it becomes visible in the API docs:
<img width=""793"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/196500130-67fb2c04-a472-4f17-beb6-6a7479e5349f.png"">

This PR makes only `attributes` public, but since more methods of `TagBuilder` are [described in `tag`](https://edgeapi.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-tag) maybe we can make more public?","{'url': 'https://api.github.com/repos/rails/rails/issues/46266/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46266/timeline,,
https://api.github.com/repos/rails/rails/issues/46264,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46264/labels{/name},https://api.github.com/repos/rails/rails/issues/46264/comments,https://api.github.com/repos/rails/rails/issues/46264/events,https://github.com/rails/rails/pull/46264,1413489933,PR_kwDNIULOQQfN_Q,46264,Support custom test paths,"{'login': 'TastyPi', 'id': 934844, 'node_id': 'MDQ6VXNlcjkzNDg0NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/934844?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/TastyPi', 'html_url': 'https://github.com/TastyPi', 'followers_url': 'https://api.github.com/users/TastyPi/followers', 'following_url': 'https://api.github.com/users/TastyPi/following{/other_user}', 'gists_url': 'https://api.github.com/users/TastyPi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/TastyPi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/TastyPi/subscriptions', 'organizations_url': 'https://api.github.com/users/TastyPi/orgs', 'repos_url': 'https://api.github.com/users/TastyPi/repos', 'events_url': 'https://api.github.com/users/TastyPi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/TastyPi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-18T16:08:23Z,2022-10-18T16:12:46Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46264', 'html_url': 'https://github.com/rails/rails/pull/46264', 'diff_url': 'https://github.com/rails/rails/pull/46264.diff', 'patch_url': 'https://github.com/rails/rails/pull/46264.patch', 'merged_at': None}","<!--
About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!-- Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important? -->

This Pull Request has been created because we're using [Packwerk](https://github.com/Shopify/packwerk) for our Rails app. We'd like to have tests for code in a package be defined in the directory for that package, e.g. `packages/a/test`. However, there is not a trivial way to make Rails's standard `test`/`test:all` etc. commands also run these tests. Our current solution is a [custom rake file](https://gist.github.com/TastyPi/75ed5f2aa01bfb59ccd598c924c08ea9) that redefines the tasks to include the packages' tests, but ideally this would be supported by Rails itself.

### Detail

This Pull Request changes `Rails::TestUnit::Runner` to support specifying default test paths using `Rails::Paths::Path`. This mirrors how `Rails::Engine` and `Rails::Application` can be configured to use different paths from the standard. It also loads `config/tests.rb` if present, otherwise there is not a good place to configure the paths.

For the example above, the `config/tests.rb` would contain something like:

```ruby
Dir.glob(""packages/*/test"").each do |path|
  Rails::TestUnit::Runner.paths[""test""] << path
end
```

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

This is my first time contributing to Rails, so I suspect this pattern does not fully follow Rails conventions, however I have at least checked that it works. I have not tested it with a project that uses `rspec` as I am unfamiliar with it.

I would say the most questionable parts are:

1. Is `Rails::TestUnit::Runner` the right class for this configuration?
2. Is `Rails::Paths::Path` the best solution for specifying these paths?
3. Should `config/tests.rb` be introduced or is there a better way to run code before tests that I am unaware of?

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [ ] Tests are added if you fix a bug or add a feature.
  (I have not investigated how to test this and do not wish to spend too much time on it before I know the final implementation and whether this feature is wanted)
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [ ] CI is passing.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
","{'url': 'https://api.github.com/repos/rails/rails/issues/46264/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46264/timeline,,
https://api.github.com/repos/rails/rails/issues/46262,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46262/labels{/name},https://api.github.com/repos/rails/rails/issues/46262/comments,https://api.github.com/repos/rails/rails/issues/46262/events,https://github.com/rails/rails/pull/46262,1412974374,PR_kwDNIULOQQDdaQ,46262,Support proc and symbol for `NumericalityValidator`'s `:in` option,"{'login': 'ThomasSevestre', 'id': 1258170, 'node_id': 'MDQ6VXNlcjEyNTgxNzA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1258170?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ThomasSevestre', 'html_url': 'https://github.com/ThomasSevestre', 'followers_url': 'https://api.github.com/users/ThomasSevestre/followers', 'following_url': 'https://api.github.com/users/ThomasSevestre/following{/other_user}', 'gists_url': 'https://api.github.com/users/ThomasSevestre/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ThomasSevestre/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ThomasSevestre/subscriptions', 'organizations_url': 'https://api.github.com/users/ThomasSevestre/orgs', 'repos_url': 'https://api.github.com/users/ThomasSevestre/repos', 'events_url': 'https://api.github.com/users/ThomasSevestre/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ThomasSevestre/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-18T10:32:09Z,2022-10-18T11:04:31Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46262', 'html_url': 'https://github.com/rails/rails/pull/46262', 'diff_url': 'https://github.com/rails/rails/pull/46262.diff', 'patch_url': 'https://github.com/rails/rails/pull/46262.patch', 'merged_at': None}","This PR adds support for proc and symbol parameters for `NumericalityValidator`'s `:in` option

For instance :
```ruby
validates_numericality_of :price, in: ->(o) { 0..o.max_price }
```

or :

```ruby
validates_numericality_of :price, in: :price_range
    
def price_range
  0..max_price
end
```
","{'url': 'https://api.github.com/repos/rails/rails/issues/46262/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46262/timeline,,
https://api.github.com/repos/rails/rails/issues/46252,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46252/labels{/name},https://api.github.com/repos/rails/rails/issues/46252/comments,https://api.github.com/repos/rails/rails/issues/46252/events,https://github.com/rails/rails/pull/46252,1410291206,PR_kwDNIULOQN1TsA,46252,Custom route formatters,"{'login': 'phendrick', 'id': 218674, 'node_id': 'MDQ6VXNlcjIxODY3NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/218674?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/phendrick', 'html_url': 'https://github.com/phendrick', 'followers_url': 'https://api.github.com/users/phendrick/followers', 'following_url': 'https://api.github.com/users/phendrick/following{/other_user}', 'gists_url': 'https://api.github.com/users/phendrick/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/phendrick/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/phendrick/subscriptions', 'organizations_url': 'https://api.github.com/users/phendrick/orgs', 'repos_url': 'https://api.github.com/users/phendrick/repos', 'events_url': 'https://api.github.com/users/phendrick/events{/privacy}', 'received_events_url': 'https://api.github.com/users/phendrick/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-15T21:09:26Z,2022-10-15T21:11:52Z,,NONE,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46252', 'html_url': 'https://github.com/rails/rails/pull/46252', 'diff_url': 'https://github.com/rails/rails/pull/46252.diff', 'patch_url': 'https://github.com/rails/rails/pull/46252.patch', 'merged_at': None}","### Motivation / Background

To allow for easily customising the output of `rails routes` this PR implements the ability to register custom route formatters and adds a `--formatter` option to use the registered formatter(s). 

### Detail

Adds a `ActionDispatch::Routing::ConsoleFormatter.register_formatter()` method and a `registered_formatters` on the `ActionDispatch::Routing::ConsoleFormatter` module. 
Each registered formatter implements `#draw(routes, ""title"")` to output the application routes and any routes registered in engines. 

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
","{'url': 'https://api.github.com/repos/rails/rails/issues/46252/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46252/timeline,,
https://api.github.com/repos/rails/rails/issues/46245,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46245/labels{/name},https://api.github.com/repos/rails/rails/issues/46245/comments,https://api.github.com/repos/rails/rails/issues/46245/events,https://github.com/rails/rails/pull/46245,1409447847,PR_kwDNIULOQNJ-pg,46245,Add Proc as a type for ActiveJob retry_on attempts,"{'login': 'rosew', 'id': 212648, 'node_id': 'MDQ6VXNlcjIxMjY0OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/212648?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rosew', 'html_url': 'https://github.com/rosew', 'followers_url': 'https://api.github.com/users/rosew/followers', 'following_url': 'https://api.github.com/users/rosew/following{/other_user}', 'gists_url': 'https://api.github.com/users/rosew/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rosew/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rosew/subscriptions', 'organizations_url': 'https://api.github.com/users/rosew/orgs', 'repos_url': 'https://api.github.com/users/rosew/repos', 'events_url': 'https://api.github.com/users/rosew/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rosew/received_events', 'type': 'User', 'site_admin': False}","[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-14T14:32:44Z,2022-10-18T21:34:58Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46245', 'html_url': 'https://github.com/rails/rails/pull/46245', 'diff_url': 'https://github.com/rails/rails/pull/46245.diff', 'patch_url': 'https://github.com/rails/rails/pull/46245.patch', 'merged_at': None}","### Motivation / Background

This Pull Request has been created because I needed `retry_on attempts:` to use more complex logic than an Integer.

In my specific case I was creating a concern for Jobs that would use `retry_on` to allow jobs to quietly fail and retry. The concern was going to use a method to allow attempts to be customized in individual jobs. 
```
    included do
      retry_on(QuietRetryError, wait: :exponentially_longer, attempts: quiet_retry_attempts) do
        # ...
      end
    end
```

However this ran into a state where the method needed to be defined and run when the concern was included instead of being available later in the job. It would be very fragile to have to define the method before including the concern. This lead to me to looking at if attempts accepted anything besides an integer. It did not but I saw there was already a pattern in place for wait to accept a Proc. I thought if that pattern was repeated for attempts than it would allow more flexibility for configuring attempts.

My original thought was to have the Proc for attempts return a number similar to what the Proc for wait does. However, on thinking about it I decided that still did not leave much flexibility because attempts would still be determined by a number. Instead I switched it to return true/false so if the next attempt occurred could be determined by whatever logic was implemented in the Proc.

### Detail

This Pull Request changes ActiveJob retry_on attempts so it will accept a Proc.

ActiveJob retry_on allowed the wait option to be set as a Proc that calculates the wait but did not give the same option for attempts. attempts could be set to only a number of times to attempt or unlimited. However, jobs sometimes need different logic than number of executions to determine if they should try again.

This PR adds support for setting attempts to a Proc that returns either true or false. On true the retry will occur.

As a an example:

    retry_on ProcRetryError, attempts: ->(executions) { executions < 2 }

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [ ] CI is passing.

","{'url': 'https://api.github.com/repos/rails/rails/issues/46245/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46245/timeline,,
https://api.github.com/repos/rails/rails/issues/46242,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46242/labels{/name},https://api.github.com/repos/rails/rails/issues/46242/comments,https://api.github.com/repos/rails/rails/issues/46242/events,https://github.com/rails/rails/pull/46242,1408898225,PR_kwDNIULOQMsdng,46242,Combine predefined activestorage attachment variants,"{'login': 'mdh', 'id': 26221, 'node_id': 'MDQ6VXNlcjI2MjIx', 'avatar_url': 'https://avatars.githubusercontent.com/u/26221?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mdh', 'html_url': 'https://github.com/mdh', 'followers_url': 'https://api.github.com/users/mdh/followers', 'following_url': 'https://api.github.com/users/mdh/following{/other_user}', 'gists_url': 'https://api.github.com/users/mdh/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mdh/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mdh/subscriptions', 'organizations_url': 'https://api.github.com/users/mdh/orgs', 'repos_url': 'https://api.github.com/users/mdh/repos', 'events_url': 'https://api.github.com/users/mdh/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mdh/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-14T07:26:23Z,2023-09-28T08:25:49Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46242', 'html_url': 'https://github.com/rails/rails/pull/46242', 'diff_url': 'https://github.com/rails/rails/pull/46242.diff', 'patch_url': 'https://github.com/rails/rails/pull/46242.patch', 'merged_at': None}","### Motivation / Background

Sometimes you will want to combine predefined-variants, like rotate and thumb:
```ruby
@user.avatar.variant(:thumb, :rotate_90)
```
Until now, you could only use 1 variant. If you would like to combine multiple variants, you would have to explicitly create all possible combinations, which becomes quite cluttered quick, e.g.:
```ruby
attachable.variant :thumb, ...
attachable.variant :thumb_rotate_90, ...
attachable.variant :thumb_rotate_180, ...
```

This PR adds support for combining multiple variants.

This Pull Request has been created because we use activestorage a lot and sometimes want to combine predefined-variants.

### Detail

This Pull Request changes the way that ActiveStorage::Attachment looks up transformations. It is backwards compatible, but allows users to define more than 1 predefined variant.

#### Before:
```ruby
has_one_attached :avatar do |attachable|
  attachable.variant :thumb,            resize_to_limit: [100, 100]
  attachable.variant :thumb_rotate_90,  resize_to_limit: [100, 100], rotate: 90
  attachable.variant :thumb_rotate_180, resize_to_limit: [100, 100], rotate: 180
end

@user.avatar.variant(:thumb_rotate_90)
```

#### After:
```ruby
has_one_attached :avatar do |attachable|
  attachable.variant :thumb, resize_to_limit: [100, 100]
end

@user.avatar.variant(:thumb, rotate: 90)
```

### Additional information

I chose to use some recursion in the lookup process, it works just fine, but might be hard to read for some. Could write this out in a more explicit way.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
","{'url': 'https://api.github.com/repos/rails/rails/issues/46242/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46242/timeline,,
https://api.github.com/repos/rails/rails/issues/46239,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46239/labels{/name},https://api.github.com/repos/rails/rails/issues/46239/comments,https://api.github.com/repos/rails/rails/issues/46239/events,https://github.com/rails/rails/issues/46239,1408386847,I_kwDNIULOU_JHHw,46239,`validates_associated` does not properly use `context` specified in `on` option.,"{'login': 'austenmadden', 'id': 7366727, 'node_id': 'MDQ6VXNlcjczNjY3Mjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7366727?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/austenmadden', 'html_url': 'https://github.com/austenmadden', 'followers_url': 'https://api.github.com/users/austenmadden/followers', 'following_url': 'https://api.github.com/users/austenmadden/following{/other_user}', 'gists_url': 'https://api.github.com/users/austenmadden/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/austenmadden/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/austenmadden/subscriptions', 'organizations_url': 'https://api.github.com/users/austenmadden/orgs', 'repos_url': 'https://api.github.com/users/austenmadden/repos', 'events_url': 'https://api.github.com/users/austenmadden/events{/privacy}', 'received_events_url': 'https://api.github.com/users/austenmadden/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-13T20:29:31Z,2022-10-14T03:32:06Z,,CONTRIBUTOR,,,,"PR with fix and test: https://github.com/rails/rails/pull/46238

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.0.4""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :topics, force: true do |t|
  end

  create_table :replies, force: true do |t|
    t.belongs_to :topic
    t.string :content
  end
end

class Topic < ActiveRecord::Base
  has_one :reply
  validates_associated :reply, on: :custom
end

class Reply < ActiveRecord::Base
  belongs_to :topic
  validates_presence_of :content, on: :custom
end

class BugTest < Minitest::Test
  def test_validates_associated_with_custom_context
    topic = Topic.create
    reply = Reply.create(topic: topic)
    refute topic.valid?(:custom)
    assert_equal [""is invalid""], topic.errors[:reply]
  end
end

```

### Expected behavior
https://api.rubyonrails.org/classes/ActiveRecord/Validations/ClassMethods.html#method-i-validates_associated States the following:

> :on - Specifies the contexts where this validation is active. Runs in all validation contexts by default nil. You can pass a symbol or an array of symbols. (e.g. on: :create or on: :custom_validation_context or on: [:create, :custom_validation_context])

This option should be respected when validating the associated object.

### Actual behavior
The default context is used and a custom context is not respected. In the above test this means the association is considered valid when it should not.

### System configuration
**Rails version**: 7.0.4

**Ruby version**: 3.1.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/46239/reactions', 'total_count': 4, '+1': 4, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46239/timeline,,
https://api.github.com/repos/rails/rails/issues/46238,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46238/labels{/name},https://api.github.com/repos/rails/rails/issues/46238/comments,https://api.github.com/repos/rails/rails/issues/46238/events,https://github.com/rails/rails/pull/46238,1408385982,PR_kwDNIULOQMRb5g,46238,Pass validation_context to validates_associated,"{'login': 'austenmadden', 'id': 7366727, 'node_id': 'MDQ6VXNlcjczNjY3Mjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7366727?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/austenmadden', 'html_url': 'https://github.com/austenmadden', 'followers_url': 'https://api.github.com/users/austenmadden/followers', 'following_url': 'https://api.github.com/users/austenmadden/following{/other_user}', 'gists_url': 'https://api.github.com/users/austenmadden/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/austenmadden/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/austenmadden/subscriptions', 'organizations_url': 'https://api.github.com/users/austenmadden/orgs', 'repos_url': 'https://api.github.com/users/austenmadden/repos', 'events_url': 'https://api.github.com/users/austenmadden/events{/privacy}', 'received_events_url': 'https://api.github.com/users/austenmadden/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,10,2022-10-13T20:28:38Z,2023-04-19T15:00:38Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46238', 'html_url': 'https://github.com/rails/rails/pull/46238', 'diff_url': 'https://github.com/rails/rails/pull/46238.diff', 'patch_url': 'https://github.com/rails/rails/pull/46238.patch', 'merged_at': None}","<!--
About this template

The following template aims to help contributors write a good description for their pull requests.
We'd like you to provide a description of the changes in your pull request (i.e. bugs fixed or features added), motivation behind the changes, and complete the checklist below before opening a pull request.

Feel free to discard it if you need to (e.g. when you just fix a typo). -->

### Motivation / Background

<!-- Describe why this Pull Request needs to be merged. What bug have you fixed? What feature have you added? Why is it important? -->

This Pull Request has been created because https://github.com/rails/rails/issues/46239

### Detail

The docs imply that when specified the `on` option of `validates_associated` should be respected by the validated association. Prior to this change the validation context used will simply be the default behavior as if no `on` option were specified. With this change, the validation_context of the parent record is passed to the `valid?` check.

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
","{'url': 'https://api.github.com/repos/rails/rails/issues/46238/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46238/timeline,,
https://api.github.com/repos/rails/rails/issues/46214,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46214/labels{/name},https://api.github.com/repos/rails/rails/issues/46214/comments,https://api.github.com/repos/rails/rails/issues/46214/events,https://github.com/rails/rails/pull/46214,1402504444,PR_kwDNIULOQHW9ew,46214,Add `ActiveRecord::Persistence#exists?`,"{'login': 'r7kamura', 'id': 111689, 'node_id': 'MDQ6VXNlcjExMTY4OQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/111689?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/r7kamura', 'html_url': 'https://github.com/r7kamura', 'followers_url': 'https://api.github.com/users/r7kamura/followers', 'following_url': 'https://api.github.com/users/r7kamura/following{/other_user}', 'gists_url': 'https://api.github.com/users/r7kamura/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/r7kamura/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/r7kamura/subscriptions', 'organizations_url': 'https://api.github.com/users/r7kamura/orgs', 'repos_url': 'https://api.github.com/users/r7kamura/repos', 'events_url': 'https://api.github.com/users/r7kamura/events{/privacy}', 'received_events_url': 'https://api.github.com/users/r7kamura/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-10T02:15:14Z,2022-12-06T22:16:10Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46214', 'html_url': 'https://github.com/rails/rails/pull/46214', 'diff_url': 'https://github.com/rails/rails/pull/46214.diff', 'patch_url': 'https://github.com/rails/rails/pull/46214.patch', 'merged_at': None}","### Motivation / Background

When you want to check whether a record still exists in the database or not, there is already methods called `ActiveRecord::Persistence#destroyed?` and `ActiveRecord::Persistence#persisted?`, but they are not able to get accurate result unless you query the same instance that was used when the record was destroyed.

For example, this is often a problem when writing tests. Writing in the RSpec example commonly used in Rails app:

```ruby
RSpec.describe 'DELETE /articles/:id' do
  let(:article) do
    Article.create!
  end

  it 'destroys article' do
    delete ""/articles/#{article.id}""
    expect(article).not_to be_persisted # WRONG CODE
    # or expect(article).to be_destroyed # WRONG CODE
  end
end
```

In such case, I have seen many codes written as a workaround like this, but none of them would be considered concise code:

```ruby
RSpec.describe 'DELETE /articles/:id' do
  let(:article) do
    Article.create!
  end

  it 'destroys article' do
    delete ""/articles/#{article.id}""
    expect(article.class.exists?(article)).to be false
    # or expect { article.reload }.to raise_error(ActiveRecord::RecordNotFound)
    # or expect { article.class.find(article.id) }.to raise_error(ActiveRecord::RecordNotFound)
    # or expect { article.class.find_by(id: article.id) }.to be_nil
    # or expect { delete ""/articles/#{article.id}"" }.to change { article.class.count }.by(-1)
    # or so...
  end
end
```

This Pull Request has been created to provide a convenient API that can be used in such case. Of course, it could be used for many other cases as well.

### Detail

This Pull Request adds `ActiveRecord::Persistence#exists?` so that you can easily check with this whether the record exists in the database or not.

```ruby
RSpec.describe 'DELETE /articles/:id' do
  let(:article) do
    Article.create!
  end

  it 'destroys article' do
    delete ""/articles/#{article.id}""
    expect(article.exists?).to be false
    # or expect(article).not_to exist
  end
end
```

### Additional information

I am not that familiar with the ActiveRecord API, so maybe there is already a method to achieve something similar that I am not aware of. If so, please let me know.

It might be debatable whether the method name `exists?` means `exists on the database`, and whether it wouldn't be confusing in the situation where a method called `persisted?` already exists.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.","{'url': 'https://api.github.com/repos/rails/rails/issues/46214/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46214/timeline,,
https://api.github.com/repos/rails/rails/issues/46210,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46210/labels{/name},https://api.github.com/repos/rails/rails/issues/46210/comments,https://api.github.com/repos/rails/rails/issues/46210/events,https://github.com/rails/rails/pull/46210,1402037354,PR_kwDNIULOQHAN9g,46210,Delete variants from service only if variants are being tracked,"{'login': 'ritikesh', 'id': 1778360, 'node_id': 'MDQ6VXNlcjE3NzgzNjA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1778360?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ritikesh', 'html_url': 'https://github.com/ritikesh', 'followers_url': 'https://api.github.com/users/ritikesh/followers', 'following_url': 'https://api.github.com/users/ritikesh/following{/other_user}', 'gists_url': 'https://api.github.com/users/ritikesh/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ritikesh/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ritikesh/subscriptions', 'organizations_url': 'https://api.github.com/users/ritikesh/orgs', 'repos_url': 'https://api.github.com/users/ritikesh/repos', 'events_url': 'https://api.github.com/users/ritikesh/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ritikesh/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,4,2022-10-08T19:13:48Z,2023-04-01T16:14:00Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46210', 'html_url': 'https://github.com/rails/rails/pull/46210', 'diff_url': 'https://github.com/rails/rails/pull/46210.diff', 'patch_url': 'https://github.com/rails/rails/pull/46210.patch', 'merged_at': None}","### Motivation / Background

When purging an `ActiveStorage::Blob` object, it makes two calls to the underlying file service. once to delete the actual file and then again to delete the variants. ActiveStorage makes tracking variants optional, and when not opted, the second delete call to the file service is redundant and can be avoided.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [ ] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46210/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46210/timeline,,
https://api.github.com/repos/rails/rails/issues/46205,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46205/labels{/name},https://api.github.com/repos/rails/rails/issues/46205/comments,https://api.github.com/repos/rails/rails/issues/46205/events,https://github.com/rails/rails/pull/46205,1400558995,PR_kwDNIULOQFzP-A,46205,Define after_schema_load_callbacks,"{'login': 'bf4', 'id': 142914, 'node_id': 'MDQ6VXNlcjE0MjkxNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/142914?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bf4', 'html_url': 'https://github.com/bf4', 'followers_url': 'https://api.github.com/users/bf4/followers', 'following_url': 'https://api.github.com/users/bf4/following{/other_user}', 'gists_url': 'https://api.github.com/users/bf4/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bf4/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bf4/subscriptions', 'organizations_url': 'https://api.github.com/users/bf4/orgs', 'repos_url': 'https://api.github.com/users/bf4/repos', 'events_url': 'https://api.github.com/users/bf4/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bf4/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,2,2022-10-07T03:06:18Z,2022-11-10T06:07:48Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46205', 'html_url': 'https://github.com/rails/rails/pull/46205', 'diff_url': 'https://github.com/rails/rails/pull/46205.diff', 'patch_url': 'https://github.com/rails/rails/pull/46205.patch', 'merged_at': None}","### Motivation / Background

See https://discuss.rubyonrails.org/t/rfc-new-activerecord-hook-after-load-schema/81506/3

Years ago while working on one of the acts-as-taggable gems I discovered that certain method calls in ActiveRecord classes rely on database connections. Specifically, any method which wants to first check which columns or any column-related information is defined, will necessitate a database connection. So, you could override or alias the columns method to add behavior on when columns is first evaluated. Ive since learned at the actual hook method at this time is load_schema


 ### Detail

Adds an after_load_schema! hook to ActiveRecord::Base which can be defined per subclass.

I intentionally started this PR with a very small change and no tests to validate the specific proposal and that it doesn't break anything.

 ### Additional information

We use something like this, for example, in our lib/sti_preload.rb


```ruby
 # per https://guides.rubyonrails.org/autoloading_and_reloading_constants.html#single-table-inheritance
 # Usage:
 # In an STI base class
 #      AppConfig.when_not_eager_loading do
 #        include StiPreload
 #        self.deleted_sti_models = []
 #      end
module StiPreload
  extend ActiveSupport::Concern

  included do
    cattr_accessor :preloaded, instance_accessor: false
    cattr_accessor :deleted_sti_models, instance_accessor: false, default: []
  end

  class_methods do
    def descendants
      preload_sti unless preloaded
      super
    end

    # Constantizes all types present in the database. There might be more on
    # disk, but that does not matter in practice as far as the STI API is
    # concerned.
    #
    # Assumes store_full_sti_class is true, the default.
    def preload_sti
      after_load_schema! do
        begin
          polymorphic_name.constantize.preload_sti!
        rescue PG::UndefinedTable, ActiveRecord::StatementInvalid => e
          raise unless e.is_a?(PG::UndefinedTable) || e.cause.is_a?(PG::UndefinedTable)
          $stderr.puts ""Skipping db-dependent code: #{polymorphic_name}""
          nil
        end
      end
      self.preloaded = true
    end

    def preload_sti!
      types_in_db = \
        base_class
          .unscoped
          .select(inheritance_column)
          .distinct
          .pluck(inheritance_column)
          .compact - deleted_sti_models

      logger ||= Rails.logger
      types_in_db.each do |type|
        logger&.debug(""Preloading STI type #{type}"")
        begin
          type.constantize
        rescue NameError
          logger&.warn ""StiPreload: type class not found: table_name=#{table_name} type_name=#{type}. (ActiveRecord::SubclassNotFound)""
          Rails.env.production? ? raise : nil
        end
      end
    end
  end
end

=begin
module AppConfig
  extend self

  def when_not_eager_loading(&block)
    return :not_eager_loading if is_eager_loaded_env?
    Rails.application.configure do
      config.after_initialize(&block)
    end
  end

  # NOTE(BF): tasks which require ""config/environment"" won't have required ""config/boot""
  # which means that config.eager_load may be false when we want to treat it as true, as
  # for example, with StiPreload, which we don't want to run during the `rake release` task
  # or `rake assets:precompile`.
  def is_eager_loaded_env?
    return @is_eager_loaded_env if defined?(@is_eager_loaded_env)
    @is_eager_loaded_env = Rails.application.config.eager_load || %w[production staging].include?(Rails.env)
  end
end
=end
```

Example code I'm using right now, but I think this can be better handled via callbacks, which I""m exploring

```ruby
  def self.inherited(base)
    return super if respond_to?(:after_load_schema_hooks)
    base.instance_eval <<~CLASS_METHODS, __FILE__, __LINE__ + 1
      class_attribute :after_load_schema_hooks, default: []

      def self.after_load_schema_hook(hook_context, &block)
        after_load_schema_hooks << [hook_context, block]
      end

      # # Define hooks which run after the record class first connects to the database
      alias without_after_load_schema_hooks load_schema
      def self.load_schema
        return if schema_loaded?
        without_after_load_schema_hooks.tap do |result|
          next unless result
          after_load_schema_hooks.each do |(hook_context, block)|
            # Rails.logger.debug { ""[AFTER LOAD_SCHEMA HOOKS] running"" }
            hook_context.instance_exec(&block)
          end
        end
      end
    CLASS_METHODS
    super
  end
```

Known gems using this general pattern

- [validates_by_schema](https://github.com/joshwlewis/validates_by_schema/blob/548399d2671797326d85fbe845ada234c18240a2/lib/validates_by_schema.rb)
- [acts-as-taggable-on](https://github.com/mbleigh/acts-as-taggable-on/blob/e0f859edd2c1f5d1d62f612478e11da8625e94bd/lib/acts_as_taggable_on/taggable/cache.rb)

Related code and PRs I'm looking at

- https://github.com/rails/rails/blob/1891a3ffcc123de89c47011f36c547354c669481/activerecord/lib/active_record/model_schema.rb#L562-L596
- https://github.com/rails/rails/blob/ea7a206c1dc8a48d1d4216be3b721fd16e680462/activemodel/lib/active_model/callbacks.rb#L109-L126
- https://github.com/rails/rails/blob/f95c0b7e96eb36bc3efc0c5beffbb9e84ea664e4/activerecord/lib/active_record/attributes.rb#L263-L269
- https://github.com/rails/rails/pull/43105
- https://github.com/rails/rails/pull/45734
- https://github.com/rails/rails/pull/37288
- https://github.com/rails/rails/pull/39467 and https://github.com/rails/rails/pull/38871 (not merged, but interesting)
- Same idea but rejected implementation https://github.com/rails/rails/pull/31681
- https://github.com/rails/rails/pull/29216

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.","{'url': 'https://api.github.com/repos/rails/rails/issues/46205/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46205/timeline,,
https://api.github.com/repos/rails/rails/issues/46191,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46191/labels{/name},https://api.github.com/repos/rails/rails/issues/46191/comments,https://api.github.com/repos/rails/rails/issues/46191/events,https://github.com/rails/rails/pull/46191,1396061802,PR_kwDNIULOQB_gYg,46191,Enable `Layout/DefEndAlignment` cop,"{'login': 'yahonda', 'id': 73684, 'node_id': 'MDQ6VXNlcjczNjg0', 'avatar_url': 'https://avatars.githubusercontent.com/u/73684?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/yahonda', 'html_url': 'https://github.com/yahonda', 'followers_url': 'https://api.github.com/users/yahonda/followers', 'following_url': 'https://api.github.com/users/yahonda/following{/other_user}', 'gists_url': 'https://api.github.com/users/yahonda/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/yahonda/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/yahonda/subscriptions', 'organizations_url': 'https://api.github.com/users/yahonda/orgs', 'repos_url': 'https://api.github.com/users/yahonda/repos', 'events_url': 'https://api.github.com/users/yahonda/events{/privacy}', 'received_events_url': 'https://api.github.com/users/yahonda/received_events', 'type': 'User', 'site_admin': False}",[],open,False,,[],,1,2022-10-04T11:00:22Z,2022-10-05T08:14:25Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46191', 'html_url': 'https://github.com/rails/rails/pull/46191', 'diff_url': 'https://github.com/rails/rails/pull/46191.diff', 'patch_url': 'https://github.com/rails/rails/pull/46191.patch', 'merged_at': None}","### Motivation / Background

This pull request enables `Layout/DefEndAlignment` cop to avoid future `warning: mismatched indentations`.

### Detail

- After reverting the merge commit via #46188

```ruby
$ git revert -m 1 4328d0e16028a46bba79ab775e509a743ceaf18c
[enable_layout_def_end_alignment 8445594965] Revert ""Merge pull request #46188 from yahonda/follow_up_45081""
 1 file changed, 1 insertion(+), 1 deletion(-)
$ bundle exec rubocop
Inspecting 3041 files
... snip ...
Offenses:

activerecord/test/cases/query_logs_formatter_test.rb:10:5: W: [Correctable] Layout/DefEndAlignment: end at 10, 4 is not aligned with def at 6, 2.
    end
    ^^^

3041 files inspected, 1 offense detected, 1 offense auto-correctable
$
```

### Additional information

Follow-up #46188


### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [ ] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [ ] Tests are added if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
","{'url': 'https://api.github.com/repos/rails/rails/issues/46191/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46191/timeline,,
https://api.github.com/repos/rails/rails/issues/46170,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46170/labels{/name},https://api.github.com/repos/rails/rails/issues/46170/comments,https://api.github.com/repos/rails/rails/issues/46170/events,https://github.com/rails/rails/pull/46170,1393567301,PR_kwDNIULOP_8mGg,46170,Fix dev initializer logs not going to stdout,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-10-01T22:04:42Z,2023-09-28T14:57:31Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46170', 'html_url': 'https://github.com/rails/rails/pull/46170', 'diff_url': 'https://github.com/rails/rails/pull/46170.diff', 'patch_url': 'https://github.com/rails/rails/pull/46170.patch', 'merged_at': None}","### Motivation / Background

Previously, the Rails server and console commands would broadcast logs to STDOUT if the Rails.logger was not already logging to STDOUT/STDERR. However, the broadcast was setup after initialization had finished, so some logs may not have been broadcast. More specifically, anything logged during initialization after the :initialize_logger initializer would not be logged to STDOUT.

This is an issue especially because of how common it is for deprecation warnings to be logged during initialization. Very important deprecation warnings such as :warn_if_autoloaded in Rails 6/6.1 would not be logged to STDOUT even though application logs after initialization would.

This is very confusing because users most likely assumed that development logs were identical between STDOUT and log/development.log when they were actually not.

### Detail

This commit fixes the issue by broadcasting when the logger is set up, so that STDOUT and log/development.log will both log everything.

### Additional information

Ref #44800 as this also fixes the STDERR/STDOUT duplicate logs if Rails.logger is configured to output to STDERR

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [ ] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.","{'url': 'https://api.github.com/repos/rails/rails/issues/46170/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46170/timeline,,
https://api.github.com/repos/rails/rails/issues/46159,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46159/labels{/name},https://api.github.com/repos/rails/rails/issues/46159/comments,https://api.github.com/repos/rails/rails/issues/46159/events,https://github.com/rails/rails/pull/46159,1391771615,PR_kwDNIULOP-dICA,46159,Fix `upsert_all` for PostgreSQL json columns when `record_timestamps: true`,"{'login': 'ruipserra', 'id': 3883777, 'node_id': 'MDQ6VXNlcjM4ODM3Nzc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3883777?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ruipserra', 'html_url': 'https://github.com/ruipserra', 'followers_url': 'https://api.github.com/users/ruipserra/followers', 'following_url': 'https://api.github.com/users/ruipserra/following{/other_user}', 'gists_url': 'https://api.github.com/users/ruipserra/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ruipserra/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ruipserra/subscriptions', 'organizations_url': 'https://api.github.com/users/ruipserra/orgs', 'repos_url': 'https://api.github.com/users/ruipserra/repos', 'events_url': 'https://api.github.com/users/ruipserra/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ruipserra/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-09-30T03:34:27Z,2022-12-05T17:17:41Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46159', 'html_url': 'https://github.com/rails/rails/pull/46159', 'diff_url': 'https://github.com/rails/rails/pull/46159.diff', 'patch_url': 'https://github.com/rails/rails/pull/46159.patch', 'merged_at': None}","### Motivation / Background

`upsert_all` uses a SQL `CASE` statement to determine whether the record's `updated_at` timestamp should be touched (#37627).

However, the `CASE` condition does not support `json` columns on PostgreSQL, [since comparison operators are not supported for the `json` data type](https://www.postgresql.org/docs/current/functions-json.html#FUNCTIONS-JSON-PROCESSING).

> [...] the usual comparison operators shown in [Table 9.1](https://www.postgresql.org/docs/current/functions-comparison.html#FUNCTIONS-COMPARISON-OP-TABLE) are available for `jsonb`, though not for `json`.

Attempting to run an upsert with a `json` column would run into an error:

```
ERROR:  operator does not exist: json = json (PG::UndefinedFunction)
```

### Detail

This PR adds an explicit `jsonb` type cast on `json` columns within that `CASE` condition. This allows the query to succeed.

### Checklist

Before submitting the PR make sure the following are checked:

* [X] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [X] There are no typos in commit messages and comments.
* [X] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [X] Feature branch is up-to-date with `main` (if not - rebase it).
* [X] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [X] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [X] PR is not in a draft state.
* [X] CI is passing.
","{'url': 'https://api.github.com/repos/rails/rails/issues/46159/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46159/timeline,,
https://api.github.com/repos/rails/rails/issues/46116,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46116/labels{/name},https://api.github.com/repos/rails/rails/issues/46116/comments,https://api.github.com/repos/rails/rails/issues/46116/events,https://github.com/rails/rails/pull/46116,1383647409,PR_kwDNIULOP32OBw,46116,Use native `Element.matches` in UJS,"{'login': '007lva', 'id': 1860816, 'node_id': 'MDQ6VXNlcjE4NjA4MTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1860816?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/007lva', 'html_url': 'https://github.com/007lva', 'followers_url': 'https://api.github.com/users/007lva/followers', 'following_url': 'https://api.github.com/users/007lva/following{/other_user}', 'gists_url': 'https://api.github.com/users/007lva/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/007lva/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/007lva/subscriptions', 'organizations_url': 'https://api.github.com/users/007lva/orgs', 'repos_url': 'https://api.github.com/users/007lva/repos', 'events_url': 'https://api.github.com/users/007lva/events{/privacy}', 'received_events_url': 'https://api.github.com/users/007lva/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2022-09-23T11:11:45Z,2023-04-07T14:17:37Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46116', 'html_url': 'https://github.com/rails/rails/pull/46116', 'diff_url': 'https://github.com/rails/rails/pull/46116.diff', 'patch_url': 'https://github.com/rails/rails/pull/46116.patch', 'merged_at': None}","**Summary**

I've notice in https://github.com/rails/rails/pull/45546 that there is some unnecessary complexity in `Rails.matches` implementation. `Element.matches` is well supported by all browsers since several years ago, so I've simplified to just rely on `Element.matches`, and avoiding to import `Rails.matches` where is not necessary.

**Other Information**

https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#browser_compatibility
![Screen Shot 2022-09-23 at 13 03 04](https://user-images.githubusercontent.com/1860816/191947217-a85e3f06-3595-43a2-a37e-d01f044bc0f6.png)
","{'url': 'https://api.github.com/repos/rails/rails/issues/46116/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46116/timeline,,
https://api.github.com/repos/rails/rails/issues/46098,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46098/labels{/name},https://api.github.com/repos/rails/rails/issues/46098/comments,https://api.github.com/repos/rails/rails/issues/46098/events,https://github.com/rails/rails/pull/46098,1382373622,PR_kwDNIULOP2z3QA,46098,Move test:prepare task to misc.rake in railties,"{'login': 'simmerz', 'id': 24327, 'node_id': 'MDQ6VXNlcjI0MzI3', 'avatar_url': 'https://avatars.githubusercontent.com/u/24327?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/simmerz', 'html_url': 'https://github.com/simmerz', 'followers_url': 'https://api.github.com/users/simmerz/followers', 'following_url': 'https://api.github.com/users/simmerz/following{/other_user}', 'gists_url': 'https://api.github.com/users/simmerz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/simmerz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/simmerz/subscriptions', 'organizations_url': 'https://api.github.com/users/simmerz/orgs', 'repos_url': 'https://api.github.com/users/simmerz/repos', 'events_url': 'https://api.github.com/users/simmerz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/simmerz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,9,2022-09-22T12:31:28Z,2022-12-09T13:51:05Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46098', 'html_url': 'https://github.com/rails/rails/pull/46098', 'diff_url': 'https://github.com/rails/rails/pull/46098.diff', 'patch_url': 'https://github.com/rails/rails/pull/46098.patch', 'merged_at': None}","I've moved the `test:prepare` task from the TestUnit railties into the core misc.rake. I hope this is the right place for it. This fixes #45431 .

Where is the best place for documenting this as a public interface that can be used by other packages to latch on to?","{'url': 'https://api.github.com/repos/rails/rails/issues/46098/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46098/timeline,,
https://api.github.com/repos/rails/rails/issues/46084,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46084/labels{/name},https://api.github.com/repos/rails/rails/issues/46084/comments,https://api.github.com/repos/rails/rails/issues/46084/events,https://github.com/rails/rails/issues/46084,1379588419,I_kwDNIULOUjrZQw,46084,Tags leak across broadcasted loggers,"{'login': 'thomasgt', 'id': 7901427, 'node_id': 'MDQ6VXNlcjc5MDE0Mjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7901427?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/thomasgt', 'html_url': 'https://github.com/thomasgt', 'followers_url': 'https://api.github.com/users/thomasgt/followers', 'following_url': 'https://api.github.com/users/thomasgt/following{/other_user}', 'gists_url': 'https://api.github.com/users/thomasgt/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/thomasgt/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/thomasgt/subscriptions', 'organizations_url': 'https://api.github.com/users/thomasgt/orgs', 'repos_url': 'https://api.github.com/users/thomasgt/repos', 'events_url': 'https://api.github.com/users/thomasgt/events{/privacy}', 'received_events_url': 'https://api.github.com/users/thomasgt/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,6,2022-09-20T15:13:04Z,2023-06-30T13:30:48Z,,NONE,,,,"I'm trying to create a tagged logger (`final_logger`) from another tagged logger (`tagged_logger2`) that is receiving broadcasts from yet another tagged logger (`tagged_logger1`). This situation triggers an odd behaviour: tags applied to `final_logger` leak upstream to the original `tagged_logger1`.

### Steps to reproduce
To reproduce, run this test case (it can be found on my fork [here](https://github.com/thomasgt/rails/commit/ac1f54e9e9ce6ee59e2fdf2726d12de05c9c0388#diff-a740708edc01d60720000d36718813f8a53ffbafc0e5312d4219e0d5d3c78fb6)):
```ruby
  test ""tags do not leak across loggers"" do
    sink1 = StringIO.new
    sink2 = StringIO.new

    tagged_logger1 = ActiveSupport::TaggedLogging.new(ActiveSupport::Logger.new(sink1))
    tagged_logger2 = ActiveSupport::TaggedLogging.new(ActiveSupport::Logger.new(sink2))
    tagged_logger2.extend(ActiveSupport::Logger.broadcast(tagged_logger1))

    final_logger = ActiveSupport::TaggedLogging.new(tagged_logger2).tagged(""test"")

    tagged_logger1.info(""foo"") # should write ""foo"" to sink1
    tagged_logger2.info(""bar"") # should write ""bar"" to sink1 (via broadcast) and ""bar"" to sink2
    final_logger.info(""baz"")   # should write ""baz"" to sink1 (via broadcast) and ""[test] baz"" to sink2

    sink1_lines = sink1.string.each_line.to_a
    sink2_lines = sink2.string.each_line.to_a

    assert_equal 3, sink1_lines.length
    assert_equal 2, sink2_lines.length

    assert_equal ""foo\n"", sink1_lines[0]
    assert_equal ""bar\n"", sink1_lines[1]
    assert_equal ""baz\n"", sink1_lines[2]

    assert_equal ""bar\n"", sink2_lines[0]
    assert_equal ""[test] baz\n"", sink2_lines[1]
  end
```

### Expected behavior
I would expect this test to pass.

### Actual behavior
The assertions on the logs in `sink1` fail; they are prefixed with ""[test]"":
```
Failure:
TaggedLoggingWithoutBlockTest#test_tags_do_not_leak_across_loggers [/Users/thomasgt/src/github.com/thomasgt/rails/activesupport/test/tagged_logging_test.rb:250]:
--- expected
+++ actual
@@ -1,2 +1,2 @@
-""foo
+""[test] foo
 ""
```

### System configuration
We originally thought this bug was related to this [PR](https://github.com/rails/rails/pull/44695). It was [reverted](https://github.com/rails/rails/commit/ff277583e22ddfbcfbd2131789a7cb7c2f868d68), but the problem persists. Our thinking now is that the PR re-implemented the bug in a different way, so reverting had no effect.

**Rails version**:
* After revert: https://github.com/thomasgt/rails/tree/logger-leak-1
* Before revert: https://github.com/thomasgt/rails/tree/logger-leak-2

**Ruby version**:
3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46084/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46084/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/46047,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46047/labels{/name},https://api.github.com/repos/rails/rails/issues/46047/comments,https://api.github.com/repos/rails/rails/issues/46047/events,https://github.com/rails/rails/pull/46047,1375036579,PR_kwDNIULOPw1smQ,46047,Warn if frameworks are loaded too early,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,24,2022-09-15T20:16:36Z,2023-01-16T21:43:45Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/46047', 'html_url': 'https://github.com/rails/rails/pull/46047', 'diff_url': 'https://github.com/rails/rails/pull/46047.diff', 'patch_url': 'https://github.com/rails/rails/pull/46047.patch', 'merged_at': None}","Prematurely loading frameworks in a Rails application may slow down boot time and could cause conflicts with load order and boot of the application. It is a common problem in gems:
- https://github.com/ViewComponent/view_component/issues/1507
- https://github.com/collectiveidea/delayed_job_active_record/issues/185

This change allows showing a warning in a load hook if a required
framework or load hook hasn't been loaded yet:

```ruby
  initializer ""active_record.premature_loading_check"" do
    ActiveSupport.on_load(:active_record) do
      ActiveSupport.warn_if_prematurely_loaded(:active_record, before: :after_initialize)
    end
  end
```

In this case if `:active_record` is loaded before `:after_initialize`
has run we show a warning:

      Load hook :active_record was called before load hook :after_initialize.
      Prematurely loading frameworks may slow down your boot time and could
      cause conflicts with load order and boot of your application.

      Consider wrapping your code with an on_load hook:

          ActiveSupport.on_load(:active_record) do
            # your code
          end
      Called from:
      config/initializers/some_initializer.rb:1:in `<main>'
      ...

In production `eager_load` gets called to load add frameworks and we
should silence the warning. A `silence_prematurely_loading_warnings` has
been added to silence all load hook order warnings. This
`silence_prematurely_loading_warnings` is called before `eager_load`
gets called.

The hook has been implemented for ActiveRecord but other frameworks,
like ActionView for example, could use it as well.

Some tests include initializers that call ActiveRecord::Base. To not
show the warning `silence_prematurely_loading_warnings` has been added
to the initializers.

### Additional information

`ActiveRecord` should be loaded after `:after_initialize` has run, so I've added an initializer to add the load_hook order in the railtie. For other frameworks like ActionView and ActionPack it should probably be added as well.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.","{'url': 'https://api.github.com/repos/rails/rails/issues/46047/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46047/timeline,,
https://api.github.com/repos/rails/rails/issues/46003,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/46003/labels{/name},https://api.github.com/repos/rails/rails/issues/46003/comments,https://api.github.com/repos/rails/rails/issues/46003/events,https://github.com/rails/rails/issues/46003,1369554829,I_kwDNIULOUaG_jQ,46003,"The response for ActionDispatch::RemoteIp::IpSpoofAttackError is not 4xx, but 500","{'login': 'willnet', 'id': 82371, 'node_id': 'MDQ6VXNlcjgyMzcx', 'avatar_url': 'https://avatars.githubusercontent.com/u/82371?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/willnet', 'html_url': 'https://github.com/willnet', 'followers_url': 'https://api.github.com/users/willnet/followers', 'following_url': 'https://api.github.com/users/willnet/following{/other_user}', 'gists_url': 'https://api.github.com/users/willnet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/willnet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/willnet/subscriptions', 'organizations_url': 'https://api.github.com/users/willnet/orgs', 'repos_url': 'https://api.github.com/users/willnet/repos', 'events_url': 'https://api.github.com/users/willnet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/willnet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,13,2022-09-12T09:23:19Z,2023-06-10T19:18:11Z,,CONTRIBUTOR,,,,"On IpSpoofAttackError raising, I want rails to return 4xx since it is a client-side problem.
Since the ActionDispatch::RemoteIp middleware is located before ActionDispatch::ShowExceptions, We cannot define the behavior when the exception raises with `config.action_dispatch.rescue_responses`.

ActionDispatch::HostAuthorization is also located before ActionDispatch::ShowExceptions, but it has its own Rack application to return 403 on exceptions. Maybe ActionDispatch::RemoteIp should have its own Rack appilcation as well.



### Steps to reproduce

```shell
rails new sampleapp
cd sampleapp
rails s -d
curl localhost:3000 -H ""X-Forwarded-For: 1.2.3.4"" -H ""Client-Ip: 5.6.7.8"" -I
```

### Expected behavior

response 4xx

### Actual behavior

```
HTTP/1.1 500 Internal Server Error
Content-Length: 4602
```


### System configuration
**Rails version**: 7.0.4

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/46003/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/46003/timeline,,
https://api.github.com/repos/rails/rails/issues/45993,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45993/labels{/name},https://api.github.com/repos/rails/rails/issues/45993/comments,https://api.github.com/repos/rails/rails/issues/45993/events,https://github.com/rails/rails/pull/45993,1368551353,PR_kwDNIULOPrc2Uw,45993,Added ability to resize email previews for better testing + ability t,"{'login': 'igorkasyanchuk', 'id': 11101, 'node_id': 'MDQ6VXNlcjExMTAx', 'avatar_url': 'https://avatars.githubusercontent.com/u/11101?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/igorkasyanchuk', 'html_url': 'https://github.com/igorkasyanchuk', 'followers_url': 'https://api.github.com/users/igorkasyanchuk/followers', 'following_url': 'https://api.github.com/users/igorkasyanchuk/following{/other_user}', 'gists_url': 'https://api.github.com/users/igorkasyanchuk/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/igorkasyanchuk/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/igorkasyanchuk/subscriptions', 'organizations_url': 'https://api.github.com/users/igorkasyanchuk/orgs', 'repos_url': 'https://api.github.com/users/igorkasyanchuk/repos', 'events_url': 'https://api.github.com/users/igorkasyanchuk/events{/privacy}', 'received_events_url': 'https://api.github.com/users/igorkasyanchuk/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2022-09-10T08:36:12Z,2022-09-10T17:50:41Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45993', 'html_url': 'https://github.com/rails/rails/pull/45993', 'diff_url': 'https://github.com/rails/rails/pull/45993.diff', 'patch_url': 'https://github.com/rails/rails/pull/45993.patch', 'merged_at': None}","### Motivation / Background

The motivation is to add the ability to test email previews on the different resolutions, plus an easier way to see the source of the email.

<img width=""809"" alt=""image"" src=""https://user-images.githubusercontent.com/11101/189475652-a0d4d44c-456b-4d6e-bbb9-e7568959fa8d.png"">
<img width=""795"" alt=""image"" src=""https://user-images.githubusercontent.com/11101/189475657-8c2e648e-741d-419b-b8ae-3f102c548f8e.png"">
<img width=""812"" alt=""image"" src=""https://user-images.githubusercontent.com/11101/189475671-06bce8b6-6969-4f08-86ac-22fa7488d86a.png"">

Since we are showing ""iframe"" with email content, with these changes we just changing the width of it.

### Detail

This Pull Request changes [REPLACE ME]

### Additional information

<!-- Provide additional information such as benchmarks, reference to other repositories or alternative solutions. -->

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] There are no typos in commit messages and comments.
* [ ] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Feature branch is up-to-date with `main` (if not - rebase it).
* [x] Pull request only contains one commit for bug fixes and small features. If it's a larger feature, multiple commits are permitted but must be descriptive.
* [x] Tests are added if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.
* [x] PR is not in a draft state.
* [x] CI is passing.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).

If your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45993/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45993/timeline,,
https://api.github.com/repos/rails/rails/issues/45967,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45967/labels{/name},https://api.github.com/repos/rails/rails/issues/45967/comments,https://api.github.com/repos/rails/rails/issues/45967/events,https://github.com/rails/rails/issues/45967,1366038829,I_kwDNIULOUWwZLQ,45967,Inconsistent update of timestamps while updating associations with *_ids=,"{'login': 'matthee', 'id': 547653, 'node_id': 'MDQ6VXNlcjU0NzY1Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/547653?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthee', 'html_url': 'https://github.com/matthee', 'followers_url': 'https://api.github.com/users/matthee/followers', 'following_url': 'https://api.github.com/users/matthee/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthee/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthee/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthee/subscriptions', 'organizations_url': 'https://api.github.com/users/matthee/orgs', 'repos_url': 'https://api.github.com/users/matthee/repos', 'events_url': 'https://api.github.com/users/matthee/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthee/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2022-09-08T10:51:09Z,2023-08-21T23:55:22Z,,CONTRIBUTOR,,,,"ActiveRecord inconsistently updates the `updated_at` column when changing `has_many through:` associations.

### Steps to reproduce

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.0.0""
  gem ""activesupport"", ""~> 7.0.0""
  gem ""sqlite3""
end

require ""active_record""
require ""active_support/testing/time_helpers""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.timestamps
  end
  
  create_table :tags, force: true do |t|
  end

  create_table :taggings, force: true do |t|
    t.integer :post_id
    t.integer :tag_id
  end
end

class Post < ActiveRecord::Base
  has_many :taggings, dependent: :destroy
  
  has_many :tags, through: :taggings
end

class Tagging < ActiveRecord::Base
  belongs_to :post, touch: true
  belongs_to :tag
end

class Tag < ActiveRecord::Base
  has_many :taggings
  has_many :posts, through: :taggings
end

class BugTest < Minitest::Test
  include ActiveSupport::Testing::TimeHelpers
  
  def test_updated_at_is_updated_when_setting_has_many_through_association
    freeze_time
        
    tag_1 = Tag.create!
    tag_2 = Tag.create!
      
    post = Post.create!
    
    travel_to(now = 1.hour.from_now)
    
    # Adding tags updates post.updated_at
    post.update(tag_ids: [tag_1.id, tag_2.id])
    assert_in_delta now, post.updated_at, 1.second, ""post#updated_at was not updated when adding tags""
    
    # Removing tags does not update post.updated_at :(
    travel_to(now = 2.hours.from_now)
    post.update(tag_ids: [tag_1.id])
    assert_in_delta now, post.updated_at, 1.second, ""post#updated_at was not updated when removing tags""
  end
  
end
```

### Expected behavior

In the example above, both `.update` calls should update the `updated_at` column of the post record. (when adding and removing records)

### Actual behavior

When deleting a record, the `updated_at` timestamp is not updated.

### System configuration
**Rails version**:
7.0.3.1
**Ruby version**:
3.0.2","{'url': 'https://api.github.com/repos/rails/rails/issues/45967/reactions', 'total_count': 3, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 3}",https://api.github.com/repos/rails/rails/issues/45967/timeline,,
https://api.github.com/repos/rails/rails/issues/45958,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45958/labels{/name},https://api.github.com/repos/rails/rails/issues/45958/comments,https://api.github.com/repos/rails/rails/issues/45958/events,https://github.com/rails/rails/pull/45958,1364025826,PR_kwDNIULOPnpUzA,45958,WIP: Add a cache per-request partial lookup cache to lookup context,"{'login': 'jhawthorn', 'id': 131752, 'node_id': 'MDQ6VXNlcjEzMTc1Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/131752?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jhawthorn', 'html_url': 'https://github.com/jhawthorn', 'followers_url': 'https://api.github.com/users/jhawthorn/followers', 'following_url': 'https://api.github.com/users/jhawthorn/following{/other_user}', 'gists_url': 'https://api.github.com/users/jhawthorn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jhawthorn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jhawthorn/subscriptions', 'organizations_url': 'https://api.github.com/users/jhawthorn/orgs', 'repos_url': 'https://api.github.com/users/jhawthorn/repos', 'events_url': 'https://api.github.com/users/jhawthorn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jhawthorn/received_events', 'type': 'User', 'site_admin': True}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-09-07T03:07:13Z,2022-09-07T07:19:06Z,,MEMBER,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45958', 'html_url': 'https://github.com/rails/rails/pull/45958', 'diff_url': 'https://github.com/rails/rails/pull/45958.diff', 'patch_url': 'https://github.com/rails/rails/pull/45958.patch', 'merged_at': None}","This adds a fast path for partial lookup on ""simple"" partial renders.

In this case ""simple"" means:
1. This is a plain partial render, like `render ""foo"", {...}` or `render partial: ""foo"", locals: {...}` 
2. No details are specified (format, handler, locale, variant)
3. No block is given (the ""layout"" form)

When this is the case, this allows a few improvements:
1. We cache any simple partial we find in the LookupContext. The LookupContext should only exists for the length of the request and the cache is cleared whenever any details, prefixes, or template paths are changed on the lookup context.
2. We go through a new `SimplePartialRenderer` class, which skips some of the work done in the regular `PartialRenderer` (string manipulation of the path/prefix, and building an hash for the options). A relatively minor optimization compared to 1, but very measurable.

cc @byroot ","{'url': 'https://api.github.com/repos/rails/rails/issues/45958/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45958/timeline,,
https://api.github.com/repos/rails/rails/issues/45954,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45954/labels{/name},https://api.github.com/repos/rails/rails/issues/45954/comments,https://api.github.com/repos/rails/rails/issues/45954/events,https://github.com/rails/rails/pull/45954,1363869828,PR_kwDNIULOPnhOfA,45954,Extract h1 headings from ActionText content,"{'login': 'equivalent', 'id': 721990, 'node_id': 'MDQ6VXNlcjcyMTk5MA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/721990?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/equivalent', 'html_url': 'https://github.com/equivalent', 'followers_url': 'https://api.github.com/users/equivalent/followers', 'following_url': 'https://api.github.com/users/equivalent/following{/other_user}', 'gists_url': 'https://api.github.com/users/equivalent/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/equivalent/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/equivalent/subscriptions', 'organizations_url': 'https://api.github.com/users/equivalent/orgs', 'repos_url': 'https://api.github.com/users/equivalent/repos', 'events_url': 'https://api.github.com/users/equivalent/events{/privacy}', 'received_events_url': 'https://api.github.com/users/equivalent/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,2,2022-09-06T22:14:16Z,2022-09-28T20:20:12Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45954', 'html_url': 'https://github.com/rails/rails/pull/45954', 'diff_url': 'https://github.com/rails/rails/pull/45954.diff', 'patch_url': 'https://github.com/rails/rails/pull/45954.patch', 'merged_at': None}","### Summary

similar way how it's possible to extract ActionText Content links:

```
class Post < ApplicationRecord
  has_rich_text :content
end

 Post.last.content.body.links
# => [""http://localhost:3000/whatever""] 
``` 

... it would be awesome if we could extract h1 headings:

```
Post.last.content.body.headings
# => [""Hello Rails""] 
``` 

My use-case is that I want to extract title for post from the wysiwyg content

```
class Post < ApplicationRecord
  has_rich_text :content

  def title
    content.body.headings.first
  end
end
```
 


","{'url': 'https://api.github.com/repos/rails/rails/issues/45954/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45954/timeline,,
https://api.github.com/repos/rails/rails/issues/45943,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45943/labels{/name},https://api.github.com/repos/rails/rails/issues/45943/comments,https://api.github.com/repos/rails/rails/issues/45943/events,https://github.com/rails/rails/pull/45943,1361477047,PR_kwDNIULOPlhFdA,45943,Reset AR::Relation in bulk insert and upsert methods,"{'login': 'quadule', 'id': 15299, 'node_id': 'MDQ6VXNlcjE1Mjk5', 'avatar_url': 'https://avatars.githubusercontent.com/u/15299?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/quadule', 'html_url': 'https://github.com/quadule', 'followers_url': 'https://api.github.com/users/quadule/followers', 'following_url': 'https://api.github.com/users/quadule/following{/other_user}', 'gists_url': 'https://api.github.com/users/quadule/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/quadule/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/quadule/subscriptions', 'organizations_url': 'https://api.github.com/users/quadule/orgs', 'repos_url': 'https://api.github.com/users/quadule/repos', 'events_url': 'https://api.github.com/users/quadule/events{/privacy}', 'received_events_url': 'https://api.github.com/users/quadule/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-09-05T06:43:31Z,2022-09-05T06:43:34Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45943', 'html_url': 'https://github.com/rails/rails/pull/45943', 'diff_url': 'https://github.com/rails/rails/pull/45943.diff', 'patch_url': 'https://github.com/rails/rails/pull/45943.patch', 'merged_at': None}","This adds a call to `reset` when `insert_all` or `upsert_all` are used on a relation object, matching the behavior of `update_all` added in #41789.","{'url': 'https://api.github.com/repos/rails/rails/issues/45943/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45943/timeline,,
https://api.github.com/repos/rails/rails/issues/45941,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45941/labels{/name},https://api.github.com/repos/rails/rails/issues/45941/comments,https://api.github.com/repos/rails/rails/issues/45941/events,https://github.com/rails/rails/pull/45941,1361175243,PR_kwDNIULOPlSErw,45941,Added `blob_url` to the response of direct uploads API,"{'login': 'AbhayVAshokan', 'id': 35297280, 'node_id': 'MDQ6VXNlcjM1Mjk3Mjgw', 'avatar_url': 'https://avatars.githubusercontent.com/u/35297280?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/AbhayVAshokan', 'html_url': 'https://github.com/AbhayVAshokan', 'followers_url': 'https://api.github.com/users/AbhayVAshokan/followers', 'following_url': 'https://api.github.com/users/AbhayVAshokan/following{/other_user}', 'gists_url': 'https://api.github.com/users/AbhayVAshokan/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/AbhayVAshokan/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/AbhayVAshokan/subscriptions', 'organizations_url': 'https://api.github.com/users/AbhayVAshokan/orgs', 'repos_url': 'https://api.github.com/users/AbhayVAshokan/repos', 'events_url': 'https://api.github.com/users/AbhayVAshokan/events{/privacy}', 'received_events_url': 'https://api.github.com/users/AbhayVAshokan/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-09-04T15:06:23Z,2022-09-04T15:13:36Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45941', 'html_url': 'https://github.com/rails/rails/pull/45941', 'diff_url': 'https://github.com/rails/rails/pull/45941.diff', 'patch_url': 'https://github.com/rails/rails/pull/45941.patch', 'merged_at': None}","### Summary

- Added `blob_url` to the response of the `create` action of the  `ActiveStorage::DirectUploadsController`. 
- This will be very useful for API-only applications where the uploaded files (usually images/videos) need to be immediately rendered in the frontend. Once the file upload is complete, the client need not send another API to the backend to fetch the blob URL.

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

<!-- ### Other Information -->

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45941/reactions', 'total_count': 3, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 1, 'confused': 0, 'heart': 1, 'rocket': 1, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45941/timeline,,
https://api.github.com/repos/rails/rails/issues/45906,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45906/labels{/name},https://api.github.com/repos/rails/rails/issues/45906/comments,https://api.github.com/repos/rails/rails/issues/45906/events,https://github.com/rails/rails/issues/45906,1355732552,I_kwDNIULOUM7WSA,45906,High object allocation count from `ActiveRecord::ConnectionAdapters::PoolManager#pool_configs `,"{'login': 'amarchenkoshopify', 'id': 101111422, 'node_id': 'U_kgDOBgbWfg', 'avatar_url': 'https://avatars.githubusercontent.com/u/101111422?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/amarchenkoshopify', 'html_url': 'https://github.com/amarchenkoshopify', 'followers_url': 'https://api.github.com/users/amarchenkoshopify/followers', 'following_url': 'https://api.github.com/users/amarchenkoshopify/following{/other_user}', 'gists_url': 'https://api.github.com/users/amarchenkoshopify/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/amarchenkoshopify/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/amarchenkoshopify/subscriptions', 'organizations_url': 'https://api.github.com/users/amarchenkoshopify/orgs', 'repos_url': 'https://api.github.com/users/amarchenkoshopify/repos', 'events_url': 'https://api.github.com/users/amarchenkoshopify/events{/privacy}', 'received_events_url': 'https://api.github.com/users/amarchenkoshopify/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,"{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]","{'url': 'https://api.github.com/repos/rails/rails/milestones/81', 'html_url': 'https://github.com/rails/rails/milestone/81', 'labels_url': 'https://api.github.com/repos/rails/rails/milestones/81/labels', 'id': 7591006, 'node_id': 'MI_kwDNIULOAHPUXg', 'number': 81, 'title': '7.0.4', 'description': '', 'creator': {'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}, 'open_issues': 1, 'closed_issues': 5, 'state': 'open', 'created_at': '2022-01-20T01:51:07Z', 'updated_at': '2023-02-27T14:18:42Z', 'due_on': None, 'closed_at': None}",2,2022-08-30T12:58:42Z,2022-08-31T12:37:42Z,,NONE,,,,"### Steps to reproduce

While working on memory efficiency investigation I noticed that a very big bunch of object allocations comes from a single method `ActiveRecord::ConnectionAdapters::PoolManager#pool_configs`:

```ruby
      def pool_configs(role = nil)
        if role
          @role_to_shard_mapping[role].values
        else
          @role_to_shard_mapping.flat_map { |_, shard_map| shard_map.values }
        end
      end 
```

This method is called on every activerecord operation and does not cache its result: could we think about a way of caching its result?

cc @eileencodes 

### Expected behavior

`#pool_configs` allocates configs once

### Actual behavior

`#pool_configs` allocates configs every time it is executed

### System configuration
**Rails version**: main branch

**Ruby version**: 3.1
","{'url': 'https://api.github.com/repos/rails/rails/issues/45906/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45906/timeline,,
https://api.github.com/repos/rails/rails/issues/45902,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45902/labels{/name},https://api.github.com/repos/rails/rails/issues/45902/comments,https://api.github.com/repos/rails/rails/issues/45902/events,https://github.com/rails/rails/pull/45902,1354601339,PR_kwDNIULOPfyVVQ,45902,Validate option keys passed to #change(),"{'login': 'vlad-pisanov', 'id': 55465196, 'node_id': 'MDQ6VXNlcjU1NDY1MTk2', 'avatar_url': 'https://avatars.githubusercontent.com/u/55465196?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/vlad-pisanov', 'html_url': 'https://github.com/vlad-pisanov', 'followers_url': 'https://api.github.com/users/vlad-pisanov/followers', 'following_url': 'https://api.github.com/users/vlad-pisanov/following{/other_user}', 'gists_url': 'https://api.github.com/users/vlad-pisanov/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/vlad-pisanov/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/vlad-pisanov/subscriptions', 'organizations_url': 'https://api.github.com/users/vlad-pisanov/orgs', 'repos_url': 'https://api.github.com/users/vlad-pisanov/repos', 'events_url': 'https://api.github.com/users/vlad-pisanov/events{/privacy}', 'received_events_url': 'https://api.github.com/users/vlad-pisanov/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,3,2022-08-29T16:59:52Z,2022-09-06T16:40:01Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45902', 'html_url': 'https://github.com/rails/rails/pull/45902', 'diff_url': 'https://github.com/rails/rails/pull/45902.diff', 'patch_url': 'https://github.com/rails/rails/pull/45902.patch', 'merged_at': None}","### Summary

`DateTime#change` and `Time#change` receive nearly identical keyword arguments, with one subtle difference: `DateTime#change` also supports `start:`.

The `change` method silently ignores invalid/unsupported keyword arguments, which makes it error-prone to typos and makes transitioning legacy codebases from `DateTime` to `Time` difficult.

The same problem affects related classes `Date` and `TimeWithZone`.

This PR enforces that all arguments passed to `change` are actually supported, and updates a stale comment to include `:nsec` and `:usec` as supported arguments to `DateTime#change`.","{'url': 'https://api.github.com/repos/rails/rails/issues/45902/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45902/timeline,,
https://api.github.com/repos/rails/rails/issues/45864,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45864/labels{/name},https://api.github.com/repos/rails/rails/issues/45864/comments,https://api.github.com/repos/rails/rails/issues/45864/events,https://github.com/rails/rails/pull/45864,1345283993,PR_kwDNIULOPYE-KQ,45864,Add Relation#select_append method to append to default selection.,"{'login': 'simi', 'id': 193936, 'node_id': 'MDQ6VXNlcjE5MzkzNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/193936?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/simi', 'html_url': 'https://github.com/simi', 'followers_url': 'https://api.github.com/users/simi/followers', 'following_url': 'https://api.github.com/users/simi/following{/other_user}', 'gists_url': 'https://api.github.com/users/simi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/simi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/simi/subscriptions', 'organizations_url': 'https://api.github.com/users/simi/orgs', 'repos_url': 'https://api.github.com/users/simi/repos', 'events_url': 'https://api.github.com/users/simi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/simi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,10,2022-08-20T20:37:47Z,2022-08-25T20:05:27Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45864', 'html_url': 'https://github.com/rails/rails/pull/45864', 'diff_url': 'https://github.com/rails/rails/pull/45864.diff', 'patch_url': 'https://github.com/rails/rails/pull/45864.patch', 'merged_at': None}","_:information_source: reopenning https://github.com/rails/rails/pull/39873 per @rafaelfranca request_

### How `select` works

- when **no** `select` is used for query **all columns** are **selected**
- when `select` is used only **selected columns** are **selected**

### Why `select` is not enough?

Often I would like to just append to current selection. Currently I need to check if anything was selected before or select `Arel.star` on my own. But I don't actually care what was selected before, I would like to add new field everytime.

```ruby
# before
User.joins(:account).select(User.arel_table[Arel.star], 'accounts.name AS account_name')
#=> SELECT ""users"".*, accounts.name AS account_name FROM ""users"" INNER JOIN ""accounts"" ON ""accounts"".""id"" = ""users"".""account_id"" LIMIT $1 


# after
User.joins(:account).select_append('accounts.name AS account_name')
#=> SELECT ""users"".*, accounts.name AS account_name FROM ""users"" INNER JOIN ""accounts"" ON ""accounts"".""id"" = ""users"".""account_id"" LIMIT $1
```

### TODO

- [ ] changelog entry
- [ ] documentation

---

:information_source: We are using following monkey-patch in our app for some time already.

```ruby
module ActiveRecord
  module SelectAppend
    extend ActiveSupport::Concern

    included do
      ActiveRecord::Querying.delegate :select_append, to: :all
    end

    def select_append(*fields)
      raise ArgumentError, ""Call `select_append' with at least one field"" if fields.empty?

      self.select_values = [table[Arel.star]] unless self.select_values.present?
      select(*fields)
    end
  end
end
```","{'url': 'https://api.github.com/repos/rails/rails/issues/45864/reactions', 'total_count': 5, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 2, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45864/timeline,,
https://api.github.com/repos/rails/rails/issues/45832,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45832/labels{/name},https://api.github.com/repos/rails/rails/issues/45832/comments,https://api.github.com/repos/rails/rails/issues/45832/events,https://github.com/rails/rails/issues/45832,1339487378,I_kwDNIULOT9b0kg,45832,MySQL 8.0 VARBINARY default value is hexadecimal,"{'login': 'HParker', 'id': 4482399, 'node_id': 'MDQ6VXNlcjQ0ODIzOTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4482399?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/HParker', 'html_url': 'https://github.com/HParker', 'followers_url': 'https://api.github.com/users/HParker/followers', 'following_url': 'https://api.github.com/users/HParker/following{/other_user}', 'gists_url': 'https://api.github.com/users/HParker/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/HParker/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/HParker/subscriptions', 'organizations_url': 'https://api.github.com/users/HParker/orgs', 'repos_url': 'https://api.github.com/users/HParker/repos', 'events_url': 'https://api.github.com/users/HParker/events{/privacy}', 'received_events_url': 'https://api.github.com/users/HParker/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 309390193, 'node_id': 'MDU6TGFiZWwzMDkzOTAxOTM=', 'url': 'https://api.github.com/repos/rails/rails/labels/MySQL', 'name': 'MySQL', 'color': 'fef2c0', 'default': False, 'description': None}]",open,False,,[],,5,2022-08-15T20:42:09Z,2022-12-08T02:40:00Z,,CONTRIBUTOR,,,,"Default values on VARBINARY columns changed behavior between MySQL 5.7 and 8.0

### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""
  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""mysql2""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""mysql2"", database: ""adam_test"", prepared_statements: false, host: '127.0.0.1', port: 3307, user: ""root"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.binary :some_binary, null: false, limit: 1024, default: ""hello-world""
  end
end

class Post < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_mysql_defaults
    post = Post.create!

    mysql_vars = ActiveRecord::Base.connection.select_rows(""SHOW VARIABLES LIKE '%version%'"")
    puts mysql_vars.inspect
    puts Post.column_defaults

    # assert_equal ""0x68656C6C6F2D776F726C64"", post.some_binary # This passes
    assert_equal ""hello-world"", post.some_binary # This fails

    reloaded_post = Post.first
    assert_equal ""hello-world"", reloaded_post.some_binary # this passes
  end
end
```

On MySQL 5.7:

```ruby
Post.column_defaults # => {""id""=>nil, ""some_binary""=>""hello-world""}
```

On MySQL 8.0:

```ruby
Post.column_defaults # => {""id""=>nil, ""some_binary""=>""0x68656C6C6F2D776F726C64""}
```

### Expected behavior

The default value on binary columns should be Ruby strings, not ruby strings of hexadecimal.

### Actual behavior

The column default in MySQL 8.0 is a hexadecimal string representing the binary data.

### System configuration
**Rails version**: main

**Ruby version**: 3.1.0

Some interesting MySQL forum posts about this behavior change:

- https://forums.mysql.com/read.php?24,685577,685577
- https://forums.mysql.com/read.php?20,698061,698061#msg-698061
","{'url': 'https://api.github.com/repos/rails/rails/issues/45832/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45832/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/45830,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45830/labels{/name},https://api.github.com/repos/rails/rails/issues/45830/comments,https://api.github.com/repos/rails/rails/issues/45830/events,https://github.com/rails/rails/issues/45830,1338922250,I_kwDNIULOT85VCg,45830,ActiveRecord Rollbacks on errors which happen on commit,"{'login': 'Baxxx', 'id': 17880055, 'node_id': 'MDQ6VXNlcjE3ODgwMDU1', 'avatar_url': 'https://avatars.githubusercontent.com/u/17880055?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Baxxx', 'html_url': 'https://github.com/Baxxx', 'followers_url': 'https://api.github.com/users/Baxxx/followers', 'following_url': 'https://api.github.com/users/Baxxx/following{/other_user}', 'gists_url': 'https://api.github.com/users/Baxxx/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Baxxx/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Baxxx/subscriptions', 'organizations_url': 'https://api.github.com/users/Baxxx/orgs', 'repos_url': 'https://api.github.com/users/Baxxx/repos', 'events_url': 'https://api.github.com/users/Baxxx/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Baxxx/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,11,2022-08-15T12:09:14Z,2022-08-25T13:32:26Z,,NONE,,,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

In some of our projects we use Postgres as database, and for some cases we deferred trigger constraints. These triggers fire up when `COMMIT` is called. Trigger can raise an error, which kills the transaction. ActiveRecord catches the error, and bubbles it up to developer, but it also sends `ROLLBACK` to Postgres, to which Postgres gives a warning that there is no transaction in progress.

I didn't test this with sqlite3 or mysql.

You can see the reproduction script, and screenshot with the current behavior.

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

```ruby
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", ""~> 7""
  gem ""pg""
end

require ""active_record""
require ""logger""

logger = Logger.new(STDOUT)

# This connection will do for database-independent bug reports.
pg_opts = {adapter: ""postgresql"", database: ""ar_rollback_after_failed_commit_issue""}

ActiveRecord::Base.establish_connection(pg_opts.except(:database))
ActiveRecord::Base.connection.drop_database(pg_opts[:database])
ActiveRecord::Base.connection.create_database(pg_opts[:database])
logger.info ""Database #{pg_opts[:database]} was (re)created.""

ActiveRecord::Base.establish_connection(pg_opts)
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  execute <<~SQL
    CREATE FUNCTION perform_custom_validation()
      RETURNS TRIGGER
      LANGUAGE plpgsql
      AS $$
        DECLARE
          total_invalid INTEGER;
        BEGIN
          SELECT COUNT(*) INTO total_invalid
          FROM things
          WHERE name = 'bad';

          IF (total_invalid > 0) THEN
            RAISE EXCEPTION 'There are bad things';
          END IF;
          RETURN NULL;
        END;
      $$;

    CREATE TABLE ""things"" (
      ""id"" bigserial primary key,
      ""name"" character varying NOT NULL
    );

    CREATE CONSTRAINT
      TRIGGER bank_transaction_rl_payment_date_validation
      AFTER INSERT OR UPDATE ON things
      DEFERRABLE INITIALLY DEFERRED
      FOR EACH ROW EXECUTE FUNCTION perform_custom_validation();
  SQL
end

class Thing < ActiveRecord::Base
  validates :name, presence: true
end

# All good
logger.info ""First transaction""
Thing.create!(name: ""good"")

# AR tries to commit, DB raises an error, AR tries to ROLLBACK, and PG gives a warning
begin
  logger.info ""Second transaction""
  Thing.create!(name: ""bad"")
rescue StandardError
  # Doesn't matter
end
```

### Expected behavior
ActiveRecord should not `ROLLBACK`, as there is no transaction in progress.

### Actual behavior
ActiveRecord tries to `ROLLBACK`.

![Screenshot from 2022-08-15 14-07-11](https://user-images.githubusercontent.com/17880055/184632335-0277cd27-4c7b-4b98-94a8-373be34a87ee.png)


### System configuration
**Rails version**: 7.0.3.1

**Ruby version**: 2.7.5p203
","{'url': 'https://api.github.com/repos/rails/rails/issues/45830/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45830/timeline,,
https://api.github.com/repos/rails/rails/issues/45828,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45828/labels{/name},https://api.github.com/repos/rails/rails/issues/45828/comments,https://api.github.com/repos/rails/rails/issues/45828/events,https://github.com/rails/rails/pull/45828,1338286964,PR_kwDNIULOPSUHCw,45828,Speed up no-op nested attributes save,"{'login': 'janko', 'id': 795488, 'node_id': 'MDQ6VXNlcjc5NTQ4OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/795488?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/janko', 'html_url': 'https://github.com/janko', 'followers_url': 'https://api.github.com/users/janko/followers', 'following_url': 'https://api.github.com/users/janko/following{/other_user}', 'gists_url': 'https://api.github.com/users/janko/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/janko/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/janko/subscriptions', 'organizations_url': 'https://api.github.com/users/janko/orgs', 'repos_url': 'https://api.github.com/users/janko/repos', 'events_url': 'https://api.github.com/users/janko/events{/privacy}', 'received_events_url': 'https://api.github.com/users/janko/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-08-14T16:03:59Z,2022-08-19T21:39:35Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45828', 'html_url': 'https://github.com/rails/rails/pull/45828', 'diff_url': 'https://github.com/rails/rails/pull/45828.diff', 'patch_url': 'https://github.com/rails/rails/pull/45828.patch', 'merged_at': None}","### Summary

When we have two large collections, traversing one for each item in the other has a complexity of O(n^2). This makes Active Record do a lot of work in case when no record data has changed.

To speed it up, we create a map of existing recrods by record ID, and use that inside the loop. This speeds up the no-op case (when no records have changed) **by 2x**.

### Other Information

Here is the script to measure performance:

```rb
require ""bundler/setup""
require ""active_record""
require ""benchmark""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.connection.create_table(:orders) { |t| }
ActiveRecord::Base.connection.create_table(:items) { |t| t.references :order, null: false }

class Order < ActiveRecord::Base
  has_many :items
  accepts_nested_attributes_for :items
end

class Item < ActiveRecord::Base
end

order = Order.create
Item.insert_all Array.new(2000, { order_id: order.id })

order = Order.first
items_attributes = order.items.map { |item| { id: item.id } }

puts Benchmark.realtime {
  order.update(items_attributes: items_attributes)
}
```

Additional speedup could be achieved by doing a similar thing for `association.target.detect`, but I found that trickier to do, since `association.target` changes through the loop, and couldn't guarantee equivalent behaviour, so I left it out of the PR.","{'url': 'https://api.github.com/repos/rails/rails/issues/45828/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45828/timeline,,
https://api.github.com/repos/rails/rails/issues/45820,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45820/labels{/name},https://api.github.com/repos/rails/rails/issues/45820/comments,https://api.github.com/repos/rails/rails/issues/45820/events,https://github.com/rails/rails/pull/45820,1336924182,PR_kwDNIULOPROlxw,45820,Fix shared state from memoization of virtual attribute default procs,"{'login': 'quadule', 'id': 15299, 'node_id': 'MDQ6VXNlcjE1Mjk5', 'avatar_url': 'https://avatars.githubusercontent.com/u/15299?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/quadule', 'html_url': 'https://github.com/quadule', 'followers_url': 'https://api.github.com/users/quadule/followers', 'following_url': 'https://api.github.com/users/quadule/following{/other_user}', 'gists_url': 'https://api.github.com/users/quadule/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/quadule/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/quadule/subscriptions', 'organizations_url': 'https://api.github.com/users/quadule/orgs', 'repos_url': 'https://api.github.com/users/quadule/repos', 'events_url': 'https://api.github.com/users/quadule/events{/privacy}', 'received_events_url': 'https://api.github.com/users/quadule/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-08-12T08:42:38Z,2022-08-12T08:42:42Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45820', 'html_url': 'https://github.com/rails/rails/pull/45820', 'diff_url': 'https://github.com/rails/rails/pull/45820.diff', 'patch_url': 'https://github.com/rails/rails/pull/45820.patch', 'merged_at': None}","### Summary

This is a fix for #45817 with some additional test coverage for proc defaults for both Active Model and Active Record.

**Context:** When a class with both `ActiveModel::Attributes` and `ActiveModel::Dirty` has an attribute with a proc default, a new instance of the model won't have a value for the attribute until it is first accessed and the default proc is called. The default value of an attribute is also not considered to be `changed?`, whether or not the default proc has been called to determine the value.

**Bug:** When a model instance is `dup`ed, [`ActiveModel::Dirty` calls `with_value_from_user` for each attribute](https://github.com/rails/rails/blob/63d4f99e2bca562110d2597ba02541c400fd5b74/activemodel/lib/active_model/dirty.rb#L133-L141), wrapping the original `UserProvidedDefault` attribute instance in a new `FromUser` attribute. If a default value is still unknown at this point, it should not be passed as the original attribute because accessing it will memoize the proc value in both attribute instances and cause them to share state.

**Fix:** Override `ActiveModel::Attribute::UserProvidedDefault#with_value_from_user` so an unknown default is not passed as the original attribute.

**Bonus:** Fixing this also revealed that falsy return values of default procs are not memoized like others in `value_before_type_cast`. This appears to be unintentional and undocumented so I fixed it as well.

### Other Information

This seems to be a long standing bug and the fix should apply to versions going back to 5.1.","{'url': 'https://api.github.com/repos/rails/rails/issues/45820/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45820/timeline,,
https://api.github.com/repos/rails/rails/issues/45817,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45817/labels{/name},https://api.github.com/repos/rails/rails/issues/45817/comments,https://api.github.com/repos/rails/rails/issues/45817/events,https://github.com/rails/rails/issues/45817,1336797388,I_kwDNIULOT63ozA,45817,Value of attribute default proc is shared between instances after dup + dirty tracking,"{'login': 'quadule', 'id': 15299, 'node_id': 'MDQ6VXNlcjE1Mjk5', 'avatar_url': 'https://avatars.githubusercontent.com/u/15299?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/quadule', 'html_url': 'https://github.com/quadule', 'followers_url': 'https://api.github.com/users/quadule/followers', 'following_url': 'https://api.github.com/users/quadule/following{/other_user}', 'gists_url': 'https://api.github.com/users/quadule/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/quadule/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/quadule/subscriptions', 'organizations_url': 'https://api.github.com/users/quadule/orgs', 'repos_url': 'https://api.github.com/users/quadule/repos', 'events_url': 'https://api.github.com/users/quadule/events{/privacy}', 'received_events_url': 'https://api.github.com/users/quadule/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2022-08-12T06:16:00Z,2022-08-15T15:56:11Z,,CONTRIBUTOR,,,,"### Steps to reproduce

When an attribute without a database column defines a default proc, `dup`ing a model in which the default wasn't accessed passes the unevaluated `UserProvidedDefault` attribute to the new instance as the attribute's original value. Checking the new attribute for changes will then memoize the value in the original attribute definition, making it the default value in every new model instance afterward.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""
  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }
  gem ""rails"", github: ""rails/rails"", ref: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Schema.define do
  create_table :cats do |t|
    t.string :name
  end
end

class Cat < ActiveRecord::Base
  attribute :sounds, default: -> { [] }
end

class VirtualAttributeTest < Minitest::Test
  def test_virtual_attribute_defaults_are_independent
    Cat.new.dup.save!
    Cat.new.sounds << ""meow""
    refute_same Cat.new.sounds, Cat.new.sounds
  end
end
```

### Expected behavior
Each new instance should get a new default value from the proc.

### Actual behavior
After using dirty tracking on a duplicated instance with an uncalled proc default, all new instances of a model receive the same default value and share any changes made to it.

### Affected versions
This seems to date back quite a while; the test fails on the main branch back to 5-1-stable.

### Credits
Thanks to @GBH for originally discovering this bug.","{'url': 'https://api.github.com/repos/rails/rails/issues/45817/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45817/timeline,,
https://api.github.com/repos/rails/rails/issues/45811,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45811/labels{/name},https://api.github.com/repos/rails/rails/issues/45811/comments,https://api.github.com/repos/rails/rails/issues/45811/events,https://github.com/rails/rails/pull/45811,1336333190,PR_kwDNIULOPQvVuQ,45811,Update docs for `conf.hosts` to be more explicit about the main domain,"{'login': 'augustocbx', 'id': 31825, 'node_id': 'MDQ6VXNlcjMxODI1', 'avatar_url': 'https://avatars.githubusercontent.com/u/31825?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/augustocbx', 'html_url': 'https://github.com/augustocbx', 'followers_url': 'https://api.github.com/users/augustocbx/followers', 'following_url': 'https://api.github.com/users/augustocbx/following{/other_user}', 'gists_url': 'https://api.github.com/users/augustocbx/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/augustocbx/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/augustocbx/subscriptions', 'organizations_url': 'https://api.github.com/users/augustocbx/orgs', 'repos_url': 'https://api.github.com/users/augustocbx/repos', 'events_url': 'https://api.github.com/users/augustocbx/events{/privacy}', 'received_events_url': 'https://api.github.com/users/augustocbx/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-08-11T18:23:42Z,2022-08-16T13:37:54Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45811', 'html_url': 'https://github.com/rails/rails/pull/45811', 'diff_url': 'https://github.com/rails/rails/pull/45811.diff', 'patch_url': 'https://github.com/rails/rails/pull/45811.patch', 'merged_at': None}","### Summary

Clarify the info for `conf.hosts`, in the special case starting with period `.domain.com`, explaining that this allows the `domain.com` itself
","{'url': 'https://api.github.com/repos/rails/rails/issues/45811/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45811/timeline,,
https://api.github.com/repos/rails/rails/issues/45778,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45778/labels{/name},https://api.github.com/repos/rails/rails/issues/45778/comments,https://api.github.com/repos/rails/rails/issues/45778/events,https://github.com/rails/rails/issues/45778,1330360134,I_kwDNIULOT0uvRg,45778,ActiveStorage attachments are lost when casting using Becomes,"{'login': 'markedmondson', 'id': 1653699, 'node_id': 'MDQ6VXNlcjE2NTM2OTk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1653699?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/markedmondson', 'html_url': 'https://github.com/markedmondson', 'followers_url': 'https://api.github.com/users/markedmondson/followers', 'following_url': 'https://api.github.com/users/markedmondson/following{/other_user}', 'gists_url': 'https://api.github.com/users/markedmondson/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/markedmondson/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/markedmondson/subscriptions', 'organizations_url': 'https://api.github.com/users/markedmondson/orgs', 'repos_url': 'https://api.github.com/users/markedmondson/repos', 'events_url': 'https://api.github.com/users/markedmondson/events{/privacy}', 'received_events_url': 'https://api.github.com/users/markedmondson/received_events', 'type': 'User', 'site_admin': False}","[{'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,3,2022-08-05T20:19:16Z,2022-11-08T23:13:35Z,,CONTRIBUTOR,,,,"### Steps to reproduce
Create an ActiveRecord model with an ActiveStorage relation. Initialize and add the associated attachment. Cast the object to another subclassed model, the associated attachment is lost.

```ruby
unless File.exist?('Gemfile')
    File.write('Gemfile', <<-GEMFILE)
    source 'https://rubygems.org'
    gem 'rails', '~> 6.1'
    gem 'sqlite3'
    GEMFILE

    system 'bundle'
end

require 'bundler'
Bundler.setup(:default)

require 'active_record'
require 'active_storage/engine'
require 'minitest/autorun'
require 'logger'

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << 'example.org'
  config.eager_load = false
  config.session_store :cookie_store, key: 'cookie_store_key'
  secrets.secret_key_base = 'secret_key_base'

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  config.active_storage.service = :local
  config.active_storage.service_configurations = {
    local: {
      root: Dir.tmpdir,
      service: 'Disk'
    }
  }
end

ENV['DATABASE_URL'] = 'sqlite3::memory:'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)
Rails.application.initialize!

require ActiveStorage::Engine.root.join('db/migrate/20170806125915_create_active_storage_tables.rb').to_s

ActiveRecord::Schema.define do
  CreateActiveStorageTables.new.change

  create_table :posts do |t|
    t.string :title
    t.string :text
  end

  create_table :comments do |t|
    t.belongs_to :post
    t.string :text
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
  has_one_attached :image
end

class ModeratedComment < Comment; end

class BugTest < Minitest::Test
  def setup
    @post = Post.create(title: 'Post', text: 'Welcome')
  end

  def test_association
    comment = @post.comments.new(text: 'I do not like this')

    moderated_comment = comment.becomes(ModeratedComment)

    assert_equal @post, moderated_comment.post # Pass
  end

  def test_attachment
    file = ActiveStorage::Blob.create_and_upload!(
      content_type: ""image/png"",
      filename: ""image.png"",
      io: ::StringIO.new(""png""),
    )
    comment = @post.comments.new(text: 'I do not like this', image: file)

    moderated_comment = comment.becomes(ModeratedComment)

    assert moderated_comment.image.attached? # Fail
  end
end
```

### Expected behavior
When casting an ActiveRecord to another model, I expect the associations to be copied thus I expect attached ActiveStorage association assets to be copied.

### Actual behavior
Previously attached ActiveStorage associated objects are lost on the original object.

### System configuration
**Rails version**: 6.1.6.1

**Ruby version**: 3.0.4
","{'url': 'https://api.github.com/repos/rails/rails/issues/45778/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45778/timeline,,
https://api.github.com/repos/rails/rails/issues/45764,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45764/labels{/name},https://api.github.com/repos/rails/rails/issues/45764/comments,https://api.github.com/repos/rails/rails/issues/45764/events,https://github.com/rails/rails/pull/45764,1329346415,PR_kwDNIULOPK_tXg,45764,Add `:save_history` option to `stream_from`,"{'login': 'mansakondo', 'id': 47113995, 'node_id': 'MDQ6VXNlcjQ3MTEzOTk1', 'avatar_url': 'https://avatars.githubusercontent.com/u/47113995?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mansakondo', 'html_url': 'https://github.com/mansakondo', 'followers_url': 'https://api.github.com/users/mansakondo/followers', 'following_url': 'https://api.github.com/users/mansakondo/following{/other_user}', 'gists_url': 'https://api.github.com/users/mansakondo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mansakondo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mansakondo/subscriptions', 'organizations_url': 'https://api.github.com/users/mansakondo/orgs', 'repos_url': 'https://api.github.com/users/mansakondo/repos', 'events_url': 'https://api.github.com/users/mansakondo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mansakondo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2022-08-05T01:52:43Z,2022-10-10T17:39:48Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45764', 'html_url': 'https://github.com/rails/rails/pull/45764', 'diff_url': 'https://github.com/rails/rails/pull/45764.diff', 'patch_url': 'https://github.com/rails/rails/pull/45764.patch', 'merged_at': None}","## Summary
This PR is motivated by this [RailsConf talk](https://youtu.be/TgpSs2ffJL0) from @palkan, where he discusses message delivery guarantees in real-time Rails applications.

Since the beginning, ActionCable rely on [Redis PubSub](https://redis.io/docs/manual/pubsub/) to create channels of communication between the server and the client. The purpose of a PubSub is solely to broadcast messages to multiple subscribers, not to make sure that they receive them. It means that if the network connection is lost for some reason, the subscriber will not be able to receive messages sent during their absence. If the subscriber is able to reconnect, they will have an inconsistent state if they don't refresh the page, thus killing the real-time experience.

To solve this problem we can use Redis PubSub in combination with [Redis Streams](https://redis.io/docs/manual/data-types/streams/). With Redis Streams, we can keep track of the messages sent by the server and retrieve the history when needed, using a timestamp that corresponds to the last time the subscriber received a message from the server. This is easily achievable because Redis Streams uses timestamps as [IDs](https://redis.io/docs/manual/data-types/streams/#entry-ids).

The approach taken in this PR is to add a `:save_history` option to `stream_from`. This option takes a boolean or a hash with the `:key`  attribute to set a custom Redis key for the stream history (I'm also considering adding an `:expires_in` option).

If this option is enabled, subscribers will request the history of messages sent in their absence, after each reconnect:
![streams_history](https://user-images.githubusercontent.com/47113995/182995620-9a26ef4c-427e-4ac8-a455-060c2aabe90e.gif)

## Tasks
- [ ] Write tests
- [ ] Write documentation

<!-- If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45764/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45764/timeline,,
https://api.github.com/repos/rails/rails/issues/45755,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45755/labels{/name},https://api.github.com/repos/rails/rails/issues/45755/comments,https://api.github.com/repos/rails/rails/issues/45755/events,https://github.com/rails/rails/pull/45755,1327804530,PR_kwDNIULOPJt_ng,45755,Factor out `validates_secure_password`,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,1,2022-08-03T21:21:10Z,2023-03-11T23:25:21Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45755', 'html_url': 'https://github.com/rails/rails/pull/45755', 'diff_url': 'https://github.com/rails/rails/pull/45755.diff', 'patch_url': 'https://github.com/rails/rails/pull/45755.patch', 'merged_at': None}","Follow-up to #45487, which was reverted by #45753.

This factors `validates_secure_password` out of `has_secure_password`, to provide an API for conditionally requiring a password.  For example:

  ```ruby
  class Account
    include ActiveModel::SecurePassword

    attr_accessor :is_guest, :password_digest

    has_secure_password validations: false
    validates_secure_password unless: :is_guest
  end

  account = Account.new
  account.valid? # => false, password required

  account.is_guest = true
  account.valid? # => true
  ```

---

/cc @liljack, @dhh
","{'url': 'https://api.github.com/repos/rails/rails/issues/45755/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45755/timeline,,
https://api.github.com/repos/rails/rails/issues/45724,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45724/labels{/name},https://api.github.com/repos/rails/rails/issues/45724/comments,https://api.github.com/repos/rails/rails/issues/45724/events,https://github.com/rails/rails/pull/45724,1324835881,PR_kwDNIULOPHPW1A,45724,Support distributed preloading calls,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2022-08-01T18:56:46Z,2022-08-22T13:54:42Z,,MEMBER,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45724', 'html_url': 'https://github.com/rails/rails/pull/45724', 'diff_url': 'https://github.com/rails/rails/pull/45724.diff', 'patch_url': 'https://github.com/rails/rails/pull/45724.patch', 'merged_at': None}","This PR is split into two commits.

The 1st commit allows records from already-loaded relations to be used when performing post-hoc preloads of downstream associations.

The 2nd commit modifies the `Preloader` to track preloaded associations in buckets, and, when preloading a downstream association, to preload that association for all owner records from the same bucket.

The goal of this PR is to allow individual `includes` and `preload` calls to be placed alongside the code that depends on them.  This makes it easier to add a preload when needed or remove a preload when it is no longer needed.

Consider the following code:

```ruby
def render_posts(posts)
  posts.includes(:comments).each do |post|
    post.comments.each do |comment|
      # ...
    end
  end
end

def render_authors(authors)
  authors.includes(:posts).each do |author|
    render_posts(author.posts)
  end
end

render_authors(Author.all)
```

Before the 1st commit, with N authors each having at least 1 post, the code would execute 2N + 2 queries.  For example, with 5 authors:

```
SELECT ""authors"".* FROM ""authors""
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" IN (?, ?, ?, ?, ?)  [[""author_id"", 1], [""author_id"", 2], [""author_id"", 3], [""author_id"", 4], [""author_id"", 5]]
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" = ?  [[""author_id"", 1]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 11]]
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" = ?  [[""author_id"", 2]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 12]]
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" = ?  [[""author_id"", 3]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 13]]
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" = ?  [[""author_id"", 4]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 14]]
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" = ?  [[""author_id"", 5]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 15]]
```

After the 1st commit, the code executes N + 2 queries:

```
SELECT ""authors"".* FROM ""authors""
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" IN (?, ?, ?, ?, ?)  [[""author_id"", 1], [""author_id"", 2], [""author_id"", 3], [""author_id"", 4], [""author_id"", 5]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 11]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 12]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 13]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 14]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" = ?  [[""post_id"", 15]]
```

After the 2nd commit, the code executes 3 queries:

```
SELECT ""authors"".* FROM ""authors""
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""author_id"" IN (?, ?, ?, ?, ?)  [[""author_id"", 1], [""author_id"", 2], [""author_id"", 3], [""author_id"", 4], [""author_id"", 5]]
SELECT ""comments"".* FROM ""comments"" WHERE ""comments"".""post_id"" IN (?, ?, ?, ?, ?)  [[""post_id"", 11], [""post_id"", 12], [""post_id"", 13], [""post_id"", 14], [""post_id"", 15]]
```

Related: #45161, #45413, #45231.  The primary difference of this PR is that users must still opt in to preloading via `includes` or `preload`.  The intent is to allow fine-grained control over when preloading happens, but to make cascading automatic.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45724/reactions', 'total_count': 6, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 2, 'rocket': 3, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/45724/timeline,,
https://api.github.com/repos/rails/rails/issues/45705,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45705/labels{/name},https://api.github.com/repos/rails/rails/issues/45705/comments,https://api.github.com/repos/rails/rails/issues/45705/events,https://github.com/rails/rails/pull/45705,1323200358,PR_kwDNIULOPF5G3g,45705,Add explicit regression tests for ActiveRecord::Migration's #say & #say_with_time,"{'login': 'nfedyashev', 'id': 61983, 'node_id': 'MDQ6VXNlcjYxOTgz', 'avatar_url': 'https://avatars.githubusercontent.com/u/61983?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/nfedyashev', 'html_url': 'https://github.com/nfedyashev', 'followers_url': 'https://api.github.com/users/nfedyashev/followers', 'following_url': 'https://api.github.com/users/nfedyashev/following{/other_user}', 'gists_url': 'https://api.github.com/users/nfedyashev/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/nfedyashev/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/nfedyashev/subscriptions', 'organizations_url': 'https://api.github.com/users/nfedyashev/orgs', 'repos_url': 'https://api.github.com/users/nfedyashev/repos', 'events_url': 'https://api.github.com/users/nfedyashev/events{/privacy}', 'received_events_url': 'https://api.github.com/users/nfedyashev/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-07-30T16:19:17Z,2023-02-07T12:21:17Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45705', 'html_url': 'https://github.com/rails/rails/pull/45705', 'diff_url': 'https://github.com/rails/rails/pull/45705.diff', 'patch_url': 'https://github.com/rails/rails/pull/45705.patch', 'merged_at': None}","related tests are in activerecord/test/cases/migrator_test.rb, but it checks puts(message_count) quantity only.

### Summary

I noticed that Migration's `#say` and `#say_with_time` methods didn't have explicit tests so this should increase test coverage a little bit.

Other than that(in the 2nd commit), after this update it fails with an explicit error in case #say_with_time was called without a block. I wasn't sure whether to put it in this PR or probably a future one.
LMKWYT","{'url': 'https://api.github.com/repos/rails/rails/issues/45705/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45705/timeline,,
https://api.github.com/repos/rails/rails/issues/45691,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45691/labels{/name},https://api.github.com/repos/rails/rails/issues/45691/comments,https://api.github.com/repos/rails/rails/issues/45691/events,https://github.com/rails/rails/issues/45691,1322122058,I_kwDNIULOTs37Sg,45691,ActionMailer fails to create correct multipart message with rfc822 attachment,"{'login': 'der-flo', 'id': 35431, 'node_id': 'MDQ6VXNlcjM1NDMx', 'avatar_url': 'https://avatars.githubusercontent.com/u/35431?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/der-flo', 'html_url': 'https://github.com/der-flo', 'followers_url': 'https://api.github.com/users/der-flo/followers', 'following_url': 'https://api.github.com/users/der-flo/following{/other_user}', 'gists_url': 'https://api.github.com/users/der-flo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/der-flo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/der-flo/subscriptions', 'organizations_url': 'https://api.github.com/users/der-flo/orgs', 'repos_url': 'https://api.github.com/users/der-flo/repos', 'events_url': 'https://api.github.com/users/der-flo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/der-flo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,6,2022-07-29T11:19:00Z,2023-05-14T20:50:15Z,,NONE,,,,"I cannot re-open #42849 so I create a new issue

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require 'bundler/inline'

gemfile(true) do
  source 'https://rubygems.org'
  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }
  gem 'rails', github: 'rails/rails', branch: 'main'
end

require 'minitest/autorun'
require 'action_mailer/railtie'

class TestMailer < ActionMailer::Base
  def main
    message_to_attach =  <<~MAIL.gsub(/\n/, ""\r\n"")
      Message-ID: <12345@foo.example>
      Subject: Test
      From: test1@foo.example
      To: test2@foo.example
      
      hello world
    MAIL
    attachments['test.eml'] = {
      mime_type: params[:mime_type],
      content: message_to_attach
    }

    mail(from: 'test3@foo.example', to: 'test4@foo.example', subject: 'Test outer') do |format|
      format.text { ""outer text - #{params[:mime_type]} attachment"" }
    end
  end
end

class BugTest < Minitest::Test
  def test_with_plain_mime_type
    message = TestMailer.with(mime_type: 'text/plain').main
    assert_equal message.mime_type, 'multipart/mixed'
  end

  def test_with_rfc822_mime_type
    message = TestMailer.with(mime_type: 'message/rfc822').main
    assert_equal message.mime_type, 'multipart/mixed'
  end
end
```

The second test fails, the message object is rendered as follows:
```
Date: Fri, 23 Jul 2021 13:59:19 +0200
From: test3@foo.example
To: test4@foo.example
Message-ID: <60faaf1738a02_14fbd98-3fb@flo.adigi.ai.mail>
Subject: Test outer
Mime-Version: 1.0
Content-Type: text/plain;
 boundary=""--==_mimepart_60faaf1738008_14fbd98-484"";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_60faaf1738008_14fbd98-484
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

outer text - message/rfc822 attachment
----==_mimepart_60faaf1738008_14fbd98-484
Content-Type: message/rfc822
Content-Transfer-Encoding: 
Content-Disposition: attachment;
 filename=test.eml
Content-ID: <60faaf1739102_14fbd98-2b@flo.adigi.ai.mail>

Message-ID: <12345@foo.example>
Subject: Test
From: test1@foo.example
To: test2@foo.example

hello world

----==_mimepart_60faaf1738008_14fbd98-484--

```

### Expected behavior

The `message.mime_type` is `multipart/mixed` in both test cases. ActionMailer handles attachments in the way it is described in https://guides.rubyonrails.org/action_mailer_basics.html#adding-attachments describes.

### Actual behavior

When attaching a `message/rfc822` - an email message - the generated mail parts are not nested correctly, the outer `multipart/mixed` is missing.

Perhaps this behaviour is caused by the [special handling](https://github.com/mikel/mail/blob/master/lib/mail/attachments_list.rb#L9) of such attachments in the `mail` gem.


### System configuration
**Rails version**: main

**Ruby version**: 3.0.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/45691/reactions', 'total_count': 2, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 2, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45691/timeline,,
https://api.github.com/repos/rails/rails/issues/45680,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45680/labels{/name},https://api.github.com/repos/rails/rails/issues/45680/comments,https://api.github.com/repos/rails/rails/issues/45680/events,https://github.com/rails/rails/pull/45680,1320789527,PR_kwDNIULOPD4Rsg,45680,Allow hosts redirects from `hosts` Rails configuration,"{'login': 'Kevinrob', 'id': 4509277, 'node_id': 'MDQ6VXNlcjQ1MDkyNzc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4509277?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/Kevinrob', 'html_url': 'https://github.com/Kevinrob', 'followers_url': 'https://api.github.com/users/Kevinrob/followers', 'following_url': 'https://api.github.com/users/Kevinrob/following{/other_user}', 'gists_url': 'https://api.github.com/users/Kevinrob/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/Kevinrob/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/Kevinrob/subscriptions', 'organizations_url': 'https://api.github.com/users/Kevinrob/orgs', 'repos_url': 'https://api.github.com/users/Kevinrob/repos', 'events_url': 'https://api.github.com/users/Kevinrob/events{/privacy}', 'received_events_url': 'https://api.github.com/users/Kevinrob/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,3,2022-07-28T11:27:45Z,2023-08-24T13:07:55Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45680', 'html_url': 'https://github.com/rails/rails/pull/45680', 'diff_url': 'https://github.com/rails/rails/pull/45680.diff', 'patch_url': 'https://github.com/rails/rails/pull/45680.patch', 'merged_at': None}","### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

We use Rails with multiple domains (and subdomains). All these domains are configured with `config.hosts`.  
Sometimes we have dynamic redirect from one domain to an other.  
And `ActionController::Redirecting::UnsafeRedirectError` is raised.

It would be great to allow redirections to domains that the app accept in `config.hosts`.
This should not be considered as unsafe.

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45680/reactions', 'total_count': 11, '+1': 8, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 3, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45680/timeline,,
https://api.github.com/repos/rails/rails/issues/45676,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45676/labels{/name},https://api.github.com/repos/rails/rails/issues/45676/comments,https://api.github.com/repos/rails/rails/issues/45676/events,https://github.com/rails/rails/pull/45676,1320522755,PR_kwDNIULOPDqBcg,45676,Detect colliding keys in Active Job Hash serialization,"{'login': 'sambostock', 'id': 8219340, 'node_id': 'MDQ6VXNlcjgyMTkzNDA=', 'avatar_url': 'https://avatars.githubusercontent.com/u/8219340?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sambostock', 'html_url': 'https://github.com/sambostock', 'followers_url': 'https://api.github.com/users/sambostock/followers', 'following_url': 'https://api.github.com/users/sambostock/following{/other_user}', 'gists_url': 'https://api.github.com/users/sambostock/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sambostock/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sambostock/subscriptions', 'organizations_url': 'https://api.github.com/users/sambostock/orgs', 'repos_url': 'https://api.github.com/users/sambostock/repos', 'events_url': 'https://api.github.com/users/sambostock/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sambostock/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,0,2022-07-28T07:37:57Z,2022-07-28T07:38:01Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45676', 'html_url': 'https://github.com/rails/rails/pull/45676', 'diff_url': 'https://github.com/rails/rails/pull/45676.diff', 'patch_url': 'https://github.com/rails/rails/pull/45676.patch', 'merged_at': None}","### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

ActiveJob serializes `Symbol` `Hash` keys by stringifying them, and storing an array of keys to be symbolized on deserialization as `_aj_symbol_keys`. This means that if a `Hash` has both `Symbol` and `String` keys with the same contents, they will collide.

Specifically, the resulting hash ends up containing only a pair consisting of:
- the symbol key
- the last value

This PR adds a check for this and logs a deprecation warning. It also introduces a setting to `raise` instead of logging the warning, with the intention of making this behavior the default in Rails 7.2/8.0.

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->

I have left a number of placeholders for the time being, because I wanted to get initial review and confirm we want to do this, before investing the time to write the docs, deprecation message, changelog, etc.

---
cc. @mangara, who mentioned this in Slack","{'url': 'https://api.github.com/repos/rails/rails/issues/45676/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45676/timeline,,
https://api.github.com/repos/rails/rails/issues/45651,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45651/labels{/name},https://api.github.com/repos/rails/rails/issues/45651/comments,https://api.github.com/repos/rails/rails/issues/45651/events,https://github.com/rails/rails/pull/45651,1315946580,PR_kwDNIULOO_8gXg,45651,Add SQL function UPPER to Arel::FactoryMethods,"{'login': 'jdufresne', 'id': 347634, 'node_id': 'MDQ6VXNlcjM0NzYzNA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/347634?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jdufresne', 'html_url': 'https://github.com/jdufresne', 'followers_url': 'https://api.github.com/users/jdufresne/followers', 'following_url': 'https://api.github.com/users/jdufresne/following{/other_user}', 'gists_url': 'https://api.github.com/users/jdufresne/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jdufresne/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jdufresne/subscriptions', 'organizations_url': 'https://api.github.com/users/jdufresne/orgs', 'repos_url': 'https://api.github.com/users/jdufresne/repos', 'events_url': 'https://api.github.com/users/jdufresne/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jdufresne/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-07-24T16:10:51Z,2022-12-23T18:21:18Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45651', 'html_url': 'https://github.com/rails/rails/pull/45651', 'diff_url': 'https://github.com/rails/rails/pull/45651.diff', 'patch_url': 'https://github.com/rails/rails/pull/45651.patch', 'merged_at': None}","This mirrors the LOWER function that already exists.

This SQL function is useful for string fields but also for PostgreSQL
range fields where UPPER returns the upper bound of the range.

### Checklist

Before submitting the PR make sure the following are checked:

* [x] This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.
* [x] Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: `[Fix #issue-number]`
* [x] Tests are added or updated if you fix a bug or add a feature.
* [x] CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.","{'url': 'https://api.github.com/repos/rails/rails/issues/45651/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45651/timeline,,
https://api.github.com/repos/rails/rails/issues/45650,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45650/labels{/name},https://api.github.com/repos/rails/rails/issues/45650/comments,https://api.github.com/repos/rails/rails/issues/45650/events,https://github.com/rails/rails/pull/45650,1315886601,PR_kwDNIULOO_5ojA,45650,[ci-skip] Fix documentation on `accessed_fields` method.,"{'login': 'dixpac', 'id': 7427365, 'node_id': 'MDQ6VXNlcjc0MjczNjU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7427365?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dixpac', 'html_url': 'https://github.com/dixpac', 'followers_url': 'https://api.github.com/users/dixpac/followers', 'following_url': 'https://api.github.com/users/dixpac/following{/other_user}', 'gists_url': 'https://api.github.com/users/dixpac/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dixpac/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dixpac/subscriptions', 'organizations_url': 'https://api.github.com/users/dixpac/orgs', 'repos_url': 'https://api.github.com/users/dixpac/repos', 'events_url': 'https://api.github.com/users/dixpac/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dixpac/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-07-24T11:54:43Z,2022-07-26T10:52:17Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45650', 'html_url': 'https://github.com/rails/rails/pull/45650', 'diff_url': 'https://github.com/rails/rails/pull/45650.diff', 'patch_url': 'https://github.com/rails/rails/pull/45650.patch', 'merged_at': None}","Change `ActionController::Base` -> `ApplicationController`, on the usage
example.","{'url': 'https://api.github.com/repos/rails/rails/issues/45650/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45650/timeline,,
https://api.github.com/repos/rails/rails/issues/45636,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45636/labels{/name},https://api.github.com/repos/rails/rails/issues/45636/comments,https://api.github.com/repos/rails/rails/issues/45636/events,https://github.com/rails/rails/issues/45636,1314546104,I_kwDNIULOTlphuA,45636,Invalid template types should raise an exception,"{'login': 'axos88', 'id': 1281218, 'node_id': 'MDQ6VXNlcjEyODEyMTg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1281218?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/axos88', 'html_url': 'https://github.com/axos88', 'followers_url': 'https://api.github.com/users/axos88/followers', 'following_url': 'https://api.github.com/users/axos88/following{/other_user}', 'gists_url': 'https://api.github.com/users/axos88/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/axos88/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/axos88/subscriptions', 'organizations_url': 'https://api.github.com/users/axos88/orgs', 'repos_url': 'https://api.github.com/users/axos88/repos', 'events_url': 'https://api.github.com/users/axos88/events{/privacy}', 'received_events_url': 'https://api.github.com/users/axos88/received_events', 'type': 'User', 'site_admin': False}","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,7,2022-07-22T07:40:54Z,2023-08-15T10:47:57Z,,NONE,,,,"### Steps to reproduce

  - Create a template in views/foo/bar.txt.erb # Note .txt, and not .text

```ruby
details = { locale: [:en], formats: [:txt], handlers: [:erb], variants: []}
ActionController::Base.view_paths.find(""bar"", 'foo', false, details, nil, [])
```

### Expected behavior

Should throw an exception that :txt is not a registered type in Template::Types

### Actual behavior

Silently fails to find the otherwise existing template, specifying the correct directory it the file resides in. 
Confustion intensifies.

### System configuration
**Rails version**: 7.0.3
**Ruby version**: 2.7.6","{'url': 'https://api.github.com/repos/rails/rails/issues/45636/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45636/timeline,,
https://api.github.com/repos/rails/rails/issues/45633,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45633/labels{/name},https://api.github.com/repos/rails/rails/issues/45633/comments,https://api.github.com/repos/rails/rails/issues/45633/events,https://github.com/rails/rails/pull/45633,1313455178,PR_kwDNIULOO92FpA,45633,Fix _read_attribute so it uses aliased attribute name as well,"{'login': 'tracyloisel', 'id': 48430, 'node_id': 'MDQ6VXNlcjQ4NDMw', 'avatar_url': 'https://avatars.githubusercontent.com/u/48430?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/tracyloisel', 'html_url': 'https://github.com/tracyloisel', 'followers_url': 'https://api.github.com/users/tracyloisel/followers', 'following_url': 'https://api.github.com/users/tracyloisel/following{/other_user}', 'gists_url': 'https://api.github.com/users/tracyloisel/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/tracyloisel/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/tracyloisel/subscriptions', 'organizations_url': 'https://api.github.com/users/tracyloisel/orgs', 'repos_url': 'https://api.github.com/users/tracyloisel/repos', 'events_url': 'https://api.github.com/users/tracyloisel/events{/privacy}', 'received_events_url': 'https://api.github.com/users/tracyloisel/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-07-21T15:39:29Z,2022-07-28T20:26:08Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45633', 'html_url': 'https://github.com/rails/rails/pull/45633', 'diff_url': 'https://github.com/rails/rails/pull/45633.diff', 'patch_url': 'https://github.com/rails/rails/pull/45633.patch', 'merged_at': None}","### Summary

The **read_attribute** method takes attribute_alias into consideration so **_read_attribute** should also do.

Fixes https://github.com/rails/rails/issues/45632.

","{'url': 'https://api.github.com/repos/rails/rails/issues/45633/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45633/timeline,,
https://api.github.com/repos/rails/rails/issues/45632,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45632/labels{/name},https://api.github.com/repos/rails/rails/issues/45632/comments,https://api.github.com/repos/rails/rails/issues/45632/events,https://github.com/rails/rails/issues/45632,1312439669,I_kwDNIULOTjo9dQ,45632,`_read_attribute` method should also check whether an attribute is aliased or not,"{'login': 'khiav223577', 'id': 4011729, 'node_id': 'MDQ6VXNlcjQwMTE3Mjk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4011729?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/khiav223577', 'html_url': 'https://github.com/khiav223577', 'followers_url': 'https://api.github.com/users/khiav223577/followers', 'following_url': 'https://api.github.com/users/khiav223577/following{/other_user}', 'gists_url': 'https://api.github.com/users/khiav223577/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/khiav223577/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/khiav223577/subscriptions', 'organizations_url': 'https://api.github.com/users/khiav223577/orgs', 'repos_url': 'https://api.github.com/users/khiav223577/repos', 'events_url': 'https://api.github.com/users/khiav223577/events{/privacy}', 'received_events_url': 'https://api.github.com/users/khiav223577/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2022-07-21T03:14:22Z,2022-07-21T21:37:09Z,,NONE,,,,"### Steps to reproduce

```rb
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""
  gem ""activerecord"", '7.0.3'
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table ""users"", force: :cascade do |t|
    t.string :name
  end

  create_table ""posts"", force: :cascade do |t|
    t.string :title
    t.integer :userId
  end
end

class User < ActiveRecord::Base
  has_many :posts
end

class Post < ActiveRecord::Base
  belongs_to :user

  alias_attribute :user_id, :userId
end

class BugTest < Minitest::Test
  def setup
    user = User.create!(name: 'Tester')
    post = Post.create!(user_id: user.id, title: 'Post A')
  end

  def test_has_many
    assert_equal ['Post A'], User.first.posts.map(&:title)
  end

  def test_belongs_to
    assert_equal 'Tester', Post.first.user&.name
  end
end
```

Result:
```
Finished in 0.059414s, 33.6619 runs/s, 33.6619 assertions/s.

  1) Failure:
BugTest#test_belongs_to [test.rb:53]:
Expected: ""Tester""
  Actual: nil

2 runs, 2 assertions, 1 failures, 0 errors, 0 skips
```

### Expected behavior

I run into this issue when I tried to add an association on an aliased attribute.

Then I found `belongs_to_association` will use `_read_attribute` method to check if this `foreign_key` exists on this model or not.
It doesn't pass the condition, therefore `find_target` will not be triggered.
https://github.com/rails/rails/blob/3272335f8f4739629283cdeff7c3db723f34a3f5/activerecord/lib/active_record/associations/association.rb#L172-L173
https://github.com/rails/rails/blob/3272335f8f4739629283cdeff7c3db723f34a3f5/activerecord/lib/active_record/associations/association.rb#L274-L276
https://github.com/rails/rails/blob/2ea5ff9e13b9c5d0d5d25b2441efa81a2de2a262/activerecord/lib/active_record/associations/belongs_to_association.rb#L133-L135
https://github.com/rails/rails/blob/4ae0390c1051a39ec16a4a95451cd06172a1b260/activerecord/lib/active_record/attribute_methods/read.rb#L37-L39

The `read_attribute` method takes `attribute_alias` into consideration since https://github.com/rails/rails/pull/26529, while `_read_attribute` doesn't. I think it should, too.

### Actual behavior

See the test script below.

### System configuration
**Rails version**: 
7.0.3.1

**Ruby version**:
ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-linux]","{'url': 'https://api.github.com/repos/rails/rails/issues/45632/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45632/timeline,,
https://api.github.com/repos/rails/rails/issues/45629,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45629/labels{/name},https://api.github.com/repos/rails/rails/issues/45629/comments,https://api.github.com/repos/rails/rails/issues/45629/events,https://github.com/rails/rails/pull/45629,1311107287,PR_kwDNIULOO7xx_g,45629,Raise Argument error for invalid jitter values,"{'login': 'aditya-vector', 'id': 4403594, 'node_id': 'MDQ6VXNlcjQ0MDM1OTQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/4403594?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/aditya-vector', 'html_url': 'https://github.com/aditya-vector', 'followers_url': 'https://api.github.com/users/aditya-vector/followers', 'following_url': 'https://api.github.com/users/aditya-vector/following{/other_user}', 'gists_url': 'https://api.github.com/users/aditya-vector/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/aditya-vector/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/aditya-vector/subscriptions', 'organizations_url': 'https://api.github.com/users/aditya-vector/orgs', 'repos_url': 'https://api.github.com/users/aditya-vector/repos', 'events_url': 'https://api.github.com/users/aditya-vector/events{/privacy}', 'received_events_url': 'https://api.github.com/users/aditya-vector/received_events', 'type': 'User', 'site_admin': False}","[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,1,2022-07-20T13:28:57Z,2022-07-21T18:05:07Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45629', 'html_url': 'https://github.com/rails/rails/pull/45629', 'diff_url': 'https://github.com/rails/rails/pull/45629.diff', 'patch_url': 'https://github.com/rails/rails/pull/45629.patch', 'merged_at': None}","### Summary

- Taking a cue from [this](https://github.com/rails/rails/pull/38545#discussion_r388377526) discussion with @jeremy, the PR attempts to fix an issue that is mainly concerned with negative jitter values.
- If the jitter value is negative, the resultant `scheduled_at` for the job may be set to a time before the current time.
- Which may result in unexpected behavior depending on the queuing backend used.
- #### Proposed Solution
  - The changes verify that the value is either positive numeric or zero and raise the associated error if not
  - Associated tests are added to validate the flow for negative jitter values and other probable invalid values like string or boolean
- #### Note
  - The chances of negative or invalid `jitter` value are very low considering the default flow and very good documentation around `jitter` usage. But cannot be ruled out in cases where for some reason the `jitter` value is dynamically passed


### Other Information

- Raising the PR more than 2 years after [the suggestion](https://github.com/rails/rails/pull/38545#discussion_r388377526) given by @jeremy , better late than never I guess :)

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45629/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45629/timeline,,
https://api.github.com/repos/rails/rails/issues/45622,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45622/labels{/name},https://api.github.com/repos/rails/rails/issues/45622/comments,https://api.github.com/repos/rails/rails/issues/45622/events,https://github.com/rails/rails/pull/45622,1308616335,PR_kwDNIULOO5p6JQ,45622,Use `class_attribute` transform block for job config,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2022-07-18T20:56:53Z,2022-07-28T06:53:09Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45622', 'html_url': 'https://github.com/rails/rails/pull/45622', 'diff_url': 'https://github.com/rails/rails/pull/45622.diff', 'patch_url': 'https://github.com/rails/rails/pull/45622.patch', 'merged_at': None}","In #45476, `ActiveRecord::Base.destroy_association_async_job` was made to accept a string which would be lazily constantized, to avoid loading `ActiveJob::Base` too soon.  However, due to the way `class_attribute` values are written, *each subclass* calling `destroy_association_async_job` will [allocate a `_destroy_association_async_job` singleton method](https://github.com/rails/rails/pull/45476/files#diff-4411c7993e3f8ccfd8e09f44a81f10dfac3ea7dbd44cabd60b369040a00be324R28) regardless of whether the subclass assigns a custom job value.

Additionally, `class_attribute` requires using a dummy attribute name so that the post-processing reader method is not overwritten when the attribute is set.  This is particularly [cumbersome](https://github.com/rails/rails/pull/45476/files#diff-4411c7993e3f8ccfd8e09f44a81f10dfac3ea7dbd44cabd60b369040a00be324R35-R36) when instance accessors are involved.

This PR re-implements #45476 by adding support for a transform block to `class_attribute`.  A transform block is applied to an attribute value when that value is first read, and the result is memoized as the actual value of the attribute.  Thus, using a transform block, `destroy_association_async_job` can lazily constantize and memoize the result, without allocating additional singleton methods, and without juggling attribute names.

The PR also applies the same technique to `ActionMailer::Base.delivery_job`.  Closes #45486.

I wrote about a few of the alternatives I considered in #45603.  Closes #45603.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45622/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45622/timeline,,
https://api.github.com/repos/rails/rails/issues/45613,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45613/labels{/name},https://api.github.com/repos/rails/rails/issues/45613/comments,https://api.github.com/repos/rails/rails/issues/45613/events,https://github.com/rails/rails/pull/45613,1307188600,PR_kwDNIULOO4cqNw,45613,Clarify Common Table Expression (CTE) support,"{'login': 'fig', 'id': 121632, 'node_id': 'MDQ6VXNlcjEyMTYzMg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/121632?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fig', 'html_url': 'https://github.com/fig', 'followers_url': 'https://api.github.com/users/fig/followers', 'following_url': 'https://api.github.com/users/fig/following{/other_user}', 'gists_url': 'https://api.github.com/users/fig/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fig/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fig/subscriptions', 'organizations_url': 'https://api.github.com/users/fig/orgs', 'repos_url': 'https://api.github.com/users/fig/repos', 'events_url': 'https://api.github.com/users/fig/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fig/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2022-07-17T19:26:36Z,2022-07-27T02:27:04Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45613', 'html_url': 'https://github.com/rails/rails/pull/45613', 'diff_url': 'https://github.com/rails/rails/pull/45613.diff', 'patch_url': 'https://github.com/rails/rails/pull/45613.patch', 'merged_at': None}","### Summary

[change to documentation only]
I've attempted to provide some more comprehensive documentation
by listing the databases that **do** support CTEs.
In creating the list, I've included those databases whose adapter
responds truthy to `#supports_common_table_expressions?`

This is intended to enhance #45586

For reference, these are renderings of the documentation before and after this commit.

#### Before
![before](https://user-images.githubusercontent.com/121632/179905226-3ba5645c-8191-4fce-8523-64b8dc247d56.png)
#### After
![after](https://user-images.githubusercontent.com/121632/179905255-2390e6a7-6fff-440c-9f7a-3b043b57c293.png)

","{'url': 'https://api.github.com/repos/rails/rails/issues/45613/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45613/timeline,,
https://api.github.com/repos/rails/rails/issues/45609,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45609/labels{/name},https://api.github.com/repos/rails/rails/issues/45609/comments,https://api.github.com/repos/rails/rails/issues/45609/events,https://github.com/rails/rails/issues/45609,1306840730,I_kwDNIULOTeTOmg,45609,Cannot add ActiveModel::Attribute::FromDatabase to permitted YAML safe load classes,"{'login': 'stanhu', 'id': 963826, 'node_id': 'MDQ6VXNlcjk2MzgyNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/963826?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/stanhu', 'html_url': 'https://github.com/stanhu', 'followers_url': 'https://api.github.com/users/stanhu/followers', 'following_url': 'https://api.github.com/users/stanhu/following{/other_user}', 'gists_url': 'https://api.github.com/users/stanhu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/stanhu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/stanhu/subscriptions', 'organizations_url': 'https://api.github.com/users/stanhu/orgs', 'repos_url': 'https://api.github.com/users/stanhu/repos', 'events_url': 'https://api.github.com/users/stanhu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/stanhu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,9,2022-07-16T15:51:30Z,2023-01-17T11:14:44Z,,CONTRIBUTOR,,,,"### Steps to reproduce

We have some database entries serialized to YAML. For example:

```
---
:custom_message: Repository Download Started
:author_name: !ruby/object:DeployToken
  concise_attributes:
  - !ruby/object:ActiveModel::Attribute::FromDatabase
    name: deploy_token_type
    value_before_type_cast: 1
  - !ruby/object:ActiveModel::Attribute::FromDatabase
    name: id
    value_before_type_cast: 2
  - !ruby/object:ActiveModel::Attribute::FromDatabase
    name: revoked
    value_before_type_cast: false
  - !ruby/object:ActiveModel::Attribute::FromDatabase
    name: read_repository
    value_before_type_cast: true
```

However, since the security release announced in https://rubyonrails.org/2022/7/12/Rails-Versions-7-0-3-1-6-1-6-1-6-0-5-1-and-5-2-8-1-have-been-released to address CVE-2022-32224, we cannot simply add `ActiveModel::Attribute::FromDatabase` to the permitted class list:

```ruby
(byebug) YAML.safe_load(payload, permitted_classes: [ActiveModel::Attribute::FromDatabase, Symbol, DeployToken], aliases: true)
*** NameError Exception: private constant ActiveModel::Attribute::FromDatabase referenced
```

<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

### Expected behavior

YAML loading should work. Should this constant no longer be private since it's been serialized to YAML?

### Actual behavior

YAML loading fails with:

```
*** NameError Exception: private constant ActiveModel::Attribute::FromDatabase referenced
```

### System configuration

**Rails version**:
v6.1.6.1

**Ruby version**:
v2.7.5","{'url': 'https://api.github.com/repos/rails/rails/issues/45609/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45609/timeline,,
https://api.github.com/repos/rails/rails/issues/45603,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45603/labels{/name},https://api.github.com/repos/rails/rails/issues/45603/comments,https://api.github.com/repos/rails/rails/issues/45603/events,https://github.com/rails/rails/pull/45603,1305305580,PR_kwDNIULOO28UUA,45603,Add `:constantize` option for `class_attribute`,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,3,2022-07-14T21:26:48Z,2022-07-19T16:36:30Z,,MEMBER,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45603', 'html_url': 'https://github.com/rails/rails/pull/45603', 'diff_url': 'https://github.com/rails/rails/pull/45603.diff', 'patch_url': 'https://github.com/rails/rails/pull/45603.patch', 'merged_at': None}","In #45476, `ActiveRecord::Base.destroy_association_async_job` was made to accept a string which would lazily be constantized, to avoid loading `ActiveJob::Base` too soon.

#45486 intends to solve the same problem for `ActionMailer::Base.delivery_job`.

While thinking about how to simplify the code from #45476 for #45486, I realized that #45476 allocates a `_destroy_association_async_job` method for every constantize.  e.g. Even if `Post` and `Comment` classes do not set a custom destroy job, [`self._destroy_association_async_job = _destroy_association_async_job.constantize`](https://github.com/rails/rails/pull/45476/files#diff-4411c7993e3f8ccfd8e09f44a81f10dfac3ea7dbd44cabd60b369040a00be324R28) will define a new singleton method for each class.

This could be addressed by calling `_destroy_association_async_job=` on the method owner:

```diff
index 0aa59fe885..b981f2e934 100644
--- a/activerecord/lib/active_record/core.rb
+++ b/activerecord/lib/active_record/core.rb
@@ -25,7 +25,8 @@ module Core
       # The job class used to destroy associations in the background.
       def self.destroy_association_async_job
         if _destroy_association_async_job.is_a?(String)
-          self._destroy_association_async_job = _destroy_association_async_job.constantize
+          owner = method(:_destroy_association_async_job=).owner
+          owner._destroy_association_async_job = _destroy_association_async_job.constantize
         end
         _destroy_association_async_job
       rescue NameError => error
```

But that makes the code even more cumbersome to replicate for e.g. #45486.  And this seems like a pattern that may reoccur.

This **draft** PR proposes a `class_attribute` `:constantize` option that would auto-constantize string values without allocating any additional singleton methods.

On one hand, a `:constantize` option feels over-specific.  On the other hand, it is an extremely simple and efficient implementation.

Another alternative I considered was a [`class_attribute` `:lazy` option](https://github.com/jonathanhefner/rails/commit/8b533464fde986125f1f89580e1da4362937bbd5).  It feels less over-specific, but requires wrapping values in a proc.

And yet another alternative I considered was a [`ConstantizingProxy`](https://github.com/jonathanhefner/rails/commit/06b2db17ce59a371a1944843476b286323b5259d) class.  It is the least invasive / most orthogonal implementation, but it requires wrapping values in a proxy object, which is even less convenient than a proc.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45603/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45603/timeline,,
https://api.github.com/repos/rails/rails/issues/45597,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45597/labels{/name},https://api.github.com/repos/rails/rails/issues/45597/comments,https://api.github.com/repos/rails/rails/issues/45597/events,https://github.com/rails/rails/pull/45597,1304290061,PR_kwDNIULOO2Fyyg,45597,Allow :schema_format in database configuration to override ActiveRecord default,"{'login': 'leboshi', 'id': 16550140, 'node_id': 'MDQ6VXNlcjE2NTUwMTQw', 'avatar_url': 'https://avatars.githubusercontent.com/u/16550140?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/leboshi', 'html_url': 'https://github.com/leboshi', 'followers_url': 'https://api.github.com/users/leboshi/followers', 'following_url': 'https://api.github.com/users/leboshi/following{/other_user}', 'gists_url': 'https://api.github.com/users/leboshi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/leboshi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/leboshi/subscriptions', 'organizations_url': 'https://api.github.com/users/leboshi/orgs', 'repos_url': 'https://api.github.com/users/leboshi/repos', 'events_url': 'https://api.github.com/users/leboshi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/leboshi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2022-07-14T05:50:33Z,2022-07-26T15:35:00Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45597', 'html_url': 'https://github.com/rails/rails/pull/45597', 'diff_url': 'https://github.com/rails/rails/pull/45597.diff', 'patch_url': 'https://github.com/rails/rails/pull/45597.patch', 'merged_at': None}","### Summary

The schema dump format (Ruby/SQL) can currently only be set globally, either via setting `ActiveRecord.schema_format` or by setting `ENV['SCHEMA_FORMAT']`. Thanks to #43530 we can set the dump _filename_, but that has no bearing on the _format_ Rails dumps or expects to load from. This PR allows you to set `schema_format` per-database in your configuration YAML. It will still be overridden by `ENV['SCHEMA_FORMAT']` when set and will fall back to `ActiveRecord.schema_format`.

Fixes #45596 (and the second half of #43173, at last).

### Changes

- `ActiveRecord::DatabaseConfigurations::HashConfig`:
  - Deprecate passing a format to `schema_dump`
  - New `schema_format` method that checks
    1. `ENV['SCHEMA_FORMAT']`
    2. the database's configuration hash
    3. the default `ActiveRecord.schema_format`
- Remove schema format from invocations of methods that otherwise have access to DB config hashes
  - Deprecate passing a format as a parameter to `load_schema`, `schema_up_to_date?`, `reconstruct_from_schema`, `dump_schema`, `schema_dump_path`, and `load_schema_current` in `DatabaseTasks`

### Notes

- Didn't specify a deprecation horizon in the deprecation messages.
- I like that this DRYs up the `ENV['SCHEMA_FORMAT']` override, which was in multiple places in databases.rake before, but it does seem smelly to me that the `HashConfig` is checking `ENV` vars; that felt a lot more natural in a Rakefile. However, there really isn't another place I saw it making sense, moving toward keeping the format in the DB config and removing it from being passed around separately. Open to feedback if anybody has thoughts on a cleaner place to put that override.","{'url': 'https://api.github.com/repos/rails/rails/issues/45597/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45597/timeline,,
https://api.github.com/repos/rails/rails/issues/45596,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45596/labels{/name},https://api.github.com/repos/rails/rails/issues/45596/comments,https://api.github.com/repos/rails/rails/issues/45596/events,https://github.com/rails/rails/issues/45596,1304247666,I_kwDNIULOTb09cg,45596,Setting `schema_dump` in database.yml does not change dump format,"{'login': 'leboshi', 'id': 16550140, 'node_id': 'MDQ6VXNlcjE2NTUwMTQw', 'avatar_url': 'https://avatars.githubusercontent.com/u/16550140?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/leboshi', 'html_url': 'https://github.com/leboshi', 'followers_url': 'https://api.github.com/users/leboshi/followers', 'following_url': 'https://api.github.com/users/leboshi/following{/other_user}', 'gists_url': 'https://api.github.com/users/leboshi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/leboshi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/leboshi/subscriptions', 'organizations_url': 'https://api.github.com/users/leboshi/orgs', 'repos_url': 'https://api.github.com/users/leboshi/repos', 'events_url': 'https://api.github.com/users/leboshi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/leboshi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2022-07-14T04:44:37Z,2022-07-14T14:34:25Z,,CONTRIBUTOR,,,,"Originally brought up in #43173.  I opened PR #43240 to address it, but that was closed when it was decided #43530 did the same thing.  Unfortunately, I don't think any of us were really reading what the other was doing, because the two PRs actually each only addressed half the opened issue.

PR incoming to fully address this and the second half of #43173!

### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true
end

class BugTest < Minitest::Test
  def test_schema_format_corresponds_with_schema_dump
    Dir.mktmpdir do |dir|
      ActiveRecord::Tasks::DatabaseTasks.stub(:db_dir, dir) do
        old_configurations = ActiveRecord::Base.configurations
        ActiveRecord::Base.configurations = {
          ""development"" => {
            ""primary"" => {
              ""database"" => ""dev-db"",
              ""schema_dump"" => ""primary_structure.sql""
            }
          }
        }

        db_config = ActiveRecord::Base.configurations.configs_for(env_name: ""development"", name: ""primary"")
        ActiveRecord::Tasks::DatabaseTasks.dump_schema(db_config)

        dump_contents = File.read(File.join(dir, ""primary_structure.sql""))
        refute_match /ActiveRecord::Schema/, dump_contents
        assert_match /CREATE TABLE/, dump_contents
      ensure
        ActiveRecord::Base.configurations = old_configurations
        ActiveRecord::Base.clear_cache!
      end
    end
  end
end
```

### Expected behavior
If `schema_dump` is set to something like `primary_structure.sql`, I'd expect it to do a SQL structure dump rather than a Ruby schema dump.

### Actual behavior
The filename in `schema_dump` has no bearing on the format of the dump Rails writes or expects to read.

### System configuration
**Rails version**: (main)

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/45596/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45596/timeline,,
https://api.github.com/repos/rails/rails/issues/45589,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45589/labels{/name},https://api.github.com/repos/rails/rails/issues/45589/comments,https://api.github.com/repos/rails/rails/issues/45589/events,https://github.com/rails/rails/pull/45589,1303610463,PR_kwDNIULOO1h4mQ,45589,Correct/update the pluralization docs,"{'login': 'movermeyer', 'id': 1459385, 'node_id': 'MDQ6VXNlcjE0NTkzODU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1459385?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/movermeyer', 'html_url': 'https://github.com/movermeyer', 'followers_url': 'https://api.github.com/users/movermeyer/followers', 'following_url': 'https://api.github.com/users/movermeyer/following{/other_user}', 'gists_url': 'https://api.github.com/users/movermeyer/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/movermeyer/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/movermeyer/subscriptions', 'organizations_url': 'https://api.github.com/users/movermeyer/orgs', 'repos_url': 'https://api.github.com/users/movermeyer/repos', 'events_url': 'https://api.github.com/users/movermeyer/events{/privacy}', 'received_events_url': 'https://api.github.com/users/movermeyer/received_events', 'type': 'User', 'site_admin': False}","[{'id': 131864, 'node_id': 'MDU6TGFiZWwxMzE4NjQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/third%20party%20issue', 'name': 'third party issue', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-07-13T15:33:28Z,2023-02-06T17:24:42Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45589', 'html_url': 'https://github.com/rails/rails/pull/45589', 'diff_url': 'https://github.com/rails/rails/pull/45589.diff', 'patch_url': 'https://github.com/rails/rails/pull/45589.patch', 'merged_at': None}","### Summary

The existing pluralization docs encouraged problematic i18n patterns:

* `zero` should not be used for locales that don't require the `zero` pluralization rule.
* `%{count}` should be used in `one` keys (if it is used in the `other` key)

[`ruby-i18n v1.11.0`](https://github.com/ruby-i18n/i18n/releases/tag/v1.11.0) changed/fixed its behavior to no longer use `zero` key in the case of `count == 0`.

### Other Information

`zero` is not a valid pluralization rule for most languages (including `en` (English)). Including `zero` in an `en` file (for example) would cause the translation of that key to collide when translating into a language that requires the `zero` key (e.g., `ar` (Arabic))

This `en` source file

```yaml
en:
  car:
    one: I have %{count} car
    other: I have %{count} cars
```

Would translate into `ar`/Arabic with this structure:

```yaml
ar:
  car:
    zero: ...
    one: ...
    other: ...
```

The required `zero` key for Arabic translation would collide with the translation of a `zero` key if it were to be provided in the `en` file.

CLDR defines [explicit `0` and `1` keys](https://unicode-org.github.io/cldr/ldml/tr35-numbers.html#Explicit_0_1_rules) for the cases where you need a special string for the cases of `count == 0` or `count == 1`.

[`ruby-i18n v1.11.0`](https://github.com/ruby-i18n/i18n/releases/tag/v1.11.0) has been updated to support explicit `0` and `1` keys.

----

In the provided example, the `one` key should also include the `%{count}` interpolation. A common mistake is to think that `one` is only for the number 1. Instead, `one` is a category for any number that behaves like 1.

* Some languages use `one` for almost every number.
* Some languages use `one` for numbers that end in ""1"" (like 1, 21, 151) but that don't end in 11 (like 11, 111, 10311).

The same is true for the `zero`, and `two` categories. They are not only used for 0 or 2, but any number that behaves like 0 or 2 in that language.","{'url': 'https://api.github.com/repos/rails/rails/issues/45589/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45589/timeline,,
https://api.github.com/repos/rails/rails/issues/45583,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45583/labels{/name},https://api.github.com/repos/rails/rails/issues/45583/comments,https://api.github.com/repos/rails/rails/issues/45583/events,https://github.com/rails/rails/pull/45583,1303169787,PR_kwDNIULOO1J9pA,45583,Add an example to ActiveRecord::AutosaveAssociation caveats [skip ci],"{'login': 'shouichi', 'id': 99586, 'node_id': 'MDQ6VXNlcjk5NTg2', 'avatar_url': 'https://avatars.githubusercontent.com/u/99586?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shouichi', 'html_url': 'https://github.com/shouichi', 'followers_url': 'https://api.github.com/users/shouichi/followers', 'following_url': 'https://api.github.com/users/shouichi/following{/other_user}', 'gists_url': 'https://api.github.com/users/shouichi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shouichi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shouichi/subscriptions', 'organizations_url': 'https://api.github.com/users/shouichi/orgs', 'repos_url': 'https://api.github.com/users/shouichi/repos', 'events_url': 'https://api.github.com/users/shouichi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shouichi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-07-13T09:34:41Z,2022-08-31T01:09:39Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45583', 'html_url': 'https://github.com/rails/rails/pull/45583', 'diff_url': 'https://github.com/rails/rails/pull/45583.diff', 'patch_url': 'https://github.com/rails/rails/pull/45583.patch', 'merged_at': None}",Close https://github.com/rails/rails/issues/45209.,"{'url': 'https://api.github.com/repos/rails/rails/issues/45583/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45583/timeline,,
https://api.github.com/repos/rails/rails/issues/45565,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45565/labels{/name},https://api.github.com/repos/rails/rails/issues/45565/comments,https://api.github.com/repos/rails/rails/issues/45565/events,https://github.com/rails/rails/pull/45565,1301105466,PR_kwDNIULOOzbgjQ,45565,Load Tree Debug,"{'login': 'gwincr11', 'id': 289882, 'node_id': 'MDQ6VXNlcjI4OTg4Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/289882?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/gwincr11', 'html_url': 'https://github.com/gwincr11', 'followers_url': 'https://api.github.com/users/gwincr11/followers', 'following_url': 'https://api.github.com/users/gwincr11/following{/other_user}', 'gists_url': 'https://api.github.com/users/gwincr11/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/gwincr11/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/gwincr11/subscriptions', 'organizations_url': 'https://api.github.com/users/gwincr11/orgs', 'repos_url': 'https://api.github.com/users/gwincr11/repos', 'events_url': 'https://api.github.com/users/gwincr11/events{/privacy}', 'received_events_url': 'https://api.github.com/users/gwincr11/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-07-11T19:05:18Z,2022-07-11T19:51:14Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45565', 'html_url': 'https://github.com/rails/rails/pull/45565', 'diff_url': 'https://github.com/rails/rails/pull/45565.diff', 'patch_url': 'https://github.com/rails/rails/pull/45565.patch', 'merged_at': None}","### Summary

This builds off the Load Tree PR https://github.com/rails/rails/pull/45161 which introduced the tree of all the loaded records. I this pr I am adding a debug view that can be used to debug all loaded active record objects and see how they were loaded. Attached is a demo of it in action.


https://user-images.githubusercontent.com/289882/178339054-1e6b79b9-3f51-4fd7-b59c-2e7765a785a3.mov



This is very much a starting point and one could imagine adding a lot more information to it, such as the sql query that loaded the record or the sql explain information.

### Other Information

This is the first debug view for active record, I am not sure where it should go, how to test it or if this is even how the rail community would want it to work. You can test it out by adding this to you Application controller:

```ruby
  ActiveRecord.load_tree_enabled = true
  ActiveRecord::Debugger.enable_debugging
```

and then this to a view or a layout:

```
<%= render ""active_record_debugger/debugger"" %>
```
It could also be a better looking interface, I am not sure how css should be brought into something like this and how to avoid fighting with site other stylesheets out there, which is why I left it out, completely open to ideas.","{'url': 'https://api.github.com/repos/rails/rails/issues/45565/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45565/timeline,,
https://api.github.com/repos/rails/rails/issues/45558,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45558/labels{/name},https://api.github.com/repos/rails/rails/issues/45558/comments,https://api.github.com/repos/rails/rails/issues/45558/events,https://github.com/rails/rails/pull/45558,1300063764,PR_kwDNIULOOyjnsQ,45558,Fix TimeWithZone#time to return local time,"{'login': 'shouichi', 'id': 99586, 'node_id': 'MDQ6VXNlcjk5NTg2', 'avatar_url': 'https://avatars.githubusercontent.com/u/99586?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shouichi', 'html_url': 'https://github.com/shouichi', 'followers_url': 'https://api.github.com/users/shouichi/followers', 'following_url': 'https://api.github.com/users/shouichi/following{/other_user}', 'gists_url': 'https://api.github.com/users/shouichi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shouichi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shouichi/subscriptions', 'organizations_url': 'https://api.github.com/users/shouichi/orgs', 'repos_url': 'https://api.github.com/users/shouichi/repos', 'events_url': 'https://api.github.com/users/shouichi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shouichi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2022-07-11T00:42:26Z,2022-07-22T10:29:26Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45558', 'html_url': 'https://github.com/rails/rails/pull/45558', 'diff_url': 'https://github.com/rails/rails/pull/45558.diff', 'patch_url': 'https://github.com/rails/rails/pull/45558.patch', 'merged_at': None}","### Summary

Currently, `TimeWithZone#time` returns UTC where time zone offset is
added/subtracted. So the value is semantically incorrect. This PR fixes it to
return local time.

Close https://github.com/rails/rails/issues/45548.

### Other Information

None.","{'url': 'https://api.github.com/repos/rails/rails/issues/45558/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45558/timeline,,
https://api.github.com/repos/rails/rails/issues/45552,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45552/labels{/name},https://api.github.com/repos/rails/rails/issues/45552/comments,https://api.github.com/repos/rails/rails/issues/45552/events,https://github.com/rails/rails/issues/45552,1299474420,I_kwDNIULOTXRn9A,45552,Rails 7.0.3 Db migration with multiple Databases disturbing tasks name change when using database_tasks: in database.yml,"{'login': 'net1957', 'id': 17736, 'node_id': 'MDQ6VXNlcjE3NzM2', 'avatar_url': 'https://avatars.githubusercontent.com/u/17736?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/net1957', 'html_url': 'https://github.com/net1957', 'followers_url': 'https://api.github.com/users/net1957/followers', 'following_url': 'https://api.github.com/users/net1957/following{/other_user}', 'gists_url': 'https://api.github.com/users/net1957/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/net1957/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/net1957/subscriptions', 'organizations_url': 'https://api.github.com/users/net1957/orgs', 'repos_url': 'https://api.github.com/users/net1957/repos', 'events_url': 'https://api.github.com/users/net1957/events{/privacy}', 'received_events_url': 'https://api.github.com/users/net1957/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,"{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,5,2022-07-08T22:00:48Z,2022-10-17T18:32:32Z,,NONE,,,,"### Steps to reproduce
with the following databse.yml
```ruby
default: &default
  adapter: sqlite3
  pool: <%= ENV.fetch(""RAILS_MAX_THREADS"") { 5 } %>
  timeout: 5000

development:
  primary:
    <<: *default
    database: db/development.sqlite3
  comdev_fr:
    <<: *default
    migrations_paths: db/migrate_comdev_fr
    database: db/development_comdev_fr.sqlite3
```
the bin/rails -T return (filterer on db:migrate):

rails db:migrate                         # Migrate the database (options: V...
rails db:migrate:comdev_fr               # Migrate comdev_fr database for c...
rails db:migrate:down                    # Runs the ""down"" for a given migr...
rails db:migrate:primary                 # Migrate primary database for cur...
rails db:migrate:redo                    # Rolls back the database one migr...
rails db:migrate:redo:comdev_fr          # Rolls back comdev_fr database on...
rails db:migrate:redo:primary            # Rolls back primary database one ...
rails db:migrate:status                  # Display status of migrations
rails db:migrate:status:comdev_fr        # Display status of migrations for...
rails db:migrate:status:primary          # Display status of migrations for...
rails db:migrate:up                      # Runs the ""up"" for a given migrat...

in most update/install script we use only the tasks related to the primary db:
rails db:migrate:primary                 # example

With the following databse.yml
```ruby
default: &default
  adapter: sqlite3
  pool: <%= ENV.fetch(""RAILS_MAX_THREADS"") { 5 } %>
  timeout: 5000

development:
  primary:
    <<: *default
    database: db/development.sqlite3
  comdev_fr:
    <<: *default
    database_tasks: false
    migrations_paths: db/migrate_comdev_fr
    database: db/development_comdev_fr.sqlite3
```
the bin/rails -T return (filterer on db:migrate):

rails db:migrate                         # Migrate the database (options: V...
rails db:migrate:down                    # Runs the ""down"" for a given migr...
rails db:migrate:redo                    # Rolls back the database one migr...
rails db:migrate:status                  # Display status of migrations
rails db:migrate:up                      # Runs the ""up"" for a given migrat...

and 
rails db:migrate:primary command is not found and so our script fail.

I have tried with more DB and as soon only 1DB has database_tasks: true (the default),
the tasks related to multi-db don't exist any more

I would be nice that in this case
the task related to the primary db don't disappear.

rails db:migrate:primary  # should be here

*** Why?
In the future if we add a new DB that support migrations, the commands for migrating the primary DB
change from 
rails db:migrate
to
rails db:migrate:primary

and most time migration are done DB by DB in separate scripts, that we need to change.

So it would be nice  to allow the  task rails db:migrate:xxxx to exist even if it's the only DB with database_tasks: true (the default)

### System configuration
**Rails version**: 7.0.3

**Ruby version**: 3.0.4
","{'url': 'https://api.github.com/repos/rails/rails/issues/45552/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45552/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/45549,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45549/labels{/name},https://api.github.com/repos/rails/rails/issues/45549/comments,https://api.github.com/repos/rails/rails/issues/45549/events,https://github.com/rails/rails/pull/45549,1299417226,PR_kwDNIULOOyD3pA,45549,Include `:rich_text_area` Capybara selector in `:_field` filter set,"{'login': 'seanpdoyle', 'id': 2575027, 'node_id': 'MDQ6VXNlcjI1NzUwMjc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2575027?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/seanpdoyle', 'html_url': 'https://github.com/seanpdoyle', 'followers_url': 'https://api.github.com/users/seanpdoyle/followers', 'following_url': 'https://api.github.com/users/seanpdoyle/following{/other_user}', 'gists_url': 'https://api.github.com/users/seanpdoyle/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/seanpdoyle/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/seanpdoyle/subscriptions', 'organizations_url': 'https://api.github.com/users/seanpdoyle/orgs', 'repos_url': 'https://api.github.com/users/seanpdoyle/repos', 'events_url': 'https://api.github.com/users/seanpdoyle/events{/privacy}', 'received_events_url': 'https://api.github.com/users/seanpdoyle/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,5,2022-07-08T20:25:17Z,2023-08-08T18:30:18Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45549', 'html_url': 'https://github.com/rails/rails/pull/45549', 'diff_url': 'https://github.com/rails/rails/pull/45549.diff', 'patch_url': 'https://github.com/rails/rails/pull/45549.patch', 'merged_at': None}","### Summary

Add the `:rich_text_area` to the `:_field` filter set, along with other
form controls like `<input>` and `<textarea>` elements so that
`assert_field` and `find(:field, ...)` can resolve to `<trix-editor>`
elements.","{'url': 'https://api.github.com/repos/rails/rails/issues/45549/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45549/timeline,,
https://api.github.com/repos/rails/rails/issues/45548,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45548/labels{/name},https://api.github.com/repos/rails/rails/issues/45548/comments,https://api.github.com/repos/rails/rails/issues/45548/events,https://github.com/rails/rails/issues/45548,1298872874,I_kwDNIULOTWs6Kg,45548,TimeWithZone#time returns incorrect time,"{'login': 'shouichi', 'id': 99586, 'node_id': 'MDQ6VXNlcjk5NTg2', 'avatar_url': 'https://avatars.githubusercontent.com/u/99586?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shouichi', 'html_url': 'https://github.com/shouichi', 'followers_url': 'https://api.github.com/users/shouichi/followers', 'following_url': 'https://api.github.com/users/shouichi/following{/other_user}', 'gists_url': 'https://api.github.com/users/shouichi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shouichi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shouichi/subscriptions', 'organizations_url': 'https://api.github.com/users/shouichi/orgs', 'repos_url': 'https://api.github.com/users/shouichi/repos', 'events_url': 'https://api.github.com/users/shouichi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shouichi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2022-07-08T11:09:34Z,2022-07-23T17:52:34Z,,CONTRIBUTOR,,,,"### Steps to reproduce

```ruby
> jst = Time.find_zone!(""Asia/Tokyo"").parse(""2022-03-30T23:59:59Z"")
> jst.utc
=> 2022-03-30 23:59:59 UTC # correct
> jst.time
=> 2022-03-31 08:59:59 UTC # wrong
```

### Expected behavior

Returns the time in the local time zone? Or if it returns UTC, it should at least match with the `TimeWithZone#utc`.

### Actual behavior

Returns UTC where the time zone offset is added/subtracted.

### System configuration
**Rails version**: ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-linux]

**Ruby version**: Rails 7.0.3","{'url': 'https://api.github.com/repos/rails/rails/issues/45548/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45548/timeline,,
https://api.github.com/repos/rails/rails/issues/45545,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45545/labels{/name},https://api.github.com/repos/rails/rails/issues/45545/comments,https://api.github.com/repos/rails/rails/issues/45545/events,https://github.com/rails/rails/pull/45545,1298097426,PR_kwDNIULOOw7sHg,45545,Support parameter filtering based on allow lists,"{'login': 'p8', 'id': 28561, 'node_id': 'MDQ6VXNlcjI4NTYx', 'avatar_url': 'https://avatars.githubusercontent.com/u/28561?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/p8', 'html_url': 'https://github.com/p8', 'followers_url': 'https://api.github.com/users/p8/followers', 'following_url': 'https://api.github.com/users/p8/following{/other_user}', 'gists_url': 'https://api.github.com/users/p8/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/p8/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/p8/subscriptions', 'organizations_url': 'https://api.github.com/users/p8/orgs', 'repos_url': 'https://api.github.com/users/p8/repos', 'events_url': 'https://api.github.com/users/p8/events{/privacy}', 'received_events_url': 'https://api.github.com/users/p8/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,4,2022-07-07T21:01:32Z,2022-11-10T21:47:26Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45545', 'html_url': 'https://github.com/rails/rails/pull/45545', 'diff_url': 'https://github.com/rails/rails/pull/45545.diff', 'patch_url': 'https://github.com/rails/rails/pull/45545.patch', 'merged_at': None}","### Summary

`ActiveSupport::ParameterFilter` currently works as a deny list: you
specify the parameters that should be filtered. If you want to specify
the parameters that should be allowed you could do it with a lambda, for
example:

```ruby
Rails.application.config.filter_parameters += [
  lambda { |key, value|
    value.replace('[FILTERED]') unless key.in?(:id)
  }
]
```

But this can be error prone. For example this doesn't work if a value is
nil.

This change makes it possible to list the parameters that are allowed.
All other parameters will be masked.

For example, to only allow primary keys and foreign keys you could
configure the following:
```ruby
Rails.application.config.allow_parameters = [:id, /_id\z/]
```

`allow_parameters` takes precedence over `filter_parameters`. So if the
`allow_parameters` are defined `filter_parameters` will be ignored.

The majority of the tests are based on the deny list equivalent:
- The `RequestParameterAllowFilter` test is based on `RequestParameterFilter` test.
- `activerecord/test/cases/allow_attributes_test.rb` is based on `activerecord/test/cases/filter_attributes_test.rb`

The current implementation of ParameterAllowFilter supports all features
from ParameterFilter, including lambdas. But maybe it should be
simplified instead by removing lambda support.","{'url': 'https://api.github.com/repos/rails/rails/issues/45545/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45545/timeline,,
https://api.github.com/repos/rails/rails/issues/45530,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45530/labels{/name},https://api.github.com/repos/rails/rails/issues/45530/comments,https://api.github.com/repos/rails/rails/issues/45530/events,https://github.com/rails/rails/pull/45530,1295249622,PR_kwDNIULOOufcVw,45530,Remove adding sprockets during app:update,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-07-06T06:28:53Z,2022-07-06T06:28:56Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45530', 'html_url': 'https://github.com/rails/rails/pull/45530', 'diff_url': 'https://github.com/rails/rails/pull/45530.diff', 'patch_url': 'https://github.com/rails/rails/pull/45530.patch', 'merged_at': None}","### Summary

This was useful during the upgrade to Rails 7, but apps upgrading from 7
to 7.1 shouldn't need this line added again.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45530/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45530/timeline,,
https://api.github.com/repos/rails/rails/issues/45529,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45529/labels{/name},https://api.github.com/repos/rails/rails/issues/45529/comments,https://api.github.com/repos/rails/rails/issues/45529/events,https://github.com/rails/rails/pull/45529,1295233245,PR_kwDNIULOOuehuw,45529,Fix adding sprockets-rails during upgrade (7-0-stable),"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2022-07-06T06:17:28Z,2022-08-30T21:13:49Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45529', 'html_url': 'https://github.com/rails/rails/pull/45529', 'diff_url': 'https://github.com/rails/rails/pull/45529.diff', 'patch_url': 'https://github.com/rails/rails/pull/45529.patch', 'merged_at': None}","### Summary

The previous strategy for adding `sprockets-rails` did not work for two
reasons:
- the regular expression would only match `require(""rails/all"")` (with
  parentheses) and not `require ""rails/all""`
- adding a require in `config/application` by itself doesn't solve the
  issue that `sprockets-rails` is no longer a dependency of `rails` and
  so must be added back to the Gemfile if it isn't a transitive
  dependency

This commit addresses those issues by ensuring sprockets-rails remains a
dependency in upgraded applications. The gem will not be added back for
application that previously skipped sprockets, which is determined by
the presence of `require ""rails/all""` or `require ""sprockets/railtie""`
in `config/application.rb`.

`active_storage:update` cannot be run inline since the bundle changes,
so the environment needs to fully reload.

Fixes #45295

### Other Information

This is intentionally being opened against `7-0-stable` because the `7.0 -> 7.1` upgrade task should not still be dealing with the sprockets change.","{'url': 'https://api.github.com/repos/rails/rails/issues/45529/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45529/timeline,,
https://api.github.com/repos/rails/rails/issues/45500,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45500/labels{/name},https://api.github.com/repos/rails/rails/issues/45500/comments,https://api.github.com/repos/rails/rails/issues/45500/events,https://github.com/rails/rails/issues/45500,1290469117,I_kwDNIULOTOr-_Q,45500,url_options are wrong after accessing engine route in integration tests,"{'login': 'brandoncc', 'id': 543973, 'node_id': 'MDQ6VXNlcjU0Mzk3Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/543973?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/brandoncc', 'html_url': 'https://github.com/brandoncc', 'followers_url': 'https://api.github.com/users/brandoncc/followers', 'following_url': 'https://api.github.com/users/brandoncc/following{/other_user}', 'gists_url': 'https://api.github.com/users/brandoncc/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/brandoncc/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/brandoncc/subscriptions', 'organizations_url': 'https://api.github.com/users/brandoncc/orgs', 'repos_url': 'https://api.github.com/users/brandoncc/repos', 'events_url': 'https://api.github.com/users/brandoncc/events{/privacy}', 'received_events_url': 'https://api.github.com/users/brandoncc/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 35206628, 'node_id': 'MDU6TGFiZWwzNTIwNjYyOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/routing', 'name': 'routing', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2022-06-30T17:56:44Z,2023-06-11T21:20:20Z,,CONTRIBUTOR,,,,"### Steps to reproduce

1. In an `ActionDispatch::IntegrationTest`, access (`get`/`post`/etc) a route that is provided by an engine.
2. Try using a route helper that is part of the core Rails application.

@gmcgibbon and I paired on this and believe that the issue lies in [this method](https://github.com/rails/rails/blob/d44e786d216f82584c7752ffee91ef4d5bea14ba/actionpack/lib/action_dispatch/testing/integration.rb#L133-L143).

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""action_controller/railtie""

module Hemi
  class Engine < ::Rails::Engine
    def self.find_root(_)
      __dir__
    end

    isolate_namespace Hemi

    routes.draw do
      post ""/example"" => ""repro#example"", as: :repro_example
    end
  end

  class ReproController < ActionController::Base
    include Engine.routes.url_helpers

    def example
      head 201
    end
  end
end

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""www.example.com""

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    get ""/"" => ""test#index"", as: ""slash""
    mount Hemi::Engine, at: ""/hemi""
  end
end

class TestController < ActionController::Base
  include Rails.application.routes.url_helpers

  def index
    render plain: ""Home""
  end
end

require ""minitest/autorun""
require ""rack/test""

class BugTest < ActionDispatch::IntegrationTest
  def test_url_is_correct_after_accessing_engine_path
    post hemi.repro_example_path
    assert_equal ""/"", slash_path
  end

  def test_url_is_correct_after_accessing_application_path
    post hemi.repro_example_path

    # resets `controller.url_options`
    get ""/""
    assert_equal ""/"", slash_path
  end

  private

  def app
    Rails.application
  end
end
```

### Expected behavior

I expect `slash_path` to always return `""/""`, and not be dependent on the last route accessed.

### Actual behavior

After accessing an engine route, `controller.url_options` represents the engine, so the engine's mount point (""script_name"" header) is prepended to the output of route helpers from the core Rails application.

Accessing a route from the core Rails application again resets `controller.url_options` and the output of the route helpers will once again be what you expect.

### System configuration
**Rails version**: 7.1.0.alpha from https://github.com/rails/rails.git (at main@c704da6)

**Ruby version**: 3.1.2
","{'url': 'https://api.github.com/repos/rails/rails/issues/45500/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45500/timeline,,
https://api.github.com/repos/rails/rails/issues/45488,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45488/labels{/name},https://api.github.com/repos/rails/rails/issues/45488/comments,https://api.github.com/repos/rails/rails/issues/45488/events,https://github.com/rails/rails/pull/45488,1288356003,PR_kwDNIULOOoxNWw,45488,Changes to/for minitest 5.16.1,"{'login': 'zenspider', 'id': 9832, 'node_id': 'MDQ6VXNlcjk4MzI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9832?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zenspider', 'html_url': 'https://github.com/zenspider', 'followers_url': 'https://api.github.com/users/zenspider/followers', 'following_url': 'https://api.github.com/users/zenspider/following{/other_user}', 'gists_url': 'https://api.github.com/users/zenspider/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zenspider/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zenspider/subscriptions', 'organizations_url': 'https://api.github.com/users/zenspider/orgs', 'repos_url': 'https://api.github.com/users/zenspider/repos', 'events_url': 'https://api.github.com/users/zenspider/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zenspider/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,7,2022-06-29T08:28:13Z,2022-11-30T04:23:08Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45488', 'html_url': 'https://github.com/rails/rails/pull/45488', 'diff_url': 'https://github.com/rails/rails/pull/45488.diff', 'patch_url': 'https://github.com/rails/rails/pull/45488.patch', 'merged_at': None}","### Summary

This bumps to minitest 5.16.1 and adds `MT_KWARGS_HACK=1` to the env for CI.

Happy to jettison the AM hack and/or put it in a different PR.

### Other Information

This is an attempt to fix failures as reported by @eileencodes in minitest/minitest#912

Boy I hope contributor PRs run the CI...","{'url': 'https://api.github.com/repos/rails/rails/issues/45488/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45488/timeline,,
https://api.github.com/repos/rails/rails/issues/45471,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45471/labels{/name},https://api.github.com/repos/rails/rails/issues/45471/comments,https://api.github.com/repos/rails/rails/issues/45471/events,https://github.com/rails/rails/pull/45471,1285755644,PR_kwDNIULOOmnqzw,45471,Added ability to add format to model attribute error key,"{'login': 'ygreeek', 'id': 28986533, 'node_id': 'MDQ6VXNlcjI4OTg2NTMz', 'avatar_url': 'https://avatars.githubusercontent.com/u/28986533?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ygreeek', 'html_url': 'https://github.com/ygreeek', 'followers_url': 'https://api.github.com/users/ygreeek/followers', 'following_url': 'https://api.github.com/users/ygreeek/following{/other_user}', 'gists_url': 'https://api.github.com/users/ygreeek/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ygreeek/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ygreeek/subscriptions', 'organizations_url': 'https://api.github.com/users/ygreeek/orgs', 'repos_url': 'https://api.github.com/users/ygreeek/repos', 'events_url': 'https://api.github.com/users/ygreeek/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ygreeek/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2022-06-27T12:46:58Z,2022-06-27T13:02:02Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45471', 'html_url': 'https://github.com/rails/rails/pull/45471', 'diff_url': 'https://github.com/rails/rails/pull/45471.diff', 'patch_url': 'https://github.com/rails/rails/pull/45471.patch', 'merged_at': None}","I've added ability to add format to model attribute error key
What problem does it solve?
For example we have following locale.yaml:
```
company:
  attributes:
    provider:
      already_used_by_other_provider: ""Already used by other provider""
      already_registered_by_another_provider: ""already registered by another provider""
```
We want to show full_error of **already_used_by_other_provider** key as `%{message}`, but want the **already_registered_by_another_provider** error key as `%{attribute} %{message}`

This can now be achieved by declaring the format like this:
```
company:
  attributes:
    provider:
      already_used_by_other_provider: 
        message: ""Already used by other provider""
        format: ""%{message}""
      already_registered_by_another_provider: ""already registered by another provider""
```","{'url': 'https://api.github.com/repos/rails/rails/issues/45471/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45471/timeline,,
https://api.github.com/repos/rails/rails/issues/45458,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45458/labels{/name},https://api.github.com/repos/rails/rails/issues/45458/comments,https://api.github.com/repos/rails/rails/issues/45458/events,https://github.com/rails/rails/pull/45458,1283810291,PR_kwDNIULOOlD96w,45458,Allow configuration of embeddable storage service for ActionText via `has_rich_text`,"{'login': 'mihaic195', 'id': 34626017, 'node_id': 'MDQ6VXNlcjM0NjI2MDE3', 'avatar_url': 'https://avatars.githubusercontent.com/u/34626017?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/mihaic195', 'html_url': 'https://github.com/mihaic195', 'followers_url': 'https://api.github.com/users/mihaic195/followers', 'following_url': 'https://api.github.com/users/mihaic195/following{/other_user}', 'gists_url': 'https://api.github.com/users/mihaic195/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/mihaic195/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/mihaic195/subscriptions', 'organizations_url': 'https://api.github.com/users/mihaic195/orgs', 'repos_url': 'https://api.github.com/users/mihaic195/repos', 'events_url': 'https://api.github.com/users/mihaic195/events{/privacy}', 'received_events_url': 'https://api.github.com/users/mihaic195/received_events', 'type': 'User', 'site_admin': False}","[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,3,2022-06-24T14:18:21Z,2023-08-03T20:27:57Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45458', 'html_url': 'https://github.com/rails/rails/pull/45458', 'diff_url': 'https://github.com/rails/rails/pull/45458.diff', 'patch_url': 'https://github.com/rails/rails/pull/45458.patch', 'merged_at': None}","### Summary

Fixes: https://github.com/rails/rails/issues/45405

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->

This is what I came up with. Essentially, it allows specifying `attachment_service` when defining `has_rich_text` association on a model.

Not sure how to write the tests for it though.

cc @skipkayhil ","{'url': 'https://api.github.com/repos/rails/rails/issues/45458/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45458/timeline,,
https://api.github.com/repos/rails/rails/issues/45445,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45445/labels{/name},https://api.github.com/repos/rails/rails/issues/45445/comments,https://api.github.com/repos/rails/rails/issues/45445/events,https://github.com/rails/rails/pull/45445,1282642155,PR_kwDNIULOOkF-2w,45445,Action cable command callbacks testing,"{'login': 'palkan', 'id': 1516722, 'node_id': 'MDQ6VXNlcjE1MTY3MjI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1516722?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/palkan', 'html_url': 'https://github.com/palkan', 'followers_url': 'https://api.github.com/users/palkan/followers', 'following_url': 'https://api.github.com/users/palkan/following{/other_user}', 'gists_url': 'https://api.github.com/users/palkan/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/palkan/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/palkan/subscriptions', 'organizations_url': 'https://api.github.com/users/palkan/orgs', 'repos_url': 'https://api.github.com/users/palkan/repos', 'events_url': 'https://api.github.com/users/palkan/events{/privacy}', 'received_events_url': 'https://api.github.com/users/palkan/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2022-06-23T16:09:13Z,2023-04-25T18:36:56Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45445', 'html_url': 'https://github.com/rails/rails/pull/45445', 'diff_url': 'https://github.com/rails/rails/pull/45445.diff', 'patch_url': 'https://github.com/rails/rails/pull/45445.patch', 'merged_at': None}","### Summary

This is the follow-up for #44696.

I found that testing callbacks is currently not supported due to some limitations of our test stubs.

### Other Information

I don't really like the way Action Cable testing currently uses connection stubs, but this is the limitation of the current library design (connections are highly coupled with event loops and servers). Back in a while, I tried to tackle this: https://github.com/rails/rails/pull/27648. Maybe, we should re-visit this problem in the future (for Rails 8, maybe?).","{'url': 'https://api.github.com/repos/rails/rails/issues/45445/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45445/timeline,,
https://api.github.com/repos/rails/rails/issues/45442,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45442/labels{/name},https://api.github.com/repos/rails/rails/issues/45442/comments,https://api.github.com/repos/rails/rails/issues/45442/events,https://github.com/rails/rails/pull/45442,1282501642,PR_kwDNIULOOj-PBQ,45442,Add optional HTTP method for service direct uploads,"{'login': 'virolea', 'id': 3525369, 'node_id': 'MDQ6VXNlcjM1MjUzNjk=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3525369?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/virolea', 'html_url': 'https://github.com/virolea', 'followers_url': 'https://api.github.com/users/virolea/followers', 'following_url': 'https://api.github.com/users/virolea/following{/other_user}', 'gists_url': 'https://api.github.com/users/virolea/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/virolea/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/virolea/subscriptions', 'organizations_url': 'https://api.github.com/users/virolea/orgs', 'repos_url': 'https://api.github.com/users/virolea/repos', 'events_url': 'https://api.github.com/users/virolea/events{/privacy}', 'received_events_url': 'https://api.github.com/users/virolea/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,5,2022-06-23T14:30:25Z,2022-06-30T08:56:03Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45442', 'html_url': 'https://github.com/rails/rails/pull/45442', 'diff_url': 'https://github.com/rails/rails/pull/45442.diff', 'patch_url': 'https://github.com/rails/rails/pull/45442.patch', 'merged_at': None}","### Summary

When building a new `Service` for ActiveStorage, one only can `PUT` requests to the direct upload endpoints for that service. Or, some services accept `POST` to their endpoint (such as Cloudinary and Wistia), which makes implementing such services with `ActiveStorage` harder, it requires more custom code and deep dive into the lib.

In this PR, a default HTTP method for direct uploads is added to the `Service` class. It defaults to `PUT` so previously developed service work exactly the same. 

One can override this method in their service class by simply declaring : 

```ruby 
class ActiveStorage::Service::MyCustomService < ActiveStorage::Service
 # [...]
  def method_for_direct_upload 
    ""POST""
  end
  # [...]
end

```
","{'url': 'https://api.github.com/repos/rails/rails/issues/45442/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45442/timeline,,
https://api.github.com/repos/rails/rails/issues/45437,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45437/labels{/name},https://api.github.com/repos/rails/rails/issues/45437/comments,https://api.github.com/repos/rails/rails/issues/45437/events,https://github.com/rails/rails/pull/45437,1281321568,PR_kwDNIULOOi8-ew,45437,Deprecate implicit conversion of Duration,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,8,2022-06-23T00:00:12Z,2023-09-09T19:54:15Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45437', 'html_url': 'https://github.com/rails/rails/pull/45437', 'diff_url': 'https://github.com/rails/rails/pull/45437.diff', 'patch_url': 'https://github.com/rails/rails/pull/45437.patch', 'merged_at': None}","The presence of method_missing on Duration can lead to some very confusing behavior:

```ruby
1.year.days # => 31556952 Days
```

Methods to convert from duration to a specific unit were added in 7bd9603778c059d8f0969feaadb26672534dbece and a2535d9fe91f58aafc7206a8a51dd29a06ecbf61, but the confusing methods they were meant to replace were left in.

This change fixes this by deprecating method_missing and reimplementing or explicitly delegating methods that make sense to keep.

In addition, there are many existing methods on Duration that can result in surprising results or incorrect units. Many methods will treat Numerics implicitly as a number of seconds, which can easily lead to unexpected behavior. In addition, there are cases like two Durations multiplied together which should result in a unit of time^2 and so should not return another Duration. These specific instances have also been deprecated:

- equality of Duration and Numeric (`1.minute == 1 # => false`)

- comparing Durations and Numerics (`5 > 2.minutes # => false`)

- adding/subtracting Durations and Numerics (`5 + 2.minutes # => 2
  minutes and 5 seconds`)

- Numeric / Duration (`3 / 2.seconds # => 1` but should have a unit of `second^-1`)

- Numeric % Duration (`3 % 2.minutes # => 3 seconds`)

- Duration * Duration (`3.days * 2.days # => 518400 days` but should really be `6 days^2`)

Other deprecations:

- Duration#is_a? returning true for value's class

- Duration#instance_of? returning true for value's class

Fixes #45433 
","{'url': 'https://api.github.com/repos/rails/rails/issues/45437/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45437/timeline,,
https://api.github.com/repos/rails/rails/issues/45433,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45433/labels{/name},https://api.github.com/repos/rails/rails/issues/45433/comments,https://api.github.com/repos/rails/rails/issues/45433/events,https://github.com/rails/rails/issues/45433,1280826386,I_kwDNIULOTFfcEg,45433,"`1.years.hours`, `1.year.days`, and other duration methods called on `1.year` all return the number of seconds in a year. ","{'login': 'db00m', 'id': 85647423, 'node_id': 'MDQ6VXNlcjg1NjQ3NDIz', 'avatar_url': 'https://avatars.githubusercontent.com/u/85647423?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/db00m', 'html_url': 'https://github.com/db00m', 'followers_url': 'https://api.github.com/users/db00m/followers', 'following_url': 'https://api.github.com/users/db00m/following{/other_user}', 'gists_url': 'https://api.github.com/users/db00m/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/db00m/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/db00m/subscriptions', 'organizations_url': 'https://api.github.com/users/db00m/orgs', 'repos_url': 'https://api.github.com/users/db00m/repos', 'events_url': 'https://api.github.com/users/db00m/events{/privacy}', 'received_events_url': 'https://api.github.com/users/db00m/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2022-06-22T20:19:24Z,2022-06-23T00:13:24Z,,NONE,,,,"This issue is small and relatively unimportant, but it's still a bug that could cause problems in the future.  I use `1.year.seconds` to get the number of seconds and was about to use `1.year.days` to get the number of days in a year until I noticed the bug.

### Steps to reproduce
When running the rails console (assuming that doing so will load ActiveSupport) run the following lines of code:
``` ruby
1.year.seconds

1.year.hours

1.year.days
```
Every line returns the same number31556952which is the number of seconds in a year.

### Expected behavior
I expect that `1.year.days` should return the number of days in a year.  The same should be the case for all other duration related methods that could be called on `Integer.year`

### Actual behavior
Each duration method returns the number of seconds in a year rather than the number of Days, Hours, or other duration types called on `Integer.year`.

### System configuration
**Rails Version**: 6.1.5

**Ruby Version**: 3.0.3

Another note on system config: After discovering this bug in the project I was working on, I created an empty project to make sure the issue didn't come from conflicting gems.  The result was the same.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45433/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45433/timeline,,
https://api.github.com/repos/rails/rails/issues/45432,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45432/labels{/name},https://api.github.com/repos/rails/rails/issues/45432/comments,https://api.github.com/repos/rails/rails/issues/45432/events,https://github.com/rails/rails/pull/45432,1280800660,PR_kwDNIULOOif5UQ,45432,Allow controller#render to pass blocks to renderables,"{'login': 'BlakeWilliams', 'id': 342554, 'node_id': 'MDQ6VXNlcjM0MjU1NA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/342554?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/BlakeWilliams', 'html_url': 'https://github.com/BlakeWilliams', 'followers_url': 'https://api.github.com/users/BlakeWilliams/followers', 'following_url': 'https://api.github.com/users/BlakeWilliams/following{/other_user}', 'gists_url': 'https://api.github.com/users/BlakeWilliams/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/BlakeWilliams/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/BlakeWilliams/subscriptions', 'organizations_url': 'https://api.github.com/users/BlakeWilliams/orgs', 'repos_url': 'https://api.github.com/users/BlakeWilliams/repos', 'events_url': 'https://api.github.com/users/BlakeWilliams/events{/privacy}', 'received_events_url': 'https://api.github.com/users/BlakeWilliams/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2022-06-22T19:59:28Z,2023-03-27T23:34:04Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45432', 'html_url': 'https://github.com/rails/rails/pull/45432', 'diff_url': 'https://github.com/rails/rails/pull/45432.diff', 'patch_url': 'https://github.com/rails/rails/pull/45432.patch', 'merged_at': None}","### Summary

Currently when controllers render Renderables (objects that respond to
`#render_in`) blocks aren't passed to the renderable object. This
differs from the `render` method in the view which does allow blocks to
be passed.

e.g.

```erb
<%= render MyRenderable.new do %>
  Hello, world
<% end %>
```

In controllers, the block in the following example will be silently ignored without 
this patch:

```ruby
class MyController < ApplicationController
  def show
    # Block is silently ignored
    render MyRenderable.new do
      ""Hello, world""
    end
  end
end
```

This change allows controllers to pass blocks to renderables, matching
the behavior of the view `render` method. It does so by passing the
block through the call chain until it can be stored in the `options`
hash. From there we pass the block to
`ActionView::Template::Renderable.new` and the block is properly passed
to the `render_in` method when `ActionView::Template::Renderable#render`
is called.

* Updates controller code to pass the block from `#render` until
  arguments are normalized.
* Stores `block` in the `options` hash that is passed throughout the
  rendering call stack.
* Updates `ActionView::Template::Renderable` to accept a block, which is
  then passed to the renderables `render_in` method.
* Adds a test validating that blocks can be passed from controller
  renderers.","{'url': 'https://api.github.com/repos/rails/rails/issues/45432/reactions', 'total_count': 2, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45432/timeline,,
https://api.github.com/repos/rails/rails/issues/45431,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45431/labels{/name},https://api.github.com/repos/rails/rails/issues/45431/comments,https://api.github.com/repos/rails/rails/issues/45431/events,https://github.com/rails/rails/issues/45431,1280798406,I_kwDNIULOTFduxg,45431,Move `test:prepare` task to the main rails tasks from test_unit railtie,"{'login': 'simmerz', 'id': 24327, 'node_id': 'MDQ6VXNlcjI0MzI3', 'avatar_url': 'https://avatars.githubusercontent.com/u/24327?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/simmerz', 'html_url': 'https://github.com/simmerz', 'followers_url': 'https://api.github.com/users/simmerz/followers', 'following_url': 'https://api.github.com/users/simmerz/following{/other_user}', 'gists_url': 'https://api.github.com/users/simmerz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/simmerz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/simmerz/subscriptions', 'organizations_url': 'https://api.github.com/users/simmerz/orgs', 'repos_url': 'https://api.github.com/users/simmerz/repos', 'events_url': 'https://api.github.com/users/simmerz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/simmerz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2022-06-22T19:57:29Z,2022-12-08T03:04:11Z,,NONE,,,,"Presently, `test:prepare` is only defined in the test_unit railtie rake task as a placeholder to be hooked on to.

The `tailwindcss-rails`, `cssbundling-rails` and `jsbundling-rails` all enhance the task to allow tests to pre-compile to `app/assets/build`.

However, for those of us using RSpec, there is no way without additional configuration to pre-compile those assets (we don't want to run `assets:precompile` either because that's utterly confusing for the developer when changes made to app/assets/* subsequently don't appear to work).

Because the Rakefile in a Rails app loads all the application rake tasks by default, then those from gems and then those in lib/tasks last of all, not including test_unit means there's no sensible way to ensure that a placeholder task exists *before* tailwindcss-rails etc enhance it, short of specifically putting the gems higher in the gemfile - that's not clear to the developer, and doesn't follow the convention that Rails should be easy to work with.

`rspec-rails` already invokes `test:prepare` if it is defined, so it seems to me to make a great deal of sense to move this placeholder into the main rails tasks and then document it as a placeholder to be enhanced by other tasks.

If you're amenable to that, I'd be happy to raise a PR for it.","{'url': 'https://api.github.com/repos/rails/rails/issues/45431/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45431/timeline,,
https://api.github.com/repos/rails/rails/issues/45422,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45422/labels{/name},https://api.github.com/repos/rails/rails/issues/45422/comments,https://api.github.com/repos/rails/rails/issues/45422/events,https://github.com/rails/rails/pull/45422,1279086763,PR_kwDNIULOOhBP_Q,45422,Add separate guides page listing Rails versions,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2022-06-21T21:04:40Z,2022-06-30T08:00:49Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45422', 'html_url': 'https://github.com/rails/rails/pull/45422', 'diff_url': 'https://github.com/rails/rails/pull/45422.diff', 'patch_url': 'https://github.com/rails/rails/pull/45422.patch', 'merged_at': None}","The purpose of this page is to provide a single location that any version of the guides can link to in order for the user to navigate to any other version of the guides.

For example, https://guides.rubyonrails.org/v6.1/index.html can link to https://guides.rubyonrails.org/versions.html, and the user will be able to navigate to https://guides.rubyonrails.org/v7.0/index.html, even after v7.0 is no longer the latest release and the v6.1 guides are no longer updated.

This commit also links the version badge displayed at the top of each page to the versions page.

| Before | After |
| --- | --- |
| ![stable-guides-before](https://user-images.githubusercontent.com/771968/174896347-a20f2764-9fea-44e6-9a7e-0905efbe64e7.png) | ![stable-guides-after](https://user-images.githubusercontent.com/771968/174896365-a743f0e7-6a95-4365-bb04-10b57df0eba6.png) |
| ![edge-guides-before](https://user-images.githubusercontent.com/771968/174896379-80d8ddf8-f447-4ce1-98b2-2b9072c1dec1.png) | ![edge-guides-after](https://user-images.githubusercontent.com/771968/174896397-c174161e-c466-4f30-bfc3-58eec9ddcd1e.png) |
| | ![versions](https://user-images.githubusercontent.com/771968/174896420-3b9bf8e3-c55f-4f2c-84c6-b0f64f5bc17b.png) |
","{'url': 'https://api.github.com/repos/rails/rails/issues/45422/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45422/timeline,,
https://api.github.com/repos/rails/rails/issues/45413,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45413/labels{/name},https://api.github.com/repos/rails/rails/issues/45413/comments,https://api.github.com/repos/rails/rails/issues/45413/events,https://github.com/rails/rails/pull/45413,1277275543,PR_kwDNIULOOfeyNg,45413,Dynamic Includes,"{'login': 'gwincr11', 'id': 289882, 'node_id': 'MDQ6VXNlcjI4OTg4Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/289882?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/gwincr11', 'html_url': 'https://github.com/gwincr11', 'followers_url': 'https://api.github.com/users/gwincr11/followers', 'following_url': 'https://api.github.com/users/gwincr11/following{/other_user}', 'gists_url': 'https://api.github.com/users/gwincr11/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/gwincr11/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/gwincr11/subscriptions', 'organizations_url': 'https://api.github.com/users/gwincr11/orgs', 'repos_url': 'https://api.github.com/users/gwincr11/repos', 'events_url': 'https://api.github.com/users/gwincr11/events{/privacy}', 'received_events_url': 'https://api.github.com/users/gwincr11/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,1,2022-06-20T18:42:16Z,2022-07-25T01:21:05Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45413', 'html_url': 'https://github.com/rails/rails/pull/45413', 'diff_url': 'https://github.com/rails/rails/pull/45413.diff', 'patch_url': 'https://github.com/rails/rails/pull/45413.patch', 'merged_at': None}","  The next step in building out active record dynamic includes and
  the new load tree debug view as proposed in https://github.com/rails/rails/pull/45071 this build on
  the load tree from https://github.com/rails/rails/pull/45161 and add
  the dynamic includes functionality.

  The dynamic includes functionality is a feature that allows you to
  automatically load the associations for a model when you iterate over
  the record and hit an association that is not yet loaded.

### Example Usage

These examples are taken from the tests added to the PR. Without dynamic includes enabled, the following implementation would execute 9 queries:

```ruby
developers = Developer.where(id: [developer.id, developer2.id])
assert_queries(9) do
  developers.each do |d|
    d.ship.parts.each do |part|
      part.trinkets.each do |t|
        t
      end
    end
  end
end
```

<details>
<summary>SQL Log</summary>

<pre>
D, [2022-05-05T16:18:46.432004 #3280] DEBUG -- :   Developer Load (0.2ms)  SELECT ""developers"".""id"", ""developers"".""name"", ""developers"".""salary"", ""developers"".""firm_id"", ""developers"".""mentor_id"", ""developers"".""legacy_created_at"", ""developers"".""legacy_updated_at"", ""developers"".""legacy_created_on"", ""developers"".""legacy_updated_on"" FROM ""developers"" WHERE ""developers"".""id"" IN (?, ?)  [[""id"", 1], [""id"", 11]]
D, [2022-05-05T16:18:46.432893 #3280] DEBUG -- :   Ship Load (0.1ms)  SELECT ""ships"".* FROM ""ships"" WHERE ""ships"".""developer_id"" = ? LIMIT ?  [[""developer_id"", 1], [""LIMIT"", 1]]
D, [2022-05-05T16:18:46.433554 #3280] DEBUG -- :   ShipPart Load (0.1ms)  SELECT ""ship_parts"".* FROM ""ship_parts"" WHERE ""ship_parts"".""ship_id"" = ?  [[""ship_id"", 2]]
D, [2022-05-05T16:18:46.434335 #3280] DEBUG -- :   Treasure Load (0.1ms)  SELECT ""treasures"".* FROM ""treasures"" WHERE ""treasures"".""looter_id"" = ? AND ""treasures"".""looter_type"" = ?  [[""looter_id"", 1], [""looter_type"", ""ShipPart""]]
D, [2022-05-05T16:18:46.434911 #3280] DEBUG -- :   Treasure Load (0.1ms)  SELECT ""treasures"".* FROM ""treasures"" WHERE ""treasures"".""looter_id"" = ? AND ""treasures"".""looter_type"" = ?  [[""looter_id"", 2], [""looter_type"", ""ShipPart""]]
D, [2022-05-05T16:18:46.435559 #3280] DEBUG -- :   Ship Load (0.0ms)  SELECT ""ships"".* FROM ""ships"" WHERE ""ships"".""developer_id"" = ? LIMIT ?  [[""developer_id"", 11], [""LIMIT"", 1]]
D, [2022-05-05T16:18:46.436479 #3280] DEBUG -- :   ShipPart Load (0.1ms)  SELECT ""ship_parts"".* FROM ""ship_parts"" WHERE ""ship_parts"".""ship_id"" = ?  [[""ship_id"", 751016585]]
D, [2022-05-05T16:18:46.437258 #3280] DEBUG -- :   Treasure Load (0.1ms)  SELECT ""treasures"".* FROM ""treasures"" WHERE ""treasures"".""looter_id"" = ? AND ""treasures"".""looter_type"" = ?  [[""looter_id"", 3], [""looter_type"", ""ShipPart""]]
D, [2022-05-05T16:18:46.438098 #3280] DEBUG -- :   Treasure Load (0.1ms)  SELECT ""treasures"".* FROM ""treasures"" WHERE ""treasures"".""looter_id"" = ? AND ""treasures"".""looter_type"" = ?  [[""looter_id"", 4], [""looter_type"", ""ShipPart""]]
</pre>
</details>


When enabling dynamic includes it happens in 4:

```ruby
developers = Developer.where(id: [developer.id, developer2.id])

ActiveRecord.enable_dynamic_includes do
  assert_queries(4) do
    developers.each do |d|
      d.ship.parts.each do |part|
        part.trinkets.each do |t|
          t
        end
      end
    end
  end
end
```

<details>
<summary>SQL Log</summary>

<pre>
D, [2022-05-05T16:18:46.388805 #3280] DEBUG -- :   Developer Load (0.2ms)  SELECT ""developers"".""id"", ""developers"".""name"", ""developers"".""salary"", ""developers"".""firm_id"", ""developers"".""mentor_id"", ""developers"".""legacy_created_at"", ""developers"".""legacy_updated_at"", ""developers"".""legacy_created_on"", ""developers"".""legacy_updated_on"" FROM ""developers"" WHERE ""developers"".""id"" IN (?, ?)  [[""id"", 1], [""id"", 11]]
D, [2022-05-05T16:18:46.424796 #3280] DEBUG -- :   Ship Load (0.3ms)  SELECT ""ships"".* FROM ""ships"" WHERE ""ships"".""developer_id"" IN (?, ?)  [[""developer_id"", 1], [""developer_id"", 11]]
D, [2022-05-05T16:18:46.425470 #3280] DEBUG -- : Dynamically preloaded: Developer.ship
D, [2022-05-05T16:18:46.427809 #3280] DEBUG -- :   ShipPart Load (0.2ms)  SELECT ""ship_parts"".* FROM ""ship_parts"" WHERE ""ship_parts"".""ship_id"" IN (?, ?)  [[""ship_id"", 2], [""ship_id"", 751016585]]
D, [2022-05-05T16:18:46.428172 #3280] DEBUG -- : Dynamically preloaded: Developer.ship.parts
D, [2022-05-05T16:18:46.430243 #3280] DEBUG -- :   Treasure Load (0.2ms)  SELECT ""treasures"".* FROM ""treasures"" WHERE ""treasures"".""looter_type"" = ? AND ""treasures"".""looter_id"" IN (?, ?, ?, ?)  [[""looter_type"", ""ShipPart""], [""looter_id"", 1], [""looter_id"", 2], [""looter_id"", 3], [""looter_id"", 4]]
D, [2022-05-05T16:18:46.430748 #3280] DEBUG -- : Dynamically preloaded: Developer.ship.parts.trinkets
</pre>

</details>

In some scenarios it is ideal to not preload all the data for a particular algorithm, if perhaps it has a very expensive database query associated and perhaps a select runs prior to loading the data to limit the selected data further in memory, you may want to turn off the dynamic includes in such a scenario. This is an exceptional case but is possible. 

The below example will take 7 queries:

```ruby
ActiveRecord.enable_dynamic_includes do
  developers = Developer.where(id: [developer.id, developer2.id])
  assert_queries(7) do
  developers.each do |d|
    assert ActiveRecord.dynamic_includes_enabled?
    ActiveRecord.disable_dynamic_includes do
      d.ship.parts.each do |part| # This should n+1
        assert_not ActiveRecord.dynamic_includes_enabled?
          ActiveRecord.enable_dynamic_includes do
            part.trinkets.each do |t|
              t
              assert ActiveRecord.dynamic_includes_enabled?
            end
         end
         assert_not ActiveRecord.dynamic_includes_enabled?
       end
     end
     assert ActiveRecord.dynamic_includes_enabled?
   end
 end
end
 ```

<details>
<summary>SQL Log</summary>

```
D, [2022-05-05T16:18:46.439329 #3280] DEBUG -- :   Developer Load (0.2ms)  SELECT ""developers"".""id"", ""developers"".""name"", ""developers"".""salary"", ""developers"".""firm_id"", ""developers"".""mentor_id"", ""developers"".""legacy_created_at"", ""developers"".""legacy_updated_at"", ""developers"".""legacy_created_on"", ""developers"".""legacy_updated_on"" FROM ""developers"" WHERE ""developers"".""id"" IN (?, ?)  [[""id"", 1], [""id"", 11]]
D, [2022-05-05T16:18:46.440002 #3280] DEBUG -- :   Ship Load (0.1ms)  SELECT ""ships"".* FROM ""ships"" WHERE ""ships"".""developer_id"" = ? LIMIT ?  [[""developer_id"", 1], [""LIMIT"", 1]]
D, [2022-05-05T16:18:46.440643 #3280] DEBUG -- :   ShipPart Load (0.1ms)  SELECT ""ship_parts"".* FROM ""ship_parts"" WHERE ""ship_parts"".""ship_id"" = ?  [[""ship_id"", 2]]
D, [2022-05-05T16:18:46.441803 #3280] DEBUG -- :   Treasure Load (0.1ms)  SELECT ""treasures"".* FROM ""treasures"" WHERE ""treasures"".""looter_type"" = ? AND ""treasures"".""looter_id"" IN (?, ?)  [[""looter_type"", ""ShipPart""], [""looter_id"", 1], [""looter_id"", 2]]
D, [2022-05-05T16:18:46.442134 #3280] DEBUG -- : Dynamically preloaded: Developer.ship.parts.trinkets
D, [2022-05-05T16:18:46.442986 #3280] DEBUG -- :   Ship Load (0.1ms)  SELECT ""ships"".* FROM ""ships"" WHERE ""ships"".""developer_id"" = ? LIMIT ?  [[""developer_id"", 11], [""LIMIT"", 1]]
D, [2022-05-05T16:18:46.443639 #3280] DEBUG -- :   ShipPart Load (0.1ms)  SELECT ""ship_parts"".* FROM ""ship_parts"" WHERE ""ship_parts"".""ship_id"" = ?  [[""ship_id"", 751016585]]
D, [2022-05-05T16:18:46.445137 #3280] DEBUG -- :   Treasure Load (0.2ms)  SELECT ""treasures"".* FROM ""treasures"" WHERE ""treasures"".""looter_type"" = ? AND ""treasures"".""looter_id"" IN (?, ?)  [[""looter_type"", ""ShipPart""], [""looter_id"", 3], [""looter_id"", 4]]
D, [2022-05-05T16:18:46.445454 #3280] DEBUG -- : Dynamically preloaded: Developer.ship.parts.trinkets
```

</details>","{'url': 'https://api.github.com/repos/rails/rails/issues/45413/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45413/timeline,,
https://api.github.com/repos/rails/rails/issues/45405,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45405/labels{/name},https://api.github.com/repos/rails/rails/issues/45405/comments,https://api.github.com/repos/rails/rails/issues/45405/events,https://github.com/rails/rails/issues/45405,1276528836,I_kwDNIULOTBZIxA,45405,Allow configuration of embeddables storage service for ActionText via `has_rich_text`,"{'login': 'simmerz', 'id': 24327, 'node_id': 'MDQ6VXNlcjI0MzI3', 'avatar_url': 'https://avatars.githubusercontent.com/u/24327?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/simmerz', 'html_url': 'https://github.com/simmerz', 'followers_url': 'https://api.github.com/users/simmerz/followers', 'following_url': 'https://api.github.com/users/simmerz/following{/other_user}', 'gists_url': 'https://api.github.com/users/simmerz/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/simmerz/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/simmerz/subscriptions', 'organizations_url': 'https://api.github.com/users/simmerz/orgs', 'repos_url': 'https://api.github.com/users/simmerz/repos', 'events_url': 'https://api.github.com/users/simmerz/events{/privacy}', 'received_events_url': 'https://api.github.com/users/simmerz/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,6,2022-06-20T08:03:07Z,2022-09-22T22:21:10Z,,NONE,,,,"Currently, ActionText attachments use the default storage service.

If we want one ActionText `has_rich_text` on a model to use a public service, the whole app needs to be public first, rather than private first, the latter of which would be my preference.

Allowing a per case configuration as is possible with native-to-model attachables would allow the developer to choose their preference, and importantly allow that data-privacy-first approach.

I guess it should fall back to the default configured service if none is specified.

I would propose to use the same service parameter as is used on `has_x_attached` and pass it through to `has_many_attached :embeds` at [rails/rich_text.rb](https://github.com/rails/rails/blob/914caca2d31bd753f47f9168f2a375921d9e91cc/actiontext/app/models/action_text/rich_text.rb#L15)

Not sure of the best way to go about passing that through though, so its configurable per rich text, rather than globally.

Previously posted as a discussion [here](https://discuss.rubyonrails.org/t/feature-proposal-allow-actiontext-content-attachments-to-use-configurable-service/76804) but posting as an issue here so that if it's worthwhile it can be PR'd.","{'url': 'https://api.github.com/repos/rails/rails/issues/45405/reactions', 'total_count': 3, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 1}",https://api.github.com/repos/rails/rails/issues/45405/timeline,,
https://api.github.com/repos/rails/rails/issues/45403,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45403/labels{/name},https://api.github.com/repos/rails/rails/issues/45403/comments,https://api.github.com/repos/rails/rails/issues/45403/events,https://github.com/rails/rails/pull/45403,1276295243,PR_kwDNIULOOeqaJg,45403,"Ignore order of SQL joins, select, includes, left_outer_joins, eager_load and preload for ActiveRecord::Relation#or & for ActiveRecord::Relation#and","{'login': 'sampatbadhe', 'id': 5279284, 'node_id': 'MDQ6VXNlcjUyNzkyODQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5279284?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sampatbadhe', 'html_url': 'https://github.com/sampatbadhe', 'followers_url': 'https://api.github.com/users/sampatbadhe/followers', 'following_url': 'https://api.github.com/users/sampatbadhe/following{/other_user}', 'gists_url': 'https://api.github.com/users/sampatbadhe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sampatbadhe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sampatbadhe/subscriptions', 'organizations_url': 'https://api.github.com/users/sampatbadhe/orgs', 'repos_url': 'https://api.github.com/users/sampatbadhe/repos', 'events_url': 'https://api.github.com/users/sampatbadhe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sampatbadhe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-06-20T03:06:03Z,2022-08-09T00:49:46Z,,CONTRIBUTOR,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45403', 'html_url': 'https://github.com/rails/rails/pull/45403', 'diff_url': 'https://github.com/rails/rails/pull/45403.diff', 'patch_url': 'https://github.com/rails/rails/pull/45403.patch', 'merged_at': None}","### Summary

Fixes https://github.com/rails/rails/issues/45398

Ignore order of SQL joins, select, includes, left_outer_joins, eager_load and preload for ActiveRecord::Relation#or & for ActiveRecord::Relation#and","{'url': 'https://api.github.com/repos/rails/rails/issues/45403/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45403/timeline,,
https://api.github.com/repos/rails/rails/issues/45399,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45399/labels{/name},https://api.github.com/repos/rails/rails/issues/45399/comments,https://api.github.com/repos/rails/rails/issues/45399/events,https://github.com/rails/rails/pull/45399,1275900837,PR_kwDNIULOOeXdfg,45399,Refactor inversing logic of `CollectionAssociation`,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-06-18T22:33:26Z,2022-09-23T15:33:11Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45399', 'html_url': 'https://github.com/rails/rails/pull/45399', 'diff_url': 'https://github.com/rails/rails/pull/45399.diff', 'patch_url': 'https://github.com/rails/rails/pull/45399.patch', 'merged_at': None}","Follow-up to #40379, #42524, and #43445.

The logic to associate records with a `CollectionAssociation` when using `has_many` inversing has become increasingly complex.  Prior to this commit, we defined an ""add record"" method ([`add_to_target`](https://github.com/rails/rails/blob/be400c3ca2b86111766d840979478fc026679368/activerecord/lib/active_record/associations/collection_association.rb#L271-L273)) that can accept a `replace: true` option, and a ""replace record"" method ([`replace_on_target`](https://github.com/rails/rails/blob/be400c3ca2b86111766d840979478fc026679368/activerecord/lib/active_record/associations/collection_association.rb#L443-L476)) that can accept a `replace: false` option. And regardless of the value of the `:replace` option, the record may be added if it cannot be replaced (i.e. does not exist), or replaced if a complex set of conditions dictate it should not be simply added.

This commit aims to simplify this logic by:

* Removing the `:replace` option from `add_to_target`.
* Renaming `replace_on_target` to a low-level `add_record` method, supporting a `:replace` option.  The name `add_record` was chosen for parity with the similarly low-level [`remove_records`](https://github.com/rails/rails/blob/be400c3ca2b86111766d840979478fc026679368/activerecord/lib/active_record/associations/collection_association.rb#L385-L395) method.
* Replacing the complex conditions of `replace_on_target` with an ""implicit target records"" concept.  Implicit target records are those that have been associated via inversing but not explicitly added.  Implicit target records exist in the `@target` array, and are also tracked via an `@implicit_target_records` array.  Whenever an implicit target record is explicitly added, it is instead removed from the `@implicit_target_records` array, to prevent a double occurrence in the `@target` array.  (Though if the record is explicitly added a 2nd time, a 2nd occurrence *will* be added to the `@target` array.  We have tests that expect this.)

Additionally, this commit provides a very small speed increase, according to the following benchmark:

<details>
  <summary><strong>Benchmark</strong></summary>

  ```ruby
  require ""benchmark""

  ActiveRecord::Base.logger = nil

  ActiveRecord::Schema.define do
    create_table :authors, force: true do |t|
    end
    create_table :posts, force: true do |t|
      t.references :author
    end
  end

  class Author < ActiveRecord::Base
    has_many :posts
  end

  class Post < ActiveRecord::Base
    belongs_to :author
  end

  POST_COUNTS = [1, 10, 100, 1000]
  ITERATIONS = 100
  CALLS_PER_ITERATION = 100

  eval <<~RUBY
  def ms_per_build(posts)
    Benchmark.ms { #{""posts.build;"" * CALLS_PER_ITERATION} }.to_f / CALLS_PER_ITERATION
  end

  def ms_per_shovel(posts, post)
    Benchmark.ms { #{""posts << post;"" * CALLS_PER_ITERATION} }.to_f / CALLS_PER_ITERATION
  end
  RUBY

  def report(label, &block)
    [false, true].each do |has_many_inversing|
      ActiveRecord::Base.has_many_inversing = has_many_inversing

      POST_COUNTS.each do |post_count|
        Post.delete_all
        Post.insert_all(post_count.times.map { { author_id: 1 } })

        block.call # warmup
        ms = ITERATIONS.times.sum(&block).to_f / ITERATIONS

        puts ""has_many_inversing == #{has_many_inversing}, posts.count == #{post_count}"".ljust(50) +
          ""=> `#{label}` @ #{""%.3f"" % ms}ms""
      end
    end
  end

  author = Author.create!(id: 1)

  report(""posts.build"") do
    posts = author.reload.posts.tap(&:load_target)
    ms_per_build(posts)
  end

  report(""posts << post"") do
    posts = author.reload.posts.tap(&:load_target)
    post = posts[posts.length / 2]
    ms_per_shovel(posts, post)
  end
  ```
</details>

Results with `main` branch:

```
has_many_inversing == false, posts.count == 1     => `posts.build` @ 0.154ms
has_many_inversing == false, posts.count == 10    => `posts.build` @ 0.142ms
has_many_inversing == false, posts.count == 100   => `posts.build` @ 0.141ms
has_many_inversing == false, posts.count == 1000  => `posts.build` @ 0.144ms
has_many_inversing == true, posts.count == 1      => `posts.build` @ 0.143ms
has_many_inversing == true, posts.count == 10     => `posts.build` @ 0.142ms
has_many_inversing == true, posts.count == 100    => `posts.build` @ 0.142ms
has_many_inversing == true, posts.count == 1000   => `posts.build` @ 0.147ms
has_many_inversing == false, posts.count == 1     => `posts << post` @ 0.192ms
has_many_inversing == false, posts.count == 10    => `posts << post` @ 0.192ms
has_many_inversing == false, posts.count == 100   => `posts << post` @ 0.202ms
has_many_inversing == false, posts.count == 1000  => `posts << post` @ 0.196ms
has_many_inversing == true, posts.count == 1      => `posts << post` @ 0.209ms
has_many_inversing == true, posts.count == 10     => `posts << post` @ 0.204ms
has_many_inversing == true, posts.count == 100    => `posts << post` @ 0.221ms
has_many_inversing == true, posts.count == 1000   => `posts << post` @ 0.195ms
```

Results with this branch:

```
has_many_inversing == false, posts.count == 1     => `posts.build` @ 0.144ms
has_many_inversing == false, posts.count == 10    => `posts.build` @ 0.132ms
has_many_inversing == false, posts.count == 100   => `posts.build` @ 0.133ms
has_many_inversing == false, posts.count == 1000  => `posts.build` @ 0.135ms
has_many_inversing == true, posts.count == 1      => `posts.build` @ 0.132ms
has_many_inversing == true, posts.count == 10     => `posts.build` @ 0.133ms
has_many_inversing == true, posts.count == 100    => `posts.build` @ 0.132ms
has_many_inversing == true, posts.count == 1000   => `posts.build` @ 0.140ms
has_many_inversing == false, posts.count == 1     => `posts << post` @ 0.200ms
has_many_inversing == false, posts.count == 10    => `posts << post` @ 0.187ms
has_many_inversing == false, posts.count == 100   => `posts << post` @ 0.188ms
has_many_inversing == false, posts.count == 1000  => `posts << post` @ 0.191ms
has_many_inversing == true, posts.count == 1      => `posts << post` @ 0.187ms
has_many_inversing == true, posts.count == 10     => `posts << post` @ 0.188ms
has_many_inversing == true, posts.count == 100    => `posts << post` @ 0.197ms
has_many_inversing == true, posts.count == 1000   => `posts << post` @ 0.189ms
```

---

/cc @ghiculescu since you authored #42524, and @jstncarvalho since you authored #43445.  If you have time, would mind testing out this branch and verifying that it does not cause a regression (performance or otherwise) for you?
","{'url': 'https://api.github.com/repos/rails/rails/issues/45399/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45399/timeline,,
https://api.github.com/repos/rails/rails/issues/45393,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45393/labels{/name},https://api.github.com/repos/rails/rails/issues/45393/comments,https://api.github.com/repos/rails/rails/issues/45393/events,https://github.com/rails/rails/pull/45393,1275552858,PR_kwDNIULOOeGWRA,45393,Add `redirect_code_for_unsafe_http_methods` config,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-06-17T22:36:00Z,2022-10-14T17:29:20Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45393', 'html_url': 'https://github.com/rails/rails/pull/45393', 'diff_url': 'https://github.com/rails/rails/pull/45393.diff', 'patch_url': 'https://github.com/rails/rails/pull/45393.patch', 'merged_at': None}","When a client follows an HTTP 302 redirect, it will typically use the same HTTP method as the original request.  This can cause issues when, for example, redirecting an XHR `DELETE` request after a `destroy`.  (Note that many clients make an exception for `POST`, and will use `GET` to follow a 302 redirect in that case.)

The solution so far has been for users to specify an explicit response code in such cases.  For example:

```ruby
def destroy
  Post.destroy(params[:id])
  redirect_to root_path, status: 303
end
```

This commit adds a `redirect_code_for_unsafe_http_methods` configuration setting that allows users to specify a default HTTP response code to use when redirecting a request made with an [unsafe HTTP method][], such as `POST` or `DELETE`.  For example, when set to 303, the explicit response code may be omitted:

```ruby
def destroy
  Post.destroy(params[:id])
  redirect_to root_path
end
```

[unsafe HTTP method]: https://developer.mozilla.org/en-US/docs/Glossary/Safe/HTTP
","{'url': 'https://api.github.com/repos/rails/rails/issues/45393/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45393/timeline,,
https://api.github.com/repos/rails/rails/issues/45381,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45381/labels{/name},https://api.github.com/repos/rails/rails/issues/45381/comments,https://api.github.com/repos/rails/rails/issues/45381/events,https://github.com/rails/rails/pull/45381,1273679239,PR_kwDNIULOOchQzw,45381,Use single query to retrieve indexes in PostgreSQL,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-06-16T14:56:32Z,2022-09-10T21:34:38Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45381', 'html_url': 'https://github.com/rails/rails/pull/45381', 'diff_url': 'https://github.com/rails/rails/pull/45381.diff', 'patch_url': 'https://github.com/rails/rails/pull/45381.patch', 'merged_at': None}","Previously, to get all indexes for the database in PostgreSQL, it was needed `# of tables + # of indexes` sql queries. Now, it is only `# of tables` sql queries.

For example, for gitlab's source base, which has 500 tables and 2000 indexes, it was needed 2500 queries, now 500.

This PR greatly reduces the time needed to generate a `schema.rb` file, for example. Or in other tools, where it is needed to retrieve all the indexes from the database. For example, I was able to speedup `active_record_doctor` by `3x` (from 126 seconds to 39 seconds) using schema caching - https://github.com/gregnavis/active_record_doctor/pull/101. And with this PR, it reduces execution time by another 8 seconds.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45381/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45381/timeline,,
https://api.github.com/repos/rails/rails/issues/45379,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45379/labels{/name},https://api.github.com/repos/rails/rails/issues/45379/comments,https://api.github.com/repos/rails/rails/issues/45379/events,https://github.com/rails/rails/pull/45379,1273448565,PR_kwDNIULOOcU0wg,45379,Add `Arel.safe` and `Arel::SafeValue` to handle quoting edge cases,"{'login': 'kmcphillips', 'id': 84159, 'node_id': 'MDQ6VXNlcjg0MTU5', 'avatar_url': 'https://avatars.githubusercontent.com/u/84159?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kmcphillips', 'html_url': 'https://github.com/kmcphillips', 'followers_url': 'https://api.github.com/users/kmcphillips/followers', 'following_url': 'https://api.github.com/users/kmcphillips/following{/other_user}', 'gists_url': 'https://api.github.com/users/kmcphillips/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kmcphillips/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kmcphillips/subscriptions', 'organizations_url': 'https://api.github.com/users/kmcphillips/orgs', 'repos_url': 'https://api.github.com/users/kmcphillips/repos', 'events_url': 'https://api.github.com/users/kmcphillips/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kmcphillips/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,9,2022-06-16T11:44:26Z,2022-06-21T22:57:54Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45379', 'html_url': 'https://github.com/rails/rails/pull/45379', 'diff_url': 'https://github.com/rails/rails/pull/45379.diff', 'patch_url': 'https://github.com/rails/rails/pull/45379.patch', 'merged_at': None}","## Problem

Fixes #44312

In some cases, SQL sanitation adds quotes around values in ways that are incorrect or can produce invalid SQL. This behaviour is mostly desired because we wish to be safe by default, and assume passed in values are unsafe. There is however no built in mechanism to bypass this in cases where the values are known to be safe.

ex:
```ruby
ActiveRecord::Base.sanitize_sql([""LIMIT :offset, :per_page"", { offset: 12, per_page: 32 }])
> ""LIMIT '12', '32'""
```


## Solution

Add an `Arel::SafeValue` class which simply tells the query builder and sanitization to pass through the value without quoting. Add a helper `Arel.safe()` for brevity and discoverability.

ex:
```ruby
ActiveRecord::Base.sanitize_sql([""LIMIT :offset, :per_page"", { offset: Arel.safe(12), per_page: Arel.safe(32) }])
> ""LIMIT 12, 32""
```

In trying to write some failing test cases I found that most of [ActiveRecord::Sanitization](https://github.com/rails/rails/blob/7ac90d9ad75c50129850572ed6c7dcd42fecbf3b/activerecord/lib/active_record/sanitization.rb) is untested. [Only a subset of it has test coverage](https://github.com/rails/rails/blob/7ac90d9ad75c50129850572ed6c7dcd42fecbf3b/activerecord/test/cases/sanitize_test.rb), and much of that coverage is agnostic to the underlying connection adapter. This PR pulls in the tests from and closes #44429 (@rbgrouleff).

It is difficult to write good clear examples because *the behaviour of the sanitization depends on the underlying adapter that is currently selected*. That was not clearly reflected in the docs or in tests, but is now.

@byroot @casperisfine as the regression was introduced in #42440.","{'url': 'https://api.github.com/repos/rails/rails/issues/45379/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45379/timeline,,
https://api.github.com/repos/rails/rails/issues/45355,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45355/labels{/name},https://api.github.com/repos/rails/rails/issues/45355/comments,https://api.github.com/repos/rails/rails/issues/45355/events,https://github.com/rails/rails/pull/45355,1271118787,PR_kwDNIULOOaZhHQ,45355,"Skip association validation when the record is persisted, unchanged and invalid","{'login': 'muZk', 'id': 1679496, 'node_id': 'MDQ6VXNlcjE2Nzk0OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1679496?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/muZk', 'html_url': 'https://github.com/muZk', 'followers_url': 'https://api.github.com/users/muZk/followers', 'following_url': 'https://api.github.com/users/muZk/following{/other_user}', 'gists_url': 'https://api.github.com/users/muZk/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/muZk/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/muZk/subscriptions', 'organizations_url': 'https://api.github.com/users/muZk/orgs', 'repos_url': 'https://api.github.com/users/muZk/repos', 'events_url': 'https://api.github.com/users/muZk/events{/privacy}', 'received_events_url': 'https://api.github.com/users/muZk/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-06-14T17:21:40Z,2022-10-14T14:39:35Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45355', 'html_url': 'https://github.com/rails/rails/pull/45355', 'diff_url': 'https://github.com/rails/rails/pull/45355.diff', 'patch_url': 'https://github.com/rails/rails/pull/45355.patch', 'merged_at': None}","### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

Fixes [#45320](https://github.com/rails/rails/issues/45320)

This adds consistency to the behavior described in the issue. Basically, skips validation when the associated record is persisted, unchanged and invalid.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45355/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45355/timeline,,
https://api.github.com/repos/rails/rails/issues/45338,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45338/labels{/name},https://api.github.com/repos/rails/rails/issues/45338/comments,https://api.github.com/repos/rails/rails/issues/45338/events,https://github.com/rails/rails/pull/45338,1268697867,PR_kwDNIULOOYYTYw,45338,Fix consistency issue between ActiveModel::Conversion and ActiveModel::Lint,"{'login': 'santib', 'id': 6373536, 'node_id': 'MDQ6VXNlcjYzNzM1MzY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6373536?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/santib', 'html_url': 'https://github.com/santib', 'followers_url': 'https://api.github.com/users/santib/followers', 'following_url': 'https://api.github.com/users/santib/following{/other_user}', 'gists_url': 'https://api.github.com/users/santib/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/santib/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/santib/subscriptions', 'organizations_url': 'https://api.github.com/users/santib/orgs', 'repos_url': 'https://api.github.com/users/santib/repos', 'events_url': 'https://api.github.com/users/santib/events{/privacy}', 'received_events_url': 'https://api.github.com/users/santib/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,2,2022-06-12T20:49:48Z,2022-06-20T22:46:13Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45338', 'html_url': 'https://github.com/rails/rails/pull/45338', 'diff_url': 'https://github.com/rails/rails/pull/45338.diff', 'patch_url': 'https://github.com/rails/rails/pull/45338.patch', 'merged_at': None}","### Summary

`ActiveModel::Lint` says `#to_key` should return `nil` if `#persisted?` is `false`, but `ActiveModel::Conversion` that implements `#to_key` doesn't care about `#persisted?` but it actually cares about `#id`.

The primary change in the PR is on `ActiveModel::Lint#test_to_key` to set the `#id` method on the model instead of the `#persisted?` method, so it always passes when `ActiveModel::Conversion` is included in a class.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45338/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45338/timeline,,
https://api.github.com/repos/rails/rails/issues/45320,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45320/labels{/name},https://api.github.com/repos/rails/rails/issues/45320/comments,https://api.github.com/repos/rails/rails/issues/45320/events,https://github.com/rails/rails/issues/45320,1267536894,I_kwDNIULOS40T_g,45320,[Bug] ActiveRecord: Association's validations are ran only on create when assigning with *_ids=,"{'login': 'james-em', 'id': 63726983, 'node_id': 'MDQ6VXNlcjYzNzI2OTgz', 'avatar_url': 'https://avatars.githubusercontent.com/u/63726983?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/james-em', 'html_url': 'https://github.com/james-em', 'followers_url': 'https://api.github.com/users/james-em/followers', 'following_url': 'https://api.github.com/users/james-em/following{/other_user}', 'gists_url': 'https://api.github.com/users/james-em/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/james-em/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/james-em/subscriptions', 'organizations_url': 'https://api.github.com/users/james-em/orgs', 'repos_url': 'https://api.github.com/users/james-em/repos', 'events_url': 'https://api.github.com/users/james-em/events{/privacy}', 'received_events_url': 'https://api.github.com/users/james-em/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,5,2022-06-10T13:21:30Z,2022-12-21T22:47:59Z,,NONE,,,,"### Steps to reproduce

**Models:**
```
class User < ApplicationRecord
  has_many :project_users, dependent: :destroy, inverse_of: :user
  has_many :projects, through: :project_users
  
  validates :name, presence: true
end

class Project < ApplicationRecord
  has_many :project_users, dependent: :destroy
  has_many :users, through: :project_users
end

class ProjectUser < ApplicationRecord
  belongs_to :project
  belongs_to :user
end
```

```
u = User.new(""email: ""test@example.com"", name: nil)
u.valid? => false (name is nil)
u.save(validate: false) => true

Generates an error:
Project.create!(name: ""Test"", user_ids: [u.id])
=> Exception because user is invalid

This doesn't generate an error
p = Project.create!(name: ""test"")
p.update!(user_ids: [u.id])
=> true
```

### Expected behavior

One of these 2:
1. Run validation in every case
2. Never run validation


### Actual behavior

Validations are executed on create but not on update.

### System configuration
**Rails version**: 7.0.3

**Ruby version**: 3.1.0
","{'url': 'https://api.github.com/repos/rails/rails/issues/45320/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45320/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/45317,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45317/labels{/name},https://api.github.com/repos/rails/rails/issues/45317/comments,https://api.github.com/repos/rails/rails/issues/45317/events,https://github.com/rails/rails/pull/45317,1267348449,PR_kwDNIULOOXTQoQ,45317,Fix Inconsistent ActiveRecord `insert_all!` Interfaces,"{'login': 'berniechiu', 'id': 2749593, 'node_id': 'MDQ6VXNlcjI3NDk1OTM=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2749593?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/berniechiu', 'html_url': 'https://github.com/berniechiu', 'followers_url': 'https://api.github.com/users/berniechiu/followers', 'following_url': 'https://api.github.com/users/berniechiu/following{/other_user}', 'gists_url': 'https://api.github.com/users/berniechiu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/berniechiu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/berniechiu/subscriptions', 'organizations_url': 'https://api.github.com/users/berniechiu/orgs', 'repos_url': 'https://api.github.com/users/berniechiu/repos', 'events_url': 'https://api.github.com/users/berniechiu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/berniechiu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2022-06-10T10:15:27Z,2022-06-29T03:36:56Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45317', 'html_url': 'https://github.com/rails/rails/pull/45317', 'diff_url': 'https://github.com/rails/rails/pull/45317.diff', 'patch_url': 'https://github.com/rails/rails/pull/45317.patch', 'merged_at': None}","### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

Currently the method `insert_all!` is missing the arguments to apply `unique_by` in cases when we need to use them, not sure why it has the inconsistent interface for calling with `!` besides raising error, they should share the same argument interface.

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45317/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45317/timeline,,
https://api.github.com/repos/rails/rails/issues/45313,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45313/labels{/name},https://api.github.com/repos/rails/rails/issues/45313/comments,https://api.github.com/repos/rails/rails/issues/45313/events,https://github.com/rails/rails/pull/45313,1266723562,PR_kwDNIULOOWxeUw,45313,Make retrieval of cached entry scope to be public. Fixes #45311,"{'login': 'poloka', 'id': 6907677, 'node_id': 'MDQ6VXNlcjY5MDc2Nzc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6907677?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/poloka', 'html_url': 'https://github.com/poloka', 'followers_url': 'https://api.github.com/users/poloka/followers', 'following_url': 'https://api.github.com/users/poloka/following{/other_user}', 'gists_url': 'https://api.github.com/users/poloka/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/poloka/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/poloka/subscriptions', 'organizations_url': 'https://api.github.com/users/poloka/orgs', 'repos_url': 'https://api.github.com/users/poloka/repos', 'events_url': 'https://api.github.com/users/poloka/events{/privacy}', 'received_events_url': 'https://api.github.com/users/poloka/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,15,2022-06-09T22:12:14Z,2022-06-13T19:09:52Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45313', 'html_url': 'https://github.com/rails/rails/pull/45313', 'diff_url': 'https://github.com/rails/rails/pull/45313.diff', 'patch_url': 'https://github.com/rails/rails/pull/45313.patch', 'merged_at': None}","### Summary
Making the retrieval of `ActiveSupport::Cache::Entry` objects public to assist in consumers retrieving a value prior to its deletion if they so wish to perform a retry operation at some future period of time.

Fixes #45311 

### Other Information
n/a
<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45313/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45313/timeline,,
https://api.github.com/repos/rails/rails/issues/45306,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45306/labels{/name},https://api.github.com/repos/rails/rails/issues/45306/comments,https://api.github.com/repos/rails/rails/issues/45306/events,https://github.com/rails/rails/pull/45306,1265401008,PR_kwDNIULOOVqoIA,45306,Enable testing of binary data in request specs,"{'login': 'stanhu', 'id': 963826, 'node_id': 'MDQ6VXNlcjk2MzgyNg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/963826?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/stanhu', 'html_url': 'https://github.com/stanhu', 'followers_url': 'https://api.github.com/users/stanhu/followers', 'following_url': 'https://api.github.com/users/stanhu/following{/other_user}', 'gists_url': 'https://api.github.com/users/stanhu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/stanhu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/stanhu/subscriptions', 'organizations_url': 'https://api.github.com/users/stanhu/orgs', 'repos_url': 'https://api.github.com/users/stanhu/repos', 'events_url': 'https://api.github.com/users/stanhu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/stanhu/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2022-06-08T23:04:15Z,2022-06-08T23:31:26Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45306', 'html_url': 'https://github.com/rails/rails/pull/45306', 'diff_url': 'https://github.com/rails/rails/pull/45306.diff', 'patch_url': 'https://github.com/rails/rails/pull/45306.patch', 'merged_at': None}","### Summary

Previously it was not possible to test POST requests with binary data
with no `Content-Type` header. rack-test will default to a
`Content-Type` of `application/x-www-form-urlencoded`, which causes
encoding errors if binary data is passed in the request parameters.

If an `:input` parameter is passed to `Rack::Test::Session`, then
`Rack::Test::Session` will not attempt to set the `Content-Type`, and
the raw data will be passed to the body of the POST request. We can
use this to test binary data with no `Content-Type`.

This came up in https://github.com/rack/rack-test/issues/247.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45306/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45306/timeline,,
https://api.github.com/repos/rails/rails/issues/45305,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45305/labels{/name},https://api.github.com/repos/rails/rails/issues/45305/comments,https://api.github.com/repos/rails/rails/issues/45305/events,https://github.com/rails/rails/pull/45305,1265394519,PR_kwDNIULOOVqSWg,45305,Add foreign key in the same statement as adding a column for PostgreSQL,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-06-08T22:53:08Z,2023-02-20T23:08:00Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45305', 'html_url': 'https://github.com/rails/rails/pull/45305', 'diff_url': 'https://github.com/rails/rails/pull/45305.diff', 'patch_url': 'https://github.com/rails/rails/pull/45305.patch', 'merged_at': None}","When using `add_reference`, PostgreSQL adds a new column and a foreign key separately. For large tables, adding a foreign key leads to problems, because the dbms needs to validate all the rows which takes a lot of time while holding exclusive locks on both tables.
 
There are 2 approaches to solve this:
1. add invalid foreign key and validate separately - safe approach, but cumbersome and takes the same long time
2. add foreign key in the same statement as a new column, which is blazingly fast. This approach is implemented in this PR; before is was possible only via raw sql.

Example:
```
\timing on
create table foos (id integer primary key);
create table bars (id integer primary key);
INSERT INTO bars (id) SELECT i FROM generate_series(1, 50000000) AS i;

-- Separately
ALTER TABLE ""bars"" ADD ""foo_id"" bigint, ADD CONSTRAINT ""fk_rails_9e5a99443d"" FOREIGN KEY (""foo_id"") REFERENCES ""foos"" (""id"");
ALTER TABLE
Time: 23305.494 ms (00:23.305)

alter table bars drop column foo_id;

-- Combined
ALTER TABLE ""bars"" ADD ""foo_id"" bigint CONSTRAINT ""fk_rails_9e5a99443d"" REFERENCES ""foos"" (""id"");
ALTER TABLE
Time: 2.362 ms
```

`23s` vs `2ms`.

I added support only for PostgreSQL, because for other dbms' this will not add any benefits.

Based on https://github.com/rails/rails/pull/41863, added @ccutrer as a co-author.","{'url': 'https://api.github.com/repos/rails/rails/issues/45305/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45305/timeline,,
https://api.github.com/repos/rails/rails/issues/45295,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45295/labels{/name},https://api.github.com/repos/rails/rails/issues/45295/comments,https://api.github.com/repos/rails/rails/issues/45295/events,https://github.com/rails/rails/issues/45295,1264065602,I_kwDNIULOS1gcQg,45295,app:update (selecting All) results in NoMethodError on config/initializers/assets.rb:4,"{'login': 'josh-m-sharpe', 'id': 39473, 'node_id': 'MDQ6VXNlcjM5NDcz', 'avatar_url': 'https://avatars.githubusercontent.com/u/39473?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/josh-m-sharpe', 'html_url': 'https://github.com/josh-m-sharpe', 'followers_url': 'https://api.github.com/users/josh-m-sharpe/followers', 'following_url': 'https://api.github.com/users/josh-m-sharpe/following{/other_user}', 'gists_url': 'https://api.github.com/users/josh-m-sharpe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/josh-m-sharpe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/josh-m-sharpe/subscriptions', 'organizations_url': 'https://api.github.com/users/josh-m-sharpe/orgs', 'repos_url': 'https://api.github.com/users/josh-m-sharpe/repos', 'events_url': 'https://api.github.com/users/josh-m-sharpe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/josh-m-sharpe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,6,2022-06-08T01:21:54Z,2022-10-11T23:49:56Z,,CONTRIBUTOR,,,,"### Steps to reproduce
1) rails 6.1 app
2) bundle update to rails 7.0.3
3) rake app:update
4) select 'a' for all

So, app:update replaces `config/initializers/assets.rb`, and then it looks like `rails  active_storage:update` fails on line 4 of that file: 
`NoMethodError: undefined method `assets'`

```
 (9:14:15 PM) ~/fin {3.0.4p208} (master)  be rake app:update
Top level ::CompositeIO is deprecated, require 'multipart/post' and use `Multipart::Post::CompositeReadIO` instead!
Top level ::Parts is deprecated, require 'multipart/post' and use `Multipart::Post::Parts` instead!
    conflict  config/boot.rb
Overwrite /Users/jsharpe/fin/config/boot.rb? (enter ""h"" for help) [Ynaqdhm] a
       force  config/boot.rb
       exist  config
    conflict  config/application.rb
       force  config/application.rb
   identical  config/environment.rb
       exist  config/environments
    conflict  config/environments/development.rb
       force  config/environments/development.rb
    conflict  config/environments/production.rb
       force  config/environments/production.rb
    conflict  config/environments/test.rb
       force  config/environments/test.rb
       exist  config/initializers
    conflict  config/initializers/assets.rb
       force  config/initializers/assets.rb
    conflict  config/initializers/content_security_policy.rb
       force  config/initializers/content_security_policy.rb
      create  config/initializers/cors.rb
    conflict  config/initializers/filter_parameter_logging.rb
       force  config/initializers/filter_parameter_logging.rb
    conflict  config/initializers/inflections.rb
       force  config/initializers/inflections.rb
      create  config/initializers/new_framework_defaults_7_0.rb
   identical  config/initializers/permissions_policy.rb
      remove  app/assets/stylesheets/application.css
      remove  config/initializers/cors.rb
       exist  bin
    conflict  bin/rails
       force  bin/rails
   identical  bin/rake
    conflict  bin/setup
       force  bin/setup
        gsub  db/schema.rb
       rails  active_storage:update
rails aborted!
NoMethodError: undefined method `assets' for #<Rails::Application::Configuration:0x000000010f3869a8 @root=#<Pathname:/Users/jsharpe/fin>, @generators=#<Rails::Configuration::Generators:0x000000010922b7d0 @aliases={}, @options={:rails=>{:orm=>:active_record, :test_framework=>:test_unit, :integration_tool=>:test_unit, :system_tests=>:test_unit}, :active_record=>{:migration=>true, :timestamps=>true}, :test_unit=>{:fixture=>false, :fixture_replacement=>:factory_bot}}, @fallbacks={}, @templates=[], @colorize_logging=true, @api_only=false, @hidden_namespaces=[], @after_generate_callbacks=[]>, @middleware=#<Rails::Configuration::MiddlewareStackProxy:0x000000010f386700 @operations=[#<Proc:0x000000010f801a78 /Users/jsharpe/.rvm/gems/ruby-3.0.4@fin/gems/railties-7.0.3/lib/rails/configuration.rb:53 (lambda)>, #<Proc:0x0000000110657078 /Users/jsh
arpe/.rvm/gems/ruby-3.0.4@fin/gems/railties-7.0.3/lib/rails/configuration.rb:59 (lambda)>], @delete_operations=[]>, @javascript_path=""javascript"", @encoding=#<Encoding:UTF-8>, @allow_concurrency=nil, @consider_all_requests_local=true, @filter_parameters=[], @filter_redirect=[], @helpers_paths=[""/Users/jsharpe/fin/app/helpers""], @hosts=["".localhost"", #<IPAddr: IPv4:0.0.0.0/0.0.0.0>, #<IPAddr: IPv6:0000:0000:0000:0000:0000:0000:0000:0000/0000:0000:0000:0000:0000:0000:0000:0000>], @host_authorization={}, @public_file_server=#<ActiveSupport::OrderedOptions {:enabled=>true, :index_name=>""index""}>, @force_ssl=false, @ssl_options={:hsts=>{:subdomains=>true}}, @session_store=nil, @time_zone=""UTC"", @beginning_of_week=:monday, @log_level=:debug, @cache_store=:null_store, @railties_order=[:all], @relative_url_root=nil, @reload_classes_only_on_ch
ange=true, @file_watcher=ActiveSupport::FileUpdateChecker, @exceptions_app=nil, @autoflush_log=true, @log_formatter=#<ActiveSupport::Logger::SimpleFormatter:0x000000010f39c848 @datetime_format=nil>, @eager_load=false, @secret_key_base=nil, @api_only=false, @debug_exception_response_format=nil, @x=#<Rails::Application::Configuration::Custom:0x000000010f39c7a8 @configurations={}>, @enable_dependency_loading=false, @read_encrypted_secrets=false, @content_security_policy=nil, @content_security_policy_report_only=false, @content_security_policy_nonce_generator=nil, @content_security_policy_nonce_directives=nil, @require_master_key=false, @loaded_config_version=6.0, @credentials=#<ActiveSupport::OrderedOptions {:content_path=>#<Pathname:/Users/jsharpe/fin/config/credentials.yml.enc>, :key_path=>#<Pathname:/Users/jsharpe/fin/config/mast
er.key>}>, @disable_sandbox=false, @add_autoload_paths_to_load_path=true, @permissions_policy=nil, @rake_eager_load=false, @server_timing=true, @paths=#<Rails::Paths::Root:0x000000010f4d5098 @path=#<Pathname:/Users/jsharpe/fin>, @root={""app""=>#<Rails::Paths::Path:0x000000010f4d4eb8 @paths=[""app""], @current=""app"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""{*,*/concerns}"", @exclude=[""assets"", ""javascript""], @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, ""app/assets""=>#<Rails::Paths::Path:0x000000010f4d4d50 @paths=[""app/assets""], @current=""app/assets"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""*"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""app/controllers""=>#<Rails::Paths::Path:0x000000010f4d4c88 @paths=[""app/controllers""], @curren
t=""app/controllers"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, ""app/channels""=>#<Rails::Paths::Path:0x000000010f4d4be8 @paths=[""app/channels""], @current=""app/channels"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, ""app/helpers""=>#<Rails::Paths::Path:0x000000010f4d4b48 @paths=[""app/helpers""], @current=""app/helpers"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, ""app/models""=>#<Rails::Paths::Path:0x000000010f4d4aa8 @paths=[""app/models""], @current=""app/models"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclud
e=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, ""app/mailers""=>#<Rails::Paths::Path:0x000000010f4d4a08 @paths=[""app/mailers""], @current=""app/mailers"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, ""app/views""=>#<Rails::Paths::Path:0x000000010f4d4968 @paths=[""app/views""], @current=""app/views"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""lib""=>#<Rails::Paths::Path:0x000000010f4d48c8 @paths=[""lib""], @current=""lib"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=true>, ""lib/assets""=>#<Rails::Paths::Path:0x
000000010f4d4800 @paths=[""lib/assets""], @current=""lib/assets"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""*"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""lib/tasks""=>#<Rails::Paths::Path:0x000000010f4d4760 @paths=[""lib/tasks""], @current=""lib/tasks"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""**/*.rake"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config""=>#<Rails::Paths::Path:0x000000010f4d46e8 @paths=[""config""], @current=""config"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/environments""=>#<Rails::Paths::Path:0x000000010f4d45a8 @paths=[""config/environments""], @current=""config/environments"", @root=#<Rails:
:Paths::Root:0x000000010f4d5098 ...>, @glob=""development.rb"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/initializers""=>#<Rails::Paths::Path:0x000000010f4d4508 @paths=[""config/initializers""], @current=""config/initializers"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""**/*.rb"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/locales""=>#<Rails::Paths::Path:0x000000010f4d4468 @paths=[""config/locales""], @current=""config/locales"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""**/*.{rb,yml}"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/routes.rb""=>#<Rails::Paths::Path:0x000000010f4d43f0 @paths=[""config/routes.rb""], @current=""config/routes.rb"", @root=#<Rails::Paths::R
oot:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/routes""=>#<Rails::Paths::Path:0x000000010f4d4350 @paths=[""config/routes""], @current=""config/routes"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""**/*.rb"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""db""=>#<Rails::Paths::Path:0x000000010f4d42d8 @paths=[""db""], @current=""db"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""db/migrate""=>#<Rails::Paths::Path:0x000000010f4d4260 @paths=[""db/migrate""], @current=""db/migrate"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=f
alse, @load_path=false>, ""db/seeds.rb""=>#<Rails::Paths::Path:0x000000010f4d41e8 @paths=[""db/seeds.rb""], @current=""db/seeds.rb"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""vendor""=>#<Rails::Paths::Path:0x000000010f4d4148 @paths=[""vendor""], @current=""vendor"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=true>, ""vendor/assets""=>#<Rails::Paths::Path:0x000000010f4d40a8 @paths=[""vendor/assets""], @current=""vendor/assets"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""*"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/database""=>#<Rails::Paths::Path:0x000000010f4d4008 @paths=[""confi
g/database.yml""], @current=""config/database"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/secrets""=>#<Rails::Paths::Path:0x000000010f4ebf50 @paths=[""config""], @current=""config/secrets"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=""secrets.yml{,.enc}"", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""config/environment""=>#<Rails::Paths::Path:0x000000010f4ebeb0 @paths=[""config/environment.rb""], @current=""config/environment"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""lib/templates""=>#<Rails::Paths::Path:0x000000010f4ebe38 @paths=[""lib/templates""], @current=""lib/templa
tes"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""log""=>#<Rails::Paths::Path:0x000000010f4ebd48 @paths=[""log/development.log""], @current=""log"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""public""=>#<Rails::Paths::Path:0x000000010f4ebcd0 @paths=[""public""], @current=""public"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""public/javascripts""=>#<Rails::Paths::Path:0x000000010f4ebc58 @paths=[""public/javascripts""], @current=""public/javascripts"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autolo
ad_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""public/stylesheets""=>#<Rails::Paths::Path:0x000000010f4ebbe0 @paths=[""public/stylesheets""], @current=""public/stylesheets"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, ""tmp""=>#<Rails::Paths::Path:0x000000010f4ebb68 @paths=[""tmp""], @current=""tmp"", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>}>, @cache_classes=false, @autoload_paths=[], @eager_load_paths=[""/Users/jsharpe/fin/app/channels"", ""/Users/jsharpe/fin/app/classes"", ""/Users/jsharpe/fin/app/controllers"", ""/Users/jsharpe/fin/app/controllers/concerns"", ""/Users/jsharpe/fin/app/helpers"", ""/Users/jsharpe/fin/app/jobs"", ""/Users/jsharpe/fin/app/mailers"", ""/Users/jsharpe/fin/app/models"", ""/Users/jsharpe/fin/app/models/concerns"", ""/Users/jsharpe/fin/app/sidekiq""], @autoload_once_paths=[]>
Did you mean?  asset_host
/Users/jsharpe/fin/config/initializers/assets.rb:4:in `<top (required)>'
/Users/jsharpe/fin/config/environment.rb:5:in `<top (required)>'
Tasks: TOP => active_storage:update => environment
(See full trace by running task with --trace)
```

### System configuration
**Rails version**:
```
be rails --version
Rails 7.0.3
```

**Ruby version**:
```
ruby --version
ruby 3.0.4p208 (2022-04-12 revision 3fa771dded) [arm64-darwin21]
```
","{'url': 'https://api.github.com/repos/rails/rails/issues/45295/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45295/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/45294,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45294/labels{/name},https://api.github.com/repos/rails/rails/issues/45294/comments,https://api.github.com/repos/rails/rails/issues/45294/events,https://github.com/rails/rails/pull/45294,1263966127,PR_kwDNIULOOUd93A,45294,Batch load ids into memory instead of loading all ids,"{'login': 'keoghpe', 'id': 1381973, 'node_id': 'MDQ6VXNlcjEzODE5NzM=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1381973?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/keoghpe', 'html_url': 'https://github.com/keoghpe', 'followers_url': 'https://api.github.com/users/keoghpe/followers', 'following_url': 'https://api.github.com/users/keoghpe/following{/other_user}', 'gists_url': 'https://api.github.com/users/keoghpe/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/keoghpe/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/keoghpe/subscriptions', 'organizations_url': 'https://api.github.com/users/keoghpe/orgs', 'repos_url': 'https://api.github.com/users/keoghpe/repos', 'events_url': 'https://api.github.com/users/keoghpe/events{/privacy}', 'received_events_url': 'https://api.github.com/users/keoghpe/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 257468118, 'node_id': 'MDU6TGFiZWwyNTc0NjgxMTg=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20work', 'name': 'needs work', 'color': '000000', 'default': False, 'description': None}]",open,False,,[],,1,2022-06-07T22:41:03Z,2022-10-12T17:15:29Z,,NONE,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45294', 'html_url': 'https://github.com/rails/rails/pull/45294', 'diff_url': 'https://github.com/rails/rails/pull/45294.diff', 'patch_url': 'https://github.com/rails/rails/pull/45294.patch', 'merged_at': None}","### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45294/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45294/timeline,,
https://api.github.com/repos/rails/rails/issues/45288,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45288/labels{/name},https://api.github.com/repos/rails/rails/issues/45288/comments,https://api.github.com/repos/rails/rails/issues/45288/events,https://github.com/rails/rails/pull/45288,1263622274,PR_kwDNIULOOULKpw,45288,Add clarification in the explanation of index_with variants,"{'login': 'dsusviela', 'id': 18326941, 'node_id': 'MDQ6VXNlcjE4MzI2OTQx', 'avatar_url': 'https://avatars.githubusercontent.com/u/18326941?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dsusviela', 'html_url': 'https://github.com/dsusviela', 'followers_url': 'https://api.github.com/users/dsusviela/followers', 'following_url': 'https://api.github.com/users/dsusviela/following{/other_user}', 'gists_url': 'https://api.github.com/users/dsusviela/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dsusviela/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dsusviela/subscriptions', 'organizations_url': 'https://api.github.com/users/dsusviela/orgs', 'repos_url': 'https://api.github.com/users/dsusviela/repos', 'events_url': 'https://api.github.com/users/dsusviela/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dsusviela/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-06-07T17:15:49Z,2022-08-04T16:32:45Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45288', 'html_url': 'https://github.com/rails/rails/pull/45288', 'diff_url': 'https://github.com/rails/rails/pull/45288.diff', 'patch_url': 'https://github.com/rails/rails/pull/45288.patch', 'merged_at': None}","### Summary

Documentation clarification regarding the `index_with` method. Product of the discussion over at #45286 

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
","{'url': 'https://api.github.com/repos/rails/rails/issues/45288/reactions', 'total_count': 2, '+1': 2, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45288/timeline,,
https://api.github.com/repos/rails/rails/issues/45286,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45286/labels{/name},https://api.github.com/repos/rails/rails/issues/45286/comments,https://api.github.com/repos/rails/rails/issues/45286/events,https://github.com/rails/rails/issues/45286,1263484300,I_kwDNIULOS089jA,45286,Enumerable::index_with will share the memory of the default value between keys,"{'login': 'dsusviela', 'id': 18326941, 'node_id': 'MDQ6VXNlcjE4MzI2OTQx', 'avatar_url': 'https://avatars.githubusercontent.com/u/18326941?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dsusviela', 'html_url': 'https://github.com/dsusviela', 'followers_url': 'https://api.github.com/users/dsusviela/followers', 'following_url': 'https://api.github.com/users/dsusviela/following{/other_user}', 'gists_url': 'https://api.github.com/users/dsusviela/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dsusviela/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dsusviela/subscriptions', 'organizations_url': 'https://api.github.com/users/dsusviela/orgs', 'repos_url': 'https://api.github.com/users/dsusviela/repos', 'events_url': 'https://api.github.com/users/dsusviela/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dsusviela/received_events', 'type': 'User', 'site_admin': False}","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2022-06-07T15:30:09Z,2022-06-08T02:15:43Z,,CONTRIBUTOR,,,,"### Steps to reproduce
Apologies if I'm misunderstanding the method, but AFAIK each default value should be independent.

So far as I've tested, arrays and hashes. Those are being shared. However if the value is a string, this one will not be shared.

<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

This will fail:

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""active_support""
require ""active_support/core_ext/enumerable""
require ""minitest/autorun""

class BugTest < Minitest::Test
  def test_index_with_shared_memory
    keys = [:only_i_should_change, :i_should_stay_empty]
    subject = keys.index_with({})

    subject[:only_i_should_change][:a_key] = ""value""

    assert subject[:only_i_should_change][:a_key] == ""value""
    assert subject[:i_should_stay_empty] == {}
  end
end
```

This will succeed however.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""active_support""
require ""active_support/core_ext/enumerable""
require ""minitest/autorun""

class BugTest < Minitest::Test
  def test_index_with_shared_memory
    keys = [:only_i_should_change, :i_should_stay_empty]
    subject = keys.index_with(""a_string"")

    subject[:only_i_should_change] = ""value""

    assert subject[:only_i_should_change] == ""value""
    assert subject[:i_should_stay_empty] == ""a_string""
  end
end
```

### Expected behavior
When using arrays or hashes, the values should be independent. In the failed example that means that the hash under the key `:is_should_stay_empty` should be empty

### Actual behavior
When using arrays or hashes, the values are not independent. In the failed example the hash under the key `:is_should_stay_empty` is the same as `:only_i_should_change`.

### System configuration
**Rails version**:
[v7.0.3](https://github.com/rails/rails/releases/tag/v7.0.3)

**Ruby version**:
Ruby version 2.7.5","{'url': 'https://api.github.com/repos/rails/rails/issues/45286/reactions', 'total_count': 8, '+1': 8, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45286/timeline,,
https://api.github.com/repos/rails/rails/issues/45241,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45241/labels{/name},https://api.github.com/repos/rails/rails/issues/45241/comments,https://api.github.com/repos/rails/rails/issues/45241/events,https://github.com/rails/rails/pull/45241,1257105513,PR_kwDNIULOOOtBpw,45241,"Add Colorized, a new routes formatter","{'login': 'faqndo97', 'id': 16840674, 'node_id': 'MDQ6VXNlcjE2ODQwNjc0', 'avatar_url': 'https://avatars.githubusercontent.com/u/16840674?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/faqndo97', 'html_url': 'https://github.com/faqndo97', 'followers_url': 'https://api.github.com/users/faqndo97/followers', 'following_url': 'https://api.github.com/users/faqndo97/following{/other_user}', 'gists_url': 'https://api.github.com/users/faqndo97/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/faqndo97/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/faqndo97/subscriptions', 'organizations_url': 'https://api.github.com/users/faqndo97/orgs', 'repos_url': 'https://api.github.com/users/faqndo97/repos', 'events_url': 'https://api.github.com/users/faqndo97/events{/privacy}', 'received_events_url': 'https://api.github.com/users/faqndo97/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,13,2022-06-01T21:41:27Z,2023-02-14T19:05:43Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45241', 'html_url': 'https://github.com/rails/rails/pull/45241', 'diff_url': 'https://github.com/rails/rails/pull/45241.diff', 'patch_url': 'https://github.com/rails/rails/pull/45241.patch', 'merged_at': None}","### Summary

I added `ActionDispatch::Routing::ConsoleFormatter::Colorized` that is a new routes formatter.

**Why a new formatter?**

The intention of this one is to add a different structure and colors to the actual `rails route` command.
This formatter can be used by a new flag (`-C`) added on the `route` command.

### Before
![Screen Shot 2022-06-01 at 6 10 17 PM](https://user-images.githubusercontent.com/16840674/171506536-c60cec25-75b7-4271-8b5e-634f349cb13b.png)

### After
![Screen Shot 2022-06-01 at 6 10 02 PM](https://user-images.githubusercontent.com/16840674/171506525-ac1d414f-08e8-4f7a-8cce-ed0ced7c68cb.png)","{'url': 'https://api.github.com/repos/rails/rails/issues/45241/reactions', 'total_count': 70, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 22, 'confused': 0, 'heart': 32, 'rocket': 9, 'eyes': 7}",https://api.github.com/repos/rails/rails/issues/45241/timeline,,
https://api.github.com/repos/rails/rails/issues/45236,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45236/labels{/name},https://api.github.com/repos/rails/rails/issues/45236/comments,https://api.github.com/repos/rails/rails/issues/45236/events,https://github.com/rails/rails/pull/45236,1255757338,PR_kwDNIULOONfwkg,45236,Fix regression in XSS filtering of HTML characters,"{'login': 'amartinfraguas', 'id': 481882, 'node_id': 'MDQ6VXNlcjQ4MTg4Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/481882?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/amartinfraguas', 'html_url': 'https://github.com/amartinfraguas', 'followers_url': 'https://api.github.com/users/amartinfraguas/followers', 'following_url': 'https://api.github.com/users/amartinfraguas/following{/other_user}', 'gists_url': 'https://api.github.com/users/amartinfraguas/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/amartinfraguas/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/amartinfraguas/subscriptions', 'organizations_url': 'https://api.github.com/users/amartinfraguas/orgs', 'repos_url': 'https://api.github.com/users/amartinfraguas/repos', 'events_url': 'https://api.github.com/users/amartinfraguas/events{/privacy}', 'received_events_url': 'https://api.github.com/users/amartinfraguas/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,5,2022-06-01T11:35:07Z,2022-06-16T11:16:09Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45236', 'html_url': 'https://github.com/rails/rails/pull/45236', 'diff_url': 'https://github.com/rails/rails/pull/45236.diff', 'patch_url': 'https://github.com/rails/rails/pull/45236.patch', 'merged_at': None}","A previous fix of mine for protections for XSS in `ActionView::Helpers` and `ERB::Util` introduced a regression by not filtering HTML characters properly. This is a complete fix for that regression, related to #45027 , which was incomplete.

We would need to support XHTML, HTML4 and HTML5. But since XHTML and HTML4 have had a note for future deprecation in the documentation for more than 5 years ( https://github.com/rails/rails/blame/main/actionview/lib/action_view/helpers/tag_helper.rb#L263 ), these changes simplify the filtering by removing support for XHTML and HTML4.

### Summary

The regression was caused by filtering according to the XML standard. Instead of that, there are now two different sets of characters for the filtering: one for the names of HTML tags and one for the names of attributes in HTML tags.

We could deprecate the legacy syntax fully, but that may add too many changes to this pull request. Still, I have updated many internal uses of the legacy syntax, especially in the tests.

### Other Information

This is a change in the API, so the minor version of Rails should be increased. Since browsers may not support the HTML standard completely, it may be a good idea to have these changes merged in main for a while before releasing them. That way, there will be some time for possible regressions to be noticed and fixed.

These changes probably won't have a big impact on security. However, they seem like an improvement by following the HTML standard closely and reducing the complexity of supporting old standards. The part that looks more risky are the changes in the form tag and the fieldset tag, since there is manual string concatenation, please review those changes carefully.","{'url': 'https://api.github.com/repos/rails/rails/issues/45236/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45236/timeline,,
https://api.github.com/repos/rails/rails/issues/45231,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45231/labels{/name},https://api.github.com/repos/rails/rails/issues/45231/comments,https://api.github.com/repos/rails/rails/issues/45231/events,https://github.com/rails/rails/pull/45231,1254453200,PR_kwDNIULOOMV6Lg,45231,Allows associations to be automatically preloadable.,"{'login': 'doliveirakn', 'id': 1671796, 'node_id': 'MDQ6VXNlcjE2NzE3OTY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1671796?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/doliveirakn', 'html_url': 'https://github.com/doliveirakn', 'followers_url': 'https://api.github.com/users/doliveirakn/followers', 'following_url': 'https://api.github.com/users/doliveirakn/following{/other_user}', 'gists_url': 'https://api.github.com/users/doliveirakn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/doliveirakn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/doliveirakn/subscriptions', 'organizations_url': 'https://api.github.com/users/doliveirakn/orgs', 'repos_url': 'https://api.github.com/users/doliveirakn/repos', 'events_url': 'https://api.github.com/users/doliveirakn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/doliveirakn/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,"{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}, {'login': 'gmcgibbon', 'id': 5162312, 'node_id': 'MDQ6VXNlcjUxNjIzMTI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5162312?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/gmcgibbon', 'html_url': 'https://github.com/gmcgibbon', 'followers_url': 'https://api.github.com/users/gmcgibbon/followers', 'following_url': 'https://api.github.com/users/gmcgibbon/following{/other_user}', 'gists_url': 'https://api.github.com/users/gmcgibbon/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/gmcgibbon/subscriptions', 'organizations_url': 'https://api.github.com/users/gmcgibbon/orgs', 'repos_url': 'https://api.github.com/users/gmcgibbon/repos', 'events_url': 'https://api.github.com/users/gmcgibbon/events{/privacy}', 'received_events_url': 'https://api.github.com/users/gmcgibbon/received_events', 'type': 'User', 'site_admin': False}]",,22,2022-05-31T21:52:47Z,2023-09-07T20:00:08Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45231', 'html_url': 'https://github.com/rails/rails/pull/45231', 'diff_url': 'https://github.com/rails/rails/pull/45231.diff', 'patch_url': 'https://github.com/rails/rails/pull/45231.patch', 'merged_at': None}","### Summary

Before we load an association for the first time, we can preload
the association. This will eliminate most standard N+1 queries in Rails
apps.

We do this by capturing the group of records returned by a query in an
AutomaticPreloader and having each record have a reference to it.

Once a record has been flagged to allow automatic preloading, subsequent
associations are also flagged the same so this will allow deeply nested
associations to all be dynamically preloaded

This is off by default and can be opted in with each relation. There
is also a global option to enable it by default

For example: 
This code snippet:
```ruby
developers = Developer.order(:id).limit(2).to_a
developers.each do |developer|
  developer.contracts.to_a.first.company
end
```
would typically result in a few N+1 queries.  The queries would look something like:
```sql
SELECT ""developers"".* FROM ""developers"" ORDER BY ""developers"".""id"" ASC LIMIT 2
SELECT ""contracts"".* FROM ""contracts"" WHERE ""contracts"".""developer_id"" = 1 
SELECT ""companies"".* FROM ""companies"" WHERE ""companies"".""id"" = 1 LIMIT 1
SELECT ""contracts"".* FROM ""contracts"" WHERE ""contracts"".""developer_id"" = 2 
SELECT ""companies"".* FROM ""companies"" WHERE ""companies"".""id"" = 2 LIMIT 1
```

With `automatic_preloading` added (`Developer.order(:id).automatic_preloading.limit(2).to_a`), the same code would generate queries like:
```sql
SELECT ""developers"".* FROM ""developers"" ORDER BY ""developers"".""id"" ASC LIMIT 2
SELECT ""contracts"".* FROM ""contracts"" WHERE ""contracts"".""developer_id"" IN (1, 2)
SELECT ""companies"".* FROM ""companies"" WHERE ""companies"".""id"" IN (1, 2)
```

","{'url': 'https://api.github.com/repos/rails/rails/issues/45231/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45231/timeline,,
https://api.github.com/repos/rails/rails/issues/45226,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45226/labels{/name},https://api.github.com/repos/rails/rails/issues/45226/comments,https://api.github.com/repos/rails/rails/issues/45226/events,https://github.com/rails/rails/pull/45226,1254067580,PR_kwDNIULOOMCVZA,45226,Parse `application/csp-report` by default,"{'login': 'choznerol', 'id': 12410942, 'node_id': 'MDQ6VXNlcjEyNDEwOTQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12410942?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/choznerol', 'html_url': 'https://github.com/choznerol', 'followers_url': 'https://api.github.com/users/choznerol/followers', 'following_url': 'https://api.github.com/users/choznerol/following{/other_user}', 'gists_url': 'https://api.github.com/users/choznerol/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/choznerol/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/choznerol/subscriptions', 'organizations_url': 'https://api.github.com/users/choznerol/orgs', 'repos_url': 'https://api.github.com/users/choznerol/repos', 'events_url': 'https://api.github.com/users/choznerol/events{/privacy}', 'received_events_url': 'https://api.github.com/users/choznerol/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2022-05-31T15:48:40Z,2022-08-25T21:08:14Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45226', 'html_url': 'https://github.com/rails/rails/pull/45226', 'diff_url': 'https://github.com/rails/rails/pull/45226.diff', 'patch_url': 'https://github.com/rails/rails/pull/45226.patch', 'merged_at': None}","### Summary

If `report-uri` is provided in `Content-Security-Policy:  ...` header (e.g. When `Rails.application.config.content_security_policy.report_uri` is configured), browsers will report CSP violations to `report-uri` as a JSON object ([schema](https://w3c.github.io/webappsec-csp/#deprecated-serialize-violation)) with a `Content-Type: application/csp-report` header.

For a Rails user, If he configured `config.report_uri` pointing to a Rails `controller#action`, he would also have to do either one of the following:
1. Write `body = JSON.parse(request.body.read)` in the corresponding controller action
2. Add `Mime::Type.register('application/csp-report', :json)` in `config/intializers/mime_type.rb`

Since Rails [supports `Content Security Policy`](https://edgeguides.rubyonrails.org/security.html#content-security-policy-header) out of the box, I think it would be nice if `application/csp-report` is also supported by default.

### Other Information

This PR may be similar to #44608
","{'url': 'https://api.github.com/repos/rails/rails/issues/45226/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45226/timeline,,
https://api.github.com/repos/rails/rails/issues/45209,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45209/labels{/name},https://api.github.com/repos/rails/rails/issues/45209/comments,https://api.github.com/repos/rails/rails/issues/45209/events,https://github.com/rails/rails/issues/45209,1252184290,I_kwDNIULOSqLQ4g,45209,Associated records are validated when passing context,"{'login': 'shouichi', 'id': 99586, 'node_id': 'MDQ6VXNlcjk5NTg2', 'avatar_url': 'https://avatars.githubusercontent.com/u/99586?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/shouichi', 'html_url': 'https://github.com/shouichi', 'followers_url': 'https://api.github.com/users/shouichi/followers', 'following_url': 'https://api.github.com/users/shouichi/following{/other_user}', 'gists_url': 'https://api.github.com/users/shouichi/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/shouichi/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/shouichi/subscriptions', 'organizations_url': 'https://api.github.com/users/shouichi/orgs', 'repos_url': 'https://api.github.com/users/shouichi/repos', 'events_url': 'https://api.github.com/users/shouichi/events{/privacy}', 'received_events_url': 'https://api.github.com/users/shouichi/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2022-05-30T04:45:47Z,2022-11-02T00:06:59Z,,CONTRIBUTOR,,,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 7.0.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.string :body
  end
end

class Post < ActiveRecord::Base
  has_many :comments

  after_create :create_invalid_comment!

  def create_invalid_comment!
    c = comments.new
    c.save!(validate: false)
  end
end

class Comment < ActiveRecord::Base
  belongs_to :post

  validates :body, presence: true
end

class BugTest < Minitest::Test
  def test_save
    post = Post.create
    assert post.save
  end

  def test_save_with_context
    post = Post.create
    assert post.save(context: :whatever)
  end

  def test_save_with_context_reloaded
    post = Post.create.reload
    assert post.save(context: :whatever)
  end
end
```

### Expected behavior

Associated records are not validated.

### Actual behavior

Associated records are validated.

### System configuration
**Rails version**: Rails 7.0.3

**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]","{'url': 'https://api.github.com/repos/rails/rails/issues/45209/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45209/timeline,,
https://api.github.com/repos/rails/rails/issues/45208,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45208/labels{/name},https://api.github.com/repos/rails/rails/issues/45208/comments,https://api.github.com/repos/rails/rails/issues/45208/events,https://github.com/rails/rails/pull/45208,1252025871,PR_kwDNIULOOKWFIw,45208,Support adding and removing `CHECK` constraints in bulk `change_table`,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-05-29T23:58:45Z,2022-05-30T00:07:08Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45208', 'html_url': 'https://github.com/rails/rails/pull/45208', 'diff_url': 'https://github.com/rails/rails/pull/45208.diff', 'patch_url': 'https://github.com/rails/rails/pull/45208.patch', 'merged_at': None}","```ruby
change_table :users, bulk: true do |t|
  t.integer :age
  t.check_constraint ""age >= 0""
end
```

### Before
```
(0.5ms)  ALTER TABLE ""users"" ADD ""age"" integer
(0.4ms)  ALTER TABLE ""users"" ADD CONSTRAINT chk_rails_124019740c CHECK (age >= 0)
```

### After
```
(0.8ms)  ALTER TABLE ""users"" ADD ""age"" integer, ADD CONSTRAINT chk_rails_124019740c CHECK (age >= 0)
```","{'url': 'https://api.github.com/repos/rails/rails/issues/45208/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45208/timeline,,
https://api.github.com/repos/rails/rails/issues/45201,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45201/labels{/name},https://api.github.com/repos/rails/rails/issues/45201/comments,https://api.github.com/repos/rails/rails/issues/45201/events,https://github.com/rails/rails/pull/45201,1251825062,PR_kwDNIULOOKMcSg,45201,Adds ability to get the combined bytes_size of all attached blobs,"{'login': 'sandip-mane', 'id': 9862943, 'node_id': 'MDQ6VXNlcjk4NjI5NDM=', 'avatar_url': 'https://avatars.githubusercontent.com/u/9862943?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sandip-mane', 'html_url': 'https://github.com/sandip-mane', 'followers_url': 'https://api.github.com/users/sandip-mane/followers', 'following_url': 'https://api.github.com/users/sandip-mane/following{/other_user}', 'gists_url': 'https://api.github.com/users/sandip-mane/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sandip-mane/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sandip-mane/subscriptions', 'organizations_url': 'https://api.github.com/users/sandip-mane/orgs', 'repos_url': 'https://api.github.com/users/sandip-mane/repos', 'events_url': 'https://api.github.com/users/sandip-mane/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sandip-mane/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,2,2022-05-29T08:29:41Z,2022-08-17T05:54:57Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45201', 'html_url': 'https://github.com/rails/rails/pull/45201', 'diff_url': 'https://github.com/rails/rails/pull/45201.diff', 'patch_url': 'https://github.com/rails/rails/pull/45201.patch', 'merged_at': None}","Adds ability to get the combined bytes_size of all attached blobs.

Example:
```ruby
class Gallery < ApplicationRecord
  has_many_attached :photos
end

Gallery.new.photos.bytes_size
```","{'url': 'https://api.github.com/repos/rails/rails/issues/45201/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45201/timeline,,
https://api.github.com/repos/rails/rails/issues/45196,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45196/labels{/name},https://api.github.com/repos/rails/rails/issues/45196/comments,https://api.github.com/repos/rails/rails/issues/45196/events,https://github.com/rails/rails/pull/45196,1251430945,PR_kwDNIULOOJ4x0A,45196,Improve ActiveStorage::Analyzer::ImageAnalyzer#metadata,"{'login': 'esparta', 'id': 1037088, 'node_id': 'MDQ6VXNlcjEwMzcwODg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1037088?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/esparta', 'html_url': 'https://github.com/esparta', 'followers_url': 'https://api.github.com/users/esparta/followers', 'following_url': 'https://api.github.com/users/esparta/following{/other_user}', 'gists_url': 'https://api.github.com/users/esparta/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/esparta/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/esparta/subscriptions', 'organizations_url': 'https://api.github.com/users/esparta/orgs', 'repos_url': 'https://api.github.com/users/esparta/repos', 'events_url': 'https://api.github.com/users/esparta/events{/privacy}', 'received_events_url': 'https://api.github.com/users/esparta/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-05-28T02:44:30Z,2022-05-28T16:57:34Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45196', 'html_url': 'https://github.com/rails/rails/pull/45196', 'diff_url': 'https://github.com/rails/rails/pull/45196.diff', 'patch_url': 'https://github.com/rails/rails/pull/45196.patch', 'merged_at': None}","### Summary

Fixing both implementations having each a different problem related to the assertion of the rotation of the images soon to be analyzed:

- VIPS: is too slow
- Imagemagick: creates a new array on every call (using more memory)

### Other Information

VIPS
----

The implementation using ruby-vips is using `Regexp#===` to compare the results of the EXIF data using `Vips::Image#get`, which turns out is not that fast compared with `Regexp#match?` when using the following micro-benchmark:

```ruby
require 'benchmark/ips'

cases = [
 ""1 (Top-left, Short, 1 components, 2 bytes)"",
 ""0 (Top-right, Short, 1 components, 2 bytes)"",
 ""3 (Bottom-right, Short, 1 components, 2 bytes)"",
 ""4 (Bottom-left, Short, 1 components, 2 bytes)"",
 ""5 (Left-top, Short, 1 components, 2 bytes)"",
 ""6 (Right-top, Short, 1 components, 2 bytes)"",
 ""7 (Right-bottom, Short, 1 components, 2 bytes)"",
 ""8 (Left-bottom, Short, 1 components, 2 bytes)""
].freeze

ROTATIONS = /Right-top|Left-bottom|Top-right|Bottom-left/

Benchmark.ips do |x|
  x.report('Regexp.match?') { ROTATIONS.match?(cases.sample) }
  x.report('Regexp ===') { ROTATIONS === cases.sample }
  x.compare!
end
```
Results - using the minimal improvement since the maximal goes up to 3.x faster:

```
Warming up --------------------------------------
       Regexp.match?   482.481k i/100ms
          Regexp ===   205.449k i/100ms
Calculating -------------------------------------
       Regexp.match?      3.075M ( 3.0%) i/s - 15.439M in   5.025161s
          Regexp ===      1.987M ( 2.7%) i/s - 10.067M in   5.070618s

Comparison:
       Regexp.match?:  3075191.3 i/s
          Regexp ===:  1986792.5 i/s - 1.55x ( 0.00) slower
```
I've checked the compatibility of both methods, and both looks like yielding the same results:

```ruby
cases = [
 ""1 (Top-left, Short, 1 components, 2 bytes)"",
 ""2 (Top-right, Short, 1 components, 2 bytes)"",
 ""3 (Bottom-right, Short, 1 components, 2 bytes)"",
 ""4 (Bottom-left, Short, 1 components, 2 bytes)"",
 ""5 (Left-top, Short, 1 components, 2 bytes)"",
 ""6 (Right-top, Short, 1 components, 2 bytes)"",
 ""7 (Right-bottom, Short, 1 components, 2 bytes)"",
 ""8 (Left-bottom, Short, 1 components, 2 bytes)""
]

cases.each_with_object({}) do |orientation, hash|
  hash[orientation] = {
    '==='    => ROTATIONS === orientation,
    'match?' => ROTATIONS.match?(orientation)
  }
end

{""1 (Top-left, Short, 1 components, 2 bytes)""
   => {""==="" => false, ""match?"" => false},
 ""2 (Top-right, Short, 1 components, 2 bytes)""
   => {""==="" => true, ""match?"" => true},
 ""3 (Bottom-right, Short, 1 components, 2 bytes)""
   => {""==="" => false, ""match?"" => false},
 ""4 (Bottom-left, Short, 1 components, 2 bytes)""
   => {""==="" => true, ""match?"" => true},
 ""5 (Left-top, Short, 1 components, 2 bytes)""
   => {""==="" => false, ""match?"" => false},
 ""6 (Right-top, Short, 1 components, 2 bytes)""
   => {""==="" => true, ""match?"" => true},
 ""7 (Right-bottom, Short, 1 components, 2 bytes)""
   => {""=== ""=> false, ""match?"" => false},
 ""8 (Left-bottom, Short, 1 components, 2 bytes)""
   => {""==="" => true, ""match?"" => true}
   }
```

Image Magick
---

In this case, the method was creating an array on every execution of `rotated_image?`, extracting the array into a constant and changing to be a `Set` will bring two benefit at once: don't use more memory and also be slightly fast since the Set are a O(1) operation and the array search is O(n).

A last benefit of this change is to have symmetric implementations when using `ROTATIONS` constant for both.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45196/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45196/timeline,,
https://api.github.com/repos/rails/rails/issues/45195,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45195/labels{/name},https://api.github.com/repos/rails/rails/issues/45195/comments,https://api.github.com/repos/rails/rails/issues/45195/events,https://github.com/rails/rails/pull/45195,1251407110,PR_kwDNIULOOJ3dZg,45195,Allow GCS service update_metadata method to set cache_control header,"{'login': 'texas-delaney', 'id': 100537396, 'node_id': 'U_kgDOBf4UNA', 'avatar_url': 'https://avatars.githubusercontent.com/u/100537396?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/texas-delaney', 'html_url': 'https://github.com/texas-delaney', 'followers_url': 'https://api.github.com/users/texas-delaney/followers', 'following_url': 'https://api.github.com/users/texas-delaney/following{/other_user}', 'gists_url': 'https://api.github.com/users/texas-delaney/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/texas-delaney/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/texas-delaney/subscriptions', 'organizations_url': 'https://api.github.com/users/texas-delaney/orgs', 'repos_url': 'https://api.github.com/users/texas-delaney/repos', 'events_url': 'https://api.github.com/users/texas-delaney/events{/privacy}', 'received_events_url': 'https://api.github.com/users/texas-delaney/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2022-05-28T01:47:23Z,2022-07-20T02:54:17Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45195', 'html_url': 'https://github.com/rails/rails/pull/45195', 'diff_url': 'https://github.com/rails/rails/pull/45195.diff', 'patch_url': 'https://github.com/rails/rails/pull/45195.patch', 'merged_at': None}","Previously, the update_metadata method in `ActiveStorage::Service::GCSService` did not allow for updating the `""Cache-Control""` header on the service. Now, update_metadata takes an argument `cache_control` that correctly updates the `""Cache-Control""` header for the file on Google Cloud Storage.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45195/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45195/timeline,,
https://api.github.com/repos/rails/rails/issues/45166,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45166/labels{/name},https://api.github.com/repos/rails/rails/issues/45166/comments,https://api.github.com/repos/rails/rails/issues/45166/events,https://github.com/rails/rails/pull/45166,1245682774,PR_kwDNIULOOFH2xw,45166,Bypass CGI escaping in `Hash#to_param`,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,1,2022-05-23T20:51:21Z,2022-05-23T21:14:20Z,,MEMBER,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45166', 'html_url': 'https://github.com/rails/rails/pull/45166', 'diff_url': 'https://github.com/rails/rails/pull/45166.diff', 'patch_url': 'https://github.com/rails/rails/pull/45166.patch', 'merged_at': None}","Prior to this commit, `Hash#to_param` was an alias for `Hash#to_query`, which meant `Hash#to_param` CGI-escaped query string keys and values, like other `to_query` methods, but *unlike* other `to_param` methods.  This caused double escaping in some cases, such as when passing a `Hash` as an `anchor` argument to `url_for`.

This commit adds an internal-use-only optional `escape` block to `to_query` methods, and `Hash#to_param` now uses this block to bypass escaping, while still being implemented in terms of `Hash#to_query`.

Fixes #43289.
Closes #43293.

---

@intrip I've added you as a co-author, due to your work on #43293.  What do you think of this approach?

This is a potentially breaking change, but I feel like it's more of a ""fix"" to make `Hash#to_param` behave the same as other `to_param` methods.
","{'url': 'https://api.github.com/repos/rails/rails/issues/45166/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45166/timeline,,
https://api.github.com/repos/rails/rails/issues/45161,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45161/labels{/name},https://api.github.com/repos/rails/rails/issues/45161/comments,https://api.github.com/repos/rails/rails/issues/45161/events,https://github.com/rails/rails/pull/45161,1245519027,PR_kwDNIULOOE_I1g,45161,Load Tree Setup,"{'login': 'gwincr11', 'id': 289882, 'node_id': 'MDQ6VXNlcjI4OTg4Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/289882?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/gwincr11', 'html_url': 'https://github.com/gwincr11', 'followers_url': 'https://api.github.com/users/gwincr11/followers', 'following_url': 'https://api.github.com/users/gwincr11/following{/other_user}', 'gists_url': 'https://api.github.com/users/gwincr11/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/gwincr11/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/gwincr11/subscriptions', 'organizations_url': 'https://api.github.com/users/gwincr11/orgs', 'repos_url': 'https://api.github.com/users/gwincr11/repos', 'events_url': 'https://api.github.com/users/gwincr11/events{/privacy}', 'received_events_url': 'https://api.github.com/users/gwincr11/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2022-05-23T17:58:08Z,2022-10-24T13:36:31Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45161', 'html_url': 'https://github.com/rails/rails/pull/45161', 'diff_url': 'https://github.com/rails/rails/pull/45161.diff', 'patch_url': 'https://github.com/rails/rails/pull/45161.patch', 'merged_at': None}","### Summary
As the first step in splitting up ActiveRecord dynamic includes and the new load tree debug view as proposed in #45071 we need the load tree to be available.

The load tree being part of ActiveModel allows for its use in both the context of ActiveRecord and x other external service. This is desirable as it allows consumers to build automatic includes across any data fetching service where preventing an n+1 query is performant.

The load tree also will provide data to the associated debugging view which is also being split out of #45071. 

There will be 2 follow up PR's to this, one re-introducing auto loading, or dynamic loading of associations. The second will be to add a debug view of the load tree.

### Other Information

I considered adding a setting for this, maybe something in ActiveRecord to only setup the load trees if it is on? @matthewd and @jhawthorn have both suggested alternate implementations of how to hold the siblings, should they be weakrefs or not is an open question.

cc @eileencodes 
","{'url': 'https://api.github.com/repos/rails/rails/issues/45161/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45161/timeline,,
https://api.github.com/repos/rails/rails/issues/45122,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45122/labels{/name},https://api.github.com/repos/rails/rails/issues/45122/comments,https://api.github.com/repos/rails/rails/issues/45122/events,https://github.com/rails/rails/pull/45122,1239386554,PR_kwDNIULON_8prg,45122,ActiveSupport::Inspect: easily set up constrained inspect output,"{'login': 'matthewd', 'id': 1034, 'node_id': 'MDQ6VXNlcjEwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthewd', 'html_url': 'https://github.com/matthewd', 'followers_url': 'https://api.github.com/users/matthewd/followers', 'following_url': 'https://api.github.com/users/matthewd/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthewd/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthewd/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthewd/subscriptions', 'organizations_url': 'https://api.github.com/users/matthewd/orgs', 'repos_url': 'https://api.github.com/users/matthewd/repos', 'events_url': 'https://api.github.com/users/matthewd/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthewd/received_events', 'type': 'User', 'site_admin': True}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,2,2022-05-18T03:36:12Z,2022-07-26T12:47:57Z,,MEMBER,,True,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45122', 'html_url': 'https://github.com/rails/rails/pull/45122', 'diff_url': 'https://github.com/rails/rails/pull/45122.diff', 'patch_url': 'https://github.com/rails/rails/pull/45122.patch', 'merged_at': None}","As noted in https://github.com/rails/rails/pull/44495, since Ruby 3.0, common exceptions like NoMethodError now include the full inspect value in their message, regardless of size.

That helps give control over the object's representation, but can be unpleasant when combined with the default all-ivar-values inspect behaviour: it makes for unworkably large exception messages, and can be particularly confusing when objects contain a reference to their ""parent"", ultimately spewing an enormous object graph, only a tiny fraction of which actually identifies the object originally intended.

We've already added several custom inspect methods (#44495 and #44456 among them), and had other reports that partly or completely trace back to this issue, including #44951 and #45121.

---

While some of our custom inspect methods have corresponding pretty print support, others do not -- which is fine for a trivial fixed string, but less fine for anything that includes further inspection. Meanwhile newer work on irb makes good pretty-printing more important for standard use cases.

My goal is to make it particularly easy to define a custom inspect behaviour, in a way that supports both inspect and pp, maintains some basic formatting consistency (e.g. use of `#<..>`), allows compact presentation of primary identifying info, and still has some escape hatches for a class author with a particular presentation in mind.

By making it trivial to define a nice inspect presentation, we can make it common to do so, and thereby curtail runaway object graphs. To that end, we can consciously trade inspection-performance-per-object for utility: the more useful this module (and its output) is, the more often it will be used, and the fewer total objects will be inspected at any one time.

---

As well as defining the base module, this PR switches a number of existing `def inspect` to use it, demonstrating that it involves similar-or-less code for similar-or-better results; it also employs the feature to set up new inspection for several notable runaway-inspections I've observed, such as AR adapters and pools.","{'url': 'https://api.github.com/repos/rails/rails/issues/45122/reactions', 'total_count': 1, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 1, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45122/timeline,,
https://api.github.com/repos/rails/rails/issues/45112,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45112/labels{/name},https://api.github.com/repos/rails/rails/issues/45112/comments,https://api.github.com/repos/rails/rails/issues/45112/events,https://github.com/rails/rails/issues/45112,1237667974,I_kwDNIULOScVQhg,45112,Action Cable: Client-initiated heartbeats,"{'login': 'jeremy', 'id': 199, 'node_id': 'MDQ6VXNlcjE5OQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/199?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jeremy', 'html_url': 'https://github.com/jeremy', 'followers_url': 'https://api.github.com/users/jeremy/followers', 'following_url': 'https://api.github.com/users/jeremy/following{/other_user}', 'gists_url': 'https://api.github.com/users/jeremy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jeremy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jeremy/subscriptions', 'organizations_url': 'https://api.github.com/users/jeremy/orgs', 'repos_url': 'https://api.github.com/users/jeremy/repos', 'events_url': 'https://api.github.com/users/jeremy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jeremy/received_events', 'type': 'User', 'site_admin': False}","[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,"{'login': 'jorgemanrubia', 'id': 129938, 'node_id': 'MDQ6VXNlcjEyOTkzOA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/129938?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jorgemanrubia', 'html_url': 'https://github.com/jorgemanrubia', 'followers_url': 'https://api.github.com/users/jorgemanrubia/followers', 'following_url': 'https://api.github.com/users/jorgemanrubia/following{/other_user}', 'gists_url': 'https://api.github.com/users/jorgemanrubia/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jorgemanrubia/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jorgemanrubia/subscriptions', 'organizations_url': 'https://api.github.com/users/jorgemanrubia/orgs', 'repos_url': 'https://api.github.com/users/jorgemanrubia/repos', 'events_url': 'https://api.github.com/users/jorgemanrubia/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jorgemanrubia/received_events', 'type': 'User', 'site_admin': False}","[{'login': 'jorgemanrubia', 'id': 129938, 'node_id': 'MDQ6VXNlcjEyOTkzOA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/129938?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jorgemanrubia', 'html_url': 'https://github.com/jorgemanrubia', 'followers_url': 'https://api.github.com/users/jorgemanrubia/followers', 'following_url': 'https://api.github.com/users/jorgemanrubia/following{/other_user}', 'gists_url': 'https://api.github.com/users/jorgemanrubia/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jorgemanrubia/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jorgemanrubia/subscriptions', 'organizations_url': 'https://api.github.com/users/jorgemanrubia/orgs', 'repos_url': 'https://api.github.com/users/jorgemanrubia/repos', 'events_url': 'https://api.github.com/users/jorgemanrubia/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jorgemanrubia/received_events', 'type': 'User', 'site_admin': False}]",,2,2022-05-16T20:17:44Z,2022-08-30T02:16:20Z,,MEMBER,,,,"Tracking issue for a new feature we're extracting from Basecamp: Relying on clients to send heartbeats.

Motivation: Preventing defunct session cruft from building up on WebSockets load balancers / proxies (e.g. Nginx or F5 BIG-IP) during network failovers and anycast IP changes.
* Basecamp runs in multiple datacenters for high availability. During failover events and network changes, existing Action Cable sessions are severed. Hence they stop receiving server-sent heartbeats and attempt a reconnect, now landing on the new network destination. All good, as expected.
* On the server side, however, a proxy or load balancer sitting in front of the app can accumulate all these indeterminate maybe-dead NATted connections, eating a ton of memory and sockets. The proxy needs to ceremoniously tear down the suddenly-absent client TCP connection, but in the meantime it's getting heartbeat pings from the server side, suggesting the connection is alive and well, so it hangs onto all the connections until the client side is surely closed.

Shifting the heartbeat responsibility from the server  client to client  server neatly resolves this. When network routing changes, the client reconnects to the new destination and ceases heartbeats to the old one. The proxy at the old destination no longer sees client _or_ server traffic on the connection, so it gracefully & expeditiously closes it out.

This feels like a strong default behavior as well, considering the client is already responsible for all other aspects of connection management.

Needs some care with backward and forward compatibility, anticipating that one, both, or neither heartbeating mechanisms could be in play during initial deployments or rollback therefrom.

Implementation:
* Introduce native heartbeating to the connection monitor
* Introduce a native ping/heartbeat message
* Skip `ActionCable::Server::Base#setup_heartbeat_timer` when client-initiated heartbeats are enabled

Example from Basecamp, implemented using a Cable channel to ""drive"" the connection monitor:
```javascript
BC.cableReady(function() {
  const pingInterval = (ActionCable.ConnectionMonitor.staleThreshold * 1000) / 2 // 3 seconds

  BC.cableMonitor = BC.cable.subscriptions.create(""MonitoringChannel"", {
    initialized() {
      ({monitor: this.monitor} = this.consumer.connection)
      this.ping = this.ping.bind(this)
    },

    connected() {
      this.monitor.recordConnect()
      return this.ping()
    },

    received(data) {
      switch (data.action) {
        case ""pong"":
          return this.pong()
        case ""pubsub_pong"":
          return this.pong()
      }
    },

    ping() {
      this.perform(""ping"")
      return this.schedulePing()
    },

    pong() {
      this.monitor.recordPing()
      return this.schedulePing()
    },

    schedulePing() {
      clearTimeout(this.scheduledPing)
      this.scheduledPing = setTimeout(this.ping, pingInterval)
    }
  }
  )
})
```
```ruby
require ""securerandom""
require ""benchmark""

# Send our own pings and answer monitoring questions.
#
# This gives us forward compat with Action Cable protocol changes,
# like pings changing from subscriptions to message types.
class MonitoringChannel < ApplicationCable::Channel
  def subscribed
    @subscription_uuid = SecureRandom.uuid
    @last_received_at = Time.now.to_f

    stream_for @subscription_uuid, ->(json) {
      instrument_pubsub_latency ActiveSupport::JSON.decode(json) do |message|
        transmit message
      end
    }
  end

  def ping
    transmit({ action: ""pong"" })
  end

  def pubsub_ping
    self.class.broadcast_to @subscription_uuid, action: ""pubsub_pong"", sent_at: Time.now.to_f
  end

  private
    def instrument_pubsub_latency(message)
      received_at = Time.now.to_f

      if sent_at = message.delete(""sent_at"")
        latency = received_at - sent_at.to_f
        message[""latency_ms""] = ms(latency)
      end

      message[""period_ms""] = ms(received_at - @last_received_at)
      @last_received_at = received_at

      ActiveSupport::Notifications.instrument :performance, measurement: ""Chat.pubsub_delay"", value: latency, action: :timing

      yield message if block_given?
      message
    end

    def ms(seconds)
      (1000 * seconds).round(2)
    end
end
```","{'url': 'https://api.github.com/repos/rails/rails/issues/45112/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45112/timeline,,reopened
https://api.github.com/repos/rails/rails/issues/45100,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45100/labels{/name},https://api.github.com/repos/rails/rails/issues/45100/comments,https://api.github.com/repos/rails/rails/issues/45100/events,https://github.com/rails/rails/pull/45100,1236138329,PR_kwDNIULON9PnMg,45100,Load configured Active Storage plugins during boot,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-05-14T22:59:57Z,2022-06-22T01:40:40Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45100', 'html_url': 'https://github.com/rails/rails/pull/45100', 'diff_url': 'https://github.com/rails/rails/pull/45100.diff', 'patch_url': 'https://github.com/rails/rails/pull/45100.patch', 'merged_at': None}","### Summary

Previously, the parts of Active Storage using ruby-vips, mini_magick, or
image_processing would try to load gems only when used. This strategy works
well because it allows apps that don't need these features to easily
ignore them and not have to depend on gems they don't need.

However, the downsides to this strategy are that it requires loading
code during requests and that it moves potential error messages into request
logs instead of those errors being immediately visible on boot.

This commit addresses these issues by restructing how the Vips and Image
Magick transformers/analyzers are organized so that they will be loaded
(if configured) on boot along with whatever dependencies they need.

For now, if :vips or :mini_magick is specified as the Active Storage
:variant_processor, not having the required gem in the Gemfile will print a
deprecation warning instead of erroring because it is likely many apps
are currently configured this way.

### Other Information

Looking for feedback on the approach, I will add tests/docs/changelog etc. after

Closes #44991 
cc @byroot because of our discussion in the other issue","{'url': 'https://api.github.com/repos/rails/rails/issues/45100/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45100/timeline,,
https://api.github.com/repos/rails/rails/issues/45070,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45070/labels{/name},https://api.github.com/repos/rails/rails/issues/45070/comments,https://api.github.com/repos/rails/rails/issues/45070/events,https://github.com/rails/rails/pull/45070,1232972757,PR_kwDNIULON6sm5Q,45070,Pattern matching APIs for records and relations.,"{'login': 'kddnewton', 'id': 5093358, 'node_id': 'MDQ6VXNlcjUwOTMzNTg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5093358?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kddnewton', 'html_url': 'https://github.com/kddnewton', 'followers_url': 'https://api.github.com/users/kddnewton/followers', 'following_url': 'https://api.github.com/users/kddnewton/following{/other_user}', 'gists_url': 'https://api.github.com/users/kddnewton/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kddnewton/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kddnewton/subscriptions', 'organizations_url': 'https://api.github.com/users/kddnewton/orgs', 'repos_url': 'https://api.github.com/users/kddnewton/repos', 'events_url': 'https://api.github.com/users/kddnewton/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kddnewton/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,7,2022-05-11T17:29:07Z,2022-12-19T12:34:26Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45070', 'html_url': 'https://github.com/rails/rails/pull/45070', 'diff_url': 'https://github.com/rails/rails/pull/45070.diff', 'patch_url': 'https://github.com/rails/rails/pull/45070.patch', 'merged_at': None}","This provides the Ruby 2.7+ pattern matching interface for Active Record
records and relations. It allows the user to pattern match against
attributes and associations on records through a hash pattern. It also
allows the user to pattern match against relations through an array pattern.

```ruby
class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
end

post = Post.new(title: ""Welcome!"", comments: [Comment.new(body: ""Thanks!"")])
post => { title: ""Welcome!"", comments: [Comment[body:]] }
body # => ""Thanks!""
```","{'url': 'https://api.github.com/repos/rails/rails/issues/45070/reactions', 'total_count': 3, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 3, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45070/timeline,,
https://api.github.com/repos/rails/rails/issues/45059,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45059/labels{/name},https://api.github.com/repos/rails/rails/issues/45059/comments,https://api.github.com/repos/rails/rails/issues/45059/events,https://github.com/rails/rails/pull/45059,1231649322,PR_kwDNIULON5o3iA,45059,Replace execute statement with DRY call to rename_index,"{'login': 'ernestns', 'id': 1467153, 'node_id': 'MDQ6VXNlcjE0NjcxNTM=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1467153?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ernestns', 'html_url': 'https://github.com/ernestns', 'followers_url': 'https://api.github.com/users/ernestns/followers', 'following_url': 'https://api.github.com/users/ernestns/following{/other_user}', 'gists_url': 'https://api.github.com/users/ernestns/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ernestns/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ernestns/subscriptions', 'organizations_url': 'https://api.github.com/users/ernestns/orgs', 'repos_url': 'https://api.github.com/users/ernestns/repos', 'events_url': 'https://api.github.com/users/ernestns/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ernestns/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 257468118, 'node_id': 'MDU6TGFiZWwyNTc0NjgxMTg=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20work', 'name': 'needs work', 'color': '000000', 'default': False, 'description': None}]",open,False,,[],,6,2022-05-10T20:21:45Z,2022-08-12T17:22:56Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45059', 'html_url': 'https://github.com/rails/rails/pull/45059', 'diff_url': 'https://github.com/rails/rails/pull/45059.diff', 'patch_url': 'https://github.com/rails/rails/pull/45059.patch', 'merged_at': None}","### Summary

DRY SQL command `ALTER INDEX #{quote_table_name(idx)} RENAME TO #{quote_table_name(new_idx)}` with existing method `rename_index`, which also contains index name length validation `def validate_index_length`","{'url': 'https://api.github.com/repos/rails/rails/issues/45059/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45059/timeline,,
https://api.github.com/repos/rails/rails/issues/45056,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45056/labels{/name},https://api.github.com/repos/rails/rails/issues/45056/comments,https://api.github.com/repos/rails/rails/issues/45056/events,https://github.com/rails/rails/issues/45056,1231096543,I_kwDNIULOSWEK3w,45056,Preload doesn't work properly for has_many through associations with STI model,"{'login': 'vitalinfo', 'id': 7523182, 'node_id': 'MDQ6VXNlcjc1MjMxODI=', 'avatar_url': 'https://avatars.githubusercontent.com/u/7523182?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/vitalinfo', 'html_url': 'https://github.com/vitalinfo', 'followers_url': 'https://api.github.com/users/vitalinfo/followers', 'following_url': 'https://api.github.com/users/vitalinfo/following{/other_user}', 'gists_url': 'https://api.github.com/users/vitalinfo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/vitalinfo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/vitalinfo/subscriptions', 'organizations_url': 'https://api.github.com/users/vitalinfo/orgs', 'repos_url': 'https://api.github.com/users/vitalinfo/repos', 'events_url': 'https://api.github.com/users/vitalinfo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/vitalinfo/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2022-05-10T12:41:05Z,2023-03-03T04:30:05Z,,NONE,,,,"### Steps to reproduce

It does work for Rails versions less than 7, but doesn't for 7+.

```ruby
# frozen_string_literal: true

require 'bundler/inline'

gemfile(true) do
  source 'https://rubygems.org'

  gem 'rails', '7.0.3'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new($stdout)

ActiveRecord::Schema.define do
  create_table 'companies', force: :cascade, &:timestamps

  create_table 'memberships', force: :cascade do |t|
    t.integer 'company_id'
    t.integer 'user_id'
    t.timestamps
  end

  create_table 'profiles', force: :cascade do |t|
    t.integer 'user_id'
    t.timestamps
  end

  create_table 'user_settings', force: :cascade do |t|
    t.integer 'user_id'
    t.timestamps
  end

  create_table 'users', force: :cascade do |t|
    t.string 'type', null: false
    t.timestamps
  end
end

class Company < ActiveRecord::Base
  has_many :memberships, inverse_of: :company, dependent: :destroy
  has_many :users, through: :memberships

  has_many :profiles, through: :users
  has_many :user_settings, through: :users
end

class Membership < ActiveRecord::Base
  belongs_to :company, inverse_of: :memberships
  belongs_to :user, inverse_of: :memberships, class_name: 'User::Simple'
end

class Profile < ActiveRecord::Base
  belongs_to :user, inverse_of: :profile, class_name: 'User::Simple'
end

class UserSetting < ActiveRecord::Base
  belongs_to :user, inverse_of: :user_setting, class_name: 'User::Simple'
end

class User < ActiveRecord::Base
  has_one :profile, inverse_of: :user, dependent: :destroy
  has_one :user_setting, inverse_of: :user, dependent: :destroy

  has_many :memberships, inverse_of: :user, dependent: :destroy

  after_create do
    create_profile(user: self)
    create_user_setting(user: self)
  end
end

class User
  class Simple < User
  end
end

class BugTest < Minitest::Test
  def test_preload
    count = rand(1..10)
    company = Company.create!
    count.times { Membership.create!(company: company, user: User::Simple.create!) }

    list = Company.all.preload(:profiles, :user_settings)

    assert_equal count, list.map(&:profiles).flatten.size
    assert_equal count, list.map(&:user_settings).flatten.size
  end
end
```

### Expected behavior
`through` (`memberships` in example) association loads once and preload associations present in the parent object.

### Actual behavior
`through` (`memberships` in example) association loads as many times as preload associations provided. Second and further associations always are empty. If remove `class_name: 'User::Simple'` from the `Membership` model, everything works fine (`through` association loads once and preload associations as well), but this isn't an option, this's just shows that problem in the STI approach and `associate_records_to_owner`? behaviour.

### System configuration
**Rails version**: 7.0.3

**Ruby version**: 3.0.3
","{'url': 'https://api.github.com/repos/rails/rails/issues/45056/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45056/timeline,,
https://api.github.com/repos/rails/rails/issues/45053,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45053/labels{/name},https://api.github.com/repos/rails/rails/issues/45053/comments,https://api.github.com/repos/rails/rails/issues/45053/events,https://github.com/rails/rails/pull/45053,1230602039,PR_kwDNIULON4xMgQ,45053,Remove database number from default Redis url of config/cable.yml template,"{'login': 'jesusisao', 'id': 3109117, 'node_id': 'MDQ6VXNlcjMxMDkxMTc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3109117?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jesusisao', 'html_url': 'https://github.com/jesusisao', 'followers_url': 'https://api.github.com/users/jesusisao/followers', 'following_url': 'https://api.github.com/users/jesusisao/following{/other_user}', 'gists_url': 'https://api.github.com/users/jesusisao/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jesusisao/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jesusisao/subscriptions', 'organizations_url': 'https://api.github.com/users/jesusisao/orgs', 'repos_url': 'https://api.github.com/users/jesusisao/repos', 'events_url': 'https://api.github.com/users/jesusisao/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jesusisao/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,0,2022-05-10T04:27:54Z,2022-05-11T09:24:05Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45053', 'html_url': 'https://github.com/rails/rails/pull/45053', 'diff_url': 'https://github.com/rails/rails/pull/45053.diff', 'patch_url': 'https://github.com/rails/rails/pull/45053.patch', 'merged_at': None}","### Summary

The Redis Pub / Sub used in ActionCable is designed so that it does not interfere with the keyspace including the database number. Therefore, writing the database number has no effect.
I deleted the database number from template because it can be misleading as if the stream is isolated in the Redis database.

https://redis.io/docs/manual/pubsub/#database--scoping
","{'url': 'https://api.github.com/repos/rails/rails/issues/45053/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45053/timeline,,
https://api.github.com/repos/rails/rails/issues/45022,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45022/labels{/name},https://api.github.com/repos/rails/rails/issues/45022/comments,https://api.github.com/repos/rails/rails/issues/45022/events,https://github.com/rails/rails/pull/45022,1226028440,PR_kwDNIULON1JjXw,45022,Perform a full reconnect on PG::UnableToSend during reconnect!,"{'login': 'bpaquet', 'id': 337117, 'node_id': 'MDQ6VXNlcjMzNzExNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/337117?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/bpaquet', 'html_url': 'https://github.com/bpaquet', 'followers_url': 'https://api.github.com/users/bpaquet/followers', 'following_url': 'https://api.github.com/users/bpaquet/following{/other_user}', 'gists_url': 'https://api.github.com/users/bpaquet/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/bpaquet/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/bpaquet/subscriptions', 'organizations_url': 'https://api.github.com/users/bpaquet/orgs', 'repos_url': 'https://api.github.com/users/bpaquet/repos', 'events_url': 'https://api.github.com/users/bpaquet/events{/privacy}', 'received_events_url': 'https://api.github.com/users/bpaquet/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,"{'login': 'matthewd', 'id': 1034, 'node_id': 'MDQ6VXNlcjEwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthewd', 'html_url': 'https://github.com/matthewd', 'followers_url': 'https://api.github.com/users/matthewd/followers', 'following_url': 'https://api.github.com/users/matthewd/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthewd/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthewd/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthewd/subscriptions', 'organizations_url': 'https://api.github.com/users/matthewd/orgs', 'repos_url': 'https://api.github.com/users/matthewd/repos', 'events_url': 'https://api.github.com/users/matthewd/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthewd/received_events', 'type': 'User', 'site_admin': True}","[{'login': 'matthewd', 'id': 1034, 'node_id': 'MDQ6VXNlcjEwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthewd', 'html_url': 'https://github.com/matthewd', 'followers_url': 'https://api.github.com/users/matthewd/followers', 'following_url': 'https://api.github.com/users/matthewd/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthewd/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthewd/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthewd/subscriptions', 'organizations_url': 'https://api.github.com/users/matthewd/orgs', 'repos_url': 'https://api.github.com/users/matthewd/repos', 'events_url': 'https://api.github.com/users/matthewd/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthewd/received_events', 'type': 'User', 'site_admin': True}]",,6,2022-05-04T22:26:07Z,2022-07-11T12:16:21Z,,NONE,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45022', 'html_url': 'https://github.com/rails/rails/pull/45022', 'diff_url': 'https://github.com/rails/rails/pull/45022.diff', 'patch_url': 'https://github.com/rails/rails/pull/45022.patch', 'merged_at': None}","### Summary

On our setup, on some cases (when a PG reader crash for example), we receive a `PG::UnableToSend: no connection to the server` exception during `reconnect!` triggered by a `verify!`, not a `PG::ConnectionBad`.

We should consider doing a full reconnect in both cases.

","{'url': 'https://api.github.com/repos/rails/rails/issues/45022/reactions', 'total_count': 1, '+1': 1, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45022/timeline,,
https://api.github.com/repos/rails/rails/issues/45021,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/45021/labels{/name},https://api.github.com/repos/rails/rails/issues/45021/comments,https://api.github.com/repos/rails/rails/issues/45021/events,https://github.com/rails/rails/pull/45021,1225978782,PR_kwDNIULON1G7kw,45021,Preserve original application configs when configuring ActionMailer,"{'login': 'fatkodima', 'id': 5657035, 'node_id': 'MDQ6VXNlcjU2NTcwMzU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5657035?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/fatkodima', 'html_url': 'https://github.com/fatkodima', 'followers_url': 'https://api.github.com/users/fatkodima/followers', 'following_url': 'https://api.github.com/users/fatkodima/following{/other_user}', 'gists_url': 'https://api.github.com/users/fatkodima/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/fatkodima/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/fatkodima/subscriptions', 'organizations_url': 'https://api.github.com/users/fatkodima/orgs', 'repos_url': 'https://api.github.com/users/fatkodima/repos', 'events_url': 'https://api.github.com/users/fatkodima/events{/privacy}', 'received_events_url': 'https://api.github.com/users/fatkodima/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}]",open,False,,[],,2,2022-05-04T21:16:41Z,2022-05-07T06:50:35Z,,CONTRIBUTOR,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/45021', 'html_url': 'https://github.com/rails/rails/pull/45021', 'diff_url': 'https://github.com/rails/rails/pull/45021.diff', 'patch_url': 'https://github.com/rails/rails/pull/45021.patch', 'merged_at': None}","I have seen basically only one of all rails railties and engines also mutates original configs - https://github.com/rails/rails/blob/main/actionview/lib/action_view/railtie.rb. So maybe worth fixing too. 

Is there a reason not to leave original values? It will be easier for a user to find a config name in the `Configuring.md` guide and to check in the console, for example, what the configured value is without dropping to the internals and to find which other global config it sets.

Closes https://github.com/rails/rails/issues/44134","{'url': 'https://api.github.com/repos/rails/rails/issues/45021/reactions', 'total_count': 3, '+1': 3, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/45021/timeline,,
https://api.github.com/repos/rails/rails/issues/44991,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44991/labels{/name},https://api.github.com/repos/rails/rails/issues/44991/comments,https://api.github.com/repos/rails/rails/issues/44991/events,https://github.com/rails/rails/pull/44991,1222042042,PR_kwDNIULONx_Kqg,44991,Show better error messages when libvips is missing,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,6,2022-05-01T06:27:03Z,2022-05-10T12:57:54Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/44991', 'html_url': 'https://github.com/rails/rails/pull/44991', 'diff_url': 'https://github.com/rails/rails/pull/44991.diff', 'patch_url': 'https://github.com/rails/rails/pull/44991.patch', 'merged_at': None}","### Summary

The previous error would look something like this:

```
/usr/local/bundle/gems/ffi-1.15.5/lib/ffi/library.rb:145:in `block in
ffi_lib': Could not open library 'vips.so.42': vips.so.42: cannot open
shared object file: No such file or directory. (LoadError)

Could not open library 'libvips.so.42': libvips.so.42: cannot open
shared object file: No such file or directory
```

Now the LoadError is rescued and a more helpful error message is
displayed directing users to install libvips

### Other Information

The difference can be seen by switching between the two repos in this script (on a system missing libvips):

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # gem ""rails, github: ""rails/rails"", branch: ""main""
  gem ""rails"", github: ""skipkayhil/rails"", branch: ""better-libvips-error""
  gem ""sqlite3""
  gem ""image_processing""
end

require ""active_record/railtie""
require ""active_storage/engine""
require ""tmpdir""

class TestApp < Rails::Application
    config.root = __dir__
    config.hosts << ""example.org""
    config.eager_load = false
    config.session_store :cookie_store, key: ""cookie_store_key""
    secrets.secret_key_base = ""secret_key_base""

    config.logger = Logger.new($stdout)
    Rails.logger  = config.logger

    config.active_storage.service = :local
    config.active_storage.service_configurations = {
      local: {
        root: Dir.tmpdir,
        service: ""Disk""
      }
    }
    config.active_storage.variant_processor = :vips
end

ENV[""DATABASE_URL""] = ""sqlite3::memory:""

Rails.application.initialize!

require ActiveStorage::Engine.root.join(""db/migrate/20170806125915_create_active_storage_tables.rb"").to_s

ActiveRecord::Schema.define do
  CreateActiveStorageTables.new.change

  create_table :users, force: true
end

class User < ActiveRecord::Base
  has_one_attached :profile
end

require ""minitest/autorun""

class BugTest < Minitest::Test
  def test_upload_and_download
    ActiveStorage::Transformers::ImageProcessingTransformer.new(0).send(:processor)
  end
end
```

Closes #43976","{'url': 'https://api.github.com/repos/rails/rails/issues/44991/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/44991/timeline,,
https://api.github.com/repos/rails/rails/issues/44988,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44988/labels{/name},https://api.github.com/repos/rails/rails/issues/44988/comments,https://api.github.com/repos/rails/rails/issues/44988/events,https://github.com/rails/rails/pull/44988,1221687722,PR_kwDNIULONxtwYw,44988,Deprecate ChainedCookieJar#signed_or_encrypted,"{'login': 'skipkayhil', 'id': 6014046, 'node_id': 'MDQ6VXNlcjYwMTQwNDY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6014046?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/skipkayhil', 'html_url': 'https://github.com/skipkayhil', 'followers_url': 'https://api.github.com/users/skipkayhil/followers', 'following_url': 'https://api.github.com/users/skipkayhil/following{/other_user}', 'gists_url': 'https://api.github.com/users/skipkayhil/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/skipkayhil/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/skipkayhil/subscriptions', 'organizations_url': 'https://api.github.com/users/skipkayhil/orgs', 'repos_url': 'https://api.github.com/users/skipkayhil/repos', 'events_url': 'https://api.github.com/users/skipkayhil/events{/privacy}', 'received_events_url': 'https://api.github.com/users/skipkayhil/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2022-04-30T01:37:24Z,2022-04-30T03:40:01Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/44988', 'html_url': 'https://github.com/rails/rails/pull/44988', 'diff_url': 'https://github.com/rails/rails/pull/44988.diff', 'patch_url': 'https://github.com/rails/rails/pull/44988.patch', 'merged_at': None}","### Summary

It has been effectively the same as `#encrypted` since `secret_key_base` was
made a requirement in Rails 6.0

### Other Information

If deprecating is too aggressive, I could also make it just an alias for `#encrypted`","{'url': 'https://api.github.com/repos/rails/rails/issues/44988/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/44988/timeline,,
https://api.github.com/repos/rails/rails/issues/44976,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44976/labels{/name},https://api.github.com/repos/rails/rails/issues/44976/comments,https://api.github.com/repos/rails/rails/issues/44976/events,https://github.com/rails/rails/pull/44976,1218944026,PR_kwDNIULONvUz8A,44976,Add `redirect_through` for multi-redirect workflows,"{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,2,2022-04-28T15:58:53Z,2022-04-29T15:48:35Z,,MEMBER,,False,"{'url': 'https://api.github.com/repos/rails/rails/pulls/44976', 'html_url': 'https://github.com/rails/rails/pull/44976', 'diff_url': 'https://github.com/rails/rails/pull/44976.diff', 'patch_url': 'https://github.com/rails/rails/pull/44976.patch', 'merged_at': None}","`redirect_through` provides syntactic sugar for redirecting to an intermediate page while tracking a final destination using an `onward` query param.  The final destination defaults to the current request path.  For example, if user authentication is required, you could write something like:

```ruby
before_action do
  redirect_through sign_in_path unless signed_in?
end
```

An `onward_url` method is also provided to fetch the `onward` param while providing open-redirect protection.  It is exposed as a view helper, so you can propagate the `onward` value via a ""Sign in"" form:

```erb
<%= form_with ... do |form| %>
  <%= hidden_field_tag :onward, onward_url %>
  ...
<% end %>
```

Then, in your ""Sign in"" controller, you could write something like:

```ruby
if self.current_user = User.authenticate_by(sign_in_params)
  redirect_to onward_url || root_url
else
  render :new, status: :unauthorized
end
```

**Why not use `request.referer` for the intermediate request?**

Redirects preserve the original `Referer` header.  Thus intermediate pages will not see the location that redirected.  For example:

1. Visit `/posts/1` while signed out.
2. Click `/posts/1/edit` link.  `Referer` will be `/posts/1`.
3. Require authentication: redirect from `/posts/1/edit` to `/sign_in`.
4. Serve `/sign_in`.  `Referer` is `/posts/1`, *not* `/posts/1/edit`.

Additionally, some browsers (e.g. Firefox) have privacy settings to spoof the `Referer` header, so it may not be reliable.

**Why not store `onward` in a session variable / cookie?**

As shared state, session variables / cookies can be a problem when using multiple browser tabs.  For example:

1. Visit `/posts` while signed out.
2. Open `/posts/1/edit`, `/posts/2/edit`, etc links in new tabs.
3. Each tab is redirected to `/sign_in`.  The final tab ""wins"" at setting the session variable.
4. Assume forms are autofilled by a password manager.  User submits each tab's form because it is easier than reopening each tab.
5. Each tab is redirected to the final tab's location; *OR*, if the session variable is discarded after use, the first tab is redirected to the final tab's intended location, and all other tabs are redirected to a fallback (or error due to `redirect_to nil`).

Additionally, session variables can erroneously ""follow"" the user.  For example:

1. Visit `/posts/1` while signed out.
2. Click `/posts/1/edit` link.
3. Require authentication: store `""/posts/1/edit""` in a session variable, and redirect to `/sign_in`.
4. Navigate to a page that doesn't require authentication, e.g. `/`.
5. Click `/sign_in` link in the page navbar.  Sign in.
6. Redirected to `/posts/1/edit` despite starting a new navigation sequence, because nothing triggered the session variable to change.
","{'url': 'https://api.github.com/repos/rails/rails/issues/44976/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}",https://api.github.com/repos/rails/rails/issues/44976/timeline,,
